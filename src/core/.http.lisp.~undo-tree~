(undo-tree-save-format-version . 1)
"a696dc93ebdd18dfafe67b7b9832ea109b03a700"
[nil nil nil nil (26790 8106 380 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 1596 . 1597) (nil fontified nil 1 . 1597) (1 . 1597) (t . -1)) nil (26790 8106 379 0) 0 nil])
([nil nil ((18 . 19)) nil (26790 8106 379 0) 0 nil])
([nil nil ((267 . 278) (218 . 229) (110 . 121) (80 . 91) 19) nil (26790 8106 378 0) 0 nil])
([nil nil ((48 . 50) (#(" " 0 1 (fontified nil)) . 47) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (48 . 49)) nil (26790 8106 377 0) 0 nil])
([nil nil ((73 . 75) (#(" " 0 1 (fontified nil)) . 72) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (73 . 74)) nil (26790 8106 376 0) 0 nil])
([nil nil ((#("						     " 0 1 (fontified nil) 1 11 (fontified nil)) . -274) (274 . 275) (#("	" 0 1 (fontified nil)) . 274) (271 . 274) (337 . 338)) nil (26790 8106 374 0) 0 nil])
([nil nil ((#("						     " 0 1 (fontified nil) 1 11 (fontified nil)) . -209) (209 . 210) (#("	" 0 1 (fontified nil)) . 209) (206 . 209) (#("						     " 0 1 (fontified nil) 1 11 (fontified nil)) . -109) (109 . 110) (#("	" 0 1 (fontified nil)) . 109) (106 . 109) (#("						     " 0 1 (fontified nil) 1 11 (fontified nil)) . -87) (87 . 88) (#("	" 0 1 (fontified nil)) . 87) (84 . 87) 19) nil (26790 8106 373 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -338) (undo-tree-id14 . -1) (undo-tree-id15 . -1) 339) nil (26790 8106 372 0) 0 nil])
([nil nil ((721 . 724) (656 . 659) (606 . 609) (553 . 556) (506 . 509) (453 . 456) (409 . 412) (359 . 361) 338) nil (26790 8106 370 0) 0 nil])
([nil nil ((901 . 904) (847 . 850) (796 . 798) 774) nil (26790 8106 369 0) 0 nil])
([nil nil ((1132 . 1138) (1050 . 1056) (1008 . 1010) 950) nil (26790 8106 369 0) 0 nil])
([nil nil ((1341 . 1347) (1253 . 1259) (1211 . 1213) 1152) nil (26790 8106 368 0) 0 nil])
([nil nil ((1447 . 1449) 1394) nil (26790 8106 367 0) 0 nil])
([nil nil ((1593 . 1595) 1535) nil (26790 8106 366 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1524 . 1525) (nil fontified nil 1509 . 1525) (nil fontified nil 1499 . 1509) (nil fontified nil 1485 . 1499) (nil fontified nil 1482 . 1485) (nil fontified nil 1477 . 1482) (nil fontified nil 1472 . 1477) (nil fontified nil 1466 . 1472) (nil fontified nil 1463 . 1466) (1463 . 1525)) nil (26790 8106 365 0) 0 nil])
([nil nil ((1525 . 1528)) nil (26790 8106 364 0) 0 nil])
([nil nil ((#("(list :error (list :type \"not_found\" :message message)) :status 404))" 0 6 (fontified t) 6 12 (face font-lock-builtin-face fontified t) 12 19 (fontified t) 19 24 (face font-lock-builtin-face fontified t) 24 25 (fontified t) 25 36 (face font-lock-string-face fontified t) 36 37 (fontified t) 37 45 (face font-lock-builtin-face fontified t) 45 56 (fontified t) 56 63 (face font-lock-builtin-face fontified t) 63 69 (fontified t)) . 1528)) nil (26790 8106 364 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1525) (undo-tree-id11 . -1) (#(" " 0 1 (fontified t)) . -1526) (undo-tree-id12 . -1) (#(" " 0 1 (fontified t)) . -1527) (undo-tree-id13 . -1) 1528) nil (26790 8106 363 0) 0 nil])
([nil nil ((1525 . 1526)) nil (26790 8106 362 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1526)) nil (26790 8106 361 0) 0 nil])
([nil nil ((1510 . 1512)) nil (26790 8106 361 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t slime-repl-old-input 13)) . -1511) (undo-tree-id10 . -1) 1512) nil (26790 8106 360 0) 0 nil])
([nil nil ((1511 . 1518)) nil (26790 8106 360 0) 0 nil])
([nil nil ((#("\"C" 0 2 (face font-lock-string-face fontified t slime-repl-old-input 13)) . 1518)) nil (26790 8106 359 0) 0 nil])
([nil nil ((#("'est" 0 4 (fontified t slime-repl-old-input 13)) . 1518)) nil (26790 8106 359 0) 0 nil])
([nil nil ((#(" OK" 0 3 (fontified t slime-repl-old-input 13)) . 1518)) nil (26790 8106 358 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t slime-repl-old-input 13)) . 1518)) nil (26790 8106 358 0) 0 nil])
([nil nil ((1522 . 1523)) nil (26790 8106 358 0) 0 nil])
([nil nil ((1523 . 1530)) nil (26790 8106 357 0) 0 nil])
([nil nil ((1530 . 1531)) nil (26790 8106 357 0) 0 nil])
([nil nil ((1531 . 1534)) nil (26790 8106 357 0) 0 nil])
([nil nil ((#("5" 0 1 (fontified t slime-repl-old-input 13)) . -1531) (undo-tree-id7 . -1) (#("0" 0 1 (fontified t slime-repl-old-input 13)) . -1532) (undo-tree-id8 . -1) (#("0" 0 1 (fontified t slime-repl-old-input 13)) . -1533) (undo-tree-id9 . -1) 1534) nil (26790 8106 356 0) 0 nil])
([nil nil ((1531 . 1534)) nil (26790 8106 354 0) 0 nil])
([nil nil ((#("(list :error (list :type \"internal\" :message message))" 0 6 (fontified t) 6 12 (face font-lock-builtin-face fontified t) 12 19 (fontified t) 19 24 (face font-lock-builtin-face fontified t) 24 25 (fontified t) 25 35 (face font-lock-string-face fontified t) 35 36 (fontified t) 36 44 (face font-lock-builtin-face fontified t) 44 50 (fontified t) 50 54 (fontified t)) . -1612) (undo-tree-id6 . -54) 1666) nil (26790 8106 353 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1670 . 1671) (nil fontified nil 1667 . 1671) (nil fontified nil 1658 . 1667) (nil fontified nil 1656 . 1658) (nil fontified nil 1648 . 1656) (nil fontified nil 1645 . 1648) (nil fontified nil 1634 . 1645) (nil fontified nil 1631 . 1634) (nil fontified nil 1626 . 1631) (nil fontified nil 1621 . 1626) (nil fontified nil 1615 . 1621) (nil fontified nil 1612 . 1615) (1612 . 1671)) nil (26790 8106 351 0) 0 nil])
([nil nil ((#("not_found" 0 9 (face font-lock-string-face fontified t slime-repl-old-input 13)) . -1635) (undo-tree-id5 . -9) 1644) nil (26790 8106 350 0) 0 nil])
([nil nil ((1635 . 1643)) nil (26790 8106 349 0) 0 nil])
([nil nil ((1391 . 1393)) nil (26790 8106 348 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1954 . 1955) (nil fontified nil 1393 . 1955) (1393 . 1955)) nil (26790 8106 348 0) 0 nil])
([nil nil ((#("
(defun respond-json (data &key (status 200) (headers nil))
  (make-instance 'response :status status
			   :headers (append '((\"Content-Type\" . \"application/json; charset=utf-8\")) headers)
			   :body (cl-json:encode-json-to-string data)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 27 (fontified t) 27 31 (face font-lock-type-face fontified t) 31 60 (fontified t) 60 87 (fontified t) 87 94 (face font-lock-builtin-face fontified t) 94 108 (fontified t) 108 116 (face font-lock-builtin-face fontified t) 116 128 (fontified t) 128 142 (face font-lock-string-face fontified t) 142 145 (fontified t) 145 178 (face font-lock-string-face fontified t) 178 190 (fontified t) 190 196 (fontified t) 196 201 (face font-lock-builtin-face fontified t) 201 240 (fontified t)) . 1151) (undo-tree-id4 . -240)) nil (26790 8106 347 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1151) (#("
" 0 1 (fontified t)) . 1151)) nil (26790 8106 346 0) 0 nil])
([nil nil ((1820 . 1828) (#(" " 0 1 (fontified nil slime-repl-old-input 13)) . 1819) (undo-tree-id3 . -1) (1820 . 1821)) nil (26790 8106 345 0) 0 nil])
([nil nil ((1853 . 1855) (#(" " 0 1 (fontified nil slime-repl-old-input 13)) . 1852) (undo-tree-id2 . -1) (1853 . 1854)) nil (26790 8106 344 0) 0 nil])
([nil nil ((1978 . 1986) (#(" " 0 1 (fontified nil slime-repl-old-input 13)) . 1977) (undo-tree-id1 . -1) (1978 . 1979)) nil (26790 8106 343 0) 0 nil])
([nil nil ((2011 . 2013) (#(" " 0 1 (fontified nil)) . 2010) (undo-tree-id0 . -1) (2011 . 2012)) nil (26790 8106 340 0) 0 nil])
([nil nil ((2026 . 2027)) nil (26790 8106 327 0) 0 nil])
([nil nil ((1478 . 1483) (t 26790 8106 0 0)) nil (26792 22758 217108 0) 0 nil])
([nil nil ((1483 . 1489)) nil (26792 22758 217108 0) 0 nil])
([nil nil ((1489 . 1490)) nil (26792 22758 217107 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1531 . 1532) (nil fontified nil 1490 . 1532) (1490 . 1532)) nil (26792 22758 217105 0) 0 nil])
([nil nil ((1532 . 1533)) nil (26792 22758 217100 0) 0 nil])
([nil nil ((1687 . 1698) (t 26792 22758 0 0)) nil (26792 23122 370176 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1792 . 1793) (nil fontified nil 1698 . 1793) (1698 . 1793)) nil (26792 23122 370175 0) 0 nil])
([nil nil ((1779 . 1787) (#(" " 0 1 (fontified nil)) . 1778) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (1729 . 1739) (#("                          " 0 26 (fontified nil)) . 1729) (1795 . 1796)) nil (26792 23122 370172 0) 0 nil])
([nil nil ((1375 . 1376) (#(" " 0 1 (fontified t)) . 1375) 1151) nil (26792 23122 370146 0) 0 nil])
([nil nil ((1468 . 1473) (t 26792 23122 0 0)) nil (26793 33448 259798 0) 0 nil])
([nil nil ((1473 . 1474)) nil (26793 33448 259798 0) 0 nil])
([nil nil ((1484 . 1485)) nil (26793 33448 259797 0) 0 nil])
([nil nil ((1468 . 1473) (#(" " 0 1 (fontified nil)) . 1467) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (1468 . 1469)) nil (26793 33448 259793 0) 0 nil])
([nil nil ((1460 . 1461) (t 26793 33448 0 0)) nil (26793 33492 276135 0) 0 nil])
([nil nil ((1149 . 1151) (t 26793 33492 0 0)) nil (26793 38724 51885 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2004 . 2005) (nil fontified nil 1151 . 2005) (1151 . 2005)) nil (26793 38724 51882 0) 0 nil])
([nil nil ((#("

(defun respond-json (data &key (status 200) (headers nil))
  (let ((normalized (etypecase data
                      (hash-table data)
                      (list (if (every #'consp data)
                                data	; déjà un alist
                                (mapcar (lambda (x) (cons (car x) (cadr x)))
					(list data)))))))
    (print (cl-json:encode-json-to-string normalized))
    (make-instance 'response
                   :status status
                   :headers (append '((\"Content-Type\" . \"application/json; charset=utf-8\")
				      (\"Cache-Control\" . \"no-store\")
				      (\"X-Content-Type-Options\" . \"nosniff\"))
				    headers)
                   :body (cl-json:encode-json-to-string normalized))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 21 (face font-lock-function-name-face fontified t) 21 28 (fontified t) 28 32 (face font-lock-type-face fontified t) 32 64 (fontified t) 64 67 (face font-lock-keyword-face fontified t) 67 82 (fontified t) 82 91 (face font-lock-keyword-face fontified t) 91 166 (fontified t) 166 168 (face font-lock-keyword-face fontified t) 168 227 (fontified t) 227 243 (face font-lock-comment-face fontified t) 243 284 (fontified t) 284 290 (face font-lock-keyword-face fontified t) 290 320 (fontified t) 320 343 (fontified t) 343 365 (fontified t) 365 398 (fontified t) 398 446 (fontified t) 446 453 (face font-lock-builtin-face fontified t) 453 480 (fontified t) 480 488 (face font-lock-builtin-face fontified t) 488 500 (fontified t) 500 514 (face font-lock-string-face fontified t) 514 517 (fontified t) 517 550 (face font-lock-string-face fontified t) 550 563 (fontified t) 563 578 (face font-lock-string-face fontified t) 578 581 (fontified t) 581 591 (face font-lock-string-face fontified t) 591 604 (fontified t) 604 628 (face font-lock-string-face fontified t) 628 631 (fontified t) 631 640 (face font-lock-string-face fontified t) 640 679 (fontified t) 679 684 (face font-lock-builtin-face fontified t) 684 731 (fontified t)) . -2005) (undo-tree-id11 . -243) (undo-tree-id12 . -397) (undo-tree-id13 . -731) 2736) nil (26793 38724 51877 0) 0 nil])
([nil nil ((#("
  " 0 3 (fontified t)) . -205) (undo-tree-id0 . -3) 208 (t 26793 38724 0 0)) nil (26795 16235 821577 0) 0 nil])
([nil nil ((2315 . 2316) (t 26795 16235 0 0)) nil (26796 27319 420425 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4912 . 4913) (nil fontified nil 2316 . 4913) (2316 . 4913)) nil (26796 27319 420424 0) 0 nil])
([nil nil ((#("(defun %trim (s) (string-trim '(#\\Space #\\Tab #\\Newline #\\Return) s))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 12 (face font-lock-function-name-face fontified t) 12 69 (fontified t)) . 2715) (undo-tree-id8 . -69)) nil (26796 27319 420423 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2714) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 2715) nil (26796 27319 420483 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 2714) (#("
" 0 1 (fontified t)) . 2714)) nil (26796 29881 613258 0) 0 nil] [nil nil ((#("
" 0 1 (fontified t)) . 2714) (#("
" 0 1 (fontified t)) . 2714)) ((2714 . 2715) (2714 . 2715)) (26796 27319 420398 0) 0 nil])
([nil nil ((72 . 75)) nil (26796 29881 613258 0) 0 nil])
nil
([nil nil ((75 . 84)) nil (26796 29881 613258 0) 0 nil])
([nil nil ((76 . 88) (#(":import-" 0 8 (face font-lock-builtin-face fontified t)) . -76) (undo-tree-id9 . -8) 84) nil (26796 29881 613257 0) 0 nil])
([nil nil ((88 . 89)) nil (26796 29881 613247 0) 0 nil])
([nil nil ((89 . 101)) nil (26796 29881 613247 0) 0 nil])
([nil nil ((101 . 102)) nil (26796 29881 613246 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 107 . 108) (nil fontified nil 102 . 108) (102 . 108)) nil (26796 29881 613246 0) 0 nil])
([nil nil ((108 . 109)) nil (26796 29881 613244 0) 0 nil])
([nil nil ((4878 . 4879)) nil (26796 29881 613241 0) 0 nil])
([nil nil ((337 . 338) (t 26796 29881 0 0)) nil (26796 30239 363097 0) 0 nil])
([nil nil ((338 . 346)) nil (26796 30239 363096 0) 0 nil])
([nil nil ((338 . 341) (#(" " 0 1 (fontified nil)) . 337) (undo-tree-id12 . -1) (338 . 339)) nil (26796 30239 363095 0) 0 nil])
([nil nil ((341 . 343)) nil (26796 30239 363094 0) 0 nil])
([nil nil ((343 . 344)) nil (26796 30239 363093 0) 0 nil])
([nil nil ((344 . 351)) nil (26796 30239 363093 0) 0 nil])
([nil nil ((351 . 355)) nil (26796 30239 363093 0) 0 nil])
([nil nil ((363 . 375)) nil (26796 30239 363092 0) 0 nil])
([nil nil ((#("g" 0 1 (face font-lock-builtin-face fontified t)) . -369) (undo-tree-id11 . -1) 370) nil (26796 30239 363092 0) 0 nil])
([nil nil ((369 . 370)) nil (26796 30239 363090 0) 0 nil])
([nil nil ((378 . 379)) nil (26796 30239 363089 0) 0 nil])
([nil nil ((375 . 376)) nil (26796 30239 363089 0) 0 nil])
([nil nil ((376 . 377)) nil (26796 30239 363088 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 393 . 394) (nil fontified nil 377 . 394) (377 . 394)) nil (26796 30239 363088 0) 0 nil])
([nil nil ((394 . 395)) nil (26796 30239 363087 0) 0 nil])
([nil nil ((395 . 411)) nil (26796 30239 363087 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-builtin-face fontified t)) . -410) (undo-tree-id10 . -1) 411) nil (26796 30239 363085 0) 0 nil])
([nil nil ((337 . 338)) nil (26796 30239 363076 0) 0 nil])
([nil nil ((338 . 355)) nil (26796 30239 363072 0) 0 nil])
([nil nil ((#("(defun url-decode-qs (s)
  (when s
    (with-output-to-string (out)
      (loop for i from 0 below (length s) do
            (let ((c (char s i)))
              (cond
                ((char= c #\\+) (write-char #\\Space out))
                ((and (char= c #\\%)
                      (<= (+ i 2) (1- (length s))))
                 (let ((h1 (digit-char-p (char s (1+ i)) 16))
                       (h2 (digit-char-p (char s (+ i 2)) 16)))
                   (if (and h1 h2)
                       (progn (write-char (code-char (+ (* h1 16) h2)) out)
                              (incf i 2))
                       (write-char c out))))
                (t (write-char c out))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 25 (fontified t) 25 28 (fontified t) 28 32 (face font-lock-keyword-face fontified t) 32 40 (fontified t) 40 61 (face font-lock-keyword-face fontified t) 61 75 (fontified t) 75 79 (face font-lock-keyword-face fontified t) 79 126 (fontified t) 126 129 (face font-lock-keyword-face fontified t) 129 162 (fontified t) 162 166 (face font-lock-keyword-face fontified t) 166 330 (fontified t) 330 333 (face font-lock-keyword-face fontified t) 333 410 (fontified t) 410 438 (fontified t) 438 458 (fontified t) 458 460 (face font-lock-keyword-face fontified t) 460 497 (fontified t) 497 502 (face font-lock-keyword-face fontified t) 502 564 (fontified t) 564 591 (fontified t) 591 680 (fontified t)) . 2843) (undo-tree-id30 . -680) (undo-tree-id31 . -438) (t 26796 30239 0 0)) nil (26796 37597 406596 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -2842) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) 2843) nil (26796 37597 406594 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 2842)) nil (26796 37597 406592 0) 0 nil])
([nil nil ((2842 . 2844)) nil (26796 37597 406592 0) 0 nil])
([nil nil ((#("x" 0 1 (face font-lock-comment-face fontified t)) . -2842) (undo-tree-id25 . -1) (#("o" 0 1 (face font-lock-comment-face fontified t)) . -2843) (undo-tree-id26 . -1) 2844) nil (26796 37597 406591 0) 0 nil])
([nil nil ((108 . 109)) nil (26796 37597 406590 0) 0 nil])
([nil nil ((109 . 110)) nil (26796 37597 406589 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 122 . 123) (nil fontified nil 110 . 123) (110 . 123)) nil (26796 37597 406589 0) 0 nil])
([nil nil ((4304 . 4305)) nil (26796 37597 406588 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4716 . 4717) (nil fontified nil 4305 . 4717) (4305 . 4717)) nil (26796 37597 406588 0) 0 nil])
([nil nil ((#("core.util" 0 9 (fontified t)) . -4430) (undo-tree-id24 . -9) 4439) nil (26796 37597 406587 0) 0 nil])
([nil nil ((4430 . 4431)) nil (26796 37597 406586 0) 0 nil])
([nil nil ((4431 . 4435)) nil (26796 37597 406586 0) 0 nil])
([nil nil ((#("core.util" 0 9 (fontified t)) . -4656) (undo-tree-id23 . -9) 4665) nil (26796 37597 406585 0) 0 nil])
([nil nil ((4656 . 4661)) nil (26796 37597 406584 0) 0 nil])
([nil nil ((123 . 124)) nil (26796 37597 406584 0) 0 nil])
([nil nil ((124 . 130)) nil (26796 37597 406583 0) 0 nil])
([nil nil ((#("l" 0 1 (face font-lock-builtin-face fontified t)) . -125) (undo-tree-id18 . -1) (#("i" 0 1 (face font-lock-builtin-face fontified t)) . -126) (undo-tree-id19 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -127) (undo-tree-id20 . -1) (#("t" 0 1 (face font-lock-builtin-face fontified t)) . -128) (undo-tree-id21 . -1) (#("-" 0 1 (face font-lock-builtin-face fontified t)) . -129) (undo-tree-id22 . -1) 130) nil (26796 37597 406582 0) 0 nil])
([nil nil ((125 . 134)) nil (26796 37597 406577 0) 0 nil])
([nil nil ((134 . 135)) nil (26796 37597 406576 0) 0 nil])
([nil nil ((135 . 145)) nil (26796 37597 406576 0) 0 nil])
([nil nil ((392 . 396)) nil (26796 37597 406576 0) 0 nil])
([nil nil ((396 . 398)) nil (26796 37597 406575 0) 0 nil])
([nil nil ((398 . 399)) nil (26796 37597 406575 0) 0 nil])
([nil nil ((399 . 407)) nil (26796 37597 406575 0) 0 nil])
([nil nil ((407 . 408)) nil (26796 37597 406575 0) 0 nil])
([nil nil ((408 . 414)) nil (26796 37597 406574 0) 0 nil])
([nil nil ((414 . 415)) nil (26796 37597 406574 0) 0 nil])
([nil nil ((415 . 416)) nil (26796 37597 406573 0) 0 nil])
([nil nil ((416 . 422)) nil (26796 37597 406573 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-comment-face fontified t)) . -420) (undo-tree-id16 . -1) (#(")" 0 1 (face font-lock-comment-face fontified t)) . -421) (undo-tree-id17 . -1) 422) nil (26796 37597 406572 0) 0 nil])
([nil nil ((420 . 422)) nil (26796 37597 406571 0) 0 nil])
([nil nil ((421 . 422)) nil (26796 37597 406570 0) 0 nil])
([nil nil ((423 . 427)) nil (26796 37597 406570 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 433 . 434) (nil fontified nil 427 . 434) (427 . 434)) nil (26796 37597 406569 0) 0 nil])
([nil nil ((427 . 428)) nil (26796 37597 406569 0) 0 nil])
([nil nil ((435 . 436)) nil (26796 37597 406569 0) 0 nil])
([nil nil ((436 . 437)) nil (26796 37597 406568 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 443 . 444) (nil fontified nil 437 . 444) (437 . 444)) nil (26796 37597 406568 0) 0 nil])
([nil nil ((#("g" 0 1 (face font-lock-builtin-face fontified t)) . -441) (undo-tree-id13 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -442) (undo-tree-id14 . -1) (#("t" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -443) (undo-tree-id15 . -1) 444) nil (26796 37597 406566 0) 0 nil])
([nil nil ((441 . 445)) nil (26796 37597 406555 0) 0 nil])
([nil nil ((4784 . 4785)) nil (26796 37597 406551 0) 0 nil])
([nil nil ((3356 . 3368) (t 26796 37597 0 0)) nil (26796 37758 110244 0) 0 nil])
([nil nil ((4797 . 4798) (t 26796 37758 0 0)) nil (26796 49383 617906 0) 0 nil])
([nil nil ((4798 . 4800)) nil (26796 49383 617905 0) 0 nil])
([nil nil ((4800 . 4801)) nil (26796 49383 617905 0) 0 nil])
([nil nil ((4801 . 4802)) nil (26796 49383 617905 0) 0 nil])
([nil nil ((4802 . 4806)) nil (26796 49383 617904 0) 0 nil])
([nil nil ((4806 . 4807)) nil (26796 49383 617904 0) 0 nil])
([nil nil ((4807 . 4812)) nil (26796 49383 617903 0) 0 nil])
([nil nil ((4812 . 4813)) nil (26796 49383 617903 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6540 . 6541) (nil fontified nil 4813 . 6541) (4813 . 6541)) nil (26796 49383 617902 0) 0 nil])
([nil nil ((518 . 522)) nil (26796 49383 617902 0) 0 nil])
([nil nil ((522 . 523)) nil (26796 49383 617902 0) 0 nil])
([nil nil ((523 . 524)) nil (26796 49383 617901 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -523) (undo-tree-id3 . -1) 524) nil (26796 49383 617901 0) 0 nil])
([nil nil ((523 . 524)) nil (26796 49383 617900 0) 0 nil])
([nil nil ((524 . 525)) nil (26796 49383 617899 0) 0 nil])
([nil nil ((525 . 527)) nil (26796 49383 617899 0) 0 nil])
([nil nil ((#("H" 0 1 (face font-lock-comment-face fontified t)) . -526) (undo-tree-id2 . -1) 527) nil (26796 49383 617898 0) 0 nil])
([nil nil ((526 . 529)) nil (26796 49383 617897 0) 0 nil])
([nil nil ((#("O" 0 1 (face font-lock-comment-face fontified t)) . -528) (undo-tree-id1 . -1) 529) nil (26796 49383 617897 0) 0 nil])
([nil nil ((528 . 529)) nil (26796 49383 617895 0) 0 nil])
([nil nil ((529 . 530)) nil (26796 49383 617895 0) 0 nil])
([nil nil ((530 . 535)) nil (26796 49383 617894 0) 0 nil])
([nil nil ((535 . 539)) nil (26796 49383 617894 0) 0 nil])
([nil nil ((539 . 540)) nil (26796 49383 617893 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 557 . 558) (nil fontified nil 540 . 558) (540 . 558)) nil (26796 49383 617893 0) 0 nil])
([nil nil ((558 . 559)) nil (26796 49383 617892 0) 0 nil])
([nil nil ((559 . 565)) nil (26796 49383 617892 0) 0 nil])
([nil nil ((559 . 572) (#("cache-" 0 6 (fontified t)) . -559) (undo-tree-id0 . -6) 565) nil (26796 49383 617891 0) 0 nil])
([nil nil ((559 . 560)) nil (26796 49383 617876 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -6521) (6536 . 6547) (#("lumen.core.util" 0 15 (fontified t)) . -6397) (6412 . 6423) (#("lumen.core.util" 0 15 (fontified t)) . -6192) (6207 . 6218)) nil (26796 49383 617875 0) 0 nil])
([nil nil ((6584 . 6585)) nil (26796 49383 617870 0) 0 nil])
([nil nil ((6585 . 6586) (t 26796 49383 0 0)) nil (26798 57467 676043 0) 0 nil])
([nil nil ((nil fontified nil 6868 . 6869) (nil fontified nil 6860 . 6868) (nil fontified nil 6854 . 6860) (nil fontified nil 6835 . 6854) (nil fontified nil 6830 . 6835) (nil fontified nil 6817 . 6830) (nil fontified nil 6815 . 6817) (nil fontified nil 6810 . 6815) (nil fontified nil 6783 . 6810) (nil fontified nil 6780 . 6783) (nil fontified nil 6770 . 6780) (nil fontified nil 6758 . 6770) (nil fontified nil 6757 . 6758) (nil fontified nil 6752 . 6757) (nil fontified nil 6741 . 6752) (nil fontified nil 6736 . 6741) (nil fontified nil 6717 . 6736) (nil fontified nil 6713 . 6717) (nil fontified nil 6700 . 6713) (nil fontified nil 6698 . 6700) (nil fontified nil 6666 . 6698) (nil fontified nil 6663 . 6666) (nil fontified nil 6653 . 6663) (nil fontified nil 6638 . 6653) (nil fontified nil 6637 . 6638) (nil fontified nil 6632 . 6637) (nil fontified nil 6628 . 6632) (nil fontified nil 6624 . 6628) (nil fontified nil 6604 . 6624) (nil fontified nil 6593 . 6604) (nil fontified nil 6592 . 6593) (nil fontified nil 6587 . 6592) (nil fontified nil 6586 . 6587) (6586 . 6869)) nil (26798 57467 676041 0) 0 nil])
([nil nil ((573 . 577)) nil (26798 57467 676039 0) 0 nil])
([nil nil ((577 . 578)) nil (26798 57467 676038 0) 0 nil])
([nil nil ((578 . 579)) nil (26798 57467 676038 0) 0 nil])
([nil nil ((579 . 580)) nil (26798 57467 676037 0) 0 nil])
([nil nil ((580 . 581)) nil (26798 57467 676037 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -578) (undo-tree-id5 . -1) (#(";" 0 1 (face font-lock-comment-face fontified t)) . -579) (undo-tree-id6 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -580) (undo-tree-id7 . -1) 581) nil (26798 57467 676036 0) 0 nil])
([nil nil ((578 . 579)) nil (26798 57467 676031 0) 0 nil])
([nil nil ((579 . 580)) nil (26798 57467 676030 0) 0 nil])
([nil nil ((580 . 583)) nil (26798 57467 676030 0) 0 nil])
([nil nil ((583 . 584)) nil (26798 57467 676030 0) 0 nil])
([nil nil ((584 . 585)) nil (26798 57467 676029 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -583) (undo-tree-id3 . -1) (#("," 0 1 (face font-lock-comment-face fontified t)) . -584) (undo-tree-id4 . -1) 585) nil (26798 57467 676029 0) 0 nil])
([nil nil ((583 . 584)) nil (26798 57467 676027 0) 0 nil])
([nil nil ((584 . 585)) nil (26798 57467 676027 0) 0 nil])
([nil nil ((585 . 586)) nil (26798 57467 676026 0) 0 nil])
([nil nil ((#("L" 0 1 (face font-lock-comment-face fontified t)) . -585) (undo-tree-id2 . -1) 586) nil (26798 57467 676026 0) 0 nil])
([nil nil ((585 . 590)) nil (26798 57467 676025 0) 0 nil])
([nil nil ((590 . 591)) nil (26798 57467 676024 0) 0 nil])
([nil nil ((591 . 592)) nil (26798 57467 676024 0) 0 nil])
([nil nil ((592 . 593)) nil (26798 57467 676024 0) 0 nil])
([nil nil ((593 . 594)) nil (26798 57467 676023 0) 0 nil])
([nil nil ((594 . 599)) nil (26798 57467 676023 0) 0 nil])
([nil nil ((599 . 603)) nil (26798 57467 676023 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 613 . 614) (nil fontified nil 603 . 614) (603 . 614)) nil (26798 57467 676022 0) 0 nil])
([nil nil ((614 . 615)) nil (26798 57467 676021 0) 0 nil])
([nil nil ((615 . 624)) nil (26798 57467 676021 0) 0 nil])
([nil nil ((624 . 625)) nil (26798 57467 676021 0) 0 nil])
([nil nil ((615 . 627) (#("current-ro" 0 10 (fontified t)) . -615) (undo-tree-id1 . -10) 625) nil (26798 57467 676020 0) 0 nil])
([nil nil ((627 . 628)) nil (26798 57467 676018 0) 0 nil])
([nil nil ((628 . 638)) nil (26798 57467 676018 0) 0 nil])
([nil nil ((628 . 643) (#("current-us" 0 10 (fontified t)) . -628) (undo-tree-id0 . -10) 638) nil (26798 57467 676017 0) 0 nil])
([nil nil ((603 . 604)) nil (26798 57467 676002 0) 0 nil])
([nil nil ((616 . 617)) nil (26798 57467 676002 0) 0 nil])
([nil nil ((630 . 631)) nil (26798 57467 676001 0) 0 nil])
([nil nil ((6942 . 6943)) nil (26798 57467 675997 0) 0 nil])
([nil nil ((6943 . 6944) (t 26798 57467 0 0)) nil (26799 5351 464185 0) 0 nil])
([nil nil ((6944 . 6947)) nil (26799 5351 464184 0) 0 nil])
([nil nil ((6947 . 6948)) nil (26799 5351 464184 0) 0 nil])
([nil nil ((6948 . 6951)) nil (26799 5351 464183 0) 0 nil])
([nil nil ((6951 . 6952)) nil (26799 5351 464183 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9818 . 9819) (nil fontified nil 6952 . 9819) (6952 . 9819)) nil (26799 5351 464182 0) 0 nil])
([nil nil ((9763 . 9768)) nil (26799 5351 464181 0) 0 nil])
([nil nil ((9768 . 9775)) nil (26799 5351 464181 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -9771) (undo-tree-id20 . -1) (#("o" 0 1 (fontified t)) . -9772) (undo-tree-id21 . -1) (#("n" 0 1 (fontified t)) . -9773) (undo-tree-id22 . -1) (#("d" 0 1 (fontified t)) . -9774) (undo-tree-id23 . -1) 9775) nil (26799 5351 464180 0) 0 nil])
([nil nil ((9771 . 9778)) nil (26799 5351 464175 0) 0 nil])
([nil nil ((9769 . 9781) (#("respond-j" 0 9 (fontified t)) . -9769) (undo-tree-id19 . -9) 9778) nil (26799 5351 464174 0) 0 nil])
([nil nil ((9781 . 9782)) nil (26799 5351 464173 0) 0 nil])
([nil nil ((9782 . 9788)) nil (26799 5351 464173 0) 0 nil])
([nil nil ((9788 . 9789)) nil (26799 5351 464172 0) 0 nil])
([nil nil ((9789 . 9797)) nil (26799 5351 464172 0) 0 nil])
([nil nil ((9797 . 9798)) nil (26799 5351 464172 0) 0 nil])
([nil nil ((9798 . 9802)) nil (26799 5351 464171 0) 0 nil])
([nil nil ((9802 . 9803)) nil (26799 5351 464171 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -9802) (undo-tree-id18 . -1) 9803) nil (26799 5351 464170 0) 0 nil])
([nil nil ((9802 . 9805)) nil (26799 5351 464169 0) 0 nil])
([nil nil ((#("
    (response :status 200 :headers hdrs :body writer)))" 0 1 (fontified t) 1 15 (fontified t) 15 22 (face font-lock-builtin-face fontified t) 22 27 (fontified t) 27 35 (face font-lock-builtin-face fontified t) 35 41 (fontified t) 41 46 (face font-lock-builtin-face fontified t) 46 55 (fontified t) 55 56 (fontified t rear-nonsticky t)) . -9805) (undo-tree-id17 . -56) 9861) nil (26799 5351 464169 0) 0 nil])
([nil nil ((8985 . 8986)) nil (26799 5351 464168 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -8985) (undo-tree-id16 . -1) 8986) nil (26799 5351 464167 0) 0 nil])
([nil nil ((#("
(defun %split-lines (s)
  (let ((acc '()) (start 0) (len (length s)))
    (labels ((push-line (end)
               (push (subseq s start end) acc)))
      (loop for i from 0 below len
            do (when (char= (char s i) #\\Newline)
                 (push-line i)
                 (setf start (1+ i))))
      (push-line len))
    (nreverse acc)))

(defun %sse-writer (handler &key retry-ms heartbeat-sec)
  \"Construit un writer (lambda (out)) qui exécute HANDLER et gère heartbeat.\"
  (lambda (out)
    (labels ((send (&key data event id comment)
               ;; Comment (keepalive)
               (when comment
                 (write-string \": \" out)
                 (write-string comment out)
                 (write-char #\\Newline out)
                 (write-char #\\Newline out)
                 (force-output out))
               ;; Event complet
               (when data
                 (when event (format out \"event: ~A~%\" event))
                 (when id    (format out \"id: ~A~%\" id))
                 (dolist (line (%split-lines data))
                   (format out \"data: ~A~%\" line))
                 (write-char #\\Newline out)
                 (force-output out))))
      ;; Option de reconnection (envoyée une fois)
      (when retry-ms
        (format out \"retry: ~D~%~%\" (truncate retry-ms))
        (force-output out))
      ;; Heartbeat (si demandé) dans un petit thread
      (let* ((alive t)
             (hb-thread (and heartbeat-sec
                             (bt:make-thread
                              (lambda ()
                                (loop while alive
                                      do (sleep heartbeat-sec)
                                         (ignore-errors
                                           (send :comment \"tick\"))))
                              :name \"lumen-sse-heartbeat\"))))
        (unwind-protect
             (funcall handler (lambda (&rest args) (apply #'send args)))
          (setf alive nil)
          (when hb-thread (bt:join-thread hb-thread)))))))

(defun respond-sse (req handler &key retry-ms (heartbeat-sec 15) headers)
  \"Répond en SSE. HANDLER reçoit (lambda (&key data event id comment) ...).\"
  (declare (ignore req))
  ;; NB: on retourne une réponse dont le body est un writer (lambda (out) ...).
  (let* ((hdrs `(;; typage / buffering
                 (\"Content-Type\"        . \"text/event-stream; charset=utf-8\")
                 (\"Cache-Control\"       . \"no-cache\")
                 (\"Connection\"          . \"keep-alive\")
                 (\"X-Accel-Buffering\"   . \"no\")
                 ;; conseils proxy/CDN (désactivation eTag et compaction)
                 (\"Pragma\"              . \"no-cache\")
                 ,@headers))
         (writer (%sse-writer handler :retry-ms retry-ms :heartbeat-sec heartbeat-sec)))
    (respond-json writer :headers hdrs)))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 28 (fontified t) 28 31 (face font-lock-keyword-face fontified t) 31 76 (fontified t) 76 82 (face font-lock-keyword-face fontified t) 82 157 (fontified t) 157 161 (face font-lock-keyword-face fontified t) 161 201 (fontified t) 201 205 (face font-lock-keyword-face fontified t) 205 350 (fontified t) 350 351 (fontified t) 351 356 (face font-lock-keyword-face fontified t) 356 357 (fontified t) 357 368 (face font-lock-function-name-face fontified t) 368 378 (fontified t) 378 382 (face font-lock-type-face fontified t) 382 409 (fontified t) 409 484 (face font-lock-doc-face fontified t) 484 488 (fontified t) 488 494 (face font-lock-keyword-face fontified t) 494 506 (fontified t) 506 512 (face font-lock-keyword-face fontified t) 512 521 (fontified t) 521 525 (face font-lock-type-face fontified t) 525 564 (fontified t) 564 567 (face font-lock-comment-delimiter-face fontified t) 567 587 (face font-lock-comment-face fontified t) 587 603 (fontified t) 603 607 (face font-lock-keyword-face fontified t) 607 647 (fontified t) 647 651 (face font-lock-string-face fontified t) 651 841 (fontified t) 841 844 (face font-lock-comment-delimiter-face fontified t) 844 858 (face font-lock-comment-face fontified t) 858 874 (fontified t) 874 878 (face font-lock-keyword-face fontified t) 878 902 (fontified t) 902 906 (face font-lock-keyword-face fontified t) 906 925 (fontified t) 925 938 (face font-lock-string-face fontified t) 938 965 (fontified t) 965 969 (face font-lock-keyword-face fontified t) 969 988 (fontified t) 988 998 (face font-lock-string-face fontified t) 998 1022 (fontified t) 1022 1028 (face font-lock-keyword-face fontified t) 1028 1087 (fontified t) 1087 1099 (face font-lock-string-face fontified t) 1099 1196 (fontified t) 1196 1199 (face font-lock-comment-delimiter-face fontified t) 1199 1241 (face font-lock-comment-face fontified t) 1241 1248 (fontified t) 1248 1252 (face font-lock-keyword-face fontified t) 1252 1282 (fontified t) 1282 1297 (face font-lock-string-face fontified t) 1297 1353 (fontified t) 1353 1356 (face font-lock-comment-delimiter-face fontified t) 1356 1400 (face font-lock-comment-face fontified t) 1400 1407 (fontified t) 1407 1411 (face font-lock-keyword-face fontified t) 1411 1501 (fontified t) 1501 1511 (fontified t) 1511 1542 (fontified t) 1542 1548 (face font-lock-keyword-face fontified t) 1548 1585 (fontified t) 1585 1589 (face font-lock-keyword-face fontified t) 1589 1707 (fontified t) 1707 1720 (face font-lock-keyword-face fontified t) 1720 1770 (fontified t) 1770 1778 (face font-lock-builtin-face fontified t) 1778 1779 (fontified t) 1779 1785 (face font-lock-string-face fontified t) 1785 1820 (fontified t) 1820 1825 (face font-lock-builtin-face fontified t) 1825 1826 (fontified t) 1826 1847 (face font-lock-string-face fontified t) 1847 1861 (fontified t) 1861 1875 (face font-lock-keyword-face fontified t) 1875 1876 (fontified t) 1876 1907 (fontified t) 1907 1913 (face font-lock-keyword-face fontified t) 1913 1915 (fontified t) 1915 1920 (face font-lock-type-face fontified t) 1920 1976 (fontified t) 1976 1987 (fontified t) 1987 1991 (face font-lock-keyword-face fontified t) 1991 2035 (fontified t) 2035 2036 (fontified t) 2036 2037 (fontified t) 2037 2042 (face font-lock-keyword-face fontified t) 2042 2043 (fontified t) 2043 2054 (face font-lock-function-name-face fontified t) 2054 2068 (fontified t) 2068 2072 (face font-lock-type-face fontified t) 2072 2112 (fontified t) 2112 2186 (face font-lock-doc-face fontified t) 2186 2190 (fontified t) 2190 2197 (face font-lock-keyword-face fontified t) 2197 2214 (fontified t) 2214 2217 (face font-lock-comment-delimiter-face fontified t) 2217 2292 (face font-lock-comment-face fontified t) 2292 2295 (fontified t) 2295 2299 (face font-lock-keyword-face fontified t) 2299 2309 (fontified t) 2309 2312 (face font-lock-comment-delimiter-face fontified t) 2312 2331 (face font-lock-comment-face fontified t) 2331 2349 (fontified t) 2349 2363 (face font-lock-string-face fontified t) 2363 2373 (fontified t) 2373 2407 (face font-lock-string-face fontified t) 2407 2427 (fontified t) 2427 2442 (face font-lock-string-face fontified t) 2442 2451 (fontified t) 2451 2461 (face font-lock-string-face fontified t) 2461 2481 (fontified t) 2481 2493 (face font-lock-string-face fontified t) 2493 2505 (fontified t) 2505 2517 (face font-lock-string-face fontified t) 2517 2537 (fontified t) 2537 2556 (face font-lock-string-face fontified t) 2556 2561 (fontified t) 2561 2565 (face font-lock-string-face fontified t) 2565 2584 (fontified t) 2584 2587 (face font-lock-comment-delimiter-face fontified t) 2587 2641 (face font-lock-comment-face fontified t) 2641 2659 (fontified t) 2659 2667 (face font-lock-string-face fontified t) 2667 2683 (fontified t) 2683 2693 (face font-lock-string-face fontified t) 2693 2724 (fontified t) 2724 2762 (fontified t) 2762 2771 (face font-lock-builtin-face fontified t) 2771 2781 (fontified t) 2781 2795 (face font-lock-builtin-face fontified t) 2795 2813 (fontified t) 2813 2818 (fontified t) 2818 2838 (fontified t) 2838 2846 (face font-lock-builtin-face fontified t) 2846 2854 (fontified t)) . -6951) (undo-tree-id13 . -2854) (undo-tree-id14 . -1151) (undo-tree-id15 . -2818) 9805) nil (26799 5351 464166 0) 0 nil])
([nil nil ((6951 . 6952)) nil (26799 5351 464164 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9609 . 9610) (nil fontified nil 6952 . 9610) (6952 . 9610)) nil (26799 5351 464163 0) 0 nil])
([nil nil ((#("
(defun %split-lines (s)
  (let ((acc '()) (start 0) (len (length s)))
    (labels ((push-line (end) (push (subseq s start end) acc)))
      (dotimes (i len)
        (when (char= #\\Newline (char s i))
          (push-line i)
          (setf start (1+ i))))
      (push-line len))
    (nreverse acc)))

(defun %make-sse-writer (handler &key retry-ms heartbeat-sec)
  \"Produit (lambda (out-stream) ...) qui envoie le flux SSE.\"
  (lambda (out)
    (labels ((send (&key data event id comment)
               ;; Comment (keepalive)
               (when comment
                 (write-string \": \" out)
                 (write-string comment out)
                 (write-char #\\Newline out)
                 (write-char #\\Newline out)
                 (force-output out))
               ;; Événement
               (when data
                 (when event (format out \"event: ~A~%\" event))
                 (when id    (format out \"id: ~A~%\" id))
                 (dolist (line (%split-lines data))
                   (format out \"data: ~A~%\" line))
                 (write-char #\\Newline out)
                 (force-output out))))
      ;; Indice de reconnexion (une fois au début)
      (when retry-ms
        (format out \"retry: ~D~%~%\" (truncate retry-ms))
        (force-output out))
      ;; Heartbeat périodique
      (let* ((alive t)
             (hb-thread (and heartbeat-sec
                             (bt:make-thread
                              (lambda ()
                                (loop while alive do
                                  (sleep heartbeat-sec)
                                  (ignore-errors (send :comment \"tick\"))))
                              :name \"lumen-sse-heartbeat\"))))
        (unwind-protect
             (funcall handler (lambda (&rest args) (apply #'send args)))
          (setf alive nil)
          (when hb-thread (bt:join-thread hb-thread)))))))

(defun respond-sse (req handler &key retry-ms (heartbeat-sec 15) headers)
  \"Construit une réponse SSE. HANDLER reçoit (lambda (&key data event id comment) ...).\"
  (declare (ignore req))
  (let* ((hdrs (append '((\"Content-Type\"      . \"text/event-stream; charset=utf-8\")
                         (\"Cache-Control\"     . \"no-cache\")
                         (\"Connection\"        . \"keep-alive\")
                         (\"X-Accel-Buffering\" . \"no\")
                         (\"Pragma\"            . \"no-cache\"))
                       headers))
         (writer (%make-sse-writer handler :retry-ms retry-ms :heartbeat-sec heartbeat-sec)))
    (make-instance 'response
                   :status 200
                   :headers hdrs
                   :body writer)))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 28 (fontified t) 28 31 (face font-lock-keyword-face fontified t) 31 76 (fontified t) 76 82 (face font-lock-keyword-face fontified t) 82 142 (fontified t) 142 149 (face font-lock-keyword-face fontified t) 149 167 (fontified t) 167 171 (face font-lock-keyword-face fontified t) 171 302 (fontified t) 302 303 (fontified t) 303 308 (face font-lock-keyword-face fontified t) 308 309 (fontified t) 309 325 (face font-lock-function-name-face fontified t) 325 335 (fontified t) 335 339 (face font-lock-type-face fontified t) 339 366 (fontified t) 366 425 (face font-lock-doc-face fontified t) 425 429 (fontified t) 429 435 (face font-lock-keyword-face fontified t) 435 447 (fontified t) 447 453 (face font-lock-keyword-face fontified t) 453 462 (fontified t) 462 466 (face font-lock-type-face fontified t) 466 505 (fontified t) 505 508 (face font-lock-comment-delimiter-face fontified t) 508 528 (face font-lock-comment-face fontified t) 528 544 (fontified t) 544 548 (face font-lock-keyword-face fontified t) 548 588 (fontified t) 588 592 (face font-lock-string-face fontified t) 592 782 (fontified t) 782 785 (face font-lock-comment-delimiter-face fontified t) 785 795 (face font-lock-comment-face fontified t) 795 811 (fontified t) 811 815 (face font-lock-keyword-face fontified t) 815 839 (fontified t) 839 843 (face font-lock-keyword-face fontified t) 843 862 (fontified t) 862 875 (face font-lock-string-face fontified t) 875 902 (fontified t) 902 906 (face font-lock-keyword-face fontified t) 906 925 (fontified t) 925 935 (face font-lock-string-face fontified t) 935 959 (fontified t) 959 965 (face font-lock-keyword-face fontified t) 965 1024 (fontified t) 1024 1036 (face font-lock-string-face fontified t) 1036 1133 (fontified t) 1133 1136 (face font-lock-comment-delimiter-face fontified t) 1136 1178 (face font-lock-comment-face fontified t) 1178 1185 (fontified t) 1185 1189 (face font-lock-keyword-face fontified t) 1189 1219 (fontified t) 1219 1234 (face font-lock-string-face fontified t) 1234 1290 (fontified t) 1290 1293 (face font-lock-comment-delimiter-face fontified t) 1293 1314 (face font-lock-comment-face fontified t) 1314 1321 (fontified t) 1321 1325 (face font-lock-keyword-face fontified t) 1325 1456 (fontified t) 1456 1462 (face font-lock-keyword-face fontified t) 1462 1499 (fontified t) 1499 1501 (face font-lock-keyword-face fontified t) 1501 1503 (face font-lock-keyword-face fontified t) 1503 1519 (fontified t) 1519 1610 (fontified t) 1610 1623 (face font-lock-keyword-face fontified t) 1623 1630 (fontified t) 1630 1638 (face font-lock-builtin-face fontified t) 1638 1639 (fontified t) 1639 1645 (face font-lock-string-face fontified t) 1645 1680 (fontified t) 1680 1685 (face font-lock-builtin-face fontified t) 1685 1686 (fontified t) 1686 1707 (face font-lock-string-face fontified t) 1707 1721 (fontified t) 1721 1735 (face font-lock-keyword-face fontified t) 1735 1736 (fontified t) 1736 1767 (fontified t) 1767 1773 (face font-lock-keyword-face fontified t) 1773 1775 (fontified t) 1775 1780 (face font-lock-type-face fontified t) 1780 1847 (fontified t) 1847 1851 (face font-lock-keyword-face fontified t) 1851 1897 (fontified t) 1897 1902 (face font-lock-keyword-face fontified t) 1902 1903 (fontified t) 1903 1914 (face font-lock-function-name-face fontified t) 1914 1928 (fontified t) 1928 1932 (face font-lock-type-face fontified t) 1932 1972 (fontified t) 1972 2058 (face font-lock-doc-face fontified t) 2058 2062 (fontified t) 2062 2069 (face font-lock-keyword-face fontified t) 2069 2087 (fontified t) 2087 2091 (face font-lock-keyword-face fontified t) 2091 2110 (fontified t) 2110 2124 (face font-lock-string-face fontified t) 2124 2132 (fontified t) 2132 2166 (face font-lock-string-face fontified t) 2166 2194 (fontified t) 2194 2209 (face font-lock-string-face fontified t) 2209 2216 (fontified t) 2216 2226 (face font-lock-string-face fontified t) 2226 2254 (fontified t) 2254 2266 (face font-lock-string-face fontified t) 2266 2276 (fontified t) 2276 2288 (face font-lock-string-face fontified t) 2288 2316 (fontified t) 2316 2335 (face font-lock-string-face fontified t) 2335 2338 (fontified t) 2338 2342 (face font-lock-string-face fontified t) 2342 2370 (fontified t) 2370 2378 (face font-lock-string-face fontified t) 2378 2392 (fontified t) 2392 2402 (face font-lock-string-face fontified t) 2402 2481 (fontified t) 2481 2490 (face font-lock-builtin-face fontified t) 2490 2500 (fontified t) 2500 2514 (face font-lock-builtin-face fontified t) 2514 2580 (fontified t) 2580 2587 (face font-lock-builtin-face fontified t) 2587 2611 (fontified t) 2611 2619 (face font-lock-builtin-face fontified t) 2619 2644 (fontified t) 2644 2649 (face font-lock-builtin-face fontified t) 2649 2658 (fontified t) 2658 2659 (rear-nonsticky t fontified t)) . 6951) (undo-tree-id9 . -2659) (undo-tree-id10 . -1736) (undo-tree-id11 . -2659) (undo-tree-id12 . -2659)) nil (26799 5351 464162 0) 0 nil])
([nil nil ((6951 . 6952)) nil (26799 5351 464159 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9589 . 9590) (nil fontified nil 6952 . 9590) (6952 . 9590)) nil (26799 5351 464159 0) 0 nil])
([nil nil ((646 . 650)) nil (26799 5351 464158 0) 0 nil])
([nil nil ((650 . 651)) nil (26799 5351 464158 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 661 . 662) (nil fontified nil 651 . 662) (651 . 662)) nil (26799 5351 464157 0) 0 nil])
([nil nil ((646 . 650)) nil (26799 5351 464157 0) 0 nil])
([nil nil ((650 . 652)) nil (26799 5351 464156 0) 0 nil])
([nil nil ((652 . 653)) nil (26799 5351 464156 0) 0 nil])
([nil nil ((653 . 656)) nil (26799 5351 464155 0) 0 nil])
([nil nil ((656 . 657)) nil (26799 5351 464155 0) 0 nil])
([nil nil ((657 . 659)) nil (26799 5351 464154 0) 0 nil])
([nil nil ((659 . 660)) nil (26799 5351 464154 0) 0 nil])
([nil nil ((660 . 665)) nil (26799 5351 464153 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-comment-face fontified t)) . -664) (undo-tree-id8 . -1) 665) nil (26799 5351 464152 0) 0 nil])
([nil nil ((664 . 670)) nil (26799 5351 464141 0) 0 nil])
([nil nil ((9630 . 9631)) nil (26799 5351 464137 0) 0 nil])
([nil nil ((317 . 318) (t 26799 5351 0 0)) nil (26799 6967 511319 0) 0 nil])
([nil nil ((318 . 322)) nil (26799 6967 511318 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -317) (undo-tree-id24 . -1) (#(":" 0 1 (fontified t)) . -318) (undo-tree-id25 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -319) (undo-tree-id26 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -320) (undo-tree-id27 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -321) (undo-tree-id28 . -1) 322) nil (26799 6967 511315 0) 0 nil])
([nil nil ((8901 . 8904) (t 26799 6967 0 0)) nil (26799 14313 533916 0) 0 nil])
([nil nil ((8904 . 8910)) nil (26799 14313 533915 0) 0 nil])
([nil nil ((8910 . 8911)) nil (26799 14313 533915 0) 0 nil])
([nil nil ((8911 . 8914)) nil (26799 14313 533914 0) 0 nil])
([nil nil ((8914 . 8915)) nil (26799 14313 533914 0) 0 nil])
([nil nil ((8915 . 8922)) nil (26799 14313 533913 0) 0 nil])
([nil nil ((8922 . 8923)) nil (26799 14313 533912 0) 0 nil])
([nil nil ((8923 . 8928)) nil (26799 14313 533912 0) 0 nil])
([nil nil ((9529 . 9534)) nil (26799 14313 533911 0) 0 nil])
([nil nil ((9534 . 9540)) nil (26799 14313 533910 0) 0 nil])
([nil nil ((9540 . 9541)) nil (26799 14313 533908 0) 0 nil])
([nil nil ((9541 . 9545)) nil (26799 14313 533893 0) 0 nil])
([nil nil ((#("S" 0 1 (face font-lock-string-face fontified t)) . -9544) (undo-tree-id3 . -1) 9545) nil (26799 14313 533891 0) 0 nil])
([nil nil ((9544 . 9547)) nil (26799 14313 533888 0) 0 nil])
([nil nil ((#("p" 0 1 (face font-lock-string-face fontified t)) . -9544) (undo-tree-id0 . -1) (#("o" 0 1 (face font-lock-string-face fontified t)) . -9545) (undo-tree-id1 . -1) (#("n" 0 1 (face font-lock-string-face fontified t)) . -9546) (undo-tree-id2 . -1) 9547) nil (26799 14313 533886 0) 0 nil])
([nil nil ((9544 . 9549)) nil (26799 14313 533859 0) 0 nil])
([nil nil ((9549 . 9550)) nil (26799 14313 533858 0) 0 nil])
([nil nil ((9550 . 9559)) nil (26799 14313 533856 0) 0 nil])
([nil nil ((9559 . 9561)) nil (26799 14313 533850 0) 0 nil])
([nil nil ((#("(print \"IN RESPOND SSE\")" 0 7 (fontified t) 7 23 (face font-lock-string-face fontified t) 23 24 (fontified t)) . 8904) (undo-tree-id5 . -23) (undo-tree-id6 . -23) (undo-tree-id7 . -23) (undo-tree-id8 . -23) (undo-tree-id9 . -23) (undo-tree-id10 . -23) (undo-tree-id11 . -23) (undo-tree-id12 . -23) (undo-tree-id13 . -23) (undo-tree-id14 . -23) (undo-tree-id15 . -24) (t 26799 14313 0 0)) nil (26799 14336 857106 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 8901) (undo-tree-id4 . -1)) nil (26799 14336 857081 0) 0 nil])
([nil nil ((8928 . 8931)) nil (26799 14336 857064 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8954 . 8955) (nil fontified nil 8954 . 8955) (nil fontified nil 8938 . 8954) (nil fontified nil 8931 . 8938) (8931 . 8955)) nil (26799 14336 857051 0) 0 nil])
([nil nil ((9125 . 9127) (t 26799 14336 0 0)) nil (26799 16582 437172 0) 0 nil])
([nil nil ((9377 . 9379)) nil (26799 16582 437171 0) 0 nil])
([nil nil ((9412 . 9417)) nil (26799 16582 437167 0) 0 nil])
([nil nil ((7291 . 7293) (t 26799 16582 0 0)) nil (26799 19789 955275 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9262 . 9263) (nil fontified nil 7293 . 9263) (7293 . 9263)) nil (26799 19789 955274 0) 0 nil])
([nil nil ((#("

(defun %sse-writer (handler &key retry-ms heartbeat-sec)
  \"Construit (lambda (send-chunk)) pour streamer SSE.
   send-chunk s -> envoie la chaîne s (le serveur la chnkette).\"
  (lambda (send-chunk)
    (labels ((emit (&key data event id comment)
               (when comment
                 (funcall send-chunk (format nil \": ~A~%~%\" comment)))
               (when data
                 (when event (funcall send-chunk (format nil \"event: ~A~%\" event)))
                 (when id    (funcall send-chunk (format nil \"id: ~A~%\" id)))
                 (dolist (line (%split-lines data))
                   (funcall send-chunk (format nil \"data: ~A~%\" line)))
                 (funcall send-chunk (format nil \"~%\")))))
      ;; Indice de reconnexion du client
      (when retry-ms
        (funcall send-chunk (format nil \"retry: ~D~%~%\" (truncate retry-ms))))
      ;; Heartbeat
      (let* ((alive t)
             (hb-thread (and heartbeat-sec
                             (bt:make-thread
                              (lambda ()
                                (loop while alive do
                                  (sleep heartbeat-sec)
                                  (ignore-errors (emit :comment \"tick\"))))
                              :name \"lumen-sse-heartbeat\"))))
        (unwind-protect
             (funcall handler (lambda (&rest args) (apply #'emit args)))
          (setf alive nil)
          (when hb-thread (bt:join-thread hb-thread)))))))

(defun respond-sse (req handler &key retry-ms (heartbeat-sec 15) headers)
  \"Réponse SSE. HANDLER reçoit (lambda (&key data event id comment) ...).\"  
  (declare (ignore req))
  (print \"IN RESPOND SSE\")
  (let* ((hdrs (append '((\"Content-Type\"      . \"text/event-stream; charset=utf-8\")
                         (\"Cache-Control\"     . \"no-cache\")
                         ;;(\"Connection\"        . \"keep-alive\")
                         (\"X-Accel-Buffering\" . \"no\")
                         (\"Pragma\"            . \"no-cache\")
                         ;; on indique chunked pour signaler le streaming
                         ;;(\"Transfer-Encoding\" . \"chunked\")
			 )
                       headers))
         (writer (%sse-writer handler :retry-ms retry-ms :heartbeat-sec heartbeat-sec)))
    (print \"REPONSE RETOURNEE\")
    (make-instance 'response
                   :status 200
                   :headers hdrs
                   :body writer)))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 20 (face font-lock-function-name-face fontified t) 20 30 (fontified t) 30 34 (face font-lock-type-face fontified t) 34 61 (fontified t) 61 177 (face font-lock-doc-face fontified t) 177 181 (fontified t) 181 187 (face font-lock-keyword-face fontified t) 187 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 221 (fontified t) 221 225 (face font-lock-type-face fontified t) 225 265 (fontified t) 265 269 (face font-lock-keyword-face fontified t) 269 327 (fontified t) 327 337 (face font-lock-string-face fontified t) 337 365 (fontified t) 365 369 (face font-lock-keyword-face fontified t) 369 393 (fontified t) 393 397 (face font-lock-keyword-face fontified t) 397 436 (fontified t) 436 449 (face font-lock-string-face fontified t) 449 477 (fontified t) 477 481 (face font-lock-keyword-face fontified t) 481 520 (fontified t) 520 530 (face font-lock-string-face fontified t) 530 555 (fontified t) 555 561 (face font-lock-keyword-face fontified t) 561 640 (fontified t) 640 652 (face font-lock-string-face fontified t) 652 710 (fontified t) 710 714 (face font-lock-string-face fontified t) 714 726 (fontified t) 726 729 (face font-lock-comment-delimiter-face fontified t) 729 761 (face font-lock-comment-face fontified t) 761 768 (fontified t) 768 772 (face font-lock-keyword-face fontified t) 772 822 (fontified t) 822 837 (face font-lock-string-face fontified t) 837 867 (fontified t) 867 870 (face font-lock-comment-delimiter-face fontified t) 870 880 (face font-lock-comment-face fontified t) 880 887 (fontified t) 887 891 (face font-lock-keyword-face fontified t) 891 1022 (fontified t) 1022 1028 (face font-lock-keyword-face fontified t) 1028 1065 (fontified t) 1065 1069 (face font-lock-keyword-face fontified t) 1069 1176 (fontified t) 1176 1189 (face font-lock-keyword-face fontified t) 1189 1196 (fontified t) 1196 1200 (face font-lock-builtin-face fontified t) 1200 1204 (face font-lock-builtin-face fontified t) 1204 1205 (fontified t) 1205 1211 (face font-lock-string-face fontified t) 1211 1216 (fontified t) 1216 1246 (fontified t) 1246 1251 (face font-lock-builtin-face fontified t) 1251 1252 (fontified t) 1252 1262 (face font-lock-string-face fontified t) 1262 1273 (face font-lock-string-face fontified t) 1273 1287 (fontified t) 1287 1301 (face font-lock-keyword-face fontified t) 1301 1333 (fontified t) 1333 1339 (face font-lock-keyword-face fontified t) 1339 1341 (fontified t) 1341 1346 (face font-lock-type-face fontified t) 1346 1413 (fontified t) 1413 1417 (face font-lock-keyword-face fontified t) 1417 1462 (fontified t) 1462 1463 (fontified t) 1463 1468 (face font-lock-keyword-face fontified t) 1468 1469 (fontified t) 1469 1480 (face font-lock-function-name-face fontified t) 1480 1494 (fontified t) 1494 1498 (face font-lock-type-face fontified t) 1498 1501 (fontified t) 1501 1536 (fontified t) 1536 1538 (fontified t) 1538 1610 (face font-lock-doc-face fontified t) 1610 1612 (fontified t) 1612 1613 (fontified t) 1613 1616 (fontified t) 1616 1623 (face font-lock-keyword-face fontified t) 1623 1638 (fontified t) 1638 1640 (fontified t) 1640 1647 (fontified t) 1647 1663 (face font-lock-string-face fontified t) 1663 1664 (fontified t rear-nonsticky t) 1664 1665 (fontified t) 1665 1668 (fontified t) 1668 1672 (face font-lock-keyword-face fontified t) 1672 1691 (fontified t) 1691 1705 (face font-lock-string-face fontified t) 1705 1713 (fontified t) 1713 1747 (face font-lock-string-face fontified t) 1747 1775 (fontified t) 1775 1790 (face font-lock-string-face fontified t) 1790 1797 (fontified t) 1797 1807 (face font-lock-string-face fontified t) 1807 1809 (fontified t) 1809 1834 (fontified t) 1834 1836 (face font-lock-comment-delimiter-face fontified t) 1836 1837 (face font-lock-comment-face fontified t) 1837 1849 (face font-lock-comment-face fontified t) 1849 1859 (face font-lock-comment-face fontified t) 1859 1871 (face font-lock-comment-face fontified t) 1871 1873 (face font-lock-comment-face fontified t) 1873 1899 (fontified t) 1899 1918 (face font-lock-string-face fontified t) 1918 1921 (fontified t) 1921 1925 (face font-lock-string-face fontified t) 1925 1953 (fontified t) 1953 1961 (face font-lock-string-face fontified t) 1961 1975 (fontified t) 1975 1985 (face font-lock-string-face fontified t) 1985 2012 (fontified t) 2012 2015 (face font-lock-comment-delimiter-face fontified t) 2015 2061 (face font-lock-comment-face fontified t) 2061 2086 (fontified t) 2086 2088 (face font-lock-comment-delimiter-face fontified t) 2088 2089 (face font-lock-comment-face fontified t) 2089 2108 (face font-lock-comment-face fontified t) 2108 2111 (face font-lock-comment-face fontified t) 2111 2120 (face font-lock-comment-face fontified t) 2120 2122 (face font-lock-comment-face fontified t) 2122 2128 (fontified t) 2128 2161 (fontified t) 2161 2199 (fontified t) 2199 2208 (face font-lock-builtin-face fontified t) 2208 2218 (fontified t) 2218 2232 (face font-lock-builtin-face fontified t) 2232 2250 (fontified t) 2250 2261 (fontified t) 2261 2280 (face font-lock-string-face fontified t) 2280 2281 (fontified t) 2281 2282 (fontified t) 2282 2330 (fontified t) 2330 2337 (face font-lock-builtin-face fontified t) 2337 2361 (fontified t) 2361 2369 (face font-lock-builtin-face fontified t) 2369 2394 (fontified t) 2394 2399 (face font-lock-builtin-face fontified t) 2399 2410 (fontified t)) . -9263) (undo-tree-id16 . -1887) (undo-tree-id17 . -793) (undo-tree-id18 . -915) (undo-tree-id19 . -1610) (undo-tree-id20 . -180) (undo-tree-id21 . -2249) (undo-tree-id22 . -2281) (undo-tree-id23 . -1612) (undo-tree-id24 . -1612) (undo-tree-id25 . -1610) (undo-tree-id26 . -1984) (undo-tree-id27 . -537) (undo-tree-id28 . -1925) (undo-tree-id29 . -1834) (undo-tree-id30 . -2086) (undo-tree-id31 . -1925) (undo-tree-id32 . -2410) (undo-tree-id33 . -782) (undo-tree-id34 . -1640) 11673) nil (26799 19789 955272 0) 0 nil])
([nil nil ((9263 . 9264)) nil (26799 19789 955248 0) 0 nil])
([nil nil ((8666 . 8668) (t 26799 19789 0 0)) nil (26799 43251 269639 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9681 . 9682) (nil fontified nil 8668 . 9682) (8668 . 9682)) nil (26799 43251 269638 0) 0 nil])
([nil nil ((7292 . 7293)) nil (26799 43251 269637 0) 0 nil])
([nil nil ((7293 . 7295)) nil (26799 43251 269637 0) 0 nil])
([nil nil ((8670 . 8671)) nil (26799 43251 269636 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-comment-face fontified t)) . -8670) (undo-tree-id35 . -1) 8671) nil (26799 43251 269635 0) 0 nil])
([nil nil ((8670 . 8672)) nil (26799 43251 269623 0) 0 nil])
([nil nil ((8672 . 8673)) nil (26799 43251 269618 0) 0 nil])
([nil nil ((#("#" 0 1 (fontified t)) . -7293) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (#("|" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -7294) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) 7295 (t 26799 43251 0 0)) nil (26799 44727 314412 0) 0 nil])
([nil nil ((#("|" 0 1 (fontified t)) . -8668) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (#("#" 0 1 (fontified t)) . -8669) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) 8670) nil (26799 44727 314393 0) 0 nil])
([nil nil ((8669 . 8671)) nil (26799 44727 314371 0) 0 nil])
([nil nil ((9687 . 9689)) nil (26799 44727 314370 0) 0 nil])
([nil nil ((9689 . 9690)) nil (26799 44727 314365 0) 0 nil])
([nil nil ((9689 . 9691) (t 26799 44727 0 0)) nil (26799 45251 32473 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10649 . 10650) (nil fontified nil 9691 . 10650) (9691 . 10650)) nil (26799 45251 32473 0) 0 nil])
([nil nil ((#("#|" 0 2 (face font-lock-comment-delimiter-face fontified t)) . 8669) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -2)) nil (26799 45251 32471 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -8668) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) 8669) nil (26799 45251 32463 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7294 . 7295) (nil fontified nil 7293 . 7295) (7293 . 7295)) nil (26799 45251 32442 0) 0 nil])
([nil nil ((#("(defun %sse-writer (handler &key retry-ms heartbeat-sec)
  (declare (ignore heartbeat-sec))
  (lambda (send-chunk)
    (labels ((emit (&key data event id comment)
               (when comment (funcall send-chunk (format nil \": ~A~%~%\" comment)))
               (when data
                 (when event (funcall send-chunk (format nil \"event: ~A~%\" event)))
                 (when id    (funcall send-chunk (format nil \"id: ~A~%\" id)))
                 (dolist (line (%split-lines data))
                   (funcall send-chunk (format nil \"data: ~A~%\" line)))
                 (funcall send-chunk (format nil \"~%\")))))
      (when retry-ms
        (funcall send-chunk (format nil \"retry: ~D~%~%\" (truncate retry-ms))))
      (handler-case
          (funcall handler (lambda (&rest args) (apply #'emit args)))
        (error (e)
          (format *error-output* \"~&[SSE] handler error: ~A~%\" e)
          (funcall send-chunk (format nil \": error ~A~%~%\" e)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 18 (face font-lock-function-name-face fontified t) 18 28 (fontified t) 28 32 (face font-lock-type-face fontified t) 32 60 (fontified t) 60 67 (face font-lock-keyword-face fontified t) 67 95 (fontified t) 95 101 (face font-lock-keyword-face fontified t) 101 120 (fontified t) 120 126 (face font-lock-keyword-face fontified t) 126 135 (fontified t) 135 139 (face font-lock-type-face fontified t) 139 179 (fontified t) 179 183 (face font-lock-keyword-face fontified t) 183 224 (fontified t) 224 234 (face font-lock-string-face fontified t) 234 262 (fontified t) 262 266 (face font-lock-keyword-face fontified t) 266 290 (fontified t) 290 294 (face font-lock-keyword-face fontified t) 294 333 (fontified t) 333 346 (face font-lock-string-face fontified t) 346 374 (fontified t) 374 378 (face font-lock-keyword-face fontified t) 378 417 (fontified t) 417 427 (face font-lock-string-face fontified t) 427 452 (fontified t) 452 458 (face font-lock-keyword-face fontified t) 458 481 (fontified t) 481 486 (fontified t) 486 537 (fontified t) 537 549 (face font-lock-string-face fontified t) 549 607 (fontified t) 607 611 (face font-lock-string-face fontified t) 611 616 (fontified t) 616 617 (fontified t) 617 624 (fontified t) 624 628 (face font-lock-keyword-face fontified t) 628 678 (fontified t) 678 693 (face font-lock-string-face fontified t) 693 724 (fontified t) 724 736 (face font-lock-keyword-face fontified t) 736 765 (fontified t) 765 771 (face font-lock-keyword-face fontified t) 771 773 (fontified t) 773 778 (face font-lock-type-face fontified t) 778 816 (fontified t) 816 821 (face font-lock-warning-face fontified t) 821 859 (fontified t) 859 888 (face font-lock-string-face fontified t) 888 934 (fontified t) 934 950 (face font-lock-string-face fontified t) 950 958 (fontified t) 958 959 (fontified t rear-nonsticky t)) . -9690) (undo-tree-id88 . -617) (undo-tree-id89 . -163) (undo-tree-id90 . -163) (undo-tree-id91 . -163) (undo-tree-id92 . -163) (undo-tree-id93 . -163) (undo-tree-id94 . -163) (undo-tree-id95 . -163) (undo-tree-id96 . -163) (undo-tree-id97 . -163) (undo-tree-id98 . -163) (undo-tree-id99 . -163) (undo-tree-id100 . -163) (undo-tree-id101 . -163) (undo-tree-id102 . -163) (undo-tree-id103 . -163) (undo-tree-id104 . -163) (undo-tree-id105 . -163) (undo-tree-id106 . -163) (undo-tree-id107 . -163) (undo-tree-id108 . -57) (undo-tree-id109 . -163) (undo-tree-id110 . -163) (undo-tree-id111 . -57) (undo-tree-id112 . -163) (undo-tree-id113 . -959) (undo-tree-id114 . -892) (undo-tree-id115 . -959) (undo-tree-id116 . -959) 10649 (t 26799 45251 0 0)) nil (26799 45473 741912 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11232 . 11233) (nil fontified nil 9690 . 11233) (9690 . 11233)) nil (26799 45473 741875 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1156) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 1157 (t 26799 45473 0 0)) nil (26800 2702 72654 0) 0 nil])
([nil nil ((#("
#|
(defun %sse-writer (handler &key retry-ms heartbeat-sec)
  (lambda (send-chunk)
    (labels ((emit (&key data event id comment)
               (when comment (funcall send-chunk (format nil \": ~A~%~%\" comment)))
               (when data
                 (when event (funcall send-chunk (format nil \"event: ~A~%\" event)))
                 (when id    (funcall send-chunk (format nil \"id: ~A~%\" id)))
                 (dolist (line (%split-lines data))
                   (funcall send-chunk (format nil \"data: ~A~%\" line)))
                 (funcall send-chunk (format nil \"~%\")))))
      (when retry-ms
        (funcall send-chunk (format nil \"retry: ~D~%~%\" (truncate retry-ms))))
      (let* ((alive t)
             ;; ⚠️ utilise bordeaux-threads:make-thread (ou importe-le) — pas “bt”
             (hb-thread (and heartbeat-sec
                             (bordeaux-threads:make-thread
                              (lambda ()
                                (loop while alive do
                                  (sleep heartbeat-sec)
                                  (ignore-errors (emit :comment \"tick\"))))
                              :name \"lumen-sse-heartbeat\"))))
        (unwind-protect
             (funcall handler (lambda (&rest args) (apply #'emit args)))
          (setf alive nil)
          (when hb-thread (bordeaux-threads:join-thread hb-thread)))))))

(defun %sse-writer (handler &key retry-ms heartbeat-sec) ; heartbeat-sec ignoré (géré par la route)
  (declare (ignore heartbeat-sec))
  (lambda (send-chunk)
    (labels ((emit (&key data event id comment)
               (when comment
                 (funcall send-chunk (format nil \": ~A~%~%\" comment)))
               (when data
                 (when event (funcall send-chunk (format nil \"event: ~A~%\" event)))
                 (when id    (funcall send-chunk (format nil \"id: ~A~%\" id)))
                 (dolist (line (%split-lines data))
                   (funcall send-chunk (format nil \"data: ~A~%\" line)))
                 (funcall send-chunk (format nil \"~%\")))))
      (when retry-ms
        (funcall send-chunk (format nil \"retry: ~D~%~%\" (truncate retry-ms))))
      ;; 💡 Appelle le handler tout de suite, sans thread ni heartbeat côté core.
      ;; Le heartbeat sera fait par la route via un :timeout et (send :comment \"idle\").
      (funcall handler (lambda (&rest args) (apply #'emit args))))))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 269 (face font-lock-comment-face fontified t) 269 325 (face font-lock-comment-face fontified t) 325 1825 (face font-lock-comment-face fontified t) 1825 1873 (face font-lock-comment-face fontified t) 1873 2394 (face font-lock-comment-face fontified t) 2394 2396 (face font-lock-comment-delimiter-face fontified t) 2396 2397 (fontified t)) . -7291) (undo-tree-id0 . -2397) (undo-tree-id1 . -894) 9688 (t 26800 2702 0 0)) nil (26804 7751 590786 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1397 . 1398) (nil fontified nil 1332 . 1398) (1332 . 1398) (t 26804 7751 0 0)) nil (26805 33893 242303 0) 0 nil])
([nil nil ((1398 . 1399)) nil (26805 33893 242302 0) 0 nil])
([nil nil ((2455 . 2457)) nil (26805 33893 242301 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3131 . 3132) (nil fontified nil 2457 . 3132) (2457 . 3132)) nil (26805 33893 242297 0) 0 nil])
([nil nil ((1330 . 1332) (t 26805 33893 0 0)) nil (26805 36014 480851 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2781 . 2782) (nil fontified nil 1332 . 2782) (1332 . 2782)) nil (26805 36014 480850 0) 0 nil])
([nil nil ((2782 . 2784)) nil (26805 36014 480850 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2927 . 2928) (nil fontified nil 2868 . 2928) (nil fontified nil 2864 . 2868) (nil fontified nil 2853 . 2864) (nil fontified nil 2849 . 2853) (nil fontified nil 2788 . 2849) (nil fontified nil 2784 . 2788) (2784 . 2928)) nil (26805 36014 480849 0) 0 nil])
([nil nil ((#("Conditions" 0 10 (face font-lock-comment-face fontified t)) . -2853) (undo-tree-id4 . -10) 2863) nil (26805 36014 480848 0) 0 nil])
([nil nil ((2853 . 2860)) nil (26805 36014 480846 0) 0 nil])
([nil nil ((3507 . 3509)) nil (26805 36014 480846 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3652 . 3653) (nil fontified nil 3593 . 3653) (nil fontified nil 3589 . 3593) (nil fontified nil 3578 . 3589) (nil fontified nil 3574 . 3578) (nil fontified nil 3513 . 3574) (nil fontified nil 3509 . 3513) (3509 . 3653)) nil (26805 36014 480845 0) 0 nil])
([nil nil ((#("Conditions" 0 10 (face font-lock-comment-face fontified t)) . -3578) (undo-tree-id3 . -10) 3588) nil (26805 36014 480844 0) 0 nil])
([nil nil ((3578 . 3586)) nil (26805 36014 480842 0) 0 nil])
([nil nil ((5501 . 5503)) nil (26805 36014 480841 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5704 . 5705) (nil fontified nil 5503 . 5705) (5503 . 5705)) nil (26805 36014 480840 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -5704) (undo-tree-id2 . -1) 5705) nil (26805 36014 480837 0) 0 nil])
([nil nil ((3305 . 3308) (t 26805 36014 0 0)) nil (26809 47167 252988 0) 0 nil])
([nil nil ((3308 . 3314)) nil (26809 47167 252987 0) 0 nil])
([nil nil ((3314 . 3315)) nil (26809 47167 252986 0) 0 nil])
([nil nil ((3315 . 3320)) nil (26809 47167 252982 0) 0 nil])
([nil nil ((3305 . 3308) (t 26809 47167 0 0)) nil (26809 47191 164171 0) 0 nil])
([nil nil ((3308 . 3314)) nil (26809 47191 164170 0) 0 nil])
([nil nil ((3314 . 3315)) nil (26809 47191 164170 0) 0 nil])
([nil nil ((3315 . 3316)) nil (26809 47191 164169 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3329 . 3330) (nil fontified nil 3316 . 3330) (3316 . 3330)) nil (26809 47191 164168 0) 0 nil])
([nil nil ((3330 . 3332)) nil (26809 47191 164164 0) 0 nil])
([nil nil ((375 . 388) (t 26809 47191 0 0)) nil (26812 60095 565001 0) 0 nil])
([nil nil ((388 . 389)) nil (26812 60095 565001 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3980 . 3981) (nil fontified nil 3708 . 3981) (3708 . 3981)) nil (26812 60095 565000 0) 0 nil])
([nil nil ((3981 . 3982)) nil (26812 60095 564996 0) 0 nil])
([nil nil ((375 . 376) (t 26812 60095 0 0)) nil (26813 38324 119688 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 386 . 387) (nil fontified nil 376 . 387) (376 . 387)) nil (26813 38324 119687 0) 0 nil])
([nil nil ((387 . 388)) nil (26813 38324 119686 0) 0 nil])
([nil nil ((388 . 391) (#(" " 0 1 (fontified nil)) . 387) (undo-tree-id0 . -1) (388 . 389)) nil (26813 38324 119681 0) 0 nil])
([nil nil ((387 . 388) (t 26813 38324 0 0)) nil (26813 38957 956193 0) 0 nil])
([nil nil ((nil fontified nil 399 . 400) (nil fontified nil 389 . 399) (nil fontified nil 388 . 389) (388 . 400)) nil (26813 38957 956193 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-builtin-face fontified t)) . -398) (undo-tree-id16 . -1) (#("2" 0 1 (face font-lock-builtin-face fontified t rear-nonsticky t)) . -399) (undo-tree-id17 . -1) 400) nil (26813 38957 956192 0) 0 nil])
([nil nil ((398 . 400)) nil (26813 38957 956190 0) 0 nil])
([nil nil ((#("5" 0 1 (face font-lock-builtin-face fontified t)) . -399) (undo-tree-id15 . -1) 400) nil (26813 38957 956189 0) 0 nil])
([nil nil ((399 . 400)) nil (26813 38957 956188 0) 0 nil])
([nil nil ((400 . 404)) nil (26813 38957 956188 0) 0 nil])
([nil nil ((nil fontified nil 415 . 416) (nil fontified nil 405 . 415) (nil fontified nil 404 . 405) (404 . 416)) nil (26813 38957 956187 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-builtin-face fontified t)) . -414) (undo-tree-id13 . -1) (#("2" 0 1 (face font-lock-builtin-face fontified t rear-nonsticky t)) . -415) (undo-tree-id14 . -1) 416) nil (26813 38957 956186 0) 0 nil])
([nil nil ((414 . 416)) nil (26813 38957 956184 0) 0 nil])
([nil nil ((5246 . 5248)) nil (26813 38957 956184 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5630 . 5631) (nil fontified nil 5621 . 5631) (nil fontified nil 5616 . 5621) (nil fontified nil 5613 . 5616) (nil fontified nil 5608 . 5613) (nil fontified nil 5601 . 5608) (nil fontified nil 5564 . 5601) (nil fontified nil 5557 . 5564) (nil fontified nil 5546 . 5557) (nil fontified nil 5542 . 5546) (nil fontified nil 5510 . 5542) (nil fontified nil 5502 . 5510) (nil fontified nil 5483 . 5502) (nil fontified nil 5471 . 5483) (nil fontified nil 5468 . 5471) (nil fontified nil 5463 . 5468) (nil fontified nil 5458 . 5463) (nil fontified nil 5452 . 5458) (nil fontified nil 5429 . 5452) (nil fontified nil 5336 . 5429) (nil fontified nil 5304 . 5336) (nil fontified nil 5282 . 5304) (nil fontified nil 5272 . 5282) (nil fontified nil 5268 . 5272) (nil fontified nil 5266 . 5268) (nil fontified nil 5264 . 5266) (nil fontified nil 5255 . 5264) (nil fontified nil 5254 . 5255) (nil fontified nil 5249 . 5254) (nil fontified nil 5248 . 5249) (5248 . 5631)) nil (26813 38957 956183 0) 0 nil])
([nil nil ((5631 . 5633)) nil (26813 38957 956180 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6015 . 6016) (nil fontified nil 6006 . 6016) (nil fontified nil 6001 . 6006) (nil fontified nil 5998 . 6001) (nil fontified nil 5993 . 5998) (nil fontified nil 5986 . 5993) (nil fontified nil 5949 . 5986) (nil fontified nil 5942 . 5949) (nil fontified nil 5931 . 5942) (nil fontified nil 5927 . 5931) (nil fontified nil 5895 . 5927) (nil fontified nil 5887 . 5895) (nil fontified nil 5868 . 5887) (nil fontified nil 5856 . 5868) (nil fontified nil 5853 . 5856) (nil fontified nil 5848 . 5853) (nil fontified nil 5843 . 5848) (nil fontified nil 5837 . 5843) (nil fontified nil 5814 . 5837) (nil fontified nil 5721 . 5814) (nil fontified nil 5689 . 5721) (nil fontified nil 5667 . 5689) (nil fontified nil 5657 . 5667) (nil fontified nil 5653 . 5657) (nil fontified nil 5651 . 5653) (nil fontified nil 5649 . 5651) (nil fontified nil 5640 . 5649) (nil fontified nil 5639 . 5640) (nil fontified nil 5634 . 5639) (nil fontified nil 5633 . 5634) (5633 . 6016)) nil (26813 38957 956179 0) 0 nil])
([nil nil ((#("422" 0 1 (face font-lock-function-name-face fontified t) 1 3 (face font-lock-function-name-face fontified t)) . -5263) (undo-tree-id12 . -3) 5266) nil (26813 38957 956176 0) 0 nil])
([nil nil ((5263 . 5266)) nil (26813 38957 956175 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-doc-face fontified t)) . -5338) (undo-tree-id10 . -1) (#("2" 0 1 (face font-lock-doc-face fontified t)) . -5339) (undo-tree-id11 . -1) 5340) nil (26813 38957 956174 0) 0 nil])
([nil nil ((5338 . 5340)) nil (26813 38957 956172 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-function-name-face fontified t)) . -5649) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (#("2" 0 1 (face font-lock-function-name-face fontified t)) . -5650) (undo-tree-id8 . -1) (undo-tree-id9 . -1) 5651) nil (26813 38957 956172 0) 0 nil])
([nil nil ((5649 . 5650)) nil (26813 38957 956167 0) 0 nil])
([nil nil ((5650 . 5651)) nil (26813 38957 956166 0) 0 nil])
([nil nil ((#("5" 0 1 (face font-lock-doc-face fontified t)) . -5339) (undo-tree-id5 . -1) 5340) nil (26813 38957 956165 0) 0 nil])
([nil nil ((5339 . 5340)) nil (26813 38957 956164 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-doc-face fontified t)) . -5723) (undo-tree-id3 . -1) (#("2" 0 1 (face font-lock-doc-face fontified t)) . -5724) (undo-tree-id4 . -1) 5725) nil (26813 38957 956164 0) 0 nil])
([nil nil ((5723 . 5725)) nil (26813 38957 956161 0) 0 nil])
([nil nil ((#("422" 0 3 (fontified t)) . -5609) (undo-tree-id2 . -3) 5612) nil (26813 38957 956161 0) 0 nil])
([nil nil ((5609 . 5612)) nil (26813 38957 956159 0) 0 nil])
([nil nil ((#("422" 0 3 (fontified t)) . -5994) (undo-tree-id1 . -3) 5997) nil (26813 38957 956157 0) 0 nil])
([nil nil ((5994 . 5997)) nil (26813 38957 956142 0) 0 nil])
([nil nil ((13264 . 13265) (t 26813 38957 0 0)) nil (26813 42926 364672 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13926 . 13927) (nil fontified nil 13265 . 13927) (13265 . 13927)) nil (26813 42926 364671 0) 0 nil])
([nil nil ((#("*" 0 1 (face font-lock-function-name-face fontified t)) . -13284) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 13285) nil (26813 42926 364670 0) 0 nil])
([nil nil ((#("lumen.core.http:" 0 16 (fontified t)) . -13481) (undo-tree-id5 . -16) 13497) nil (26813 42926 364668 0) 0 nil])
([nil nil ((#("lumen.core.http:" 0 16 (fontified t)) . -13531) (undo-tree-id4 . -16) 13547) nil (26813 42926 364667 0) 0 nil])
([nil nil ((#("lumen.core.http:" 0 16 (fontified t)) . -13579) (undo-tree-id3 . -16) 13595) nil (26813 42926 364665 0) 0 nil])
([nil nil ((#("lumen.core.http:" 0 16 (fontified t)) . -13650) (undo-tree-id2 . -16) 13666) nil (26813 42926 364664 0) 0 nil])
([nil nil ((#("lumen.core.http:" 0 16 (fontified t)) . -13699) (undo-tree-id1 . -16) 13715) nil (26813 42926 364662 0) 0 nil])
([nil nil ((280 . 286)) nil (26813 42926 364661 0) 0 nil])
([nil nil ((280 . 292) (#("ctx-fr" 0 6 (fontified t)) . -280) (undo-tree-id0 . -6) 286) nil (26813 42926 364659 0) 0 nil])
([nil nil ((292 . 293)) nil (26813 42926 364643 0) 0 nil])
([nil nil ((280 . 281)) nil (26813 42926 364642 0) 0 nil])
([nil nil ((13860 . 13861)) nil (26813 42926 364637 0) 0 nil])
([nil nil ((10826 . 10827) (t 26813 42926 0 0)) nil (26818 57125 795346 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10944 . 10945) (nil fontified nil 10936 . 10945) (nil fontified nil 10930 . 10936) (nil fontified nil 10911 . 10930) (nil fontified nil 10906 . 10911) (nil fontified nil 10859 . 10906) (nil fontified nil 10856 . 10859) (nil fontified nil 10846 . 10856) (nil fontified nil 10845 . 10846) (nil fontified nil 10834 . 10845) (nil fontified nil 10833 . 10834) (nil fontified nil 10828 . 10833) (nil fontified nil 10827 . 10828) (10827 . 10945)) nil (26818 57125 795345 0) 0 nil])
([nil nil ((#("role" 0 3 (face font-lock-function-name-face fontified t) 3 4 (face font-lock-function-name-face fontified t)) . -10842) (undo-tree-id8 . -4) 10846) nil (26818 57125 795343 0) 0 nil])
([nil nil ((10842 . 10848)) nil (26818 57125 795342 0) 0 nil])
([nil nil ((#("role" 0 4 (face font-lock-builtin-face fontified t)) . -10909) (undo-tree-id7 . -4) 10913) nil (26818 57125 795341 0) 0 nil])
([nil nil ((10909 . 10914)) nil (26818 57125 795340 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-builtin-face fontified t)) . -10913) (undo-tree-id6 . -1) 10914) nil (26818 57125 795340 0) 0 nil])
([nil nil ((10913 . 10915)) nil (26818 57125 795338 0) 0 nil])
([nil nil ((#("role" 0 4 (face font-lock-string-face fontified t)) . -10935) (undo-tree-id5 . -4) 10939) nil (26818 57125 795337 0) 0 nil])
([nil nil ((10935 . 10941)) nil (26818 57128 5611 0) 0 nil])
([nil nil ((719 . 720)) nil (26818 57204 306810 0) 0 nil] [nil nil ((720 . 721)) ((#(" " 0 1 (fontified t)) . 720) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1)) (26818 57126 865844 0) 0 nil])
([nil nil ((720 . 721)) nil (26818 57204 306808 0) 0 nil])
([nil nil ((721 . 722)) ((#("_" 0 1 (fontified t)) . 721) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1)) (26818 57125 795393 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 734 . 735) (nil fontified nil 721 . 735) (721 . 735)) nil (26818 57204 306804 0) 0 nil])
([nil nil ((#("_" 0 1 (fontified t)) . -721) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 722) ((721 . 722)) (26818 57125 795331 0) 0 nil])
([nil nil ((14001 . 14003) (t 26818 57204 0 0)) nil (26821 14732 215080 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 15048 . 15049) (nil fontified nil 14003 . 15049) (14003 . 15049)) nil (26821 14732 215079 0) 0 nil])
([nil nil ((#("*" 0 1 (face font-lock-function-name-face fontified t)) . 14022)) nil (26821 14732 215078 0) 0 nil])
([nil nil ((14122 . 14123)) nil (26821 14732 215077 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14214 . 14215) (nil fontified nil 14123 . 14215) (14123 . 14215)) nil (26821 14732 215076 0) 0 nil])
([nil nil ((#("
(defun ctx-from-req (req)
  \"Construit un ctx plist: :tenant-id, :actor-id, :scopes, :request-id.
   Dépend des middlewares (tenant-from-host, auth, request-id) qui posent ces clés dans le req.\"
  (let* ((tenant-id (ctx-get req :tenant-id))
         (actor-id  (or (ctx-get req :actor-id)
                        (ctx-get req :user-id))) ; suivant ton mw auth
         (scopes    (or (ctx-get req :scopes) '()))
         (request-id (ctx-get req :request-id)))
    (list :tenant-id tenant-id
          :actor-id actor-id
          :scopes scopes
          :request-id request-id)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 29 (fontified t) 29 195 (face font-lock-doc-face fontified t) 195 199 (fontified t) 199 203 (face font-lock-keyword-face fontified t) 203 211 (fontified t) 211 229 (fontified t) 229 239 (face font-lock-builtin-face fontified t) 239 242 (fontified t) 242 279 (fontified t) 279 288 (face font-lock-builtin-face fontified t) 288 327 (fontified t) 327 335 (face font-lock-builtin-face fontified t) 335 339 (fontified t) 339 361 (face font-lock-comment-face fontified t) 361 398 (fontified t) 398 405 (face font-lock-builtin-face fontified t) 405 447 (fontified t) 447 458 (face font-lock-builtin-face fontified t) 458 472 (fontified t) 472 482 (face font-lock-builtin-face fontified t) 482 503 (fontified t) 503 512 (face font-lock-builtin-face fontified t) 512 532 (fontified t) 532 539 (face font-lock-builtin-face fontified t) 539 547 (fontified t) 547 557 (fontified t) 557 568 (face font-lock-builtin-face fontified t) 568 582 (fontified t)) . 13419) (undo-tree-id31 . -582)) nil (26821 14732 215075 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13419)) nil (26821 14732 215056 0) 0 nil])
([nil nil ((#("n" 0 1 (fontified t)) . -14223) (undo-tree-id34 . -1) 14224 (t 26821 14732 0 0)) nil (26821 15369 69786 0) 0 nil])
([nil nil ((14223 . 14224)) nil (26821 15369 69785 0) 0 nil])
([nil nil ((3397 . 3399)) nil (26821 15369 69784 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -3397) (undo-tree-id32 . -1) (#(":" 0 1 (face font-lock-builtin-face fontified t)) . -3398) (undo-tree-id33 . -1) 3399) nil (26821 15369 69782 0) 0 nil])
([nil nil ((3397 . 3399)) nil (26821 15369 69768 0) 0 nil])
([nil nil ((3426 . 3428)) nil (26821 15369 69762 0) 0 nil])
([nil nil ((430 . 431)) nil (26821 15369 69752 0) 0 nil])
([nil nil ((431 . 432)) nil (26821 15369 69751 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 445 . 446) (nil fontified nil 432 . 446) (432 . 446)) nil (26821 15369 69747 0) 0 nil])
([nil nil ((825 . 826) (t 26821 15369 0 0)) nil (26821 15858 680493 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -825) (undo-tree-id35 . -1) 826) nil (26821 15858 680487 0) 0 nil])
([nil nil ((12841 . 12843) (t 26821 15858 0 0)) nil (26822 37281 906721 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15469 . 15470) (nil fontified nil 12843 . 15470) (12843 . 15470)) nil (26822 37281 906721 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15468) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (#("
" 0 1 (rear-nonsticky t fontified t)) . -15469) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 15470) nil (26822 37281 906719 0) 0 nil])
([nil nil ((15468 . 15469)) nil (26822 37281 906696 0) 0 nil])
([nil nil ((11297 . 11299)) nil (26822 37281 906696 0) 0 nil])
([nil nil ((11296 . 11297)) nil (26822 37281 906695 0) 0 nil])
([nil nil ((12845 . 12847)) nil (26822 37281 906694 0) 0 nil])
([nil nil ((12847 . 12848)) nil (26822 37281 906690 0) 0 nil])
([nil nil ((14641 . 14644) (t 26822 37281 0 0)) nil (26822 37407 228210 0) 0 nil])
([nil nil ((14615 . 14647) (#("usocket:connection-aborted-er" 0 29 (fontified t)) . -14615) (undo-tree-id22 . -29) (undo-tree-id23 . -26) (undo-tree-id24 . -26) (undo-tree-id25 . -26) (undo-tree-id26 . -26) (undo-tree-id27 . -26) (undo-tree-id28 . -26) (undo-tree-id29 . -26) (undo-tree-id30 . -26) (undo-tree-id31 . -26) (undo-tree-id32 . -26) (undo-tree-id33 . -27) (undo-tree-id34 . -27) (undo-tree-id35 . -27) (undo-tree-id36 . -27) (undo-tree-id37 . -27) (undo-tree-id38 . -27) (undo-tree-id39 . -28) (undo-tree-id40 . -28) (undo-tree-id41 . -29) (undo-tree-id42 . -29) 14644) nil (26822 37407 228209 0) 0 nil])
([nil nil ((14690 . 14693)) nil (26822 37407 228193 0) 0 nil])
([nil nil ((14666 . 14696) (#("usocket:connection-reset-er" 0 27 (fontified t)) . -14666) (undo-tree-id5 . -27) (undo-tree-id6 . -24) (undo-tree-id7 . -24) (undo-tree-id8 . -24) (undo-tree-id9 . -24) (undo-tree-id10 . -24) (undo-tree-id11 . -24) (undo-tree-id12 . -24) (undo-tree-id13 . -24) (undo-tree-id14 . -24) (undo-tree-id15 . -24) (undo-tree-id16 . -25) (undo-tree-id17 . -25) (undo-tree-id18 . -26) (undo-tree-id19 . -26) (undo-tree-id20 . -27) (undo-tree-id21 . -27) 14693) nil (26822 37407 228189 0) 0 nil])
([nil nil ((4240 . 4245) (t 26822 37407 0 0)) nil (26822 48504 871916 0) 0 nil])
([nil nil ((4245 . 4251)) nil (26822 48504 871916 0) 0 nil])
([nil nil ((4251 . 4252)) nil (26822 48504 871915 0) 0 nil])
([nil nil ((4252 . 4263)) nil (26822 48504 871915 0) 0 nil])
([nil nil ((4263 . 4268)) nil (26822 48504 871914 0) 0 nil])
([nil nil ((4268 . 4274)) nil (26822 48504 871914 0) 0 nil])
([nil nil ((4274 . 4275)) nil (26822 48504 871913 0) 0 nil])
([nil nil ((4275 . 4280)) nil (26822 48504 871909 0) 0 nil])
([nil nil ((4245 . 4247) (t 26822 48504 0 0)) nil (26822 48942 681848 0) 0 nil])
([nil nil ((4270 . 4272)) nil (26822 48942 681844 0) 0 nil])
([nil nil ((3658 . 3660) (t 26822 48942 0 0)) nil (26824 10561 99837 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5486 . 5487) (nil fontified nil 3660 . 5487) (3660 . 5487)) nil (26824 10561 99836 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -5486) (undo-tree-id2 . -1) 5487) nil (26824 10561 99836 0) 0 nil])
([nil nil ((179 . 180)) nil (26824 10561 99835 0) 0 nil])
([nil nil ((180 . 181)) nil (26824 10561 99834 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -180) (undo-tree-id1 . -1) 181) nil (26824 10561 99834 0) 0 nil])
([nil nil ((180 . 185)) nil (26824 10561 99832 0) 0 nil])
([nil nil ((180 . 190) (#("url-e" 0 5 (fontified t)) . -180) (undo-tree-id0 . -5) 185) nil (26824 10561 99831 0) 0 nil])
([nil nil ((190 . 191)) nil (26824 10561 99817 0) 0 nil])
([nil nil ((191 . 192)) nil (26824 10561 99816 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 215 . 216) (nil fontified nil 192 . 216) (192 . 216)) nil (26824 10561 99815 0) 0 nil])
([nil nil ((180 . 181)) nil (26824 10561 99811 0) 0 nil])
([nil nil ((#("
#|
(defun %sse-writer (handler &key retry-ms heartbeat-sec)
  (declare (ignore heartbeat-sec))
  (lambda (send-chunk)
    (labels ((emit (&key data event id comment)
               (when comment
                 (funcall send-chunk (format nil \": ~A~%~%\" comment)))
               (when data
                 (when event (funcall send-chunk (format nil \"event: ~A~%\" event)))
                 (when id    (funcall send-chunk (format nil \"id: ~A~%\" id)))
                 (dolist (line (%split-lines data))
                   (funcall send-chunk (format nil \"data: ~A~%\" line)))
                 (funcall send-chunk (format nil \"~%\"))))
             (safe-send (&rest args)
               (handler-case
                   (cond
                     ;; Autoriser (funcall send \"texte\")
                     ((and (= (length args) 1) (stringp (first args)))
                      (emit :data (first args)))
                     ;; Liste &key impaire -> message d'erreur côté client
                     ((oddp (length args))
                      (funcall send-chunk
                               (format nil \": error odd number of &KEY arguments ~S~%~%\" args)))
                     (t
                      (apply #'emit args)))
                 (error (e)
                   (format *error-output* \"~&[SSE] handler error: ~A~%\" e)
                   (funcall send-chunk (format nil \": error ~A~%~%\" e))))))
      (when retry-ms
        (funcall send-chunk (format nil \"retry: ~D~%~%\" (truncate retry-ms))))
      (funcall handler #'safe-send))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 856 (face font-lock-comment-face fontified t) 856 1548 (face font-lock-comment-face fontified t) 1548 1550 (face font-lock-comment-delimiter-face fontified t)) . 13207) (undo-tree-id0 . -1550) (t 26824 10561 0 0)) nil (26945 13465 565830 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13207)) nil (26945 13465 565813 0) 0 nil])
([nil nil ((829 . 833) (t 26945 13465 0 0)) nil (26945 20039 726817 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 863 . 864) (nil fontified nil 833 . 864) (833 . 864)) nil (26945 20039 726816 0) 0 nil])
([nil nil ((17619 . 17620)) nil (26945 20039 726814 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19017 . 19018) (nil fontified nil 17620 . 19018) (17620 . 19018)) nil (26945 20039 726813 0) 0 nil])
([nil nil ((19018 . 19020)) nil (26945 20039 726812 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19511 . 19512) (nil fontified nil 19020 . 19512) (19020 . 19512)) nil (26945 20039 726811 0) 0 nil])
([nil nil ((864 . 868)) nil (26945 20039 726810 0) 0 nil])
([nil nil ((868 . 869)) nil (26945 20039 726809 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 883 . 884) (nil fontified nil 869 . 884) (869 . 884)) nil (26945 20039 726804 0) 0 nil])
([nil nil ((19532 . 19533)) nil (26945 20039 726800 0) 0 nil])
([nil nil ((4585 . 4587) (t 26945 20039 0 0)) nil (26945 37659 202180 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5591 . 5592) (nil fontified nil 4587 . 5592) (4587 . 5592)) nil (26945 37659 202179 0) 0 nil])
([nil nil ((3823 . 3824)) nil (26945 37659 202178 0) 0 nil])
([nil nil ((3824 . 3826)) nil (26945 37659 202177 0) 0 nil])
([nil nil ((4589 . 4591)) nil (26945 37659 202173 0) 0 nil])
([nil nil ((413 . 414) (t 26945 37659 0 0)) nil (26948 1655 80888 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 425 . 426) (nil fontified nil 414 . 426) (414 . 426)) nil (26948 1655 80887 0) 0 nil])
([nil nil ((#("4" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -425) (undo-tree-id27 . -1) 426) nil (26948 1655 80887 0) 0 nil])
([nil nil ((425 . 426)) nil (26948 1655 80886 0) 0 nil])
([nil nil ((9210 . 9212)) nil (26948 1655 80885 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9363 . 9364) (nil fontified nil 9358 . 9364) (nil fontified nil 9351 . 9358) (nil fontified nil 9350 . 9351) (nil fontified nil 9333 . 9350) (nil fontified nil 9325 . 9333) (nil fontified nil 9314 . 9325) (nil fontified nil 9303 . 9314) (nil fontified nil 9300 . 9303) (nil fontified nil 9295 . 9300) (nil fontified nil 9290 . 9295) (nil fontified nil 9284 . 9290) (nil fontified nil 9265 . 9284) (nil fontified nil 9262 . 9265) (nil fontified nil 9251 . 9262) (nil fontified nil 9241 . 9251) (nil fontified nil 9232 . 9241) (nil fontified nil 9231 . 9232) (nil fontified nil 9230 . 9231) (nil fontified nil 9229 . 9230) (nil fontified nil 9219 . 9229) (nil fontified nil 9218 . 9219) (nil fontified nil 9213 . 9218) (nil fontified nil 9212 . 9213) (9212 . 9364)) nil (26948 1655 80884 0) 0 nil])
([nil nil ((#("not_found" 0 9 (face font-lock-string-face fontified t)) . -9304) (undo-tree-id26 . -9) 9313) nil (26948 1655 80882 0) 0 nil])
([nil nil ((9304 . 9307)) nil (26948 1655 80880 0) 0 nil])
([nil nil ((#("h" 0 1 (face font-lock-string-face fontified t)) . -9306) (undo-tree-id25 . -1) 9307) nil (26948 1655 80879 0) 0 nil])
([nil nil ((9306 . 9316)) nil (26948 1655 80878 0) 0 nil])
([nil nil ((#("Not Found" 0 9 (face font-lock-string-face fontified t)) . -9252) (undo-tree-id22 . -9) (undo-tree-id23 . -9) (undo-tree-id24 . -9) 9261) nil (26948 1655 80877 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9263 . 9264) (nil fontified nil 9252 . 9264) (9252 . 9264)) nil (26948 1655 80874 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-string-face fontified t)) . -9252) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 9253) nil (26948 1655 80873 0) 0 nil])
([nil nil ((9252 . 9253)) nil (26948 1655 80870 0) 0 nil])
([nil nil ((#("4" 0 1 (fontified t)) . -9367) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) 9368) nil (26948 1655 80869 0) 0 nil])
([nil nil ((9367 . 9368)) nil (26948 1655 80866 0) 0 nil])
([nil nil ((#("4" 0 1 (face font-lock-function-name-face fontified t)) . -9229) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 9230) nil (26948 1655 80864 0) 0 nil])
([nil nil ((9229 . 9230)) nil (26948 1655 80847 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3136) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) 3137 (t 26948 1655 0 0)) nil (26950 43580 954027 0) 0 nil])
([nil nil ((9369 . 9371)) nil (26950 43580 954025 0) 0 nil])
([nil nil ((nil fontified nil 9528 . 9529) (nil fontified nil 9523 . 9528) (nil fontified nil 9516 . 9523) (nil fontified nil 9515 . 9516) (nil fontified nil 9514 . 9515) (nil fontified nil 9498 . 9514) (nil fontified nil 9490 . 9498) (nil fontified nil 9481 . 9490) (nil fontified nil 9479 . 9481) (nil fontified nil 9465 . 9479) (nil fontified nil 9462 . 9465) (nil fontified nil 9457 . 9462) (nil fontified nil 9452 . 9457) (nil fontified nil 9446 . 9452) (nil fontified nil 9427 . 9446) (nil fontified nil 9424 . 9427) (nil fontified nil 9423 . 9424) (nil fontified nil 9422 . 9423) (nil fontified nil 9412 . 9422) (nil fontified nil 9410 . 9412) (nil fontified nil 9400 . 9410) (nil fontified nil 9391 . 9400) (nil fontified nil 9390 . 9391) (nil fontified nil 9389 . 9390) (nil fontified nil 9378 . 9389) (nil fontified nil 9377 . 9378) (nil fontified nil 9372 . 9377) (nil fontified nil 9371 . 9372) (9371 . 9529)) nil (26950 43580 954024 0) 0 nil])
([nil nil ((#("Unauthorized" 0 1 (face font-lock-string-face fontified t) 1 11 (face font-lock-string-face fontified t) 11 12 (face font-lock-string-face fontified t rear-nonsticky t)) . -9411) (undo-tree-id60 . -12) (undo-tree-id61 . -4) (undo-tree-id62 . -4) (undo-tree-id63 . -4) (undo-tree-id64 . -4) (undo-tree-id65 . -4) (undo-tree-id66 . -12) (undo-tree-id67 . -12) (undo-tree-id68 . -12) (undo-tree-id69 . -12) 9423) nil (26950 43580 954021 0) 0 nil])
([nil nil ((9411 . 9420)) nil (26950 43580 954016 0) 0 nil])
([nil nil ((#("unauthorized" 0 12 (face font-lock-string-face fontified t)) . -9463) (undo-tree-id50 . -12) (undo-tree-id51 . -6) (undo-tree-id52 . -6) (undo-tree-id53 . -6) (undo-tree-id54 . -6) (undo-tree-id55 . -6) (undo-tree-id56 . -12) (undo-tree-id57 . -12) (undo-tree-id58 . -12) (undo-tree-id59 . -12) 9475) nil (26950 43580 954015 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9471 . 9472) (nil fontified nil 9463 . 9472) (9463 . 9472)) nil (26950 43580 954011 0) 0 nil])
([nil nil ((#("F" 0 1 (face font-lock-string-face fontified t)) . 9463)) nil (26950 43580 954010 0) 0 nil])
([nil nil ((9463 . 9464)) nil (26950 43580 954010 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-function-name-face fontified t)) . -9388) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) 9389) nil (26950 43580 954009 0) 0 nil])
([nil nil ((9388 . 9389)) nil (26950 43580 954003 0) 0 nil])
([nil nil ((#("1" 0 1 (fontified t)) . -9520) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) 9521) nil (26950 43580 954001 0) 0 nil])
([nil nil ((9520 . 9521)) nil (26950 43580 953980 0) 0 nil])
([nil nil ((454 . 456) (452 . 453) (t 26950 43580 0 0)) nil (26950 44316 49145 0) 0 nil])
([nil nil ((468 . 469)) nil (26950 44316 49144 0) 0 nil])
([nil nil ((469 . 470)) nil (26950 44316 49144 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 481 . 482) (nil fontified nil 470 . 482) (470 . 482)) nil (26950 44316 49143 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -469) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (#(":" 0 1 (face font-lock-builtin-face fontified t)) . -470) (undo-tree-id78 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -471) (undo-tree-id79 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -472) (undo-tree-id80 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -473) (undo-tree-id81 . -1) (#("p" 0 1 (face font-lock-builtin-face fontified t)) . -474) (undo-tree-id82 . -1) (#("o" 0 1 (face font-lock-builtin-face fontified t)) . -475) (undo-tree-id83 . -1) (#("n" 0 1 (face font-lock-builtin-face fontified t)) . -476) (undo-tree-id84 . -1) (#("d" 0 1 (face font-lock-builtin-face fontified t)) . -477) (undo-tree-id85 . -1) (#("-" 0 1 (face font-lock-builtin-face fontified t)) . -478) (undo-tree-id86 . -1) (#("4" 0 1 (face font-lock-builtin-face fontified t)) . -479) (undo-tree-id87 . -1) (#("0" 0 1 (face font-lock-builtin-face fontified t)) . -480) (undo-tree-id88 . -1) (#("4" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -481) (undo-tree-id89 . -1) 482) nil (26950 44316 49141 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 480 . 481) (nil fontified nil 469 . 481) (469 . 481)) nil (26950 44316 49131 0) 0 nil])
([nil nil ((#("4" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -480) (undo-tree-id75 . -1) 481) nil (26950 44316 49130 0) 0 nil])
([nil nil ((480 . 481)) nil (26950 44316 49128 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 481) (#(" " 0 1 (fontified t)) . 481) (#("
" 0 1 (fontified t)) . 481) (undo-tree-id73 . -1) (undo-tree-id74 . -1)) nil (26950 44316 49124 0) 0 nil])
([nil nil ((13939 . 13940) (t 26950 44316 0 0)) nil (26961 19797 138970 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14029 . 14030) (nil fontified nil 14028 . 14030) (nil fontified nil 14018 . 14028) (nil fontified nil 14002 . 14018) (nil fontified nil 13978 . 14002) (nil fontified nil 13976 . 13978) (nil fontified nil 13969 . 13976) (nil fontified nil 13965 . 13969) (nil fontified nil 13947 . 13965) (nil fontified nil 13946 . 13947) (nil fontified nil 13941 . 13946) (nil fontified nil 13940 . 13941) (13940 . 14030)) nil (26961 19797 138966 0) 0 nil])
([nil nil ((815 . 816) (t 26961 19797 0 0)) nil (26961 28196 761650 0) 0 nil])
([nil nil ((816 . 817)) nil (26961 28196 761649 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 838 . 839) (nil fontified nil 835 . 839) (nil fontified nil 817 . 835) (817 . 839)) nil (26961 28196 761644 0) 0 nil])
([nil nil ((9246 . 9248) (t 26961 28196 0 0)) nil (26964 17318 102170 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9399 . 9400) (nil fontified nil 9394 . 9400) (nil fontified nil 9387 . 9394) (nil fontified nil 9369 . 9387) (nil fontified nil 9361 . 9369) (nil fontified nil 9350 . 9361) (nil fontified nil 9339 . 9350) (nil fontified nil 9336 . 9339) (nil fontified nil 9331 . 9336) (nil fontified nil 9326 . 9331) (nil fontified nil 9320 . 9326) (nil fontified nil 9298 . 9320) (nil fontified nil 9287 . 9298) (nil fontified nil 9277 . 9287) (nil fontified nil 9268 . 9277) (nil fontified nil 9266 . 9268) (nil fontified nil 9265 . 9266) (nil fontified nil 9255 . 9265) (nil fontified nil 9254 . 9255) (nil fontified nil 9249 . 9254) (nil fontified nil 9248 . 9249) (9248 . 9400)) nil (26964 17318 102169 0) 0 nil])
([nil nil ((#("4" 0 1 (face font-lock-function-name-face fontified t)) . -9265) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 9266) nil (26964 17318 102166 0) 0 nil])
([nil nil ((9265 . 9266)) nil (26964 17318 102162 0) 0 nil])
([nil nil ((#("Not Found" 0 9 (face font-lock-string-face fontified t)) . -9288) (undo-tree-id12 . -9) (undo-tree-id13 . -9) (undo-tree-id14 . -9) 9297) nil (26964 17318 102161 0) 0 nil])
([nil nil ((9288 . 9291)) nil (26964 17318 102159 0) 0 nil])
([nil nil ((9291 . 9292)) nil (26964 17318 102158 0) 0 nil])
([nil nil ((9292 . 9299)) nil (26964 17318 102158 0) 0 nil])
([nil nil ((#("not_found" 0 9 (face font-lock-string-face fontified t)) . -9342) (undo-tree-id1 . -9) (undo-tree-id2 . -3) (undo-tree-id3 . -3) (undo-tree-id4 . -3) (undo-tree-id5 . -3) (undo-tree-id6 . -3) (undo-tree-id7 . -3) (undo-tree-id8 . -9) (undo-tree-id9 . -9) (undo-tree-id10 . -9) (undo-tree-id11 . -9) 9351) nil (26964 17318 102157 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9352 . 9353) (nil fontified nil 9342 . 9353) (9342 . 9353)) nil (26964 17318 102149 0) 0 nil])
([nil nil ((9342 . 9345) (#("Bad" 0 3 (face font-lock-string-face fontified t)) . 9342)) nil (26964 17318 102148 0) 0 nil])
([nil nil ((9345 . 9353) (#(" Request" 0 7 (face font-lock-string-face fontified t) 7 8 (face font-lock-string-face rear-nonsticky t fontified t)) . 9345)) nil (26964 17318 102147 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -9345) (undo-tree-id0 . -1) 9346) nil (26964 17318 102146 0) 0 nil])
([nil nil ((9345 . 9346)) nil (26964 17318 102130 0) 0 nil])
([nil nil ((#("4" 0 1 (fontified t)) . -9401) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) 9402 (t 26964 17318 0 0)) nil (26964 17333 872474 0) 0 nil])
([nil nil ((9401 . 9402)) nil (26964 17333 872471 0) 0 nil])
([nil nil ((468 . 469)) nil (26964 17333 872470 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 480 . 481) (nil fontified nil 469 . 481) (469 . 481)) nil (26964 17333 872469 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-builtin-face fontified t)) . -479) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (#("3" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -480) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) 481) nil (26964 17333 872466 0) 0 nil])
([nil nil ((479 . 481)) nil (26964 17333 872441 0) 0 nil])
([nil nil ((1416 . 1418) (t 26964 17333 0 0)) nil (26964 17605 428981 0) 0 nil])
([nil nil ((#("x" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -1416) (undo-tree-id35 . -1) (#("b" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -1417) (undo-tree-id36 . -1) 1418) nil (26964 17605 428977 0) 0 nil])
([nil nil ((#("#|
(defun url-encode (s &key (space-as-plus nil))
  (let* ((text (or s \"\"))
         (bytes (trivial-utf-8:string-to-utf-8-bytes text)))
    (with-output-to-string (out)
      (loop for b across bytes
            for ch = (code-char b)
            do (cond
                 ;; A-Z
                 ((and (>= b 65) (<= b 90)) (write-char ch out))
                 ;; a-z
                 ((and (>= b 97) (<= b 122)) (write-char ch out))
                 ;; 0-9
                 ((and (>= b 48) (<= b 57)) (write-char ch out))
                 ;; - . _ ~
                 ((member b '(45 46 95 126)) (write-char ch out))
                 ;; espace
                 ((and space-as-plus (= b 32)) (write-char #\\+ out))
                 (t (format out \"%%%02X\" b)))))))
|#" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 659 (face font-lock-comment-face fontified t) 659 715 (face font-lock-comment-face fontified t) 715 765 (face font-lock-comment-face fontified t) 765 767 (face font-lock-comment-delimiter-face fontified t)) . 3886) (undo-tree-id2 . -767) (t 26964 17605 0 0)) nil (26976 9456 717226 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3885) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 3886) nil (26976 9456 717222 0) 0 nil])
([nil nil ((18504 . 18508) (t 26976 9456 0 0)) nil (26992 61361 324203 0) 0 nil])
([nil nil ((18508 . 18509)) nil (26992 61361 324202 0) 0 nil])
([nil nil ((#("
	  :" 0 1 (fontified t) 1 5 (fontified t)) . -18504) (undo-tree-id19 . -5) (undo-tree-id20 . -5) 18509) nil (26992 61361 324201 0) 0 nil])
([nil nil ((18288 . 18291)) nil (26992 61361 324200 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18335 . 18336) (nil fontified nil 18334 . 18336) (nil fontified nil 18331 . 18334) (nil fontified nil 18291 . 18331) (18291 . 18336)) nil (26992 61361 324199 0) 0 nil])
([nil nil ((#("ua" 0 2 (fontified t)) . -18292) (undo-tree-id18 . -2) 18294) nil (26992 61361 324198 0) 0 nil])
([nil nil ((18292 . 18296)) nil (26992 61361 324197 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -18302) (undo-tree-id16 . -1) (#(" " 0 1 (fontified t)) . -18303) (undo-tree-id17 . -1) 18304) nil (26992 61361 324196 0) 0 nil])
([nil nil ((#("ua" 0 2 (face font-lock-builtin-face fontified t)) . -18332) (undo-tree-id15 . -2) 18334) nil (26992 61361 324195 0) 0 nil])
([nil nil ((18332 . 18336)) nil (26992 61361 324194 0) 0 nil])
([nil nil ((18338 . 18341)) nil (26992 61361 324193 0) 0 nil])
([nil nil ((nil fontified nil 18387 . 18388) (nil fontified nil 18386 . 18387) (nil fontified nil 18381 . 18386) (nil fontified nil 18341 . 18381) (18341 . 18388)) nil (26992 61361 324193 0) 0 nil])
([nil nil ((#("json" 0 4 (face font-lock-builtin-face fontified t)) . -18382) (undo-tree-id14 . -4) 18386) nil (26992 61361 324192 0) 0 nil])
([nil nil ((18382 . 18386)) nil (26992 61361 324191 0) 0 nil])
([nil nil ((#("json" 0 4 (fontified t)) . -18342) (undo-tree-id13 . -4) 18346) nil (26992 61361 324190 0) 0 nil])
([nil nil ((18342 . 18344)) nil (26992 61361 324189 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -18343) (undo-tree-id12 . -1) 18344) nil (26992 61361 324189 0) 0 nil])
([nil nil ((18343 . 18346)) nil (26992 61361 324188 0) 0 nil])
([nil nil ((18388 . 18391)) nil (26992 61361 324187 0) 0 nil])
([nil nil ((nil fontified nil 18437 . 18438) (nil fontified nil 18436 . 18437) (nil fontified nil 18431 . 18436) (nil fontified nil 18391 . 18431) (18391 . 18438)) nil (26992 61361 324187 0) 0 nil])
([nil nil ((#("form" 0 4 (fontified t)) . -18392) (undo-tree-id11 . -4) 18396) nil (26992 61361 324186 0) 0 nil])
([nil nil ((18392 . 18398)) nil (26992 61361 324185 0) 0 nil])
([nil nil ((#("form" 0 4 (face font-lock-builtin-face fontified t)) . -18434) (undo-tree-id10 . -4) 18438) nil (26992 61361 324184 0) 0 nil])
([nil nil ((18434 . 18435)) nil (26992 61361 324183 0) 0 nil])
([nil nil ((18435 . 18440)) nil (26992 61361 324183 0) 0 nil])
([nil nil ((#("l" 0 1 (face font-lock-builtin-face fontified t)) . -18436) (undo-tree-id6 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -18437) (undo-tree-id7 . -1) (#("d" 0 1 (face font-lock-builtin-face fontified t)) . -18438) (undo-tree-id8 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -18439) (undo-tree-id9 . -1) 18440) nil (26992 61361 324182 0) 0 nil])
([nil nil ((18436 . 18440)) nil (26992 61361 324178 0) 0 nil])
([nil nil ((18442 . 18445)) nil (26992 61361 324177 0) 0 nil])
([nil nil ((nil fontified nil 18491 . 18492) (nil fontified nil 18490 . 18491) (nil fontified nil 18485 . 18490) (nil fontified nil 18445 . 18485) (18445 . 18492)) nil (26992 61361 324177 0) 0 nil])
([nil nil ((#("form" 0 4 (fontified t)) . -18446) (undo-tree-id5 . -4) 18450) nil (26992 61361 324176 0) 0 nil])
([nil nil ((18446 . 18451)) nil (26992 61361 324175 0) 0 nil])
([nil nil ((#("form" 0 4 (face font-lock-builtin-face fontified t)) . -18487) (undo-tree-id4 . -4) 18491) nil (26992 61361 324174 0) 0 nil])
([nil nil ((18487 . 18492)) nil (26992 61361 324173 0) 0 nil])
([nil nil ((18710 . 18714)) nil (26992 61361 324172 0) 0 nil])
([nil nil ((18714 . 18719)) nil (26992 61361 324172 0) 0 nil])
([nil nil ((18719 . 18720)) nil (26992 61361 324172 0) 0 nil])
([nil nil ((18720 . 18724)) nil (26992 61361 324171 0) 0 nil])
([nil nil ((18724 . 18725)) nil (26992 61361 324171 0) 0 nil])
([nil nil ((18725 . 18730)) nil (26992 61361 324170 0) 0 nil])
([nil nil ((18730 . 18731)) nil (26992 61361 324170 0) 0 nil])
([nil nil ((18731 . 18733)) nil (26992 61361 324170 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -18732) (undo-tree-id3 . -1) 18733) nil (26992 61361 324169 0) 0 nil])
([nil nil ((18732 . 18735)) nil (26992 61361 324168 0) 0 nil])
([nil nil ((18731 . 18737) (#("form" 0 4 (fontified t)) . -18731) (undo-tree-id2 . -4) 18735) nil (26992 61361 324167 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -18735) (undo-tree-id0 . -1) (#("t" 0 1 (fontified t)) . -18736) (undo-tree-id1 . -1) 18737) nil (26992 61361 324165 0) 0 nil])
([nil nil ((18735 . 18739)) nil (26992 61361 324150 0) 0 nil])
([nil nil ((18739 . 18746)) nil (26992 61361 324150 0) 0 nil])
([nil nil ((18746 . 18747)) nil (26992 61361 324149 0) 0 nil])
([nil nil ((18747 . 18753)) nil (26992 61361 324149 0) 0 nil])
([nil nil ((18753 . 18754)) nil (26992 61361 324148 0) 0 nil])
([nil nil ((18754 . 18760)) nil (26992 61361 324148 0) 0 nil])
([nil nil ((18760 . 18761)) nil (26992 61361 324147 0) 0 nil])
([nil nil ((18761 . 18765)) nil (26992 61361 324146 0) 0 nil])
([nil nil ((18765 . 18766)) nil (26992 61361 324142 0) 0 nil])
([nil nil ((6890 . 6891) (t 26993 53276 0 0)) nil (26996 56199 229186 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7406 . 7407) (nil fontified nil 7403 . 7407) (nil fontified nil 7401 . 7403) (nil fontified nil 7400 . 7401) (nil fontified nil 7395 . 7400) (nil fontified nil 7340 . 7395) (nil fontified nil 7332 . 7340) (nil fontified nil 7313 . 7332) (nil fontified nil 7308 . 7313) (nil fontified nil 7305 . 7308) (nil fontified nil 7301 . 7305) (nil fontified nil 7197 . 7301) (nil fontified nil 7193 . 7197) (nil fontified nil 7182 . 7193) (nil fontified nil 7167 . 7182) (nil fontified nil 7166 . 7167) (nil fontified nil 7161 . 7166) (nil fontified nil 7120 . 7161) (nil fontified nil 7112 . 7120) (nil fontified nil 7102 . 7112) (nil fontified nil 7095 . 7102) (nil fontified nil 7074 . 7095) (nil fontified nil 7066 . 7074) (nil fontified nil 7045 . 7066) (nil fontified nil 7025 . 7045) (nil fontified nil 7022 . 7025) (nil fontified nil 7017 . 7022) (nil fontified nil 7012 . 7017) (nil fontified nil 7006 . 7012) (nil fontified nil 6924 . 7006) (nil fontified nil 6920 . 6924) (nil fontified nil 6909 . 6920) (nil fontified nil 6898 . 6909) (nil fontified nil 6897 . 6898) (nil fontified nil 6892 . 6897) (nil fontified nil 6891 . 6892) (6891 . 7407)) nil (26996 56199 229185 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -7406) (undo-tree-id1 . -1) 7407) nil (26996 56199 229181 0) 0 nil])
([nil nil ((6890 . 6891)) nil (26996 56199 229180 0) 0 nil])
([nil nil ((558 . 559)) nil (26996 56199 229179 0) 0 nil])
([nil nil ((559 . 560)) nil (26996 56199 229179 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 574 . 575) (nil fontified nil 560 . 575) (560 . 575)) nil (26996 56199 229178 0) 0 nil])
([nil nil ((494 . 495)) nil (26996 56199 229177 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 506 . 507) (nil fontified nil 495 . 507) (495 . 507)) nil (26996 56199 229177 0) 0 nil])
([nil nil ((#("3" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -506) (undo-tree-id0 . -1) 507) nil (26996 56199 229175 0) 0 nil])
([nil nil ((506 . 507)) nil (26997 91 339603 0) 0 nil])
([nil nil ((3216 . 3217) (t 26996 56199 0 0)) nil (26997 97 547614 0) 0 nil] [nil nil ((7189 . 7191) (t 26996 56199 0 0)) ((#("

" 0 1 (fontified t) 1 2 (fontified t)) . 7189) (undo-tree-id2 . -2) (undo-tree-id3 . -2) (undo-tree-id4 . -2) (undo-tree-id5 . -2)) (26997 91 161851 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3303 . 3304) (nil fontified nil 3217 . 3304) (3217 . 3304)) nil (26997 97 547612 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7277 . 7278) (nil fontified nil 7191 . 7278) (7191 . 7278)) ((#("(defun make-allow-header (methods)

  (cons \"allow\" (format nil \"~{~A~^, ~}\" methods)))" 0 1 (fontified nil) 1 6 (face font-lock-keyword-face fontified nil) 6 7 (fontified nil) 7 24 (face font-lock-function-name-face fontified nil) 24 36 (fontified nil) 36 44 (fontified nil) 44 51 (face font-lock-string-face fontified nil) 51 64 (fontified nil) 64 76 (face font-lock-string-face fontified nil) 76 86 (fontified nil) 86 87 (rear-nonsticky nil fontified nil)) . 7191) (undo-tree-id0 . -87) (undo-tree-id1 . -36) (nil fontified t 7215 . 7227) (nil fontified t 7198 . 7215) (nil fontified t 7197 . 7198) (nil fontified t 7192 . 7197) (nil fontified t 7191 . 7192) (nil rear-nonsticky t 7277 . 7278)) (26997 91 161781 0) 0 nil])
([nil nil ((3304 . 3305)) nil (26997 97 547608 0) 0 nil])
nil
([nil nil ((3304 . 3306) (t 26997 97 0 0)) nil (26997 135 471367 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3851 . 3852) (nil fontified nil 3306 . 3852) (3306 . 3852)) nil (26997 135 471366 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3251)) nil (26997 135 471365 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3338)) nil (26997 135 471364 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3361)) nil (26997 135 471364 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3396)) nil (26997 135 471363 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3447)) nil (26997 135 471362 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3508)) nil (26997 135 471362 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 3561)) nil (26997 135 471361 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3610)) nil (26997 135 471360 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3658)) nil (26997 135 471359 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 3728)) nil (26997 135 471359 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3746)) nil (26997 135 471358 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3797)) nil (26997 135 471353 0) 0 nil])
([nil nil ((#("(defun respond-405 (path)
  (let* ((methods (allowed-methods-for path)))
    (lumen.core.http:respond-json
     `((:error . ((:type . \"method_not_allowed\")
                  (:allowed . ,methods))))
     :status 405
     :headers (list (make-allow-header methods)))))

(defun respond-options (path)
  (let* ((methods (allowed-methods-for path)))
    (make-instance 'lumen.core.http:response
                   :status 204
                   :headers (list (make-allow-header methods))
                   :body \"\")))" 0 1 (fontified t) 1 6 (fontified t face font-lock-keyword-face) 6 7 (fontified t) 7 18 (fontified t face font-lock-function-name-face) 18 29 (fontified t) 29 33 (fontified t face font-lock-keyword-face) 33 115 (fontified t) 115 121 (fontified t face font-lock-builtin-face) 121 126 (fontified t) 126 131 (fontified t face font-lock-builtin-face) 131 134 (fontified t) 134 154 (fontified t face font-lock-string-face) 154 175 (fontified t) 175 183 (fontified t face font-lock-builtin-face) 183 204 (fontified t) 204 211 (fontified t face font-lock-builtin-face) 211 216 (fontified t) 216 221 (fontified t) 221 229 (fontified t face font-lock-builtin-face) 229 254 (fontified t) 254 267 (fontified t) 267 268 (fontified t) 268 270 (fontified t) 270 275 (face font-lock-keyword-face fontified t) 275 276 (fontified t) 276 291 (face font-lock-function-name-face fontified t) 291 302 (fontified t) 302 306 (face font-lock-keyword-face fontified t) 306 410 (fontified t) 410 417 (face font-lock-builtin-face fontified t) 417 441 (fontified t) 441 449 (face font-lock-builtin-face fontified t) 449 504 (fontified t) 504 509 (face font-lock-builtin-face fontified t) 509 510 (fontified t) 510 512 (face font-lock-string-face fontified t) 512 515 (fontified t)) . 7547) (undo-tree-id54 . -515) 8062 (t 26997 135 0 0)) nil (26997 506 647252 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -7545) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (#("
" 0 1 (fontified t)) . -7546) (undo-tree-id52 . -1) (undo-tree-id53 . -1) 7547) nil (26997 506 647251 0) 0 nil])
([nil nil ((#("
(defun make-allow-header (methods)
  (cons \"allow\" (format nil \"~{~A~^, ~}\" methods)))

(defun allowed-methods-for (path)
  (let ((methods '()))
    (loop for r across *routes* do
      (when (cl-ppcre:scan (route-pattern r) path)
        (pushnew (route-method r) methods :test #'string=)))
    ;; HEAD est toujours autorisé si GET l’est (RFC)
    (when (member \"GET\" methods :test #'string=)
      (pushnew \"HEAD\" methods :test #'string=))
    ;; n’ajouter OPTIONS que s’il existe AU MOINS une méthode trouvée
    (when methods
      (pushnew \"OPTIONS\" methods :test #'string=))
    (sort (copy-list methods) #'string<)))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 25 (face font-lock-function-name-face fontified t) 25 36 (fontified t) 36 44 (fontified t) 44 51 (face font-lock-string-face fontified t) 51 64 (fontified t) 64 76 (face font-lock-string-face fontified t) 76 86 (fontified t) 86 87 (fontified t rear-nonsticky t) 87 88 (fontified t) 88 89 (fontified t) 89 90 (fontified t) 90 95 (face font-lock-keyword-face fontified t) 95 96 (fontified t) 96 115 (face font-lock-function-name-face fontified t) 115 123 (fontified t) 123 126 (fontified t) 126 129 (face font-lock-keyword-face fontified t) 129 146 (fontified t) 146 151 (fontified t) 151 155 (face font-lock-keyword-face fontified t) 155 181 (fontified t) 181 188 (fontified t) 188 192 (face font-lock-keyword-face fontified t) 192 232 (fontified t) 232 274 (fontified t) 274 279 (face font-lock-builtin-face fontified t) 279 293 (fontified t) 293 297 (fontified t) 297 300 (face font-lock-comment-delimiter-face fontified t) 300 345 (face font-lock-comment-face fontified t) 345 346 (face font-lock-comment-face fontified t) 346 351 (fontified t) 351 355 (face font-lock-keyword-face fontified t) 355 364 (fontified t) 364 369 (face font-lock-string-face fontified t) 369 378 (fontified t) 378 383 (face font-lock-builtin-face fontified t) 383 395 (fontified t) 395 410 (fontified t) 410 416 (face font-lock-string-face fontified t) 416 425 (fontified t) 425 430 (face font-lock-builtin-face fontified t) 430 443 (fontified t) 443 447 (fontified t) 447 450 (face font-lock-comment-delimiter-face fontified t) 450 512 (face font-lock-comment-face fontified t) 512 513 (face font-lock-comment-face fontified t) 513 518 (fontified t) 518 522 (face font-lock-keyword-face fontified t) 522 531 (fontified t) 531 546 (fontified t) 546 555 (face font-lock-string-face fontified t) 555 564 (fontified t) 564 569 (face font-lock-builtin-face fontified t) 569 582 (fontified t) 582 623 (fontified t) 623 624 (fontified t rear-nonsticky t)) . 3216) (undo-tree-id46 . -624) (undo-tree-id47 . -177) (undo-tree-id48 . -177) (undo-tree-id49 . -146)) nil (26997 506 647248 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 3216)) nil (26997 506 647245 0) 0 nil])
([nil nil ((#(":respond-415" 0 12 (face font-lock-builtin-face fontified t)) . 508) (undo-tree-id44 . -12) (undo-tree-id45 . -8) 520) nil (26997 506 647244 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -507) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) 508) nil (26997 506 647241 0) 0 nil])
([nil nil ((#(":respond-options" 0 16 (face font-lock-builtin-face fontified t)) . 559) (undo-tree-id27 . -16) (undo-tree-id28 . -8) (undo-tree-id29 . -8) (undo-tree-id30 . -8) (undo-tree-id31 . -8) (undo-tree-id32 . -8) (undo-tree-id33 . -8) (undo-tree-id34 . -16) (undo-tree-id35 . -16) (undo-tree-id36 . -16) (undo-tree-id37 . -16) (undo-tree-id38 . -16) 575) nil (26997 506 647237 0) 0 nil])
([nil current ((#(" " 0 1 (fontified t)) . -558) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) 559) nil (26997 506 647225 0) 0 nil])
nil
