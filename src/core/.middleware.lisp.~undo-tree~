(undo-tree-save-format-version . 1)
"46f2e20d1c274cf615e52e04e8367eee71c7d5fb"
[nil nil nil nil (26790 8105 954414 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 531 . 532) (nil fontified nil 1 . 532) (1 . 532) (t . -1)) nil (26790 8105 954413 0) 0 nil])
([nil nil ((530 . 537) (506 . 511) (478 . 480) 413) nil (26790 8105 954412 0) 0 nil])
([nil nil ((414 . 416) (331 . 334) (286 . 288) 251) nil (26790 8105 954412 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -249) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 250) nil (26790 8105 954411 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -416) (undo-tree-id6 . -1) 417) nil (26790 8105 954407 0) 0 nil])
([nil nil ((345 . 348) (#(" " 0 1 (fontified nil)) . 344) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (345 . 346)) nil (26790 8105 954405 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -415) (undo-tree-id3 . -3) 418) nil (26790 8105 954403 0) 0 nil])
([nil nil ((17 . 18)) nil (26790 8105 954402 0) 0 nil])
([nil nil ((146 . 151) (77 . 82) 19) nil (26790 8105 954402 0) 0 nil])
([nil nil ((196 . 197)) nil (26790 8105 954401 0) 0 nil])
([nil nil ((54 . 56) (#(" " 0 1 (fontified nil)) . 53) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (54 . 55)) nil (26790 8105 954400 0) 0 nil])
([nil nil ((#("	    " 0 1 (fontified nil) 1 5 (fontified nil)) . -147) (147 . 148) (#("	" 0 1 (fontified nil)) . 147) (145 . 147) (#("	    " 0 1 (fontified nil) 1 5 (fontified nil)) . -81) (81 . 82) (#("	" 0 1 (fontified nil)) . 81) (79 . 81) 19) nil (26790 8105 954397 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -229) (undo-tree-id0 . -1) 230) nil (26790 8105 954395 0) 0 nil])
([nil nil ((558 . 559)) nil (26790 8105 954376 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -558) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 559 (t 26790 8105 0 0)) nil (26790 8894 681189 0) 0 nil])
([nil nil ((264 . 267)) nil (26790 8894 681174 0) 0 nil])
([nil nil ((561 . 562)) nil (26790 8894 681170 0) 0 nil])
([nil nil ((426 . 428) (t 26790 8894 0 0)) nil (26790 30997 455225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 686 . 687) (nil fontified nil 428 . 687) (428 . 687)) nil (26790 30997 455224 0) 0 nil])
([nil nil ((435 . 438)) nil (26790 30997 455223 0) 0 nil])
([nil nil ((#("
(defun my-compose (&rest middlewares)
  (reduce (lambda (acc mw) (funcall mw acc))
	  middlewares
	  :initial-value (lambda (req) (declare (ignore req)) (respond-500))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 39 (fontified t) 39 50 (fontified t) 50 56 (face font-lock-keyword-face fontified t) 56 99 (fontified t) 99 102 (fontified t) 102 116 (face font-lock-builtin-face fontified t) 116 118 (fontified t) 118 124 (face font-lock-keyword-face fontified t) 124 132 (fontified t) 132 139 (face font-lock-keyword-face fontified t) 139 170 (fontified t)) . 256) (undo-tree-id2 . -170)) nil (26790 30997 455222 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 256)) nil (26790 30997 455205 0) 0 nil])
([nil nil ((519 . 521) (t 26790 30997 0 0)) nil (26791 6639 874942 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 888 . 889) (nil fontified nil 521 . 889) (521 . 889)) nil (26791 6639 874937 0) 0 nil])
([nil nil ((143 . 144) (t 26791 6639 0 0)) nil (26792 22517 814708 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 155 . 156) (nil fontified nil 144 . 156) (144 . 156)) nil (26792 22517 814707 0) 0 nil])
([nil nil ((#("5" 0 1 (face font-lock-builtin-face fontified t)) . 153)) nil (26792 22517 814704 0) 0 nil])
([nil nil ((153 . 154)) nil (26792 22517 814699 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -155) (undo-tree-id0 . -1) 156 (t 26792 22517 0 0)) nil (26792 22521 943730 0) 0 nil])
([nil nil ((155 . 156)) nil (26792 22521 943694 0) 0 nil])
([nil nil ((1038 . 1039) (t 26792 22521 0 0)) nil (26793 38724 176704 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3178 . 3179) (nil fontified nil 1039 . 3179) (1039 . 3179)) nil (26793 38724 176702 0) 0 nil])
([nil nil ((#("(defparameter *debug* nil)  ;; active les prints si T" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 21 (face font-lock-variable-name-face fontified t) 21 28 (fontified t) 28 31 (face font-lock-comment-delimiter-face fontified t) 31 53 (face font-lock-comment-face fontified t)) . 1039)) nil (26793 38724 176701 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1037) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (#("
" 0 1 (fontified t)) . -1038) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 1039) nil (26793 38724 176700 0) 0 nil])
([nil nil ((268 . 269)) nil (26793 38724 176694 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 321 . 322) (nil fontified nil 300 . 322) (nil fontified nil 297 . 300) (nil fontified nil 290 . 297) (nil fontified nil 283 . 290) (nil fontified nil 282 . 283) (nil fontified nil 270 . 282) (nil fontified nil 269 . 270) (269 . 322)) nil (26793 38724 176692 0) 0 nil])
([nil nil ((3178 . 3179)) nil (26793 38724 176690 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4349 . 4350) (nil fontified nil 3179 . 4350) (3179 . 4350)) nil (26793 38724 176689 0) 0 nil])
([nil nil ((322 . 324)) nil (26793 38724 176688 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 419 . 420) (nil fontified nil 324 . 420) (324 . 420)) nil (26793 38724 176687 0) 0 nil])
([nil nil ((#("

(defun my-compose (&rest middlewares)
  (reduce (lambda (next mw) (funcall mw next))
          (reverse middlewares)
          :initial-value (lambda (req)
                           (declare (ignore req))
                           (respond-404 \"No handler\"))))" 0 1 (fontified t) 1 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 19 (face font-lock-function-name-face fontified t) 19 21 (fontified t) 21 26 (face font-lock-type-face fontified t) 26 51 (fontified t) 51 57 (face font-lock-keyword-face fontified t) 57 129 (fontified t) 129 143 (face font-lock-builtin-face fontified t) 143 145 (fontified t) 145 151 (face font-lock-keyword-face fontified t) 151 186 (fontified t) 186 193 (face font-lock-keyword-face fontified t) 193 248 (fontified t) 248 260 (face font-lock-string-face fontified t) 260 264 (fontified t)) . 420) (undo-tree-id0 . -264)) nil (26793 38724 176685 0) 0 nil])
([nil nil ((189 . 192)) nil (26793 38724 176666 0) 0 nil])
([nil nil ((206 . 207)) nil (26793 38724 176665 0) 0 nil])
([nil nil ((207 . 214)) nil (26793 38724 176665 0) 0 nil])
([nil nil ((214 . 215)) nil (26793 38724 176664 0) 0 nil])
([nil nil ((215 . 225)) nil (26793 38724 176663 0) 0 nil])
([nil nil ((225 . 226)) nil (26793 38724 176663 0) 0 nil])
([nil nil ((226 . 227)) nil (26793 38724 176662 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 238 . 239) (nil fontified nil 227 . 239) (227 . 239)) nil (26793 38724 176661 0) 0 nil])
([nil nil ((239 . 244)) nil (26793 38724 176659 0) 0 nil])
([nil nil ((244 . 251)) nil (26793 38724 176659 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 271 . 272) (nil fontified nil 244 . 272) (244 . 272)) nil (26793 38724 176657 0) 0 nil])
([nil nil ((272 . 273)) nil (26793 38724 176650 0) 0 nil])
([nil nil ((280 . 281) (t 26793 38724 0 0)) nil (26793 38822 412375 0) 0 nil])
([nil nil ((2918 . 2921) (t 26793 38822 0 0)) nil (26794 5030 879715 0) 0 nil])
([nil nil ((2921 . 2926)) nil (26794 5030 879714 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -2925) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 2926) nil (26794 5030 879713 0) 0 nil])
([nil nil ((2925 . 2927)) nil (26794 5030 879696 0) 0 nil])
([nil nil ((2927 . 2928)) nil (26794 5030 879696 0) 0 nil])
([nil nil ((2928 . 2931)) nil (26794 5030 879695 0) 0 nil])
([nil nil ((2931 . 2932)) nil (26794 5030 879695 0) 0 nil])
([nil nil ((2932 . 2937)) nil (26794 5030 879694 0) 0 nil])
([nil nil ((2937 . 2938)) nil (26794 5030 879694 0) 0 nil])
([nil nil ((2938 . 2941)) nil (26794 5030 879693 0) 0 nil])
([nil nil ((2941 . 2946)) nil (26794 5030 879689 0) 0 nil])
([nil nil ((2921 . 2922) (t 26794 5030 0 0)) nil (26794 5103 592251 0) 0 nil])
([nil nil ((#("k" 0 1 (fontified t)) . -2921) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) 2922) nil (26794 5103 592250 0) 0 nil])
([nil nil ((#("(print \"IN QUERY PARSER\")" 0 7 (fontified t) 7 24 (face font-lock-string-face fontified t) 24 25 (fontified t)) . 2921) (undo-tree-id10 . -25) (undo-tree-id11 . -25) (undo-tree-id12 . -25) (undo-tree-id13 . -25) (undo-tree-id14 . -25) (undo-tree-id15 . -25) (undo-tree-id16 . -25) (undo-tree-id17 . -25) (undo-tree-id18 . -25) (undo-tree-id19 . -25) (undo-tree-id20 . -25)) nil (26794 5103 592243 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 2918) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1)) nil (26794 5103 592236 0) 0 nil])
([nil nil ((2966 . 2971)) nil (26794 5103 592226 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2995 . 2996) (nil fontified nil 2995 . 2996) (nil fontified nil 2978 . 2995) (nil fontified nil 2971 . 2978) (2971 . 2996)) nil (26794 5103 592222 0) 0 nil])
([nil nil ((#("
    (print \"IN QUERY PARSER\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 29 (face font-lock-string-face fontified t) 29 30 (rear-nonsticky t fontified t)) . 2966) (undo-tree-id30 . -30) (undo-tree-id31 . -30) (undo-tree-id32 . -5) (undo-tree-id33 . -30) (undo-tree-id34 . -30) (undo-tree-id35 . -30) (undo-tree-id36 . -30) (undo-tree-id37 . -30) (undo-tree-id38 . -30) (undo-tree-id39 . -30) (undo-tree-id40 . -30) (undo-tree-id41 . -30) (undo-tree-id42 . -30) (undo-tree-id43 . -30) (undo-tree-id44 . -30) (undo-tree-id45 . -30) (undo-tree-id46 . -30) (undo-tree-id47 . -5) (undo-tree-id48 . -30) (t 26794 5103 0 0)) nil (26794 5133 928544 0) 0 nil])
([nil nil ((2966 . 2971) (t 26794 5133 0 0)) nil (26794 5165 613683 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2995 . 2996) (nil fontified nil 2995 . 2996) (nil fontified nil 2978 . 2995) (nil fontified nil 2971 . 2978) (2971 . 2996)) nil (26794 5165 613679 0) 0 nil])
([nil nil ((#("
    (print \"IN QUERY PARSER\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 29 (face font-lock-string-face fontified t) 29 30 (rear-nonsticky t fontified t)) . 2966) (undo-tree-id49 . -30) (undo-tree-id50 . -30) (undo-tree-id51 . -5) (undo-tree-id52 . -1) (undo-tree-id53 . -30) (undo-tree-id54 . -30) (undo-tree-id55 . -30) (undo-tree-id56 . -30) (undo-tree-id57 . -30) (undo-tree-id58 . -30) (undo-tree-id59 . -30) (undo-tree-id60 . -30) (undo-tree-id61 . -30) (undo-tree-id62 . -30) (undo-tree-id63 . -30) (undo-tree-id64 . -30) (undo-tree-id65 . -30) (undo-tree-id66 . -30) (undo-tree-id67 . -30) (undo-tree-id68 . -30) (undo-tree-id69 . -30) (undo-tree-id70 . -30) (undo-tree-id71 . -5) (undo-tree-id72 . -30) (t 26794 5165 0 0)) nil (26794 5192 322012 0) 0 nil])
([nil nil ((2919 . 2921) (#("  " 0 2 (face font-lock-comment-face fontified nil)) . 2918) (undo-tree-id73 . -1) (undo-tree-id74 . -2) (undo-tree-id75 . -2) (undo-tree-id76 . -2) (undo-tree-id77 . -2) (undo-tree-id78 . -2) (undo-tree-id79 . -2) (undo-tree-id80 . -2) (undo-tree-id81 . -2) (2920 . 2921) (t 26794 5192 0 0)) nil (26794 7894 145291 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3028 . 3029) (nil fontified nil 2921 . 3029) (2921 . 3029)) nil (26794 7894 145278 0) 0 nil])
([nil nil ((3175 . 3180)) nil (26794 7894 145277 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3287 . 3288) (nil fontified nil 3180 . 3288) (3180 . 3288)) nil (26794 7894 145274 0) 0 nil])
([nil nil ((#("nil" 0 3 (fontified t)) . -369) (undo-tree-id82 . -3) (undo-tree-id83 . -2) (undo-tree-id84 . -2) (undo-tree-id85 . -2) (undo-tree-id86 . -2) (undo-tree-id87 . -2) (undo-tree-id88 . -3) (undo-tree-id89 . -3) (undo-tree-id90 . -3) (undo-tree-id91 . -3) 372 (t 26794 7894 0 0)) nil (26794 9793 728525 0) 0 nil])
([nil nil ((369 . 370)) nil (26794 9793 728507 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -369) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) 370 (t 26794 9793 0 0)) nil (26794 9926 995500 0) 0 nil])
([nil nil ((369 . 372)) nil (26794 9926 995481 0) 0 nil])
([nil nil ((156 . 157) (t 26794 9926 0 0)) nil (26794 10550 189171 0) 0 nil])
([nil nil ((157 . 166)) nil (26794 10550 189170 0) 0 nil])
([nil nil ((157 . 158)) nil (26794 10550 189166 0) 0 nil])
([nil nil ((411 . 413) (t 26794 10550 0 0)) nil (26794 11341 457871 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 561 . 562) (nil fontified nil 413 . 562) (413 . 562)) nil (26794 11341 457871 0) 0 nil])
([nil nil ((292 . 293)) nil (26794 11341 457870 0) 0 nil])
([nil nil ((293 . 294)) nil (26794 11341 457868 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 301 . 302) (nil fontified nil 294 . 302) (294 . 302)) nil (26794 11341 457865 0) 0 nil])
([nil nil ((502 . 504) (t 26794 11341 0 0)) nil (26794 11926 106694 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 795 . 796) (nil fontified nil 504 . 796) (504 . 796)) nil (26794 11926 106694 0) 0 nil])
([nil nil ((#("
(defvar *app* (lambda (req) (declare (ignore req)) (respond-404 \"No handler\")))" 0 1 (fontified t) 1 2 (fontified t) 2 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 14 (face font-lock-variable-name-face fontified t) 14 16 (fontified t) 16 22 (face font-lock-keyword-face fontified t) 22 30 (fontified t) 30 37 (face font-lock-keyword-face fontified t) 37 65 (fontified t) 65 77 (face font-lock-string-face fontified t) 77 80 (fontified t)) . 422) (undo-tree-id107 . -80)) nil (26794 11926 106693 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -421) (undo-tree-id105 . -1) (undo-tree-id106 . -1) 422) nil (26794 11926 106691 0) 0 nil])
([nil nil ((785 . 787)) nil (26794 11926 106689 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1258 . 1259) (nil fontified nil 787 . 1259) (787 . 1259)) nil (26794 11926 106689 0) 0 nil])
([nil nil ((#("
(defun set-app! (&rest mws)
  (setf *app* (apply #'my-compose mws)))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 29 (fontified t) 29 68 (fontified t) 68 69 (fontified t rear-nonsticky t) 69 70 (fontified t)) . 716) (undo-tree-id104 . -70)) nil (26794 11926 106688 0) 0 nil])
([nil nil ((302 . 303)) nil (26794 11926 106686 0) 0 nil])
([nil nil ((303 . 304)) nil (26794 11926 106685 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 323 . 324) (nil fontified nil 304 . 324) (304 . 324)) nil (26794 11926 106684 0) 0 nil])
([nil nil ((#("(defparameter *app* nil)
" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 19 (face font-lock-variable-name-face fontified t) 19 25 (fontified t)) . -365) (undo-tree-id103 . -25) 390) nil (26794 11926 106681 0) 0 nil])
([nil nil ((1020 . 1024) (t 26794 11926 0 0)) nil (26794 12119 874659 0) 0 nil])
([nil nil ((#("i" 0 1 (fontified t)) . -1023) (undo-tree-id109 . -1) 1024) nil (26794 12119 874658 0) 0 nil])
([nil nil ((1023 . 1026)) nil (26794 12119 874656 0) 0 nil])
([nil nil ((1026 . 1027)) nil (26794 12119 874656 0) 0 nil])
([nil nil ((1073 . 1074)) nil (26794 12119 874655 0) 0 nil])
([nil nil ((1027 . 1038) (#(" " 0 1 (fontified nil)) . 1026) (undo-tree-id108 . -1) (1027 . 1028)) nil (26794 12119 874655 0) 0 nil])
([nil nil ((1026 . 1038)) nil (26794 12119 874643 0) 0 nil])
([nil nil ((1038 . 1044)) nil (26794 12119 874642 0) 0 nil])
([nil nil ((1044 . 1045)) nil (26794 12119 874642 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1075 . 1076) (nil fontified nil 1045 . 1076) (1045 . 1076)) nil (26794 12119 874641 0) 0 nil])
([nil nil ((1076 . 1077)) nil (26794 12119 874641 0) 0 nil])
([nil nil ((1077 . 1089)) nil (26794 12119 874640 0) 0 nil])
([nil nil ((1089 . 1095)) nil (26794 12119 874640 0) 0 nil])
([nil nil ((1095 . 1096)) nil (26794 12119 874639 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1140 . 1141) (nil fontified nil 1096 . 1141) (1096 . 1141)) nil (26794 12119 874638 0) 0 nil])
([nil nil ((1141 . 1142)) nil (26794 12119 874634 0) 0 nil])
([nil nil ((712 . 714) (t 26794 12119 0 0)) nil (26794 12528 162094 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1161 . 1162) (nil fontified nil 714 . 1162) (714 . 1162)) nil (26794 12528 162093 0) 0 nil])
([nil nil ((1771 . 1773)) nil (26794 12528 162092 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2112 . 2113) (nil fontified nil 1773 . 2113) (1773 . 2113)) nil (26794 12528 162092 0) 0 nil])
([nil nil ((#("
(defun set-app! (&rest middlewares)
  \"Compose les MIDDLEWARES et installe la nouvelle pile dans *app*.\"
  (setf *app* (apply #'my-compose middlewares)
        *pipeline-signature* (mapcar (lambda (mw)
                                       (etypecase mw
                                         (function (progn
						     (print (function-lambda-expression mw))
						     (print (symbol-name (function-lambda-expression mw)))
						     (symbol-name (function-lambda-expression mw))))
                                         (t (princ-to-string mw))))
                                     middlewares)))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 39 (fontified t) 39 105 (face font-lock-doc-face fontified t) 105 191 (fontified t) 191 197 (face font-lock-keyword-face fontified t) 197 243 (fontified t) 243 252 (face font-lock-keyword-face fontified t) 252 256 (fontified t) 256 308 (fontified t) 308 313 (face font-lock-keyword-face fontified t) 313 314 (fontified t) 314 332 (fontified t) 332 362 (fontified t) 362 363 (fontified t rear-nonsticky t) 363 365 (fontified t) 365 383 (fontified t) 383 427 (fontified t) 427 428 (fontified t rear-nonsticky t) 428 429 (fontified t) 429 430 (fontified t) 430 441 (fontified t) 441 489 (fontified t) 489 557 (fontified t) 557 607 (fontified t) 607 608 (fontified t rear-nonsticky t) 608 609 (fontified t)) . 1163) (undo-tree-id110 . -609) (undo-tree-id111 . -429)) nil (26794 12528 162090 0) 0 nil])
([nil nil ((324 . 325)) nil (26794 12528 162079 0) 0 nil])
([nil nil ((325 . 331)) nil (26794 12528 162075 0) 0 nil])
([nil nil ((1169 . 1171) (t 26794 12528 0 0)) nil (26794 12695 395328 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1242 . 1243) (nil fontified nil 1171 . 1243) (1171 . 1243)) nil (26794 12695 395327 0) 0 nil])
([nil nil ((331 . 332)) nil (26794 12695 395326 0) 0 nil])
([nil nil ((332 . 333)) nil (26794 12695 395325 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 336 . 337) (nil fontified nil 333 . 337) (333 . 337)) nil (26794 12695 395322 0) 0 nil])
([nil nil ((5677 . 5678) (t 26794 12695 0 0)) nil (26794 17052 156586 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8270 . 8271) (nil fontified nil 5678 . 8271) (5678 . 8271)) nil (26794 17052 156585 0) 0 nil])
([nil nil ((5676 . 5678)) nil (26794 17052 156584 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8658 . 8659) (nil fontified nil 5678 . 8659) (5678 . 8659)) nil (26794 17052 156584 0) 0 nil])
([nil nil ((168 . 171)) nil (26794 17052 156583 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 172 . 173) (nil fontified nil 171 . 173) (171 . 173)) nil (26794 17052 156583 0) 0 nil])
([nil nil ((173 . 174)) nil (26794 17052 156582 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 175 . 176) (nil fontified nil 174 . 176) (174 . 176)) nil (26794 17052 156581 0) 0 nil])
([nil nil ((nil fontified nil 176 . 177) (176 . 177)) nil (26794 17052 156581 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 195 . 196) (nil fontified nil 185 . 196) (nil fontified nil 184 . 185) (nil fontified nil 172 . 184) (nil fontified nil 171 . 172) (171 . 196)) nil (26794 17052 156580 0) 0 nil])
([nil nil ((196 . 197)) nil (26794 17052 156579 0) 0 nil])
([nil nil ((197 . 198)) nil (26794 17052 156578 0) 0 nil])
([nil nil ((201 . 202)) nil (26794 17052 156578 0) 0 nil])
([nil nil ((#("core" 0 3 (face font-lock-builtin-face fontified t) 3 4 (face font-lock-builtin-face rear-nonsticky t fontified t)) . 192)) nil (26794 17052 156577 0) 0 nil])
([nil nil ((192 . 197)) nil (26794 17052 156576 0) 0 nil])
([nil nil ((206 . 207)) nil (26794 17052 156575 0) 0 nil])
([nil nil ((11293 . 11294) 942) nil (26794 17052 156572 0) 0 nil])
([nil nil ((9472 . 9474) (t 26794 17052 0 0)) nil (26795 1355 891480 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16025 . 16026) (nil fontified nil 9474 . 16026) (9474 . 16026)) nil (26795 1355 891480 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t rear-nonsticky t)) . -16025) (undo-tree-id194 . -1) 16026) nil (26795 1355 891479 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11870 . 11871) (nil fontified nil 11870 . 11871) (11870 . 11871)) nil (26795 1355 891478 0) 0 nil])
([nil nil ((#("ðŸ“" 0 1 (face font-lock-string-face fontified t)) . -11868) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -11869) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (#("ðŸ“" 0 1 (face font-lock-string-face rear-nonsticky t fontified t)) . -11870) (undo-tree-id193 . -1) 11871) nil (26795 1355 891477 0) 0 nil])
([nil nil ((#("ðŸ“„" 0 1 (face font-lock-string-face fontified t)) . -12093) (undo-tree-id187 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -12094) (undo-tree-id188 . -1) 12095) nil (26795 1355 891474 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -16018) (undo-tree-id184 . -1) (#(")" 0 1 (fontified t)) . -16019) (undo-tree-id185 . -1) (#(")" 0 1 (fontified t)) . -16020) (undo-tree-id186 . -1) 16021) nil (26795 1355 891472 0) 0 nil])
([nil nil ((#("          " 0 10 (fontified t)) . -15831) (#("   " 0 3 (fontified t)) . -15780) (#("        " 0 8 (fontified t)) . -15753) (#("        " 0 8 (fontified t)) . -15719) (#("        " 0 8 (fontified t)) . -15690) (#("                     " 0 21 (fontified t)) . -15661) (#("      " 0 6 (fontified t)) . -15594) (#("      " 0 6 (fontified t)) . -15480) (#("      " 0 6 (fontified t)) . -15434) (#("      " 0 6 (fontified t)) . -15359) (#("      " 0 6 (fontified t)) . -15300) (#("      " 0 6 (fontified t)) . -15262) (#("      " 0 6 (fontified t)) . -15233) (#("    " 0 4 (fontified t)) . -15156) (#("    " 0 4 (fontified t)) . -15129) (#("                 " 0 7 (fontified t) 7 17 (fontified t)) . -15092) (#("  " 0 2 (fontified t)) . -14998) (#("  " 0 2 (fontified t)) . -14943) (#("  " 0 2 (fontified t)) . -14859) (#("  " 0 2 (fontified t)) . -14792) (#("  " 0 2 (fontified t)) . -14656) (#("  " 0 2 (fontified t)) . -14618) (#("  " 0 2 (fontified t)) . -14575) (#("               " 0 15 (fontified t)) . -14535) (12938 . 12939) (#("              " 0 14 (fontified t)) . 12938) 12161) nil (26795 1355 891466 0) 0 nil])
([nil nil ((364 . 368) (#(" " 0 1 (fontified nil)) . 363) (undo-tree-id183 . -1) (364 . 365)) nil (26795 1355 891464 0) 0 nil])
([nil nil ((380 . 381)) nil (26795 1355 891463 0) 0 nil])
([nil nil ((381 . 388)) nil (26795 1355 891462 0) 0 nil])
([nil nil ((388 . 389)) nil (26795 1355 891462 0) 0 nil])
([nil nil ((389 . 394)) nil (26795 1355 891461 0) 0 nil])
([nil nil ((#("
(defun static (&key prefix dir)
  \"Servez les fichiers de DIR quand PATH commence par PREFIX.\"
  (let* ((prefix* (if (and prefix (plusp (length prefix))) prefix \"/\"))
         (dir*    (truename dir)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (and (>= (length path) (length prefix*))
                   (string= prefix* path :end2 (length prefix*)))
              (let* ((rel (subseq path (length prefix*)))
                     ;; sÃ©curiser : pas de .., pas de backslashes
                     (clean (if (search \"..\" rel) \"\" rel))
                     (pn (merge-pathnames clean dir*)))
                (handler-case
                    (if (and (probe-file pn)
                             (not (sb-posix:stat-mode-ifdir (sb-posix:stat pn)))) ; optionnel SBCL: refuser dossiers
                        (let* ((bytes (read-file-bytes pn))
                               (resp  (make-instance 'lumen.core.http:response
                                                     :status 200
                                                     :headers (list (cons \"content-type\" (guess-content-type pn))
                                                                    (cons \"cache-control\" \"public, max-age=3600\"))
                                                     :body (trivial-utf-8:utf-8-bytes-to-string bytes))))
                          ;; NB: ton write-response attend une string; si tu veux pousser des octets,
                          ;; fais Ã©voluer response pour accepter un (vector (unsigned-byte 8)).
                          resp)
                        (lumen.core.http:respond-404 \"File not found\"))
                  (error ()
                    (lumen.core.http:respond-404 \"File error\"))))
              (funcall next req)))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (fontified t) 16 20 (face font-lock-type-face fontified t) 20 35 (fontified t) 35 95 (face font-lock-doc-face fontified t) 95 99 (fontified t) 99 103 (face font-lock-keyword-face fontified t) 103 115 (fontified t) 115 117 (face font-lock-keyword-face fontified t) 117 162 (fontified t) 162 165 (face font-lock-string-face fontified t) 165 208 (fontified t) 208 214 (face font-lock-keyword-face fontified t) 214 229 (fontified t) 229 235 (face font-lock-keyword-face fontified t) 235 251 (fontified t) 251 254 (face font-lock-keyword-face fontified t) 254 306 (fontified t) 306 308 (face font-lock-keyword-face fontified t) 308 391 (fontified t) 391 396 (face font-lock-builtin-face fontified t) 396 431 (fontified t) 431 435 (face font-lock-keyword-face fontified t) 435 472 (fontified t) 472 474 (fontified t) 474 495 (fontified t) 495 498 (face font-lock-comment-delimiter-face fontified t) 498 540 (face font-lock-comment-face fontified t) 540 569 (fontified t) 569 571 (face font-lock-keyword-face fontified t) 571 580 (fontified t) 580 584 (face font-lock-string-face fontified t) 584 590 (fontified t) 590 592 (face font-lock-string-face fontified t) 592 643 (fontified t) 643 655 (fontified t) 655 672 (fontified t) 672 684 (face font-lock-keyword-face fontified t) 684 706 (fontified t) 706 708 (face font-lock-keyword-face fontified t) 708 726 (fontified t) 726 727 (fontified t) 727 730 (fontified t) 730 812 (fontified t) 812 847 (face font-lock-comment-face fontified t) 847 872 (fontified t) 872 876 (face font-lock-keyword-face fontified t) 876 1039 (fontified t) 1039 1046 (face font-lock-builtin-face fontified t) 1046 1104 (fontified t) 1104 1112 (face font-lock-builtin-face fontified t) 1112 1125 (fontified t) 1125 1139 (face font-lock-string-face fontified t) 1139 1239 (fontified t) 1239 1254 (face font-lock-string-face fontified t) 1254 1255 (fontified t) 1255 1277 (face font-lock-string-face fontified t) 1277 1324 (fontified t) 1324 1333 (fontified t) 1333 1338 (face font-lock-builtin-face fontified t) 1338 1386 (fontified t) 1386 1388 (fontified t) 1388 1412 (fontified t) 1412 1415 (face font-lock-comment-delimiter-face fontified t) 1415 1463 (face font-lock-comment-face fontified t) 1463 1488 (face font-lock-comment-face fontified t) 1488 1498 (fontified t) 1498 1500 (fontified t) 1500 1514 (fontified t) 1514 1517 (face font-lock-comment-delimiter-face fontified t) 1517 1584 (face font-lock-comment-face fontified t) 1584 1669 (fontified t) 1669 1685 (face font-lock-string-face fontified t) 1685 1707 (fontified t) 1707 1712 (face font-lock-warning-face fontified t) 1712 1765 (fontified t) 1765 1777 (face font-lock-string-face fontified t) 1777 1782 (fontified t) 1782 1819 (fontified t) 1819 1820 (fontified t rear-nonsticky t) 1820 1821 (fontified t)) . -15870) (undo-tree-id153 . -369) (undo-tree-id154 . -814) (undo-tree-id155 . -1821) (undo-tree-id156 . -1) (undo-tree-id157 . -1386) (undo-tree-id158 . -655) (undo-tree-id159 . -655) (undo-tree-id160 . -655) (undo-tree-id161 . -655) (undo-tree-id162 . -655) (undo-tree-id163 . -655) (undo-tree-id164 . -655) (undo-tree-id165 . -655) (undo-tree-id166 . -599) (undo-tree-id167 . -168) (undo-tree-id168 . -898) (undo-tree-id169 . -1821) (undo-tree-id170 . -1821) (undo-tree-id171 . -1821) (undo-tree-id172 . -1821) (undo-tree-id173 . -1821) (undo-tree-id174 . -1821) (undo-tree-id175 . -1821) (undo-tree-id176 . -1821) (undo-tree-id177 . -1821) (undo-tree-id178 . -1821) (undo-tree-id179 . -1821) (undo-tree-id180 . -1821) (undo-tree-id181 . -1821) (undo-tree-id182 . -1821) 17691) nil (26795 1355 891460 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -15869) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) (undo-tree-id150 . -1) (undo-tree-id151 . -1) (undo-tree-id152 . -1) 15870) nil (26795 1355 891444 0) 0 nil])
([nil nil ((15869 . 15870) 15300) nil (26795 1355 891409 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -14566) (undo-tree-id209 . -1) 14567 (t 26795 1355 0 0)) nil (26795 1768 112939 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15121) (undo-tree-id208 . -1) 15122) nil (26795 1768 112938 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15690) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) (undo-tree-id207 . -1) 15691) nil (26795 1768 112936 0) 0 nil])
([nil nil ((15866 . 15867)) nil (26795 1768 112919 0) 0 nil])
([nil nil ((15867 . 15869)) nil (26795 1768 112918 0) 0 nil])
([nil nil ((15766 . 15769) (#("    " 0 4 (fontified t)) . 15766) (15716 . 15719) (15685 . 15689) (#("          " 0 10 (fontified t)) . 15685) (15653 . 15661) (#("              " 0 14 (fontified t)) . 15653) (15630 . 15638) (#("              " 0 14 (fontified t)) . 15630) (15612 . 15616) (#("                   " 0 19 (fontified t)) . 15612) (15558 . 15564) (15439 . 15444) (#("                                  " 0 34 (fontified t)) . 15439) (15422 . 15427) (#("                                  " 0 34 (fontified t)) . 15422) (15377 . 15381) (#("                   " 0 19 (fontified t)) . 15377) (15331 . 15337) (15287 . 15293) (15252 . 15258) (15171 . 15175) (15138 . 15144) (#("                       " 0 23 (fontified t)) . 15138) (15123 . 15125) (15027 . 15029) (14970 . 14972) (14884 . 14886) (14815 . 14817) (14677 . 14679) (14637 . 14639) (14592 . 14594) 12179) nil (26795 1768 112913 0) 0 nil])
([nil nil ((12742 . 12744) (t 26795 1768 0 0)) nil (26795 3561 91837 0) 0 nil])
([nil nil ((12744 . 12750)) nil (26795 3561 91836 0) 0 nil])
([nil nil ((12750 . 12751)) nil (26795 3561 91836 0) 0 nil])
([nil nil ((12751 . 12754)) nil (26795 3561 91836 0) 0 nil])
([nil nil ((12754 . 12755)) nil (26795 3561 91835 0) 0 nil])
([nil nil ((12755 . 12763)) nil (26795 3561 91830 0) 0 nil])
([nil nil ((12816 . 12820) (t 26795 3561 0 0)) nil (26795 3836 444419 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12838 . 12839) (nil fontified nil 12838 . 12839) (nil fontified nil 12827 . 12838) (nil fontified nil 12820 . 12827) (12820 . 12839)) nil (26795 3836 444419 0) 0 nil])
([nil nil ((#("\"IN STATIC\"" 0 11 (face font-lock-string-face fontified t)) . -12827) (undo-tree-id218 . -11) 12838) nil (26795 3836 444418 0) 0 nil])
([nil nil ((12827 . 12831)) nil (26795 3836 444417 0) 0 nil])
([nil nil ((12832 . 12836)) nil (26795 3836 444417 0) 0 nil])
([nil nil ((nil fontified nil 12847 . 12848) (nil fontified nil 12836 . 12847) (12836 . 12848)) nil (26795 3836 444416 0) 0 nil])
([nil nil ((#("path" 0 4 (fontified t)) . -12843) (undo-tree-id217 . -4) 12847) nil (26795 3836 444416 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12852 . 12853) (nil fontified nil 12843 . 12853) (12843 . 12853)) nil (26795 3836 444415 0) 0 nil])
([nil nil ((12832 . 12836)) nil (26795 3836 444414 0) 0 nil])
([nil nil ((nil fontified nil 12847 . 12848) (nil fontified nil 12836 . 12847) (12836 . 12848)) nil (26795 3836 444414 0) 0 nil])
([nil nil ((#("path" 0 4 (fontified t)) . -12843) (undo-tree-id214 . -4) (undo-tree-id215 . -4) (undo-tree-id216 . -4) 12847) nil (26795 3836 444413 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12848 . 12849) (nil fontified nil 12843 . 12849) (12843 . 12849)) nil (26795 3836 444411 0) 0 nil])
([nil nil ((12849 . 12850)) nil (26795 3836 444411 0) 0 nil])
([nil nil ((12982 . 12990)) nil (26795 3836 444410 0) 0 nil])
([nil nil ((nil fontified nil 13007 . 13008) (nil fontified nil 13006 . 13007) (nil fontified nil 12997 . 13006) (nil fontified nil 12990 . 12997) (12990 . 13008)) nil (26795 3836 444410 0) 0 nil])
([nil nil ((#("prefix-len" 0 9 (fontified t) 9 10 (fontified t rear-nonsticky t)) . -12997) (undo-tree-id211 . -10) (undo-tree-id212 . -10) (undo-tree-id213 . -10) 13007) nil (26795 3836 444409 0) 0 nil])
([nil nil ((12997 . 13003)) nil (26795 3836 444406 0) 0 nil])
([nil nil ((#("Ã©" 0 1 (face font-lock-string-face fontified t)) . -13002) (undo-tree-id210 . -1) 13003) nil (26795 3836 444405 0) 0 nil])
([nil nil ((13002 . 13003)) nil (26795 3836 444398 0) 0 nil])
([nil nil ((13136 . 13139)) nil (26795 3836 444398 0) 0 nil])
([nil nil ((nil fontified nil 13152 . 13153) (nil fontified nil 13146 . 13152) (nil fontified nil 13139 . 13146) (13139 . 13153)) nil (26795 3836 444397 0) 0 nil])
([nil nil ((13151 . 13152)) nil (26795 3836 444396 0) 0 nil])
([nil nil ((13152 . 13153)) nil (26795 3836 444392 0) 0 nil])
([nil nil ((#("prefix" 0 5 (fontified t) 5 6 (rear-nonsticky t fontified t)) . -12843) (undo-tree-id226 . -6) 12849 (t 26795 3836 0 0)) nil (26795 4013 598702 0) 0 nil])
([nil nil ((12843 . 12847)) nil (26795 4013 598701 0) 0 nil])
([nil nil ((10580 . 10585)) nil (26795 4013 598700 0) 0 nil])
([nil nil ((10585 . 10591)) nil (26795 4013 598700 0) 0 nil])
([nil nil ((10591 . 10592)) nil (26795 4013 598700 0) 0 nil])
([nil nil ((10592 . 10597)) nil (26795 4013 598699 0) 0 nil])
([nil nil ((10597 . 10598)) nil (26795 4013 598699 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-string-face fontified t)) . -10594) (undo-tree-id222 . -1) (#("F" 0 1 (face font-lock-string-face fontified t)) . -10595) (undo-tree-id223 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -10596) (undo-tree-id224 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -10597) (undo-tree-id225 . -1) 10598) nil (26795 4013 598698 0) 0 nil])
([nil nil ((10594 . 10597)) nil (26795 4013 598695 0) 0 nil])
([nil nil ((10597 . 10598)) nil (26795 4013 598695 0) 0 nil])
([nil nil ((10598 . 10602)) nil (26795 4013 598694 0) 0 nil])
([nil nil ((10602 . 10603)) nil (26795 4013 598694 0) 0 nil])
([nil nil ((10603 . 10606)) nil (26795 4013 598693 0) 0 nil])
([nil nil ((10781 . 10788)) nil (26795 4013 598693 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10808 . 10809) (nil fontified nil 10808 . 10809) (nil fontified nil 10795 . 10808) (nil fontified nil 10788 . 10795) (10788 . 10809)) nil (26795 4013 598692 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -10806) (undo-tree-id219 . -1) (undo-tree-id220 . -1) (undo-tree-id221 . -1) 10807) nil (26795 4013 598690 0) 0 nil])
([nil nil ((10806 . 10807)) nil (26795 4013 598678 0) 0 nil])
([nil nil ((9607 . 9610) (t 26795 4013 0 0)) nil (26795 4111 432787 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9630 . 9631) (nil fontified nil 9630 . 9631) (nil fontified nil 9617 . 9630) (nil fontified nil 9610 . 9617) (9610 . 9631)) nil (26795 4111 432786 0) 0 nil])
([nil nil ((9618 . 9620)) nil (26795 4111 432786 0) 0 nil])
([nil nil ((9620 . 9621)) nil (26795 4111 432785 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . 9631)) nil (26795 4111 432785 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -9630) (undo-tree-id241 . -1) 9631) nil (26795 4111 432784 0) 0 nil])
([nil nil ((10123 . 10126)) nil (26795 4111 432783 0) 0 nil])
([nil nil ((10126 . 10128)) nil (26795 4111 432783 0) 0 nil])
([nil nil ((10128 . 10129)) nil (26795 4111 432783 0) 0 nil])
([nil nil ((10129 . 10135)) nil (26795 4111 432782 0) 0 nil])
([nil nil ((10135 . 10136)) nil (26795 4111 432782 0) 0 nil])
([nil nil ((10136 . 10140)) nil (26795 4111 432781 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -10139) (undo-tree-id240 . -1) 10140) nil (26795 4111 432781 0) 0 nil])
([nil nil ((10139 . 10142)) nil (26795 4111 432780 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -10141) (undo-tree-id239 . -1) 10142) nil (26795 4111 432779 0) 0 nil])
([nil nil ((10141 . 10142)) nil (26795 4111 432777 0) 0 nil])
([nil nil ((9750 . 9753)) nil (26795 4111 432777 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9768 . 9769) (nil fontified nil 9753 . 9769) (9753 . 9769)) nil (26795 4111 432777 0) 0 nil])
([nil nil ((#("2" 0 1 (fontified t)) . -9766) (undo-tree-id232 . -1) (undo-tree-id233 . -1) (undo-tree-id234 . -1) (undo-tree-id235 . -1) (undo-tree-id236 . -1) (undo-tree-id237 . -1) (undo-tree-id238 . -1) 9767) nil (26795 4111 432776 0) 0 nil])
([nil nil ((9766 . 9767)) nil (26795 4111 432772 0) 0 nil])
([nil nil ((10555 . 10558)) nil (26795 4111 432772 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10573 . 10574) (nil fontified nil 10558 . 10574) (10558 . 10574)) nil (26795 4111 432771 0) 0 nil])
([nil nil ((#("2" 0 1 (fontified t)) . -10571) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -1) 10572) nil (26795 4111 432770 0) 0 nil])
([nil nil ((10571 . 10572)) nil (26795 4163 447584 0) 0 nil])
([nil nil ((13138 . 13146) (t 26795 4111 0 0)) nil (26795 4366 306125 0) 0 nil] [nil nil ((13189 . 13195) (t 26795 4111 0 0)) ((#("
			  " 0 1 (fontified t) 1 6 (fontified t)) . 13189) (undo-tree-id243 . -6) (undo-tree-id244 . -1) (undo-tree-id245 . -1) (undo-tree-id246 . -6) (undo-tree-id247 . -6) (undo-tree-id248 . -6) (undo-tree-id249 . -6)) (26795 4162 758507 0) 0 nil])
([nil nil ((13146 . 13152)) nil (26795 4366 306125 0) 0 nil])
([nil nil ((13195 . 13201)) ((#("(print" 0 6 (fontified t)) . 13195) (undo-tree-id242 . -6)) (26795 4162 758462 0) 0 nil])
([nil nil ((13152 . 13153)) nil (26795 4366 306124 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 13176 . 13177) (nil fontified nil 13153 . 13177) (13153 . 13177)) nil (26795 4366 306124 0) 0 nil])
([nil nil ((13177 . 13178)) nil (26795 4366 306123 0) 0 nil])
([nil nil ((#("(print \"OKKK\")
	      (print (subseq path prefix-len))" 0 7 (fontified t) 7 13 (face font-lock-string-face fontified t) 13 14 (fontified t rear-nonsticky t) 14 15 (fontified t) 15 29 (fontified t) 29 52 (fontified t) 52 53 (rear-nonsticky t fontified t) 53 54 (fontified t)) . 13124) (undo-tree-id253 . -14) (undo-tree-id254 . -54) 13178) nil (26795 4366 306123 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13116)) nil (26795 4366 306121 0) 0 nil])
([nil nil ((13274 . 13277)) nil (26795 4366 306121 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13330 . 13331) (nil fontified nil 13330 . 13331) (nil fontified nil 13329 . 13330) (nil fontified nil 13306 . 13329) (nil fontified nil 13292 . 13306) (nil fontified nil 13291 . 13292) (nil fontified nil 13290 . 13291) (nil fontified nil 13284 . 13290) (nil fontified nil 13277 . 13284) (13277 . 13331)) nil (26795 4366 306120 0) 0 nil])
([nil nil ((#("
		(print \"OKKK\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 16 (face font-lock-string-face fontified t) 16 17 (fontified t rear-nonsticky t)) . 13274) (undo-tree-id252 . -17)) nil (26795 4366 306119 0) 0 nil])
([nil nil ((13274 . 13277)) nil (26795 4366 306118 0) 0 nil])
([nil nil ((nil fontified nil 13292 . 13293) (nil fontified nil 13284 . 13292) (nil fontified nil 13277 . 13284) (13277 . 13293)) nil (26795 4366 306118 0) 0 nil])
([nil nil ((#("\"OKKK 1\"" 0 8 (face font-lock-string-face fontified t)) . -13284) (undo-tree-id251 . -8) 13292) nil (26795 4366 306117 0) 0 nil])
([nil nil ((13284 . 13290)) nil (26795 4366 306115 0) 0 nil])
([nil nil ((13480 . 13490)) nil (26795 4366 306115 0) 0 nil])
([nil nil ((nil fontified nil 13505 . 13506) (nil fontified nil 13497 . 13505) (nil fontified nil 13490 . 13497) (13490 . 13506)) nil (26795 4366 306114 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -13503) (undo-tree-id250 . -1) 13504) nil (26795 4366 306112 0) 0 nil])
([nil nil ((13503 . 13504)) nil (26795 4366 306101 0) 0 nil])
([nil nil ((12313 . 12315) (t 26795 4366 0 0)) nil (26795 5405 680073 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18991 . 18992) (nil fontified nil 12315 . 18992) (12315 . 18992)) nil (26795 5405 680072 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t rear-nonsticky t)) . -18991) (undo-tree-id10 . -1) 18992) nil (26795 5405 680071 0) 0 nil])
([nil nil ((#("

(defun static (&key prefix dir (auto-index t) (try-index \"index.html\") (redirect-dir t))
  \"Servez fichiers ET dossiers.
  - prefix: URL base (ex: \\\"/public\\\")
  - dir   : rÃ©pertoire racine (pathname)
  - auto-index: si T, gÃ©nÃ¨re un index HTML pour les dossiers
  - try-index : nom de fichier dâ€™index Ã  servir si prÃ©sent (NIL pour dÃ©sactiver)
  - redirect-dir: rediriger vers lâ€™URL avec slash si dossier sans slash\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (prefix-len (length prefix*)))
    (lambda (next)
      (lambda (req)
	(print \"IN STATIC\")
        (let ((path (lumen.core.http:req-path req)))
	  (print path)
	  (print root*)
	  (print prefix-len)
          (if (and (>= (length path) prefix-len)
                   (string= prefix* path :end2 prefix-len))	      
              (let* ((rel (subseq path prefix-len)) ; peut Ãªtre \"\" ou \"sub/..\"
                     (target (safe-join root* rel)))
		(print \"OKKK 1\")
		(print target)
	      (print (subseq path prefix-len))
                (handler-case
                    (cond
                      ;; Dossier ?
                      ((uiop:directory-pathname-p target)
		       (print \"OKKK 3\")
                       (let* ((has-trailing-slash (and (> (length path) 0)
                                                       (char= (char path (1- (length path))) #\\/))))
                         (cond
                           ;; Redirection /path â†’ /path/
                           ((and redirect-dir (not has-trailing-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\")))
                                           :body \"\"))
                           ;; index.html ?
                           ((and try-index
                                 (probe-file (merge-pathnames try-index (uiop:ensure-directory-pathname target))))
                            (let* ((pn (merge-pathnames try-index (uiop:ensure-directory-pathname target)))
                                   (bytes (read-file-bytes pn)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" (guess-content-type pn))
                                                            (cons \"cache-control\" \"public, max-age=300\")))
                              :body bytes))
                           ;; listing auto ?
                           (auto-index
                            (let* ((html (directory-index-html (uiop:ensure-directory-pathname target)
                                                               (if (plusp (length path)) path \"/\"))))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")))
                              :body html))
			   (t
                            (lumen.core.http:respond-404 \"Directory index disabled\")))))
                      ;; Fichier ?
                      ((probe-file target)
                       (let ((bytes (read-file-bytes target)))
			 (make-instance 'lumen.core.http:response
					:status 200
					:headers (list (cons \"content-type\" (guess-content-type target))
                                                       (cons \"cache-control\" \"public, max-age=3600\")))
			 :body bytes))
		      ;; Rien trouvÃ©
		      (t (funcall next req)))
		  (error ()
                    (lumen.core.http:respond-404 \"File error\")))))
	  (funcall next req))))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 14 (face font-lock-function-name-face fontified t) 14 15 (face font-lock-function-name-face fontified t) 15 17 (fontified t) 17 21 (face font-lock-type-face fontified t) 21 59 (fontified t) 59 71 (face font-lock-string-face fontified t) 71 93 (fontified t) 93 384 (face font-lock-doc-face fontified t) 384 417 (face font-lock-doc-face fontified t) 417 418 (fontified t) 418 421 (fontified t) 421 425 (face font-lock-keyword-face fontified t) 425 447 (fontified t) 447 450 (face font-lock-string-face fontified t) 450 532 (fontified t) 532 538 (face font-lock-keyword-face fontified t) 538 553 (fontified t) 553 559 (face font-lock-keyword-face fontified t) 559 574 (fontified t) 574 585 (face font-lock-string-face fontified t) 585 596 (fontified t) 596 599 (face font-lock-keyword-face fontified t) 599 706 (fontified t) 706 708 (face font-lock-keyword-face fontified t) 708 785 (fontified t) 785 790 (face font-lock-builtin-face fontified t) 790 826 (fontified t) 826 830 (face font-lock-keyword-face fontified t) 830 863 (fontified t) 863 890 (face font-lock-comment-face fontified t) 890 952 (fontified t) 952 960 (face font-lock-string-face fontified t) 960 1036 (fontified t) 1036 1048 (face font-lock-keyword-face fontified t) 1048 1070 (fontified t) 1070 1074 (face font-lock-keyword-face fontified t) 1074 1097 (fontified t) 1097 1100 (face font-lock-comment-delimiter-face fontified t) 1100 1110 (face font-lock-comment-face fontified t) 1110 1184 (fontified t) 1184 1192 (face font-lock-string-face fontified t) 1192 1218 (fontified t) 1218 1222 (face font-lock-keyword-face fontified t) 1222 1396 (fontified t) 1396 1400 (face font-lock-keyword-face fontified t) 1400 1428 (fontified t) 1428 1431 (face font-lock-comment-delimiter-face fontified t) 1431 1458 (face font-lock-comment-face fontified t) 1458 1501 (fontified t) 1501 1514 (fontified t) 1514 1530 (fontified t) 1530 1642 (fontified t) 1642 1649 (face font-lock-builtin-face fontified t) 1649 1697 (fontified t) 1697 1705 (face font-lock-builtin-face fontified t) 1705 1718 (fontified t) 1718 1728 (face font-lock-string-face fontified t) 1728 1755 (fontified t) 1755 1758 (face font-lock-string-face fontified t) 1758 1805 (fontified t) 1805 1810 (face font-lock-builtin-face fontified t) 1810 1811 (fontified t) 1811 1813 (face font-lock-string-face fontified t) 1813 1843 (fontified t) 1843 1846 (face font-lock-comment-delimiter-face fontified t) 1846 1859 (face font-lock-comment-face fontified t) 1859 1918 (fontified t) 1918 2017 (fontified t) 2017 2046 (fontified t) 2046 2050 (face font-lock-keyword-face fontified t) 2050 2306 (fontified t) 2306 2313 (face font-lock-builtin-face fontified t) 2313 2363 (fontified t) 2363 2371 (face font-lock-builtin-face fontified t) 2371 2384 (fontified t) 2384 2398 (face font-lock-string-face fontified t) 2398 2490 (fontified t) 2490 2505 (face font-lock-string-face fontified t) 2505 2506 (fontified t) 2506 2527 (face font-lock-string-face fontified t) 2527 2561 (fontified t) 2561 2566 (face font-lock-builtin-face fontified t) 2566 2602 (fontified t) 2602 2605 (face font-lock-comment-delimiter-face fontified t) 2605 2620 (face font-lock-comment-face fontified t) 2620 2688 (fontified t) 2688 2692 (face font-lock-keyword-face fontified t) 2692 2826 (fontified t) 2826 2828 (face font-lock-keyword-face fontified t) 2828 2856 (fontified t) 2856 2859 (face font-lock-string-face fontified t) 2859 2980 (fontified t) 2980 2987 (face font-lock-builtin-face fontified t) 2987 3030 (fontified t) 3030 3037 (fontified t) 3037 3045 (face font-lock-builtin-face fontified t) 3045 3058 (fontified t) 3058 3072 (face font-lock-string-face fontified t) 3072 3073 (fontified t) 3073 3099 (face font-lock-string-face fontified t) 3099 3103 (fontified t) 3103 3133 (fontified t) 3133 3138 (face font-lock-builtin-face fontified t) 3138 3212 (fontified t) 3212 3238 (face font-lock-string-face fontified t) 3238 3266 (fontified t) 3266 3269 (face font-lock-comment-delimiter-face fontified t) 3269 3279 (face font-lock-comment-face fontified t) 3279 3346 (fontified t) 3346 3349 (face font-lock-keyword-face fontified t) 3349 3435 (fontified t) 3435 3442 (face font-lock-builtin-face fontified t) 3442 3452 (fontified t) 3452 3460 (face font-lock-builtin-face fontified t) 3460 3473 (fontified t) 3473 3487 (face font-lock-string-face fontified t) 3487 3578 (fontified t) 3578 3593 (face font-lock-string-face fontified t) 3593 3594 (fontified t) 3594 3616 (face font-lock-string-face fontified t) 3616 3624 (fontified t) 3624 3629 (face font-lock-builtin-face fontified t) 3629 3646 (fontified t) 3646 3649 (face font-lock-comment-delimiter-face fontified t) 3649 3661 (face font-lock-comment-face fontified t) 3661 3698 (fontified t) 3698 3703 (face font-lock-warning-face fontified t) 3703 3756 (fontified t) 3756 3768 (face font-lock-string-face fontified t) 3768 3800 (fontified t)) . -18991) (undo-tree-id8 . -3800) (undo-tree-id9 . -2318) 22791) nil (26795 5405 680068 0) 0 nil])
([nil nil ((18758 . 18766) (#("                    " 0 20 (fontified t)) . 18758) (18744 . 18748) (18701 . 18702) (18616 . 18617) (18578 . 18579) (18457 . 18464) (#("                                                       " 0 55 (fontified t)) . 18457) (18391 . 18392) (18338 . 18339) (18256 . 18257) (18187 . 18190) (#("                       " 0 23 (fontified t)) . 18187) (18165 . 18166) (18111 . 18112) (15451 . 15452) (#("                " 0 16 (fontified t)) . 15451) 14331) nil (26795 5405 680065 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -14329) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 14330) nil (26795 5405 680059 0) 0 nil])
([nil nil ((#("uiop" 0 4 (fontified t)) . -15582) (undo-tree-id11 . -4) 15586 (t 26795 5405 0 0)) nil (26795 5573 264841 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . 15582)) nil (26795 5573 264833 0) 0 nil])
([nil nil ((15582 . 15594)) nil (26795 5573 264829 0) 0 nil])
([nil nil ((18818 . 18819) (t 26795 5573 0 0)) nil (26795 5615 564623 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18914) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 18915) nil (26795 5615 564619 0) 0 nil])
([nil nil ((18731 . 18732) (t 26795 5615 0 0)) nil (26795 5659 81620 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18819) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) 18820) nil (26795 5659 81617 0) 0 nil])
([nil nil ((18094 . 18095) (t 26795 5659 0 0)) nil (26795 5753 67413 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18732) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) 18733) nil (26795 5753 67412 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18818) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) 18819) nil (26795 5753 67402 0) 0 nil])
([nil nil ((18913 . 18914)) nil (26795 5753 67370 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15361 . 15362) (nil fontified nil 15319 . 15362) (15319 . 15362) (t 26795 5753 0 0)) nil (26795 6500 592142 0) 0 nil])
([nil nil ((15362 . 15370)) nil (26795 6500 592141 0) 0 nil])
([nil nil ((#("(and (>= (length path) plen)
                   (string= prefix* path :end2 plen))" 0 29 (fontified t) 29 70 (fontified t) 70 75 (face font-lock-builtin-face fontified t) 75 82 (fontified t)) . -15370) (undo-tree-id97 . -82) 15452) nil (26795 6500 592140 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 15362)) nil (26795 6500 592139 0) 0 nil])
([nil nil ((#("core" 0 4 (fontified t)) . -15326) (undo-tree-id96 . -4) 15330) nil (26795 6500 592138 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . 15326)) nil (26795 6500 592137 0) 0 nil])
([nil nil ((15330 . 15331)) nil (26795 6500 592137 0) 0 nil])
([nil nil ((206 . 207)) nil (26795 6500 592137 0) 0 nil])
([nil nil ((207 . 223)) nil (26795 6500 592136 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-builtin-face fontified t)) . -211) (undo-tree-id93 . -1) (#("n" 0 1 (face font-lock-builtin-face fontified t)) . -212) (undo-tree-id94 . -1) (#("g" 0 1 (face font-lock-builtin-face fontified t)) . -213) (undo-tree-id95 . -1) 214) nil (26795 6500 592135 0) 0 nil])
([nil nil ((#("

(defun ensure-header (headers name value)
  \"Remplace/insÃ¨re (name . value) en insensibilitÃ© de casse.\"
  (let* ((lname (string-downcase name))
         (found (assoc lname headers :test #'string=)))
    (if found
        (progn (setf (cdr found) value) headers)
        (append headers (list (cons lname value))))))" 0 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-function-name-face fontified t) 22 46 (fontified t) 46 105 (face font-lock-doc-face fontified t) 105 109 (fontified t) 109 113 (face font-lock-keyword-face fontified t) 113 183 (fontified t) 183 188 (face font-lock-builtin-face fontified t) 188 207 (fontified t) 207 209 (face font-lock-keyword-face fontified t) 209 225 (fontified t) 225 230 (face font-lock-keyword-face fontified t) 230 318 (fontified t)) . 4575) (undo-tree-id92 . -318)) nil (26795 6500 592133 0) 0 nil])
([nil nil ((5249 . 5259)) nil (26795 6500 592132 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -5258) (undo-tree-id91 . -1) 5259) nil (26795 6500 592131 0) 0 nil])
([nil nil ((5258 . 5260)) nil (26795 6500 592130 0) 0 nil])
([nil nil ((#("i" 0 1 (fontified t)) . -5258) (undo-tree-id89 . -1) (#("l" 0 1 (fontified t)) . -5259) (undo-tree-id90 . -1) 5260) nil (26795 6500 592129 0) 0 nil])
([nil nil ((5258 . 5261)) nil (26795 6500 592206 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6639 . 6640) (nil fontified nil 6629 . 6640) (6629 . 6640)) nil (26795 6643 913412 0) 0 nil] [nil nil ((nil rear-nonsticky nil 5286 . 5287) (nil fontified nil 5274 . 5287) (5274 . 5287)) ((#("ensure-header" 0 12 (fontified nil) 12 13 (rear-nonsticky nil fontified nil)) . 5274) (undo-tree-id98 . -13) (nil rear-nonsticky t 5286 . 5287)) (26795 6500 592114 0) 0 nil])
([nil nil ((6640 . 6641)) nil (26795 6643 913412 0) 0 nil])
nil
([nil nil ((#("e" 0 1 (rear-nonsticky t fontified t)) . 6636) (#("r" 0 1 (fontified t)) . 6636) (#("o" 0 1 (fontified t)) . 6636) (#("c" 0 1 (fontified t)) . 6636)) nil (26795 6643 913411 0) 0 nil])
([nil nil ((6636 . 6640)) nil (26795 6643 913410 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -6639) (undo-tree-id107 . -1) 6640) nil (26795 6643 913410 0) 0 nil])
([nil nil ((6639 . 6641)) nil (26795 6643 913409 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . 6629)) nil (26795 6643 913408 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6742 . 6743) (nil fontified nil 6742 . 6743) (nil fontified nil 6731 . 6742) (6731 . 6743)) nil (26795 6643 913408 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6916 . 6917) (nil fontified nil 6916 . 6917) (nil fontified nil 6905 . 6916) (6905 . 6917)) nil (26795 6643 913407 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7188 . 7189) (nil fontified nil 7188 . 7189) (nil fontified nil 7177 . 7188) (7177 . 7189)) nil (26795 6643 913406 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7785 . 7786) (nil fontified nil 7785 . 7786) (nil fontified nil 7774 . 7785) (7774 . 7786)) nil (26795 6643 913406 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7884 . 7885) (nil fontified nil 7884 . 7885) (nil fontified nil 7873 . 7884) (7873 . 7885)) nil (26795 6643 913405 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8005 . 8006) (nil fontified nil 8005 . 8006) (nil fontified nil 7994 . 8005) (7994 . 8006)) nil (26795 6643 913404 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8126 . 8127) (nil fontified nil 8126 . 8127) (nil fontified nil 8115 . 8126) (8115 . 8127)) nil (26795 6643 913404 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8326 . 8327) (nil fontified nil 8326 . 8327) (nil fontified nil 8315 . 8326) (8315 . 8327)) nil (26795 6643 913403 0) 0 nil])
([nil nil ((220 . 221)) nil (26795 6643 913402 0) 0 nil])
([nil nil ((221 . 229)) nil (26795 6643 913402 0) 0 nil])
([nil nil ((221 . 235) (#(":ensure-" 0 8 (face font-lock-builtin-face fontified t)) . -221) (undo-tree-id106 . -8) 229) nil (26795 6643 913401 0) 0 nil])
([nil nil ((#("e" 0 1 (face font-lock-builtin-face fontified t)) . -229) (undo-tree-id100 . -1) (#("x" 0 1 (face font-lock-builtin-face fontified t)) . -230) (undo-tree-id101 . -1) (#("p" 0 1 (face font-lock-builtin-face fontified t)) . -231) (undo-tree-id102 . -1) (#("o" 0 1 (face font-lock-builtin-face fontified t)) . -232) (undo-tree-id103 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -233) (undo-tree-id104 . -1) (#("t" 0 1 (face font-lock-builtin-face fontified t)) . -234) (undo-tree-id105 . -1) 235) nil (26795 6643 913399 0) 0 nil])
([nil nil ((229 . 231)) nil (26795 6643 913393 0) 0 nil])
([nil nil ((221 . 235) (#(":ensure-he" 0 10 (face font-lock-builtin-face fontified t)) . -221) (undo-tree-id99 . -10) 231) nil (26795 6643 913390 0) 0 nil])
([nil nil ((#("
(defun directory-index-html (dir rel-url)
  \"GÃ©nÃ¨re un listing minimal (UTF-8) pour DIR. rel-url commence par /.\"
  (let* ((entries (uiop:directory-files dir))
         (subdirs (uiop:subdirectories dir)))
    (with-output-to-string (s)
      (format s \"<!doctype html><meta charset='utf-8'><title>Index of ~A</title>\" rel-url)
      (format s \"<h1>Index of ~A</h1><ul>\" rel-url)
      (when (and (> (length rel-url) 1))
        (let* ((up (if (char= (char rel-url (1- (length rel-url))) #\\/)
                       (subseq rel-url 0 (max 1 (position #\\/ rel-url :from-end t :end (1- (length rel-url)))))
                       (subseq rel-url 0 (max 1 (position #\\/ rel-url :from-end t))))))
          (format s \"<li><a href='~A'>..</a></li>\" up)))
      (dolist (sd (sort (copy-list subdirs) #'string< :key #'namestring))
        (let* ((name (car (last (uiop:split-string (namestring sd) :separator \"/\")))))
          (format s \"<li><a href='~A/'>~A/</a></li>\" name name)))
      (dolist (f (sort (copy-list entries) #'string< :key #'namestring))
        (let* ((name (car (last (uiop:split-string (namestring f) :separator \"/\")))))
          (format s \"<li><a href='~A'>~A</a></li>\" name name)))
      (format s \"</ul>\"))))
" 0 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 45 (fontified t) 45 114 (face font-lock-doc-face fontified t) 114 118 (fontified t) 118 122 (face font-lock-keyword-face fontified t) 122 212 (fontified t) 212 233 (face font-lock-keyword-face fontified t) 233 254 (fontified t) 254 319 (face font-lock-string-face fontified t) 319 345 (fontified t) 345 371 (face font-lock-string-face fontified t) 371 388 (fontified t) 388 392 (face font-lock-keyword-face fontified t) 392 431 (fontified t) 431 435 (face font-lock-keyword-face fontified t) 435 442 (fontified t) 442 444 (face font-lock-keyword-face fontified t) 444 564 (fontified t) 564 573 (face font-lock-builtin-face fontified t) 573 576 (fontified t) 576 580 (face font-lock-builtin-face fontified t) 580 676 (fontified t) 676 685 (face font-lock-builtin-face fontified t) 685 714 (fontified t) 714 744 (face font-lock-string-face fontified t) 744 758 (fontified t) 758 764 (face font-lock-keyword-face fontified t) 764 805 (fontified t) 805 809 (face font-lock-builtin-face fontified t) 809 834 (fontified t) 834 838 (face font-lock-keyword-face fontified t) 838 892 (fontified t) 892 902 (face font-lock-builtin-face fontified t) 902 903 (fontified t) 903 906 (face font-lock-string-face fontified t) 906 932 (fontified t) 932 964 (face font-lock-string-face fontified t) 964 985 (fontified t) 985 991 (face font-lock-keyword-face fontified t) 991 1031 (fontified t) 1031 1035 (face font-lock-builtin-face fontified t) 1035 1060 (fontified t) 1060 1064 (face font-lock-keyword-face fontified t) 1064 1117 (fontified t) 1117 1127 (face font-lock-builtin-face fontified t) 1127 1128 (fontified t) 1128 1131 (face font-lock-string-face fontified t) 1131 1157 (fontified t) 1157 1187 (face font-lock-string-face fontified t) 1187 1217 (fontified t) 1217 1224 (face font-lock-string-face fontified t) 1224 1229 (fontified t)) . -10916) (undo-tree-id0 . -1229) (undo-tree-id1 . -28) (undo-tree-id2 . -28) (undo-tree-id3 . -28) (undo-tree-id4 . -28) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1051) (undo-tree-id8 . -1229) 12145 (t 26795 6643 0 0)) nil (26795 14565 540668 0) 0 nil])
([nil nil ((#("
	 (x (print rel1))" 0 19 (fontified t)) . 9581) (undo-tree-id15 . -19) (t 26795 14565 0 0)) nil (26795 15182 349301 0) 0 nil])
([nil nil ((#("
	 (x (print rel2))" 0 19 (fontified t)) . 9954) (undo-tree-id14 . -19)) nil (26795 15182 349300 0) 0 nil])
([nil nil ((#("
	 (x (print rel3))" 0 19 (fontified t)) . 10348) (undo-tree-id13 . -19)) nil (26795 15182 349298 0) 0 nil])
([nil nil ((#("
    (print \"SAFE JOIN 1\")" 0 12 (fontified t) 12 25 (face font-lock-string-face fontified t) 25 26 (fontified t)) . 10436) (undo-tree-id12 . -26)) nil (26795 15182 349297 0) 0 nil])
([nil nil ((#("
      (print \"SAFE JOIN 2\")" 0 14 (fontified t) 14 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 10611) (undo-tree-id9 . -28) (undo-tree-id10 . -28) (undo-tree-id11 . -28)) nil (26795 15182 349293 0) 0 nil])
([nil nil ((#("
  (when *debug* (format t \"~&[mw] query-parser HIT (before): ~A~%\" (type-of (lumen.core.http:req-query req))))" 0 1 (face font-lock-comment-face fontified t) 1 4 (fontified t) 4 8 (face font-lock-keyword-face fontified t) 8 27 (fontified t) 27 67 (face font-lock-string-face fontified t) 67 111 (fontified t)) . 4195) (undo-tree-id16 . -111) (undo-tree-id17 . -111) (undo-tree-id18 . -111) (undo-tree-id19 . -111) (undo-tree-id20 . -111) (undo-tree-id21 . -111) (undo-tree-id22 . -111) (undo-tree-id23 . -111) (undo-tree-id24 . -111) (undo-tree-id25 . -111) (t 26795 15182 0 0)) nil (26795 16032 486933 0) 0 nil])
([nil nil ((#("
    (when *debug* (format t \"~&[mw] query-parser OUT (after):  ~A~%\" (type-of (lumen.core.http:req-query req))))" 0 6 (fontified t) 6 10 (face font-lock-keyword-face fontified t) 10 29 (fontified t) 29 69 (face font-lock-string-face fontified t) 69 97 (fontified t) 97 113 (fontified t)) . 4341) (undo-tree-id0 . -113) (undo-tree-id1 . -35) (undo-tree-id2 . -35) (undo-tree-id3 . -35) (undo-tree-id4 . -35) (undo-tree-id5 . -35) (undo-tree-id6 . -35) (undo-tree-id7 . -113) (undo-tree-id8 . -113) (undo-tree-id9 . -113) (undo-tree-id10 . -113) (undo-tree-id11 . -113) (undo-tree-id12 . -113) (undo-tree-id13 . -113) (undo-tree-id14 . -113) (undo-tree-id15 . -113)) nil (26795 16032 486922 0) 0 nil])
([nil nil ((17146 . 17147) (t 26795 16032 0 0)) nil (26795 17742 317034 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18015 . 18016) (nil fontified nil 17147 . 18016) (17147 . 18016)) nil (26795 17742 317032 0) 0 nil])
([nil nil ((18016 . 18017)) nil (26795 17742 317029 0) 0 nil])
([nil nil ((17714 . 17715) (#("     " 0 5 (fontified t)) . 17714) (17638 . 17639) (#("                        " 0 24 (fontified t)) . 17638) 17147 (t 26795 17742 0 0)) nil (26795 19013 778072 0) 0 nil])
([nil nil ((12513 . 12515)) nil (26795 19013 778071 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12650 . 12651) (nil fontified nil 12515 . 12651) (12515 . 12651)) nil (26795 19013 778071 0) 0 nil])
([nil nil ((12986 . 12990)) nil (26795 19013 778070 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13007 . 13008) (nil fontified nil 12990 . 13008) (12990 . 13008)) nil (26795 19013 778070 0) 0 nil])
([nil nil ((13532 . 13533)) nil (26795 19013 778069 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13676 . 13677) (nil fontified nil 13533 . 13677) (13533 . 13677)) nil (26795 19013 778068 0) 0 nil])
([nil nil ((13677 . 13679)) nil (26795 19013 778068 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13740 . 13741) (nil fontified nil 13679 . 13741) (13679 . 13741)) nil (26795 19013 778067 0) 0 nil])
([nil nil ((16606 . 16614)) nil (26795 19013 778067 0) 0 nil])
([nil nil ((#("
                            (lumen.core.http:respond-404 \"Directory index disabled\")" 0 1 (fontified t) 1 58 (fontified t) 58 84 (face font-lock-string-face fontified t) 84 85 (fontified t)) . 16614) (undo-tree-id13 . -85)) nil (26795 19013 778066 0) 0 nil])
([nil nil ((16608 . 16615) (#("			    " 0 7 (fontified nil)) . 16607) (undo-tree-id11 . -7) (undo-tree-id12 . -7) (16614 . 16615)) nil (26795 19013 778065 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -16606) (undo-tree-id9 . -1) (undo-tree-id10 . -1) 16607) nil (26795 19013 778063 0) 0 nil])
([nil nil ((16606 . 16614)) nil (26795 19013 778062 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17523 . 17524) (nil fontified nil 16614 . 17524) (16614 . 17524)) nil (26795 19013 778061 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -17522) (undo-tree-id7 . -1) (#(")" 0 1 (rear-nonsticky t fontified t)) . -17523) (undo-tree-id8 . -1) 17524) nil (26795 19013 778060 0) 0 nil])
([nil nil ((#("(t
                            " 0 31 (fontified t)) . -16704) (undo-tree-id6 . -31) 16735) nil (26795 19013 778058 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 16676)) nil (26795 19013 778056 0) 0 nil])
([nil nil ((16704 . 16705) (16676 . 16677)) nil (26795 19013 778055 0) 0 nil])
([nil nil ((#("
			    " 0 1 (fontified t) 1 8 (fontified t)) . -17492) (undo-tree-id5 . -8) 17500) nil (26795 19013 778055 0) 0 nil])
([nil nil ((#("	     " 0 6 (fontified nil)) . -18172) (18172 . 18173) (#("	" 0 1 (fontified nil)) . 18172) (18168 . 18172) (#("    " 0 4 (fontified t)) . -18156) (#(" " 0 1 (fontified t)) . -18114) (#(" " 0 1 (fontified t)) . -18030) (#(" " 0 1 (fontified t)) . -17993) (#("	" 0 1 (fontified nil)) . -17879) (17879 . 17880) (#("	" 0 1 (fontified nil)) . 17879) (17872 . 17879) (#(" " 0 1 (fontified t)) . -17801) (#(" " 0 1 (fontified t)) . -17749) (#(" " 0 1 (fontified t)) . -17668) (#("	" 0 1 (fontified nil)) . -17602) (17602 . 17603) (#("	" 0 1 (fontified nil)) . 17602) (17595 . 17602) (#(" " 0 1 (fontified t)) . -17572) (#(" " 0 1 (fontified t)) . -17519) 12735) nil (26795 19013 778053 0) 0 nil])
([nil nil ((#("(funcall next req)" 0 18 (fontified t)) . -18117) (undo-tree-id4 . -18) 18135) nil (26795 19013 778051 0) 0 nil])
([nil nil ((18117 . 18126) (#(" " 0 1 (fontified nil)) . 18116) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (18117 . 18118)) nil (26795 19013 778050 0) 0 nil])
([nil nil ((18116 . 18126)) nil (26795 19013 778047 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18829 . 18830) (nil fontified nil 18126 . 18830) (18126 . 18830)) nil (26795 19013 778047 0) 0 nil])
([nil nil ((#("
		       " 0 1 (fontified t) 1 10 (fontified t)) . -18830) (undo-tree-id1 . -10) 18840) nil (26795 19013 778046 0) 0 nil])
([nil nil ((19008 . 19009)) nil (26795 19013 778043 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -19008) (undo-tree-id0 . -1) 19009) nil (26795 19013 778040 0) 0 nil])
([nil nil ((423 . 424) (t 26795 19013 0 0)) nil (26795 19979 61678 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 430 . 431) (nil fontified nil 424 . 431) (424 . 431)) nil (26795 19979 61677 0) 0 nil])
([nil nil ((431 . 436)) nil (26795 19979 61672 0) 0 nil])
([nil nil ((19866 . 19867) (t 26795 19979 0 0)) nil (26795 21090 42160 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20772 . 20773) (nil fontified nil 19867 . 20773) (19867 . 20773)) nil (26795 21090 42159 0) 0 nil])
([nil nil ((#("

(defun static-many (&rest mounts)
  \"Monte plusieurs middlewares static en cascade.
MOUNTS est une liste de specs, chacune Ã©tant:
  - une PLIST de paramÃ¨tres pour (static ...) (ex: '(:prefix \\\"/public\\\" :dir #P\\\"./public/\\\"))
  - OU directement un middleware (static :prefix ... :dir ...).

PrioritÃ©: l'ordre donnÃ©. Chaque static essaie â†’ sinon passe au suivant â†’ sinon NEXT.\"
  (let* ((mws
           (mapcar (lambda (m)
                     (etypecase m
                       (function m)	; dÃ©jÃ  un middleware
                       (list     (apply #'static m)))) ; spec plist â†’ construire
                   mounts)))
    (lambda (next)
      ;; on enrobe NEXT par les statics du dernier au premier (classique)
      (reduce (lambda (n mw) (funcall mw n))
              mws
              :from-end t
              :initial-value next))))" 0 2 (fontified t) 2 3 (fontified t) 3 8 (fontified t face font-lock-keyword-face) 8 9 (fontified t) 9 20 (fontified t face font-lock-function-name-face) 20 22 (fontified t) 22 27 (face font-lock-type-face fontified t) 27 38 (fontified t) 38 378 (face font-lock-doc-face fontified t) 378 382 (fontified t) 382 386 (face font-lock-keyword-face fontified t) 386 413 (fontified t) 413 419 (face font-lock-keyword-face fontified t) 419 446 (fontified t) 446 455 (face font-lock-keyword-face fontified t) 455 494 (fontified t) 494 515 (face font-lock-comment-face fontified t) 515 570 (fontified t) 570 596 (face font-lock-comment-face fontified t) 596 630 (fontified t) 630 636 (face font-lock-keyword-face fontified t) 636 650 (fontified t) 650 653 (face font-lock-comment-delimiter-face fontified t) 653 718 (face font-lock-comment-face fontified t) 718 733 (fontified t) 733 739 (face font-lock-keyword-face fontified t) 739 795 (fontified t) 795 804 (face font-lock-builtin-face fontified t) 804 821 (fontified t) 821 835 (face font-lock-builtin-face fontified t) 835 844 (fontified t)) . 19021) (undo-tree-id0 . -844) (undo-tree-id1 . -20) (undo-tree-id2 . -844) (undo-tree-id3 . -844)) nil (26795 21090 42157 0) 0 nil])
([nil nil ((19929 . 19930) 19021) nil (26795 21090 42135 0) 0 nil])
([nil nil ((19930 . 19931) (t 26795 21090 0 0)) nil (26796 29881 522111 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22901 . 22902) (nil fontified nil 19931 . 22902) (19931 . 22902)) nil (26796 29881 522110 0) 0 nil])
([nil nil ((22902 . 22903)) nil (26796 29881 522105 0) 0 nil])
([nil nil ((436 . 441) (t 26796 29881 0 0)) nil (26796 30136 982320 0) 0 nil])
([nil nil ((441 . 442)) nil (26796 30136 982319 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -441) (undo-tree-id12 . -1) 442) nil (26796 30136 982319 0) 0 nil])
([nil nil ((441 . 443)) nil (26796 30136 982318 0) 0 nil])
([nil nil ((443 . 444)) nil (26796 30136 982317 0) 0 nil])
([nil nil ((444 . 451)) nil (26796 30136 982316 0) 0 nil])
([nil nil ((451 . 456)) nil (26796 30136 982316 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 465 . 466) (nil fontified nil 456 . 466) (456 . 466)) nil (26796 30136 982315 0) 0 nil])
([nil nil ((456 . 457)) nil (26796 30136 982315 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -456) (undo-tree-id11 . -1) 457) nil (26796 30136 982313 0) 0 nil])
([nil nil ((456 . 457)) nil (26796 30136 982311 0) 0 nil])
([nil nil ((467 . 468)) nil (26796 30136 982309 0) 0 nil])
([nil nil ((436 . 441)) nil (26796 30136 982308 0) 0 nil])
([nil nil ((441 . 443)) nil (26796 30136 982308 0) 0 nil])
([nil nil ((443 . 444)) nil (26796 30136 982305 0) 0 nil])
([nil nil ((444 . 446)) nil (26796 30136 982304 0) 0 nil])
([nil nil ((#("o" 0 1 (face font-lock-comment-face fontified t)) . -445) (undo-tree-id10 . -1) 446) nil (26796 30136 982303 0) 0 nil])
([nil nil ((445 . 450)) nil (26796 30136 982300 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-comment-face fontified t)) . -447) (undo-tree-id7 . -1) (#("e" 0 1 (face font-lock-comment-face fontified t)) . -448) (undo-tree-id8 . -1) (#("r" 0 1 (face font-lock-comment-face fontified t)) . -449) (undo-tree-id9 . -1) 450) nil (26796 30136 982299 0) 0 nil])
([nil nil ((447 . 450)) nil (26796 30136 982294 0) 0 nil])
([nil nil ((450 . 451)) nil (26796 30136 982293 0) 0 nil])
([nil nil ((451 . 459)) nil (26796 30136 982293 0) 0 nil])
([nil nil ((459 . 464)) nil (26796 30136 982292 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 478 . 479) (nil fontified nil 464 . 479) (464 . 479)) nil (26796 30136 982291 0) 0 nil])
([nil nil ((464 . 466)) nil (26796 30136 982290 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -465) (undo-tree-id6 . -1) 466) nil (26796 30136 982290 0) 0 nil])
([nil nil ((512 . 513)) nil (26796 30136 982288 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -512) (undo-tree-id5 . -1) 513) nil (26796 30136 982287 0) 0 nil])
([nil nil ((512 . 513)) nil (26796 30136 982285 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 523 . 524) (nil fontified nil 513 . 524) (513 . 524)) nil (26796 30136 982285 0) 0 nil])
([nil nil ((524 . 525)) nil (26796 30136 982284 0) 0 nil])
([nil nil ((525 . 532)) nil (26796 30136 982283 0) 0 nil])
([nil nil ((532 . 533)) nil (26796 30136 982282 0) 0 nil])
([nil nil ((533 . 534)) nil (26796 30136 982282 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 547 . 548) (nil fontified nil 534 . 548) (534 . 548)) nil (26796 30136 982281 0) 0 nil])
([nil nil ((480 . 483) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -463) (463 . 464) (#("	" 0 1 (fontified nil)) . 463) (460 . 463) (480 . 481)) nil (26796 30136 982280 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 492 . 493) (nil fontified nil 486 . 493) (nil fontified nil 483 . 486) (483 . 493)) nil (26796 30136 982278 0) 0 nil])
([nil nil ((#("Cookies" 0 6 (face font-lock-comment-face fontified t) 6 7 (face font-lock-comment-face rear-nonsticky t fontified t)) . 486)) nil (26796 30136 982277 0) 0 nil])
([nil nil ((486 . 494)) nil (26796 30136 982277 0) 0 nil])
([nil nil ((494 . 498)) nil (26796 30136 982276 0) 0 nil])
([nil nil ((498 . 508)) nil (26796 30136 982276 0) 0 nil])
([nil nil ((508 . 515)) nil (26796 30136 982275 0) 0 nil])
([nil nil ((#("
   ;; Redirect
   :respond-redirect" 0 1 (fontified t) 1 4 (fontified t) 4 7 (face font-lock-comment-delimiter-face fontified t) 7 16 (face font-lock-comment-face fontified t) 16 19 (fontified t) 19 36 (face font-lock-builtin-face fontified t)) . 479) (undo-tree-id4 . -36)) nil (26796 30136 982271 0) 0 nil])
([nil nil ((#("core" 0 4 (fontified t)) . -22881) (undo-tree-id13 . -4) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -4) (undo-tree-id20 . -4) (undo-tree-id21 . -4) (undo-tree-id22 . -4) 22885 (t 26796 30136 0 0)) nil (26796 30260 107670 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . 22881)) nil (26796 30260 107653 0) 0 nil])
([nil nil ((22885 . 22886)) nil (26796 30260 107649 0) 0 nil])
([nil nil ((479 . 480) (t 26796 30260 0 0)) nil (26796 30335 324996 0) 0 nil])
([nil nil ((480 . 494)) nil (26796 30335 324992 0) 0 nil])
([nil nil ((21006 . 21008) (t 26796 30335 0 0)) nil (26796 31779 344713 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21215 . 21216) (nil fontified nil 21008 . 21216) (21008 . 21216)) nil (26796 31779 344709 0) 0 nil])
([nil nil ((#("

(defun set-cookie! (resp name value &rest opts)
  \"Ajoute un header Set-Cookie formatÃ© Ã  la rÃ©ponse.\"
  (apply #'lumen.core.http:add-set-cookie
         resp
         (lumen.core.http:format-set-cookie name value
                                            ;; transfÃ¨re les :keys passÃ©es
                                            (loop for (k v) on opts by #'cddr append (list k v)))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 20 (face font-lock-function-name-face fontified t) 20 38 (fontified t) 38 43 (face font-lock-type-face fontified t) 43 52 (fontified t) 52 103 (face font-lock-doc-face fontified t) 103 259 (fontified t) 259 262 (face font-lock-comment-delimiter-face fontified t) 262 290 (face font-lock-comment-face fontified t) 290 335 (fontified t) 335 339 (face font-lock-keyword-face fontified t) 339 389 (fontified t)) . 20617) (undo-tree-id23 . -389) (undo-tree-id24 . -214) (undo-tree-id25 . -169) (undo-tree-id26 . -323) (undo-tree-id27 . -323) (undo-tree-id28 . -323) (undo-tree-id29 . -323) (undo-tree-id30 . -251) (undo-tree-id31 . -251) (undo-tree-id32 . -251) (undo-tree-id33 . -251) (undo-tree-id34 . -251) (undo-tree-id35 . -251) (undo-tree-id36 . -389) (undo-tree-id37 . -389) (undo-tree-id38 . -389) (undo-tree-id39 . -323) (undo-tree-id40 . -389) (t 26796 31779 0 0)) nil (26796 31799 215862 0) 0 nil])
([nil nil ((22846 . 22847) (t 26796 31799 0 0)) nil (26796 37597 321812 0) 0 nil])
([nil nil ((22847 . 22849)) nil (26796 37597 321812 0) 0 nil])
([nil nil ((22849 . 22850)) nil (26796 37597 321811 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-delimiter-face fontified nil)) . 22849) (undo-tree-id47 . -1) (22850 . 22851)) nil (26796 37597 321811 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24311 . 24312) (nil fontified nil 22850 . 24312) (22850 . 24312)) nil (26796 37597 321810 0) 0 nil])
([nil nil ((22849 . 22850)) nil (26796 37597 321809 0) 0 nil])
([nil nil ((22850 . 22854)) nil (26796 37597 321809 0) 0 nil])
([nil nil ((22854 . 22855)) nil (26796 37597 321809 0) 0 nil])
([nil nil ((22855 . 22861)) nil (26796 37597 321808 0) 0 nil])
([nil nil ((167 . 168)) nil (26796 37597 321808 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 185 . 186) (nil fontified nil 178 . 186) (nil fontified nil 177 . 178) (nil fontified nil 176 . 177) (nil fontified nil 175 . 176) (nil fontified nil 169 . 175) (nil fontified nil 168 . 169) (168 . 186)) nil (26796 37597 321807 0) 0 nil])
([nil nil ((#("setf (getf (lumen.core.http:req-ctx" 0 35 (fontified t)) . -23388) (undo-tree-id46 . -35) 23423) nil (26796 37597 321806 0) 0 nil])
([nil nil ((23388 . 23396)) nil (26796 37597 321805 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23403 . 23404) (nil fontified nil 23388 . 23404) (23388 . 23404)) nil (26796 37597 321804 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -23416) (undo-tree-id45 . -1) 23417) nil (26796 37597 321804 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -23422) (undo-tree-id44 . -1) 23423) nil (26796 37597 321803 0) 0 nil])
([nil nil ((23423 . 23427) (#("            " 0 12 (fontified t)) . 23423) 22881) nil (26796 37597 321801 0) 0 nil])
([nil nil ((23461 . 23466) (#(" " 0 1 (fontified nil)) . 23461) (23460 . 23461)) nil (26796 37597 321801 0) 0 nil])
([nil nil ((23536 . 23538)) nil (26796 37597 321800 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24224 . 24225) (nil fontified nil 23538 . 24225) (23538 . 24225)) nil (26796 37597 321800 0) 0 nil])
([nil nil ((23584 . 23587)) nil (26796 37597 321799 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23642 . 23643) (nil fontified nil 23587 . 23643) (23587 . 23643)) nil (26796 37597 321799 0) 0 nil])
([nil nil ((#("

(define-middleware multipart-parser (req next)
  \"Parse multipart/form-data â†’ ctx[:files], ctx[:fields].\"
  (let* ((headers (lumen.core.http:req-headers req))
         (ct      (cdr (assoc \"content-type\" headers :test #'string-equal)))
         (len     (cdr (assoc \"content-length\" headers :test #'string-equal)))
         (len*    (when len (parse-integer len :junk-allowed t))))
    (when (and ct len* (> len* 0)
               (search \"multipart/form-data\" (string-downcase ct)))
      (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
        (when res
          (setf (getf (lumen.core.http:req-ctx req) :fields) (getf res :fields))
          (setf (getf (lumen.core.http:req-ctx req) :files)  (getf res :files)))))
    (funcall next req)))" 0 1 (fontified t) 1 3 (fontified t) 3 20 (face font-lock-keyword-face fontified t) 20 51 (fontified t) 51 107 (face font-lock-string-face fontified t) 107 111 (fontified t) 111 115 (face font-lock-keyword-face fontified t) 115 191 (fontified t) 191 205 (face font-lock-string-face fontified t) 205 214 (fontified t) 214 219 (face font-lock-builtin-face fontified t) 219 268 (fontified t) 268 284 (face font-lock-string-face fontified t) 284 293 (fontified t) 293 298 (face font-lock-builtin-face fontified t) 298 336 (fontified t) 336 340 (face font-lock-keyword-face fontified t) 340 364 (fontified t) 364 377 (face font-lock-builtin-face fontified t) 377 389 (fontified t) 389 393 (face font-lock-keyword-face fontified t) 393 441 (fontified t) 441 462 (face font-lock-string-face fontified t) 462 493 (fontified t) 493 496 (face font-lock-keyword-face fontified t) 496 594 (fontified t) 594 598 (face font-lock-keyword-face fontified t) 598 655 (fontified t) 655 662 (face font-lock-builtin-face fontified t) 662 674 (fontified t) 674 681 (face font-lock-builtin-face fontified t) 681 736 (fontified t) 736 742 (face font-lock-builtin-face fontified t) 742 755 (fontified t) 755 761 (face font-lock-builtin-face fontified t) 761 790 (fontified t) 790 791 (fontified t rear-nonsticky t)) . 24284) (undo-tree-id43 . -791)) nil (26796 37597 321798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22619 . 22620) (nil fontified nil 22574 . 22620) (22574 . 22620)) nil (26796 37597 321797 0) 0 nil])
([nil nil ((#("(setf (getf " 0 12 (fontified t)) . 22620)) nil (26796 37597 321796 0) 0 nil])
([nil nil ((#("(lumen.core.http:req-ctx " 0 19 (fontified t) 19 25 (fontified t)) . 22620) (undo-tree-id42 . -25)) nil (26796 37597 321796 0) 0 nil])
([nil nil ((#("req) :request-id) rid)" 0 5 (fontified t) 5 16 (help-echo "Easy to misread; consider moving the element to the next line" face (font-lock-warning-face font-lock-builtin-face) fontified t) 16 18 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t) 18 22 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . 22620) (undo-tree-id41 . -22)) nil (26796 37597 321794 0) 0 nil])
([nil nil ((158 . 160) (156 . 157)) nil (26796 37597 321784 0) 0 nil])
([nil nil ((24274 . 24275) 160) nil (26796 37597 321781 0) 0 nil])
([nil nil ((#("set-ctx" 0 6 (fontified t) 6 7 (fontified t)) . -23394) (undo-tree-id60 . -7) 23401 (t 26796 37597 0 0)) nil (26796 37702 6734 0) 0 nil])
([nil nil ((23394 . 23399)) nil (26796 37702 6732 0) 0 nil])
([nil nil ((23378 . 23402) (#("lumen.core.http:ctx-s!" 0 15 (fontified t) 15 16 (fontified t rear-nonsticky t) 16 21 (fontified t) 21 22 (fontified t)) . 23378) (undo-tree-id48 . -16) (undo-tree-id49 . -21) (undo-tree-id50 . -16) (undo-tree-id51 . -19) (undo-tree-id52 . -19) (undo-tree-id53 . -19) (undo-tree-id54 . -19) (undo-tree-id55 . -19) (undo-tree-id56 . -20) (undo-tree-id57 . -20) (undo-tree-id58 . -21) (undo-tree-id59 . -21) 23399) nil (26796 37702 6729 0) 0 nil])
([nil nil ((258 . 261) (t 26796 37701 0 0)) nil (26796 37877 739090 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 325 . 326) (nil fontified nil 325 . 326) (nil fontified nil 311 . 325) (nil fontified nil 310 . 311) (nil fontified nil 297 . 310) (nil fontified nil 296 . 297) (nil fontified nil 292 . 296) (nil fontified nil 291 . 292) (nil fontified nil 288 . 291) (nil fontified nil 287 . 288) (nil fontified nil 275 . 287) (nil fontified nil 274 . 275) (nil fontified nil 262 . 274) (nil fontified nil 261 . 262) (261 . 326)) nil (26796 37877 739089 0) 0 nil])
([nil nil ((#("utils" 0 5 (face font-lock-builtin-face fontified t)) . -282) (undo-tree-id66 . -5) 287) nil (26796 37877 739088 0) 0 nil])
([nil nil ((282 . 291)) nil (26796 37877 739086 0) 0 nil])
([nil nil ((#("-> :->> :str-prefix-p :ensure-header" 0 2 (face font-lock-builtin-face fontified t) 2 3 (fontified t) 3 7 (face font-lock-builtin-face fontified t) 7 8 (fontified t) 8 21 (face font-lock-builtin-face fontified t) 21 22 (fontified t) 22 36 (face font-lock-builtin-face fontified t)) . -293) (undo-tree-id65 . -36) 329) nil (26796 37877 739086 0) 0 nil])
([nil nil ((293 . 297)) nil (26796 37877 739084 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-builtin-face fontified t)) . -293) (undo-tree-id61 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -294) (undo-tree-id62 . -1) (#("l" 0 1 (face font-lock-builtin-face fontified t)) . -295) (undo-tree-id63 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -296) (undo-tree-id64 . -1) 297) nil (26796 37877 739082 0) 0 nil])
([nil nil ((293 . 309)) nil (26796 37877 739067 0) 0 nil])
([nil nil ((24327 . 24328) (t 26796 37877 0 0)) nil (26796 39883 441238 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28742 . 28743) (nil fontified nil 24328 . 28743) (24328 . 28743)) nil (26796 39883 441237 0) 0 nil])
([nil nil ((#("

;;; ---------------- Middleware ---------------" 0 2 (fontified t) 2 6 (face font-lock-comment-delimiter-face fontified t) 6 49 (face font-lock-comment-face fontified t)) . 26117) (undo-tree-id4 . -49)) nil (26796 39883 441237 0) 0 nil])
([nil nil ((#("helpers" 0 7 (face font-lock-comment-face fontified t)) . -24354) (undo-tree-id3 . -7) 24361) nil (26796 39883 441236 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -24353) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 24354) nil (26796 39883 441234 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 24370)) nil (26796 39883 441232 0) 0 nil])
([nil nil ((#("
(defun method-get-or-head-p (req)
  (let ((m (slot-value req 'lumen.core.http::method)))
    (or (string= m \"GET\") (string= m \"HEAD\"))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 38 (fontified t) 38 41 (face font-lock-keyword-face fontified t) 41 90 (fontified t) 90 109 (fontified t) 109 114 (face font-lock-string-face fontified t) 114 127 (fontified t) 127 133 (face font-lock-string-face fontified t) 133 137 (fontified t)) . 25971) (undo-tree-id0 . -137)) nil (26796 39883 441231 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 25971)) nil (26796 39883 441217 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -28167) (28182 . 28193)) nil (26796 39883 441217 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -26981) (26996 . 27007) (#("lumen.core.util" 0 15 (fontified t)) . -26748) (26763 . 26774)) nil (26796 39883 441216 0) 0 nil])
([nil nil ((27037 . 27045) (#(" " 0 1 (fontified nil)) . 27037) (27036 . 27037)) nil (26796 39883 441215 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 27050)) nil (26796 39883 441214 0) 0 nil])
([nil nil ((#("    " 0 4 (fontified nil)) . -27107) (27050 . 27051)) nil (26796 39883 441214 0) 0 nil])
([nil nil ((27123 . 27130) (#(" " 0 1 (fontified nil)) . 27123) (27122 . 27123)) nil (26796 39883 441213 0) 0 nil])
([nil nil ((636 . 639) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -587) (587 . 588) (#("	" 0 1 (fontified nil)) . 587) (584 . 587) (636 . 637)) nil (26796 39883 441212 0) 0 nil])
([nil nil ((639 . 641)) nil (26796 39883 441211 0) 0 nil])
([nil nil ((641 . 642)) nil (26796 39883 441210 0) 0 nil])
([nil nil ((642 . 646)) nil (26796 39883 441210 0) 0 nil])
([nil nil ((646 . 650)) nil (26796 39883 441210 0) 0 nil])
([nil nil ((650 . 651)) nil (26796 39883 441209 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 654 . 655) (nil fontified nil 651 . 655) (651 . 655)) nil (26796 39883 441208 0) 0 nil])
([nil nil ((28565 . 28566)) nil (26796 39883 441204 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27758) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 27759 (t 26796 39883 0 0)) nil (26796 39934 279584 0) 0 nil])
([nil nil ((27758 . 27760)) nil (26796 39934 279581 0) 0 nil])
([nil nil ((#("x" 0 1 (fontified t)) . -27759) (undo-tree-id18 . -1) 27760) nil (26796 39934 279581 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27770) (undo-tree-id17 . -1) 27771) nil (26796 39934 279579 0) 0 nil])
([nil nil ((27770 . 27771)) nil (26796 39934 279578 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27885) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 27886) nil (26796 39934 279577 0) 0 nil])
([nil nil ((27885 . 27886)) nil (26796 39934 279566 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27903) (undo-tree-id5 . -1) 27904) nil (26796 39934 279564 0) 0 nil])
([nil nil ((27903 . 27904)) nil (26796 39934 279551 0) 0 nil])
([nil nil ((25520 . 25522) (t 26796 39934 0 0)) nil (26796 40128 551415 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25796 . 25797) (nil fontified nil 25522 . 25797) (25522 . 25797)) nil (26796 40128 551414 0) 0 nil])
([nil nil ((#("
(defun %parse-if-none-match (h)
  \"Retourne une liste de tags (strings) tels que reÃ§us, ex: (\\\"W/\\\\\\\"SIG\\\\\\\"\\\" \\\"\\\\\\\"SIG2\\\\\\\"\\\")\"
  (when (and h (plusp (length h)))
    (mapcar #'string-trim
            (uiop:split-string h :separator \",\"))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 35 (fontified t) 35 130 (face font-lock-doc-face fontified t) 130 134 (fontified t) 134 138 (face font-lock-keyword-face fontified t) 138 192 (fontified t) 192 225 (fontified t) 225 235 (face font-lock-builtin-face fontified t) 235 236 (fontified t) 236 239 (face font-lock-string-face fontified t) 239 244 (fontified t)) . 25277) (undo-tree-id22 . -244) (undo-tree-id23 . -13) (undo-tree-id24 . -13) (undo-tree-id25 . -13) (undo-tree-id26 . -13) (undo-tree-id27 . -9) (undo-tree-id28 . -14) (undo-tree-id29 . -14) (undo-tree-id30 . -180) (undo-tree-id31 . -9) (undo-tree-id32 . -14) (undo-tree-id33 . -14) (undo-tree-id34 . -14) (undo-tree-id35 . -14) (undo-tree-id36 . -14) (undo-tree-id37 . -14) (undo-tree-id38 . -14) (undo-tree-id39 . -14) (undo-tree-id40 . -14) (undo-tree-id41 . -14) (undo-tree-id42 . -14) (undo-tree-id43 . -8) (undo-tree-id44 . -28) (undo-tree-id45 . -28) (undo-tree-id46 . -9) (undo-tree-id47 . -8) (undo-tree-id48 . -28) (undo-tree-id49 . -28) (undo-tree-id50 . -28) (undo-tree-id51 . -28) (undo-tree-id52 . -191) (undo-tree-id53 . -191) (undo-tree-id54 . -191) (undo-tree-id55 . -191) (undo-tree-id56 . -191) (undo-tree-id57 . -191) (undo-tree-id58 . -191) (undo-tree-id59 . -191) (undo-tree-id60 . -191) (undo-tree-id61 . -243) (undo-tree-id62 . -243) (undo-tree-id63 . -243) (undo-tree-id64 . -243) (undo-tree-id65 . -243) (undo-tree-id66 . 1) (undo-tree-id67 . -244) (undo-tree-id68 . -1) (undo-tree-id69 . -192) (undo-tree-id70 . -244) (undo-tree-id71 . -244) (undo-tree-id72 . -244) (undo-tree-id73 . -8) (undo-tree-id74 . -244) (undo-tree-id75 . -244) (undo-tree-id76 . -244) (undo-tree-id77 . -244)) nil (26796 40128 551410 0) 0 nil])
([nil nil ((23571 . 23578) (t 26796 40128 0 0)) nil (26796 44274 853560 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23624 . 23625) (nil fontified nil 23578 . 23625) (23578 . 23625)) nil (26796 44274 853560 0) 0 nil])
([nil nil ((24373 . 24377)) nil (26796 44274 853559 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24423 . 24424) (nil fontified nil 24377 . 24424) (24377 . 24424)) nil (26796 44274 853559 0) 0 nil])
([nil nil ((28704 . 28705)) nil (26796 44274 853558 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33886 . 33887) (nil fontified nil 28705 . 33887) (28705 . 33887)) nil (26796 44274 853557 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -30605) (undo-tree-id85 . -1) 30606) nil (26796 44274 853557 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -28766) (undo-tree-id84 . -1) 28767) nil (26796 44274 853556 0) 0 nil])
([nil nil ((30169 . 30170) (30133 . 30134) (30101 . 30102) (30017 . 30018) (29946 . 29954) (#("                                                               " 0 63 (fontified t)) . 29946) (29910 . 29911) (29818 . 29819) (29747 . 29748) (29555 . 29556) (29458 . 29459) (29396 . 29397) (29328 . 29329) (29211 . 29212) (29157 . 29158) (29080 . 29081) (29035 . 29036) 28767) nil (26796 44274 853554 0) 0 nil])
([nil nil ((29044 . 29051) (#(" " 0 1 (fontified nil)) . 29043) (undo-tree-id83 . -1) (29044 . 29045)) nil (26796 44274 853552 0) 0 nil])
([nil nil ((#("       " 0 7 (fontified t)) . -30072) (#("       " 0 7 (fontified t)) . -30043) (#("       " 0 7 (fontified t)) . -30018) (#("       " 0 7 (fontified t)) . -29941) (#("	" 0 1 (fontified nil)) . -29884) (29884 . 29885) (#("	" 0 1 (fontified nil)) . 29884) (29883 . 29884) (#("       " 0 7 (fontified t)) . -29841) (#("       " 0 7 (fontified t)) . -29756) (#("       " 0 7 (fontified t)) . -29692) (#("       " 0 7 (fontified t)) . -29625) (#("       " 0 7 (fontified t)) . -29514) (#("       " 0 7 (fontified t)) . -29424) (#("       " 0 7 (fontified t)) . -29369) (#("       " 0 7 (fontified t)) . -29308) (#("       " 0 7 (fontified t)) . -29198) (#("       " 0 7 (fontified t)) . -29151) (#("       " 0 7 (fontified t)) . -29081) 28767) nil (26796 44274 853550 0) 0 nil])
([nil nil ((29220 . 29228) (#(" " 0 1 (fontified nil)) . 29219) (undo-tree-id82 . -1) (29220 . 29221)) nil (26796 44274 853548 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -32426) (undo-tree-id78 . -1) (#(" " 0 1 (fontified t)) . -32427) (undo-tree-id79 . -1) (#(" " 0 1 (fontified t)) . -32428) (undo-tree-id80 . -1) (#(" " 0 1 (fontified t)) . -32429) (undo-tree-id81 . -1) 32430) nil (26796 44274 853546 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -33517) (33532 . 33543) (#("lumen.core.util" 0 15 (fontified t)) . -33432) (33447 . 33458) (#("lumen.core.util" 0 15 (fontified t)) . -32220) (32235 . 32246)) nil (26796 44274 853533 0) 0 nil])
([nil nil ((33739 . 33740) 33528) nil (26796 44274 853529 0) 0 nil])
([nil nil ((131 . 141) (t 26796 44274 0 0)) nil (26796 44345 891161 0) 0 nil])
([nil nil ((141 . 142)) nil (26796 44345 891160 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -131) (undo-tree-id106 . -1) 132) nil (26796 44345 891160 0) 0 nil])
([nil nil ((131 . 132)) nil (26796 44345 891159 0) 0 nil])
([nil nil ((141 . 142)) nil (26796 44345 891158 0) 0 nil])
([nil nil ((142 . 151)) nil (26796 44345 891158 0) 0 nil])
([nil nil ((#("t" 0 1 (face font-lock-builtin-face fontified t)) . -150) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) 151) nil (26796 44345 891157 0) 0 nil])
([nil nil ((150 . 151)) nil (26796 44345 891155 0) 0 nil])
([nil nil ((#("a" 0 1 (face font-lock-builtin-face fontified t)) . -149) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (#("t" 0 1 (face font-lock-builtin-face fontified t)) . -150) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) 151) nil (26796 44345 891154 0) 0 nil])
([nil nil ((149 . 153)) nil (26796 44345 891147 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-builtin-face fontified t)) . -152) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) 153) nil (26796 44345 891145 0) 0 nil])
([nil nil ((152 . 154)) nil (26796 44345 891128 0) 0 nil])
([nil nil ((156 . 158) (154 . 155) (t 26796 44345 0 0)) nil (26796 44355 17387 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -183) (undo-tree-id107 . -3) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -3) (undo-tree-id111 . -3) (undo-tree-id112 . -3) (undo-tree-id113 . -3) (undo-tree-id114 . -3) (undo-tree-id115 . -3) 186) nil (26796 44355 17383 0) 0 nil])
([nil nil ((30939 . 30946) (t 26796 44355 0 0)) nil (26796 45302 256911 0) 0 nil])
([nil nil ((30946 . 30947)) nil (26796 45302 256910 0) 0 nil])
([nil nil ((30247 . 30249)) nil (26796 45302 256909 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31690 . 31691) (nil fontified nil 30249 . 31691) (30249 . 31691)) nil (26796 45302 256909 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -31690) (undo-tree-id117 . -1) 31691) nil (26796 45302 256908 0) 0 nil])
([nil nil ((31594 . 31596)) nil (26796 45302 256906 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31619 . 31620) (nil fontified nil 31599 . 31620) (nil fontified nil 31596 . 31599) (31596 . 31620)) nil (26796 45302 256905 0) 0 nil])
([nil nil ((#("
(defun %parse-accept-encoding (h)
  \"Retourne une alist '( (\\\"gzip\\\" . q) (\\\"deflate\\\" . q) ... ) triÃ©e par q desc.
   Si header manquant â†’ NIL.\"
  (when (and h (plusp (length h)))
    (let* ((tokens (uiop:split-string h :separator \",\"))
           (pairs
             (mapcar
	      (lambda (tok)
                (let* ((t1 (string-trim '(#\\Space #\\Tab) tok))
                       (pos (position #\\; t1))
                       (enc (string-downcase
			     (string-trim '(#\\Space #\\Tab)
                                                          (subseq t1 0 (or pos (length t1))))))
                       (q   (if (and pos
                                     (let* ((p2 (position #\\= t1 :start (1+ pos)))
                                            (k  (and p2 (string-trim '(#\\Space #\\Tab)
                                                                     (subseq t1 (1+ pos) p2)))))
                                       (and p2 (string-equal k \"q\"))))
                                (let* ((p2 (position #\\= t1 :start (1+ pos)))
                                       (raw (string-trim '(#\\Space #\\Tab)
							 (subseq t1 (1+ p2)))))
                                  (or (ignore-errors (parse-number raw)) 0.0))
                                1.0)))
                  (cons enc q)))
              tokens)))
      ;; filtre q=0, trie desc
      (sort (remove-if (lambda (c) (<= (cdr c) 0.0)) pairs)
            #'>
            :key #'cdr))))
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 30 (face font-lock-function-name-face fontified t) 30 37 (fontified t) 37 146 (face font-lock-doc-face fontified t) 146 150 (fontified t) 150 154 (face font-lock-keyword-face fontified t) 154 187 (fontified t) 187 191 (face font-lock-keyword-face fontified t) 191 222 (fontified t) 222 232 (face font-lock-builtin-face fontified t) 232 233 (fontified t) 233 236 (face font-lock-string-face fontified t) 236 257 (fontified t) 257 286 (fontified t) 286 292 (face font-lock-keyword-face fontified t) 292 299 (fontified t) 299 316 (fontified t) 316 320 (face font-lock-keyword-face fontified t) 320 362 (fontified t) 362 409 (fontified t) 409 492 (fontified t) 492 588 (fontified t) 588 617 (fontified t) 617 619 (face font-lock-keyword-face fontified t) 619 629 (fontified t) 629 667 (fontified t) 667 671 (face font-lock-keyword-face fontified t) 671 694 (fontified t) 694 700 (face font-lock-builtin-face fontified t) 700 712 (fontified t) 712 798 (fontified t) 798 895 (fontified t) 895 958 (fontified t) 958 961 (face font-lock-string-face fontified t) 961 966 (fontified t) 966 999 (fontified t) 999 1003 (face font-lock-keyword-face fontified t) 1003 1026 (fontified t) 1026 1032 (face font-lock-builtin-face fontified t) 1032 1044 (fontified t) 1044 1118 (fontified t) 1118 1126 (fontified t) 1126 1149 (fontified t) 1149 1188 (fontified t) 1188 1201 (face font-lock-keyword-face fontified t) 1201 1228 (fontified t) 1228 1267 (fontified t) 1267 1300 (fontified t) 1300 1314 (fontified t) 1314 1324 (fontified t) 1324 1330 (fontified t) 1330 1333 (face font-lock-comment-delimiter-face fontified t) 1333 1355 (face font-lock-comment-face fontified t) 1355 1371 (fontified t) 1371 1379 (fontified t) 1379 1385 (face font-lock-keyword-face fontified t) 1385 1415 (fontified t) 1415 1431 (fontified t) 1431 1443 (fontified t) 1443 1447 (face font-lock-builtin-face fontified t) 1447 1458 (fontified t)) . 28790) (undo-tree-id116 . -1458)) nil (26796 45302 256904 0) 0 nil])
([nil nil ((33343 . 33351)) nil (26796 45302 256894 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33369 . 33370) (nil fontified nil 33351 . 33370) (33351 . 33370)) nil (26796 45302 256893 0) 0 nil])
([nil nil ((33370 . 33371)) nil (26796 45302 256893 0) 0 nil])
([nil nil ((33370 . 33371)) nil (26796 45302 256892 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33377 . 33378) (nil fontified nil 33371 . 33378) (33371 . 33378)) nil (26796 45302 256892 0) 0 nil])
([nil nil ((33718 . 33726)) nil (26796 45302 256890 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33797 . 33798) (nil fontified nil 33726 . 33798) (33726 . 33798)) nil (26796 45302 256882 0) 0 nil])
([nil nil ((679 . 683) (t 26796 45302 0 0)) nil (26796 45337 48225 0) 0 nil])
([nil nil ((683 . 685)) nil (26796 45337 48224 0) 0 nil])
([nil nil ((685 . 686)) nil (26796 45337 48224 0) 0 nil])
([nil nil ((686 . 697)) nil (26796 45337 48223 0) 0 nil])
([nil nil ((697 . 701)) nil (26796 45337 48223 0) 0 nil])
([nil nil ((701 . 703)) nil (26796 45337 48222 0) 0 nil])
([nil nil ((#("c" 0 1 (fontified t)) . -701) (undo-tree-id118 . -1) (#("o" 0 1 (fontified t)) . -702) (undo-tree-id119 . -1) 703) nil (26796 45337 48221 0) 0 nil])
([nil nil ((701 . 710)) nil (26796 45337 48207 0) 0 nil])
([nil nil ((710 . 713)) nil (26796 45337 48203 0) 0 nil])
([nil nil ((30499 . 30501) (t 26796 45337 0 0)) nil (26796 45939 30359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 30934 . 30935) (nil fontified nil 30501 . 30935) (30501 . 30935)) nil (26796 45939 30358 0) 0 nil])
([nil nil ((31570 . 31572)) nil (26796 45939 30357 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 32081 . 32082) (nil fontified nil 31572 . 32082) (31572 . 32082)) nil (26796 45939 30356 0) 0 nil])
([nil nil ((#("GZIP" 0 4 (face font-lock-comment-face fontified t)) . -30958) (undo-tree-id125 . -4) 30962) nil (26796 45939 30355 0) 0 nil])
([nil nil ((30958 . 30969)) nil (26796 45939 30354 0) 0 nil])
([nil nil ((33819 . 33826)) nil (26796 45939 30353 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 34126 . 34127) (nil fontified nil 33826 . 34127) (33826 . 34127)) nil (26796 45939 30352 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 34748 . 34749) (nil fontified nil 34542 . 34749) (34542 . 34749)) nil (26796 45939 30351 0) 0 nil])
([nil nil ((34749 . 34755)) nil (26796 45939 30350 0) 0 nil])
([nil nil ((34755 . 34757)) nil (26796 45939 30349 0) 0 nil])
([nil nil ((#("\"gzip\"" 0 6 (face font-lock-string-face fontified t)) . -35068) (undo-tree-id124 . -6) 35074) nil (26796 45939 30348 0) 0 nil])
([nil nil ((35068 . 35074)) nil (26796 45939 30346 0) 0 nil])
([nil nil ((#("gz" 0 2 (fontified t)) . -35176) (undo-tree-id123 . -2) 35178) nil (26796 45939 30345 0) 0 nil])
([nil nil ((35176 . 35179)) nil (26796 45939 30343 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -35178) (undo-tree-id122 . -1) 35179) nil (26796 45939 30343 0) 0 nil])
([nil nil ((35178 . 35182)) nil (26796 45939 30341 0) 0 nil])
([nil nil ((#("gz" 0 2 (fontified t)) . -35375) (undo-tree-id121 . -2) 35377) nil (26796 45939 30339 0) 0 nil])
([nil nil ((35375 . 35378)) nil (26796 45939 30336 0) 0 nil])
([nil nil ((#("d" 0 1 (fontified t)) . -35377) (undo-tree-id120 . -1) 35378) nil (26796 45939 30334 0) 0 nil])
([nil nil ((35377 . 35382)) nil (26796 45939 30322 0) 0 nil])
([nil nil ((35419 . 35420)) nil (26796 45939 30320 0) 0 nil])
([nil nil ((35420 . 35421)) nil (26796 45939 30315 0) 0 nil])
([nil nil ((32139 . 32140) (t 26796 45939 0 0)) nil (26796 47478 57680 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37939 . 37940) (nil fontified nil 32140 . 37940) (32140 . 37940)) nil (26796 47478 57679 0) 0 nil])
([nil nil ((#("

(defun compression (&key (threshold 1024) (encodings '(\"gzip\")) (add-vary t))
  \"Compresse la rÃ©ponse si pertinent.
   - THRESHOLD : taille mini du corps (octets) pour compresser (def. 1024)
   - ENCODINGS : liste d'encodages supportÃ©s (actuellement \\\"gzip\\\" seulement)
   - ADD-VARY  : si T, ajoute (ou complÃ¨te) Vary: Accept-Encoding\"
  (declare (ignore encodings)) ; gzip only pour lâ€™instant
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (status (lumen.core.http:resp-status resp))
             (headers (lumen.core.http:resp-headers resp)))
        (labels ((decorate-vary (hdrs)
                   (if add-vary
                       (let* ((existing (cdr (assoc \"vary\" hdrs :test #'string=)))
                              (new (if existing
                                       (if (search \"accept-encoding\" (string-downcase existing))
                                           existing
                                           (format nil \"~A, Accept-Encoding\" existing))
                                       \"Accept-Encoding\")))
                         (lumen.utils:ensure-header hdrs \"vary\" new))
                       hdrs)))
          (cond
            ;; Ne compresse jamais ces cas
            ((or (member status '(204 304))                         ; pas de corps
                 (cdr (assoc \"content-encoding\" headers :test #'string=)) ; dÃ©jÃ  encodÃ©
                 (not (%client-wants-gzip-p (lumen.core.http:req-headers req)))) ; client ne veut pas
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)
            (t
	     (let* ((chosen (%choose-encoding req-h :supported '(\"gzip\" \"deflate\"))))
               (if (null chosen)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
             (let* ((body-bytes (%bytes (lumen.core.http:resp-body resp)))
                    (len (length body-bytes)))
               (if (< len threshold)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
                   ;; compresser
                   (let* ((encoded (ecase (intern (string-upcase chosen) :keyword)
                                           (:GZIP    (gzip-bytes bytes))
                                           (:DEFLATE (deflate-bytes bytes))))
			  ;;(gz (gzip-bytes body-bytes))
                          (hdrs (lumen.core.http:resp-headers resp)))
		     ;; Content-Encoding ;; Vary 
                     (setf (lumen.core.http:resp-headers resp)
                           (-> hdrs
                               (lumen.utils:ensure-header \"content-encoding\" chosen)
                               (lumen.utils:ensure-header \"content-length\" (princ-to-string (length chosen)))
                               (decorate-vary)))
		     ;; Corps compressÃ© â†’ write-response recalculera Content-Length tout seul
                     (setf (lumen.core.http:resp-body resp) encoded)
                     resp))))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 20 (face font-lock-function-name-face fontified t) 20 22 (fontified t) 22 26 (face font-lock-type-face fontified t) 26 57 (fontified t) 57 63 (face font-lock-string-face fontified t) 63 82 (fontified t) 82 134 (face font-lock-doc-face fontified t) 134 193 (face font-lock-doc-face fontified t) 193 338 (face font-lock-doc-face fontified t) 338 342 (fontified t) 342 348 (face font-lock-keyword-face fontified t) 348 349 (face font-lock-keyword-face fontified t) 349 370 (fontified t) 370 397 (face font-lock-comment-face fontified t) 397 400 (fontified t) 400 406 (face font-lock-keyword-face fontified t) 406 419 (fontified t) 419 425 (face font-lock-keyword-face fontified t) 425 439 (fontified t) 439 443 (face font-lock-keyword-face fontified t) 443 482 (fontified t) 482 483 (fontified t) 483 513 (fontified t) 513 528 (fontified t) 528 574 (fontified t) 574 588 (fontified t) 588 597 (fontified t) 597 603 (face font-lock-keyword-face fontified t) 603 609 (fontified t) 609 627 (fontified t) 627 647 (fontified t) 647 648 (face font-lock-keyword-face fontified t) 648 649 (face font-lock-keyword-face fontified t) 649 659 (fontified t) 659 683 (fontified t) 683 687 (face font-lock-keyword-face fontified t) 687 711 (fontified t) 711 717 (face font-lock-string-face fontified t) 717 723 (fontified t) 723 728 (face font-lock-builtin-face fontified t) 728 778 (fontified t) 778 780 (face font-lock-keyword-face fontified t) 780 816 (fontified t) 816 830 (fontified t) 830 832 (face font-lock-keyword-face fontified t) 832 841 (fontified t) 841 858 (face font-lock-string-face fontified t) 858 887 (fontified t) 887 994 (fontified t) 994 1015 (face font-lock-string-face fontified t) 1015 1066 (fontified t) 1066 1077 (face font-lock-string-face fontified t) 1077 1083 (face font-lock-string-face fontified t) 1083 1087 (fontified t) 1087 1113 (fontified t) 1113 1124 (fontified t) 1124 1144 (fontified t) 1144 1150 (face font-lock-string-face fontified t) 1150 1157 (fontified t) 1157 1199 (fontified t) 1199 1203 (face font-lock-keyword-face fontified t) 1203 1204 (fontified t) 1204 1216 (fontified t) 1216 1219 (face font-lock-comment-delimiter-face fontified t) 1219 1247 (face font-lock-comment-face fontified t) 1247 1252 (fontified t) 1252 1313 (fontified t) 1313 1315 (fontified t) 1315 1330 (face font-lock-comment-face fontified t) 1330 1359 (fontified t) 1359 1377 (face font-lock-string-face fontified t) 1377 1386 (fontified t) 1386 1391 (face font-lock-builtin-face fontified t) 1391 1397 (fontified t) 1397 1404 (fontified t) 1404 1418 (face font-lock-comment-face fontified t) 1418 1449 (fontified t) 1449 1451 (fontified t) 1451 1499 (fontified t) 1499 1501 (face font-lock-comment-face fontified t) 1501 1520 (face font-lock-comment-face fontified t) 1520 1666 (fontified t) 1666 1681 (fontified t) 1681 1687 (fontified t) 1687 1688 (fontified t) 1688 1692 (face font-lock-keyword-face fontified t) 1692 1726 (fontified t) 1726 1736 (face font-lock-builtin-face fontified t) 1736 1739 (fontified t) 1739 1745 (face font-lock-string-face fontified t) 1745 1746 (fontified t) 1746 1755 (face font-lock-string-face fontified t) 1755 1776 (fontified t) 1776 1778 (face font-lock-keyword-face fontified t) 1778 1813 (fontified t) 1813 1818 (face font-lock-keyword-face fontified t) 1818 1987 (fontified t) 1987 1988 (fontified t rear-nonsticky t) 1988 1989 (fontified t) 1989 2001 (fontified t) 2001 2003 (fontified t) 2003 2007 (face font-lock-keyword-face fontified t) 2007 2064 (fontified t) 2064 2127 (fontified t) 2127 2129 (face font-lock-keyword-face fontified t) 2129 2168 (fontified t) 2168 2173 (face font-lock-keyword-face fontified t) 2173 2205 (fontified t) 2205 2237 (fontified t) 2237 2363 (fontified t) 2363 2366 (face font-lock-comment-delimiter-face fontified t) 2366 2377 (face font-lock-comment-face fontified t) 2377 2397 (fontified t) 2397 2401 (face font-lock-keyword-face fontified t) 2401 2403 (fontified t) 2403 2413 (fontified t) 2413 2418 (face font-lock-keyword-face fontified t) 2418 2450 (fontified t) 2450 2458 (face font-lock-builtin-face fontified t) 2458 2504 (fontified t) 2504 2509 (face font-lock-builtin-face fontified t) 2509 2533 (fontified t) 2533 2577 (fontified t) 2577 2585 (face font-lock-builtin-face fontified t) 2585 2609 (fontified t) 2609 2610 (fontified t rear-nonsticky t) 2610 2611 (fontified t) 2611 2616 (fontified t) 2616 2618 (face font-lock-comment-delimiter-face fontified t) 2618 2646 (face font-lock-comment-face fontified t) 2646 2647 (face font-lock-comment-face fontified t) 2647 2682 (fontified t) 2682 2717 (fontified t) 2717 2724 (fontified t) 2724 2727 (face font-lock-comment-delimiter-face fontified t) 2727 2742 (face font-lock-comment-face fontified t) 2742 2743 (face font-lock-comment-face fontified t rear-nonsticky t) 2743 2744 (face font-lock-comment-face fontified t) 2744 2750 (face font-lock-comment-face fontified t) 2750 2751 (face font-lock-comment-face fontified t rear-nonsticky t) 2751 2752 (face font-lock-comment-face fontified t) 2752 2753 (face font-lock-comment-face fontified t) 2753 2852 (fontified t) 2852 2884 (fontified t) 2884 2895 (fontified t) 2895 2910 (fontified t) 2910 2928 (face font-lock-string-face fontified t) 2928 2935 (fontified t) 2935 2937 (fontified t) 2937 2969 (fontified t) 2969 2980 (fontified t) 2980 2995 (fontified t) 2995 3011 (face font-lock-string-face fontified t) 3011 3020 (fontified t) 3020 3047 (fontified t) 3047 3096 (fontified t) 3096 3103 (fontified t) 3103 3106 (face font-lock-comment-delimiter-face fontified t) 3106 3174 (face font-lock-comment-face fontified t) 3174 3175 (face font-lock-comment-face fontified t rear-nonsticky t) 3175 3176 (face font-lock-comment-face fontified t) 3176 3245 (fontified t) 3245 3279 (fontified t) 3279 3280 (fontified t rear-nonsticky t) 3280 3282 (fontified t)) . -37940) (undo-tree-id128 . -1087) (undo-tree-id129 . -3175) (undo-tree-id130 . -1681) (undo-tree-id131 . -3282) (undo-tree-id132 . -3282) 41222) nil (26796 47478 57678 0) 0 nil])
([nil nil ((#("(defun %content-type (headers)
  (cdr (assoc \"content-type\" headers :test #'string=)))

(defun %type-prefixed-p (ct prefixes)
  \"Vrai si le Content-Type CT commence par un des PREFIXES (strings).\"
  (and ct prefixes
       (let ((ct* (string-downcase ct)))
         (some (lambda (pfx) (lumen.core.util:str-prefix-p (string-downcase pfx) ct*))
               prefixes))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 45 (fontified t) 45 59 (face font-lock-string-face fontified t) 59 68 (fontified t) 68 73 (face font-lock-builtin-face fontified t) 73 89 (fontified t) 89 94 (face font-lock-keyword-face fontified t) 94 95 (fontified t) 95 111 (face font-lock-function-name-face fontified t) 111 128 (fontified t) 128 196 (face font-lock-doc-face fontified t) 196 224 (fontified t) 224 227 (face font-lock-keyword-face fontified t) 227 273 (fontified t) 273 279 (face font-lock-keyword-face fontified t) 279 371 (fontified t)) . 32140) (undo-tree-id127 . -371)) nil (26796 47478 57672 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 32140) (#("
" 0 1 (fontified t)) . 32140)) nil (26796 47478 57669 0) 0 nil])
([nil nil ((30935 . 30937)) nil (26796 47478 57668 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31307 . 31308) (nil fontified nil 31216 . 31308) (nil fontified nil 31210 . 31216) (nil fontified nil 31164 . 31210) (nil fontified nil 31161 . 31164) (nil fontified nil 31133 . 31161) (nil fontified nil 31065 . 31133) (nil fontified nil 31048 . 31065) (nil fontified nil 31032 . 31048) (nil fontified nil 31031 . 31032) (nil fontified nil 31026 . 31031) (nil fontified nil 31010 . 31026) (nil fontified nil 31005 . 31010) (nil fontified nil 30996 . 31005) (nil fontified nil 30982 . 30996) (nil fontified nil 30957 . 30982) (nil fontified nil 30944 . 30957) (nil fontified nil 30943 . 30944) (nil fontified nil 30938 . 30943) (nil fontified nil 30937 . 30938) (30937 . 31308)) nil (26796 47478 57667 0) 0 nil])
([nil nil ((154 . 155)) nil (26796 47478 57664 0) 0 nil])
([nil nil ((155 . 156)) nil (26796 47478 57663 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 167 . 168) (nil fontified nil 156 . 168) (156 . 168)) nil (26796 47478 57662 0) 0 nil])
([nil nil ((156 . 158) (154 . 155)) nil (26796 47478 57661 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -171) (undo-tree-id126 . -3) 174) nil (26796 47478 57659 0) 0 nil])
([nil nil ((32913 . 32920) (#("           " 0 11 (fontified nil)) . 32913) (#("   " 0 3 (fontified t)) . -32899) (#("   " 0 3 (fontified t)) . -32875) (#("   " 0 3 (fontified t)) . -32851) (#("   " 0 3 (fontified t)) . -32791) (#("   " 0 3 (fontified t)) . -32719) (#("   " 0 3 (fontified t)) . -32662) (#("   " 0 3 (fontified t)) . -32600) (#("   " 0 3 (fontified t)) . -32580) 32527) nil (26796 47478 57641 0) 0 nil])
([nil nil (("lumen.core.util" . -37674) (37689 . 37700) (#("lumen.core.util" 0 15 (fontified t)) . -33851) (t 26796 47478 0 0) (33866 . 33877) (t 26796 47478 0 0)) nil (26796 47490 421489 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -31238) (t 26796 47490 0 0) (31253 . 31264) (t 26796 47490 0 0)) nil (26796 47501 526956 0) 0 nil])
([nil nil ((37915 . 37916) (t 26796 47501 0 0)) nil (26796 49382 300209 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 39614 . 39615) (nil fontified nil 37916 . 39615) (37916 . 39615)) nil (26796 49382 300208 0) 0 nil])
([nil nil ((37915 . 37916)) nil (26796 49382 300207 0) 0 nil])
([nil nil ((37916 . 37919)) nil (26796 49382 300207 0) 0 nil])
([nil nil ((37919 . 37920)) nil (26796 49382 300207 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37942 . 37943) (nil fontified nil 37920 . 37943) (37920 . 37943)) nil (26796 49382 300206 0) 0 nil])
([nil nil ((37943 . 37944)) nil (26796 49382 300206 0) 0 nil])
([nil nil ((37944 . 37965)) nil (26796 49382 300205 0) 0 nil])
([nil nil ((37965 . 37984)) nil (26796 49382 300205 0) 0 nil])
([nil nil ((#("â€‘" 0 1 (face font-lock-comment-face fontified t)) . 37922)) nil (26796 49382 300205 0) 0 nil])
([nil nil ((37922 . 37923)) nil (26796 49382 300204 0) 0 nil])
([nil nil ((#("â€‘" 0 1 (face font-lock-comment-face fontified t)) . -37931) (undo-tree-id135 . -1) 37932) nil (26796 49382 300204 0) 0 nil])
([nil nil ((37931 . 37932)) nil (26796 49382 300203 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -39449) (39464 . 39475) (#("lumen.core.util" 0 15 (fontified t)) . -39379) (39394 . 39405) (#("lumen.core.util" 0 15 (fontified t)) . -38569) (38584 . 38595)) nil (26796 49382 300202 0) 0 nil])
([nil nil ((295 . 296)) nil (26796 49382 300201 0) 0 nil])
([nil nil ((296 . 297)) nil (26796 49382 300201 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 311 . 312) (nil fontified nil 297 . 312) (297 . 312)) nil (26796 49382 300200 0) 0 nil])
([nil nil ((312 . 313)) nil (26796 49382 300199 0) 0 nil])
([nil nil ((313 . 320)) nil (26796 49382 300199 0) 0 nil])
([nil nil ((313 . 329) (#("format-" 0 7 (fontified t)) . -313) (undo-tree-id134 . -7) 320) nil (26796 49382 300198 0) 0 nil])
([nil nil ((313 . 314)) nil (26796 49382 300197 0) 0 nil])
([nil nil ((313 . 315) (#(" " 0 1 (fontified nil)) . 312) (undo-tree-id133 . -1) (313 . 314)) nil (26796 49382 300195 0) 0 nil])
([nil nil ((39709 . 39710) 315) nil (26796 49382 300182 0) 0 nil])
([nil nil ((766 . 770) (749 . 753) (#("   " 0 3 (fontified nil)) . 749) (764 . 765) (t 26796 49382 0 0)) nil (26796 49741 601456 0) 0 nil])
([nil nil ((770 . 771)) nil (26796 49741 601455 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 795 . 796) (nil fontified nil 771 . 796) (771 . 796)) nil (26796 49741 601455 0) 0 nil])
([nil nil ((#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -768) (768 . 769) (#("	" 0 1 (fontified nil)) . 768) (765 . 768) (#("	   " 0 4 (fontified nil)) . -647) (647 . 648) (#("	" 0 1 (fontified nil)) . 647) (644 . 647) 19) nil (26796 49741 601454 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -749) (undo-tree-id142 . -1) (#(" " 0 1 (fontified t)) . -750) (undo-tree-id143 . -1) (#(" " 0 1 (fontified t)) . -751) (undo-tree-id144 . -1) 752) nil (26796 49741 601452 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -751) (undo-tree-id136 . -1) (#(" " 0 1 (fontified t)) . -752) (undo-tree-id137 . -1) (#(" " 0 1 (fontified t)) . -753) (undo-tree-id138 . -1) (#(" " 0 1 (fontified t)) . -754) (undo-tree-id139 . -1) (#(" " 0 1 (fontified nil)) . -755) (undo-tree-id140 . -1) (#("	" 0 1 (fontified nil)) . 756) (undo-tree-id141 . -1) (748 . 756) 749) nil (26796 49741 601445 0) 0 nil])
([nil nil ((14580 . 14589) (#(" " 0 1 (fontified nil)) . 14580) (14579 . 14580) (t 26796 49741 0 0)) nil (26796 50658 162219 0) 0 nil])
([nil nil ((14598 . 14606)) nil (26796 50658 162218 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14636 . 14637) (nil fontified nil 14606 . 14637) (14606 . 14637)) nil (26796 50658 162218 0) 0 nil])
([nil nil ((19427 . 19428)) nil (26796 50658 162217 0) 0 nil])
([nil nil ((13105 . 13106)) nil (26796 50658 162217 0) 0 nil])
([nil nil ((13105 . 13107)) nil (26796 50658 162217 0) 0 nil])
([nil nil ((#("              " 0 14 (face font-lock-comment-face fontified nil)) . -19391) (19429 . 19430)) nil (26796 50658 162216 0) 0 nil])
([nil nil ((19416 . 19418)) nil (26796 50658 162216 0) 0 nil])
([nil nil ((19418 . 19420)) nil (26796 50658 162215 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27252 . 27253) (nil fontified nil 19420 . 27253) (19420 . 27253)) nil (26796 50658 162215 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -27252) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) 27253) nil (26796 50658 162214 0) 0 nil])
([nil nil ((27252 . 27253)) nil (26796 50658 162210 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -27252) (undo-tree-id145 . -1) (undo-tree-id146 . -1) 27253) nil (26796 50658 162207 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -26783) (26798 . 26809) (#("lumen.core.util" 0 15 (fontified t)) . -26649) (26664 . 26675) (#("lumen.core.util" 0 15 (fontified t)) . -25739) (25754 . 25765) (#("lumen.core.util" 0 15 (fontified t)) . -25613) (25628 . 25639) (#("lumen.core.util" 0 15 (fontified t)) . -24796) (24811 . 24822) (#("lumen.core.util" 0 15 (fontified t)) . -24652) (24667 . 24678) (#("lumen.core.util" 0 15 (fontified t)) . -23658) (23673 . 23684) (#("lumen.core.util" 0 15 (fontified t)) . -23522) (23537 . 23548) (#("lumen.core.util" 0 15 (fontified t)) . -22667) (22682 . 22693) (#("lumen.core.util" 0 15 (fontified t)) . -22531) (t 26796 50658 0 0) (22546 . 22557) (t 26796 50658 0 0)) nil (26796 50672 180361 0) 0 nil])
([nil nil ((47574 . 47575) (t 26796 50672 0 0)) nil (26797 27361 393744 0) 0 nil])
([nil nil ((47575 . 47577)) nil (26797 27361 393743 0) 0 nil])
([nil nil ((47577 . 47578)) nil (26797 27361 393743 0) 0 nil])
([nil nil ((47578 . 47579)) nil (26797 27361 393742 0) 0 nil])
([nil nil ((47579 . 47586)) nil (26797 27361 393742 0) 0 nil])
([nil nil ((47586 . 47587)) nil (26797 27361 393742 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 49113 . 49114) (nil fontified nil 47587 . 49114) (47587 . 49114)) nil (26797 27361 393741 0) 0 nil])
([nil nil ((793 . 797)) nil (26797 27361 393741 0) 0 nil])
([nil nil ((797 . 799)) nil (26797 27361 393740 0) 0 nil])
([nil nil ((799 . 800)) nil (26797 27361 393740 0) 0 nil])
([nil nil ((800 . 807)) nil (26797 27361 393739 0) 0 nil])
([nil nil ((807 . 811)) nil (26797 27361 393739 0) 0 nil])
([nil nil ((811 . 819)) nil (26797 27361 393738 0) 0 nil])
([nil nil ((821 . 825) (808 . 812) (#("   " 0 3 (fontified nil)) . 808) (819 . 820)) nil (26797 27361 393738 0) 0 nil])
([nil nil ((825 . 830)) nil (26797 27361 393737 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-builtin-face fontified t)) . -827) (undo-tree-id189 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -828) (undo-tree-id190 . -1) (#("f" 0 1 (face font-lock-builtin-face fontified t)) . -829) (undo-tree-id191 . -1) 830) nil (26797 27361 393736 0) 0 nil])
([nil nil ((827 . 830)) nil (26797 27361 393731 0) 0 nil])
([nil nil ((49151 . 49153)) nil (26797 27361 393731 0) 0 nil])
([nil nil ((49153 . 49155)) nil (26797 27361 393731 0) 0 nil])
([nil nil ((49155 . 49156)) nil (26797 27361 393730 0) 0 nil])
([nil nil ((49156 . 49157)) nil (26797 27361 393730 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -49155) (undo-tree-id187 . -1) (#(";" 0 1 (face font-lock-comment-face fontified t)) . -49156) (undo-tree-id188 . -1) 49157) nil (26797 27361 393729 0) 0 nil])
([nil nil ((49155 . 49156)) nil (26797 27361 393727 0) 0 nil])
([nil nil ((49156 . 49157)) nil (26797 27361 393727 0) 0 nil])
([nil nil ((49157 . 49161)) nil (26797 27361 393726 0) 0 nil])
([nil nil ((49161 . 49162)) nil (26797 27361 393726 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50794 . 50795) (nil fontified nil 49162 . 50795) (49162 . 50795)) nil (26797 27361 393726 0) 0 nil])
([nil nil ((49161 . 49162)) nil (26797 27361 393725 0) 0 nil])
([nil nil ((49162 . 49164)) nil (26797 27361 393724 0) 0 nil])
([nil nil ((49164 . 49165)) nil (26797 27361 393724 0) 0 nil])
([nil nil ((49165 . 49167)) nil (26797 27361 393724 0) 0 nil])
([nil nil ((49164 . 49165)) nil (26797 27361 393723 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 49477 . 49478) (nil fontified nil 49165 . 49478) (49165 . 49478)) nil (26797 27361 393723 0) 0 nil])
([nil nil ((49165 . 49166)) nil (26797 27361 393722 0) 0 nil])
([nil nil ((49166 . 49167)) nil (26797 27361 393722 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -49270) (undo-tree-id186 . -1) 49271) nil (26797 27361 393721 0) 0 nil])
([nil nil ((49270 . 49271)) nil (26797 27361 393720 0) 0 nil])
([nil nil ((49271 . 49272)) nil (26797 27361 393720 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -49454) (undo-tree-id185 . -1) 49455) nil (26797 27361 393720 0) 0 nil])
([nil nil ((49454 . 49455)) nil (26797 27361 393719 0) 0 nil])
([nil nil ((49455 . 49456)) nil (26797 27361 393718 0) 0 nil])
([nil nil ((709 . 710)) nil (26797 27361 393718 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -709) (undo-tree-id184 . -1) 710) nil (26797 27361 393717 0) 0 nil])
([nil nil ((385 . 388)) nil (26797 27361 393716 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 436 . 437) (nil fontified nil 436 . 437) (nil fontified nil 419 . 436) (nil fontified nil 418 . 419) (nil fontified nil 402 . 418) (nil fontified nil 401 . 402) (nil fontified nil 389 . 401) (nil fontified nil 388 . 389) (388 . 437)) nil (26797 27361 393716 0) 0 nil])
([nil nil ((#("body" 0 4 (face font-lock-builtin-face fontified t)) . 414)) nil (26797 27361 393715 0) 0 nil])
([nil nil ((414 . 421)) nil (26797 27361 393714 0) 0 nil])
([nil nil ((#(":parse-urlencoded" 0 17 (face font-lock-builtin-face fontified t)) . -422) (undo-tree-id183 . -17) 439) nil (26797 27361 393714 0) 0 nil])
([nil nil ((nil fontified nil 505 . 506) (nil fontified nil 489 . 505) (nil fontified nil 476 . 489) (nil fontified nil 475 . 476) (nil fontified nil 474 . 475) (nil fontified nil 462 . 474) (nil fontified nil 461 . 462) (nil fontified nil 460 . 461) (nil fontified nil 448 . 460) (nil fontified nil 447 . 448) (nil fontified nil 435 . 447) (nil fontified nil 434 . 435) (nil fontified nil 433 . 434) (nil fontified nil 426 . 433) (nil fontified nil 422 . 426) (422 . 506)) nil (26797 27361 393712 0) 0 nil])
([nil nil ((506 . 507)) nil (26797 27361 393711 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 541 . 542) (nil fontified nil 532 . 542) (nil fontified nil 531 . 532) (nil fontified nil 530 . 531) (nil fontified nil 520 . 530) (nil fontified nil 519 . 520) (nil fontified nil 518 . 519) (nil fontified nil 508 . 518) (nil fontified nil 507 . 508) (507 . 542)) nil (26797 27361 393710 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -506) (undo-tree-id181 . -1) (undo-tree-id182 . -1) 507) nil (26797 27361 393709 0) 0 nil])
([nil nil ((507 . 508)) nil (26797 27361 393707 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 515 . 516) (nil fontified nil 508 . 516) (508 . 516)) nil (26797 27361 393707 0) 0 nil])
([nil nil ((516 . 517)) nil (26797 27361 393706 0) 0 nil])
([nil nil ((551 . 552)) nil (26797 27361 393706 0) 0 nil])
([nil nil ((552 . 553)) nil (26797 27361 393705 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 562 . 563) (nil fontified nil 553 . 563) (553 . 563)) nil (26797 27361 393705 0) 0 nil])
([nil nil ((50310 . 50312)) nil (26797 27361 393704 0) 0 nil])
([nil nil ((50399 . 50401)) nil (26797 27361 393704 0) 0 nil])
([nil nil ((50404 . 50406)) nil (26797 27361 393704 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -50724) (undo-tree-id180 . -10) 50734) nil (26797 27361 393703 0) 0 nil])
([nil nil ((50724 . 50733)) nil (26797 27361 393702 0) 0 nil])
([nil nil ((#("header-name" 0 11 (fontified t)) . 50734) (undo-tree-id179 . -11) 50745) nil (26797 27361 393702 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -50734) (undo-tree-id178 . -1) 50735) nil (26797 27361 393701 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50748 . 50749) (nil fontified nil 50738 . 50749) (50738 . 50749)) nil (26797 27361 393700 0) 0 nil])
([nil nil ((#(":test" 0 5 (fontified t)) . 50749)) nil (26797 27361 393699 0) 0 nil])
([nil nil ((#(" #'string" 0 9 (fontified t)) . 50749)) nil (26797 27361 393699 0) 0 nil])
([nil nil ((#("-equal" 0 6 (fontified t)) . 50749)) nil (26797 27361 393698 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -50751) (undo-tree-id177 . -1) 50752) nil (26797 27361 393698 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50729 . 50730) (nil fontified nil 50724 . 50730) (50724 . 50730)) nil (26797 27361 393697 0) 0 nil])
([nil nil ((50730 . 50736)) nil (26797 27361 393696 0) 0 nil])
([nil nil ((#("cdr (assoc " 0 11 (fontified t)) . -50861) (undo-tree-id176 . -11) 50872) nil (26797 27361 393696 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50882 . 50883) (nil fontified nil 50873 . 50883) (nil fontified nil 50867 . 50873) (nil fontified nil 50866 . 50867) (nil fontified nil 50861 . 50866) (50861 . 50883)) nil (26797 27361 393695 0) 0 nil])
([nil nil ((50883 . 50887)) nil (26797 27361 393694 0) 0 nil])
([nil nil ((50887 . 50888)) nil (26797 27361 393693 0) 0 nil])
([nil nil ((#("form" 0 4 (fontified t)) . -50901) (undo-tree-id175 . -4) 50905) nil (26797 27361 393693 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -50900) (undo-tree-id173 . -1) (undo-tree-id174 . -1) 50901) nil (26797 27361 393692 0) 0 nil])
([nil nil ((50901 . 50914) (#(" " 0 1 (fontified nil)) . 50900) (undo-tree-id172 . -1) (50901 . 50902)) nil (26797 27361 393690 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -50931) (undo-tree-id171 . -1) 50932) nil (26797 27361 393689 0) 0 nil])
([nil nil ((51227 . 51233) (#(" " 0 1 (fontified nil)) . 51226) (undo-tree-id170 . -1) (51227 . 51228)) nil (26797 27361 393686 0) 0 nil])
([nil nil ((51322 . 51324)) nil (26797 27361 393685 0) 0 nil])
([nil nil ((51324 . 51327)) nil (26797 27361 393685 0) 0 nil])
([nil nil ((51327 . 51328)) nil (26797 27361 393684 0) 0 nil])
([nil nil ((51328 . 51331)) nil (26797 27361 393684 0) 0 nil])
([nil nil ((51331 . 51332)) nil (26797 27361 393684 0) 0 nil])
([nil nil ((51332 . 51339)) nil (26797 27361 393683 0) 0 nil])
([nil nil ((51339 . 51340)) nil (26797 27361 393683 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 52053 . 52054) (nil fontified nil 51340 . 52054) (51340 . 52054)) nil (26797 27361 393682 0) 0 nil])
([nil nil ((#("str:starts-with?" 0 16 (fontified t)) . -51701) (undo-tree-id169 . -16) 51717) nil (26797 27361 393682 0) 0 nil])
([nil nil ((51701 . 51709)) nil (26797 27361 393681 0) 0 nil])
([nil nil ((51701 . 51713) (#("lumen.ut" 0 8 (fontified t)) . -51701) (undo-tree-id168 . -8) 51709) nil (26797 27361 393680 0) 0 nil])
([nil nil ((51713 . 51716)) nil (26797 27361 393679 0) 0 nil])
([nil nil ((51701 . 51717) (#("lumen.utils:str" 0 15 (fontified t)) . -51701) (undo-tree-id167 . -15) 51716) nil (26797 27361 393679 0) 0 nil])
([nil nil ((51717 . 51718)) nil (26797 27361 393678 0) 0 nil])
([nil nil ((51701 . 51725) (#("lumen.utils:str-p" 0 17 (fontified t)) . -51701) (undo-tree-id166 . -17) 51718) nil (26797 27361 393677 0) 0 nil])
([nil nil ((564 . 567)) nil (26797 27361 393676 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 615 . 616) (nil fontified nil 615 . 616) (nil fontified nil 598 . 615) (nil fontified nil 597 . 598) (nil fontified nil 581 . 597) (nil fontified nil 580 . 581) (nil fontified nil 568 . 580) (nil fontified nil 567 . 568) (567 . 616)) nil (26797 27361 393675 0) 0 nil])
([nil nil ((#("body" 0 4 (face font-lock-builtin-face fontified t)) . 593)) nil (26797 27361 393674 0) 0 nil])
([nil nil ((593 . 596)) nil (26797 27361 393674 0) 0 nil])
([nil nil ((596 . 597)) nil (26797 27361 393673 0) 0 nil])
([nil nil ((597 . 602)) nil (26797 27361 393673 0) 0 nil])
([nil nil ((597 . 607) (#("jwt-e" 0 5 (fontified t)) . -597) (undo-tree-id165 . -5) 602) nil (26797 27361 393672 0) 0 nil])
([nil nil ((607 . 608)) nil (26797 27361 393671 0) 0 nil])
([nil nil ((608 . 613)) nil (26797 27361 393670 0) 0 nil])
([nil nil ((608 . 618) (#("jwt-d" 0 5 (fontified t)) . -608) (undo-tree-id154 . -5) (undo-tree-id155 . -4) (undo-tree-id156 . -4) (undo-tree-id157 . -4) (undo-tree-id158 . -4) (undo-tree-id159 . -4) (undo-tree-id160 . -4) (undo-tree-id161 . -4) (undo-tree-id162 . -4) (undo-tree-id163 . -5) (undo-tree-id164 . -5) 613) nil (26797 27361 786970 0) 0 nil])
([nil nil ((#(" :parse" 0 1 (fontified t) 1 7 (face font-lock-builtin-face fontified t)) . 618)) nil (26797 27883 958760 0) 0 nil] [nil nil ((#(" :parse-urlencoded)
  (:export :define-middleware :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :*debug* :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :static-many
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
	   :csrf))" 0 1 (fontified t) 1 18 (face font-lock-builtin-face fontified t) 18 19 (rear-nonsticky t fontified t) 19 20 (fontified t) 20 23 (fontified t) 23 30 (face font-lock-builtin-face fontified t) 30 31 (fontified t) 31 49 (face font-lock-builtin-face fontified t) 49 50 (fontified t) 50 61 (face font-lock-builtin-face fontified t) 61 62 (fontified t) 62 68 (face font-lock-builtin-face fontified t) 68 69 (fontified t) 69 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 87 (face font-lock-builtin-face fontified t) 87 88 (fontified t) 88 101 (face font-lock-builtin-face fontified t) 101 106 (fontified t) 106 134 (face font-lock-builtin-face fontified t) 134 135 (fontified t) 135 143 (face font-lock-builtin-face fontified t) 143 144 (fontified t) 144 153 (face font-lock-builtin-face fontified t) 153 154 (fontified t) 154 175 (face font-lock-builtin-face fontified t) 175 180 (fontified t) 180 186 (face font-lock-builtin-face fontified t) 186 187 (fontified t) 187 192 (face font-lock-builtin-face fontified t) 192 193 (fontified t) 193 200 (face font-lock-builtin-face fontified t) 200 201 (fontified t) 201 206 (face font-lock-builtin-face fontified t) 206 207 (fontified t) 207 219 (face font-lock-builtin-face fontified t) 219 224 (fontified t) 224 227 (face font-lock-comment-delimiter-face fontified t) 227 243 (face font-lock-comment-face fontified t) 243 246 (fontified t) 246 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 277 (face font-lock-builtin-face fontified t) 277 278 (fontified t) 278 281 (fontified t) 281 284 (face font-lock-comment-delimiter-face fontified t) 284 292 (face font-lock-comment-face fontified t) 292 295 (fontified t) 295 306 (face font-lock-builtin-face fontified t) 306 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 327 (face font-lock-builtin-face fontified t) 327 328 (fontified t) 328 343 (face font-lock-builtin-face fontified t) 343 344 (fontified t) 344 347 (fontified t) 347 350 (face font-lock-comment-delimiter-face fontified t) 350 355 (face font-lock-comment-face fontified t) 355 358 (fontified t) 358 359 (face font-lock-builtin-face fontified t) 359 362 (face font-lock-builtin-face fontified t) 362 363 (face font-lock-builtin-face fontified t rear-nonsticky t) 363 364 (fontified t) 364 367 (fontified t) 367 370 (face font-lock-comment-delimiter-face fontified t) 370 382 (face font-lock-comment-face fontified t) 382 385 (fontified t) 385 397 (face font-lock-builtin-face fontified t) 397 398 (fontified t) 398 401 (fontified t) 401 402 (face font-lock-builtin-face fontified t) 402 426 (face font-lock-builtin-face fontified t) 426 427 (face font-lock-builtin-face fontified t rear-nonsticky t) 427 428 (fontified t) 428 431 (fontified t) 431 434 (face font-lock-comment-delimiter-face fontified t) 434 442 (face font-lock-comment-face fontified t) 442 446 (fontified t) 446 454 (face font-lock-builtin-face fontified t) 454 455 (fontified t) 455 459 (fontified t) 459 464 (face font-lock-builtin-face fontified t) 464 466 (fontified t)) . 618) (undo-tree-id151 . -20) (undo-tree-id152 . -20) (undo-tree-id153 . -466)) ((618 . 1084)) (26797 27361 393786 0) 0 nil])
([nil nil ((#("-urlencoded" 0 11 (fontified t)) . 618)) nil (26797 27883 958759 0) 0 nil])
([nil nil ((#("

(in-package :lumen.core.middleware)" 0 1 (fontified t) 1 3 (fontified t) 3 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 36 (face font-lock-builtin-face fontified t) 36 37 (fontified t)) . 618) (undo-tree-id150 . -37)) ((618 . 655)) (26797 27361 393657 0) 0 nil])
([nil nil ((608 . 609)) nil (26797 27883 958759 0) 0 nil])
nil
([nil nil ((597 . 598)) nil (26797 27883 958758 0) 0 nil])
([nil nil ((1066 . 1069) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1060) (1060 . 1061) (#("	" 0 1 (fontified nil)) . 1060) (1057 . 1060) (1066 . 1067)) nil (26797 27883 958757 0) 0 nil])
([nil nil ((1069 . 1075)) nil (26797 27883 958756 0) 0 nil])
([nil nil ((1066 . 1070) (#("   " 0 3 (fontified t)) . 1066) 1075) nil (26797 27883 958755 0) 0 nil])
([nil nil ((1076 . 1079)) nil (26797 27883 958753 0) 0 nil])
([nil nil ((52132 . 52133)) nil (26797 27883 958750 0) 0 nil])
([nil nil ((488 . 489) (t 26797 27883 0 0)) nil (26797 28579 736731 0) 0 nil])
([nil nil ((564 . 565) (t 26797 28579 0 0)) nil (26797 28918 120145 0) 0 nil])
([nil nil ((565 . 566)) nil (26797 28918 120144 0) 0 nil])
([nil nil ((nil rear-nonsticky (face) 578 . 579) (nil fontified nil 566 . 579) (566 . 579)) nil (26797 28918 120144 0) 0 nil])
([nil nil ((567 . 574) (#("SESSION" 0 7 (face font-lock-builtin-face fontified t rear-nonsticky (face) slime-repl-output t)) . 567)) nil (26797 28918 120143 0) 0 nil])
([nil nil ((574 . 578) (#("-TTL" 0 4 (face font-lock-builtin-face fontified t rear-nonsticky (face) slime-repl-output t)) . 574)) nil (26797 28918 120143 0) 0 nil])
([nil nil ((578 . 579)) nil (26797 28918 120142 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t slime-repl-output t)) . -578) (undo-tree-id193 . -1) 579) nil (26797 28918 120142 0) 0 nil])
([nil nil ((579 . 580)) nil (26797 28918 120140 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 595 . 596) (nil fontified nil 580 . 596) (580 . 596)) nil (26797 28918 120139 0) 0 nil])
([nil nil ((580 . 581)) nil (26797 28918 120139 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -580) (undo-tree-id192 . -1) 581) nil (26797 28918 120138 0) 0 nil])
([nil nil ((580 . 581)) nil (26797 28918 120129 0) 0 nil])
([nil nil ((597 . 598)) nil (26797 28918 120129 0) 0 nil])
([nil nil ((598 . 599)) nil (26797 28918 120129 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 614 . 615) (nil fontified nil 599 . 615) (599 . 615)) nil (26797 28918 120128 0) 0 nil])
([nil nil ((#("session" 0 7 (face font-lock-builtin-face fontified t)) . 600)) nil (26797 28918 120127 0) 0 nil])
([nil nil ((600 . 604)) nil (26797 28918 120126 0) 0 nil])
([nil nil ((604 . 606)) nil (26797 28918 120122 0) 0 nil])
([nil nil ((#("%" 0 1 (fontified t)) . 48388) (t 26797 28918 0 0)) nil (26797 29525 406058 0) 0 nil])
([nil nil ((#(" :wrap nil" 0 1 (fontified t) 1 6 (face font-lock-builtin-face fontified t) 6 10 (fontified t)) . -49915) (undo-tree-id5 . -10) (undo-tree-id6 . -10) (undo-tree-id7 . -10) (undo-tree-id8 . -10) 49925 (t 26797 29525 0 0)) nil (26797 29652 220379 0) 0 nil])
([nil nil ((#("
     " 0 1 (fontified t) 1 6 (fontified t)) . -49902) (undo-tree-id0 . -6) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -6) (undo-tree-id4 . -6) 49908) nil (26797 29652 220373 0) 0 nil])
([nil nil ((40760 . 40761) (t 26797 29652 0 0)) nil (26797 30684 73944 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 42548 . 42549) (nil fontified nil 40761 . 42549) (40761 . 42549)) nil (26797 30684 73943 0) 0 nil])
([nil nil ((42549 . 42550)) nil (26797 30684 73939 0) 0 nil])
([nil nil ((52304 . 52306) (t 26797 30684 0 0)) nil (26797 31245 519742 0) 0 nil])
([nil nil ((52306 . 52312)) nil (26797 31245 519742 0) 0 nil])
([nil nil ((52312 . 52313)) nil (26797 31245 519742 0) 0 nil])
([nil nil ((52313 . 52315)) nil (26797 31245 519741 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -52314) (undo-tree-id10 . -1) 52315) nil (26797 31245 519741 0) 0 nil])
([nil nil ((52314 . 52315)) nil (26797 31245 519739 0) 0 nil])
([nil nil ((52315 . 52317)) nil (26797 31245 519739 0) 0 nil])
([nil nil ((52317 . 52323)) nil (26797 31245 519738 0) 0 nil])
([nil nil ((52323 . 52324)) nil (26797 31245 519738 0) 0 nil])
([nil nil ((52324 . 52327)) nil (26797 31245 519737 0) 0 nil])
([nil nil ((52327 . 52329)) nil (26797 31245 519737 0) 0 nil])
([nil nil ((52329 . 52335)) nil (26797 31245 519736 0) 0 nil])
([nil nil ((52335 . 52336)) nil (26797 31245 519735 0) 0 nil])
([nil nil ((52336 . 52340)) nil (26797 31245 519735 0) 0 nil])
([nil nil ((52327 . 52329)) nil (26797 31245 519735 0) 0 nil])
([nil nil ((52329 . 52335)) nil (26797 31245 519734 0) 0 nil])
([nil nil ((52335 . 52336)) nil (26797 31245 519734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 52377 . 52378) (nil fontified nil 52377 . 52378) (nil fontified nil 52372 . 52377) (nil fontified nil 52336 . 52372) (52336 . 52378)) nil (26797 31245 519733 0) 0 nil])
([nil nil ((52378 . 52379)) nil (26797 31245 519733 0) 0 nil])
([nil nil ((53056 . 53059)) nil (26797 31245 519732 0) 0 nil])
([nil nil ((53059 . 53065)) nil (26797 31245 519732 0) 0 nil])
([nil nil ((53065 . 53066)) nil (26797 31245 519731 0) 0 nil])
([nil nil ((53066 . 53071)) nil (26797 31245 519731 0) 0 nil])
([nil nil ((53071 . 53074)) nil (26797 31245 519730 0) 0 nil])
([nil nil ((53074 . 53079)) nil (26797 31245 519730 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -53078) (undo-tree-id9 . -1) 53079) nil (26797 31245 519729 0) 0 nil])
([nil nil ((53078 . 53080)) nil (26797 31245 519720 0) 0 nil])
([nil nil ((53080 . 53081)) nil (26797 31245 519720 0) 0 nil])
([nil nil ((53081 . 53085)) nil (26797 31245 519719 0) 0 nil])
([nil nil ((53085 . 53088)) nil (26797 31245 519718 0) 0 nil])
([nil nil ((53088 . 53094)) nil (26797 31245 519718 0) 0 nil])
([nil nil ((53094 . 53095)) nil (26797 31245 519718 0) 0 nil])
([nil nil ((53095 . 53103)) nil (26797 31245 519717 0) 0 nil])
([nil nil ((53103 . 53106)) nil (26797 31245 519716 0) 0 nil])
([nil nil ((53106 . 53112)) nil (26797 31245 519715 0) 0 nil])
([nil nil ((53112 . 53113)) nil (26797 31245 519714 0) 0 nil])
([nil nil ((53113 . 53118)) nil (26797 31245 519711 0) 0 nil])
([nil nil ((53366 . 53368) (t 26797 31245 0 0)) nil (26797 32269 587643 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55072 . 55073) (nil fontified nil 53368 . 55073) (53368 . 55073)) nil (26797 32269 587642 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -55072) (undo-tree-id16 . -1) 55073) nil (26797 32269 587641 0) 0 nil])
([nil nil ((#("(print m)
	(print ok)
	(print (lumen.core.session:session-get req :csrf))
	(print tok)" 0 10 (fontified t) 10 22 (fontified t) 22 30 (fontified t) 30 66 (fontified t) 66 71 (face font-lock-builtin-face fontified t) 71 72 (rear-nonsticky t fontified t) 72 73 (fontified t) 73 74 (fontified t) 74 86 (fontified t)) . 52306) (undo-tree-id15 . -86) 52392) nil (26797 32269 587640 0) 0 nil])
([nil nil ((53913 . 53915)) nil (26797 32269 587639 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 54000 . 54001) (nil fontified nil 53989 . 54001) (nil fontified nil 53988 . 53989) (nil fontified nil 53987 . 53988) (nil fontified nil 53986 . 53987) (nil fontified nil 53981 . 53986) (nil fontified nil 53945 . 53981) (nil fontified nil 53937 . 53945) (nil fontified nil 53925 . 53937) (nil fontified nil 53915 . 53925) (53915 . 54001)) nil (26797 32269 587638 0) 0 nil])
([nil nil ((#("m" 0 1 (fontified t)) . -53922) (undo-tree-id14 . -1) 53923) nil (26797 32269 587637 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 53927 . 53928) (nil fontified nil 53922 . 53928) (53922 . 53928)) nil (26797 32269 587635 0) 0 nil])
([nil nil ((#("ok" 0 2 (fontified t)) . -53938) (undo-tree-id13 . -2) 53940) nil (26797 32269 587635 0) 0 nil])
([nil nil ((53938 . 53941)) nil (26797 32269 587634 0) 0 nil])
([nil nil ((53941 . 53942)) nil (26797 32269 587633 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . -53941) (undo-tree-id12 . -1) 53942) nil (26797 32269 587633 0) 0 nil])
([nil nil ((53941 . 53942)) nil (26797 32269 587631 0) 0 nil])
([nil nil ((#("(print \"OK\")
		(print hdr)
		(print hdr-tok)
		(print form)" 0 7 (fontified t) 7 11 (face font-lock-string-face fontified t) 11 13 (fontified t) 13 27 (fontified t) 27 45 (fontified t) 45 59 (fontified t)) . 52973) (undo-tree-id11 . -59) 53032) nil (26797 32269 587712 0) 0 nil])
([nil nil ((54441 . 54447)) nil (26797 32282 121368 0) 0 nil] [nil nil ((nil rear-nonsticky nil 54499 . 54500) (nil fontified nil 54486 . 54500) (nil fontified nil 54468 . 54486) (nil fontified nil 54454 . 54468) (nil fontified nil 54452 . 54454) (nil fontified nil 54448 . 54452) (nil fontified nil 54441 . 54448) (54441 . 54500)) ((#("(print \"OK\")
		(print hdr)
		(print hdr-tok)
		(print form)" 0 7 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified nil) 7 11 (help-echo "Easy to misread; consider moving the element to the next line" face (font-lock-warning-face font-lock-string-face) fontified nil) 11 12 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified nil) 12 13 (fontified nil) 13 27 (fontified nil) 27 45 (fontified nil) 45 58 (fontified nil) 58 59 (rear-nonsticky nil fontified nil)) . 54441) (undo-tree-id17 . -59) (undo-tree-id18 . -45) (nil fontified t 54453 . 54454) (nil fontified t 54452 . 54453) (nil fontified t 54454 . 54468) (nil fontified t 54468 . 54486) (nil rear-nonsticky t 54499 . 54500)) (26797 32269 587619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 54505 . 54506) (nil fontified nil 54492 . 54506) (nil fontified nil 54474 . 54492) (nil fontified nil 54460 . 54474) (nil fontified nil 54458 . 54460) (nil fontified nil 54454 . 54458) (nil fontified nil 54447 . 54454) (54447 . 54506)) nil (26797 32282 121367 0) 0 nil])
nil
([nil nil ((#("
(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\"))
  (lambda (next)
    (lambda (req)
      ;; s'assurer qu'on a une session (middleware session avant csrf)
      (let* ((m  (lumen.core.http:req-method req))
             (ok (member m methods :test #'string=))
             (tok (or (lumen.core.session:session-get req :csrf)
                      (let ((tkn (%random-token)))
                        (lumen.core.session:session-set! req :csrf tkn) tkn))))
	
        ;; dÃ©poser/rafraÃ®chir le cookie token (lecture cÃ´tÃ© front)
        (let ((resp (funcall next req)))
          (set-cookie! resp cookie-name tok :path path :http-only nil)
          (if (not ok)
              resp
              (let* ((hdr (lumen.core.http:req-headers req))
                     (hdr-tok (lumen.utils:alist-get hdr header-name))
                     (form (lumen.core.http:ctx-get req :form))
                     (field-tok (lumen.utils:alist-get form \"csrf_token\"
						       :test #'string=))
                     (match (or (and hdr-tok (string= hdr-tok tok))
                                (and field-tok (string= field-tok tok)))))
		
                (if match
                    resp
                    (lumen.core.http:respond-json
                     '((:error . ((:type . \"csrf\")
				  (:message . \"invalid or missing CSRF token\"))))
                     :status 403)))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 14 (fontified t) 14 18 (face font-lock-type-face fontified t) 18 32 (fontified t) 32 44 (face font-lock-string-face fontified t) 44 77 (fontified t) 77 91 (face font-lock-string-face fontified t) 91 122 (fontified t) 122 128 (face font-lock-string-face fontified t) 128 129 (fontified t) 129 134 (face font-lock-string-face fontified t) 134 135 (fontified t) 135 142 (face font-lock-string-face fontified t) 142 143 (fontified t) 143 151 (face font-lock-string-face fontified t) 151 178 (fontified t) 178 181 (face font-lock-string-face fontified t) 181 187 (fontified t) 187 193 (face font-lock-keyword-face fontified t) 193 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 225 (fontified t) 225 228 (face font-lock-comment-delimiter-face fontified t) 228 290 (face font-lock-comment-face fontified t) 290 297 (fontified t) 297 301 (face font-lock-keyword-face fontified t) 301 376 (fontified t) 376 381 (face font-lock-builtin-face fontified t) 381 452 (fontified t) 452 457 (face font-lock-builtin-face fontified t) 457 482 (fontified t) 482 485 (face font-lock-keyword-face fontified t) 485 510 (fontified t) 510 571 (fontified t) 571 576 (face font-lock-builtin-face fontified t) 576 590 (fontified t) 590 591 (fontified t) 591 592 (fontified t) 592 600 (fontified t) 600 603 (face font-lock-comment-delimiter-face fontified t) 603 659 (face font-lock-comment-face fontified t) 659 668 (fontified t) 668 671 (face font-lock-keyword-face fontified t) 671 744 (fontified t) 744 749 (face font-lock-builtin-face fontified t) 749 755 (fontified t) 755 765 (face font-lock-builtin-face fontified t) 765 782 (fontified t) 782 784 (face font-lock-keyword-face fontified t) 784 828 (fontified t) 828 832 (face font-lock-keyword-face fontified t) 832 1001 (fontified t) 1001 1006 (face font-lock-builtin-face fontified t) 1006 1035 (fontified t) 1035 1069 (fontified t) 1069 1081 (face font-lock-string-face fontified t) 1081 1082 (fontified t) 1082 1095 (fontified t) 1095 1100 (face font-lock-builtin-face fontified t) 1100 1181 (fontified t) 1181 1256 (fontified t) 1256 1258 (fontified t) 1258 1259 (fontified t) 1259 1276 (fontified t) 1276 1278 (fontified t face font-lock-keyword-face) 1278 1384 (fontified t) 1384 1390 (fontified t face font-lock-builtin-face) 1390 1395 (fontified t) 1395 1400 (fontified t face font-lock-builtin-face) 1400 1403 (fontified t) 1403 1409 (fontified t face font-lock-string-face) 1409 1418 (fontified t) 1418 1426 (fontified t face font-lock-builtin-face) 1426 1429 (fontified t) 1429 1460 (fontified t face font-lock-string-face) 1460 1465 (fontified t) 1465 1485 (fontified t) 1485 1486 (fontified t) 1486 1493 (face font-lock-builtin-face fontified t) 1493 1505 (fontified t) 1505 1506 (fontified t)) . 51715) (undo-tree-id19 . -1506) (undo-tree-id20 . -340) (undo-tree-id21 . -416) (undo-tree-id22 . -1154) (undo-tree-id23 . -591) (undo-tree-id24 . -1258) (undo-tree-id25 . -1) (undo-tree-id26 . -1465) (undo-tree-id27 . -1506) (undo-tree-id28 . -1506) (undo-tree-id29 . -1506) (undo-tree-id30 . -1506) (undo-tree-id31 . -200) (undo-tree-id32 . -200) (undo-tree-id33 . -200) (undo-tree-id34 . -200) (undo-tree-id35 . -200) (undo-tree-id36 . -200) (undo-tree-id37 . -109)) nil (26797 32282 121365 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 51715)) nil (26797 32282 121339 0) 0 nil])
([nil nil ((52253 . 52255) (t 26797 32282 0 0)) nil (26797 32308 60258 0) 0 nil])
([nil nil ((52342 . 52344)) nil (26797 32308 60256 0) 0 nil])
([nil nil ((52347 . 52349)) nil (26797 32308 60253 0) 0 nil])
([nil nil ((53586 . 53588) (t 26797 32308 0 0)) nil (26797 33048 286642 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55755 . 55756) (nil fontified nil 53588 . 55756) (53588 . 55756)) nil (26797 33048 286642 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -55755) (undo-tree-id50 . -1) 55756) nil (26797 33048 286641 0) 0 nil])
([nil nil ((#("(print method)
	(print mut?)
	(print (lumen.core.session:session-get req :csrf))
	(print tok)" 0 7 (fontified t) 7 12 (fontified t) 12 13 (fontified t rear-nonsticky t) 13 15 (fontified t) 15 29 (fontified t) 29 37 (fontified t) 37 73 (fontified t) 73 78 (face font-lock-builtin-face fontified t) 78 79 (fontified t rear-nonsticky t) 79 80 (fontified t) 80 81 (fontified t) 81 92 (fontified t) 92 93 (fontified t rear-nonsticky t)) . 52355) (undo-tree-id49 . -93) 52448) nil (26797 33048 286640 0) 0 nil])
([nil nil ((54136 . 54138)) nil (26797 33048 286639 0) 0 nil])
([nil nil ((nil fontified nil 54230 . 54231) (nil fontified nil 54219 . 54230) (nil fontified nil 54218 . 54219) (nil fontified nil 54217 . 54218) (nil fontified nil 54216 . 54217) (nil fontified nil 54211 . 54216) (nil fontified nil 54175 . 54211) (nil fontified nil 54167 . 54175) (nil fontified nil 54153 . 54167) (nil fontified nil 54151 . 54153) (nil fontified nil 54150 . 54151) (nil fontified nil 54145 . 54150) (nil fontified nil 54138 . 54145) (54138 . 54231)) nil (26797 33048 286638 0) 0 nil])
([nil nil ((54129 . 54131)) nil (26797 33048 286636 0) 0 nil])
([nil nil ((54134 . 54136)) nil (26797 33048 286636 0) 0 nil])
([nil nil ((54042 . 54044)) nil (26797 33048 286635 0) 0 nil])
([nil nil ((#("(print \"OK\")
		(print hdr)
		(print hdr-tok)
		(print form)" 0 7 (fontified t) 7 11 (fontified t face font-lock-string-face) 11 13 (fontified t) 13 27 (fontified t) 27 45 (fontified t) 45 58 (fontified t) 58 59 (fontified t rear-nonsticky t)) . 52853) (undo-tree-id48 . -59) 52912) nil (26797 33048 286634 0) 0 nil])
([nil nil ((54708 . 54716)) nil (26797 33048 286633 0) 0 nil])
([nil nil ((nil fontified nil 54774 . 54775) (nil fontified nil 54761 . 54774) (nil fontified nil 54743 . 54761) (nil fontified nil 54729 . 54743) (nil fontified nil 54727 . 54729) (nil fontified nil 54723 . 54727) (nil fontified nil 54716 . 54723) (54716 . 54775)) nil (26797 33048 286632 0) 0 nil])
([nil nil ((#("
(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\"))
  (lambda (next)
    (lambda (req)
      ;; Assure session (middleware :session doit Ãªtre avant)
      (let* ((method (lumen.core.http:req-method req))
             (mut?   (member method methods :test #'string=))
             ;; token en session ou crÃ©ation
             (tok (or (lumen.core.session:session-get req :csrf)
                      (let ((tkn (%random-token)))
                        (lumen.core.session:session-set! req :csrf tkn) tkn))))
	
        ;; 1) VÃ©rifier AVANT dâ€™appeler next si mÃ©thode mutable
        (when mut?
          (let* ((hdr (lumen.core.http:req-headers req))
                 (hdr-tok (cdr (assoc header-name hdr :test #'string-equal)))
                 (form    (lumen.core.http:ctx-get req :form))
                 (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                 (match (or (and hdr-tok (string= hdr-tok tok))
                            (and field-tok (string= field-tok tok)))))
	    
            (unless match
              (return-from csrf
                (lambda (_req)
                  (declare (ignore _req))
                  (lumen.core.http:respond-json
                   '((:error . ((:type . \"csrf\")
                                (:message . \"invalid or missing CSRF token\"))))
                   :status 403))))))

        ;; 2) Appeler le handler
        (let ((resp (funcall next req)))
          ;; 3) Poser/rafraÃ®chir le cookie CSRF (lisible cÃ´tÃ© client)
          (set-cookie! resp cookie-name tok :path path :http-only nil)
          resp)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 14 (fontified t) 14 18 (face font-lock-type-face fontified t) 18 32 (fontified t) 32 44 (face font-lock-string-face fontified t) 44 77 (fontified t) 77 91 (face font-lock-string-face fontified t) 91 122 (fontified t) 122 128 (face font-lock-string-face fontified t) 128 129 (fontified t) 129 134 (face font-lock-string-face fontified t) 134 135 (fontified t) 135 142 (face font-lock-string-face fontified t) 142 143 (fontified t) 143 151 (face font-lock-string-face fontified t) 151 178 (fontified t) 178 181 (face font-lock-string-face fontified t) 181 187 (fontified t) 187 193 (face font-lock-keyword-face fontified t) 193 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 225 (fontified t) 225 228 (face font-lock-comment-delimiter-face fontified t) 228 281 (face font-lock-comment-face fontified t) 281 288 (fontified t) 288 292 (face font-lock-keyword-face fontified t) 292 380 (fontified t) 380 385 (face font-lock-builtin-face fontified t) 385 411 (fontified t) 411 414 (face font-lock-comment-delimiter-face fontified t) 414 443 (face font-lock-comment-face fontified t) 443 501 (fontified t) 501 506 (face font-lock-builtin-face fontified t) 506 508 (fontified t) 508 531 (fontified t) 531 534 (face font-lock-keyword-face fontified t) 534 559 (fontified t) 559 620 (fontified t) 620 625 (face font-lock-builtin-face fontified t) 625 639 (fontified t) 639 640 (fontified t) 640 641 (fontified t) 641 649 (fontified t) 649 652 (face font-lock-comment-delimiter-face fontified t) 652 704 (face font-lock-comment-face fontified t) 704 713 (fontified t) 713 717 (face font-lock-keyword-face fontified t) 717 734 (fontified t) 734 738 (face font-lock-keyword-face fontified t) 738 834 (fontified t) 834 839 (face font-lock-builtin-face fontified t) 839 913 (fontified t) 913 918 (face font-lock-builtin-face fontified t) 918 961 (fontified t) 961 973 (face font-lock-string-face fontified t) 973 979 (fontified t) 979 984 (face font-lock-builtin-face fontified t) 984 1062 (fontified t) 1062 1123 (fontified t) 1123 1133 (fontified t) 1133 1138 (fontified t) 1138 1139 (fontified t) 1139 1152 (fontified t) 1152 1158 (fontified t face font-lock-keyword-face) 1158 1180 (fontified t) 1180 1191 (fontified t face font-lock-keyword-face) 1191 1214 (fontified t) 1214 1220 (fontified t face font-lock-keyword-face) 1220 1247 (fontified t) 1247 1254 (fontified t face font-lock-keyword-face) 1254 1340 (fontified t) 1340 1346 (fontified t face font-lock-builtin-face) 1346 1351 (fontified t) 1351 1354 (fontified t face font-lock-builtin-face) 1354 1355 (fontified t face font-lock-builtin-face) 1355 1356 (fontified t face font-lock-builtin-face) 1356 1359 (fontified t) 1359 1365 (fontified t face font-lock-string-face) 1365 1367 (fontified t) 1367 1400 (fontified t) 1400 1408 (fontified t face font-lock-builtin-face) 1408 1411 (fontified t) 1411 1420 (fontified t face font-lock-string-face) 1420 1442 (fontified t face font-lock-string-face) 1442 1447 (fontified t) 1447 1466 (fontified t) 1466 1473 (fontified t face font-lock-builtin-face) 1473 1493 (fontified t) 1493 1496 (fontified t face font-lock-comment-delimiter-face) 1496 1515 (fontified t face font-lock-comment-face) 1515 1518 (fontified t face font-lock-comment-face) 1518 1527 (fontified t) 1527 1530 (fontified t face font-lock-keyword-face) 1530 1569 (fontified t) 1569 1572 (fontified t face font-lock-comment-delimiter-face) 1572 1629 (fontified t face font-lock-comment-face) 1629 1673 (fontified t) 1673 1678 (face font-lock-builtin-face fontified t) 1678 1684 (fontified t) 1684 1694 (face font-lock-builtin-face fontified t) 1694 1700 (fontified t) 1700 1719 (fontified t)) . 51715) (undo-tree-id38 . -1719) (undo-tree-id39 . -1) (undo-tree-id40 . -295) (undo-tree-id41 . -1132) (undo-tree-id42 . -634) (undo-tree-id43 . -537) (undo-tree-id44 . -538) (undo-tree-id45 . -640) (undo-tree-id46 . -1138) (undo-tree-id47 . -1719)) nil (26797 33048 286630 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 51715)) nil (26797 33048 286612 0) 0 nil])
([nil nil ((52676 . 52682) (t 26797 33048 0 0)) nil (26797 34997 996484 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 53017 . 53018) (nil fontified nil 52682 . 53018) (52682 . 53018)) nil (26797 34997 996483 0) 0 nil])
([nil nil ((#("
                   (hdr-tok (cdr (assoc header-name hdr :test #'string-equal)))" 0 1 (fontified t) 1 57 (fontified t) 57 62 (face font-lock-builtin-face fontified t) 62 80 (fontified t)) . 52596) (undo-tree-id62 . -80)) nil (26797 34997 996483 0) 0 nil])
([nil nil ((#("	" 0 1 (fontified nil)) . -53275) (53275 . 53276) (#("	" 0 1 (fontified nil)) . 53275) (53269 . 53275) (#("	" 0 1 (fontified nil)) . -53252) (53252 . 53253) (#("	" 0 1 (fontified nil)) . 53252) (53246 . 53252) (#("	" 0 1 (fontified nil)) . -53233) (53233 . 53234) (#("	" 0 1 (fontified nil)) . 53233) (53227 . 53233) (52880 . 52884) (#("                    " 0 20 (fontified t)) . 52880) (52800 . 52804) (#("                    " 0 20 (fontified t)) . 52800) (52738 . 52743) (#("       " 0 7 (fontified t)) . 52738) (52654 . 52659) (#("       " 0 7 (fontified t)) . 52654) (#("   " 0 3 (fontified t)) . -51878) (#("   " 0 3 (fontified t)) . -51820) (#("   " 0 3 (fontified t)) . -51776) 51716) nil (26797 34997 996481 0) 0 nil])
([nil nil ((51714 . 51716)) nil (26797 34997 996479 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 54911 . 54912) (nil fontified nil 51716 . 54912) (51716 . 54912)) nil (26797 34997 996478 0) 0 nil])
([nil nil ((#("

(defun csrf (&key (cookie-name \"csrf_token\")
               (header-name \"x-csrf-token\")
               (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
               (path \"/\"))
  (lambda (next)
    (lambda (req)
      ;; (1) session requise (middleware :session doit Ãªtre avant)
      (let* ((method (lumen.core.http:req-method req))
             (mut?   (member method methods :test #'string=))
             ;; token en session (crÃ©Ã© si absent)
             (tok (or (lumen.core.session:session-get req :csrf)
                      (let ((tkn (%random-token)))
                        (lumen.core.session:session-set! req :csrf tkn) tkn))))
	(print method)
	(print mut?)
	(print (lumen.core.session:session-get req :csrf))
	(print tok)
        (if mut?
            ;; MÃ©thode mutable â†’ valider AVANT d'appeler next
            (let* ((hdr (lumen.core.http:req-headers req))
		   (hdr-raw (cdr (assoc header-name hdr :test #'string-equal)))
		   ;; si le header vaut \"csrf_token\", on va lire la vraie valeur dans les cookies
		   (hdr-tok (if (and hdr-raw (string= hdr-raw cookie-name))
				(cdr (assoc cookie-name (lumen.core.http:req-cookies req) :test #'string=))
				hdr-raw))
                   (form    (lumen.core.http:ctx-get req :form)) ; nÃ©cessite form-parser AVANT csrf
                   (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                   (ok (or (and hdr-tok (string= hdr-tok tok))
                           (and field-tok (string= field-tok tok)))))
	      (print \"OK\")
	      (print hdr)
	      (print hdr-tok)
	      (print form)
              (if ok
                  (let ((resp (funcall next req)))
                    ;; RafraÃ®chir/exposer le cookie cÃ´tÃ© client
                    (set-cookie! resp cookie-name tok :path path :http-only nil)
                    resp)
                  ;; Token manquant/incorrect â†’ 403 immÃ©diat (sans RETURN-FROM)
                  (let ((resp (lumen.core.http:respond-json
                               '((:error . ((:type . \"csrf\")
                                            (:message . \"invalid or missing CSRF token\"))))
                               :status 403)))
                    ;; On en profite pour (rÃ©)Ã©mettre le cookie pour que le client lâ€™ait
                    (set-cookie! resp cookie-name tok :path path :http-only nil)
                    resp)))
            ;; MÃ©thode non mutable â†’ laisser passer et poser le cookie
            (let ((resp (funcall next req)))
              (set-cookie! resp cookie-name tok :path path :http-only nil)
              resp))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 13 (face font-lock-function-name-face fontified t) 13 15 (fontified t) 15 19 (face font-lock-type-face fontified t) 19 33 (fontified t) 33 45 (face font-lock-string-face fontified t) 45 47 (fontified t) 47 75 (fontified t) 75 89 (face font-lock-string-face fontified t) 89 91 (fontified t) 91 117 (fontified t) 117 123 (face font-lock-string-face fontified t) 123 124 (fontified t) 124 129 (face font-lock-string-face fontified t) 129 130 (fontified t) 130 137 (face font-lock-string-face fontified t) 137 138 (fontified t) 138 146 (face font-lock-string-face fontified t) 146 149 (fontified t) 149 170 (fontified t) 170 173 (face font-lock-string-face fontified t) 173 176 (fontified t) 176 179 (fontified t) 179 185 (face font-lock-keyword-face fontified t) 185 198 (fontified t) 198 204 (face font-lock-keyword-face fontified t) 204 217 (fontified t) 217 220 (face font-lock-comment-delimiter-face fontified t) 220 278 (face font-lock-comment-face fontified t) 278 285 (fontified t) 285 289 (face font-lock-keyword-face fontified t) 289 377 (fontified t) 377 382 (face font-lock-builtin-face fontified t) 382 408 (fontified t) 408 411 (face font-lock-comment-delimiter-face fontified t) 411 445 (face font-lock-comment-face fontified t) 445 503 (fontified t) 503 508 (face font-lock-builtin-face fontified t) 508 510 (fontified t) 510 533 (fontified t) 533 536 (face font-lock-keyword-face fontified t) 536 561 (fontified t) 561 622 (fontified t) 622 627 (face font-lock-builtin-face fontified t) 627 641 (fontified t) 641 642 (fontified t) 642 649 (fontified t) 649 654 (fontified t) 654 655 (fontified t rear-nonsticky t) 655 657 (fontified t) 657 671 (fontified t) 671 679 (fontified t) 679 715 (fontified t) 715 720 (face font-lock-builtin-face fontified t) 720 721 (fontified t rear-nonsticky t) 721 722 (fontified t) 722 723 (fontified t) 723 734 (fontified t) 734 735 (fontified t rear-nonsticky t) 735 736 (fontified t) 736 745 (fontified t) 745 747 (face font-lock-keyword-face fontified t) 747 765 (fontified t) 765 768 (face font-lock-comment-delimiter-face fontified t) 768 815 (face font-lock-comment-face fontified t) 815 828 (fontified t) 828 832 (face font-lock-keyword-face fontified t) 832 873 (fontified t) 873 874 (fontified t) 874 879 (fontified t) 879 916 (fontified t) 916 921 (face font-lock-builtin-face fontified t) 921 940 (fontified t) 940 945 (fontified t) 945 948 (face font-lock-comment-delimiter-face fontified t) 948 1024 (face font-lock-comment-face fontified t) 1024 1029 (fontified t) 1029 1039 (fontified t) 1039 1041 (face font-lock-keyword-face fontified t) 1041 1090 (fontified t) 1090 1148 (fontified t) 1148 1153 (face font-lock-builtin-face fontified t) 1153 1170 (fontified t) 1170 1178 (fontified t) 1178 1179 (fontified t rear-nonsticky t) 1179 1180 (fontified t) 1180 1191 (fontified t) 1191 1237 (fontified t) 1237 1242 (face font-lock-builtin-face fontified t) 1242 1245 (fontified t) 1245 1280 (face font-lock-comment-face fontified t) 1280 1322 (fontified t) 1322 1334 (face font-lock-string-face fontified t) 1334 1340 (fontified t) 1340 1345 (face font-lock-builtin-face fontified t) 1345 1422 (fontified t) 1422 1492 (fontified t) 1492 1499 (fontified t) 1499 1501 (fontified t) 1501 1506 (fontified t) 1506 1510 (face font-lock-string-face fontified t) 1510 1512 (fontified t) 1512 1531 (fontified t) 1531 1547 (fontified t) 1547 1554 (fontified t) 1554 1572 (fontified t) 1572 1573 (fontified t rear-nonsticky t) 1573 1574 (fontified t) 1574 1589 (fontified t) 1589 1591 (face font-lock-keyword-face fontified t) 1591 1614 (fontified t) 1614 1617 (face font-lock-keyword-face fontified t) 1617 1666 (fontified t) 1666 1669 (face font-lock-comment-delimiter-face fontified t) 1669 1710 (face font-lock-comment-face fontified t) 1710 1734 (fontified t) 1734 1764 (fontified t) 1764 1769 (face font-lock-builtin-face fontified t) 1769 1775 (fontified t) 1775 1785 (face font-lock-builtin-face fontified t) 1785 1791 (fontified t) 1791 1835 (fontified t) 1835 1838 (face font-lock-comment-delimiter-face fontified t) 1838 1897 (face font-lock-comment-face fontified t) 1897 1902 (fontified t) 1902 1916 (fontified t) 1916 1919 (face font-lock-keyword-face fontified t) 1919 1957 (fontified t) 1957 1991 (fontified t) 1991 1997 (face font-lock-builtin-face fontified t) 1997 2002 (fontified t) 2002 2007 (face font-lock-builtin-face fontified t) 2007 2010 (fontified t) 2010 2016 (face font-lock-string-face fontified t) 2016 2063 (fontified t) 2063 2071 (face font-lock-builtin-face fontified t) 2071 2074 (fontified t) 2074 2105 (face font-lock-string-face fontified t) 2105 2141 (fontified t) 2141 2148 (face font-lock-builtin-face fontified t) 2148 2176 (fontified t) 2176 2179 (face font-lock-comment-delimiter-face fontified t) 2179 2245 (face font-lock-comment-face fontified t) 2245 2299 (fontified t) 2299 2304 (face font-lock-builtin-face fontified t) 2304 2310 (fontified t) 2310 2320 (face font-lock-builtin-face fontified t) 2320 2353 (fontified t) 2353 2354 (fontified t) 2354 2366 (fontified t) 2366 2369 (face font-lock-comment-delimiter-face fontified t) 2369 2425 (face font-lock-comment-face fontified t) 2425 2438 (fontified t) 2438 2441 (face font-lock-keyword-face fontified t) 2441 2449 (fontified t) 2449 2466 (fontified t) 2466 2470 (fontified t) 2470 2518 (fontified t) 2518 2523 (face font-lock-builtin-face fontified t) 2523 2529 (fontified t) 2529 2539 (face font-lock-builtin-face fontified t) 2539 2544 (fontified t) 2544 2545 (fontified t) 2545 2569 (fontified t) 2569 2570 (fontified t)) . -54912) (undo-tree-id58 . -1) (undo-tree-id59 . -1422) (undo-tree-id60 . -817) (undo-tree-id61 . -2570) 57482) nil (26797 34997 996477 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -54911) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) 54912) nil (26797 34997 996475 0) 0 nil])
([nil nil ((54911 . 54914)) nil (26797 34997 996472 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -54911) (undo-tree-id51 . -1) (#(" " 0 1 (fontified t)) . -54912) (undo-tree-id52 . -1) (#(" " 0 1 (fontified t)) . -54913) (undo-tree-id53 . -1) 54914) nil (26797 34997 996470 0) 0 nil])
([nil nil ((54911 . 54914)) nil (26797 34997 996459 0) 0 nil])
([nil nil ((54911 . 54912)) nil (26797 34997 996456 0) 0 nil])
([nil nil ((53030 . 53032) (t 26797 34997 0 0)) nil (26797 35117 138133 0) 0 nil])
([nil nil ((53121 . 53123)) nil (26797 35117 138132 0) 0 nil])
([nil nil ((53126 . 53128)) nil (26797 35117 138129 0) 0 nil])
([nil nil ((55661 . 55662) (t 26797 35117 0 0)) nil (26797 52679 701880 0) 0 nil])
([nil nil ((55662 . 55665)) nil (26797 52679 701879 0) 0 nil])
([nil nil ((55665 . 55666)) nil (26797 52679 701878 0) 0 nil])
([nil nil ((55666 . 55671)) nil (26797 52679 701878 0) 0 nil])
([nil nil ((55671 . 55672)) nil (26797 52679 701877 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60323 . 60324) (nil fontified nil 55672 . 60324) (55672 . 60324)) nil (26797 52679 701877 0) 0 nil])
([nil nil ((1130 . 1135)) nil (26797 52679 701876 0) 0 nil])
([nil nil ((1135 . 1136)) nil (26797 52679 701876 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1149 . 1150) (nil fontified nil 1136 . 1150) (1136 . 1150)) nil (26797 52679 701875 0) 0 nil])
([nil nil ((60344 . 60345)) nil (26797 52679 701871 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -59757) (t 26797 52679 0 0) (59772 . 59783) (t 26797 52679 0 0)) nil (26797 52804 417407 0) 0 nil])
([nil nil ((#("(getf " 0 6 (fontified t)) . -30852) (undo-tree-id64 . -6) 30858 (t 26797 52804 0 0)) nil (26797 53018 767051 0) 0 nil])
([nil nil ((#("req" 0 3 (fontified t)) . -30869) (undo-tree-id63 . -3) 30872) nil (26797 53018 767047 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . 30869)) nil (26797 53018 767032 0) 0 nil])
([nil nil ((30872 . 30876)) nil (26797 53018 767030 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . 30880)) nil (26797 53018 767024 0) 0 nil])
([nil nil ((60334 . 60335) (t 26797 53018 0 0)) nil (26798 52308 232495 0) 0 nil])
([nil nil ((60335 . 60338)) nil (26798 52308 232494 0) 0 nil])
([nil nil ((60338 . 60339)) nil (26798 52308 232493 0) 0 nil])
([nil nil ((60339 . 60340)) nil (26798 52308 232493 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-comment-face fontified t)) . -60339) (undo-tree-id117 . -1) 60340) nil (26798 52308 232493 0) 0 nil])
([nil nil ((60339 . 60343)) nil (26798 52308 232492 0) 0 nil])
([nil nil ((60343 . 60344)) nil (26798 52308 232491 0) 0 nil])
([nil nil ((60344 . 60347)) nil (26798 52308 232491 0) 0 nil])
([nil nil ((60347 . 60348)) nil (26798 52308 232491 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 61361 . 61362) (nil fontified nil 60348 . 61362) (60348 . 61362)) nil (26798 52308 232490 0) 0 nil])
([nil nil ((#("U" 0 1 (face font-lock-comment-face fontified t)) . 60340)) nil (26798 52308 232490 0) 0 nil])
([nil nil ((60340 . 60341)) nil (26798 52308 232489 0) 0 nil])
([nil nil ((60568 . 60573) (60474 . 60477) (60452 . 60455) (60407 . 60413) (60389 . 60393) (60372 . 60374) 60348) nil (26798 52308 232489 0) 0 nil])
([nil nil ((60891 . 60896) (60867 . 60872) (60810 . 60811) (60716 . 60722) (60662 . 60668) (60644 . 60648) (60627 . 60629) 60592) nil (26798 52308 232488 0) 0 nil])
([nil nil ((60537 . 60548) (#(" " 0 1 (fontified nil)) . 60536) (undo-tree-id116 . -1) (60537 . 60538)) nil (26798 52308 232487 0) 0 nil])
([nil nil ((60776 . 60780) (#(" " 0 1 (fontified nil)) . 60775) (undo-tree-id115 . -1) (60776 . 60777)) nil (26798 52308 232485 0) 0 nil])
([nil nil ((60971 . 60984) (#(" " 0 1 (fontified nil)) . 60970) (undo-tree-id114 . -1) (60971 . 60972)) nil (26798 52308 232484 0) 0 nil])
([nil nil ((61012 . 61019) (#(" " 0 1 (fontified nil)) . 61012) (61011 . 61012)) nil (26798 52308 232483 0) 0 nil])
([nil nil ((61362 . 61367) (61338 . 61343) (61286 . 61289) (61263 . 61264) (61165 . 61171) (61111 . 61117) (61093 . 61097) (61076 . 61078) 61039) nil (26798 52308 232482 0) 0 nil])
([nil nil ((61216 . 61220) (#(" " 0 1 (fontified nil)) . 61215) (undo-tree-id113 . -1) (61216 . 61217)) nil (26798 52308 232481 0) 0 nil])
([nil nil ((61431 . 61444) (#(" " 0 1 (fontified nil)) . 61430) (undo-tree-id112 . -1) (61431 . 61432)) nil (26798 52308 232480 0) 0 nil])
([nil nil ((61481 . 61488) (#(" " 0 1 (fontified nil)) . 61480) (undo-tree-id111 . -1) (61481 . 61482)) nil (26798 52308 232479 0) 0 nil])
([nil nil ((61505 . 61507)) nil (26798 52308 232478 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62884 . 62885) (nil fontified nil 61507 . 62885) (61507 . 62885)) nil (26798 52308 232477 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -61711) (undo-tree-id110 . -1) 61712) nil (26798 52308 232477 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -61760) (undo-tree-id109 . -1) 61761) nil (26798 52308 232476 0) 0 nil])
([nil nil ((62203 . 62204)) nil (26798 52308 232475 0) 0 nil])
([nil nil ((62179 . 62180) (62168 . 62176) (62123 . 62131) (62070 . 62071) (62049 . 62053) (61958 . 61966) (61929 . 61931) (61904 . 61906) (61864 . 61866) (61805 . 61807) (61783 . 61785) 61761) nil (26798 52308 232474 0) 0 nil])
([nil nil ((62237 . 62245) (#(" " 0 1 (fontified nil)) . 62237) (62236 . 62237)) nil (26798 52308 232473 0) 0 nil])
([nil nil ((62218 . 62225) (#(" " 0 1 (fontified nil)) . 62217) (undo-tree-id108 . -1) (62218 . 62219)) nil (26798 52308 232472 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -62260) (undo-tree-id107 . -1) 62261) nil (26798 52308 232471 0) 0 nil])
([nil nil ((62570 . 62575) (62546 . 62551) (62516 . 62517) (62476 . 62482) (62458 . 62462) (62441 . 62443) (62352 . 62354) 62261) nil (26798 52308 232469 0) 0 nil])
([nil nil ((62641 . 62654) (#(" " 0 1 (fontified nil)) . 62640) (undo-tree-id106 . -1) (62641 . 62642)) nil (26798 52308 232468 0) 0 nil])
([nil nil ((62690 . 62697) (#(" " 0 1 (fontified nil)) . 62689) (undo-tree-id105 . -1) (62690 . 62691)) nil (26798 52308 232467 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -62714) (undo-tree-id104 . -1) 62715) nil (26798 52308 232465 0) 0 nil])
([nil nil ((62881 . 62887) (62832 . 62838) (62739 . 62741) 62716) nil (26798 52308 232464 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -62746) (undo-tree-id103 . -10) 62756) nil (26798 52308 232463 0) 0 nil])
([nil nil ((62746 . 62748)) nil (26798 52308 232462 0) 0 nil])
([nil nil ((#("l" 0 1 (fontified t)) . -62746) (undo-tree-id101 . -1) (#("=" 0 1 (fontified t)) . -62747) (undo-tree-id102 . -1) 62748) nil (26798 52308 232462 0) 0 nil])
([nil nil ((62746 . 62755)) nil (26798 52308 232460 0) 0 nil])
([nil nil ((62746 . 62748)) nil (26798 52308 232460 0) 0 nil])
([nil nil ((62748 . 62751)) nil (26798 52308 232459 0) 0 nil])
([nil nil ((#("m" 0 1 (fontified t)) . -62746) (undo-tree-id96 . -1) (#("u" 0 1 (fontified t)) . -62747) (undo-tree-id97 . -1) (#("m" 0 1 (fontified t)) . -62748) (undo-tree-id98 . -1) (#("e" 0 1 (fontified t)) . -62749) (undo-tree-id99 . -1) (#("n" 0 1 (fontified t)) . -62750) (undo-tree-id100 . -1) 62751) nil (26798 52308 232458 0) 0 nil])
([nil nil ((62746 . 62748)) nil (26798 52308 232455 0) 0 nil])
([nil nil ((#("L" 0 1 (fontified t)) . -62746) (undo-tree-id94 . -1) (#("u" 0 1 (fontified t)) . -62747) (undo-tree-id95 . -1) 62748) nil (26798 52308 232455 0) 0 nil])
([nil nil ((62746 . 62750)) nil (26798 52308 232453 0) 0 nil])
([nil nil ((#("Ã¹" 0 1 (fontified t)) . -62748) (undo-tree-id92 . -1) (#("e" 0 1 (fontified t)) . -62749) (undo-tree-id93 . -1) 62750) nil (26798 52308 232452 0) 0 nil])
([nil nil ((62748 . 62752)) nil (26798 52308 232451 0) 0 nil])
([nil nil ((#("Ã¹" 0 1 (fontified t)) . -62748) (undo-tree-id88 . -1) (#("e" 0 1 (fontified t)) . -62749) (undo-tree-id89 . -1) (#("n" 0 1 (fontified t)) . -62750) (undo-tree-id90 . -1) (#("." 0 1 (fontified t)) . -62751) (undo-tree-id91 . -1) 62752) nil (26798 52308 232450 0) 0 nil])
([nil nil ((62748 . 62750)) nil (26798 52308 232447 0) 0 nil])
([nil nil ((62750 . 62752)) nil (26798 52308 232447 0) 0 nil])
([nil nil ((#("?" 0 1 (fontified t)) . -62751) (undo-tree-id87 . -1) 62752) nil (26798 52308 232446 0) 0 nil])
([nil nil ((62751 . 62758)) nil (26798 52308 232445 0) 0 nil])
([nil nil ((#("\"x-forwarded-for\"" 0 17 (face font-lock-string-face fontified t)) . 62768) (undo-tree-id86 . -17) 62785) nil (26798 52308 232445 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -62767) (undo-tree-id84 . -1) (undo-tree-id85 . -1) 62768) nil (26798 52308 232443 0) 0 nil])
([nil nil ((62801 . 62802)) nil (26798 52308 232441 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62818 . 62819) (nil fontified nil 62802 . 62819) (62802 . 62819)) nil (26798 52308 232440 0) 0 nil])
([nil nil ((#(" :test #'string-equal" 0 1 (fontified t) 1 6 (face font-lock-builtin-face fontified t) 6 21 (fontified t)) . -62819) (undo-tree-id83 . -21) 62840) nil (26798 52308 232439 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -62820) (undo-tree-id82 . -1) 62821) nil (26798 52308 232438 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 62887)) nil (26798 52308 232437 0) 0 nil])
([nil nil ((62916 . 62918) 62889) nil (26798 52308 232436 0) 0 nil])
([nil nil ((62944 . 62946) (#(" " 0 1 (fontified nil)) . 62943) (undo-tree-id81 . -1) (62944 . 62945)) nil (26798 52308 232435 0) 0 nil])
([nil nil ((54950 . 54951)) nil (26798 52308 232434 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 57191 . 57192) (nil fontified nil 54951 . 57192) (54951 . 57192)) nil (26798 52308 232571 0) 0 nil])
([nil nil ((55569 . 55573)) nil (26798 52392 846529 0) 0 nil] [nil nil ((#("
(defun auth-jwt (&key (secret \"change-me\") (header \"authorization\") (prefix \"Bearer \"))
  \"Extrait Authorization: Bearer <jwt> et place :jwt (payload) dans req-ctx si valide.\"
  (lambda (next)
    (lambda (req)
      (let* ((hdrs (lumen.core.http:req-headers req))
             (raw  (cdr (assoc header hdrs :test #'string-equal)))
             (tok  (and raw (lumen.utils:str-prefix-p prefix raw)
                        (subseq raw (length prefix)))))
        (when tok
          (multiple-value-bind (payload _)
              (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
            (declare (ignore _))
            (when payload (lumen.core.http:ctx-set! req :jwt payload))))
        (funcall next req)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 31 (fontified t) 31 42 (face font-lock-string-face fontified t) 42 52 (fontified t) 52 67 (face font-lock-string-face fontified t) 67 77 (fontified t) 77 86 (face font-lock-string-face fontified t) 86 91 (fontified t) 91 109 (face font-lock-doc-face fontified t) 109 175 (face font-lock-doc-face fontified t) 175 176 (face font-lock-doc-face fontified t) 176 177 (fontified t) 177 180 (fontified t) 180 186 (face font-lock-keyword-face fontified t) 186 194 (fontified t) 194 199 (fontified t) 199 205 (face font-lock-keyword-face fontified t) 205 219 (fontified t) 219 223 (face font-lock-keyword-face fontified t) 223 251 (fontified t) 251 266 (fontified t) 266 309 (fontified t) 309 314 (face font-lock-builtin-face fontified t) 314 334 (fontified t) 334 346 (fontified t) 346 399 (fontified t) 399 411 (fontified t) 411 418 (fontified t) 418 426 (fontified t) 426 455 (fontified t) 455 464 (fontified t) 464 468 (face font-lock-keyword-face fontified t) 468 473 (fontified t) 473 484 (fontified t) 484 488 (face font-lock-keyword-face fontified t) 488 503 (face font-lock-keyword-face fontified t) 503 516 (fontified t) 516 559 (fontified t) 559 561 (fontified t) 561 568 (face font-lock-builtin-face fontified t) 568 572 (fontified t) 572 576 (fontified t) 576 583 (face font-lock-builtin-face fontified t) 583 587 (fontified t) 587 600 (fontified t) 600 607 (face font-lock-keyword-face fontified t) 607 633 (fontified t) 633 637 (face font-lock-keyword-face fontified t) 637 676 (fontified t) 676 680 (face font-lock-builtin-face fontified t) 680 705 (fontified t) 705 723 (fontified t)) . -57192) (undo-tree-id65 . -1) (undo-tree-id66 . -723) (undo-tree-id67 . -15) (undo-tree-id68 . -15) (undo-tree-id69 . -15) (undo-tree-id70 . -15) (undo-tree-id71 . -15) (undo-tree-id72 . -15) (undo-tree-id73 . -15) (undo-tree-id74 . -47) (undo-tree-id75 . -47) (undo-tree-id76 . -666) (undo-tree-id77 . -666) (undo-tree-id78 . -666) (undo-tree-id79 . -666) (undo-tree-id80 . -693) 57915) ((57192 . 57915)) (26798 52308 232429 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55598 . 55599) (nil fontified nil 55573 . 55599) (55573 . 55599)) nil (26798 52392 846577 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 55607 . 55608) (nil fontified nil 55599 . 55608) (55599 . 55608)) nil (26798 57467 575281 0) 0 nil] [nil nil ((#("\"Bearer \"" 0 9 (face font-lock-string-face fontified t)) . 55650) (undo-tree-id118 . -9) (undo-tree-id119 . -2) (undo-tree-id120 . -2) (undo-tree-id121 . -9) (undo-tree-id122 . -9) (undo-tree-id123 . -9) (undo-tree-id124 . -9) (undo-tree-id125 . -9) (undo-tree-id126 . -9) (undo-tree-id127 . -9) 55659) ((55650 . 55659)) (26798 52392 846524 0) 0 nil])
([nil nil ((55608 . 55609)) nil (26798 57467 575280 0) 0 nil])
nil
([nil nil ((55609 . 55613)) nil (26798 57467 575280 0) 0 nil])
([nil nil ((55638 . 55640)) nil (26798 57467 575279 0) 0 nil])
([nil nil ((56035 . 56048) (#(" " 0 1 (fontified nil)) . 56035) (56034 . 56035)) nil (26798 57467 575279 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -56215) (undo-tree-id162 . -10) 56225) nil (26798 57467 575278 0) 0 nil])
([nil nil ((56215 . 56218)) nil (26798 57467 575277 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -56215) (undo-tree-id159 . -1) (#("l" 0 1 (fontified t)) . -56216) (undo-tree-id160 . -1) (#("i" 0 1 (fontified t)) . -56217) (undo-tree-id161 . -1) 56218) nil (26798 57467 575277 0) 0 nil])
([nil nil ((56215 . 56223)) nil (26798 57467 575275 0) 0 nil])
([nil nil ((56215 . 56227) (#("lumen.ut" 0 8 (fontified t)) . -56215) (undo-tree-id158 . -8) 56223) nil (26798 57467 575274 0) 0 nil])
([nil nil ((56227 . 56236)) nil (26798 57467 575273 0) 0 nil])
([nil nil ((56236 . 56237)) nil (26798 57467 575273 0) 0 nil])
([nil nil ((56237 . 56240)) nil (26798 57467 575272 0) 0 nil])
([nil nil ((#(" jwt" 0 4 (fontified t)) . 56248)) nil (26798 57467 575272 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -56249) (undo-tree-id157 . -1) 56250) nil (26798 57467 575272 0) 0 nil])
([nil nil ((#("cdr (assoc \"scopes\" jwt)" 0 11 (fontified t) 11 19 (face font-lock-string-face fontified t) 19 24 (fontified t)) . -56285) (undo-tree-id156 . -24) 56309) nil (26798 57467 575271 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56317 . 56318) (nil fontified nil 56311 . 56318) (nil fontified nil 56310 . 56311) (nil fontified nil 56285 . 56310) (56285 . 56318)) nil (26798 57467 575270 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -56311) (undo-tree-id155 . -1) 56312) nil (26798 57467 575269 0) 0 nil])
([nil nil ((56311 . 56312)) nil (26798 57467 575268 0) 0 nil])
([nil nil ((56318 . 56319)) nil (26798 57467 575268 0) 0 nil])
([nil nil ((56606 . 56611) (#(" " 0 1 (fontified nil)) . 56606) (56605 . 56606)) nil (26798 57467 575267 0) 0 nil])
([nil nil ((#("cdr (assoc :role jwt)" 0 11 (fontified t) 11 16 (face font-lock-builtin-face fontified t) 16 21 (fontified t)) . -56719) (undo-tree-id154 . -21) 56740) nil (26798 57467 575267 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56751 . 56752) (nil fontified nil 56745 . 56752) (nil fontified nil 56744 . 56745) (nil fontified nil 56719 . 56744) (56719 . 56752)) nil (26798 57467 575265 0) 0 nil])
([nil nil ((#("scopes" 0 5 (face font-lock-builtin-face fontified t) 5 6 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -56746) (undo-tree-id153 . -6) 56752) nil (26798 57467 575265 0) 0 nil])
([nil nil ((56746 . 56750)) nil (26798 57467 575258 0) 0 nil])
([nil nil ((56746 . 56754) (#(" " 0 1 (fontified nil)) . 56745) (undo-tree-id152 . -1) (#("      " 0 6 (fontified nil)) . -56693) (56752 . 56753)) nil (26798 57467 575257 0) 0 nil])
([nil nil ((#("cdr (assoc \"role\" jwt)" 0 11 (fontified t) 11 17 (face font-lock-string-face fontified t) 17 22 (fontified t)) . -56755) (undo-tree-id151 . -22) 56777) nil (26798 57467 575256 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56787 . 56788) (nil fontified nil 56781 . 56788) (nil fontified nil 56780 . 56781) (nil fontified nil 56755 . 56780) (56755 . 56788)) nil (26798 57467 575255 0) 0 nil])
([nil nil ((#("scopes" 0 5 (face font-lock-builtin-face fontified t) 5 6 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -56782) (undo-tree-id150 . -6) 56788) nil (26798 57467 575254 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -56781) (undo-tree-id148 . -1) (undo-tree-id149 . -1) 56782) nil (26798 57467 575253 0) 0 nil])
([nil nil ((56781 . 56787)) nil (26798 57467 575250 0) 0 nil])
([nil nil ((#("  " 0 2 (fontified nil)) . -57252) (57298 . 57299)) nil (26798 57467 575249 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret \"change-me\") (header \"authorization\") (prefix \"Bearer \"))
  \"Extrait Authorization: Bearer <jwt> et place :jwt (payload) dans req-ctx si valide.\"
  (lambda (next)
    (lambda (req)
      (let* ((hdrs (lumen.core.http:req-headers req))
             (raw  (cdr (assoc header hdrs :test #'string-equal)))
             (tok  (and raw (lumen.utils:str-prefix-p prefix raw)
                        (subseq raw (length prefix)))))
        (when tok
          (multiple-value-bind (payload _)
              (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
            (declare (ignore _))
            (when payload (lumen.core.http:ctx-set! req :jwt payload))))
        (funcall next req)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 31 (fontified t) 31 42 (face font-lock-string-face fontified t) 42 52 (fontified t) 52 67 (face font-lock-string-face fontified t) 67 77 (fontified t) 77 86 (face font-lock-string-face fontified t) 86 91 (fontified t) 91 109 (face font-lock-doc-face fontified t) 109 175 (face font-lock-doc-face fontified t) 175 176 (face font-lock-doc-face fontified t) 176 177 (fontified t) 177 180 (fontified t) 180 186 (face font-lock-keyword-face fontified t) 186 194 (fontified t) 194 199 (fontified t) 199 205 (face font-lock-keyword-face fontified t) 205 212 (fontified t) 212 219 (fontified t) 219 223 (face font-lock-keyword-face fontified t) 223 251 (fontified t) 251 266 (fontified t) 266 309 (fontified t) 309 314 (face font-lock-builtin-face fontified t) 314 318 (fontified t) 318 333 (fontified t) 333 334 (fontified t) 334 346 (fontified t) 346 399 (fontified t) 399 411 (fontified t) 411 418 (fontified t) 418 426 (fontified t) 426 439 (fontified t) 439 455 (fontified t) 455 464 (fontified t) 464 468 (face font-lock-keyword-face fontified t) 468 473 (fontified t) 473 484 (fontified t) 484 488 (face font-lock-keyword-face fontified t) 488 489 (face font-lock-keyword-face fontified t) 489 503 (face font-lock-keyword-face fontified t) 503 516 (fontified t) 516 553 (fontified t) 553 559 (fontified t) 559 561 (fontified t) 561 568 (face font-lock-builtin-face fontified t) 568 572 (fontified t) 572 576 (fontified t) 576 583 (face font-lock-builtin-face fontified t) 583 587 (fontified t) 587 600 (fontified t) 600 607 (face font-lock-keyword-face fontified t) 607 633 (fontified t) 633 637 (face font-lock-keyword-face fontified t) 637 676 (fontified t) 676 680 (face font-lock-builtin-face fontified t) 680 705 (fontified t) 705 723 (fontified t) 723 724 (fontified t)) . -57297) (undo-tree-id147 . -724) 58021) nil (26798 57467 575249 0) 0 nil])
([nil nil ((57252 . 57254) 57223) nil (26798 57467 575248 0) 0 nil])
([nil nil ((#("(defparameter *rl-store* (make-hash-table :test 'equal)) ; key -> (tokens . last-refill)
(defparameter *rl-capacity* 10) ; 10 req / fenÃªtre
(defparameter *rl-refill-interval* 10) ; refill complet en 10 s

(defun %now () (truncate (get-universal-time)))

(defun %rl-take (key)
  (let* ((now (%now))
	 (cell (gethash key *rl-store* (cons *rl-capacity* now)))
	 (tokens (car cell)) (last (cdr cell))
	 (elapsed (- now last))
	 (refill (min *rl-capacity*
		      (+ tokens (floor (* (*rl-capacity*) (/ (max 0 elapsed) *rl-refill-interval*)))))))
    (if (> refill 0)
	(progn (setf (car cell) (1- refill) (cdr cell) now)
	       (setf (gethash key *rl-store*) cell)
	       t)
	(progn (setf (gethash key *rl-store*)
		     (cons refill now))
	       nil))))

(defun rate-limit (key-fn &key (capacity *rl-capacity*) (refill-sec *rl-refill-interval*))
  (declare (ignore capacity refill-sec)) ; simplifiÃ©: sâ€™appuie sur les defparams globaux
  (lambda (next)
    (lambda (req)
      (let ((key (funcall key-fn req)))
	(if (and key (%rl-take key))
	    (funcall next req)
	    (lumen.core.http:respond-json '((:error . ((:type . \"rate-limit\")
						       (:message . \"too many requests\"))))
					  :status 429))))))

(defun remote-ip (req)
  (or (lumen.utils:alist-get (lumen.core.http:req-headers req) \"x-forwarded-for\")
      (lumen.core.http:ctx-get req :remote-addr)
      \"unknown\"))

(defun rate-limit-login ()
  (rate-limit (lambda (req)
		(format nil \"login:~a\" (remote-ip req)))))" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 24 (face font-lock-variable-name-face fontified t) 24 42 (fontified t) 42 47 (face font-lock-builtin-face fontified t) 47 57 (fontified t) 57 89 (face font-lock-comment-face fontified t) 89 90 (fontified t) 90 102 (face font-lock-keyword-face fontified t) 102 103 (fontified t) 103 116 (face font-lock-variable-name-face fontified t) 116 121 (fontified t) 121 140 (face font-lock-comment-face fontified t) 140 141 (fontified t) 141 153 (face font-lock-keyword-face fontified t) 153 154 (fontified t) 154 174 (face font-lock-variable-name-face fontified t) 174 179 (fontified t) 179 204 (face font-lock-comment-face fontified t) 204 205 (fontified t) 205 206 (fontified t) 206 211 (face font-lock-keyword-face fontified t) 211 212 (fontified t) 212 216 (face font-lock-function-name-face fontified t) 216 253 (fontified t) 253 254 (fontified t) 254 255 (fontified t) 255 260 (face font-lock-keyword-face fontified t) 260 261 (fontified t) 261 269 (face font-lock-function-name-face fontified t) 269 276 (fontified t) 276 278 (fontified t) 278 279 (fontified t) 279 283 (face font-lock-keyword-face fontified t) 283 298 (fontified t) 298 300 (fontified t) 300 359 (fontified t) 359 399 (fontified t) 399 424 (fontified t) 424 459 (fontified t) 459 546 (fontified t) 546 547 (fontified t) 547 549 (face font-lock-keyword-face fontified t) 549 564 (fontified t) 564 565 (fontified t) 565 570 (face font-lock-keyword-face fontified t) 570 624 (fontified t) 624 669 (fontified t) 669 672 (fontified t) 672 673 (fontified t) 673 674 (fontified t) 674 679 (face font-lock-keyword-face fontified t) 679 737 (fontified t) 737 753 (fontified t) 753 754 (fontified t) 754 755 (fontified t) 755 760 (face font-lock-keyword-face fontified t) 760 761 (fontified t) 761 771 (face font-lock-function-name-face fontified t) 771 780 (fontified t) 780 784 (face font-lock-type-face fontified t) 784 845 (fontified t) 845 848 (fontified t) 848 855 (face font-lock-keyword-face fontified t) 855 886 (fontified t) 886 934 (face font-lock-comment-face fontified t) 934 936 (fontified t) 936 937 (fontified t) 937 943 (face font-lock-keyword-face fontified t) 943 955 (fontified t) 955 956 (fontified t) 956 962 (face font-lock-keyword-face fontified t) 962 975 (fontified t) 975 976 (fontified t) 976 979 (face font-lock-keyword-face fontified t) 979 1010 (fontified t) 1010 1011 (fontified t) 1011 1013 (face font-lock-keyword-face fontified t) 1013 1044 (fontified t) 1044 1063 (fontified t) 1063 1068 (fontified t) 1068 1101 (fontified t) 1101 1107 (face font-lock-builtin-face fontified t) 1107 1112 (fontified t) 1112 1117 (face font-lock-builtin-face fontified t) 1117 1120 (fontified t) 1120 1132 (face font-lock-string-face fontified t) 1132 1134 (fontified t) 1134 1148 (fontified t) 1148 1156 (face font-lock-builtin-face fontified t) 1156 1159 (fontified t) 1159 1178 (face font-lock-string-face fontified t) 1178 1183 (fontified t) 1183 1190 (fontified t) 1190 1197 (face font-lock-builtin-face fontified t) 1197 1207 (fontified t) 1207 1208 (fontified t) 1208 1209 (fontified t) 1209 1210 (fontified t) 1210 1215 (face font-lock-keyword-face fontified t) 1215 1216 (fontified t) 1216 1225 (face font-lock-function-name-face fontified t) 1225 1232 (fontified t) 1232 1260 (fontified t) 1260 1295 (fontified t) 1295 1311 (face font-lock-string-face fontified t) 1311 1312 (face font-lock-string-face fontified t rear-nonsticky t) 1312 1314 (fontified t) 1314 1320 (fontified t) 1320 1349 (fontified t) 1349 1361 (face font-lock-builtin-face fontified t) 1361 1363 (fontified t) 1363 1369 (fontified t) 1369 1378 (face font-lock-string-face fontified t) 1378 1380 (fontified t) 1380 1381 (fontified t) 1381 1382 (fontified t) 1382 1383 (fontified t) 1383 1388 (face font-lock-keyword-face fontified t) 1388 1389 (fontified t) 1389 1405 (face font-lock-function-name-face fontified t) 1405 1409 (fontified t) 1409 1411 (fontified t) 1411 1424 (fontified t) 1424 1430 (face font-lock-keyword-face fontified t) 1430 1451 (fontified t) 1451 1461 (face font-lock-string-face fontified t) 1461 1480 (fontified t) 1480 1481 (fontified t rear-nonsticky t)) . -63132) (undo-tree-id144 . -661) (undo-tree-id145 . -1381) (undo-tree-id146 . -1481) 64613) nil (26798 57467 575247 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 63540 . 63541) (nil fontified nil 63132 . 63541) (63132 . 63541)) nil (26798 57467 575245 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret lumen.core.jwt:*jwt-secret*)
                      (required-p nil) (roles-allow nil) (scopes-allow nil))
  \"Extrait Authorization: Bearer <jwt>, vÃ©rifie, pose :jwt dans req-ctx.
Options:
 - REQUIRED-P : 401 si token manquant/invalide
 - ROLES-ALLOW : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW : liste de scopes requis (OR logique par dÃ©faut ; mets :all pour AND)\"
  (lambda (next)
    (lambda (req)
      (let* ((hdrs (lumen.core.http:req-headers req))
             (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
             (tok  (and raw (>= (length raw) 7)
			(lumen.utils:str-prefix-p \"Bearer \" raw)
                        ;;(string= (subseq raw 0 7) \"Bearer \")
                        (subseq raw 7))))
        (when tok
          (multiple-value-bind (payload ok)
              (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
            (when ok (lumen.core.http:ctx-set! req :jwt payload))))
        (labels ((fail (status msg)
                   (lumen.core.http:respond-json `((:error . ((:type . \"auth\")
							      (:message . ,msg))))
                                                 :status status))
                 (has-scope-p (jwt required)
                   (let* ((sc (or (lumen.utils:alist-get jwt :scopes)
                                  (lumen.utils:alist-get jwt \"scopes\"))))
                     (cond
                       ((null scopes-allow) t)
                       ((eq scopes-allow :all)
                        (every (lambda (x) (member x sc :test #'string=)) required))
                       (t (some  (lambda (x) (member x sc :test #'string=))
				 required))))))
                (jwt (lumen.core.http:ctx-get req :jwt))
          (role (and jwt (or (lumen.utils:alist-get jwt :role)
			     (lumen.utils:alist-get jwt \"role\")))))
          (cond
            ((and required-p (null jwt)) (fail 401 \"missing or invalid token\"))
            ((and roles-allow jwt (not (member role roles-allow :test #'string=)))
             (fail 403 \"forbidden\"))
            ((and scopes-allow jwt (not (has-scope-p jwt scopes-allow)))
             (fail 403 \"insufficient_scope\"))
            (t (funcall next req))))))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 139 (fontified t) 139 406 (face font-lock-doc-face fontified t) 406 410 (fontified t) 410 416 (face font-lock-keyword-face fontified t) 416 429 (fontified t) 429 435 (face font-lock-keyword-face fontified t) 435 449 (fontified t) 449 453 (face font-lock-keyword-face fontified t) 453 527 (fontified t) 527 542 (face font-lock-string-face fontified t) 542 548 (fontified t) 548 553 (face font-lock-builtin-face fontified t) 553 572 (fontified t) 572 620 (fontified t) 620 623 (fontified t) 623 648 (fontified t) 648 649 (rear-nonsticky t fontified t) 649 657 (face font-lock-string-face fontified t) 657 658 (face font-lock-string-face rear-nonsticky t fontified t) 658 663 (fontified t) 663 664 (fontified t) 664 688 (fontified t) 688 690 (face font-lock-comment-delimiter-face fontified t) 690 716 (face font-lock-comment-face fontified t) 716 725 (face font-lock-comment-face fontified t) 725 727 (face font-lock-comment-face fontified t) 727 778 (fontified t) 778 782 (face font-lock-keyword-face fontified t) 782 798 (fontified t) 798 817 (face font-lock-keyword-face fontified t) 817 876 (fontified t) 876 883 (face font-lock-builtin-face fontified t) 883 891 (fontified t) 891 898 (face font-lock-builtin-face fontified t) 898 915 (fontified t) 915 919 (face font-lock-keyword-face fontified t) 919 953 (fontified t) 953 957 (face font-lock-builtin-face fontified t) 957 979 (fontified t) 979 985 (face font-lock-keyword-face fontified t) 985 1006 (fontified t) 1006 1058 (fontified t) 1058 1064 (face font-lock-builtin-face fontified t) 1064 1069 (fontified t) 1069 1074 (face font-lock-builtin-face fontified t) 1074 1077 (fontified t) 1077 1083 (face font-lock-string-face fontified t) 1083 1099 (fontified t) 1099 1107 (face font-lock-builtin-face fontified t) 1107 1119 (fontified t) 1119 1168 (fontified t) 1168 1175 (face font-lock-builtin-face fontified t) 1175 1230 (fontified t) 1230 1250 (fontified t) 1250 1254 (face font-lock-keyword-face fontified t) 1254 1265 (fontified t) 1265 1290 (fontified t) 1290 1291 (fontified t) 1291 1298 (face font-lock-builtin-face fontified t) 1298 1300 (fontified t) 1300 1335 (fontified t) 1335 1360 (fontified t) 1360 1361 (fontified t) 1361 1362 (face font-lock-string-face fontified t) 1362 1367 (face font-lock-string-face fontified t) 1367 1368 (face font-lock-string-face rear-nonsticky t fontified t) 1368 1369 (face font-lock-string-face fontified t) 1369 1374 (fontified t) 1374 1396 (fontified t) 1396 1400 (face font-lock-keyword-face fontified t) 1400 1489 (fontified t) 1489 1493 (face font-lock-builtin-face fontified t) 1493 1527 (fontified t) 1527 1533 (face font-lock-keyword-face fontified t) 1533 1551 (fontified t) 1551 1556 (face font-lock-builtin-face fontified t) 1556 1580 (fontified t) 1580 1614 (fontified t) 1614 1620 (face font-lock-keyword-face fontified t) 1620 1638 (fontified t) 1638 1643 (face font-lock-builtin-face fontified t) 1643 1676 (fontified t) 1676 1726 (fontified t) 1726 1730 (face font-lock-builtin-face fontified t) 1730 1733 (fontified t) 1733 1763 (fontified t) 1763 1788 (fontified t) 1788 1789 (fontified t) 1789 1794 (face font-lock-builtin-face fontified t) 1794 1796 (fontified t) 1796 1805 (fontified t) 1805 1830 (fontified t) 1830 1831 (fontified t) 1831 1837 (face font-lock-string-face fontified t) 1837 1843 (fontified t) 1843 1854 (fontified t) 1854 1858 (face font-lock-keyword-face fontified t) 1858 1910 (fontified t) 1910 1936 (face font-lock-string-face fontified t) 1936 2003 (fontified t) 2003 2008 (face font-lock-builtin-face fontified t) 2008 2045 (fontified t) 2045 2056 (face font-lock-string-face fontified t) 2056 2155 (fontified t) 2155 2175 (face font-lock-string-face fontified t) 2175 2218 (fontified t)) . 54950) (undo-tree-id143 . -2218)) nil (26798 57467 575244 0) 0 nil])
([nil nil ((54950 . 54951)) nil (26798 57467 575243 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 57544 . 57545) (nil fontified nil 54951 . 57545) (54951 . 57545)) nil (26798 57467 575243 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -57544) (undo-tree-id142 . -1) 57545) nil (26798 57467 575242 0) 0 nil])
([nil nil ((57544 . 57545)) nil (26798 57467 575241 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -57544) (undo-tree-id141 . -1) 57545) nil (26798 57467 575241 0) 0 nil])
([nil nil ((#("   " 0 3 (fontified t)) . -55133) (#("   " 0 3 (fontified t)) . -55096) (#("   " 0 3 (fontified t)) . -55060) 54988) nil (26798 57467 575240 0) 0 nil])
([nil nil ((#("
(in-package :lumen.core.middleware)
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 12 (face font-lock-keyword-face fontified t) 12 13 (fontified t) 13 35 (face font-lock-builtin-face fontified t) 35 37 (fontified t)) . 54950) (undo-tree-id140 . -37)) nil (26798 57467 575239 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -54932) (undo-tree-id138 . -1) (#(" " 0 1 (fontified t)) . -54933) (undo-tree-id139 . -1) 54934) nil (26798 57467 575238 0) 0 nil])
([nil nil ((63637 . 63645) (#(" " 0 1 (fontified nil)) . 63636) (undo-tree-id137 . -1) (63637 . 63638)) nil (26798 57467 575236 0) 0 nil])
([nil nil ((63676 . 63684) (#(" " 0 1 (fontified nil)) . 63675) (undo-tree-id136 . -1) (63676 . 63677)) nil (26798 57467 575235 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -62989) (undo-tree-id135 . -1) 62990) nil (26798 57467 575233 0) 0 nil])
([nil nil ((672 . 675)) nil (26798 57467 575232 0) 0 nil])
([nil nil ((675 . 678)) nil (26798 57467 575232 0) 0 nil])
([nil nil ((678 . 683)) nil (26798 57467 575232 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -682) (undo-tree-id134 . -1) 683) nil (26798 57467 575231 0) 0 nil])
([nil nil ((682 . 685)) nil (26798 57467 575230 0) 0 nil])
([nil nil ((676 . 688) (#(":import-f" 0 9 (face font-lock-builtin-face fontified t)) . -676) (undo-tree-id133 . -9) 685) nil (26798 57467 575230 0) 0 nil])
([nil nil ((688 . 689)) nil (26798 57467 575229 0) 0 nil])
([nil nil ((689 . 690)) nil (26798 57467 575228 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 716 . 717) (nil fontified nil 690 . 717) (690 . 717)) nil (26798 57467 575228 0) 0 nil])
([nil nil ((710 . 711)) nil (26798 57467 575227 0) 0 nil])
([nil nil ((718 . 719)) nil (26798 57467 575227 0) 0 nil])
([nil nil ((1197 . 1200) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1181) (1181 . 1182) (#("	" 0 1 (fontified nil)) . 1181) (1178 . 1181) (1197 . 1198)) nil (26798 57467 575226 0) 0 nil])
([nil nil ((1200 . 1201)) nil (26798 57467 575225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1241 . 1242) (nil fontified nil 1201 . 1242) (1201 . 1242)) nil (26798 57467 575225 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -1201) (undo-tree-id132 . -1) 1202) nil (26798 57467 575224 0) 0 nil])
([nil nil ((57210 . 57221) (#(" " 0 1 (fontified nil)) . 57209) (undo-tree-id131 . -1) (57210 . 57211)) nil (26798 57467 575223 0) 0 nil])
([nil nil ((57252 . 57261) (#(" " 0 1 (fontified nil)) . 57251) (undo-tree-id130 . -1) (57252 . 57253)) nil (26798 57467 575221 0) 0 nil])
([nil nil ((57356 . 57366) (#(" " 0 1 (fontified nil)) . 57355) (undo-tree-id129 . -1) (57356 . 57357)) nil (26798 57467 575220 0) 0 nil])
([nil nil ((57397 . 57405) (#(" " 0 1 (fontified nil)) . 57396) (undo-tree-id128 . -1) (57397 . 57398)) nil (26798 57467 575216 0) 0 nil])
([nil nil ((64013 . 64014)) nil (26798 57467 575203 0) 0 nil])
([nil nil ((55039 . 55040) (t 26798 57467 0 0)) nil (26798 59603 210161 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55222 . 55223) (nil fontified nil 55040 . 55223) (55040 . 55223)) nil (26798 59603 210161 0) 0 nil])
([nil nil ((55039 . 55040)) nil (26798 59603 210160 0) 0 nil])
([nil nil ((55040 . 55042)) nil (26798 59603 210160 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -55040) (undo-tree-id163 . -1) (#("-" 0 1 (face font-lock-string-face fontified t)) . -55041) (undo-tree-id164 . -1) 55042) nil (26798 59603 210159 0) 0 nil])
([nil nil ((55040 . 55041)) nil (26798 59603 210148 0) 0 nil])
([nil nil ((55041 . 55042)) nil (26798 59603 210147 0) 0 nil])
([nil nil ((55226 . 55227)) nil (26798 59603 210147 0) 0 nil])
([nil nil ((55227 . 55229)) nil (26798 59603 210147 0) 0 nil])
([nil nil ((63777 . 63779)) nil (26798 59603 210146 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 63930 . 63931) (nil fontified nil 63779 . 63931) (63779 . 63931)) nil (26798 59603 210146 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified nil)) . -63854) (63853 . 63854)) nil (26798 59603 210145 0) 0 nil])
([nil nil ((63854 . 63856)) nil (26798 59603 210144 0) 0 nil])
([nil nil ((63856 . 63857)) nil (26798 59603 210144 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 63881)) nil (26798 59603 210142 0) 0 nil])
([nil nil ((63881 . 63882)) nil (26798 59603 210139 0) 0 nil])
([nil nil ((648 . 649) (t 26798 59603 0 0)) nil (26798 59827 741727 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 660 . 661) (nil fontified nil 649 . 661) (649 . 661)) nil (26798 59827 741726 0) 0 nil])
([nil nil ((661 . 662)) nil (26798 59827 741721 0) 0 nil])
([nil nil ((63790 . 63791) (t 26798 59827 0 0)) nil (26798 60456 420785 0) 0 nil])
([nil nil ((57959 . 57961)) nil (26798 60456 420785 0) 0 nil])
([nil nil ((nil fontified nil 58035 . 58036) (nil fontified nil 58028 . 58035) (nil fontified nil 58016 . 58028) (nil fontified nil 58013 . 58016) (nil fontified nil 58002 . 58013) (nil fontified nil 57992 . 58002) (nil fontified nil 57990 . 57992) (nil fontified nil 57981 . 57990) (nil fontified nil 57975 . 57981) (nil fontified nil 57968 . 57975) (nil fontified nil 57967 . 57968) (nil fontified nil 57962 . 57967) (nil fontified nil 57961 . 57962) (57961 . 58036)) nil (26798 60456 420784 0) 0 nil])
([nil nil ((57973 . 57974)) nil (26798 60456 420782 0) 0 nil])
([nil nil ((#("o" 0 1 (face font-lock-function-name-face fontified t)) . -57969) (undo-tree-id178 . -1) (#("l" 0 1 (face font-lock-function-name-face fontified t)) . -57970) (undo-tree-id179 . -1) (#("e" 0 1 (face font-lock-function-name-face fontified t)) . -57971) (undo-tree-id180 . -1) (#("s" 0 1 (face font-lock-function-name-face fontified t)) . -57972) (undo-tree-id181 . -1) (#("s" 0 1 (face font-lock-function-name-face fontified t)) . -57973) (undo-tree-id182 . -1) 57974) nil (26798 60456 420781 0) 0 nil])
([nil nil ((57969 . 57970)) nil (26798 60456 420778 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-function-name-face fontified t)) . -57968) (undo-tree-id176 . -1) (#("s" 0 1 (face font-lock-function-name-face fontified t)) . -57969) (undo-tree-id177 . -1) 57970) nil (26798 60456 420777 0) 0 nil])
([nil nil ((57968 . 57974)) nil (26798 60456 420775 0) 0 nil])
([nil nil ((#("
(defun scopes-allowed (roles)
  (auth-jwt :required-p t :roles-allow roles))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (face font-lock-function-name-face fontified t) 16 22 (face font-lock-function-name-face fontified t) 22 31 (fontified t) 31 33 (fontified t) 33 43 (fontified t) 43 54 (face font-lock-builtin-face fontified t) 54 57 (fontified t) 57 69 (face font-lock-builtin-face fontified t) 69 76 (fontified t) 76 77 (fontified t rear-nonsticky t)) . 57960) (undo-tree-id172 . -77) (undo-tree-id173 . -14) (undo-tree-id174 . -14) (undo-tree-id175 . -14)) nil (26798 60456 420774 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -57959) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) 57960) nil (26798 60456 420771 0) 0 nil])
([nil nil ((#("
;;; Auth API
(defun auth-required ()
  (lambda (next)
    (lambda (req)
      (if (lumen.core.http:ctx-get req :jwt)
	  (funcall next req)
	  (lumen.core.http:respond-json '((:error . ((:type . \"auth\")
						     (:message . \"unauthorized\"))))
					:status 401)))))


(defun roles-allowed (&rest roles)
  (lambda (next)
    (lambda (req)
      (let* ((jwt (lumen.core.http:ctx-get req :jwt))
	     (role (and jwt (or (cdr (assoc :role jwt))
				(cdr (assoc \"role\" jwt :test #'string=))))))
	(if (and role (member role roles :test #'string-equal))
	    (funcall next req)
	    (lumen.core.http:respond-json '((:error . ((:type . \"auth\")
						       (:message . \"forbidden\"))))
					  :status 403))))))

(defun scopes-allowed (&rest scopes)
  (lambda (next)
    (lambda (req)
      (let* ((jwt (lumen.core.http:ctx-get req :jwt))
	     (have (and jwt (or (cdr (assoc :scopes jwt))
				(cdr (assoc \"scopes\" jwt :test #'string=))))))
	(if (and (listp have)
		 (intersection have scopes :test #'string-equal))
	    (funcall next req)
	    (lumen.core.http:respond-json '((:error . ((:type . \"auth\")
						       (:message . \"insufficient scope\"))))
					  :status 403))))))
" 0 1 (fontified t) 1 5 (face font-lock-comment-delimiter-face fontified t) 5 14 (face font-lock-comment-face fontified t) 14 15 (fontified t) 15 20 (face font-lock-keyword-face fontified t) 20 21 (fontified t) 21 28 (face font-lock-function-name-face fontified t) 28 34 (face font-lock-function-name-face fontified t) 34 38 (fontified t) 38 41 (fontified t) 41 47 (face font-lock-keyword-face fontified t) 47 59 (fontified t) 59 60 (fontified t) 60 66 (face font-lock-keyword-face fontified t) 66 79 (fontified t) 79 80 (fontified t) 80 82 (face font-lock-keyword-face fontified t) 82 112 (fontified t) 112 116 (face font-lock-builtin-face fontified t) 116 121 (fontified t) 121 140 (fontified t) 140 143 (fontified t) 143 176 (fontified t) 176 182 (face font-lock-builtin-face fontified t) 182 187 (fontified t) 187 192 (face font-lock-builtin-face fontified t) 192 195 (fontified t) 195 201 (face font-lock-string-face fontified t) 201 215 (fontified t) 215 223 (face font-lock-builtin-face fontified t) 223 226 (fontified t) 226 234 (face font-lock-string-face fontified t) 234 240 (face font-lock-string-face fontified t) 240 245 (fontified t) 245 250 (fontified t) 250 257 (face font-lock-builtin-face fontified t) 257 267 (fontified t) 267 269 (fontified t) 269 270 (fontified t) 270 275 (face font-lock-keyword-face fontified t) 275 276 (fontified t) 276 289 (face font-lock-function-name-face fontified t) 289 291 (fontified t) 291 296 (face font-lock-type-face fontified t) 296 304 (fontified t) 304 307 (fontified t) 307 313 (face font-lock-keyword-face fontified t) 313 325 (fontified t) 325 326 (fontified t) 326 332 (face font-lock-keyword-face fontified t) 332 345 (fontified t) 345 346 (fontified t) 346 350 (face font-lock-keyword-face fontified t) 350 379 (fontified t) 379 386 (fontified t) 386 390 (face font-lock-builtin-face fontified t) 390 393 (fontified t) 393 399 (fontified t) 399 430 (fontified t) 430 435 (face font-lock-builtin-face fontified t) 435 458 (fontified t) 458 464 (face font-lock-string-face fontified t) 464 469 (fontified t) 469 474 (face font-lock-builtin-face fontified t) 474 491 (fontified t) 491 492 (fontified t) 492 493 (fontified t) 493 495 (face font-lock-keyword-face fontified t) 495 525 (fontified t) 525 530 (face font-lock-builtin-face fontified t) 530 553 (fontified t) 553 572 (fontified t) 572 577 (fontified t) 577 610 (fontified t) 610 616 (face font-lock-builtin-face fontified t) 616 621 (fontified t) 621 626 (face font-lock-builtin-face fontified t) 626 629 (fontified t) 629 635 (face font-lock-string-face fontified t) 635 637 (fontified t) 637 651 (fontified t) 651 659 (face font-lock-builtin-face fontified t) 659 662 (fontified t) 662 673 (face font-lock-string-face fontified t) 673 678 (fontified t) 678 685 (fontified t) 685 692 (face font-lock-builtin-face fontified t) 692 702 (fontified t) 702 703 (fontified t) 703 704 (fontified t) 704 705 (fontified t) 705 710 (face font-lock-keyword-face fontified t) 710 711 (fontified t) 711 725 (face font-lock-function-name-face fontified t) 725 727 (fontified t) 727 732 (face font-lock-type-face fontified t) 732 741 (fontified t) 741 744 (fontified t) 744 750 (face font-lock-keyword-face fontified t) 750 762 (fontified t) 762 763 (fontified t) 763 769 (face font-lock-keyword-face fontified t) 769 782 (fontified t) 782 783 (fontified t) 783 787 (face font-lock-keyword-face fontified t) 787 823 (fontified t) 823 827 (face font-lock-builtin-face fontified t) 827 830 (fontified t) 830 836 (fontified t) 836 867 (fontified t) 867 874 (face font-lock-builtin-face fontified t) 874 897 (fontified t) 897 905 (face font-lock-string-face fontified t) 905 910 (fontified t) 910 915 (face font-lock-builtin-face fontified t) 915 932 (fontified t) 932 933 (fontified t) 933 934 (fontified t) 934 936 (face font-lock-keyword-face fontified t) 936 958 (fontified t) 958 984 (fontified t) 984 989 (face font-lock-builtin-face fontified t) 989 1012 (fontified t) 1012 1031 (fontified t) 1031 1036 (fontified t) 1036 1069 (fontified t) 1069 1075 (face font-lock-builtin-face fontified t) 1075 1080 (fontified t) 1080 1085 (face font-lock-builtin-face fontified t) 1085 1088 (fontified t) 1088 1094 (face font-lock-string-face fontified t) 1094 1096 (fontified t) 1096 1110 (fontified t) 1110 1118 (face font-lock-builtin-face fontified t) 1118 1121 (fontified t) 1121 1141 (face font-lock-string-face fontified t) 1141 1146 (fontified t) 1146 1153 (fontified t) 1153 1160 (face font-lock-builtin-face fontified t) 1160 1169 (fontified t) 1169 1170 (fontified t rear-nonsticky t) 1170 1171 (fontified t)) . -62620) (undo-tree-id165 . -393) (undo-tree-id166 . -1171) 63791) nil (26798 60456 420764 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60424 . 60425) (nil fontified nil 60423 . 60425) (60423 . 60425) (t 26798 60456 0 0)) nil (26798 61394 184721 0) 0 nil])
([nil nil ((57829 . 57831)) nil (26798 61394 184720 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60411 . 60412) (nil fontified nil 57831 . 60412) (57831 . 60412)) nil (26798 61394 184720 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret nil secret-supplied-p)
                   (required-p nil)
                   (roles-allow nil)
                   (scopes-allow nil))
  \"Middleware qui extrait Authorization: Bearer <jwt>, vÃ©rifie la signature,
et pose :jwt dans le contexte req-ctx.

Options:
 - SECRET : clÃ© HMAC (par dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P : 401 si token manquant/invalide
 - ROLES-ALLOW : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW : liste de scopes requis (:all pour AND logique)\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (let* ((hdrs (lumen.core.http:req-headers req))
               (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
               (tok  (and raw (>= (length raw) 7)
                          (string= (subseq raw 0 7) \"Bearer \")
                          (subseq raw 7))))
          ;; Si token prÃ©sent â†’ tenter decode
          (when tok
            (multiple-value-bind (payload ok)
                (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
              (when ok (lumen.core.http:ctx-set! req :jwt payload))))
          ;; VÃ©rifs
          (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                 (role (and jwt (or (cdr (assoc :role jwt))
                                    (cdr (assoc \"role\" jwt))))))
            (cond
              ((and required-p (null jwt))
               (lumen.core.http:respond-json
                '((:error . ((:type . \"auth\") (:message . \"missing or invalid token\"))))
                :status 401))
              ((and roles-allow jwt
                    (not (member role roles-allow :test #'string=)))
               (lumen.core.http:respond-json
                '((:error . ((:type . \"auth\") (:message . \"forbidden\"))))
                :status 403))
              ((and scopes-allow jwt
                    (not (let ((sc (or (cdr (assoc :scopes jwt))
                                       (cdr (assoc \"scopes\" jwt)))))
                           (cond
                             ((eq scopes-allow :all)
                              (every (lambda (x)
				       (member x sc :test #'string=))
				     scopes-allow))
                             (t
                              (some (lambda (x)
				      (member x sc :test #'string=))
				    scopes-allow))))))
               (lumen.core.http:respond-json
                '((:error . ((:type . \"auth\") (:message . \"insufficient_scope\"))))
                :status 403))
              (t (funcall next req)))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 54 (fontified t) 54 90 (fontified t) 90 127 (fontified t) 127 166 (fontified t) 166 168 (fontified t) 168 352 (face font-lock-doc-face fontified t) 352 520 (face font-lock-doc-face fontified t) 520 524 (fontified t) 524 527 (face font-lock-keyword-face fontified t) 527 538 (fontified t) 538 540 (face font-lock-keyword-face fontified t) 540 602 (fontified t) 602 608 (face font-lock-keyword-face fontified t) 608 623 (fontified t) 623 629 (face font-lock-keyword-face fontified t) 629 645 (fontified t) 645 649 (face font-lock-keyword-face fontified t) 649 725 (fontified t) 725 740 (face font-lock-string-face fontified t) 740 746 (fontified t) 746 751 (face font-lock-builtin-face fontified t) 751 872 (fontified t) 872 881 (face font-lock-string-face fontified t) 881 937 (fontified t) 937 940 (face font-lock-comment-delimiter-face fontified t) 940 973 (face font-lock-comment-face fontified t) 973 984 (fontified t) 984 988 (face font-lock-keyword-face fontified t) 988 1006 (fontified t) 1006 1025 (face font-lock-keyword-face fontified t) 1025 1086 (fontified t) 1086 1093 (face font-lock-builtin-face fontified t) 1093 1101 (fontified t) 1101 1108 (face font-lock-builtin-face fontified t) 1108 1127 (fontified t) 1127 1131 (face font-lock-keyword-face fontified t) 1131 1165 (fontified t) 1165 1169 (face font-lock-builtin-face fontified t) 1169 1192 (fontified t) 1192 1195 (face font-lock-comment-delimiter-face fontified t) 1195 1202 (face font-lock-comment-face fontified t) 1202 1213 (fontified t) 1213 1217 (face font-lock-keyword-face fontified t) 1217 1254 (fontified t) 1254 1258 (face font-lock-builtin-face fontified t) 1258 1309 (fontified t) 1309 1314 (face font-lock-builtin-face fontified t) 1314 1317 (fontified t) 1317 1321 (fontified t) 1321 1369 (fontified t) 1369 1375 (face font-lock-string-face fontified t) 1375 1399 (fontified t) 1399 1403 (face font-lock-keyword-face fontified t) 1403 1427 (fontified t) 1427 1447 (fontified t) 1447 1455 (fontified t) 1455 1485 (fontified t) 1485 1492 (fontified t) 1492 1499 (fontified t) 1499 1501 (fontified t) 1501 1511 (fontified t) 1511 1517 (face font-lock-builtin-face fontified t) 1517 1522 (fontified t) 1522 1527 (face font-lock-builtin-face fontified t) 1527 1530 (fontified t) 1530 1536 (face font-lock-string-face fontified t) 1536 1539 (fontified t) 1539 1547 (face font-lock-builtin-face fontified t) 1547 1550 (fontified t) 1550 1576 (face font-lock-string-face fontified t) 1576 1581 (fontified t) 1581 1597 (fontified t) 1597 1604 (face font-lock-builtin-face fontified t) 1604 1647 (fontified t) 1647 1666 (fontified t) 1666 1697 (fontified t) 1697 1702 (face font-lock-builtin-face fontified t) 1702 1716 (fontified t) 1716 1780 (fontified t) 1780 1786 (face font-lock-builtin-face fontified t) 1786 1791 (fontified t) 1791 1796 (face font-lock-builtin-face fontified t) 1796 1799 (fontified t) 1799 1805 (face font-lock-string-face fontified t) 1805 1808 (fontified t) 1808 1816 (face font-lock-builtin-face fontified t) 1816 1819 (fontified t) 1819 1830 (face font-lock-string-face fontified t) 1830 1851 (fontified t) 1851 1852 (face font-lock-builtin-face fontified t) 1852 1858 (face font-lock-builtin-face fontified t) 1858 1865 (fontified t) 1865 1928 (fontified t) 1928 1931 (face font-lock-keyword-face fontified t) 1931 1953 (fontified t) 1953 1960 (face font-lock-builtin-face fontified t) 1960 2018 (fontified t) 2018 2026 (face font-lock-string-face fontified t) 2026 2064 (fontified t) 2064 2068 (face font-lock-keyword-face fontified t) 2068 2116 (fontified t) 2116 2120 (face font-lock-builtin-face fontified t) 2120 2122 (fontified t) 2122 2160 (fontified t) 2160 2166 (face font-lock-keyword-face fontified t) 2166 2171 (fontified t) 2171 2195 (fontified t) 2195 2200 (face font-lock-builtin-face fontified t) 2200 2222 (fontified t) 2222 2236 (fontified t) 2236 2237 (fontified t) 2237 2269 (fontified t) 2269 2306 (fontified t) 2306 2312 (face font-lock-keyword-face fontified t) 2312 2317 (fontified t) 2317 2340 (fontified t) 2340 2345 (face font-lock-builtin-face fontified t) 2345 2366 (fontified t) 2366 2384 (fontified t) 2384 2385 (fontified t) 2385 2449 (fontified t) 2449 2455 (face font-lock-builtin-face fontified t) 2455 2460 (fontified t) 2460 2465 (face font-lock-builtin-face fontified t) 2465 2468 (fontified t) 2468 2474 (face font-lock-string-face fontified t) 2474 2477 (fontified t) 2477 2485 (face font-lock-builtin-face fontified t) 2485 2488 (fontified t) 2488 2508 (face font-lock-string-face fontified t) 2508 2529 (fontified t) 2529 2536 (face font-lock-builtin-face fontified t) 2536 2543 (fontified t) 2543 2586 (fontified t)) . 55243) (undo-tree-id192 . -2586)) nil (26798 61394 184719 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 55243)) nil (26798 61394 184718 0) 0 nil])
([nil nil ((57676 . 57679) (#(" " 0 1 (fontified nil)) . 57676) (undo-tree-id191 . -1) (57675 . 57676)) nil (26798 61394 184717 0) 0 nil])
([nil nil ((57288 . 57295) (#(" " 0 1 (fontified nil)) . 57287) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (57288 . 57289)) nil (26798 61394 184716 0) 0 nil])
([nil nil ((57326 . 57331) (#(" " 0 1 (fontified nil)) . 57325) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (57326 . 57327)) nil (26798 61394 184714 0) 0 nil])
([nil nil ((57426 . 57433) (#(" " 0 1 (fontified nil)) . 57425) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (57426 . 57427)) nil (26798 61394 184712 0) 0 nil])
([nil nil ((57464 . 57469) (#(" " 0 1 (fontified nil)) . 57463) (undo-tree-id184 . -1) (57464 . 57465)) nil (26798 61394 184710 0) 0 nil])
([nil nil ((57852 . 57853)) nil (26798 61394 184707 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -57852) (undo-tree-id183 . -1) 57853) nil (26798 61394 184704 0) 0 nil])
([nil nil ((31753 . 31758) (t 26798 61394 0 0)) nil (26799 6927 154563 0) 0 nil])
([nil nil ((31758 . 31764)) nil (26799 6927 154563 0) 0 nil])
([nil nil ((31764 . 31765)) nil (26799 6927 154563 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -31759) (undo-tree-id222 . -1) (#("r" 0 1 (fontified t)) . -31760) (undo-tree-id223 . -1) (#("i" 0 1 (fontified t)) . -31761) (undo-tree-id224 . -1) (#("n" 0 1 (fontified t)) . -31762) (undo-tree-id225 . -1) (#("t" 0 1 (fontified t)) . -31763) (undo-tree-id226 . -1) (#(" " 0 1 (fontified t)) . -31764) (undo-tree-id227 . -1) 31765) nil (26799 6927 154562 0) 0 nil])
([nil nil ((31759 . 31765)) nil (26799 6927 154558 0) 0 nil])
([nil nil ((31765 . 31766)) nil (26799 6927 154558 0) 0 nil])
([nil nil ((31766 . 31767)) nil (26799 6927 154558 0) 0 nil])
([nil nil ((31767 . 31768)) nil (26799 6927 154557 0) 0 nil])
([nil nil ((31768 . 31770)) nil (26799 6927 154557 0) 0 nil])
([nil nil ((31770 . 31775)) nil (26799 6927 154556 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-string-face fontified t)) . -31772) (undo-tree-id219 . -1) (#("e" 0 1 (face font-lock-string-face fontified t)) . -31773) (undo-tree-id220 . -1) (#("r" 0 1 (face font-lock-string-face fontified t)) . -31774) (undo-tree-id221 . -1) 31775) nil (26799 6927 154555 0) 0 nil])
([nil nil ((31772 . 31777)) nil (26799 6927 154553 0) 0 nil])
([nil nil ((31777 . 31778)) nil (26799 6927 154553 0) 0 nil])
([nil nil ((31778 . 31781)) nil (26799 6927 154552 0) 0 nil])
([nil nil ((31781 . 31782)) nil (26799 6927 154552 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-string-face fontified t)) . -31780) (undo-tree-id217 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -31781) (undo-tree-id218 . -1) 31782) nil (26799 6927 154551 0) 0 nil])
([nil nil ((31780 . 31783)) nil (26799 6927 154550 0) 0 nil])
([nil nil ((31783 . 31784)) nil (26799 6927 154549 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31790 . 31791) (nil fontified nil 31784 . 31791) (31784 . 31791)) nil (26799 6927 154549 0) 0 nil])
([nil nil ((31791 . 31792)) nil (26799 6927 154548 0) 0 nil])
([nil nil ((31792 . 31797)) nil (26799 6927 154548 0) 0 nil])
([nil nil ((31797 . 31803)) nil (26799 6927 154547 0) 0 nil])
([nil nil ((31803 . 31804)) nil (26799 6927 154546 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31885 . 31886) (nil fontified nil 31831 . 31886) (nil fontified nil 31804 . 31831) (31804 . 31886)) nil (26799 6927 154545 0) 0 nil])
([nil nil ((31886 . 31887)) nil (26799 6927 154545 0) 0 nil])
([nil nil ((31792 . 31797)) nil (26799 6927 154544 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31830 . 31831) (nil fontified nil 31830 . 31831) (nil fontified nil 31829 . 31830) (nil fontified nil 31823 . 31829) (nil fontified nil 31822 . 31823) (nil fontified nil 31807 . 31822) (nil fontified nil 31797 . 31807) (31797 . 31831)) nil (26799 6927 154543 0) 0 nil])
([nil nil ((#("Headers" 0 7 (face font-lock-string-face fontified t)) . -31808) (undo-tree-id207 . -7) (undo-tree-id208 . -4) (undo-tree-id209 . -4) (undo-tree-id210 . -4) (undo-tree-id211 . -4) (undo-tree-id212 . -4) (undo-tree-id213 . -7) (undo-tree-id214 . -7) (undo-tree-id215 . -7) (undo-tree-id216 . -7) 31815) nil (26799 6927 154542 0) 0 nil])
([nil nil ((31808 . 31815)) nil (26799 6927 154534 0) 0 nil])
([nil nil ((31815 . 31816)) nil (26799 6927 154534 0) 0 nil])
([nil nil ((31816 . 31821)) nil (26799 6927 154533 0) 0 nil])
([nil nil ((31821 . 31822)) nil (26799 6927 154533 0) 0 nil])
([nil nil ((#("headers" 0 6 (fontified t) 6 7 (fontified t rear-nonsticky t)) . -31830) (undo-tree-id193 . -7) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -7) (undo-tree-id200 . -7) (undo-tree-id201 . -7) (undo-tree-id202 . -7) (undo-tree-id203 . -7) (undo-tree-id204 . -7) (undo-tree-id205 . -7) (undo-tree-id206 . -7) 31837) nil (26799 6927 154531 0) 0 nil])
([nil nil ((31830 . 31834)) nil (26799 6927 154510 0) 0 nil])
([nil nil ((933 . 934) (t 26799 6927 0 0)) nil (26799 7199 363029 0) 0 nil])
([nil nil ((934 . 943)) nil (26799 7199 363028 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-builtin-face fontified t)) . -942) (undo-tree-id0 . -1) 943) nil (26799 7199 363027 0) 0 nil])
([nil nil ((942 . 946)) nil (26799 7199 363012 0) 0 nil])
([nil nil ((32244 . 32249) (t 26799 7199 0 0)) nil (26799 7368 187675 0) 0 nil])
([nil nil ((32249 . 32255)) nil (26799 7368 187674 0) 0 nil])
([nil nil ((32255 . 32256)) nil (26799 7368 187673 0) 0 nil])
([nil nil ((32256 . 32268)) nil (26799 7368 187670 0) 0 nil])
([nil nil ((#("
    (print (lumen.core.body:parse-urlencoded
				 (lumen.core.http:req-body-stream req) len*))" 0 95 (fontified t)) . 31848) (undo-tree-id1 . -95) (undo-tree-id2 . -95) (undo-tree-id3 . -95) (undo-tree-id4 . -95) (undo-tree-id5 . -95) (undo-tree-id6 . -95) (undo-tree-id7 . -95) (undo-tree-id8 . -95) (undo-tree-id9 . -95) (undo-tree-id10 . -95) (undo-tree-id11 . -95) (undo-tree-id12 . -95) (undo-tree-id13 . -95) (undo-tree-id14 . -95) (undo-tree-id15 . -95) (undo-tree-id16 . -95) (t 26799 7368 0 0)) nil (26799 7415 414850 0) 0 nil])
([nil nil ((56410 . 56414) (t 26799 7415 0 0)) nil (26799 9037 421011 0) 0 nil])
([nil nil ((56414 . 56415)) nil (26799 9037 421010 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -56414) (undo-tree-id76 . -1) 56415) nil (26799 9037 421010 0) 0 nil])
([nil nil ((56414 . 56419)) nil (26799 9037 421009 0) 0 nil])
([nil nil ((56419 . 56420)) nil (26799 9037 421008 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -56419) (undo-tree-id75 . -1) 56420) nil (26799 9037 421008 0) 0 nil])
([nil nil ((56419 . 56420)) nil (26799 9037 421006 0) 0 nil])
([nil nil ((56414 . 56415)) nil (26799 9037 421006 0) 0 nil])
([nil nil ((56421 . 56422)) nil (26799 9037 421005 0) 0 nil])
([nil nil ((56422 . 56423)) nil (26799 9037 421005 0) 0 nil])
([nil nil ((56423 . 56424)) nil (26799 9037 421004 0) 0 nil])
([nil nil ((56424 . 56425)) nil (26799 9037 421004 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -56424) (undo-tree-id74 . -1) 56425) nil (26799 9037 421003 0) 0 nil])
([nil nil ((56424 . 56430)) nil (26799 9037 421002 0) 0 nil])
([nil nil ((56430 . 56431)) nil (26799 9037 421002 0) 0 nil])
([nil nil ((56431 . 56432)) nil (26799 9037 421001 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -56430) (undo-tree-id72 . -1) (#(":" 0 1 (face font-lock-string-face fontified t)) . -56431) (undo-tree-id73 . -1) 56432) nil (26799 9037 421001 0) 0 nil])
([nil nil ((56430 . 56431)) nil (26799 9037 420999 0) 0 nil])
([nil nil ((56431 . 56432)) nil (26799 9037 420998 0) 0 nil])
([nil nil ((56432 . 56437)) nil (26799 9037 420998 0) 0 nil])
([nil nil ((56437 . 56438)) nil (26799 9037 420998 0) 0 nil])
([nil nil ((56438 . 56442)) nil (26799 9037 420997 0) 0 nil])
([nil nil ((56603 . 56611)) nil (26799 9037 420997 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56638 . 56639) (nil fontified nil 56634 . 56639) (nil fontified nil 56621 . 56634) (nil fontified nil 56611 . 56621) (56611 . 56639)) nil (26799 9037 420996 0) 0 nil])
([nil nil ((#("Token" 0 5 (face font-lock-string-face fontified t)) . -56622) (undo-tree-id71 . -5) 56627) nil (26799 9037 420995 0) 0 nil])
([nil nil ((56622 . 56629)) nil (26799 9037 420994 0) 0 nil])
([nil nil ((56635 . 56636)) nil (26799 9037 420994 0) 0 nil])
([nil nil ((56636 . 56637)) nil (26799 9037 420993 0) 0 nil])
([nil nil ((#("P" 0 1 (face font-lock-string-face fontified t)) . -56636) (undo-tree-id70 . -1) 56637) nil (26799 9037 420993 0) 0 nil])
([nil nil ((56636 . 56639)) nil (26799 9037 420991 0) 0 nil])
([nil nil ((56639 . 56640)) nil (26799 9037 420991 0) 0 nil])
([nil nil ((56640 . 56642)) nil (26799 9037 420990 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -56641) (undo-tree-id69 . -1) 56642) nil (26799 9037 420989 0) 0 nil])
([nil nil ((56641 . 56644)) nil (26799 9037 420988 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -56646) (undo-tree-id46 . -3) (undo-tree-id47 . -2) (undo-tree-id48 . -2) (undo-tree-id49 . -2) (undo-tree-id50 . -2) (undo-tree-id51 . -2) (undo-tree-id52 . -3) (undo-tree-id53 . -3) (undo-tree-id54 . -3) (undo-tree-id55 . -3) (undo-tree-id56 . -3) (undo-tree-id57 . -3) (undo-tree-id58 . -3) (undo-tree-id59 . -3) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -3) (undo-tree-id66 . -3) (undo-tree-id67 . -3) (undo-tree-id68 . -3) 56649) nil (26799 9037 420987 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56655 . 56656) (nil fontified nil 56646 . 56656) (56646 . 56656)) nil (26799 9037 420972 0) 0 nil])
([nil nil ((56410 . 56414)) nil (26799 9037 420971 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56441 . 56442) (nil fontified nil 56437 . 56442) (nil fontified nil 56424 . 56437) (nil fontified nil 56414 . 56424) (56414 . 56442)) nil (26799 9037 420970 0) 0 nil])
([nil nil ((#("Token" 0 5 (face font-lock-string-face fontified t)) . -56425) (undo-tree-id31 . -5) (undo-tree-id32 . -2) (undo-tree-id33 . -2) (undo-tree-id34 . -2) (undo-tree-id35 . -2) (undo-tree-id36 . -2) (undo-tree-id37 . -2) (undo-tree-id38 . -2) (undo-tree-id39 . -2) (undo-tree-id40 . -2) (undo-tree-id41 . -2) (undo-tree-id42 . -5) (undo-tree-id43 . -5) (undo-tree-id44 . -5) (undo-tree-id45 . -5) 56430) nil (26799 9037 420969 0) 0 nil])
([nil nil ((56425 . 56428)) nil (26799 9037 420957 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -56436) (undo-tree-id17 . -3) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -3) (undo-tree-id24 . -3) (undo-tree-id25 . -3) (undo-tree-id26 . -3) (undo-tree-id27 . -3) (undo-tree-id28 . -3) (undo-tree-id29 . -3) (undo-tree-id30 . -3) 56439) nil (26799 9037 420955 0) 0 nil])
([nil nil ((56436 . 56439)) nil (26799 9037 420932 0) 0 nil])
([nil nil ((#("~" 0 1 (face font-lock-string-face fontified t)) . -56665) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) 56666 (t 26799 9037 0 0)) nil (26799 9132 310828 0) 0 nil])
([nil nil ((60027 . 60029) (t 26799 9132 0 0)) nil (26799 16582 479414 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60134 . 60135) (nil fontified nil 60029 . 60135) (60029 . 60135)) nil (26799 16582 479413 0) 0 nil])
([nil nil ((60527 . 60530)) nil (26799 16582 479412 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60561 . 60562) (nil fontified nil 60530 . 60562) (60530 . 60562)) nil (26799 16582 479411 0) 0 nil])
([nil nil ((60838 . 60839)) nil (26799 16582 479407 0) 0 nil])
([nil nil ((946 . 947) (t 26799 16582 0 0)) nil (26799 48715 862284 0) 0 nil])
([nil nil ((947 . 948)) nil (26799 48715 862283 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 963 . 964) (nil fontified nil 953 . 964) (nil fontified nil 948 . 953) (948 . 964)) nil (26799 48715 862279 0) 0 nil])
([nil nil ((60881 . 60882) (t 26799 48715 0 0)) nil (26800 1416 759359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 63611 . 63612) (nil fontified nil 60882 . 63612) (60882 . 63612)) nil (26800 1416 759359 0) 0 nil])
([nil nil ((#("
(defun https-redirect (&key
                         (prefixes '(\"/\"))     ; prÃ©fixes Ã  forcer en https
                         (ssl-port 443)        ; port public https
                         (hsts nil)            ; ex: t  â†’ ajouter Strict-Transport-Security
                         (hsts-max-age 15552000) ; 180 jours
                         (hsts-include-subdomains t)
                         (hsts-preload nil))
  \"Redirige HTTP â†’ HTTPS (301) pour les chemins dont le prÃ©fixe matche.
Options:
- PREFIXES : liste de prÃ©fixes (strings) Ã  forcer en https (\\\"/\\\" pour tout).
- SSL-PORT : port https externe (443 par dÃ©faut).
- HSTS    : si T, ajoute Strict-Transport-Security (uniquement sur rÃ©ponses *dÃ©jÃ * HTTPS).\"
  (lambda (next)
    (lambda (req)
      (let* ((path (lumen.core.http:req-path req))
             (force-p (some (lambda (pfx) (%path-has-prefix-p path pfx)) prefixes))
             (secure? (%request-secure-p req)))
        (cond
          ;; Si dÃ©jÃ  HTTPS : on laisse passer, et on peut ajouter HSTS si demandÃ©.
          (secure?
           (let ((resp (funcall next req)))
             (when hsts
               (let* ((hdrs (lumen.core.http:resp-headers resp))
                      (val  (with-output-to-string (s)
                              (format s \"max-age=~D\" hsts-max-age)
                              (when hsts-include-subdomains (format s \"; includeSubDomains\"))
                              (when hsts-preload           (format s \"; preload\")))))
                 (setf (lumen.core.http:resp-headers resp)
                       (lumen.utils:ensure-header hdrs \"strict-transport-security\" val))))
             resp))
          ;; HTTP + ciblÃ© â†’ 301 vers https
          ((and force-p (not secure?))
           (let* ((loc (%https-location req :ssl-port ssl-port))
                  (headers (list (cons \"location\" loc)
                                 (cons \"cache-control\" \"no-store\"))))
             (make-instance 'lumen.core.http:response
                            :status 301 :headers headers :body \"\")))
          ;; HTTP mais non ciblÃ© â†’ passer au suivant
          (t
           (funcall next req)))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 22 (face font-lock-function-name-face fontified t) 22 24 (fontified t) 24 28 (face font-lock-type-face fontified t) 28 66 (fontified t) 66 69 (face font-lock-string-face fontified t) 69 76 (fontified t) 76 105 (face font-lock-comment-face fontified t) 105 152 (fontified t) 152 172 (face font-lock-comment-face fontified t) 172 219 (fontified t) 219 264 (face font-lock-comment-face fontified t) 264 313 (fontified t) 313 325 (face font-lock-comment-face fontified t) 325 425 (fontified t) 425 723 (face font-lock-doc-face fontified t) 723 727 (fontified t) 727 733 (face font-lock-keyword-face fontified t) 733 746 (fontified t) 746 752 (face font-lock-keyword-face fontified t) 752 766 (fontified t) 766 770 (face font-lock-keyword-face fontified t) 770 839 (fontified t) 839 843 (face font-lock-keyword-face fontified t) 843 845 (face font-lock-keyword-face fontified t) 845 894 (fontified t) 894 951 (fontified t) 951 955 (face font-lock-keyword-face fontified t) 955 966 (fontified t) 966 969 (face font-lock-comment-delimiter-face fontified t) 969 1039 (face font-lock-comment-face fontified t) 1039 1070 (fontified t) 1070 1073 (face font-lock-keyword-face fontified t) 1073 1116 (fontified t) 1116 1120 (face font-lock-keyword-face fontified t) 1120 1142 (fontified t) 1142 1146 (face font-lock-keyword-face fontified t) 1146 1220 (fontified t) 1220 1241 (face font-lock-keyword-face fontified t) 1241 1286 (fontified t) 1286 1298 (face font-lock-string-face fontified t) 1298 1344 (fontified t) 1344 1348 (face font-lock-keyword-face fontified t) 1348 1383 (fontified t) 1383 1404 (face font-lock-string-face fontified t) 1404 1438 (fontified t) 1438 1442 (face font-lock-keyword-face fontified t) 1442 1476 (fontified t) 1476 1487 (face font-lock-string-face fontified t) 1487 1501 (fontified t) 1501 1516 (fontified t) 1516 1552 (fontified t) 1552 1607 (fontified t) 1607 1634 (face font-lock-string-face fontified t) 1634 1673 (fontified t) 1673 1676 (face font-lock-comment-delimiter-face fontified t) 1676 1706 (face font-lock-comment-face fontified t) 1706 1757 (fontified t) 1757 1761 (face font-lock-keyword-face fontified t) 1761 1789 (fontified t) 1789 1798 (face font-lock-builtin-face fontified t) 1798 1849 (fontified t) 1849 1859 (face font-lock-string-face fontified t) 1859 1904 (fontified t) 1904 1919 (face font-lock-string-face fontified t) 1919 1920 (fontified t) 1920 1930 (face font-lock-string-face fontified t) 1930 2017 (fontified t) 2017 2024 (face font-lock-builtin-face fontified t) 2024 2029 (fontified t) 2029 2037 (face font-lock-builtin-face fontified t) 2037 2046 (fontified t) 2046 2051 (face font-lock-builtin-face fontified t) 2051 2052 (fontified t) 2052 2054 (face font-lock-string-face fontified t) 2054 2068 (fontified t) 2068 2071 (face font-lock-comment-delimiter-face fontified t) 2071 2111 (face font-lock-comment-face fontified t) 2111 2159 (fontified t)) . -63612) (undo-tree-id5 . -2159) 65771) nil (26800 1416 759358 0) 0 nil])
([nil nil ((#("
    (print \"XXXXXXXXX\")" 0 12 (fontified t) 12 23 (face font-lock-string-face fontified t) 23 24 (fontified t)) . 32167) (undo-tree-id4 . -24)) nil (26800 1416 759356 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3757) (undo-tree-id3 . -1) 3758) nil (26800 1416 759355 0) 0 nil])
([nil nil ((#("(let* ((headers (lumen.core.http:req-headers req))
         (ct      (cdr (assoc \"content-type\" headers :test #'string-equal)))
         (len     (cdr (assoc \"content-length\" headers :test #'string-equal)))
         (len*    (when len (parse-integer len :junk-allowed t))))
    (format t \"Headers: ~A~%\" headers)
    (format t \"Content Length: ~A~%\" len*)
    (when (and ct len* (> len* 0)
               (search \"application/x-www-form-urlencoded\" (string-downcase ct)))
      (lumen.core.http:ctx-set! req :form
				(lumen.core.body:parse-urlencoded
				 (lumen.core.http:req-body-stream req) len*))
      (lumen.core.http:ctx-set! req :body-consumed t))
    (funcall next req)))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 81 (fontified t) 81 95 (face font-lock-string-face fontified t) 95 104 (fontified t) 104 109 (face font-lock-builtin-face fontified t) 109 158 (fontified t) 158 174 (face font-lock-string-face fontified t) 174 183 (fontified t) 183 188 (face font-lock-builtin-face fontified t) 188 226 (fontified t) 226 230 (face font-lock-keyword-face fontified t) 230 254 (fontified t) 254 267 (face font-lock-builtin-face fontified t) 267 288 (fontified t) 288 303 (face font-lock-string-face fontified t) 303 327 (fontified t) 327 349 (face font-lock-string-face fontified t) 349 361 (fontified t) 361 365 (face font-lock-keyword-face fontified t) 365 413 (fontified t) 413 448 (face font-lock-string-face fontified t) 448 508 (fontified t) 508 513 (face font-lock-builtin-face fontified t) 513 583 (fontified t) 583 602 (fontified t) 602 638 (fontified t) 638 652 (face font-lock-builtin-face fontified t) 652 656 (fontified t) 656 657 (fontified t) 657 681 (fontified t)) . 31510) (undo-tree-id2 . -681)) nil (26800 1416 759353 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 32168 . 32169) (nil fontified nil 31510 . 32169) (31510 . 32169)) nil (26800 1416 759352 0) 0 nil])
([nil nil ((#("(let* ((h (lumen.core.http:req-headers req))
         (ct (cdr (assoc \"content-type\" h :test #'string-equal)))
         (len (cdr (assoc \"content-length\" h :test #'string-equal)))
         (len* (when len (parse-integer len :junk-allowed t))))
    (when (and ct len* (> len* 0)
               (search \"multipart/form-data\" (string-downcase ct)))
      (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
        (when res
          (lumen.core.http:ctx-set! req :fields (cdr (assoc :fields res)))
          (lumen.core.http:ctx-set! req :files  (cdr (assoc :files  res)))
	  (lumen.core.http:ctx-set! req :body-consumed t)))))
  (funcall next req))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 70 (fontified t) 70 84 (face font-lock-string-face fontified t) 84 87 (fontified t) 87 92 (face font-lock-builtin-face fontified t) 92 137 (fontified t) 137 153 (face font-lock-string-face fontified t) 153 156 (fontified t) 156 161 (face font-lock-builtin-face fontified t) 161 196 (fontified t) 196 200 (face font-lock-keyword-face fontified t) 200 224 (fontified t) 224 237 (face font-lock-builtin-face fontified t) 237 249 (fontified t) 249 253 (face font-lock-keyword-face fontified t) 253 301 (fontified t) 301 322 (face font-lock-string-face fontified t) 322 353 (fontified t) 353 356 (face font-lock-keyword-face fontified t) 356 454 (fontified t) 454 458 (face font-lock-keyword-face fontified t) 458 503 (fontified t) 503 510 (face font-lock-builtin-face fontified t) 510 523 (fontified t) 523 530 (face font-lock-builtin-face fontified t) 530 578 (fontified t) 578 584 (face font-lock-builtin-face fontified t) 584 598 (fontified t) 598 604 (face font-lock-builtin-face fontified t) 604 623 (fontified t) 623 646 (fontified t) 646 660 (face font-lock-builtin-face fontified t) 660 668 (fontified t) 668 689 (fontified t)) . 32279) (undo-tree-id0 . -689) (undo-tree-id1 . -283)) nil (26800 1416 759350 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33052 . 33053) (nil fontified nil 32279 . 33053) (32279 . 33053)) nil (26800 1416 759333 0) 0 nil])
([nil nil ((64236 . 64237) (t 26800 1416 0 0)) nil (26800 38057 103891 0) 0 nil])
([nil nil ((nil fontified nil 65827 . 65828) (nil fontified nil 65807 . 65827) (nil fontified nil 65799 . 65807) (nil fontified nil 65785 . 65799) (nil fontified nil 65753 . 65785) (nil fontified nil 65656 . 65753) (nil fontified nil 65653 . 65656) (nil fontified nil 65642 . 65653) (nil fontified nil 65635 . 65642) (nil fontified nil 65613 . 65635) (nil fontified nil 65599 . 65613) (nil fontified nil 65583 . 65599) (nil fontified nil 65575 . 65583) (nil fontified nil 65549 . 65575) (nil fontified nil 65530 . 65549) (nil fontified nil 65527 . 65530) (nil fontified nil 65522 . 65527) (nil fontified nil 65517 . 65522) (nil fontified nil 65511 . 65517) (nil fontified nil 65445 . 65511) (nil fontified nil 65434 . 65445) (nil fontified nil 65406 . 65434) (nil fontified nil 65402 . 65406) (nil fontified nil 65390 . 65402) (nil fontified nil 65377 . 65390) (nil fontified nil 65316 . 65377) (nil fontified nil 65311 . 65316) (nil fontified nil 65249 . 65311) (nil fontified nil 65233 . 65249) (nil fontified nil 65213 . 65233) (nil fontified nil 65209 . 65213) (nil fontified nil 65206 . 65209) (nil fontified nil 65198 . 65206) (nil fontified nil 65172 . 65198) (nil fontified nil 65168 . 65172) (nil fontified nil 65143 . 65168) (nil fontified nil 65131 . 65143) (nil fontified nil 65126 . 65131) (nil fontified nil 65125 . 65126) (nil fontified nil 65124 . 65125) (nil fontified nil 65123 . 65124) (nil fontified nil 65076 . 65123) (nil fontified nil 65072 . 65076) (nil fontified nil 65071 . 65072) (nil fontified nil 65070 . 65071) (nil fontified nil 65069 . 65070) (nil fontified nil 65060 . 65069) (nil fontified nil 65051 . 65060) (nil fontified nil 65044 . 65051) (nil fontified nil 65027 . 65044) (nil fontified nil 65010 . 65027) (nil fontified nil 65007 . 65010) (nil fontified nil 64999 . 65007) (nil fontified nil 64996 . 64999) (nil fontified nil 64987 . 64996) (nil fontified nil 64984 . 64987) (nil fontified nil 64979 . 64984) (nil fontified nil 64974 . 64979) (nil fontified nil 64968 . 64974) (nil fontified nil 64896 . 64968) (nil fontified nil 64885 . 64896) (nil fontified nil 64876 . 64885) (nil fontified nil 64862 . 64876) (nil fontified nil 64859 . 64862) (nil fontified nil 64835 . 64859) (nil fontified nil 64827 . 64835) (nil fontified nil 64785 . 64827) (nil fontified nil 64779 . 64785) (nil fontified nil 64764 . 64779) (nil fontified nil 64733 . 64764) (nil fontified nil 64634 . 64733) (nil fontified nil 64603 . 64634) (nil fontified nil 64567 . 64603) (nil fontified nil 64564 . 64567) (nil fontified nil 64552 . 64564) (nil fontified nil 64546 . 64552) (nil fontified nil 64403 . 64546) (nil fontified nil 64394 . 64403) (nil fontified nil 64358 . 64394) (nil fontified nil 64354 . 64358) (nil fontified nil 64339 . 64354) (nil fontified nil 64335 . 64339) (nil fontified nil 64308 . 64335) (nil fontified nil 64291 . 64308) (nil fontified nil 64290 . 64291) (nil fontified nil 64289 . 64290) (nil fontified nil 64288 . 64289) (nil fontified nil 64257 . 64288) (nil fontified nil 64241 . 64257) (nil fontified nil 64237 . 64241) (64237 . 65828)) nil (26800 38057 103888 0) 0 nil])
([nil nil ((1288 . 1292) (1242 . 1246) (#("   " 0 3 (fontified nil)) . 1242) (1286 . 1287)) nil (26800 38057 103881 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1322 . 1323) (nil fontified nil 1310 . 1323) (nil fontified nil 1309 . 1310) (nil fontified nil 1308 . 1309) (nil fontified nil 1307 . 1308) (nil fontified nil 1293 . 1307) (nil fontified nil 1292 . 1293) (1292 . 1323)) nil (26800 38057 103879 0) 0 nil])
([nil nil ((65865 . 65866)) nil (26800 38057 103875 0) 0 nil])
([nil nil ((#("define-middleware" 0 17 (face font-lock-keyword-face fontified t)) . -64328) (undo-tree-id21 . -17) 64345 (t 26800 38057 0 0)) nil (26800 38226 689683 0) 0 nil])
([nil nil ((64328 . 64329)) nil (26800 38226 689682 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -64328) (undo-tree-id20 . -1) 64329) nil (26800 38226 689682 0) 0 nil])
([nil nil ((64328 . 64333)) nil (26800 38226 689681 0) 0 nil])
([nil nil ((64375 . 64378)) nil (26800 38226 689680 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 64409 . 64410) (nil fontified nil 64404 . 64410) (nil fontified nil 64398 . 64404) (nil fontified nil 64385 . 64398) (nil fontified nil 64379 . 64385) (nil fontified nil 64378 . 64379) (64378 . 64410)) nil (26800 38226 689680 0) 0 nil])
([nil nil ((65130 . 65132)) nil (26800 38226 689679 0) 0 nil])
([nil nil ((#("define-middleware" 0 5 (face font-lock-keyword-face fontified t) 5 17 (face font-lock-keyword-face fontified t)) . -65188) (undo-tree-id18 . -17) (undo-tree-id19 . -6) 65205) nil (26800 38226 689678 0) 0 nil])
([nil nil ((65188 . 65189)) nil (26800 38226 689676 0) 0 nil])
([nil nil ((65189 . 65193)) nil (26800 38226 689676 0) 0 nil])
([nil nil ((#("req next " 0 9 (fontified t)) . -64351) (undo-tree-id7 . -9) (undo-tree-id8 . -8) (undo-tree-id9 . -8) (undo-tree-id10 . -8) (undo-tree-id11 . -8) (undo-tree-id12 . -9) (undo-tree-id13 . -9) (undo-tree-id14 . -9) (undo-tree-id15 . -9) (undo-tree-id16 . -9) (undo-tree-id17 . -9) 64360) nil (26800 38226 689675 0) 0 nil])
([nil nil ((#("req next " 0 9 (fontified t)) . -65200) (undo-tree-id0 . -9) (undo-tree-id1 . -9) (undo-tree-id2 . -9) (undo-tree-id3 . -9) (undo-tree-id4 . -9) (undo-tree-id5 . -9) (undo-tree-id6 . -9) 65209) nil (26800 38226 689668 0) 0 nil])
([nil nil ((65237 . 65240)) nil (26800 38226 689651 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 65271 . 65272) (nil fontified nil 65266 . 65272) (nil fontified nil 65260 . 65266) (nil fontified nil 65247 . 65260) (nil fontified nil 65241 . 65247) (nil fontified nil 65240 . 65241) (65240 . 65272)) nil (26800 38226 689651 0) 0 nil])
([nil nil ((65142 . 65143) (#("    " 0 4 (fontified t)) . 65142) (65123 . 65126) (65041 . 65044) (64995 . 64999) (64952 . 64956) (64923 . 64927) (64839 . 64842) (#("      " 0 6 (fontified t)) . 64839) (64798 . 64799) (#("    " 0 4 (fontified t)) . 64798) (64751 . 64755) (64715 . 64719) (64660 . 64664) (64617 . 64621) (#("       " 0 7 (fontified t)) . 64617) (64604 . 64606) (#("     " 0 5 (fontified t)) . 64604) (64573 . 64574) (#("    " 0 4 (fontified t)) . 64573) (64557 . 64561) (64533 . 64537) (64470 . 64474) (64404 . 64408) 64327) nil (26800 38226 689649 0) 0 nil])
([nil nil ((65923 . 65924)) nil (26800 38226 689646 0) 0 nil])
([nil nil ((65924 . 65925)) nil (26800 38226 689645 0) 0 nil])
([nil nil ((65910 . 65914) (65852 . 65856) (65746 . 65750) (65725 . 65728) (65659 . 65664) (#("                       " 0 23 (fontified t)) . 65659) (65613 . 65616) (65569 . 65573) (65531 . 65534) (#("      " 0 6 (fontified t)) . 65531) (65504 . 65505) (#("    " 0 4 (fontified t)) . 65504) (65447 . 65451) (65410 . 65414) (65303 . 65307) 65206) nil (26800 38226 689641 0) 0 nil])
([nil nil ((65936 . 65939) (t 26800 38226 0 0)) nil (26800 39792 431436 0) 0 nil])
([nil nil ((65939 . 65940)) nil (26800 39792 431435 0) 0 nil])
([nil nil ((65940 . 65946)) nil (26800 39792 431435 0) 0 nil])
([nil nil ((65946 . 65947)) nil (26800 39792 431435 0) 0 nil])
([nil nil ((65947 . 65950)) nil (26800 39792 431434 0) 0 nil])
([nil nil ((65950 . 65951)) nil (26800 39792 431434 0) 0 nil])
([nil nil ((65951 . 65955)) nil (26800 39792 431433 0) 0 nil])
([nil nil ((65955 . 65956)) nil (26800 39792 431432 0) 0 nil])
([nil nil ((65936 . 65937)) nil (26800 39792 431432 0) 0 nil])
([nil nil ((65956 . 65957)) nil (26800 39792 431431 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 68713 . 68714) (nil fontified nil 65957 . 68714) (65957 . 68714)) nil (26800 39792 431431 0) 0 nil])
([nil nil ((3713 . 3715)) nil (26800 39792 431430 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5899 . 5900) (nil fontified nil 3715 . 5900) (3715 . 5900)) nil (26800 39792 431430 0) 0 nil])
([nil nil ((3181 . 3182)) nil (26800 39792 431429 0) 0 nil])
([nil nil ((3182 . 3184)) nil (26800 39792 431428 0) 0 nil])
([nil nil ((3717 . 3719)) nil (26800 39792 431428 0) 0 nil])
([nil nil ((3719 . 3720)) nil (26800 39792 431427 0) 0 nil])
([nil nil ((1323 . 1324)) nil (26800 39792 431427 0) 0 nil])
([nil nil ((1324 . 1325)) nil (26800 39792 431426 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -1324) (undo-tree-id2 . -1) 1325) nil (26800 39792 431426 0) 0 nil])
([nil nil ((1324 . 1333)) nil (26800 39792 431423 0) 0 nil])
([nil nil ((1324 . 1339) (#("access-lo" 0 9 (fontified t)) . -1324) (undo-tree-id1 . -9) 1333) nil (26800 39792 431422 0) 0 nil])
([nil nil ((1331 . 1332)) nil (26800 39792 431420 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -1331) (undo-tree-id0 . -1) 1332) nil (26800 39792 431418 0) 0 nil])
([nil nil ((1324 . 1325)) nil (26800 39792 431402 0) 0 nil])
([nil nil ((66942 . 66949) (#(" " 0 1 (fontified nil)) . 66941) (undo-tree-id11 . -1) (66942 . 66943) (t 26800 39792 0 0)) nil (26800 40262 284102 0) 0 nil])
([nil nil ((68173 . 68174)) nil (26800 40262 284101 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 72388 . 72389) (nil fontified nil 68174 . 72389) (68174 . 72389)) nil (26800 40262 284100 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -72388) (undo-tree-id10 . -1) 72389) nil (26800 40262 284099 0) 0 nil])
([nil nil ((#("
(defun %open-log-file (path)
  (open path :direction :output :if-exists :append :if-does-not-exist :create
             :external-format :utf-8))

(defun %rfc3339-now ()
  (local-time:format-timestring
   nil (local-time:now)
   :format '(:year \"-\" (:month 2) \"-\" (:day 2) \"T\" (:hour 2) \":\" (:min 2) \":\" (:sec 2) \"Z\")))

(defun access-log-json (&key stream to-file)
  \"Retourne un middleware qui Ã©crit une ligne JSON par requÃªte.
Si TO-FILE est fourni, ouvre le fichier (append, UTF-8) ; sinon utilise STREAM (par dÃ©faut *standard-output*).\"
  (let* ((out (or (and to-file (%open-log-file to-file))
                  (or stream *standard-output*)))
         (lock (bordeaux-threads:make-lock \"access-log-json\")))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0  (get-internal-real-time))
                 (rid (or (lumen.core.http:ctx-get req :request-id) \"\"))
                 (ip  (or (let* ((xff (h \"x-forwarded-for\")))
                            (and xff (car (uiop:split-string xff :separator \",\"))))
                          (h \"x-real-ip\") \"\"))
                 (mth (or (lumen.core.http:req-method req) \"GET\"))
                 (host (or (h \"host\") \"\"))
                 (pth (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms  (/ (- (get-internal-real-time) t0)
                         (/ internal-time-units-per-second 1000.0)))
                 (body (lumen.core.http:resp-body resp))
                 (bytes (cond
                          ((stringp body) (length (trivial-utf-8:string-to-utf-8-bytes body)))
                          ((typep body '(simple-array (unsigned-byte 8) (*))) (length body))
                          (t nil))) ; streaming inconnu â†’ omis
                 (obj `((:ts . ,(%rfc3339-now))
                        (:request_id . ,rid)
                        (:ip . ,ip)
                        (:method . ,mth)
                        (:host . ,host)
                        (:path . ,pth)
                        (:status . ,(lumen.core.http:resp-status resp))
                        (:ms . ,(round ms))
                        ,@(when bytes `((:bytes . ,bytes))))))
            ;; Ã©criture thread-safe
            (bordeaux-threads:with-lock-held (lock)
              (handler-case
                  (progn
                    (write-string (cl-json:encode-json-to-string obj) out)
                    (terpri out)
                    (finish-output out))
                (error (_)
                  (declare (ignore _))
                  (format out \"~S~%\" obj)
                  (finish-output out))))
            resp))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 43 (fontified t) 43 53 (face font-lock-builtin-face fontified t) 53 54 (fontified t) 54 61 (face font-lock-builtin-face fontified t) 61 62 (fontified t) 62 72 (face font-lock-builtin-face fontified t) 72 73 (fontified t) 73 80 (face font-lock-builtin-face fontified t) 80 81 (fontified t) 81 99 (face font-lock-builtin-face fontified t) 99 100 (fontified t) 100 107 (face font-lock-builtin-face fontified t) 107 121 (fontified t) 121 137 (face font-lock-builtin-face fontified t) 137 138 (fontified t) 138 144 (face font-lock-builtin-face fontified t) 144 149 (fontified t) 149 154 (face font-lock-keyword-face fontified t) 154 155 (fontified t) 155 161 (face font-lock-function-name-face fontified t) 161 167 (face font-lock-function-name-face fontified t) 167 171 (fontified t) 171 230 (fontified t) 230 237 (face font-lock-builtin-face fontified t) 237 240 (fontified t) 240 241 (face font-lock-builtin-face fontified t) 241 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 249 (face font-lock-string-face fontified t) 249 251 (fontified t) 251 257 (face font-lock-builtin-face fontified t) 257 261 (fontified t) 261 264 (face font-lock-string-face fontified t) 264 266 (fontified t) 266 270 (face font-lock-builtin-face fontified t) 270 274 (fontified t) 274 277 (face font-lock-string-face fontified t) 277 279 (fontified t) 279 284 (face font-lock-builtin-face fontified t) 284 288 (fontified t) 288 291 (face font-lock-string-face fontified t) 291 293 (fontified t) 293 297 (face font-lock-builtin-face fontified t) 297 301 (fontified t) 301 304 (face font-lock-string-face fontified t) 304 306 (fontified t) 306 310 (face font-lock-builtin-face fontified t) 310 314 (fontified t) 314 317 (face font-lock-string-face fontified t) 317 321 (fontified t) 321 322 (fontified t) 322 323 (fontified t) 323 328 (face font-lock-keyword-face fontified t) 328 329 (fontified t) 329 337 (face font-lock-function-name-face fontified t) 337 344 (face font-lock-function-name-face fontified t) 344 346 (fontified t) 346 350 (face font-lock-type-face fontified t) 350 369 (fontified t) 369 542 (face font-lock-doc-face fontified t) 542 546 (fontified t) 546 550 (face font-lock-keyword-face fontified t) 550 693 (fontified t) 693 710 (face font-lock-string-face fontified t) 710 719 (fontified t) 719 725 (face font-lock-keyword-face fontified t) 725 740 (fontified t) 740 746 (face font-lock-keyword-face fontified t) 746 762 (fontified t) 762 768 (face font-lock-keyword-face fontified t) 768 850 (fontified t) 850 855 (face font-lock-builtin-face fontified t) 855 886 (fontified t) 886 890 (face font-lock-keyword-face fontified t) 890 978 (fontified t) 978 989 (face font-lock-builtin-face fontified t) 989 991 (fontified t) 991 993 (face font-lock-string-face fontified t) 993 1023 (fontified t) 1023 1027 (face font-lock-keyword-face fontified t) 1027 1037 (fontified t) 1037 1054 (face font-lock-string-face fontified t) 1054 1123 (fontified t) 1123 1133 (face font-lock-builtin-face fontified t) 1133 1134 (fontified t) 1134 1137 (face font-lock-string-face fontified t) 1137 1171 (fontified t) 1171 1182 (face font-lock-string-face fontified t) 1182 1184 (fontified t) 1184 1186 (face font-lock-string-face fontified t) 1186 1248 (fontified t) 1248 1253 (face font-lock-string-face fontified t) 1253 1286 (fontified t) 1286 1292 (face font-lock-string-face fontified t) 1292 1294 (fontified t) 1294 1296 (face font-lock-string-face fontified t) 1296 1356 (fontified t) 1356 1359 (face font-lock-string-face fontified t) 1359 1394 (fontified t) 1394 1405 (fontified t) 1405 1501 (fontified t) 1501 1531 (fontified t) 1531 1613 (fontified t) 1613 1617 (face font-lock-keyword-face fontified t) 1617 1837 (fontified t) 1837 1842 (fontified t) 1842 1869 (face font-lock-comment-face fontified t) 1869 1894 (fontified t) 1894 1897 (face font-lock-builtin-face fontified t) 1897 1942 (fontified t) 1942 1953 (face font-lock-builtin-face fontified t) 1953 1987 (fontified t) 1987 1990 (face font-lock-builtin-face fontified t) 1990 2023 (fontified t) 2023 2030 (face font-lock-builtin-face fontified t) 2030 2064 (fontified t) 2064 2069 (face font-lock-builtin-face fontified t) 2069 2104 (fontified t) 2104 2109 (face font-lock-builtin-face fontified t) 2109 2143 (fontified t) 2143 2150 (face font-lock-builtin-face fontified t) 2150 2215 (fontified t) 2215 2218 (face font-lock-builtin-face fontified t) 2218 2261 (fontified t) 2261 2265 (face font-lock-keyword-face fontified t) 2265 2275 (fontified t) 2275 2281 (face font-lock-builtin-face fontified t) 2281 2309 (fontified t) 2309 2312 (face font-lock-comment-delimiter-face fontified t) 2312 2333 (face font-lock-comment-face fontified t) 2333 2346 (fontified t) 2346 2377 (face font-lock-keyword-face fontified t) 2377 2400 (fontified t) 2400 2412 (face font-lock-keyword-face fontified t) 2412 2432 (fontified t) 2432 2437 (face font-lock-keyword-face fontified t) 2437 2604 (fontified t) 2604 2609 (face font-lock-warning-face fontified t) 2609 2633 (fontified t) 2633 2640 (face font-lock-keyword-face fontified t) 2640 2683 (fontified t) 2683 2689 (face font-lock-string-face fontified t) 2689 2757 (fontified t) 2757 2758 (fontified t rear-nonsticky t) 2758 2759 (fontified t)) . -72388) (undo-tree-id3 . -1) (undo-tree-id4 . -173) (undo-tree-id5 . -2759) (undo-tree-id6 . -322) (undo-tree-id7 . -1531) (undo-tree-id8 . -2355) (undo-tree-id9 . -2759) 75147) nil (26800 40262 284096 0) 0 nil])
([nil nil ((72388 . 72389)) nil (26800 40262 284076 0) 0 nil])
([nil nil ((3941 . 3943) (t 26800 40262 0 0)) nil (26800 40390 193153 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5523 . 5524) (nil fontified nil 3943 . 5524) (3943 . 5524)) nil (26800 40390 193152 0) 0 nil])
([nil nil ((#("

(defun logger (&key (stream *terminal-io*) (color t))
  \"Logger concis: [ts] ip METHOD host path -> status (ms)\"
  (lambda (next)
    (lambda (req)
      (labels ((h (name)
                 (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
        (let* ((t0   (get-internal-real-time))
               (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                           (and xff (car (uiop:split-string xff :separator \",\"))))
                         (h \"x-real-ip\") \"\"))
               (host (or (h \"host\") \"\"))
               (meth (or (lumen.core.http:req-method req) \"GET\"))
               (path (or (lumen.core.http:req-path req) \"/\"))
               (resp (funcall next req))
               (ms   (/ (- (get-internal-real-time) t0)
                        (/ internal-time-units-per-second 1000.0)))
               (st   (lumen.core.http:resp-status resp)))
          (if color
              (format stream \"[~A] ~A ~A ~A ~A -> ~C[~A m=~A~C[0m (~,0F ms)~%\"
                      (local-time:format-timestring nil (local-time:now)
                                                    :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                                              (:hour 2) \":\" (:min 2) \":\" (:sec 2)))
                      ip meth host path
                      #\\Esc (concatenate 'string (format nil \"~A\" st)
                                         (format nil \"~C[0;~am\" #\\Esc (%status-color st))) ; pour aligner la coloration
                      #\\Esc
                      ms)
            (format stream \"[~A] ~A ~A ~A ~A -> ~A (~,0F ms)~%\"
                    (local-time:format-timestring nil (local-time:now)
                                                  :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                                            (:hour 2) \":\" (:min 2) \":\" (:sec 2)))
                    ip meth host path st ms))
          (finish-output stream)
          resp)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 15 (face font-lock-function-name-face fontified t) 15 17 (fontified t) 17 21 (face font-lock-type-face fontified t) 21 58 (fontified t) 58 114 (face font-lock-doc-face fontified t) 114 118 (fontified t) 118 124 (face font-lock-keyword-face fontified t) 124 137 (fontified t) 137 143 (face font-lock-keyword-face fontified t) 143 157 (fontified t) 157 163 (face font-lock-keyword-face fontified t) 163 243 (fontified t) 243 248 (face font-lock-builtin-face fontified t) 248 277 (fontified t) 277 281 (face font-lock-keyword-face fontified t) 281 341 (fontified t) 341 345 (face font-lock-keyword-face fontified t) 345 355 (fontified t) 355 372 (face font-lock-string-face fontified t) 372 440 (fontified t) 440 450 (face font-lock-builtin-face fontified t) 450 451 (fontified t) 451 454 (face font-lock-string-face fontified t) 454 487 (fontified t) 487 498 (face font-lock-string-face fontified t) 498 500 (fontified t) 500 502 (face font-lock-string-face fontified t) 502 533 (fontified t) 533 539 (face font-lock-string-face fontified t) 539 541 (fontified t) 541 543 (face font-lock-string-face fontified t) 543 604 (fontified t) 604 609 (face font-lock-string-face fontified t) 609 668 (fontified t) 668 671 (face font-lock-string-face fontified t) 671 764 (fontified t) 764 771 (fontified t) 771 782 (fontified t) 782 839 (fontified t) 839 908 (fontified t) 908 910 (face font-lock-keyword-face fontified t) 910 946 (fontified t) 946 995 (face font-lock-string-face fontified t) 995 1121 (fontified t) 1121 1128 (face font-lock-builtin-face fontified t) 1128 1131 (fontified t) 1131 1136 (face font-lock-builtin-face fontified t) 1136 1137 (fontified t) 1137 1140 (face font-lock-string-face fontified t) 1140 1142 (fontified t) 1142 1148 (face font-lock-builtin-face fontified t) 1148 1152 (fontified t) 1152 1155 (face font-lock-string-face fontified t) 1155 1157 (fontified t) 1157 1161 (face font-lock-builtin-face fontified t) 1161 1165 (fontified t) 1165 1168 (face font-lock-string-face fontified t) 1168 1232 (fontified t) 1232 1237 (face font-lock-builtin-face fontified t) 1237 1241 (fontified t) 1241 1244 (face font-lock-string-face fontified t) 1244 1246 (fontified t) 1246 1250 (face font-lock-builtin-face fontified t) 1250 1254 (fontified t) 1254 1257 (face font-lock-string-face fontified t) 1257 1259 (fontified t) 1259 1263 (face font-lock-builtin-face fontified t) 1263 1297 (fontified t) 1297 1309 (fontified t) 1309 1370 (fontified t) 1370 1374 (face font-lock-string-face fontified t) 1374 1432 (fontified t) 1432 1442 (face font-lock-string-face fontified t) 1442 1470 (fontified t) 1470 1499 (face font-lock-comment-face fontified t) 1499 1501 (fontified t) 1501 1527 (fontified t) 1527 1580 (fontified t) 1580 1616 (face font-lock-string-face fontified t) 1616 1738 (fontified t) 1738 1745 (face font-lock-builtin-face fontified t) 1745 1748 (fontified t) 1748 1753 (face font-lock-builtin-face fontified t) 1753 1754 (fontified t) 1754 1757 (face font-lock-string-face fontified t) 1757 1759 (fontified t) 1759 1765 (face font-lock-builtin-face fontified t) 1765 1769 (fontified t) 1769 1772 (face font-lock-string-face fontified t) 1772 1774 (fontified t) 1774 1778 (face font-lock-builtin-face fontified t) 1778 1782 (fontified t) 1782 1785 (face font-lock-string-face fontified t) 1785 1847 (fontified t) 1847 1852 (face font-lock-builtin-face fontified t) 1852 1856 (fontified t) 1856 1859 (face font-lock-string-face fontified t) 1859 1861 (fontified t) 1861 1865 (face font-lock-builtin-face fontified t) 1865 1869 (fontified t) 1869 1872 (face font-lock-string-face fontified t) 1872 1874 (fontified t) 1874 1878 (face font-lock-builtin-face fontified t) 1878 1981 (fontified t) 1981 1982 (fontified t rear-nonsticky t) 1982 1983 (fontified t)) . -5524) (undo-tree-id13 . -1552) (undo-tree-id14 . -1983) 7507) nil (26800 40390 193152 0) 0 nil])
([nil nil ((5524 . 5525)) nil (26800 40390 193149 0) 0 nil])
([nil nil ((66212 . 66219)) nil (26800 40390 193149 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 66908 . 66909) (nil fontified nil 66219 . 66909) (66219 . 66909)) nil (26800 40390 193148 0) 0 nil])
([nil nil ((#("
      (let* ((lock (bordeaux-threads:make-lock \"rt-lock\"))
             (cv   (bordeaux-threads:make-condition-variable))
             (resp nil)
             (done nil))
	(bordeaux-threads:make-thread
	 (lambda ()
	   (let ((r (funcall next req)))
             (bordeaux-threads:with-lock-held (lock)
               (setf resp r
		     done t)
               (bordeaux-threads:condition-notify cv)))))
	(bordeaux-threads:with-lock-held (lock)
	  (unless (bordeaux-threads:condition-wait cv lock :timeout (/ ms 1000.0))
            ;; timeout â†’ 504
            (return-from request-timeout
              (lumen.core.http:respond-json
               '((:error . ((:type . \"timeout\") (:message . \"gateway timeout\"))))
               :status 504))))
	resp))))
" 0 1 (fontified t) 1 8 (fontified t) 8 12 (face font-lock-keyword-face fontified t) 12 48 (fontified t) 48 57 (face font-lock-string-face fontified t) 57 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 216 (fontified t) 216 221 (fontified t) 221 224 (face font-lock-keyword-face fontified t) 224 264 (fontified t) 264 295 (face font-lock-keyword-face fontified t) 295 303 (fontified t) 303 346 (fontified t) 346 406 (fontified t) 406 437 (face font-lock-keyword-face fontified t) 437 449 (fontified t) 449 455 (face font-lock-keyword-face fontified t) 455 497 (fontified t) 497 505 (face font-lock-builtin-face fontified t) 505 533 (fontified t) 533 536 (face font-lock-comment-delimiter-face fontified t) 536 550 (face font-lock-comment-face fontified t) 550 563 (fontified t) 563 574 (face font-lock-keyword-face fontified t) 574 653 (fontified t) 653 659 (face font-lock-builtin-face fontified t) 659 664 (fontified t) 664 669 (face font-lock-builtin-face fontified t) 669 672 (fontified t) 672 681 (face font-lock-string-face fontified t) 681 684 (fontified t) 684 692 (face font-lock-builtin-face fontified t) 692 695 (fontified t) 695 712 (face font-lock-string-face fontified t) 712 732 (fontified t) 732 739 (face font-lock-builtin-face fontified t) 739 755 (fontified t) 755 758 (fontified t)) . -66909) (undo-tree-id12 . -758) 67667) nil (26800 40390 193147 0) 0 nil])
([nil nil ((66909 . 66910)) nil (26800 40390 193139 0) 0 nil])
([nil nil ((66910 . 66911)) nil (26800 40390 193138 0) 0 nil])
([nil nil ((66899 . 66900) (#("    " 0 4 (fontified nil)) . 66899) (66911 . 66912)) nil (26800 40390 193137 0) 0 nil])
([nil nil ((66903 . 66906) (66821 . 66824) (66775 . 66779) (66732 . 66736) (66703 . 66707) (66619 . 66622) (#("      " 0 6 (fontified t)) . 66619) (66578 . 66579) (#("    " 0 4 (fontified t)) . 66578) (66531 . 66535) (66502 . 66506) (66447 . 66451) (66404 . 66408) (#("       " 0 7 (fontified t)) . 66404) (66391 . 66393) (#("     " 0 5 (fontified t)) . 66391) (66360 . 66361) (#("    " 0 4 (fontified t)) . 66360) (66344 . 66348) (66281 . 66285) 66138) nil (26800 40390 193132 0) 0 nil])
([nil nil ((#("[" 0 1 (face font-lock-string-face fontified t)) . -5229) (undo-tree-id23 . -1) 5230 (t 26800 40390 0 0)) nil (26800 41888 704006 0) 0 nil])
([nil nil ((5229 . 5230)) nil (26800 41888 704005 0) 0 nil])
([nil nil ((#("[" 0 1 (face font-lock-string-face fontified t)) . -5239) (undo-tree-id22 . -1) 5240) nil (26800 41888 704004 0) 0 nil])
([nil nil ((5239 . 5240)) nil (26800 41888 704003 0) 0 nil])
([nil nil ((3941 . 3943)) nil (26800 41888 704002 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4388 . 4389) (nil fontified nil 3943 . 4389) (3943 . 4389)) nil (26800 41888 704001 0) 0 nil])
([nil nil ((4389 . 4391)) nil (26800 41888 704001 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6414 . 6415) (nil fontified nil 4391 . 6415) (4391 . 6415)) nil (26800 41888 704000 0) 0 nil])
([nil nil ((#("

(defun logger (&key (stream *terminal-io*) (color t))
  \"Logger concis: [ts] ip METHOD host path -> status (ms).\"
  (lambda (next)
    (lambda (req)
      (labels ((h (name)
                 (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
        (let* ((t0   (get-internal-real-time))
               (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                           (and xff (car (uiop:split-string xff :separator \",\"))))
                         (h \"x-real-ip\") \"\"))
               (host (or (h \"host\") \"\"))
               (meth (or (lumen.core.http:req-method req) \"GET\"))
               (path (or (lumen.core.http:req-path req) \"/\"))
               (resp (funcall next req))
               (ms   (/ (- (get-internal-real-time) t0)
                        (/ internal-time-units-per-second 1000.0)))
               (st   (lumen.core.http:resp-status resp))
               (ts   (local-time:format-timestring
                      nil (local-time:now)
                      :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                (:hour 2) \":\" (:min 2) \":\" (:sec 2)))))
          (if color
              ;; Placeholders: ts ip meth host path ESC color st ESC ms  â†’ 10 args
              (format stream \"[~A] ~A ~A ~A ~A -> ~C[0;~am~D~C[0m (~,0F ms)~%\"
                      ts ip meth host path
                      #\\Esc (%status-color st) st #\\Esc ms)
            (format stream \"[~A] ~A ~A ~A ~A -> ~D (~,0F ms)~%\"
                    ts ip meth host path st ms))
          (finish-output stream)
          resp)))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 15 (face font-lock-function-name-face fontified t) 15 17 (fontified t) 17 21 (face font-lock-type-face fontified t) 21 58 (fontified t) 58 115 (face font-lock-doc-face fontified t) 115 119 (fontified t) 119 125 (face font-lock-keyword-face fontified t) 125 138 (fontified t) 138 144 (face font-lock-keyword-face fontified t) 144 158 (fontified t) 158 164 (face font-lock-keyword-face fontified t) 164 244 (fontified t) 244 249 (face font-lock-builtin-face fontified t) 249 278 (fontified t) 278 282 (face font-lock-keyword-face fontified t) 282 342 (fontified t) 342 346 (face font-lock-keyword-face fontified t) 346 356 (fontified t) 356 373 (face font-lock-string-face fontified t) 373 441 (fontified t) 441 451 (face font-lock-builtin-face fontified t) 451 452 (fontified t) 452 455 (face font-lock-string-face fontified t) 455 488 (fontified t) 488 499 (face font-lock-string-face fontified t) 499 501 (fontified t) 501 503 (face font-lock-string-face fontified t) 503 534 (fontified t) 534 540 (face font-lock-string-face fontified t) 540 542 (fontified t) 542 544 (face font-lock-string-face fontified t) 544 605 (fontified t) 605 610 (face font-lock-string-face fontified t) 610 669 (fontified t) 669 672 (face font-lock-string-face fontified t) 672 1013 (fontified t) 1013 1020 (face font-lock-builtin-face fontified t) 1020 1023 (fontified t) 1023 1028 (face font-lock-builtin-face fontified t) 1028 1029 (fontified t) 1029 1032 (face font-lock-string-face fontified t) 1032 1034 (fontified t) 1034 1040 (face font-lock-builtin-face fontified t) 1040 1044 (fontified t) 1044 1047 (face font-lock-string-face fontified t) 1047 1049 (fontified t) 1049 1053 (face font-lock-builtin-face fontified t) 1053 1057 (fontified t) 1057 1060 (face font-lock-string-face fontified t) 1060 1094 (fontified t) 1094 1099 (face font-lock-builtin-face fontified t) 1099 1103 (fontified t) 1103 1106 (face font-lock-string-face fontified t) 1106 1108 (fontified t) 1108 1112 (face font-lock-builtin-face fontified t) 1112 1116 (fontified t) 1116 1119 (face font-lock-string-face fontified t) 1119 1121 (fontified t) 1121 1125 (face font-lock-builtin-face fontified t) 1125 1144 (fontified t) 1144 1146 (face font-lock-keyword-face fontified t) 1146 1167 (fontified t) 1167 1170 (face font-lock-comment-delimiter-face fontified t) 1170 1236 (face font-lock-comment-face fontified t) 1236 1265 (fontified t) 1265 1314 (face font-lock-string-face fontified t) 1314 1315 (fontified t) 1315 1445 (fontified t) 1445 1481 (face font-lock-string-face fontified t) 1481 1501 (fontified t) 1501 1502 (fontified t) 1502 1531 (fontified t) 1531 1564 (fontified t) 1564 1582 (fontified t) 1582 1583 (fontified t rear-nonsticky t)) . -6415) (undo-tree-id15 . -2) (undo-tree-id16 . -1583) (undo-tree-id17 . -1299) (undo-tree-id18 . -1299) (undo-tree-id19 . -1299) (undo-tree-id20 . -1583) (undo-tree-id21 . -1564) 7998) nil (26800 41888 703995 0) 0 nil])
([nil nil ((6415 . 6416) (t 26800 41888 0 0)) nil (26800 41896 747077 0) 0 nil])
([nil nil ((#("o" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -6415) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) 6416) nil (26800 41896 747073 0) 0 nil])
([nil nil ((16252 . 16254) (t 26800 41896 0 0)) nil (26804 50837 230013 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16723 . 16724) (nil fontified nil 16254 . 16724) (16254 . 16724)) nil (26804 50837 230012 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -16723) (undo-tree-id1 . -1) 16724) nil (26804 50837 230011 0) 0 nil])
([nil nil ((23485 . 23486)) nil (26804 50837 230009 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23511 . 23512) (nil fontified nil 23486 . 23512) (23486 . 23512)) nil (26804 50837 230009 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25683 . 25684) (nil fontified nil 25649 . 25684) (25649 . 25684)) nil (26804 50837 230008 0) 0 nil])
([nil nil ((#("((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn    (merge-pathnames try-index dir*))
                                   (bytes (read-file-bytes pn))
                                   (ut    (ignore-errors (file-write-date pn)))
                                   (hdrs  (list (cons \"content-type\" (guess-content-type pn))
                                                (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))))
                              (when ut
                                (setf hdrs (lumen.utils:ensure-header
                                            hdrs \"last-modified\"
                                            (lumen.utils:format-http-date ut))))
                              (make-instance 'lumen.core.http:response
                                             :status 200 :headers hdrs :body bytes)))" 0 92 (fontified t) 92 96 (face font-lock-keyword-face fontified t) 96 246 (fontified t) 246 259 (face font-lock-keyword-face fontified t) 259 283 (fontified t) 283 337 (fontified t) 337 351 (face font-lock-string-face fontified t) 351 431 (fontified t) 431 446 (face font-lock-string-face fontified t) 446 459 (fontified t) 459 479 (face font-lock-string-face fontified t) 479 531 (fontified t) 531 535 (face font-lock-keyword-face fontified t) 535 658 (fontified t) 658 673 (face font-lock-string-face fontified t) 673 687 (fontified t) 687 755 (fontified t) 755 862 (fontified t) 862 871 (fontified t) 871 878 (face font-lock-builtin-face fontified t) 878 883 (fontified t) 883 891 (face font-lock-builtin-face fontified t) 891 897 (fontified t) 897 902 (face font-lock-builtin-face fontified t) 902 911 (fontified t)) . -25712) (undo-tree-id0 . -911) 26623) nil (26804 50837 230007 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26753 . 26754) (nil fontified nil 25712 . 26754) (25712 . 26754)) nil (26804 50837 229993 0) 0 nil])
([nil nil ((26489 . 26498) (#(" " 0 1 (fontified nil)) . 26489) (26488 . 26489)) nil (26804 50837 230047 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 26533) (undo-tree-id11 . -1) (undo-tree-id12 . -1)) nil (26804 50866 359591 0) 0 nil] [nil nil ((#("(" 0 1 (fontified t)) . 26498)) ((26498 . 26499)) (26804 50837 229988 0) 0 nil])
([nil nil ((#("                          " 0 26 (fontified nil)) . -26571) (26533 . 26534)) nil (26804 50866 359589 0) 0 nil])
nil
([nil nil ((#("
" 0 1 (fontified t)) . 26586) (undo-tree-id9 . -1) (undo-tree-id10 . -1)) nil (26804 50866 359589 0) 0 nil])
([nil nil ((#("                          " 0 26 (fontified nil)) . -26624) (26586 . 26587)) nil (26804 50866 359587 0) 0 nil])
([nil nil ((26754 . 26755)) nil (26804 50866 359586 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26778 . 26779) (nil fontified nil 26755 . 26779) (26755 . 26779)) nil (26804 50866 359664 0) 0 nil])
([nil nil ((26882 . 26889) (#(" " 0 1 (fontified nil)) . 26882) (26881 . 26882)) nil (26804 51524 968765 0) 0 nil] [nil nil ((26887 . 26901) (#(" " 0 1 (fontified nil)) . 26886) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (26887 . 26888)) ((#("
" 0 1 (fontified nil)) . 26887) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (26886 . 26887) (#("							       " 0 14 (fontified t)) . 26887) (undo-tree-id15 . -14)) (26804 50866 359581 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 26929)) nil (26804 51524 968764 0) 0 nil])
nil
([nil nil ((#("                     " 0 21 (fontified nil)) . -26972) (26929 . 26930)) nil (26804 51524 968764 0) 0 nil])
([nil nil ((27249 . 27260) (#(" " 0 1 (fontified nil)) . 27248) (undo-tree-id47 . -1) (27249 . 27250)) nil (26804 51524 968763 0) 0 nil])
([nil nil ((27293 . 27305) (#(" " 0 1 (fontified nil)) . 27293) (27292 . 27293)) nil (26804 51524 968762 0) 0 nil])
([nil nil ((#("(ut   (ignore-errors (file-write-date dir*)))" 0 7 (fontified t) 7 20 (face font-lock-keyword-face fontified t) 20 45 (fontified t)) . -27038) (undo-tree-id46 . -45) 27083) nil (26804 51524 968761 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27064 . 27065) (nil fontified nil 27038 . 27065) (27038 . 27065)) nil (26804 51524 968760 0) 0 nil])
([nil nil ((#("ut" 0 2 (fontified t)) . -27343) (undo-tree-id45 . -2) 27345) nil (26804 51524 968759 0) 0 nil])
([nil nil ((27343 . 27345)) nil (26804 51524 968758 0) 0 nil])
([nil nil ((#("(lumen.utils:format-http-date ut)" 0 33 (fontified t)) . -27525) (undo-tree-id44 . -33) 27558) nil (26804 51524 968758 0) 0 nil])
([nil nil ((27525 . 27527)) nil (26804 51524 968755 0) 0 nil])
([nil nil ((#("
                                            " 0 1 (fontified t) 1 45 (fontified t)) . -27480) (undo-tree-id43 . -45) 27525) nil (26804 51524 968755 0) 0 nil])
([nil nil ((27480 . 27481)) nil (26804 51524 968753 0) 0 nil])
([nil nil ((28011 . 28023)) nil (26804 51524 968753 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28047 . 28048) (nil fontified nil 28023 . 28048) (28023 . 28048)) nil (26804 51524 968753 0) 0 nil])
([nil nil ((#("(t
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn    (merge-pathnames spa-fallback root*))
				       (lm   (%file-rfc1123 pn))
                                       (bytes (read-file-bytes pn))
                                       (ut    (ignore-errors (file-write-date pn)))
                                       (hdrs  (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                    (cons \"cache-control\" \"no-store\"))))
                                  (when ut
                                    (setf hdrs (lumen.utils:ensure-header
                                                hdrs \"last-modified\"
                                                (lumen.utils:format-http-date ut))))
                                  (make-instance 'lumen.core.http:response
                                                 :status 200 :headers hdrs :body bytes))
                                (lumen.core.http:respond-404 \"Directory index disabled\")))" 0 32 (fontified t) 32 34 (face font-lock-keyword-face fontified t) 34 163 (fontified t) 163 168 (fontified t) 168 201 (fontified t) 201 205 (face font-lock-keyword-face fontified t) 205 236 (fontified t) 236 242 (fontified t) 242 252 (fontified t) 252 263 (fontified t) 263 287 (fontified t) 287 288 (rear-nonsticky t fontified t) 288 289 (fontified t) 289 393 (fontified t) 393 404 (fontified t) 404 417 (face font-lock-keyword-face fontified t) 417 430 (fontified t) 430 441 (fontified t) 441 473 (fontified t) 473 499 (fontified t) 499 513 (face font-lock-string-face fontified t) 513 514 (fontified t) 514 540 (face font-lock-string-face fontified t) 540 542 (fontified t) 542 600 (fontified t) 600 615 (face font-lock-string-face fontified t) 615 616 (fontified t) 616 626 (face font-lock-string-face fontified t) 626 631 (fontified t) 631 666 (fontified t) 666 670 (face font-lock-keyword-face fontified t) 670 710 (fontified t) 710 748 (fontified t) 748 768 (fontified t) 768 801 (fontified t) 801 816 (face font-lock-string-face fontified t) 816 817 (fontified t) 817 876 (fontified t) 876 902 (fontified t) 902 933 (fontified t) 933 977 (fontified t) 977 1009 (fontified t) 1009 1011 (fontified t) 1011 1026 (fontified t) 1026 1033 (face font-lock-builtin-face fontified t) 1033 1038 (fontified t) 1038 1046 (face font-lock-builtin-face fontified t) 1046 1048 (fontified t) 1048 1052 (fontified t) 1052 1057 (face font-lock-builtin-face fontified t) 1057 1066 (fontified t) 1066 1127 (fontified t) 1127 1153 (face font-lock-string-face fontified t) 1153 1156 (fontified t)) . -27760) (undo-tree-id42 . -1156) 28916) nil (26804 51524 968752 0) 0 nil])
([nil nil ((27734 . 27740) (#("                           " 0 27 (fontified nil)) . 27733) (undo-tree-id40 . -27) (undo-tree-id41 . -27) (27760 . 27761)) nil (26804 51524 968750 0) 0 nil])
([nil nil ((27732 . 27739)) nil (26804 51524 968749 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28838 . 28839) (nil fontified nil 27739 . 28839) (27739 . 28839)) nil (26804 51524 968748 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -28837) (undo-tree-id38 . -1) (#(")" 0 1 (rear-nonsticky t fontified t)) . -28838) (undo-tree-id39 . -1) 28839) nil (26804 51524 968747 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -28847) (undo-tree-id37 . -1) 28848) nil (26804 51524 968745 0) 0 nil])
([nil nil ((28847 . 28848)) nil (26804 51524 968745 0) 0 nil])
([nil nil ((#("

			  " 0 1 (fontified t) 1 2 (fontified t) 2 7 (fontified t)) . -28837) (undo-tree-id36 . -7) 28844) nil (26804 51524 968744 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 28837)) nil (26804 51524 968743 0) 0 nil])
([nil nil ((#("((probe-file target)
                       (let* ((bytes (read-file-bytes target))
                              (ut    (ignore-errors (file-write-date target)))
                              (hdrs  (list (cons \"content-type\" (guess-content-type target))
                                           (cons \"cache-control\" (format nil \"public, max-age=~D\" file-cache-secs)))))
                         (when ut
                           (setf hdrs (lumen.utils:ensure-header
                                       hdrs \"last-modified\"
                                       (lumen.utils:format-http-date ut))))
                         (make-instance 'lumen.core.http:response
                                        :status 200 :headers hdrs :body bytes)))" 0 21 (fontified t) 21 29 (fontified t) 29 45 (fontified t) 45 49 (face font-lock-keyword-face fontified t) 49 84 (fontified t) 84 122 (fontified t) 122 135 (face font-lock-keyword-face fontified t) 135 212 (fontified t) 212 226 (face font-lock-string-face fontified t) 226 305 (fontified t) 305 320 (face font-lock-string-face fontified t) 320 333 (fontified t) 333 353 (face font-lock-string-face fontified t) 353 401 (fontified t) 401 405 (face font-lock-keyword-face fontified t) 405 518 (fontified t) 518 533 (face font-lock-string-face fontified t) 533 554 (fontified t) 554 610 (fontified t) 610 706 (fontified t) 706 716 (fontified t) 716 723 (face font-lock-builtin-face fontified t) 723 728 (fontified t) 728 736 (face font-lock-builtin-face fontified t) 736 742 (fontified t) 742 747 (face font-lock-builtin-face fontified t) 747 756 (fontified t)) . -28916) (undo-tree-id35 . -756) 29672) nil (26804 51524 968742 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 29792 . 29793) (nil fontified nil 28916 . 29793) (28916 . 29793)) nil (26804 51524 968739 0) 0 nil])
([nil nil ((29793 . 29802)) nil (26804 51524 968738 0) 0 nil])
([nil nil ((28840 . 28849)) nil (26804 51524 968738 0) 0 nil])
([nil nil ((#("(if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn    (merge-pathnames spa-fallback root*))
                                  (bytes (read-file-bytes pn))
                                  (ut    (ignore-errors (file-write-date pn)))
                                  (hdrs  (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                               (cons \"cache-control\" \"no-store\"))))
                             (when ut
                               (setf hdrs (lumen.utils:ensure-header
                                           hdrs \"last-modified\"
                                           (lumen.utils:format-http-date ut))))
                             (make-instance 'lumen.core.http:response
                                            :status 200 :headers hdrs :body bytes))
                           (funcall next req))" 0 1 (fontified t) 1 3 (face font-lock-keyword-face fontified t) 3 160 (fontified t) 160 164 (face font-lock-keyword-face fontified t) 164 316 (fontified t) 316 329 (face font-lock-keyword-face fontified t) 329 406 (fontified t) 406 420 (face font-lock-string-face fontified t) 420 421 (fontified t) 421 425 (face font-lock-string-face fontified t) 425 447 (face font-lock-string-face fontified t) 447 449 (fontified t) 449 502 (fontified t) 502 517 (face font-lock-string-face fontified t) 517 518 (fontified t) 518 524 (face font-lock-string-face fontified t) 524 528 (face font-lock-string-face fontified t) 528 533 (fontified t) 533 544 (fontified t) 544 555 (fontified t) 555 563 (fontified t) 563 567 (face font-lock-keyword-face fontified t) 567 571 (fontified t) 571 688 (fontified t) 688 703 (face font-lock-string-face fontified t) 703 714 (fontified t) 714 784 (fontified t) 784 898 (fontified t) 898 905 (face font-lock-builtin-face fontified t) 905 910 (fontified t) 910 918 (face font-lock-builtin-face fontified t) 918 924 (fontified t) 924 929 (face font-lock-builtin-face fontified t) 929 984 (fontified t)) . -29925) (undo-tree-id34 . -984) 30909) nil (26804 51524 968738 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 30821 . 30822) (nil fontified nil 29925 . 30822) (29925 . 30822)) nil (26804 51524 968737 0) 0 nil])
([nil nil ((31015 . 31016)) nil (26804 51524 968736 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -31015) (undo-tree-id33 . -1) 31016) nil (26804 51524 968735 0) 0 nil])
([nil nil ((38042 . 38043)) nil (26804 51524 968734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38228 . 38229) (nil fontified nil 38043 . 38229) (38043 . 38229)) nil (26804 51524 968734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38318 . 38319) (nil fontified nil 38312 . 38319) (38312 . 38319)) nil (26804 51524 968733 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 41621 . 41622) (nil fontified nil 38230 . 41622) (38230 . 41622)) nil (26804 51524 968733 0) 0 nil])
([nil nil ((41622 . 41623)) nil (26804 51524 968732 0) 0 nil])
([nil nil ((#("(defun etag (&key (weak t) (only-status '(200)) (add-cache-control nil))
  \"Ajoute/valide ETag et gÃ¨re 304 si If-None-Match matche.
   - WEAK : si T (dÃ©faut), gÃ©nÃ¨re un ETag faible (W/\\\"...\\\").
   - ONLY-STATUS : liste de statuts concernÃ©s (par dÃ©faut (200)).
   - ADD-CACHE-CONTROL : string optionnelle, ex: \\\"public, max-age=300\\\".\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels ((decorate (resp)
                   (let* ((etag (compute-etag (lumen.core.http:resp-body resp) :weak weak))
                          (hdrs (lumen.core.http:resp-headers resp)))
                     ;; ETag
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header hdrs \"etag\" etag))
                     ;; Cache-Control optionnel
                     (when add-cache-control
                       (setf (lumen.core.http:resp-headers resp)
                             (lumen.utils:ensure-header (lumen.core.http:resp-headers
							 resp)
                                                        \"cache-control\"
							add-cache-control)))
                     resp)))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((resp* (decorate resp))
                     (etag-val (cdr (assoc \"etag\" (lumen.core.http:resp-headers resp*)
                                           :test #'string=)))
                     (inm (cdr (assoc \"if-none-match\"
                                      (lumen.core.http:req-headers req)
                                      :test #'string-equal))))
                (if (and etag-val inm
                         (or (some (lambda (x) (string= x \"*\"))
                                   (%parse-if-none-match inm))
                             (some (lambda (x) (%weak-match-p x etag-val))
                                   (%parse-if-none-match inm))))
                    ;; 304 Not Modified : pas de corps
                    (make-instance 'lumen.core.http:response
                                   :status 304
                                   :headers (lumen.utils:ensure-header
                                             (copy-list (lumen.core.http:resp-headers resp*))
                                             \"etag\" etag-val)
                                   :body \"\")
                    resp*))
              ;; Pas concernÃ© â†’ renvoyer tel quel (mais on peut dÃ©corer si tu veux ETag partout)
              resp))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 11 (face font-lock-function-name-face fontified t) 11 13 (fontified t) 13 17 (face font-lock-type-face fontified t) 17 36 (fontified t) 36 72 (fontified t) 72 73 (fontified t) 73 75 (fontified t) 75 82 (face font-lock-doc-face fontified t) 82 88 (face font-lock-doc-face fontified t) 88 89 (face font-lock-doc-face fontified t rear-nonsticky t) 89 132 (face font-lock-doc-face fontified t) 132 334 (face font-lock-doc-face fontified t) 334 338 (fontified t) 338 344 (face font-lock-keyword-face fontified t) 344 357 (fontified t) 357 363 (face font-lock-keyword-face fontified t) 363 377 (fontified t) 377 381 (face font-lock-keyword-face fontified t) 381 476 (fontified t) 476 482 (face font-lock-keyword-face fontified t) 482 521 (fontified t) 521 525 (face font-lock-keyword-face fontified t) 525 580 (fontified t) 580 585 (face font-lock-builtin-face fontified t) 585 684 (fontified t) 684 687 (face font-lock-comment-delimiter-face fontified t) 687 692 (face font-lock-comment-face fontified t) 692 814 (fontified t) 814 820 (face font-lock-string-face fontified t) 820 849 (fontified t) 849 852 (face font-lock-comment-delimiter-face fontified t) 852 876 (face font-lock-comment-face fontified t) 876 898 (fontified t) 898 902 (face font-lock-keyword-face fontified t) 902 1142 (fontified t) 1142 1157 (face font-lock-string-face fontified t) 1157 1226 (fontified t) 1226 1228 (face font-lock-keyword-face fontified t) 1228 1324 (fontified t) 1324 1328 (face font-lock-keyword-face fontified t) 1328 1397 (fontified t) 1397 1403 (face font-lock-string-face fontified t) 1403 1484 (fontified t) 1484 1489 (face font-lock-builtin-face fontified t) 1489 1507 (fontified t) 1507 1518 (fontified t) 1518 1541 (fontified t) 1541 1543 (face font-lock-string-face fontified t) 1543 1556 (face font-lock-string-face fontified t) 1556 1557 (fontified t) 1557 1573 (fontified t) 1573 1629 (fontified t) 1629 1667 (fontified t) 1667 1672 (face font-lock-builtin-face fontified t) 1672 1709 (fontified t) 1709 1711 (face font-lock-keyword-face fontified t) 1711 1766 (fontified t) 1766 1772 (face font-lock-keyword-face fontified t) 1772 1788 (fontified t) 1788 1791 (face font-lock-string-face fontified t) 1791 1893 (fontified t) 1893 1899 (face font-lock-keyword-face fontified t) 1899 2017 (fontified t) 2017 2020 (face font-lock-comment-delimiter-face fontified t) 2020 2052 (face font-lock-comment-face fontified t) 2052 2148 (fontified t) 2148 2155 (face font-lock-builtin-face fontified t) 2155 2195 (fontified t) 2195 2203 (face font-lock-builtin-face fontified t) 2203 2370 (fontified t) 2370 2376 (face font-lock-string-face fontified t) 2376 2422 (fontified t) 2422 2427 (face font-lock-builtin-face fontified t) 2427 2428 (fontified t) 2428 2430 (face font-lock-string-face fontified t) 2430 2474 (fontified t) 2474 2477 (face font-lock-comment-delimiter-face fontified t) 2477 2557 (face font-lock-comment-face fontified t) 2557 2582 (fontified t)) . -41623) (undo-tree-id27 . -1215) (undo-tree-id28 . -2581) (undo-tree-id29 . -2581) (undo-tree-id30 . -2582) (undo-tree-id31 . -828) (undo-tree-id32 . -454) 44205) nil (26804 51524 968730 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -41621) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) 41622) nil (26804 51524 968724 0) 0 nil])
([nil nil ((733 . 736) (t 26804 51524 0 0)) nil (26804 51808 261100 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 779 . 780) (nil fontified nil 779 . 780) (nil fontified nil 772 . 779) (nil fontified nil 771 . 772) (nil fontified nil 750 . 771) (nil fontified nil 749 . 750) (nil fontified nil 737 . 749) (nil fontified nil 736 . 737) (736 . 780)) nil (26804 51808 261099 0) 0 nil])
([nil nil ((#(":lumen.core.ratelimit" 0 21 (face font-lock-builtin-face fontified t)) . -750) (undo-tree-id49 . -21) 771) nil (26804 51808 261098 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 771 . 772) (nil fontified nil 750 . 772) (750 . 772)) nil (26804 51808 261095 0) 0 nil])
([nil nil ((#(":allow?" 0 7 (face font-lock-builtin-face fontified t)) . -773) (undo-tree-id48 . -7) 780) nil (26804 51808 261093 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 785 . 786) (nil fontified nil 773 . 786) (773 . 786)) nil (26804 51808 261081 0) 0 nil])
([nil nil ((8888 . 8889) (t 26804 51808 0 0)) nil (26805 32724 210724 0) 0 nil])
([nil nil ((8889 . 8891)) nil (26805 32724 210723 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 8891) (undo-tree-id57 . -1)) nil (26805 32724 210723 0) 0 nil])
([nil nil ((8891 . 8892)) nil (26805 32724 210722 0) 0 nil])
([nil nil ((#("[" 0 1 (fontified t)) . -8890) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (#("
" 0 1 (fontified t)) . -8891) (undo-tree-id56 . -1) 8892) nil (26805 32724 210721 0) 0 nil])
([nil nil ((8890 . 8891)) nil (26805 32724 210719 0) 0 nil])
([nil nil ((8891 . 8892)) nil (26805 32724 210718 0) 0 nil])
([nil nil ((#("              " 0 14 (face font-lock-comment-face fontified nil)) . -11932) (11981 . 11982)) nil (26805 32724 210718 0) 0 nil])
([nil nil ((11968 . 11970)) nil (26805 32724 210717 0) 0 nil])
([nil nil ((11970 . 11972)) nil (26805 32724 210717 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18595 . 18596) (nil fontified nil 11972 . 18596) (11972 . 18596)) nil (26805 32724 210716 0) 0 nil])
([nil nil ((975 . 979)) nil (26805 32724 210715 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-builtin-face fontified t)) . -977) (undo-tree-id52 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -978) (undo-tree-id53 . -1) 979) nil (26805 32724 210715 0) 0 nil])
([nil nil ((977 . 985)) nil (26805 32724 210712 0) 0 nil])
([nil nil ((985 . 986)) nil (26805 32724 210712 0) 0 nil])
([nil nil ((#("e" 0 1 (face font-lock-builtin-face fontified t)) . -978) (undo-tree-id51 . -1) 979) nil (26805 32724 210711 0) 0 nil])
([nil nil ((978 . 979)) nil (26805 32724 210708 0) 0 nil])
([nil nil ((999 . 1003) (#(" " 0 1 (fontified nil)) . 998) (undo-tree-id50 . -1) (999 . 1000)) nil (26805 32724 210704 0) 0 nil])
([nil nil ((#("
(in-package :lumen.http) ; <-- adapte si ton mw vit ailleurs
" 0 1 (fontified t) 1 2 (fontified t) 2 12 (fontified t face font-lock-keyword-face) 12 13 (fontified t) 13 21 (fontified t face font-lock-builtin-face) 21 24 (face font-lock-builtin-face fontified t) 24 26 (fontified t) 26 62 (face font-lock-comment-face fontified t)) . 12233) (undo-tree-id95 . -62) (undo-tree-id96 . -21) (undo-tree-id97 . -1) (undo-tree-id98 . -21) (undo-tree-id99 . -21) (undo-tree-id100 . -21) (undo-tree-id101 . -21) (undo-tree-id102 . -21) (undo-tree-id103 . -22) (undo-tree-id104 . -22) (undo-tree-id105 . -22) (undo-tree-id106 . -22) (undo-tree-id107 . -23) (undo-tree-id108 . -23) (undo-tree-id109 . -23) (undo-tree-id110 . -23) (undo-tree-id111 . -23) (undo-tree-id112 . -23) (undo-tree-id113 . -23) (undo-tree-id114 . -23) (undo-tree-id115 . -62) (undo-tree-id116 . -62) (undo-tree-id117 . -62) (undo-tree-id118 . -62) (undo-tree-id119 . -62) (undo-tree-id120 . -62) (undo-tree-id121 . -62) (undo-tree-id122 . -62) (undo-tree-id123 . -62) (t 26805 32724 0 0)) nil (26805 32954 418806 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -12232) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) 12233) nil (26805 32954 418778 0) 0 nil])
([nil nil ((787 . 790) (t 26805 32954 0 0)) nil (26806 54397 206745 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 840 . 841) (nil fontified nil 840 . 841) (nil fontified nil 827 . 840) (nil fontified nil 826 . 827) (nil fontified nil 804 . 826) (nil fontified nil 803 . 804) (nil fontified nil 791 . 803) (nil fontified nil 790 . 791) (790 . 841)) nil (26806 54397 206744 0) 0 nil])
([nil nil ((#("http-range" 0 10 (face font-lock-builtin-face fontified t)) . -816) (undo-tree-id10 . -10) 826) nil (26806 54397 206742 0) 0 nil])
([nil nil ((816 . 821)) nil (26806 54397 206741 0) 0 nil])
([nil nil ((#(":respond-file" 0 13 (face font-lock-builtin-face fontified t)) . -822) (undo-tree-id9 . -13) 835) nil (26806 54397 206741 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 850 . 851) (nil fontified nil 836 . 851) (nil fontified nil 835 . 836) (nil fontified nil 834 . 835) (nil fontified nil 822 . 834) (822 . 851)) nil (26806 54397 206740 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.core.proxy :trust-proxy :parse-forwarded)" 0 1 (fontified t) 1 3 (fontified t) 3 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 47 (face font-lock-builtin-face fontified t) 47 48 (fontified t) 48 49 (face font-lock-builtin-face fontified t) 49 63 (face font-lock-builtin-face fontified t) 63 64 (face font-lock-builtin-face rear-nonsticky t fontified t) 64 65 (rear-nonsticky t fontified t)) . 787) (undo-tree-id7 . -65) (undo-tree-id8 . -64)) nil (26806 54397 206739 0) 0 nil])
([nil nil ((787 . 790)) nil (26806 54397 206738 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 840 . 841) (nil fontified nil 840 . 841) (nil fontified nil 827 . 840) (nil fontified nil 826 . 827) (nil fontified nil 804 . 826) (nil fontified nil 803 . 804) (nil fontified nil 791 . 803) (nil fontified nil 790 . 791) (790 . 841)) nil (26806 54397 206737 0) 0 nil])
([nil nil ((#("core." 0 5 (face font-lock-builtin-face fontified t)) . -811) (undo-tree-id6 . -5) 816) nil (26806 54397 206736 0) 0 nil])
([nil nil ((#("range" 0 5 (face font-lock-builtin-face fontified t)) . -816) (undo-tree-id5 . -5) 821) nil (26806 54397 206733 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -815) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 816) nil (26806 54397 206732 0) 0 nil])
([nil nil ((815 . 820)) nil (26806 54397 206730 0) 0 nil])
([nil nil ((#("x" 0 1 (face font-lock-builtin-face fontified t)) . -818) (undo-tree-id1 . -1) (#("y" 0 1 (face font-lock-builtin-face fontified t)) . -819) (undo-tree-id2 . -1) 820) nil (26806 54397 206730 0) 0 nil])
([nil nil ((818 . 821)) nil (26806 54397 206726 0) 0 nil])
([nil nil ((#(":respond-file" 0 13 (face font-lock-builtin-face fontified t)) . -822) (undo-tree-id0 . -13) 835) nil (26806 54397 206725 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 833 . 834) (nil fontified nil 822 . 834) (822 . 834)) nil (26806 54397 206709 0) 0 nil])
([nil nil ((1216 . 1217) (t 26806 54397 0 0)) nil (26806 54409 89847 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-comment-face fontified t)) . -1216) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) 1217) nil (26806 54409 89844 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.http.proxy :trust-proxy)" 0 1 (fontified t) 1 3 (fontified t) 3 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 46 (face font-lock-builtin-face fontified t) 46 47 (face font-lock-builtin-face rear-nonsticky t fontified t) 47 48 (rear-nonsticky t fontified t)) . 787) (undo-tree-id16 . -48) (undo-tree-id17 . -3) (undo-tree-id18 . -24) (undo-tree-id19 . -28) (undo-tree-id20 . -48) (undo-tree-id21 . -48) (undo-tree-id22 . -48) (undo-tree-id23 . -35) (undo-tree-id24 . -48) (t 26806 54409 0 0)) nil (26806 54865 472830 0) 0 nil])
([nil nil ((69081 . 69083) (t 26806 54865 0 0)) nil (26808 13508 722402 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 72979 . 72980) (nil fontified nil 69083 . 72980) (69083 . 72980)) nil (26808 13508 722401 0) 0 nil])
([nil nil ((66357 . 66358)) nil (26808 13508 722401 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . -66357) (undo-tree-id0 . -1) 66358) nil (26808 13508 722400 0) 0 nil])
([nil nil ((66357 . 66358)) nil (26808 13508 722386 0) 0 nil])
([nil nil ((66358 . 66360)) nil (26808 13508 722386 0) 0 nil])
([nil nil ((69085 . 69087)) nil (26808 13508 722385 0) 0 nil])
([nil nil ((69087 . 69088)) nil (26808 13508 722381 0) 0 nil])
([nil nil ((84948 . 84949) (t 26808 13508 0 0)) nil (26809 12807 825619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 85466 . 85467) (nil fontified nil 84949 . 85467) (84949 . 85467)) nil (26809 12807 825617 0) 0 nil])
([nil nil ((1409 . 1414)) nil (26809 12807 825616 0) 0 nil])
([nil nil ((1414 . 1415)) nil (26809 12807 825615 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1430 . 1431) (nil fontified nil 1415 . 1431) (1415 . 1431)) nil (26809 12807 825614 0) 0 nil])
([nil nil ((85489 . 85490)) nil (26809 12807 825607 0) 0 nil])
([nil nil ((385 . 388) (t 26809 12807 0 0)) nil (26809 12898 498003 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 436 . 437) (nil fontified nil 436 . 437) (nil fontified nil 419 . 436) (nil fontified nil 418 . 419) (nil fontified nil 402 . 418) (nil fontified nil 401 . 402) (nil fontified nil 389 . 401) (nil fontified nil 388 . 389) (388 . 437)) nil (26809 12898 498002 0) 0 nil])
([nil nil ((#(":lumen.core.body" 0 16 (face font-lock-builtin-face fontified t)) . -402) (undo-tree-id11 . -16) (undo-tree-id12 . -6) (undo-tree-id13 . -6) (undo-tree-id14 . -6) (undo-tree-id15 . -6) (undo-tree-id16 . -6) (undo-tree-id17 . -16) (undo-tree-id18 . -16) (undo-tree-id19 . -16) (undo-tree-id20 . -16) 418) nil (26809 12898 497999 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 422 . 423) (nil fontified nil 402 . 423) (402 . 423)) nil (26809 12898 497986 0) 0 nil])
([nil nil ((#(":parse-urlencoded" 0 17 (face font-lock-builtin-face fontified t)) . -424) (undo-tree-id1 . -17) (undo-tree-id2 . -6) (undo-tree-id3 . -6) (undo-tree-id4 . -6) (undo-tree-id5 . -6) (undo-tree-id6 . -6) (undo-tree-id7 . -17) (undo-tree-id8 . -17) (undo-tree-id9 . -17) (undo-tree-id10 . -17) 441) nil (26809 12898 497983 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 461 . 462) (nil fontified nil 445 . 462) (nil fontified nil 444 . 445) (nil fontified nil 443 . 444) (nil fontified nil 442 . 443) (nil fontified nil 436 . 442) (nil fontified nil 425 . 436) (nil fontified nil 424 . 425) (424 . 462)) nil (26809 12898 497952 0) 0 nil])
([nil nil ((462 . 463) (t 26809 12898 0 0)) nil (26809 13022 106944 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-builtin-face fontified t)) . -462) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) 463) nil (26809 13022 106939 0) 0 nil])
([nil nil ((1 . 84948) (#("(in-package :cl)

(defpackage :lumen.core.middleware
  (:use :cl :alexandria)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date)
  (:import-from :lumen.core.body :parse-urlencoded)
  (:import-from :lumen.data.repo.core :tenant-id-for-host :tenant-id-by-code)
  (:import-from :lumen.core.session :session-id :session-data :session-get :session-set! :session-del! :verify-signed-sid :sign-sid :store-get :store-put! :store-del! :rand-bytes :*session-ttl* :*session-cookie* :*secure-cookie*)
  (:import-from :lumen.core.jwt :*jwt-secret* :jwt-encode :jwt-decode)
  (:import-from :lumen.core.ratelimit :allow?)
  (:import-from :lumen.core.http-range :respond-file)
  (:export :define-middleware :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :*debug* :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :cors-auto :static-many
	   :form-parser :multipart-parser
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
   :csrf
	   :auth-jwt
   :https-redirect
	   :auth-required :roles-allowed :rate-limit
	   :request-timeout :max-body-size :access-log-json
	   :tenant-from-host))

(in-package :lumen.core.middleware)

(defparameter *debug* nil)  ;; active les prints si T

(defvar *app* (lambda (req)
                (declare (ignore req))
                (lumen.core.http:respond-404 \"No handler\"))
  \"La pile de middlewares active. Toujours mise Ã  jour via (set-app!).\")

(defvar *pipeline-signature* nil
  \"Liste symbolique des middlewares dans l'ordre actuel.\")

(defstruct mw-entry
  name   ;; string (affichage)
  fn)    ;; le factory: (next) -> (lambda (req) ...)

(defun %entry-name (x)
  (etypecase x
    (mw-entry (mw-entry-name x))
    (function \"<fn>\")))  ;; fallback lisible

(defun %entry-fn (x)
  (etypecase x
    (mw-entry (mw-entry-fn x))
    (function x)))

(defun named (name fn-factory)
  \"Wrappe un middleware factory avec un nom (string).\"
  (make-mw-entry :name (string name) :fn fn-factory))

(defmacro ->mw (name form)
  `(lumen.core.middleware:named ,name ,form))

(defun set-app! (&rest middlewares)
  \"Compose la pile. Chaque Ã©lÃ©ment peut Ãªtre:
   - un FUNCTION (factory classique),
   - ou (named \\\"Nom\\\" FUNCTION).\"
  (let* ((fns   (mapcar #'%entry-fn   middlewares))
         (names (mapcar #'%entry-name middlewares)))
    (setf *app* (apply #'my-compose fns)
          *pipeline-signature* names)))

(defun header-ref (headers name)
  (cdr (assoc (string-downcase name) headers :test #'string=)))

(defun my-compose (&rest middlewares)
  \"Construit (req -> resp) en enchaÃ®nant les middlewares dans lâ€™ordre donnÃ©.\"
  (let ((terminal (lambda (req)
                    (declare (ignore req))
                    (respond-404 \"No handler\"))))
    (dolist (mw (reverse middlewares) terminal)
      (setf terminal (funcall mw terminal)))))  ; <-- APPELLE le mw AVEC `next`

(defmacro define-middleware (name (req-sym next-sym) &body body)
  `(defun ,name (,next-sym)
     (lambda (,req-sym)
       ,@body)))

#|
(define-middleware logger (req next)
  (let* ((start (get-internal-real-time))
         (resp (funcall next req))
         (end  (get-internal-real-time))
         (ms   (floor (* 1000.0 (/ (- end start)
                                   internal-time-units-per-second)))))
    (when *debug*
      (format t \"~&[lumen] ~A ~A -> ~A (~A ms)~%\"
              (slot-value req 'lumen.core.http::method)
              (slot-value req 'lumen.core.http::path)
              (lumen.core.http:resp-status resp)
              ms))
    resp))
|#

(defun %status-color (status)
  (cond
    ((<= 200 status 299) \"32\")  ; vert
    ((<= 300 status 399) \"36\")  ; cyan
    ((<= 400 status 499) \"33\")  ; jaune
    (t                          \"31\"))) ; rouge

(defun %emacs-repl-p ()
  \"Vrai si on est dans un REPL Emacs (SLIME/SLY) ou INSIDE_EMACS.\"
  (or (member :swank *features*)
      (member :slynk *features*)
      (uiop:getenv \"INSIDE_EMACS\")))

(defun %supports-ansi-p (stream)
  (declare (ignore stream))
  (and (not (%emacs-repl-p))
       (not (member :win32 *features*))
       (let ((term (uiop:getenv \"TERM\")))
         (and term (not (string= term \"\")) (not (string-equal term \"dumb\"))))))

(defun logger (&key (stream *terminal-io*) (color :auto))
  \"Logger concis: [ts] ip METHOD host path -> status (ms).
COLOR âˆˆ (:auto T NIL) â€” par dÃ©faut :auto (dÃ©sactivÃ© sur consoles sans ANSI).\"
  (let ((color-enabled (if (eq color :auto) (%supports-ansi-p stream) (not (null color)))))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0   (get-internal-real-time))
                 ;; IP: XFF â†’ X-Real-IP â†’ ctx[:remote-addr] â†’ \"-\"
                 (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                             (and xff (string-trim \" \" (car (uiop:split-string xff :separator \",\")))))
                           (h \"x-real-ip\")
                           (lumen.core.http:ctx-get req :remote-addr)
                           \"-\"))
                 (host (or (h \"host\") \"\"))
                 (meth (or (lumen.core.http:req-method req) \"GET\"))
                 (path (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms   (/ (- (get-internal-real-time) t0)
                          (/ internal-time-units-per-second 1000.0)))
                 (msi  (round ms))
                 (st   (lumen.core.http:resp-status resp))
                 (ts   (local-time:format-timestring
                        nil (local-time:now)
                        :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                  (:hour 2) \":\" (:min 2) \":\" (:sec 2)))))
            (if color-enabled
                ;; Placeholders: ts ip meth host path ESC color st ESC msi
                (format stream \"[~A] ~A ~A ~A ~A -> ~C[0;~am~D~C[0m (~D ms)~%\"
                        ts ip meth host path
                        #\\Esc (%status-color st) st #\\Esc msi)
              (format stream \"[~A] ~A ~A ~A ~A -> ~D (~D ms)~%\"
                      ts ip meth host path st msi))
            (finish-output stream)
            resp))))))

;; --- Query parser -----------------------------------------------------------
(defun %url-decode (s)
  \"Decode minimal: %HH et '+' -> espace.\"
  (when s
    (with-output-to-string (out)
      (loop for i from 0 below (length s) do
            (let ((c (char s i)))
              (cond
                ((char= c #\\+) (write-char #\\Space out))
                ((and (char= c #\\%)
                      (<= (+ i 2) (1- (length s))))
                 (let* ((h1 (digit-char-p (char s (1+ i)) 16))
                        (h2 (digit-char-p (char s (+ i 2)) 16)))
                   (if (and h1 h2)
                       (progn
                         (write-char (code-char (+ (* h1 16) h2)) out)
                         (incf i 2))
                       (write-char c out))))
                (t (write-char c out))))))))

(defun parse-query-string-to-alist (qs)
  \"Transforme \\\"a=1&b=2&b=3\\\" -> ((\\\"a\\\" . \\\"1\\\") (\\\"b\\\" . \\\"2\\\") (\\\"b\\\" . \\\"3\\\")).\"
  (if (or (null qs) (zerop (length qs)))
      nil
      (loop for pair in (uiop:split-string qs :separator \"&\")
            for p = (position #\\= pair)
            for k = (%url-decode (subseq pair 0 (or p (length pair))))
            for v = (%url-decode (if p (subseq pair (1+ p)) \"\"))
            collect (cons k v))))

(define-middleware query-parser (req next)
  ;; Si req-query est une string, on la remplace par une alist.
  (let* ((q (lumen.core.http:req-query req)))
    (when (stringp q)
      (setf (lumen.core.http:req-query req) (parse-query-string-to-alist q)))
    (funcall next req)))

(defun path-matches? (path paths prefixes)
  (or (and paths (member path paths :test #'string=))
      (and prefixes (some (lambda (pfx)
                            (and (<= (length pfx) (length path))
                                 (string= pfx path :end2 (length pfx))))
                          prefixes))))

(defun json-only (&key paths prefixes)
  \"Middleware factory. Force Content-Type JSON pour les routes listÃ©es.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (path (lumen.core.http:req-path req)))
        (when (path-matches? path paths prefixes)
          (setf (lumen.core.http:resp-headers resp)
                (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                               \"content-type\"
                               \"application/json; charset=utf-8\")))
        resp))))

#|
(defun cors (&key (origins '(\"*\")) (methods '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\"))
                  (headers '(\"Content-Type\" \"Authorization\"))
                  (expose '()) (credentials nil) (max-age 600))
  \"CORS middleware. RÃ©pond aux prÃ©flights (OPTIONS) et enrichit toutes les rÃ©ponses.\"
  (lambda (next)
    (lambda (req)
      (let* ((req-h (lumen.core.http:req-headers req))
             (origin (cdr (assoc \"origin\" req-h :test #'string-equal)))
             (req-method (cdr (assoc \"access-control-request-method\" req-h :test #'string-equal)))
             (preflight (and (stringp req-method)
                             (string= (slot-value req 'lumen.core.http::method) \"OPTIONS\")))
             (allow-origin (cond
                             ((or (null origin) (member \"*\" origins :test #'string=)) \"*\")
                             ((member origin origins :test #'string=) origin)
                             (t nil))))
        (labels ((decorate (resp)
                   (when allow-origin
                     (setf (lumen.core.http:resp-headers resp)
                           (-> (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header \"access-control-allow-origin\" allow-origin)
                               (lumen.utils:ensure-header \"vary\" \"Origin\"))))
                   (when credentials
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                          \"access-control-allow-credentials\" \"true\")))
                   (when expose
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                          \"access-control-expose-headers\"
                                          (format nil \"~{~A~^, ~}\" expose))))
                   resp))
          (if preflight
              (let ((resp (make-instance 'lumen.core.http:response
                                         :status 204 :headers nil :body \"\")))
                (when allow-origin
                  (setf (lumen.core.http:resp-headers resp)
                        (-> (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header \"access-control-allow-origin\" allow-origin)
                            (lumen.utils:ensure-header \"access-control-allow-methods\" (format nil \"~{~A~^, ~}\" methods))
                            (lumen.utils:ensure-header \"access-control-allow-headers\" (format nil \"~{~A~^, ~}\" headers))
                            (lumen.utils:ensure-header \"access-control-max-age\" (princ-to-string max-age)))))
                (when credentials
                  (setf (lumen.core.http:resp-headers resp)
                        (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                       \"access-control-allow-credentials\" \"true\")))
                resp)
(decorate (funcall next req))))))))
|#

;;;; ----------------------------------------------------------------------------
;;;; CORS dual-mode (dev permissif / prod strict) + factory via lumen.core.config
;;;; ----------------------------------------------------------------------------
(defun cors (&key (mode :dev)                       ; :dev | :prod
                  (origins '(\"*\"))                  ; whitelist en :prod, ou '(\"*\") en :dev
                  (methods '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\"))
                  (headers '(\"Content-Type\" \"Authorization\"))
                  (expose '()) (credentials nil) (max-age 600))
  \"CORS middleware dual-mode (dev permissif / prod strict).
- MODE       : :dev (permissif) | :prod (strict whitelist)
- ORIGINS    : liste d'origines autorisÃ©es (prod) ou '(\\\"*\\\") (dev)
- CREDENTIALS: si T, on nâ€™Ã©met jamais \\\"*\\\" ; on renvoie lâ€™Origin effectif si autorisÃ©
- MAX-AGE    : secondes de cache prÃ©flight\"
  (lambda (next)
    (lambda (req)
      (let* ((req-h (lumen.core.http:req-headers req))
             (origin (cdr (assoc \"origin\" req-h :test #'string-equal)))
             (acr-method (cdr (assoc \"access-control-request-method\" req-h :test #'string-equal)))
             (acr-headers-req (cdr (assoc \"access-control-request-headers\" req-h :test #'string-equal)))
             (is-options (string= (slot-value req 'lumen.core.http::method) \"OPTIONS\"))
             (preflight (and is-options (stringp acr-method)))
             (allow-origin
               (cond
                 ((eq mode :dev)
                  ;; En dev: permissif ; si credentials, renvoyer origin (si prÃ©sent) plutÃ´t que \"*\"
                  (or (and credentials origin) \"*\"))
                 ((eq mode :prod)
                  (cond
                    ((and origin (member origin origins :test #'string=)) origin)
                    ((member \"*\" origins :test #'string=) \"*\") ; si on veut forcer permissif en prod (dÃ©conseillÃ©)
                    (t nil)))
                 (t nil))))
        (labels
            ((%ensure (resp name value)
               (setf (lumen.core.http:resp-headers resp)
                     (lumen.utils:ensure-header (lumen.core.http:resp-headers resp) name value)))
             (decorate (resp)
               ;; Toujours Vary: Origin (CDN-safe)
               (%ensure resp \"vary\" \"Origin\")
               ;; Allow-Origin (+ credentials si applicable)
               (when allow-origin
                 (let ((effective
                         (if (and credentials (string= allow-origin \"*\") (stringp origin))
                             origin
                             allow-origin)))
                   (%ensure resp \"access-control-allow-origin\" effective)
                   (when (and credentials (not (string= effective \"*\")))
                     (%ensure resp \"access-control-allow-credentials\" \"true\"))))
               ;; Expose-Headers
               (when expose
                 (%ensure resp \"access-control-expose-headers\" (format nil \"~{~A~^, ~}\" expose)))
               resp))
          (if preflight
              (let ((resp (make-instance 'lumen.core.http:response
                                         :status 204 :headers nil :body \"\")))
                ;; Vary complet pour prÃ©flight
                (dolist (h '(\"Origin\" \"Access-Control-Request-Method\" \"Access-Control-Request-Headers\"))
                  (%ensure resp \"vary\" h))
                (when allow-origin
                  (let* ((effective
                           (if (and credentials (string= allow-origin \"*\") (stringp origin))
                               origin
                               allow-origin))
                         (allow-headers
                           ;; Ã©cho des headers demandÃ©s par le client + base configurÃ©e
                           (let ((base (format nil \"~{~A~^, ~}\" headers)))
                             (if (and acr-headers-req (plusp (length acr-headers-req)))
                                 (format nil \"~A, ~A\" base acr-headers-req)
                                 base))))
                    (%ensure resp \"access-control-allow-origin\" effective)
                    (%ensure resp \"access-control-allow-methods\" (format nil \"~{~A~^, ~}\" methods))
                    (%ensure resp \"access-control-allow-headers\" allow-headers)
                    (%ensure resp \"access-control-max-age\" (princ-to-string max-age))
                    (when (and credentials (not (string= effective \"*\")))
                      (%ensure resp \"access-control-allow-credentials\" \"true\"))))
                resp)
              (decorate (funcall next req))))))))

;;; --------------------------------------------------------------------------
;;; Factory branchÃ©e sur lumen.core.config
;;; --------------------------------------------------------------------------

(eval-when (:compile-toplevel :load-toplevel :execute)
  (unless (find-package :lumen.core.config)
    (error \"Le package :lumen.core.config doit Ãªtre chargÃ© avant cors-auto.\")))

(defun %prod-profile-p (profile)
  \"Renvoie T si le profil indique un environnement de prod/staging.\"
  (member profile '(:prod :production :staging) :test #'eq))

(defun cors-auto ()
  \"Construit un mw CORS depuis lumen.core.config.
ClÃ©s supportÃ©es (profilÃ©es par ENV grÃ¢ce Ã  lumen.core.config):
  - :cors/origins        â†’ liste (CSV ou multiple) dâ€™origines autorisÃ©es
  - :cors/credentials    â†’ bool
  - :cors/max-age        â†’ durÃ©e (ex: \\\"600s\\\", \\\"10m\\\")
  - :cors/headers        â†’ liste dâ€™en-tÃªtes acceptÃ©s au prÃ©flight
  - :cors/methods        â†’ liste de mÃ©thodes autorisÃ©es
  - :cors/expose         â†’ liste dâ€™en-tÃªtes exposÃ©s cÃ´tÃ© client\"
  (let* ((profile (lumen.core.config:cfg-profile))
         (mode    (if (%prod-profile-p profile) :prod :dev))
         (origins (or (lumen.core.config:cfg-get-list :cors/origins) (if (eq mode :prod) '() '(\"*\"))))
         (creds   (or (lumen.core.config:cfg-get-bool :cors/credentials :default nil) nil))
         (max-age (or (lumen.core.config:cfg-get-duration :cors/max-age :default \"600s\") 600))
         (hdrs    (or (lumen.core.config:cfg-get-list :cors/headers) '(\"Content-Type\" \"Authorization\")))
         (meths   (or (lumen.core.config:cfg-get-list :cors/methods)
                      '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\")))
         (xpose   (or (lumen.core.config:cfg-get-list :cors/expose) '())))
    (cors :mode mode
          :origins origins
          :credentials creds
          :max-age max-age
          :headers hdrs
          :methods meths
          :expose xpose)))

(defun guess-content-type (pathname)
  (let* ((s (string-downcase (or (pathname-type pathname) \"\"))))
    (cond
      ((string= s \"html\") \"text/html; charset=utf-8\")
      ((string= s \"css\")  \"text/css; charset=utf-8\")
      ((string= s \"js\")   \"application/javascript; charset=utf-8\")
      ((member s '(\"png\" \"jpg\" \"jpeg\" \"gif\" \"webp\") :test #'string=) (format nil \"image/~A\" s))
      ((string= s \"svg\")  \"image/svg+xml\")
      ((string= s \"json\") \"application/json; charset=utf-8\")
      (t \"application/octet-stream\"))))

(defun read-file-bytes (pathname)
  (with-open-file (in pathname :element-type '(unsigned-byte 8))
    (let* ((size (file-length in))
           (buf  (make-array size :element-type '(unsigned-byte 8))))
      (read-sequence buf in)
      buf)))

(defun safe-join (root rel)
  \"ConcatÃ¨ne ROOT et REL en empÃªchant tout Ã©chappement (.., backslashes, drive, etc.).\"
  (print \"IN SAFE JOIN\")
  (let* ((rel* (or rel \"\"))
         ;; remplace backslashes et retire .. :
         (rel1 (substitute #\\/ #\\\\ rel*))
         (rel2 (with-output-to-string (s)
                 (dolist (part (remove-if #'(lambda (p) (or (string= p \"\")
                                                            (string= p \".\")))
                                          (uiop:split-string rel1 :separator \"/\")))
                   (unless (string= part \"..\")
                     (format s \"~A/\" part)))))
         ;; retire le slash final ajoutÃ© si rel ne devait pas en avoir
         (rel3 (if (and (> (length rel2) 0)
                        (char= (char rel2 (1- (length rel2))) #\\/)
                        (not (and (> (length rel1) 0)
                                  (char= (char rel1 (1- (length rel1))) #\\/))))
                  (subseq rel2 0 (1- (length rel2)))
                  rel2))
         (abs (merge-pathnames rel3 (uiop:ensure-directory-pathname (truename root)))))
    ;; sÃ©curitÃ© : lâ€™abs doit rester sous root
    (let* ((root* (namestring (uiop:ensure-directory-pathname (truename root))))
           (abs*  (namestring (truename abs))))
      (if (and (>= (length abs*) (length root*))
               (string= root* abs* :end2 (length root*)))
          abs
          (uiop:merge-pathnames* #P\"__forbidden__\" (truename root))))))

(defun directory-index-html (dir rel-url &key (hide-dotfiles t))
  \"GÃ©nÃ¨re un index HTML simple pour DIR.
REL-URL doit commencer par / et prÃ©ciser le chemin demandÃ© (avec / final pour les dossiers).\"
  (let* ((rel (or rel-url \"/\"))
         (rel* (if (char= (char rel (1- (length rel))) #\\/) rel (concatenate 'string rel \"/\")))
         (files (uiop:directory-files dir))
         (subs  (uiop:subdirectories dir)))
    (labels ((visible-p (pn)
               (let ((name (car (last (uiop:split-string (namestring pn) :separator \"/\")))))
                 (or (not hide-dotfiles)
                     (and name (not (and (> (length name) 0) (char= (char name 0) #\\.))))))))
      (with-output-to-string (s)
        (format s \"<!doctype html><meta charset='utf-8'><title>Index of ~A</title>\" rel*)
        (format s \"<style>body{font:14px system-ui,Segoe UI,Roboto,sans-serif;margin:24px}ul{list-style:none;padding-left:0}li{margin:2px 0}</style>\")
        (format s \"<h1>Index of ~A</h1><ul>\" rel*)
        (when (> (length rel*) 1)
          ;; lien vers le parent
          (let* ((trim (if (char= (char rel* (1- (length rel*))) #\\/)
                           (subseq rel* 0 (1- (length rel*)))
                           rel*))
                 (pidx (or (position #\\/ trim :from-end t) 0))
                 (up (if (= pidx 0) \"/\" (subseq trim 0 pidx))))
            (format s \"<li>â†©ï¸Ž <a href='~A'>..</a></li>\" up)))
        (dolist (sd (sort (remove-if-not #'visible-p subs) #'string< :key #'namestring))
          (let* ((nm (car (last (uiop:split-string (namestring sd) :separator \"/\")))))
            (format s \"<li>ðŸ“ <a href='~A/'>~A/</a></li>\" nm nm)))
        (dolist (f (sort (remove-if-not #'visible-p files) #'string< :key #'namestring))
          (let* ((nm (car (last (uiop:split-string (namestring f) :separator \"/\")))))
            (format s \"<li>ðŸ“„ <a href='~A'>~A</a></li>\" nm nm)))
        (format s \"</ul>\")))))

(defun method-get-or-head-p (req)
  (let ((m (slot-value req 'lumen.core.http::method)))
    (or (string= m \"GET\") (string= m \"HEAD\"))))

(defun %file-rfc1123 (pn)
  (let ((ut (ignore-errors (file-write-date pn))))
    (and ut (lumen.utils:format-http-date ut))))

(defun %weak-etag-from-file (pn)
  \"Weak ETag sans lecture du contenu: taille+mtime.\"
  (handler-case
      (let* ((size (with-open-file (in pn :direction :input :element-type '(unsigned-byte 8))
                     (file-length in)))
             (mt   (file-write-date pn)))
        (format nil \"W/\\\"~X-~X\\\"\" size mt))
    (error () nil)))

;;; ---------- Static middleware ------------------------------------------------
#|
(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
		 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR.

Options:
- AUTO-INDEX      : T â†’ gÃ©nÃ¨re un listing HTML si pas d'index.
- TRY-INDEX       : nom d'index Ã  servir (string) ou NIL pour dÃ©sactiver.
- REDIRECT-DIR    : T â†’ redirige /chemin â†’ /chemin/ (301) pour les dossiers.
- HIDE-DOTFILES   : T â†’ masque fichiers/dirs commenÃ§ant par '.' dans le listing.
- FILE-CACHE-SECS : Â« Cache-Control Â» pour fichiers (par dÃ©faut 3600).
- DIR-CACHE-SECS  : Â« Cache-Control Â» pour index/dir (par dÃ©faut 300).
- SPA-FALLBACK : string (ex. \\\"index.html\\\") servi quand *aucun fichier*
  ne correspond sous PREFIX, pour GET/HEAD uniquement (idÃ©al pour SPA).

NB: Le corps est envoyÃ© en octets (vecteur (unsigned-byte 8)).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (lumen.utils:str-prefix-p prefix* path)	      
              (let* ((rel    (subseq path plen)) ; peut Ãªtre \"\" ou \"foo/bar\"
                     (target (safe-join root* rel))
                     (dir-truename (ignore-errors (lumen.utils:probe-directory
						   target)))
		     (ut (file-write-date pathname)))
                (handler-case
                    (cond
                      ;; -------- Dossier ----------
                      (dir-truename
                       (let* ((has-slash (and (> (length path) 0)
                                              (char= (char path (1- (length path))) #\\/)))
                              (dir* (uiop:ensure-directory-pathname dir-truename)))
                         (cond
                           ;; /dir â†’ /dir/
                           ((and redirect-dir (not has-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                          (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                           :body \"\"))
                           ;; index.html si prÃ©sent
                           ((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn (merge-pathnames try-index dir*))
                                   (bytes (read-file-bytes pn)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" (guess-content-type pn))
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body bytes)))
                           ;; listing auto
                           (auto-index
                            (let* ((html (directory-index-html dir* (if (plusp (length path)) path \"/\")
                                                               :hide-dotfiles hide-dotfiles)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body html)))
                           (t
			    ;; pas d'index ni listing â†’ fallback SPA si demandÃ©, sinon 404
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn (merge-pathnames spa-fallback root*))
                                       (bytes (read-file-bytes pn)))
                                  (make-instance 'lumen.core.http:response
                                                 :status 200
                                                 :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                                (cons \"cache-control\" \"no-store\"))
                                                 :body bytes))
                                (lumen.core.http:respond-404 \"Directory index disabled\"))))))
                      ;; -------- Fichier ----------
                      ((probe-file target)
		       (let* ((bytes (read-file-bytes target)))
                         (make-instance 'lumen.core.http:response
                                        :status 200
                                        :headers (list (cons \"content-type\" (guess-content-type target))
						       (cons \"cache-control\" (format nil \"public, max-age=~D\" file-cache-secs)))
                                        :body bytes)))
                      ;; -------- Rien pour ce prefix â†’ passe au suivant ----------
                      (t
		       (if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn (merge-pathnames spa-fallback root*))
                                  (bytes (read-file-bytes pn)))
                             (make-instance 'lumen.core.http:response
                                            :status 200
                                            :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                           (cons \"cache-control\" \"no-store\"))
                                            :body bytes))
                           (funcall next req))))
                  (error ()
		    (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passe au suivant
(funcall next req)))))))
|#

(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
                 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR (optimisÃ© streaming/Range).

Options:
- AUTO-INDEX      : T â†’ gÃ©nÃ¨re un listing HTML si pas d'index.
- TRY-INDEX       : nom d'index Ã  servir (string) ou NIL pour dÃ©sactiver.
- REDIRECT-DIR    : T â†’ redirige /chemin â†’ /chemin/ (301) pour les dossiers.
- HIDE-DOTFILES   : T â†’ masque fichiers/dirs commenÃ§ant par '.' dans le listing.
- FILE-CACHE-SECS : Â« Cache-Control Â» pour fichiers (par dÃ©faut 3600).
- DIR-CACHE-SECS  : Â« Cache-Control Â» pour index/dir (par dÃ©faut 300).
- SPA-FALLBACK    : string (ex. \\\"index.html\\\") servi quand *aucun fichier*
  ne correspond sous PREFIX, pour GET/HEAD uniquement (idÃ©al pour SPA).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (and (>= (length path) plen)
                   (string= prefix* path :end2 plen)) ; Ã©vite dÃ©pendre dâ€™un util ici
              (let* ((rel    (subseq path plen))         ; \"\" ou \"foo/bar\"
                     (target (safe-join root* rel))
                     (dir-truename (ignore-errors (lumen.utils:probe-directory target))))
                (handler-case
                    (cond
                      ;; -------- Dossier ----------
                      (dir-truename
                       (let* ((has-slash (and (> (length path) 0)
                                              (char= (char path (1- (length path))) #\\/)))
                              (dir* (uiop:ensure-directory-pathname dir-truename)))
                         (cond
                           ;; /dir â†’ /dir/ (301)
                           ((and redirect-dir (not has-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                          (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                           :body \"\"))
                           ;; index.html si prÃ©sent â†’ respond-file (streaming + Range)
                           ((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn   (merge-pathnames try-index dir*))
                                   (ct   (guess-content-type pn))
                                   (lm   (%file-rfc1123 pn))
                                   (etag (%weak-etag-from-file pn))
                                   (resp (lumen.core.http-range:respond-file
                                          req pn
                                          :content-type ct
                                          :last-modified-rfc1123 lm
                                          :etag etag)))
                              (setf (lumen.core.http:resp-headers resp)
                                    (lumen.utils:ensure-header
				     (lumen.core.http:resp-headers resp)
                                     \"cache-control\"
                                     (format nil \"public, max-age=~D\" dir-cache-secs)))
                              resp))
                           ;; listing auto (gÃ©nÃ¨re HTML en mÃ©moire)
                           (auto-index
                            (let* ((html (directory-index-html
					  dir* (if (plusp (length path)) path \"/\")
                                          :hide-dotfiles hide-dotfiles))
                                   (lm   (%file-rfc1123 dir*))
                                   (hdrs (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                               (cons \"cache-control\"
						     (format nil \"public, max-age=~D\"
							     dir-cache-secs)))))
                              (when lm
                                (setf hdrs (lumen.utils:ensure-header
                                            hdrs \"last-modified\" lm)))
                              (make-instance 'lumen.core.http:response
                                             :status 200 :headers hdrs :body html)))
                           ;; pas d'index ni listing â†’ SPA fallback si demandÃ©, sinon 404
			   (t
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn   (merge-pathnames spa-fallback root*))
                                       (lm   (%file-rfc1123 pn))
                                       (resp (lumen.core.http-range:respond-file
                                              req pn
                                              :content-type \"text/html; charset=utf-8\"
                                              :last-modified-rfc1123 lm)))
                                  ;; SPA: pas de cache persistant
                                  (setf (lumen.core.http:resp-headers resp)
                                        (lumen.utils:ensure-header
                                         (lumen.core.http:resp-headers resp)
                                         \"cache-control\" \"no-store\"))
                                  resp)
                                (lumen.core.http:respond-404 \"Directory index disabled\"))))))
		      
                      ;; -------- Fichier ----------
                      ((probe-file target)
                       (let* ((ct   (guess-content-type target))
                              (lm   (%file-rfc1123 target))
                              (etag (%weak-etag-from-file target))
                              (resp (lumen.core.http-range:respond-file
                                     req target
                                     :content-type ct
                                     :last-modified-rfc1123 lm
                                     :etag etag)))
                         (setf (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                          \"cache-control\"
                                                          (format nil \"public, max-age=~D\" file-cache-secs)))
                         resp))
		      
                      ;; -------- Rien pour ce prefix ----------
                      (t
                       (if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn   (merge-pathnames spa-fallback root*))
                                  (lm   (%file-rfc1123 pn))
                                  (resp (lumen.core.http-range:respond-file
                                         req pn
                                         :content-type \"text/html; charset=utf-8\"
                                         :last-modified-rfc1123 lm)))
                             (setf (lumen.core.http:resp-headers resp)
                                   (lumen.utils:ensure-header
                                    (lumen.core.http:resp-headers resp)
                                    \"cache-control\" \"no-store\"))
                             resp)
                           (funcall next req))))
                  (error ()
                    (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passer au suivant
              (funcall next req)))))))
 
(defun static-many (&rest mounts)
  \"Monte plusieurs middlewares static en cascade.
MOUNTS: soit des PLISTs pour (static ...), soit des factories (next->handler).\"
  (let* ((factories
           (mapcar (lambda (m)
                     (etypecase m
                       (function m)                 ; dÃ©jÃ  une factory
                       (list     (apply #'static m)))) ; spec â†’ factory
                   mounts)))
    (lambda (next)
      (let ((acc next))
        (dolist (f (reverse factories) acc)
          (let ((wrapped (funcall f acc)))
            (unless (functionp wrapped)
              (error \"static-many: chaque element doit etre une FACTORY (next->handler). ~
                      Cet element a retourne ~S, pas une fonction. ~%~
                      Indice: ne passe pas un HANDLER (req->resp), mais une FACTORY.\"
                     wrapped))
            (setf acc wrapped)))))))

;;; ---------------- Cookies ----------------------------------------------------

(define-middleware cookies-parser (req next)
  \"Parse Cookie: â€¦ â†’ req-cookies (alist).\"
  (let* ((h (lumen.core.http:req-headers req))
         (raw (cdr (assoc \"cookie\" h :test #'string-equal))))
    (when raw
      (setf (lumen.core.http:req-cookies req)
            (lumen.core.http:parse-cookie-header raw))))
  (funcall next req))

(defun cookie (req name)
  \"Lit un cookie par nom (string), ou NIL.\"
  (cdr (assoc name (lumen.core.http:req-cookies req) :test #'string=)))

(defun set-cookie! (resp name value &rest opts)
  \"Ajoute un header Set-Cookie formatÃ© Ã  la rÃ©ponse.\"
  (lumen.core.http:add-set-cookie
   resp
   (apply #'lumen.core.http:format-set-cookie name value opts)))

;;; ---------------- Error wrapper ---------------------------------------------

(defparameter *error-handler*
  (lambda (e req)
    (declare (ignore req))
    ;; Rendu JSON par dÃ©faut ; en dev on imprime une backtrace
    (let* ((msg (princ-to-string e))
           (bt  (when *debug*
                  (with-output-to-string (s)
                    (ignore-errors (uiop:print-backtrace :stream s)))))
           (payload `((:error . ((:type . \"internal\")
                                  (:message . ,msg)
                                  ,@(when bt (list (cons :backtrace bt))))))))
      (lumen.core.http:respond-json payload :status 500))))

(define-middleware error-wrapper (req next)
  \"Capture toute condition et rend une 500 propre via *error-handler*.\"
  (handler-case
      (funcall next req)
    (error (e)
      (funcall *error-handler* e req))))

;;; ---------------- Request-ID -------------------------------------------------

(defun %rand-hex (nbytes)
  (let ((hex \"0123456789abcdef\"))
    (with-output-to-string (s)
      (dotimes (i (* 2 nbytes))
        (write-char (char hex (random 16)) s)))))

(defun make-request-id ()
  \"UUIDv4-ish (hex) simple, suffisant pour corrÃ©lation de logs.\"
  (let ((h (%rand-hex 16)))
    ;; 8-4-4-4-12 avec bits de version 4 (optionnel simplifiÃ©)
    (format nil \"~A-~A-4~A-~A~A-~A\"
            (subseq h 0 8) (subseq h 8 12) (subseq h 13 16)
            (subseq h 16 17) (subseq h 17 20) (subseq h 20 32))))

(define-middleware request-id (req next)
  \"Injecte un X-Request-ID dans la rÃ©ponse, disponible aussi via req-ctx.\"
  (let* ((rid (or (lumen.core.http:ctx-get req :request-id)
                  (make-request-id)))
         (resp (progn
                 (lumen.core.http:ctx-set! req :request-id rid)
                 (funcall next req))))
    (setf (lumen.core.http:resp-headers resp)
          (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                         \"x-request-id\" rid))
    resp))

;; Form parser
(define-middleware form-parser (req next)
  \"Parse application/x-www-form-urlencoded â†’ ctx[:form] (alist).\"
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((headers (lumen.core.http:req-headers req))
           (ct  (cdr (assoc \"content-type\" headers :test #'string-equal)))
           (len (cdr (assoc \"content-length\" headers :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0)
                 (search \"application/x-www-form-urlencoded\" (string-downcase ct)))
        (lumen.core.http:ctx-set! req :form
          (lumen.core.body:parse-urlencoded (lumen.core.http:req-body-stream req) len*))
        (lumen.core.http:ctx-set! req :body-consumed t))))
  (funcall next req))

(define-middleware multipart-parser (req next)
  \"Parse multipart/form-data â†’ ctx[:files], ctx[:fields].\"
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((h (lumen.core.http:req-headers req))
           (ct (cdr (assoc \"content-type\" h :test #'string-equal)))
           (len (cdr (assoc \"content-length\" h :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0)
                 (search \"multipart/form-data\" (string-downcase ct)))
        (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
          (when res
            (lumen.core.http:ctx-set! req :fields (cdr (assoc :fields res)))
            (lumen.core.http:ctx-set! req :files  (cdr (assoc :files  res)))
            (lumen.core.http:ctx-set! req :body-consumed t))))))
  (funcall next req))

;;; ---------------- ETag ----------------
;; FNV-1a 64-bit (simple, sans dÃ©pendance)
(defun %fnv1a-64 (bytes)
  (let* ((hash #xCBF29CE484222325)
         (prime #x100000001B3))
    (dotimes (i (length bytes))
      (setf hash (logxor hash (aref bytes i)))
      (setf hash (mod (* hash prime) (expt 2 64))))
    hash))

(defun %hex64 (u64)
  (format nil \"~16,'0X\" u64))

(defun %body->bytes (body)
  (etypecase body
    (string (trivial-utf-8:string-to-utf-8-bytes body))
    ((vector (unsigned-byte 8)) body)
    (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))

(defun compute-etag (body &key (weak t))
  \"Retourne une chaÃ®ne ETag, ex: W/\\\"AB12...-1234\\\"\"
  (let* ((bytes (%body->bytes body))
         (h (%hex64 (%fnv1a-64 bytes)))
         (sig (format nil \"~A-~D\" h (length bytes))))
    (if weak
        (format nil \"W/~S\" sig)   ; \"W/\" + quoted-string
        (format nil \"~S\" sig)))   ; strong: juste quoted-string

  )

(defun %parse-if-none-match (h)
  \"Retourne une liste de tags (strings) tels que reÃ§us, ex: (\\\"W/\\\\\\\"SIG\\\\\\\"\\\" \\\"\\\\\\\"SIG2\\\\\\\"\\\").\"
  (when (and h (plusp (length h)))
    (mapcar (lambda (s) (string-trim '(#\\Space #\\Tab) s))
            (uiop:split-string h :separator \",\"))))

(defun %strip-weak (tag)
  \"Retire le prÃ©fixe W/ si prÃ©sent.\"
  (let ((s (string-trim '(#\\Space #\\Tab) tag)))
    (if (and (>= (length s) 2)
             (char-equal (char s 0) #\\W)
             (char=      (char s 1) #\\/))
        (subseq s 2)
        s)))

(defun %weak-match-p (client-tag server-tag)
  \"RÃ¨gle de weak comparison (RFC 7232 Â§2.3.2).
   client-tag et server-tag incluent les guillemets.\"
  (string= (%strip-weak client-tag) (%strip-weak server-tag)))

;;; Middleware ETag rendu 'safe' :
;;; - Ne tente PAS de calculer un ETag si le corps est un writer (fonction).
;;; - Si un ETag est DÃ‰JÃ€ prÃ©sent (ex: respond-file), utilise-le pour 304.
(defun etag (&key (weak t) (only-status '(200)) (add-cache-control nil))
  \"Ajoute/valide ETag et gÃ¨re 304 si If-None-Match matche.
   - WEAK : si T (dÃ©faut), gÃ©nÃ¨re un ETag faible (W/\\\"...\\\").
   - ONLY-STATUS : liste de statuts concernÃ©s (par dÃ©faut (200)).
   - ADD-CACHE-CONTROL : string optionnelle, ex: \\\"public, max-age=300\\\".\"
  (lambda (next)
    (lambda (req)
      (let* ((resp   (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels
            ((ensure-etag! (resp)
               (let* ((hdrs (lumen.core.http:resp-headers resp))
                      (existing (cdr (assoc \"etag\" hdrs :test #'string=))))
                 (cond
                   ;; ETag dÃ©jÃ  posÃ© (ex: respond-file) â†’ on le laisse.
                   (existing
                    (when add-cache-control
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                       \"cache-control\" add-cache-control)))
                    existing)
                   ;; Corps fonction (writer) â†’ on ne peut pas calculer â†’ on n'ajoute pas
                   ((functionp (lumen.core.http:resp-body resp))
                    (when add-cache-control
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                       \"cache-control\" add-cache-control)))
                    nil)
                   ;; Corps string / octets â†’ on calcule
                   (t
                    (let* ((val (compute-etag (lumen.core.http:resp-body resp) :weak weak)))
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header hdrs \"etag\" val))
                      (when add-cache-control
                        (setf (lumen.core.http:resp-headers resp)
                              (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                         \"cache-control\" add-cache-control)))
                      val))))))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((etag-val (ensure-etag! resp))
                     (inm (cdr (assoc \"if-none-match\"
                                      (lumen.core.http:req-headers req)
                                      :test #'string-equal))))
                (if (and etag-val inm
                         (or (some (lambda (x) (string= x \"*\"))
                                   (%parse-if-none-match inm))
                             (some (lambda (x) (%weak-match-p x etag-val))
                                   (%parse-if-none-match inm))))
                    ;; 304 Not Modified : pas de corps
                    (make-instance 'lumen.core.http:response
                                   :status 304
                                   :headers (lumen.utils:ensure-header
                                             (copy-list (lumen.core.http:resp-headers resp))
                                             \"etag\" etag-val)
                                   :body \"\")
                    resp))
              ;; Pas concernÃ© â†’ renvoyer tel quel
              resp))))))

;;; ---------------- Helpers Accept-Encoding ----------------
(defun %parse-accept-encoding (h)
  \"Retourne une alist '( (\\\"gzip\\\" . q) (\\\"deflate\\\" . q) ... ) triÃ©e par q desc.\"
  (labels ((parse-q (s)
             (handler-case
                 (let* ((v (read-from-string s nil nil)))
                   (if (numberp v) (coerce v 'float) 1.0))
               (error () 1.0))))
    (when (and h (plusp (length h)))
      (let* ((tokens (uiop:split-string h :separator \",\"))
             (pairs
               (mapcar (lambda (tok)
                         (let* ((t1 (string-trim '(#\\Space #\\Tab) tok))
                                (pos (position #\\; t1))
                                (enc (string-downcase
                                      (string-trim '(#\\Space #\\Tab)
                                                   (subseq t1 0 (or pos (length t1))))))
                                (q   (if pos
                                         (let* ((p2 (position #\\= t1 :start (1+ pos))))
                                           (if p2
                                               (parse-q (string-trim '(#\\Space #\\Tab)
                                                                     (subseq t1 (1+ p2))))
                                               1.0))
                                         1.0)))
                           (cons enc q)))
                       tokens)))
	;; filtre q=0, trie desc
        (sort (remove-if (lambda (c) (<= (cdr c) 0.0)) pairs)
              #'> :key #'cdr)))))

(defun %client-wants-gzip-p (headers)
  (let ((ae (cdr (assoc \"accept-encoding\" headers :test #'string-equal))))
    (member \"gzip\" (mapcar #'car (%parse-accept-encoding ae))
            :test #'string=)))

(defun %choose-encoding (headers &key (supported '(\"gzip\" \"deflate\")))
  \"Renvoie \\\"gzip\\\" ou \\\"deflate\\\" selon Accept-Encoding et q-values, ou NIL si rien.\"
  (let* ((ae (cdr (assoc \"accept-encoding\" headers :test #'string-equal)))
         (prefs (%parse-accept-encoding ae)))
    (some (lambda (p)
            (let ((enc (car p)))
              (when (member enc supported :test #'string=)
                enc)))
          prefs)))

(defun %content-type (headers)
  (cdr (assoc \"content-type\" headers :test #'string=)))

(defun %type-prefixed-p (ct prefixes)
  \"Vrai si le Content-Type CT commence par un des PREFIXES (strings).\"
  (and ct prefixes
       (let ((ct* (string-downcase ct)))
         (some (lambda (pfx) (lumen.utils:str-prefix-p (string-downcase pfx) ct*))
               prefixes))))

;;; ---------------- Compressors ----------------
(defun %bytes (body)
  (etypecase body
    (string (trivial-utf-8:string-to-utf-8-bytes body))
    ((vector (unsigned-byte 8)) body)
    (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))

(defun gzip-bytes (u8vec)
  \"Retourne un nouveau vecteur d'octets gzip du contenu U8VEC.\"
  (let ((out (flexi-streams:make-in-memory-output-stream
              :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:gzip-compressor :stream out)
      (dotimes (i (length u8vec))
        (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

(defun deflate-bytes (u8vec)
  \"Retourne un nouveau vecteur d'octets *deflate* (zlib wrapper, RFC1950) du contenu U8VEC.\"
  (let ((out (flexi-streams:make-in-memory-output-stream
              :element-type '(unsigned-byte 8))))
    ;; NB: 'deflate' cÃ´tÃ© HTTP signifie gÃ©nÃ©ralement zlib-wrapped (pas raw)
    (salza2:with-compressor (c 'salza2:zlib-compressor :stream out)
      (dotimes (i (length u8vec))
        (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

;;; ---------------- Middleware ----------------
;; ---------- DÃ©tection contenus dÃ©jÃ  compressÃ©s / peu compressibles ----------
(defun %starts-with (vec &rest bytes)
  (when (and (vectorp vec)
             (subtypep (array-element-type vec) '(unsigned-byte 8))
             (<= (length bytes) (length vec)))
    (loop for i from 0 below (length bytes)
          always (= (aref vec i) (nth i bytes)))))

(defun %looks-gzip-p   (bytes) (%starts-with bytes #x1F #x8B))                ; GZIP
(defun %looks-zlib-p   (bytes) (or (%starts-with bytes #x78 #x01)             ; ZLIB/deflate
                                   (%starts-with bytes #x78 #x9C)
                                   (%starts-with bytes #x78 #xDA)))
(defun %looks-png-p    (bytes) (%starts-with bytes #x89 #x50 #x4E #x47 #x0D #x0A #x1A #x0A))
(defun %looks-jpeg-p   (bytes) (%starts-with bytes #xFF #xD8 #xFF))
(defun %looks-gif-p    (bytes)
  (and (>= (length bytes) 6)
       (let ((s (map 'string #'code-char (subseq bytes 0 6))))
         (or (string= s \"GIF87a\") (string= s \"GIF89a\")))))
(defun %looks-webp-p   (bytes)
  (and (>= (length bytes) 12)
       (string= (map 'string #'code-char (subseq bytes 0 4))  \"RIFF\")
       (string= (map 'string #'code-char (subseq bytes 8 12)) \"WEBP\")))
(defun %looks-zip-p    (bytes) (%starts-with bytes #x50 #x4B #x03 #x04))
(defun %looks-pdf-p    (bytes)
  (and (>= (length bytes) 4)
       (string= (map 'string #'code-char (subseq bytes 0 4)) \"%PDF\")))

(defun %incompressible-magic-p (bytes)
  \"Renvoie T si BYTES semble dÃ©jÃ  compressÃ© (gzip/zlib) ou de type peu compressible (images, zip, pdf).\"
  (or (%looks-gzip-p bytes)
      (%looks-zlib-p bytes)
      (%looks-png-p  bytes)
      (%looks-jpeg-p bytes)
      (%looks-gif-p  bytes)
      (%looks-webp-p bytes)
      (%looks-zip-p  bytes)
      (%looks-pdf-p  bytes)))

(defun compression
    (&key (threshold 1024)
       (add-vary t)
       (skip-types '(\"image/\" \"video/\" \"audio/\"
                     \"application/zip\" \"application/pdf\"
                     \"application/x-gzip\" \"application/x-7z-compressed\"
                     \"application/x-rar-compressed\" \"application/x-tar\"))
       (only-types nil)
       (min-ratio 0.95)
       (skip-if nil))		     ; (lambda (req resp) ...) -> bool
  \"Compresse la rÃ©ponse (gzip/deflate) si pertinent.
Options:
  - THRESHOLD  : octets minimum du corps original
  - ADD-VARY   : ajoute Vary: Accept-Encoding
  - SKIP-TYPES : liste de prÃ©fixes MIME Ã  ignorer
  - ONLY-TYPES : liste de prÃ©fixes MIME autorisÃ©s (si non-NIL, restreint la compression)
  - MIN-RATIO  : ne garde pas la compression si (compressed/original) > MIN-RATIO
  - SKIP-IF    : prÃ©dicat (req resp) â†’ T pour dÃ©sactiver la compression\"
  (labels
      ((decorate-vary (hdrs)
         (if add-vary
             (let* ((existing (cdr (assoc \"vary\" hdrs :test #'string=)))
                    (new (if existing
                             (if (search \"accept-encoding\" (string-downcase existing))
                                 existing
                                 (format nil \"~A, Accept-Encoding\" existing))
                             \"Accept-Encoding\")))
               (lumen.utils:ensure-header hdrs \"vary\" new))
             hdrs)))
    (lambda (next)
      (lambda (req)
        (let* ((resp    (funcall next req))
               (status  (lumen.core.http:resp-status resp))
               (req-h   (lumen.core.http:req-headers req))
               (resp-h  (lumen.core.http:resp-headers resp))
               (ct      (%content-type resp-h)))

          (cond
            ;; Jamais compresser ces statuts / si dÃ©jÃ  encodÃ©
            ((or (member status '(204 304))
                 (assoc \"content-encoding\" resp-h :test #'string=))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter un Ã©ventuel prÃ©dicat dâ€™exclusion
            ((and skip-if (funcall skip-if req resp))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter ONLY-TYPES (si fourni)
            ((and only-types (not (%type-prefixed-p ct only-types)))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Ne pas compresser si CT est dans SKIP-TYPES
            ((%type-prefixed-p ct skip-types)
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; NÃ©gociation de contenu
            (t
             (let ((chosen (%choose-encoding req-h :supported '(\"gzip\" \"deflate\"))))
               (if (null chosen)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
                   (let* ((orig (lumen.core.http:resp-body resp))
                          (bytes (etypecase orig
                                   (string (trivial-utf-8:string-to-utf-8-bytes orig))
                                   ((vector (unsigned-byte 8)) orig)
                                   (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))
                          (len (length bytes)))

                     (cond
                       ((< len threshold)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       ((%incompressible-magic-p bytes)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       (t
                        (let* ((encoded (ecase (intern (string-upcase chosen) :keyword)
                                          (:GZIP    (gzip-bytes bytes))
                                          (:DEFLATE (deflate-bytes bytes))))
                               (ratio (if (plusp len)
                                          (/ (float (length encoded)) (float len))
                                          1.0)))
                          (if (> ratio min-ratio)
                              ;; Gain insuffisant
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (decorate-vary (lumen.core.http:resp-headers resp)))
                                resp)
                              ;; Conserver compression
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (-> (lumen.core.http:resp-headers resp)
                                          (lumen.utils:ensure-header \"content-encoding\" chosen)
                                          (decorate-vary)))
                                (setf (lumen.core.http:resp-body resp) encoded)
                                resp)))))))))))))))

;;; If-Modified-Since â†’ 304 ----------------------------------------
(defun last-modified-conditional (&key (only-status '(200)))
  \"Si la rÃ©ponse porte Last-Modified, compare If-Modified-Since et renvoie 304 si applicable.
   Respecte la rÃ¨gle de prioritÃ© : si If-None-Match est prÃ©sent, on laisse l'autre middleware (ETag) dÃ©cider.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp   (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels ((->304 (resp lm)
                   (make-instance 'lumen.core.http:response
                                  :status 304
                                  :headers (lumen.utils:ensure-header
                                            (copy-list (lumen.core.http:resp-headers resp))
                                            \"last-modified\" lm)
                                  :body \"\")))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((req-h  (lumen.core.http:req-headers req))
                     (resp-h (lumen.core.http:resp-headers resp))
                     (ims    (cdr (assoc \"if-modified-since\" req-h :test #'string-equal)))
                     (inm    (cdr (assoc \"if-none-match\" req-h :test #'string-equal))) ; prioritÃ© ETag
                     (lm     (cdr (assoc \"last-modified\" resp-h :test #'string=))))
                (if (and lm ims (null inm))
                    (let* ((ims-ut (lumen.utils:parse-http-date ims))
                           (lm-ut  (lumen.utils:parse-http-date lm)))
                      (if (and ims-ut lm-ut (>= ims-ut lm-ut))
                          (->304 resp lm)
                          resp))
                    resp))
              resp))))))

;;; Session
(defun session (&key secret (ttl lumen.core.session:*session-ttl*)
                     (cookie-name lumen.core.session:*session-cookie*)
                     (http-only t) (secure lumen.core.session:*secure-cookie*)
                     (path \"/\"))
  \"Sessions mÃ©moire via cookie signÃ©. SECRET requis.\"
  (assert (and secret (plusp (length secret))) () \"session: :secret requis.\")
  (lambda (next)
    (lambda (req)
      ;; lecture cookie
      (let* ((raw (or (cookie req cookie-name) \"\"))
             (sid (and (> (length raw) 0)
                       (lumen.core.session:verify-signed-sid raw secret)))
             (data (and sid (lumen.core.session:store-get sid))))
        ;; si pas de session â†’ crÃ©er
        (unless sid
          (setf sid (lumen.core.session:make-session-id))
          (setf data '()))
        ;; mettre en ctx
        (lumen.core.http:ctx-set! req :session-id sid)
        (lumen.core.http:ctx-set! req :session    data)
        ;; suite
        (let* ((resp (funcall next req))
               (sid* (lumen.core.session:session-id req))
               (dat* (lumen.core.session:session-data req)))
          ;; persister si non-vide (ou toujours, Ã  toi de voir)
          (lumen.core.session:store-put! sid* dat* ttl)
          ;; cookie signÃ©
          (let* ((signed (lumen.core.session:sign-sid sid* secret)))
            (set-cookie! resp cookie-name signed
                         :path path :http-only http-only :secure secure
                         :max-age ttl))
          resp)))))

;;; CSRF
#|
- On gÃ©nÃ¨re un token alÃ©atoire, stockÃ© en session (:csrf) et envoyÃ© aussi au client (cookie csrf_token).
- Pour les mÃ©thodes mutables (POST, PUT, PATCH, DELETE), on vÃ©rifie que la requÃªte fournit le mÃªme token via header X-CSRF-Token ou champ de formulaire (ctx :form â†’ key \"csrf_token\").
- Si absent/incorrect â†’ 403.
|#
(defun %random-token ()
  (let* ((b (lumen.core.session:rand-bytes 32)))
    (cl-base64:usb8-array-to-base64-string b :uri t))) ; base64url

(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\")
                  (except-prefixes '())   ; ex: '(\"/login\" \"/api/webhook\")
                  (except-exact '())      ; ex: '(\"/login\" \"/signup\")
                  (skip-if nil))          ; (lambda (req) -> boolean)
  (labels ((path-exempt-p (req)
             (let ((p (lumen.core.http:req-path req)))
               (or
                ;; skip par prÃ©dicat custom
                (and skip-if (funcall skip-if req))
                ;; skip par match exact
                (member p except-exact :test #'string=)
                ;; skip par prÃ©fixe
                (some (lambda (pre)
                        (and (<= (length pre) (length p))
                             (string= pre p :end2 (length pre))))
                      except-prefixes)))))
    (lambda (next)
      (lambda (req)
        ;; (1) session requise (middleware :session doit Ãªtre avant)
        (let* ((method (lumen.core.http:req-method req))
               (mut?   (member method methods :test #'string=))
               ;; token en session (crÃ©Ã© si absent)
               (tok (or (lumen.core.session:session-get req :csrf)
                        (let ((tkn (%random-token)))
                          (lumen.core.session:session-set! req :csrf tkn) tkn))))
          (labels ((emit-cookie (resp)
                     (set-cookie! resp cookie-name tok :path path :http-only nil)))
            (cond
              ;; Cas exemptÃ© â†’ pas de vÃ©rif, mais on Ã©met/rafraÃ®chit le cookie
              ((or (not mut?) (path-exempt-p req))
               (let ((resp (funcall next req)))
                 (emit-cookie resp)
                 resp))

              ;; MÃ©thode mutable + pas exemptÃ© â†’ vÃ©rification stricte
              (t
               (let* ((hdr (lumen.core.http:req-headers req))
                      (hdr-raw (cdr (assoc header-name hdr :test #'string-equal)))
                      ;; tolÃ©rance: si on reÃ§oit littÃ©ralement \"csrf_token\", lire la valeur dans les cookies
                      (hdr-tok (if (and hdr-raw (string= hdr-raw cookie-name))
                                   (cdr (assoc cookie-name (lumen.core.http:req-cookies req) :test #'string=))
                                   hdr-raw))
                      (form (lumen.core.http:ctx-get req :form))
                      (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                      (ok (or (and hdr-tok (string= hdr-tok tok))
                              (and field-tok (string= field-tok tok)))))
                 (if ok
                     (let ((resp (funcall next req)))
                       (emit-cookie resp)
                       resp)
                     (let ((resp (lumen.core.http:respond-json
                                  '((:error . ((:type . \"csrf\")
                                               (:message . \"invalid or missing CSRF token\"))))
                                  :status 403)))
                       (emit-cookie resp) ; pour que le client rÃ©cupÃ¨re le bon token
                       resp)))))))))))

;;; JWT (HS256)
#|
Les scopes sont des permissions fines, embarquÃ©es dans le JWT.
Un rÃ´le, câ€™est â€œqui je suisâ€ (ex. admin, user).
Un scope, câ€™est â€œce que je peux faireâ€ (ex. read:users, write:payments).
|#
#|
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)   ; ex: '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any))  ; :any (OR) ou :all (AND)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx, applique garde optionnelle.
Options:
 - SECRET         : clÃ© HMAC (defaut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (let* ((hdrs (lumen.core.http:req-headers req))
               (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
               (tok  (and raw (>= (length raw) 7)
                          (string= (subseq raw 0 7) \"Bearer \")
                          (subseq raw 7))))
	  (format t \"Raw: ~A~%\" raw)
	  (format t \"Token: ~A~%\" tok)
          ;; dÃ©codage
          (when tok
            (multiple-value-bind (payload ok)
                (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
	      (format t \"Payload: ~A~%OK: ~A~%\" payload ok)
              (when ok (lumen.core.http:ctx-set! req :jwt payload))))
          ;; vÃ©rifs
          (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                 (role (and jwt (or (cdr (assoc :role jwt))
                                    (cdr (assoc \"role\" jwt)))))
                 (sc   (and jwt (or (cdr (assoc :scopes jwt))
                                    (cdr (assoc \"scopes\" jwt))))))
            (labels ((fail (status msg)
                       (lumen.core.http:respond-json
                        `((:error . ((:type . \"auth\") (:message . ,msg))))
                        :status status))
                     (has-scope? ()
                       (cond
                         ((null scopes-allow) t) ; pas dâ€™exigence
                         ((eq scopes-mode :all)
                          (every (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow))
                         (t ; :any
                          (some  (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow)))))
              (cond
                ((and required-p (null jwt)) (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
		 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scope?))) (fail 403 \"insufficient_scope\"))
                (t (funcall next req))))))))))
|#

(defun %bearer-token-from (headers)
  \"Extrait proprement le Bearer token (case-insensitive, espaces tolÃ©rÃ©s).\"
  (let* ((raw (cdr (assoc \"authorization\" headers :test #'string-equal))))
    (when raw
      (let* ((s (string-trim \" \" raw))
             (len (length s)))
        (labels ((starts-with-ci (needle hay)
                   (and (>= (length hay) (length needle))
                        (string-equal needle hay :end2 (length needle)))))
          (cond
            ((starts-with-ci \"Bearer \" s) (subseq s 7))
            ((starts-with-ci \"bearer \" s) (subseq s 7))
            (t nil)))))))

(defun %alist-get-ci (alist key)
  \"Assoc insensitive string|keyword sur alist mixte.\"
  (let ((sk (etypecase key
              (keyword (string-downcase (symbol-name key)))
              (string  (string-downcase key)))))
    (or (cdr (assoc key alist :test #'equal))
        (cdr (assoc sk  alist :test #'string=))
        (let ((kk (and (stringp key) (intern (string-upcase key) :keyword))))
          (and kk (cdr (assoc kk alist)))))))

(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)      ; '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any)      ; :any (OR) | :all (AND)
                      (leeway-sec 60))        ; tolÃ©rance horloge (exp/iat)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx et applique des gardes optionnelles.
Options:
 - SECRET         : clÃ© HMAC (dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)
 - LEEWAY-SEC     : tolÃ©rance de clock skew sur exp/iat.\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (%bearer-token-from hdrs)))
            ;; DÃ©codage (tolÃ©rance exp/iat simple via leeway)
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                    (lumen.core.jwt:jwt-decode tok :secret secret :verify t :leeway leeway-sec))
                (when ok
                  ;; Pose le JWT brut et quelques alias pratiques
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (%alist-get-ci payload :tenant)))
                    (when tenant
                      (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                   (role (and jwt (or (%alist-get-ci jwt :role)
                                      (%alist-get-ci jwt \"role\"))))
                   (sc   (or (and jwt (%alist-get-ci jwt :scopes)) '())))
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
                 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scopes? scopes-allow sc)))
                 (fail 403 \"insufficient_scope\"))
                (t
                 (funcall next req))))))))))

(defun auth-required ()
  (auth-jwt :required-p t))

(defun roles-allowed (roles)
  (auth-jwt :required-p t :roles-allow roles))

;;; HTTPS
(defun %bool (x) (and x t))

(defun %request-secure-p (req)
  \"Vrai si la requÃªte est dÃ©jÃ  HTTPS (socket TLS ou proxy qui lâ€™indique).\"
  (or (lumen.core.http:ctx-get req :secure)
      (let* ((h (lumen.core.http:req-headers req))
             (xfp (cdr (assoc \"x-forwarded-proto\" h :test #'string-equal)))
             (xfs (cdr (assoc \"x-forwarded-ssl\"   h :test #'string-equal))))
        (or (and xfp (string-equal xfp \"https\"))
            (and xfs (string-equal xfs \"on\"))))))

(defun %path-has-prefix-p (path prefix)
  (and (<= (length prefix) (length path))
       (string= prefix path :end2 (length prefix))))

(defun %build-query (req)
  \"Reconstruit la query string si possible.\"
  (let ((q (lumen.core.http:req-query req)))
    (cond
      ((null q) \"\")
      ((stringp q) (if (plusp (length q)) (concatenate 'string \"?\" q) \"\"))
      ((listp q)
       (let ((parts
               (mapcar (lambda (cell)
                         (let ((k (car cell)) (v (cdr cell)))
                           ;; k/v peuvent Ãªtre keywords ou strings
                           (format nil \"~A=~A\"
                                   (etypecase k
                                     (string k)
                                     (symbol (string-downcase (symbol-name k))))
                                   (etypecase v
                                     (string v)
                                     (symbol (string-downcase (symbol-name v)))
                                     (t (princ-to-string v))))))
                       q)))
         (if parts
             (concatenate 'string \"?\" (map 'string #'identity
                                           (with-output-to-string (s)
                                             (format s \"~{~A~^&~}\" parts))))
             \"\")))
      (t \"\"))))

(defun host-without-port (host)
  (let ((pos (position #\\: host)))
    (if pos (subseq host 0 pos) host)))

(defun %https-location (req &key ssl-port)
  \"Construit lâ€™URL de redirection https (conserve host, path, query).
   Ajoute :ssl-port si non standard (â‰ 443).\"
  (let* ((h    (lumen.core.http:req-headers req))
         (host (or (cdr (assoc \"x-forwarded-host\" h :test #'string-equal))
                   (cdr (assoc \"host\"             h :test #'string-equal))
                   \"localhost\"))
	 (host0 (host-without-port host))
         (path (lumen.core.http:req-path req))
         (qs   (%build-query req))
         (port-suffix (if (and ssl-port (not (= ssl-port 443)))
                          (format nil \":~D\" ssl-port) \"\"))
         (scheme \"https://\"))
    (format nil \"~A~A~A~A~A\" scheme host0 port-suffix path qs)))

(defun https-redirect (&key
                         (prefixes '(\"/\"))            ; prÃ©fixes Ã  forcer en HTTPS
                         (except-prefixes nil)         ; prÃ©fixes EXCLUS (pas de redirect/HSTS)
                         (ssl-port 443)                ; port public HTTPS
                         (hsts nil)                    ; t â‡’ ajoute Strict-Transport-Security (sur HTTPS)
                         (hsts-max-age 15552000)       ; 180 jours
                         (hsts-include-subdomains t)
                         (hsts-preload nil))
  \"Redirige HTTP â†’ HTTPS (301) pour les chemins dont le prÃ©fixe matche.
Options:
- PREFIXES         : liste de prÃ©fixes (strings) Ã  forcer en https (\\\"/\\\" pour tout).
- EXCEPT-PREFIXES  : liste de prÃ©fixes Ã  EXCLURE (pas de redirect, pas de HSTS).
- SSL-PORT         : port https externe (443 par dÃ©faut).
- HSTS             : si T, ajoute Strict-Transport-Security *sur les rÃ©ponses HTTPS*
                     (sauf si le chemin est exclu par EXCEPT-PREFIXES).\"
  (labels ((matches-any-p (path lst)
             (and lst (some (lambda (pfx) (%path-has-prefix-p path pfx)) lst))))
    (lambda (next)
      (lambda (req)
        (let* ((path     (lumen.core.http:req-path req))
               (in-scope (matches-any-p path prefixes))
               (excluded (matches-any-p path except-prefixes))
               (secure?  (%request-secure-p req)))
          (cond
            ;; DÃ©jÃ  en HTTPS : on passe au suivant, et on pose HSTS si demandÃ© (et non exclu)
            (secure?
             (let ((resp (funcall next req)))
               (when (and hsts (not excluded))
                 (let* ((hdrs (lumen.core.http:resp-headers resp))
                        (val  (with-output-to-string (s)
                                (format s \"max-age=~D\" hsts-max-age)
                                (when hsts-include-subdomains (format s \"; includeSubDomains\"))
                                (when hsts-preload           (format s \"; preload\")))))
                   (setf (lumen.core.http:resp-headers resp)
                         (lumen.utils:ensure-header hdrs \"strict-transport-security\" val))))
               resp))

            ;; HTTP + ciblÃ© + non exclu â†’ 301 vers HTTPS
            ((and in-scope (not excluded) (not secure?))
             (let* ((loc (%https-location req :ssl-port ssl-port))
                    (headers (list (cons \"location\" loc)
                                   (cons \"cache-control\" \"no-store\"))))
               (make-instance 'lumen.core.http:response
                              :status 301 :headers headers :body \"\")))

            ;; HTTP hors-scope ou exclu â†’ passer au suivant
            (t
             (funcall next req))))))))

;;Le rate limiting contrÃ´le combien de fois un client peut appeler une route
;; dans une pÃ©riode donnÃ©e. Câ€™est une protection anti-abus / DDoS / brute-force.
(defun rate-limit (&key (capacity 10) (refill-per-sec 1) (route-key \"default\"))
  (lambda (next)
    (lambda (req)
      (if (lumen.core.ratelimit:allow? req :capacity capacity
					   :refill-per-sec refill-per-sec
					   :route-key route-key)
          (funcall next req)
          (lumen.core.http:respond-json
           '((:error . ((:type . \"rate_limit\") (:message . \"Too Many Requests\"))))
           :status 429)))))

;;; Request Timeout (504 si le handler dÃ©passe N ms)
(defun request-timeout (&key (ms 5000))
  (lambda (next)
    (lambda (req)
      (let* ((lock (bordeaux-threads:make-lock \"rt-lock\"))
             (cv   (bordeaux-threads:make-condition-variable))
             (resp nil))
	(bordeaux-threads:make-thread
	 (lambda ()
	   (let ((r (funcall next req)))
             (bordeaux-threads:with-lock-held (lock)
               (setf resp r)
               (bordeaux-threads:condition-notify cv)))))
	(bordeaux-threads:with-lock-held (lock)
	  (unless (bordeaux-threads:condition-wait cv lock :timeout (/ ms 1000.0))
            ;; timeout â†’ 504
            (return-from request-timeout
              (lumen.core.http:respond-json
               '((:error . ((:type . \"timeout\") (:message . \"gateway timeout\"))))
               :status 504))))
	resp))))

;;; max-body-size (413 si Content-Length trop grand)
(defun max-body-size (&key (bytes (* 2 1024 1024))) ; 2 MiB
  (lambda (next)
    (lambda (req)
      (let* ((clen (cdr (assoc \"content-length\" (lumen.core.http:req-headers req)
                               :test #'string-equal)))
             (n (and clen (parse-integer clen :junk-allowed t))))
	(when (and n (> n bytes))
	  (return-from max-body-size
            (lumen.core.http:respond-json
             `((:error . ((:type . \"payload_too_large\")
			  (:message . ,(format nil \"max ~D bytes\" bytes)))))
             :status 413))))
      ;; pour les cas sans Content-Length, on laisse les parseurs respecter une limite via ctx si tu veux
      (lumen.core.http:ctx-set! req :max-body-size bytes)
      (funcall next req))))

;;; Access Log JSON
(defun %open-log-file (path)
  (open path :direction :output :if-exists :append :if-does-not-exist :create
             :external-format :utf-8))

(defun %rfc3339-now ()
  (local-time:format-timestring
   nil (local-time:now)
   :format '(:year \"-\" (:month 2) \"-\" (:day 2) \"T\" (:hour 2) \":\" (:min 2) \":\" (:sec 2) \"Z\")))

(defun %plist->alist (plist)
  (loop for (k v) on plist by #'cddr collect (cons k v)))

(defun %normalize-fields (fields req resp ms bytes)
  \"Retourne une alist Ã  partir de FIELDS (NIL | alist | plist | fn).\"
  (cond
    ((null fields) nil)
    ((and (listp fields)
          (every #'consp fields)) fields)                  ; dÃ©jÃ  alist
    ((and (listp fields) (evenp (length fields))) (%plist->alist fields)) ; plist
    ((functionp fields) (let ((res (funcall fields req resp ms bytes)))
                          (cond
                            ((null res) nil)
                            ((and (listp res) (every #'consp res)) res)
                            ((and (listp res) (evenp (length res))) (%plist->alist res))
                            (t nil))))
    (t nil)))

(defun %merge-alist (base extras &key (test #'equal))
  \"Merge en donnant prioritÃ© Ã  EXTRAS (override).\"
  (let ((res (copy-list base)))
    (dolist (kv extras)
      (let* ((k (car kv))
             (cell (assoc k res :test test)))
        (if cell
            (setf (cdr cell) (cdr kv))
            (push kv res))))
    (nreverse res)))

(defun access-log-json (&key stream to-file fields)
  \"Middleware: Ã©crit une ligne JSON par requÃªte.
:fields accepte NIL, alist, plist, ou (lambda (req resp ms bytes) -> alist/plist).\"
  (let* ((out (or (and to-file (%open-log-file to-file))
                  (or stream *standard-output*)))
         (lock (bordeaux-threads:make-lock \"access-log-json\")))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0  (get-internal-real-time))
                 (rid (or (lumen.core.http:ctx-get req :request-id) \"\"))
                 (ip  (or (let* ((xff (h \"x-forwarded-for\")))
                            (and xff (car (uiop:split-string xff :separator \",\"))))
                          (h \"x-real-ip\") \"\"))
                 (mth (or (lumen.core.http:req-method req) \"GET\"))
                 (host (or (h \"host\") \"\"))
                 (pth (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms  (/ (- (get-internal-real-time) t0)
                         (/ internal-time-units-per-second 1000.0)))
                 (body (lumen.core.http:resp-body resp))
                 (bytes (cond
                          ((stringp body) (length (trivial-utf-8:string-to-utf-8-bytes body)))
                          ((typep body '(simple-array (unsigned-byte 8) (*))) (length body))
                          (t nil))) ; streaming inconnu â†’ omis
                 (base `((:ts . ,(%rfc3339-now))
                         (:request_id . ,rid)
                         (:ip . ,ip)
                         (:method . ,mth)
                         (:host . ,host)
                         (:path . ,pth)
                         (:status . ,(lumen.core.http:resp-status resp))
                         (:ms . ,(round ms))
                         ,@(when bytes `((:bytes . ,bytes)))))
                 (extra (%normalize-fields fields req resp ms bytes))
                 (obj   (%merge-alist base extra :test
                                      (lambda (a b)
                                        (string-equal (if (symbolp a) (symbol-name a) (format nil \"~A\" a))
                                                      (if (symbolp b) (symbol-name b) (format nil \"~A\" b)))))))
            (bordeaux-threads:with-lock-held (lock)
              (handler-case
                  (progn
                    (write-string (cl-json:encode-json-to-string obj) out)
                    (terpri out)
                    (finish-output out))
                (error (_)
                  (declare (ignore _))
                  (format out \"~S~%\" obj)
                  (finish-output out))))
            resp))))))

(define-middleware tenant-from-host (req next)
  (let* ((host (cdr (assoc \"host\" (lumen.core.http:req-headers req) :test #'string-equal)))
         ;; mappe host -> UUID (ou via SELECT sur tenants(code))
         (tid  (crd.backend.repo:tenant-id-for-host host)))  ;; retourne une string UUID
    (when tid
      (lumen.core.http:ctx-set! req :tenant-id tid)
      ;; optionnel: aussi le code si tu veux
      (lumen.core.http:ctx-set! req :tenant-code (crd.backend.repo:tenant-code-by-id tid))))
  (funcall next req))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 52 (face font-lock-type-face fontified t) 52 56 (fontified t) 56 60 (face font-lock-builtin-face fontified t) 60 61 (fontified t) 61 64 (face font-lock-builtin-face fontified t) 64 65 (fontified t) 65 76 (face font-lock-builtin-face fontified t) 76 81 (fontified t) 81 93 (face font-lock-builtin-face fontified t) 93 94 (fontified t) 94 110 (face font-lock-builtin-face fontified t) 110 111 (fontified t) 111 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 129 (face font-lock-builtin-face fontified t) 129 130 (fontified t) 130 140 (face font-lock-builtin-face fontified t) 140 141 (fontified t) 141 153 (face font-lock-builtin-face fontified t) 153 157 (fontified t) 157 170 (face font-lock-builtin-face fontified t) 170 171 (fontified t) 171 183 (face font-lock-builtin-face fontified t) 183 184 (fontified t) 184 196 (face font-lock-builtin-face fontified t) 196 197 (fontified t) 197 207 (face font-lock-builtin-face fontified t) 207 208 (fontified t) 208 216 (face font-lock-builtin-face fontified t) 216 217 (fontified t) 217 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 243 (face font-lock-builtin-face fontified t) 243 244 (fontified t) 244 256 (face font-lock-builtin-face fontified t) 256 257 (fontified t) 257 260 (face font-lock-builtin-face fontified t) 260 261 (fontified t) 261 265 (face font-lock-builtin-face fontified t) 265 266 (fontified t) 266 279 (face font-lock-builtin-face fontified t) 279 280 (fontified t) 280 294 (face font-lock-builtin-face fontified t) 294 295 (fontified t) 295 311 (face font-lock-builtin-face fontified t) 311 314 (fontified t) 314 331 (face font-lock-builtin-face fontified t) 331 336 (fontified t) 336 348 (face font-lock-builtin-face fontified t) 348 349 (fontified t) 349 365 (face font-lock-builtin-face fontified t) 365 366 (fontified t) 366 383 (face font-lock-builtin-face fontified t) 383 388 (fontified t) 388 400 (face font-lock-builtin-face fontified t) 400 401 (fontified t) 401 422 (face font-lock-builtin-face fontified t) 422 423 (fontified t) 423 442 (face font-lock-builtin-face fontified t) 442 443 (fontified t) 443 461 (face font-lock-builtin-face fontified t) 461 466 (fontified t) 466 478 (face font-lock-builtin-face fontified t) 478 479 (fontified t) 479 498 (face font-lock-builtin-face fontified t) 498 499 (fontified t) 499 510 (face font-lock-builtin-face fontified t) 510 511 (fontified t) 511 524 (face font-lock-builtin-face fontified t) 524 525 (fontified t) 525 537 (face font-lock-builtin-face fontified t) 537 538 (fontified t) 538 551 (face font-lock-builtin-face fontified t) 551 552 (fontified t) 552 565 (face font-lock-builtin-face fontified t) 565 566 (fontified t) 566 584 (face font-lock-builtin-face fontified t) 584 585 (fontified t) 585 594 (face font-lock-builtin-face fontified t) 594 595 (fontified t) 595 605 (face font-lock-builtin-face fontified t) 605 606 (fontified t) 606 617 (face font-lock-builtin-face fontified t) 617 618 (fontified t) 618 629 (face font-lock-builtin-face fontified t) 629 630 (fontified t) 630 641 (face font-lock-builtin-face fontified t) 641 642 (fontified t) 642 656 (face font-lock-builtin-face fontified t) 656 657 (fontified t) 657 674 (face font-lock-builtin-face fontified t) 674 675 (fontified t) 675 691 (face font-lock-builtin-face fontified t) 691 696 (fontified t) 696 708 (face font-lock-builtin-face fontified t) 708 709 (fontified t) 709 724 (face font-lock-builtin-face fontified t) 724 725 (fontified t) 725 738 (face font-lock-builtin-face fontified t) 738 739 (fontified t) 739 750 (face font-lock-builtin-face fontified t) 750 751 (fontified t) 751 762 (face font-lock-builtin-face fontified t) 762 767 (fontified t) 767 779 (face font-lock-builtin-face fontified t) 779 780 (fontified t) 780 801 (face font-lock-builtin-face fontified t) 801 802 (fontified t) 802 809 (face font-lock-builtin-face fontified t) 809 814 (fontified t) 814 826 (face font-lock-builtin-face fontified t) 826 827 (fontified t) 827 849 (face font-lock-builtin-face fontified t) 849 850 (fontified t) 850 863 (face font-lock-builtin-face fontified t) 863 868 (fontified t) 868 875 (face font-lock-builtin-face fontified t) 875 876 (fontified t) 876 894 (face font-lock-builtin-face fontified t) 894 895 (fontified t) 895 906 (face font-lock-builtin-face fontified t) 906 907 (fontified t) 907 913 (face font-lock-builtin-face fontified t) 913 914 (fontified t) 914 921 (face font-lock-builtin-face fontified t) 921 922 (fontified t) 922 932 (face font-lock-builtin-face fontified t) 932 933 (fontified t) 933 946 (face font-lock-builtin-face fontified t) 946 951 (fontified t) 951 979 (face font-lock-builtin-face fontified t) 979 980 (fontified t) 980 988 (face font-lock-builtin-face fontified t) 988 989 (fontified t) 989 998 (face font-lock-builtin-face fontified t) 998 999 (fontified t) 999 1020 (face font-lock-builtin-face fontified t) 1020 1025 (fontified t) 1025 1031 (face font-lock-builtin-face fontified t) 1031 1032 (fontified t) 1032 1037 (face font-lock-builtin-face fontified t) 1037 1038 (fontified t) 1038 1045 (face font-lock-builtin-face fontified t) 1045 1046 (fontified t) 1046 1051 (face font-lock-builtin-face fontified t) 1051 1052 (fontified t) 1052 1062 (face font-lock-builtin-face fontified t) 1062 1063 (fontified t) 1063 1075 (face font-lock-builtin-face fontified t) 1075 1080 (fontified t) 1080 1092 (face font-lock-builtin-face fontified t) 1092 1093 (fontified t) 1093 1110 (face font-lock-builtin-face fontified t) 1110 1115 (fontified t) 1115 1118 (face font-lock-comment-delimiter-face fontified t) 1118 1134 (face font-lock-comment-face fontified t) 1134 1137 (fontified t) 1137 1153 (face font-lock-builtin-face fontified t) 1153 1154 (fontified t) 1154 1168 (face font-lock-builtin-face fontified t) 1168 1172 (fontified t) 1172 1175 (face font-lock-comment-delimiter-face fontified t) 1175 1183 (face font-lock-comment-face fontified t) 1183 1186 (fontified t) 1186 1197 (face font-lock-builtin-face fontified t) 1197 1198 (fontified t) 1198 1210 (face font-lock-builtin-face fontified t) 1210 1211 (fontified t) 1211 1218 (face font-lock-builtin-face fontified t) 1218 1219 (fontified t) 1219 1234 (face font-lock-builtin-face fontified t) 1234 1238 (fontified t) 1238 1241 (face font-lock-comment-delimiter-face fontified t) 1241 1246 (face font-lock-comment-face fontified t) 1246 1249 (fontified t) 1249 1254 (face font-lock-builtin-face fontified t) 1254 1258 (fontified t) 1258 1261 (face font-lock-comment-delimiter-face fontified t) 1261 1273 (face font-lock-comment-face fontified t) 1273 1276 (fontified t) 1276 1288 (face font-lock-builtin-face fontified t) 1288 1292 (fontified t) 1292 1318 (face font-lock-builtin-face fontified t) 1318 1322 (fontified t) 1322 1325 (face font-lock-comment-delimiter-face fontified t) 1325 1333 (face font-lock-comment-face fontified t) 1333 1337 (fontified t) 1337 1345 (face font-lock-builtin-face fontified t) 1345 1349 (fontified t) 1349 1354 (face font-lock-builtin-face fontified t) 1354 1359 (fontified t) 1359 1368 (face font-lock-builtin-face fontified t) 1368 1372 (fontified t) 1372 1387 (face font-lock-builtin-face fontified t) 1387 1392 (fontified t) 1392 1406 (face font-lock-builtin-face fontified t) 1406 1407 (fontified t) 1407 1421 (face font-lock-builtin-face fontified t) 1421 1422 (fontified t) 1422 1433 (face font-lock-builtin-face fontified t) 1433 1438 (fontified t) 1438 1454 (face font-lock-builtin-face fontified t) 1454 1455 (fontified t) 1455 1469 (face font-lock-builtin-face fontified t) 1469 1470 (fontified t) 1470 1486 (face font-lock-builtin-face fontified t) 1486 1491 (fontified t) 1491 1500 (face font-lock-builtin-face fontified t) 1500 1508 (face font-lock-builtin-face fontified t) 1508 1511 (fontified t) 1511 85567 (fontified nil)) . 1) (t 26809 13022 0 0)) nil (26809 16043 292499 0) 0 nil])
([nil nil ((84948 . 84949) (t 26809 16046 0 0)) nil (26811 59703 876572 0) 0 nil])
([nil nil ((84949 . 84950)) nil (26811 59703 876572 0) 0 nil])
([nil nil ((#("#" 0 1 (fontified t)) . -84949) (undo-tree-id14 . -1) 84950) nil (26811 59703 876571 0) 0 nil])
([nil nil ((84949 . 84970)) nil (26811 59703 876570 0) 0 nil])
([nil nil ((84970 . 84991)) nil (26811 59703 876569 0) 0 nil])
([nil nil ((84991 . 85012)) nil (26811 59703 876569 0) 0 nil])
([nil nil ((85012 . 85023)) nil (26811 59703 876568 0) 0 nil])
([nil nil ((84952 . 85026) (#("-----------------------------------------------------------------------" 0 71 (face font-lock-comment-face fontified t)) . -84952) (undo-tree-id13 . -71) 85023) nil (26811 59703 876568 0) 0 nil])
([nil nil ((85026 . 85027)) nil (26811 59703 876566 0) 0 nil])
([nil nil ((85027 . 85030)) nil (26811 59703 876566 0) 0 nil])
([nil nil ((85030 . 85031)) nil (26811 59703 876565 0) 0 nil])
([nil nil ((85031 . 85034)) nil (26811 59703 876565 0) 0 nil])
([nil nil ((85034 . 85035)) nil (26811 59703 876564 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 85111 . 85112) (nil fontified nil 85038 . 85112) (nil fontified nil 85035 . 85038) (85035 . 85112)) nil (26811 59703 876563 0) 0 nil])
([nil nil ((85030 . 85031)) nil (26811 59703 876563 0) 0 nil])
([nil nil ((85031 . 85033)) nil (26811 59703 876562 0) 0 nil])
([nil nil ((85033 . 85034)) nil (26811 59703 876561 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 85221 . 85222) (nil fontified nil 85034 . 85222) (85034 . 85222)) nil (26811 59703 876560 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -85222) (undo-tree-id9 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -85223) (undo-tree-id10 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -85224) (undo-tree-id11 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -85225) (undo-tree-id12 . -1) 85226) nil (26811 59703 876559 0) 0 nil])
([nil nil ((85300 . 85301)) nil (26811 59703 876549 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 87499 . 87500) (nil fontified nil 85301 . 87500) (85301 . 87500)) nil (26811 59703 876548 0) 0 nil])
([nil nil ((85396 . 85397)) nil (26811 59703 876547 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -85396) (undo-tree-id8 . -1) 85397) nil (26811 59703 876546 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -85381) (undo-tree-id7 . -1) 85382) nil (26811 59703 876545 0) 0 nil])
([nil nil ((#("

(defun make-request-id ()
  \"UUIDv4-ish (hex) simple, suffisant pour corrÃ©lation de logs.\"
  (let ((h (%rand-hex 16)))
    (format nil \"~A-~A-4~A-~A~A-~A\"
            (subseq h 0 8) (subseq h 8 12) (subseq h 13 16)
            (subseq h 16 17) (subseq h 17 20) (subseq h 20 32))))" 0 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 24 (face font-lock-function-name-face fontified t) 24 30 (fontified t) 30 92 (face font-lock-doc-face fontified t) 92 96 (fontified t) 96 99 (face font-lock-keyword-face fontified t) 99 137 (fontified t) 137 156 (face font-lock-string-face fontified t) 156 282 (fontified t)) . 86161) (undo-tree-id5 . -282) (undo-tree-id6 . -216)) nil (26811 59703 876543 0) 0 nil])
([nil nil ((#("
;; Ton gÃ©nÃ©rateur dâ€™ID existant (repris tel quel)
(defun %rand-hex (nbytes)
  (let ((hex \"0123456789abcdef\"))
    (with-output-to-string (s)
      (dotimes (i (* 2 nbytes))
        (write-char (char hex (random 16)) s)))))" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 51 (face font-lock-comment-face fontified t) 51 52 (fontified t) 52 57 (face font-lock-keyword-face fontified t) 57 58 (fontified t) 58 67 (face font-lock-function-name-face fontified t) 67 80 (fontified t) 80 83 (face font-lock-keyword-face fontified t) 83 90 (fontified t) 90 108 (face font-lock-string-face fontified t) 108 116 (fontified t) 116 137 (face font-lock-keyword-face fontified t) 137 149 (fontified t) 149 156 (face font-lock-keyword-face fontified t) 156 174 (fontified t) 174 223 (fontified t)) . 85938) (undo-tree-id3 . -223) (undo-tree-id4 . -223)) nil (26811 59703 876540 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -85937) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 85938) nil (26811 59703 876537 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 85937)) nil (26811 59703 876516 0) 0 nil])
([nil nil ((86992 . 86993)) nil (26811 59703 876511 0) 0 nil])
([nil nil ((1121 . 1122) (t 26811 59703 0 0)) nil (26811 60412 544089 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1136 . 1137) (nil fontified nil 1122 . 1137) (1122 . 1137)) nil (26811 60412 544087 0) 0 nil])
([nil nil ((1137 . 1138)) nil (26811 60412 544081 0) 0 nil])
([nil nil ((#("
             (len (length s))" 0 30 (fontified t)) . 69345) (undo-tree-id0 . -30) (t 26811 60412 0 0)) nil (26812 51560 458347 0) 0 nil])
([nil nil ((36411 . 36416) (t 26812 51560 0 0)) nil (26812 63458 26364 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 36734 . 36735) (nil fontified nil 36716 . 36735) (nil fontified nil 36696 . 36716) (nil fontified nil 36625 . 36696) (nil fontified nil 36610 . 36625) (nil fontified nil 36416 . 36610) (36416 . 36735)) nil (26812 63458 26363 0) 0 nil])
([nil nil ((#("\"cache-control\"
                                                          (format nil \"public, max-age=~D\" file-cache-secs)" 0 15 (face font-lock-string-face fontified t) 15 86 (fontified t) 86 106 (face font-lock-string-face fontified t) 106 123 (fontified t)) . -36610) (undo-tree-id22 . -123) (undo-tree-id23 . -123) (undo-tree-id24 . -123) (undo-tree-id25 . -123) (undo-tree-id26 . -123) (undo-tree-id27 . -16) (undo-tree-id28 . -123) (undo-tree-id29 . -123) 36733) nil (26812 63458 26362 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 36633 . 36634) (nil fontified nil 36610 . 36634) (36610 . 36634)) nil (26812 63458 26354 0) 0 nil])
([nil nil ((36516 . 36520) (#(" " 0 1 (fontified nil)) . 36515) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (36516 . 36517)) nil (26812 63458 26352 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 36555) (undo-tree-id9 . -1) (undo-tree-id10 . -1)) nil (26812 63458 26341 0) 0 nil])
([nil nil ((#("                          " 0 26 (fontified nil)) . -36588) (undo-tree-id0 . -26) (undo-tree-id1 . -26) (undo-tree-id2 . -26) (undo-tree-id3 . -26) (undo-tree-id4 . -26) (undo-tree-id5 . -26) (undo-tree-id6 . -26) (undo-tree-id7 . -26) (undo-tree-id8 . -26) (36555 . 36556)) nil (26812 63458 26335 0) 0 nil])
([nil nil ((37859 . 37861) (t 26812 63458 0 0)) nil (26813 21032 355004 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 51419 . 51420) (nil fontified nil 37861 . 51420) (37861 . 51420)) nil (26813 21032 355003 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -51419) (undo-tree-id31 . -1) 51420) nil (26813 21032 355001 0) 0 nil])
([nil nil ((51419 . 51420)) nil (26813 21032 354997 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -51419) (undo-tree-id30 . -1) 51420) nil (26813 21032 354995 0) 0 nil])
([nil nil ((37860 . 37862)) nil (26813 21032 354969 0) 0 nil])
([nil nil ((29762 . 29764)) nil (26813 21032 354962 0) 0 nil])
([nil nil ((20822 . 20824) (t 26813 21032 0 0)) nil (26813 22679 258392 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23252 . 23253) (nil fontified nil 20824 . 23253) (20824 . 23253)) nil (26813 22679 258391 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -23252) (undo-tree-id35 . -1) 23253) nil (26813 22679 258389 0) 0 nil])
([nil nil ((20823 . 20825)) nil (26813 22679 258387 0) 0 nil])
([nil nil ((#("{" 0 1 (fontified t)) . -20824) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) 20825) nil (26813 22679 258385 0) 0 nil])
([nil nil ((20824 . 20825)) nil (26813 22679 258364 0) 0 nil])
([nil nil ((19340 . 19342)) nil (26813 22679 258357 0) 0 nil])
([nil nil ((#("(defun %alist-get-ci (alist key)
  \"Assoc insensitive string|keyword sur alist mixte.\"
  (let ((sk (etypecase key
              (keyword (string-downcase (symbol-name key)))
              (string  (string-downcase key)))))
    (or (cdr (assoc key alist :test #'equal))
        (cdr (assoc sk  alist :test #'string=))
        (let ((kk (and (stringp key) (intern (string-upcase key) :keyword))))
          (and kk (cdr (assoc kk alist)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 35 (fontified t) 35 86 (face font-lock-doc-face fontified t) 86 90 (fontified t) 90 93 (face font-lock-keyword-face fontified t) 93 100 (fontified t) 100 109 (face font-lock-keyword-face fontified t) 109 253 (fontified t) 253 258 (face font-lock-builtin-face fontified t) 258 299 (fontified t) 299 304 (face font-lock-builtin-face fontified t) 304 326 (fontified t) 326 329 (face font-lock-keyword-face fontified t) 329 382 (fontified t) 382 390 (face font-lock-builtin-face fontified t) 390 440 (fontified t)) . -85882) (undo-tree-id46 . -440) (undo-tree-id47 . -20) (undo-tree-id48 . -20) (undo-tree-id49 . -20) (undo-tree-id50 . -20) (undo-tree-id51 . -20) (undo-tree-id52 . -20) (undo-tree-id53 . -20) (undo-tree-id54 . -373) (undo-tree-id55 . -373) (undo-tree-id56 . -373) (undo-tree-id57 . -373) (undo-tree-id58 . -395) (undo-tree-id59 . -440) (undo-tree-id60 . -440) 86322 (t 26813 22679 0 0)) nil (26819 18376 269948 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86479 . 86480) (nil fontified nil 85882 . 86480) (85882 . 86480)) nil (26819 18376 269939 0) 0 nil])
([nil nil ((86480 . 86482)) nil (26819 18376 269939 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86814 . 86815) (nil fontified nil 86482 . 86815) (86482 . 86815)) nil (26819 18376 269938 0) 0 nil])
([nil nil ((86480 . 86482)) nil (26819 18376 269938 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86578 . 86579) (nil fontified nil 86482 . 86579) (86482 . 86579)) nil (26819 18376 269937 0) 0 nil])
([nil nil ((86915 . 86916)) nil (26819 18376 269937 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 92007 . 92008) (nil fontified nil 86916 . 92008) (86916 . 92008)) nil (26819 18376 269936 0) 0 nil])
([nil nil ((87665 . 87666)) nil (26819 18376 269935 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 87989 . 87990) (nil fontified nil 87666 . 87990) (87666 . 87990)) nil (26819 18376 269935 0) 0 nil])
([nil nil ((92333 . 92334)) nil (26819 18376 269934 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -92333) (undo-tree-id44 . -1) (undo-tree-id45 . -1) 92334) nil (26819 18376 269933 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)      ; '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any)      ; :any (OR) | :all (AND)
                      (leeway-sec 60))        ; tolÃ©rance horloge (exp/iat)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx et applique des gardes optionnelles.
Options:
 - SECRET         : clÃ© HMAC (dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)
 - LEEWAY-SEC     : tolÃ©rance de clock skew sur exp/iat.\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (%bearer-token-from hdrs)))
            ;; DÃ©codage (tolÃ©rance exp/iat simple via leeway)
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                    (lumen.core.jwt:jwt-decode tok :secret secret :verify t :leeway leeway-sec))
                (when ok
                  ;; Pose le JWT brut et quelques alias pratiques
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (%alist-get-ci payload :tenant)))
                    (when tenant
                      (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                   (role (and jwt (or (%alist-get-ci jwt :role)
                                      (%alist-get-ci jwt \"role\"))))
                   (sc   (or (and jwt (%alist-get-ci jwt :scopes)) '())))
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
                 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scopes? scopes-allow sc)))
                 (fail 403 \"insufficient_scope\"))
                (t
                 (funcall next req))))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 179 (fontified t) 179 216 (face font-lock-comment-face fontified t) 216 251 (fontified t) 251 255 (face font-lock-builtin-face fontified t) 255 256 (fontified t) 256 262 (fontified t) 262 287 (face font-lock-comment-face fontified t) 287 333 (fontified t) 333 363 (face font-lock-comment-face fontified t) 363 365 (fontified t) 365 784 (face font-lock-doc-face fontified t) 784 788 (fontified t) 788 791 (face font-lock-keyword-face fontified t) 791 802 (fontified t) 802 804 (face font-lock-keyword-face fontified t) 804 866 (fontified t) 866 872 (face font-lock-keyword-face fontified t) 872 887 (fontified t) 887 893 (face font-lock-keyword-face fontified t) 893 909 (fontified t) 909 915 (face font-lock-keyword-face fontified t) 915 1012 (fontified t) 1012 1018 (face font-lock-builtin-face fontified t) 1018 1023 (fontified t) 1023 1028 (face font-lock-builtin-face fontified t) 1028 1031 (fontified t) 1031 1037 (face font-lock-string-face fontified t) 1037 1040 (fontified t) 1040 1048 (face font-lock-builtin-face fontified t) 1048 1076 (fontified t) 1076 1083 (face font-lock-builtin-face fontified t) 1083 1149 (fontified t) 1149 1153 (face font-lock-keyword-face fontified t) 1153 1165 (fontified t) 1165 1189 (fontified t) 1189 1223 (fontified t) 1223 1227 (face font-lock-builtin-face fontified t) 1227 1255 (fontified t) 1255 1261 (face font-lock-keyword-face fontified t) 1261 1281 (fontified t) 1281 1286 (face font-lock-builtin-face fontified t) 1286 1354 (fontified t) 1354 1360 (face font-lock-keyword-face fontified t) 1360 1380 (fontified t) 1380 1385 (face font-lock-builtin-face fontified t) 1385 1421 (fontified t) 1421 1425 (face font-lock-keyword-face fontified t) 1425 1500 (fontified t) 1500 1501 (fontified t) 1501 1519 (fontified t) 1519 1531 (fontified t) 1531 1534 (face font-lock-comment-delimiter-face fontified t) 1534 1581 (face font-lock-comment-face fontified t) 1581 1594 (fontified t) 1594 1598 (face font-lock-keyword-face fontified t) 1598 1618 (fontified t) 1618 1637 (face font-lock-keyword-face fontified t) 1637 1670 (fontified t) 1670 1683 (face font-lock-keyword-face fontified t) 1683 1735 (fontified t) 1735 1742 (face font-lock-builtin-face fontified t) 1742 1750 (fontified t) 1750 1757 (face font-lock-builtin-face fontified t) 1757 1760 (fontified t) 1760 1767 (face font-lock-builtin-face fontified t) 1767 1787 (fontified t) 1787 1798 (fontified t) 1798 1802 (face font-lock-keyword-face fontified t) 1802 1806 (fontified t) 1806 1824 (fontified t) 1824 1827 (face font-lock-comment-delimiter-face fontified t) 1827 1872 (face font-lock-comment-face fontified t) 1872 1920 (fontified t) 1920 1924 (face font-lock-builtin-face fontified t) 1924 1953 (fontified t) 1953 1957 (face font-lock-keyword-face fontified t) 1957 1965 (fontified t) 1965 1990 (fontified t) 1990 1997 (face font-lock-builtin-face fontified t) 1997 2022 (fontified t) 2022 2026 (face font-lock-keyword-face fontified t) 2026 2086 (fontified t) 2086 2093 (face font-lock-builtin-face fontified t) 2093 2119 (fontified t) 2119 2122 (face font-lock-comment-delimiter-face fontified t) 2122 2137 (face font-lock-comment-face fontified t) 2137 2150 (fontified t) 2150 2154 (face font-lock-keyword-face fontified t) 2154 2191 (fontified t) 2191 2195 (face font-lock-builtin-face fontified t) 2195 2255 (fontified t) 2255 2260 (face font-lock-builtin-face fontified t) 2260 2319 (fontified t) 2319 2325 (face font-lock-string-face fontified t) 2325 2387 (fontified t) 2387 2394 (face font-lock-builtin-face fontified t) 2394 2419 (fontified t) 2419 2423 (face font-lock-keyword-face fontified t) 2423 2496 (fontified t) 2496 2522 (face font-lock-string-face fontified t) 2522 2615 (fontified t) 2615 2620 (face font-lock-builtin-face fontified t) 2620 2661 (fontified t) 2661 2672 (face font-lock-string-face fontified t) 2672 2689 (fontified t) 2689 2738 (fontified t) 2738 2765 (fontified t) 2765 2785 (face font-lock-string-face fontified t) 2785 2852 (fontified t)) . -92333) (undo-tree-id0 . -575) (undo-tree-id1 . -1154) (undo-tree-id2 . -1154) (undo-tree-id3 . -1154) (undo-tree-id4 . -1603) (undo-tree-id5 . -2852) (undo-tree-id6 . -2852) (undo-tree-id7 . -2136) (undo-tree-id8 . -1) (undo-tree-id9 . -2852) (undo-tree-id10 . -1) (undo-tree-id11 . -1519) (undo-tree-id12 . -133) (undo-tree-id13 . -133) (undo-tree-id14 . -133) (undo-tree-id15 . -133) (undo-tree-id16 . -133) (undo-tree-id17 . -133) (undo-tree-id18 . -459) (undo-tree-id19 . -459) (undo-tree-id20 . -459) (undo-tree-id21 . -459) (undo-tree-id22 . -459) (undo-tree-id23 . -783) (undo-tree-id24 . -783) (undo-tree-id25 . -783) (undo-tree-id26 . -783) (undo-tree-id27 . -783) (undo-tree-id28 . -783) (undo-tree-id29 . -783) (undo-tree-id30 . -783) (undo-tree-id31 . -783) (undo-tree-id32 . -287) (undo-tree-id33 . -459) (undo-tree-id34 . -1) (undo-tree-id35 . -287) (undo-tree-id36 . -45) (undo-tree-id37 . -45) (undo-tree-id38 . -1) (undo-tree-id39 . -1519) (undo-tree-id40 . -879) (undo-tree-id41 . -1647) (undo-tree-id42 . -2562) (undo-tree-id43 . -2852) 95185) nil (26819 18376 269930 0) 0 nil])
([nil nil ((92333 . 92334)) nil (26819 18376 269887 0) 0 nil])
([nil nil ((90659 . 90665) (t 26819 18376 0 0)) nil (26819 22002 4978 0) 0 nil])
([nil nil ((90665 . 90666)) nil (26819 22002 4977 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -90665) (undo-tree-id86 . -1) 90666) nil (26819 22002 4976 0) 0 nil])
([nil nil ((90665 . 90671)) nil (26819 22002 4975 0) 0 nil])
([nil nil ((90671 . 90672)) nil (26819 22002 4975 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -90671) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) 90672) nil (26819 22002 4974 0) 0 nil])
([nil nil ((90671 . 90672)) nil (26819 22002 4971 0) 0 nil])
([nil nil ((90672 . 90673)) nil (26819 22002 4970 0) 0 nil])
([nil nil ((90673 . 90674)) nil (26819 22002 4970 0) 0 nil])
([nil nil ((90674 . 90675)) nil (26819 22002 4969 0) 0 nil])
([nil nil ((90675 . 90681)) nil (26819 22002 4969 0) 0 nil])
([nil nil ((#("K" 0 1 (face font-lock-string-face fontified t)) . -90679) (undo-tree-id79 . -1) (#("K" 0 1 (face font-lock-string-face fontified t)) . -90680) (undo-tree-id80 . -1) 90681) nil (26819 22002 4968 0) 0 nil])
([nil nil ((90679 . 90684)) nil (26819 22002 4967 0) 0 nil])
([nil nil ((90684 . 90685)) nil (26819 22002 4966 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-string-face fontified t)) . -90683) (undo-tree-id77 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -90684) (undo-tree-id78 . -1) 90685) nil (26819 22002 4966 0) 0 nil])
([nil nil ((90683 . 90684)) nil (26819 22002 4964 0) 0 nil])
([nil nil ((90684 . 90685)) nil (26819 22002 4963 0) 0 nil])
([nil nil ((90685 . 90688)) nil (26819 22002 4963 0) 0 nil])
([nil nil ((#("Ã©" 0 1 (face font-lock-string-face fontified t)) . -90687) (undo-tree-id76 . -1) 90688) nil (26819 22002 4962 0) 0 nil])
([nil nil ((90687 . 90689)) nil (26819 22002 4959 0) 0 nil])
([nil nil ((90689 . 90690)) nil (26819 22002 4959 0) 0 nil])
([nil nil ((90690 . 90693)) nil (26819 22002 4958 0) 0 nil])
([nil nil ((90693 . 90694)) nil (26819 22002 4958 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -90693) (undo-tree-id74 . -1) (undo-tree-id75 . -1) 90694) nil (26819 22002 4957 0) 0 nil])
([nil nil ((90693 . 90695)) nil (26819 22002 4956 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -90693) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (#(")" 0 1 (fontified t)) . -90694) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) 90695) nil (26819 22002 4954 0) 0 nil])
([nil nil ((90693 . 90694)) nil (26819 22002 4946 0) 0 nil])
([nil nil ((90689 . 90690)) nil (26819 22002 4945 0) 0 nil])
([nil nil ((90690 . 90691)) nil (26819 22002 4944 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -90691) (undo-tree-id61 . -1) 90692) nil (26819 22002 4940 0) 0 nil])
([nil nil ((90869 . 90875) (#(" " 0 1 (fontified nil)) . 90868) (undo-tree-id93 . -1) (#(" " 0 1 (fontified nil)) . -90842) (90870 . 90871) (t 26819 22002 0 0)) nil (26819 47276 411762 0) 0 nil])
([nil nil ((90924 . 90927)) nil (26819 47276 411761 0) 0 nil])
([nil nil ((90927 . 90931)) nil (26819 47276 411760 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -90927) (undo-tree-id89 . -1) (#("r" 0 1 (fontified t)) . -90928) (undo-tree-id90 . -1) (#("i" 0 1 (fontified t)) . -90929) (undo-tree-id91 . -1) (#("n" 0 1 (fontified t)) . -90930) (undo-tree-id92 . -1) 90931) nil (26819 47276 411759 0) 0 nil])
([nil nil ((90927 . 90933)) nil (26819 47276 411756 0) 0 nil])
([nil nil ((90933 . 90934)) nil (26819 47276 411756 0) 0 nil])
([nil nil ((90934 . 90937)) nil (26819 47276 411756 0) 0 nil])
([nil nil ((90937 . 90940)) nil (26819 47276 411755 0) 0 nil])
([nil nil ((90940 . 90942)) nil (26819 47276 411755 0) 0 nil])
([nil nil ((90942 . 90946)) nil (26819 47276 411754 0) 0 nil])
([nil nil ((90946 . 90947)) nil (26819 47276 411754 0) 0 nil])
([nil nil ((90947 . 90952)) nil (26819 47276 411754 0) 0 nil])
([nil nil ((90947 . 90954) (#("paylo" 0 5 (fontified t)) . -90947) (undo-tree-id88 . -5) 90952) nil (26819 47276 411753 0) 0 nil])
([nil nil ((90954 . 90955)) nil (26819 47276 411751 0) 0 nil])
([nil nil ((91957 . 91965)) nil (26819 47276 411750 0) 0 nil])
([nil nil ((91965 . 91971)) nil (26819 47276 411750 0) 0 nil])
([nil nil ((91971 . 91972)) nil (26819 47276 411749 0) 0 nil])
([nil nil ((91972 . 91979)) nil (26819 47276 411749 0) 0 nil])
([nil nil ((91979 . 91987)) nil (26819 47276 411749 0) 0 nil])
([nil nil ((91987 . 91988)) nil (26819 47276 411748 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -91987) (undo-tree-id87 . -1) 91988) nil (26819 47276 411747 0) 0 nil])
([nil nil ((91987 . 91993)) nil (26819 47276 411738 0) 0 nil])
([nil nil ((91993 . 91994)) nil (26819 47276 411737 0) 0 nil])
([nil nil ((91994 . 91996)) nil (26819 47276 411736 0) 0 nil])
([nil nil ((91996 . 91998)) nil (26819 47276 411736 0) 0 nil])
([nil nil ((91998 . 92006)) nil (26819 47276 411736 0) 0 nil])
([nil nil ((92006 . 92012)) nil (26819 47276 411735 0) 0 nil])
([nil nil ((92012 . 92013)) nil (26819 47276 411735 0) 0 nil])
([nil nil ((92013 . 92018)) nil (26819 47276 411734 0) 0 nil])
([nil nil ((92018 . 92026)) nil (26819 47276 411734 0) 0 nil])
([nil nil ((92026 . 92032)) nil (26819 47276 411733 0) 0 nil])
([nil nil ((92032 . 92033)) nil (26819 47276 411732 0) 0 nil])
([nil nil ((92033 . 92036)) nil (26819 47276 411727 0) 0 nil])
([nil nil ((#("(defun auth-required ()
  (auth-jwt :required-p t))

(defun roles-allowed (roles)
  (auth-jwt :required-p t :roles-allow roles))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 36 (fontified t) 36 47 (face font-lock-builtin-face fontified t) 47 49 (fontified t) 49 52 (fontified t) 52 54 (fontified t) 54 59 (face font-lock-keyword-face fontified t) 59 60 (fontified t) 60 73 (face font-lock-function-name-face fontified t) 73 94 (fontified t) 94 105 (face font-lock-builtin-face fontified t) 105 108 (fontified t) 108 120 (face font-lock-builtin-face fontified t) 120 128 (fontified t)) . -92486) (undo-tree-id94 . -128) 92614 (t 26819 47276 0 0)) nil (26819 54738 374583 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 93596 . 93597) (nil fontified nil 92486 . 93597) (92486 . 93597)) nil (26819 54738 374568 0) 0 nil])
([nil nil ((86915 . 86916) (t 26819 54738 0 0)) nil (26819 54784 304605 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 92275 . 92276) (nil fontified nil 86916 . 92276) (86916 . 92276)) nil (26819 54784 304605 0) 0 nil])
([nil nil ((92276 . 92277)) nil (26819 54784 304604 0) 0 nil])
([nil nil ((92277 . 92279)) nil (26819 54784 304603 0) 0 nil])
([nil nil ((97849 . 97851)) nil (26819 54784 304599 0) 0 nil])
([nil nil ((6173 . 6175) (t 26819 54784 0 0)) nil (26821 5291 64867 0) 0 nil])
([nil nil ((6360 . 6361)) nil (26821 5291 64866 0) 0 nil])
([nil nil ((#("Ã©" 0 1 (face font-lock-string-face fontified t)) . -6360) (undo-tree-id95 . -1) 6361) nil (26821 5291 64865 0) 0 nil])
([nil nil ((6360 . 6361)) nil (26821 5291 64851 0) 0 nil])
([nil nil ((111866 . 111868) (t 26821 5291 0 0)) nil (26821 14732 286177 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 115173 . 115174) (nil fontified nil 111868 . 115174) (111868 . 115174)) nil (26821 14732 286177 0) 0 nil])
([nil nil ((#("uuid:make-v4-string" 0 19 (fontified t)) . -113821) (undo-tree-id99 . -19) 113840) nil (26821 14732 286176 0) 0 nil])
([nil nil ((113821 . 113836)) nil (26821 14732 286170 0) 0 nil])
([nil nil ((113821 . 113848) (#("lumen.utils:gen" 0 15 (fontified t)) . -113821) (undo-tree-id98 . -15) 113836) nil (26821 14732 286166 0) 0 nil])
([nil nil ((#("(ua   (cdr (assoc \"user-agent\" hdrs :test #'string=)))
             (ip   (or (cdr (assoc \"x-forwarded-for\" hdrs :test #'string=))
                       (ignore-errors (lumen.core.http:req-remote-addr req))))" 0 18 (fontified t) 18 30 (face font-lock-string-face fontified t) 30 36 (fontified t) 36 41 (face font-lock-builtin-face fontified t) 41 90 (fontified t) 90 107 (face font-lock-string-face fontified t) 107 113 (fontified t) 113 118 (face font-lock-builtin-face fontified t) 118 155 (fontified t) 155 168 (face font-lock-keyword-face fontified t) 168 209 (fontified t)) . -113937) (undo-tree-id97 . -209) 114146) nil (26821 14732 286163 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 113989 . 113990) (nil fontified nil 113937 . 113990) (113937 . 113990)) nil (26821 14732 286161 0) 0 nil])
([nil nil ((115027 . 115029)) nil (26821 14732 286161 0) 0 nil])
([nil nil ((116005 . 116007)) nil (26821 14732 286160 0) 0 nil])
([nil nil ((#(";; ---- Middleware request-context -------------------------------------------" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 78 (face font-lock-comment-face fontified t)) . 111788)) nil (26821 14732 286159 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -111787) (undo-tree-id96 . -1) 111788) nil (26821 14732 286158 0) 0 nil])
([nil nil ((113284 . 113285)) nil (26821 14732 286137 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 113362 . 113363) (nil fontified nil 113288 . 113363) (nil fontified nil 113285 . 113288) (113285 . 113363)) nil (26821 14732 286135 0) 0 nil])
([nil nil ((116007 . 116008)) nil (26821 14732 286130 0) 0 nil])
([nil nil ((6360 . 6361) (t 26821 14732 0 0)) nil (26821 15856 565848 0) 0 nil])
([nil nil ((87463 . 87465) (#("   " 0 3 (fontified nil)) . -87436) (87465 . 87466) (t 26821 15856 0 0)) nil (26822 27826 498088 0) 0 nil])
([nil nil ((87465 . 87471)) nil (26822 27826 498087 0) 0 nil])
([nil nil ((87471 . 87472)) nil (26822 27826 498086 0) 0 nil])
([nil nil ((87472 . 87473)) nil (26822 27826 498084 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -87472) (undo-tree-id26 . -1) 87473) nil (26822 27826 498083 0) 0 nil])
([nil nil ((87472 . 87474)) nil (26822 27826 498080 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -87472) (undo-tree-id24 . -1) (#("'" 0 1 (fontified t)) . -87473) (undo-tree-id25 . -1) 87474) nil (26822 27826 498079 0) 0 nil])
([nil nil ((87472 . 87480)) nil (26822 27826 498072 0) 0 nil])
([nil nil ((87480 . 87481)) nil (26822 27826 498071 0) 0 nil])
([nil nil ((87481 . 87483)) nil (26822 27826 498070 0) 0 nil])
([nil nil ((87483 . 87484)) nil (26822 27826 498070 0) 0 nil])
([nil nil ((87484 . 87488)) nil (26822 27826 498069 0) 0 nil])
([nil nil ((87488 . 87489)) nil (26822 27826 498068 0) 0 nil])
([nil nil ((87489 . 87491)) nil (26822 27826 498067 0) 0 nil])
([nil nil ((87491 . 87494)) nil (26822 27826 498065 0) 0 nil])
([nil nil ((91582 . 91583) (91527 . 91528) (91478 . 91479) (91389 . 91390) (91322 . 91323) (91274 . 91275) (" " . -90150) (#("   " 0 3 (fontified t)) . -87362) (#("   " 0 3 (fontified t)) . -87318) (#("   " 0 3 (fontified t)) . -87268) (#("   " 0 3 (fontified t)) . -87219) (#("   " 0 3 (fontified t)) . -87176) (#("   " 0 3 (fontified t)) . -87141) (#("   " 0 3 (fontified t)) . -87103) (#("   " 0 3 (fontified t)) . -87065) (#("   " 0 3 (fontified t)) . -87028) (#("   " 0 3 (fontified t)) . -86992) 86920) nil (26822 27826 498062 0) 0 nil])
([nil nil ((90196 . 90204) (#(" " 0 1 (fontified nil)) . 90195) (undo-tree-id23 . -1) (90196 . 90197)) nil (26822 27826 498057 0) 0 nil])
([nil nil ((90234 . 90237)) nil (26822 27826 498054 0) 0 nil])
([nil nil ((90237 . 90243)) nil (26822 27826 498053 0) 0 nil])
([nil nil ((90243 . 90244)) nil (26822 27826 498052 0) 0 nil])
([nil nil ((90244 . 90246)) nil (26822 27826 498051 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -90238) (undo-tree-id15 . -1) (#("r" 0 1 (fontified t)) . -90239) (undo-tree-id16 . -1) (#("i" 0 1 (fontified t)) . -90240) (undo-tree-id17 . -1) (#("n" 0 1 (fontified t)) . -90241) (undo-tree-id18 . -1) (#("t" 0 1 (fontified t)) . -90242) (undo-tree-id19 . -1) (#(" " 0 1 (fontified t)) . -90243) (undo-tree-id20 . -1) (#("p" 0 1 (fontified t)) . -90244) (undo-tree-id21 . -1) (#("a" 0 1 (fontified t)) . -90245) (undo-tree-id22 . -1) 90246) nil (26822 27826 498048 0) 0 nil])
([nil nil ((90238 . 90243)) nil (26822 27826 498035 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -90242) (undo-tree-id14 . -1) 90243) nil (26822 27826 498034 0) 0 nil])
([nil nil ((90242 . 90244)) nil (26822 27826 498031 0) 0 nil])
([nil nil ((90244 . 90245)) nil (26822 27826 498030 0) 0 nil])
([nil nil ((90245 . 90246)) nil (26822 27826 498029 0) 0 nil])
([nil nil ((90246 . 90247)) nil (26822 27826 498029 0) 0 nil])
([nil nil ((90247 . 90256)) nil (26822 27826 498027 0) 0 nil])
([nil nil ((90256 . 90257)) nil (26822 27826 498026 0) 0 nil])
([nil nil ((90257 . 90261)) nil (26822 27826 498025 0) 0 nil])
([nil nil ((#("M" 0 1 (face font-lock-string-face fontified t)) . -90260) (undo-tree-id13 . -1) 90261) nil (26822 27826 498024 0) 0 nil])
([nil nil ((90260 . 90262)) nil (26822 27826 498021 0) 0 nil])
([nil nil ((90262 . 90263)) nil (26822 27826 498020 0) 0 nil])
([nil nil ((90263 . 90267)) nil (26822 27826 498019 0) 0 nil])
([nil nil ((90267 . 90270)) nil (26822 27826 498018 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 90299 . 90300) (nil fontified nil 90295 . 90300) (nil fontified nil 90280 . 90295) (nil fontified nil 90270 . 90280) (90270 . 90300)) nil (26822 27826 498016 0) 0 nil])
([nil nil ((#("TOKEN" 0 5 (face font-lock-string-face fontified t)) . -90283) (undo-tree-id12 . -5) 90288) nil (26822 27826 498014 0) 0 nil])
([nil nil ((90283 . 90290)) nil (26822 27826 498012 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -90298) (undo-tree-id11 . -3) 90301) nil (26822 27826 498010 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 90304 . 90305) (nil fontified nil 90298 . 90305) (90298 . 90305)) nil (26822 27826 498007 0) 0 nil])
([nil nil ((90306 . 90309)) nil (26822 27826 498006 0) 0 nil])
([nil nil ((nil fontified nil 90344 . 90345) (nil fontified nil 90343 . 90344) (nil fontified nil 90337 . 90343) (nil fontified nil 90336 . 90337) (nil fontified nil 90319 . 90336) (nil fontified nil 90309 . 90319) (90309 . 90345)) nil (26822 27826 498004 0) 0 nil])
([nil nil ((#("PAYLOAD" 0 7 (face font-lock-string-face fontified t)) . -90322) (undo-tree-id10 . -7) 90329) nil (26822 27826 498002 0) 0 nil])
([nil nil ((90322 . 90324)) nil (26822 27826 497999 0) 0 nil])
([nil nil ((#("payload" 0 6 (fontified t) 6 7 (fontified t rear-nonsticky t)) . -90332) (undo-tree-id9 . -7) 90339) nil (26822 27826 497998 0) 0 nil])
([nil nil ((90332 . 90334)) nil (26822 27826 497995 0) 0 nil])
([nil nil ((91731 . 91739)) nil (26822 27826 497994 0) 0 nil])
([nil nil ((nil fontified nil 91836 . 91837) (nil fontified nil 91833 . 91836) (nil fontified nil 91821 . 91833) (nil fontified nil 91811 . 91821) (nil fontified nil 91809 . 91811) (nil fontified nil 91808 . 91809) (nil fontified nil 91807 . 91808) (nil fontified nil 91806 . 91807) (nil fontified nil 91800 . 91806) (nil fontified nil 91799 . 91800) (nil fontified nil 91782 . 91799) (nil fontified nil 91772 . 91782) (nil fontified nil 91770 . 91772) (nil fontified nil 91764 . 91770) (nil fontified nil 91749 . 91764) (nil fontified nil 91739 . 91749) (91739 . 91837)) nil (26822 27826 497992 0) 0 nil])
([nil nil ((#("TOKEN" 0 5 (face font-lock-string-face fontified t)) . -91752) (undo-tree-id8 . -5) 91757) nil (26822 27826 497987 0) 0 nil])
([nil nil ((91752 . 91755)) nil (26822 27826 497985 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -91763) (undo-tree-id7 . -3) 91766) nil (26822 27826 497984 0) 0 nil])
([nil nil ((91763 . 91766)) nil (26822 27826 497981 0) 0 nil])
([nil nil ((#("PAYLOAD" 0 7 (face font-lock-string-face fontified t)) . -91783) (undo-tree-id6 . -7) 91790) nil (26822 27826 497980 0) 0 nil])
([nil nil ((91783 . 91784)) nil (26822 27826 497975 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-string-face fontified t)) . -91783) (undo-tree-id5 . -1) 91784) nil (26822 27826 497974 0) 0 nil])
([nil nil ((91783 . 91785)) nil (26822 27826 497970 0) 0 nil])
([nil nil ((91785 . 91786)) nil (26822 27826 497969 0) 0 nil])
([nil nil ((91786 . 91791)) nil (26822 27826 497968 0) 0 nil])
([nil nil ((#("payload" 0 6 (fontified t) 6 7 (fontified t rear-nonsticky t)) . -91799) (undo-tree-id4 . -7) 91806) nil (26822 27826 497967 0) 0 nil])
([nil nil ((91799 . 91804)) nil (26822 27826 497964 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -91803) (undo-tree-id3 . -1) 91804) nil (26822 27826 497962 0) 0 nil])
([nil nil ((91803 . 91804)) nil (26822 27826 497958 0) 0 nil])
([nil nil ((91799 . 91807) (#("is-ad" 0 5 (fontified t)) . -91799) (undo-tree-id2 . -5) 91804) nil (26822 27826 497955 0) 0 nil])
([nil nil ((#("
		(format t \"~&OK: ~A~%\" ok)" 0 1 (fontified t) 1 3 (fontified t) 3 13 (fontified t) 13 25 (face font-lock-string-face fontified t) 25 28 (fontified t) 28 29 (fontified t rear-nonsticky t)) . 91808) (undo-tree-id0 . -29) (undo-tree-id1 . -29)) nil (26822 27826 497945 0) 0 nil])
([nil nil ((86694 . 86699) (t 26822 27826 0 0)) nil (26822 28062 428841 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86728 . 86729) (nil fontified nil 86724 . 86729) (nil fontified nil 86709 . 86724) (nil fontified nil 86702 . 86709) (nil fontified nil 86699 . 86702) (86699 . 86729)) nil (26822 28062 428840 0) 0 nil])
([nil nil ((#("TOKEN" 0 5 (face font-lock-string-face fontified t)) . -86712) (undo-tree-id41 . -5) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -5) (undo-tree-id48 . -5) (undo-tree-id49 . -5) (undo-tree-id50 . -5) 86717) nil (26822 28062 428837 0) 0 nil])
([nil nil ((86712 . 86714)) nil (26822 28062 428827 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -86722) (undo-tree-id27 . -3) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -3) (undo-tree-id34 . -3) (undo-tree-id35 . -3) (undo-tree-id36 . -3) (undo-tree-id37 . -3) (undo-tree-id38 . -3) (undo-tree-id39 . -3) (undo-tree-id40 . -3) 86725) nil (26822 28062 428824 0) 0 nil])
([nil nil ((86722 . 86724)) nil (26822 28062 428795 0) 0 nil])
([nil nil ((87114 . 87115) (t 26822 28062 0 0)) nil (26822 28185 171919 0) 0 nil])
([nil nil ((87115 . 87116)) nil (26822 28185 171918 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -87115) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) 87116) nil (26822 28185 171916 0) 0 nil])
([nil nil ((87115 . 87120)) nil (26822 28185 171913 0) 0 nil])
([nil nil ((#("q" 0 1 (fontified t)) . -87114) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (#("u" 0 1 (fontified t)) . -87115) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (#("e" 0 1 (fontified t)) . -87116) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (#("r" 0 1 (fontified t)) . -87117) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (#("y" 0 1 (fontified t)) . -87118) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (#("-" 0 1 (fontified t)) . -87119) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) 87120) nil (26822 28185 171908 0) 0 nil])
([nil nil ((#("params" 0 6 (fontified t)) . -86681) (undo-tree-id51 . -6) (undo-tree-id52 . -3) (undo-tree-id53 . -3) (undo-tree-id54 . -3) (undo-tree-id55 . -3) (undo-tree-id56 . -3) (undo-tree-id57 . -6) (undo-tree-id58 . -6) (undo-tree-id59 . -6) (undo-tree-id60 . -6) (undo-tree-id61 . -6) (undo-tree-id62 . -6) (undo-tree-id63 . -6) (undo-tree-id64 . -6) 86687) nil (26822 28185 171841 0) 0 nil])
([nil nil ((86681 . 86686)) nil (26822 28185 171809 0) 0 nil])
([nil nil ((91844 . 91851) (#("	" 0 1 (fontified nil)) . -91805) (91805 . 91806) (#("	" 0 1 (fontified nil)) . 91805) (91799 . 91805) (91838 . 91839) (t 26822 28185 0 0)) nil (26822 30879 257895 0) 0 nil])
([nil nil ((91851 . 91852)) nil (26822 30879 257894 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -91851) (undo-tree-id136 . -1) 91852) nil (26822 30879 257893 0) 0 nil])
([nil nil ((nil fontified nil 91888 . 91889) (nil fontified nil 91880 . 91888) (nil fontified nil 91879 . 91880) (nil fontified nil 91861 . 91879) (nil fontified nil 91851 . 91861) (91851 . 91889)) nil (26822 30879 257891 0) 0 nil])
([nil nil ((#("ADMIN" 0 5 (face font-lock-string-face fontified t)) . -91867) (undo-tree-id135 . -5) 91872) nil (26822 30879 257889 0) 0 nil])
([nil nil ((91867 . 91875)) nil (26822 30879 257887 0) 0 nil])
([nil nil ((91875 . 91876)) nil (26822 30879 257887 0) 0 nil])
([nil nil ((91876 . 91877)) nil (26822 30879 257886 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-string-face fontified t)) . 91877)) nil (26822 30879 257886 0) 0 nil])
([nil nil ((#("is-admin" 0 8 (fontified t)) . -91884) (undo-tree-id134 . -8) 91892) nil (26822 30879 257884 0) 0 nil])
([nil nil ((91884 . 91889)) nil (26822 30879 257874 0) 0 nil])
([nil nil ((91889 . 91893)) nil (26822 30879 257873 0) 0 nil])
([nil nil ((91892 . 91893)) nil (26822 30879 257869 0) 0 nil])
([nil nil ((#("
						 " 0 1 (fontified t) 1 8 (fontified t)) . -90225) (undo-tree-id138 . -8) 90233 (t 26822 30879 0 0)) nil (26822 35524 462092 0) 0 nil])
([nil nil ((90236 . 90244) (#(" " 0 1 (fontified nil)) . 90235) (undo-tree-id137 . -1) (90236 . 90237)) nil (26822 35524 462089 0) 0 nil])
([nil nil ((90262 . 90263)) nil (26822 35524 462080 0) 0 nil])
([nil nil ((90263 . 90269)) nil (26822 35524 462080 0) 0 nil])
([nil nil ((90269 . 90270)) nil (26822 35524 462079 0) 0 nil])
([nil nil ((90270 . 90271)) nil (26822 35524 462074 0) 0 nil])
([nil nil ((90276 . 90278) (t 26822 35524 0 0)) nil (26822 35920 303659 0) 0 nil])
([nil nil ((90311 . 90313)) nil (26822 35920 303658 0) 0 nil])
([nil nil ((90352 . 90354)) nil (26822 35920 303656 0) 0 nil])
([nil nil ((91784 . 91786)) nil (26822 35920 303656 0) 0 nil])
([nil nil ((91822 . 91824)) nil (26822 35920 303654 0) 0 nil])
([nil nil ((91870 . 91872)) nil (26822 35920 303650 0) 0 nil])
([nil nil ((#("
    (format t \"~&QP: ~A~%\" qp)" 0 1 (fontified t) 1 5 (fontified t) 5 8 (fontified t) 8 15 (fontified t) 15 27 (face font-lock-string-face fontified t) 27 30 (fontified t) 30 31 (fontified t rear-nonsticky t)) . 86693) (undo-tree-id139 . -31) (undo-tree-id140 . -28) (undo-tree-id141 . -14) (undo-tree-id142 . -14) (undo-tree-id143 . -14) (undo-tree-id144 . -14) (undo-tree-id145 . -14) (undo-tree-id146 . -14) (undo-tree-id147 . -14) (undo-tree-id148 . -31) (undo-tree-id149 . -31) (undo-tree-id150 . -31) (undo-tree-id151 . -31) (t 26822 35920 0 0)) nil (26822 36283 781368 0) 0 nil])
([nil nil ((18570 . 18571) (t 26822 36283 0 0)) nil (26822 39036 637653 0) 0 nil])
([nil nil ((18571 . 18572)) nil (26822 39036 637652 0) 0 nil])
([nil nil ((#("|" 0 1 (fontified t)) . -18571) (undo-tree-id156 . -1) 18572) nil (26822 39036 637651 0) 0 nil])
([nil nil ((18571 . 18573)) nil (26822 39036 637650 0) 0 nil])
([nil nil ((19100 . 19102)) nil (26822 39036 637649 0) 0 nil])
([nil nil ((#("\\" 0 1 (face font-lock-comment-face fontified t)) . -19100) (undo-tree-id154 . -1) (#("#" 0 1 (face font-lock-comment-face fontified t)) . -19101) (undo-tree-id155 . -1) 19102) nil (26822 39036 637648 0) 0 nil])
([nil nil ((19100 . 19102)) nil (26822 39036 637645 0) 0 nil])
([nil nil ((19102 . 19103)) nil (26822 39036 637644 0) 0 nil])
([nil nil ((333 . 336)) nil (26822 39036 637643 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 437 . 438) (nil fontified nil 437 . 438) (nil fontified nil 420 . 437) (nil fontified nil 417 . 420) (nil fontified nil 401 . 417) (nil fontified nil 400 . 401) (nil fontified nil 386 . 400) (nil fontified nil 385 . 386) (nil fontified nil 372 . 385) (nil fontified nil 371 . 372) (nil fontified nil 367 . 371) (nil fontified nil 366 . 367) (nil fontified nil 363 . 366) (nil fontified nil 362 . 363) (nil fontified nil 350 . 362) (nil fontified nil 349 . 350) (nil fontified nil 337 . 349) (nil fontified nil 336 . 337) (336 . 438)) nil (26822 39036 637642 0) 0 nil])
([nil nil ((#(":lumen.utils" 0 12 (face font-lock-builtin-face fontified t)) . -350) (undo-tree-id153 . -12) 362) nil (26822 39036 637639 0) 0 nil])
([nil nil ((350 . 351)) nil (26822 39036 637637 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 365 . 366) (nil fontified nil 351 . 366) (351 . 366)) nil (26822 39036 637636 0) 0 nil])
([nil nil ((#(":-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date" 0 3 (face font-lock-builtin-face fontified t) 3 4 (fontified t) 4 8 (face font-lock-builtin-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-builtin-face fontified t) 22 23 (fontified t) 23 37 (face font-lock-builtin-face fontified t) 37 38 (fontified t) 38 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 57 (fontified t) 57 74 (face font-lock-builtin-face fontified t)) . -367) (undo-tree-id152 . -74) 441) nil (26822 39036 637634 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 385 . 386) (nil fontified nil 367 . 386) (367 . 386)) nil (26822 39036 637622 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 43178 . 43179) (nil fontified nil 43164 . 43179) (43164 . 43179)) nil (26822 39036 637621 0) 0 nil])
([nil nil ((43179 . 43180)) nil (26822 39036 637620 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 44301 . 44302) (nil fontified nil 44287 . 44302) (44287 . 44302)) nil (26822 39036 637620 0) 0 nil])
([nil nil ((44302 . 44303)) nil (26822 39036 637619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 48070 . 48071) (nil fontified nil 48056 . 48071) (48056 . 48071)) nil (26822 39036 637618 0) 0 nil])
([nil nil ((48071 . 48072)) nil (26822 39036 637617 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 51554 . 51555) (nil fontified nil 51540 . 51555) (51540 . 51555)) nil (26822 39036 637615 0) 0 nil])
([nil nil ((51555 . 51556)) nil (26822 39036 637610 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -1481) (undo-tree-id157 . -1) 1482 (t 26822 39036 0 0)) nil (26822 40105 161146 0) 0 nil])
([nil nil ((1481 . 1482)) nil (26822 40105 161133 0) 0 nil])
([nil nil ((#("(defun path-matches? (path paths prefixes)
  (or (and paths (member path paths :test #'string=))
      (and prefixes (some (lambda (pfx)
                            (and (<= (length pfx) (length path))
                                 (string= pfx path :end2 (length pfx))))
                          prefixes))))

(defun json-only (&key paths prefixes)
  \"Middleware factory. Force Content-Type JSON pour les routes listÃ©es.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (path (lumen.core.http:req-path req)))
        (when (path-matches? path paths prefixes)
          (setf (lumen.core.http:resp-headers resp)
                (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                               \"content-type\"
                               \"application/json; charset=utf-8\")))
        resp))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 79 (fontified t) 79 84 (face font-lock-builtin-face fontified t) 84 124 (fontified t) 124 130 (face font-lock-keyword-face fontified t) 130 253 (fontified t) 253 258 (face font-lock-builtin-face fontified t) 258 315 (fontified t) 315 316 (fontified t) 316 321 (face font-lock-keyword-face fontified t) 321 322 (fontified t) 322 331 (face font-lock-function-name-face fontified t) 331 333 (fontified t) 333 337 (face font-lock-type-face fontified t) 337 356 (fontified t) 356 426 (face font-lock-doc-face fontified t) 426 430 (fontified t) 430 436 (face font-lock-keyword-face fontified t) 436 449 (fontified t) 449 455 (face font-lock-keyword-face fontified t) 455 469 (fontified t) 469 473 (face font-lock-keyword-face fontified t) 473 562 (fontified t) 562 566 (face font-lock-keyword-face fontified t) 566 765 (fontified t) 765 779 (face font-lock-string-face fontified t) 779 811 (fontified t) 811 828 (face font-lock-string-face fontified t) 828 844 (face font-lock-string-face fontified t) 844 864 (fontified t)) . -8113) (undo-tree-id1 . -864) (undo-tree-id2 . -864) (undo-tree-id3 . -864) 8977 (t 26822 40105 0 0)) nil (26822 45479 180243 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10744 . 10745) (nil fontified nil 8113 . 10745) (8113 . 10745)) nil (26822 45479 180240 0) 0 nil])
([nil nil ((979 . 980)) nil (26822 45479 180238 0) 0 nil])
([nil nil ((#("b" 0 1 (face font-lock-builtin-face fontified t)) . -979) (undo-tree-id0 . -1) 980) nil (26822 45479 180236 0) 0 nil])
([nil nil ((60793 . 60799) (#(" " 0 1 (fontified nil)) . 60792) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (60793 . 60794) (t 26822 45479 0 0)) nil (26822 60851 373866 0) 0 nil])
([nil nil ((60847 . 60851)) nil (26822 60851 373845 0) 0 nil])
([nil nil ((60851 . 60857)) nil (26822 60851 373845 0) 0 nil])
([nil nil ((60857 . 60858)) nil (26822 60851 373844 0) 0 nil])
([nil nil ((60858 . 60866)) nil (26822 60851 373843 0) 0 nil])
([nil nil ((60866 . 60870)) nil (26822 60851 373842 0) 0 nil])
([nil nil ((60870 . 60876)) nil (26822 60851 373842 0) 0 nil])
([nil nil ((60876 . 60877)) nil (26822 60851 373841 0) 0 nil])
([nil nil ((60877 . 60881)) nil (26822 60851 373837 0) 0 nil])
([nil nil ((60851 . 60853) (t 26822 60851 0 0)) nil (26822 63465 557388 0) 0 nil])
([nil nil ((60872 . 60874)) nil (26822 63465 557384 0) 0 nil])
([nil nil ((115879 . 115886) (t 26822 63465 0 0)) nil (26949 35765 979949 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 115914 . 115915) (nil fontified nil 115914 . 115915) (nil fontified nil 115893 . 115914) (nil fontified nil 115886 . 115893) (115886 . 115915)) nil (26949 35765 979948 0) 0 nil])
([nil nil ((#("TENANT FROM HOST" 0 16 (face font-lock-string-face fontified t)) . -115897) (undo-tree-id0 . -16) (undo-tree-id1 . -16) (undo-tree-id2 . -16) 115913) nil (26949 35765 979946 0) 0 nil])
([nil nil ((115897 . 115912)) nil (26949 35765 979928 0) 0 nil])
([nil nil ((116816 . 116818) (t 26949 35765 0 0)) nil (26949 35967 694806 0) 0 nil])
([nil nil ((116818 . 116819)) nil (26949 35967 694805 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -116818) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 116819) nil (26949 35967 694803 0) 0 nil])
([nil nil ((116818 . 116824)) nil (26949 35967 694786 0) 0 nil])
([nil nil ((116824 . 116825)) nil (26949 35967 694785 0) 0 nil])
([nil nil ((116825 . 116829)) nil (26949 35967 694780 0) 0 nil])
([nil nil ((116818 . 116820) (t 26949 35967 0 0)) nil (26949 36197 240766 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -116818) (undo-tree-id8 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -116819) (undo-tree-id9 . -1) 116820) nil (26949 36197 240764 0) 0 nil])
([nil nil ((116829 . 116831)) nil (26949 36197 240755 0) 0 nil])
([nil nil ((116831 . 116837)) nil (26949 36197 240754 0) 0 nil])
([nil nil ((116837 . 116838)) nil (26949 36197 240753 0) 0 nil])
([nil nil ((116838 . 116843)) nil (26949 36197 240749 0) 0 nil])
([nil nil ((#("
	(print jwt)
	(print \"OK\")" 0 1 (fontified t) 1 2 (fontified t) 2 14 (fontified t) 14 22 (fontified t) 22 26 (face font-lock-string-face fontified t) 26 27 (fontified t)) . 116816) (undo-tree-id10 . -27) (undo-tree-id11 . -13) (undo-tree-id12 . -13) (undo-tree-id13 . -27) (undo-tree-id14 . -13) (undo-tree-id15 . -27) (t 26949 36197 0 0)) nil (26949 36306 72313 0) 0 nil])
([nil nil ((#("
#|
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)        ; '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any)        ; :any (OR) | :all (AND)
                      (leeway-sec 60)
                      ;; NOUVEAU :
                      (allow-query-token-p t)   ; autoriser ?access=... (utile pour SSE)
                      (qs-keys '(\"access\" \"token\")))
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx et applique des gardes optionnelles.
Sources de token supportÃ©es (par ordre de prioritÃ©) :
  1) Authorization: Bearer <jwt>
  2) Query-string: ?access=... (ou :qs-keys)
  3) Cookie: access_token
 - SECRET         : clÃ© HMAC (dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)
 - LEEWAY-SEC     : tolÃ©rance de clock skew sur exp/iat.\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (normalize-scopes (v)
               ;; tolÃ¨re list/vector/string/json/csv
               (handler-case
                   (let* ((lst (cond
                                 ((null v) '())
                                 ((listp v) v)
                                 ((vectorp v) (loop for x across v collect x))
                                 ((stringp v)
                                  (let* ((s (string-trim \" \" v)))
                                    (cond
                                      ((and (> (length s) 1)
                                            (char= (char s 0) #\\[)
                                            (char= (char s (1- (length s))) #\\]))
                                       ;; JSON-ish trÃ¨s tolÃ©rant
                                       (let* ((inner (subseq s 1 (1- (length s))))
                                              (parts (cl-ppcre:split \"\\\\s*,\\\\s*\" inner)))
                                         (mapcar (lambda (x)
                                                   (let ((y (string-trim \" \\\"\" x))) y))
                                                 parts)))
                                      ((search \",\" s)
                                       (cl-ppcre:split \"\\\\s*,\\\\s*\" s))
                                      (t (list s)))))
                                 (t (list (princ-to-string v))))))
                     (remove-duplicates
                      (remove-if (lambda (s) (or (null s) (string= s \"\")))
                                 (mapcar (lambda (s)
                                           (substitute #\\: #\\. (string s))) ; courriers.read â†’ courriers:read
                                         lst))
                      :test #'string=))
                 (error () '())))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (or (%bearer-token-from hdrs)
                           (and allow-query-token-p (%query-token-from req :keys qs-keys))
                           (%cookie req \"access_token\"))))
	    (format t \"~&TOKEN: ~A~%\" tok)
            ;; DÃ©codage
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                   (lumen.core.jwt:jwt-decode
		    tok :secret secret :verify t :leeway leeway-sec))
		(print ok)
		(print payload)
                (when ok
                  ;; Pose le JWT et alias utiles
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (or (%alist-get-ci payload :tenant)
                                     (%alist-get-ci payload \"tenant\")))
                         (tenant-id (or (%alist-get-ci payload :tenant-id)
                                        (%alist-get-ci payload \"tenant_id\")
                                        tenant)))
                    (when tenant-id
                      (lumen.core.http:ctx-set! req :tenant-id tenant-id))
                    (when tenant
                      (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                   (role (and jwt (or (%alist-get-ci jwt :role)
                                      (%alist-get-ci jwt \"role\"))))
                   (sc   (normalize-scopes (and jwt (%alist-get-ci jwt :scopes)))))
	      (print \"XVEV\")
	      (print jwt)
	      (print role)
	      (print sc)
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
                 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scopes? scopes-allow sc)))
                 (fail 403 \"insufficient_scope\"))
                (t
                 (funcall next req))))))))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 737 (face font-lock-comment-face fontified t) 737 754 (face font-lock-comment-face fontified t) 754 2254 (face font-lock-comment-face fontified t) 2254 2318 (face font-lock-comment-face fontified t) 2318 3818 (face font-lock-comment-face fontified t) 3818 3830 (face font-lock-comment-face fontified t) 3830 5330 (face font-lock-comment-face fontified t) 5330 5355 (face font-lock-comment-face fontified t) 5355 5573 (face font-lock-comment-face fontified t) 5573 5575 (face font-lock-comment-delimiter-face fontified t)) . -94483) (undo-tree-id5 . -5575) (undo-tree-id6 . -4522) 100058 (t 26949 36306 0 0)) nil (26961 9456 789066 0) 0 nil])
([nil nil ((#(";;; JWT (HS256)
#|
Les scopes sont des permissions fines, embarquÃ©es dans le JWT.
Un rÃ´le, câ€™est â€œqui je suisâ€ (ex. admin, user).
Un scope, câ€™est â€œce que je peux faireâ€ (ex. read:users, write:payments).
|#
#|
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)   ; ex: '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any))  ; :any (OR) ou :all (AND)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx, applique garde optionnelle.
Options:
 - SECRET         : clÃ© HMAC (defaut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (let* ((hdrs (lumen.core.http:req-headers req))
               (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
               (tok  (and raw (>= (length raw) 7)
                          (string= (subseq raw 0 7) \"Bearer \")
                          (subseq raw 7))))
	  (format t \"Raw: ~A~%\" raw)
	  (format t \"Token: ~A~%\" tok)
          ;; dÃ©codage
          (when tok
            (multiple-value-bind (payload ok)
                (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
	      (format t \"Payload: ~A~%OK: ~A~%\" payload ok)
              (when ok (lumen.core.http:ctx-set! req :jwt payload))))
          ;; vÃ©rifs
          (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                 (role (and jwt (or (cdr (assoc :role jwt))
                                    (cdr (assoc \"role\" jwt)))))
                 (sc   (and jwt (or (cdr (assoc :scopes jwt))
                                    (cdr (assoc \"scopes\" jwt))))))
            (labels ((fail (status msg)
                       (lumen.core.http:respond-json
                        `((:error . ((:type . \"auth\") (:message . ,msg))))
                        :status status))
                     (has-scope? ()
                       (cond
                         ((null scopes-allow) t) ; pas dâ€™exigence
                         ((eq scopes-mode :all)
                          (every (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow))
                         (t ; :any
                          (some  (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow)))))
              (cond
                ((and required-p (null jwt)) (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
		 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scope?))) (fail 403 \"insufficient_scope\"))
                (t (funcall next req))))))))))
|#
" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 16 (face font-lock-comment-face fontified t) 16 18 (face font-lock-comment-delimiter-face fontified t) 18 26 (face font-lock-comment-face fontified t) 26 203 (face font-lock-comment-face fontified t) 203 205 (face font-lock-comment-delimiter-face fontified t) 205 206 (fontified t) 206 208 (face font-lock-comment-delimiter-face fontified t) 208 1526 (face font-lock-comment-face fontified t) 1526 1533 (face font-lock-comment-face fontified t) 1533 1860 (face font-lock-comment-face fontified t) 1860 2933 (face font-lock-comment-face fontified t) 2933 2935 (face font-lock-comment-delimiter-face fontified t) 2935 2936 (fontified t)) . -84310) (undo-tree-id3 . -2936) (undo-tree-id4 . -1806) 87246) nil (26961 9456 789063 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -84309) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 84310) nil (26961 9456 789057 0) 0 nil])
([nil nil ((#("#|
(define-middleware request-context (req next)
  \"Renseigne ctx avec :ip, :ua, (Ã©ventuel :tenant-id dÃ©jÃ  posÃ© en amont)
   et garantit :request-id (+ header X-Request-ID). Idempotent.\"
  (let* ((rid (or (lumen.core.http:ctx-get req :request-id)
                  (%header req \"x-request-id\")
                  (make-request-id)))
         (ip  (%peer-ip req))
         (ua  (%user-agent req)))
    (lumen.core.http:ctx-set! req :request-id rid)
    (lumen.core.http:ctx-set! req :ip         ip)
    (lumen.core.http:ctx-set! req :ua         ua)
    ;; (optionnel) si tenant-from-host ne lâ€™a pas fait, on peut tenter un fallback ici
    ;; mais on considÃ¨re tenant-from-host dÃ©jÃ  en place.
    (let ((resp (funcall next req)))
      ;; Propage X-Request-ID cÃ´tÃ© rÃ©ponse si absent
      (setf (lumen.core.http:resp-headers resp)
            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                       \"x-request-id\" rid))
      resp)))
|#
" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 24 (face font-lock-comment-face fontified t) 24 49 (face font-lock-comment-face fontified t) 49 149 (face font-lock-comment-face fontified t) 149 187 (face font-lock-comment-face fontified t) 187 978 (face font-lock-comment-face fontified t) 978 980 (face font-lock-comment-delimiter-face fontified t) 980 981 (fontified t)) . -108754) (undo-tree-id0 . -981) 109735) nil (26961 9456 789051 0) 0 nil])
([nil nil ((7832 . 7834) (t 26961 9456 0 0)) nil (26984 7636 449181 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9049 . 9050) (nil fontified nil 7834 . 9050) (7834 . 9050)) nil (26984 7636 449177 0) 0 nil])
([nil nil ((#("
(defun parse-query-string-to-alist (qs)
  \"Transforme \\\"a=1&b=2&b=3\\\" -> ((\\\"a\\\" . \\\"1\\\") (\\\"b\\\" . \\\"2\\\") (\\\"b\\\" . \\\"3\\\")).\"
  (if (or (null qs) (zerop (length qs)))
      nil
      (loop for pair in (uiop:split-string qs :separator \"&\")
            for p = (position #\\= pair)
            for k = (%url-decode (subseq pair 0 (or p (length pair))))
            for v = (%url-decode (if p (subseq pair (1+ p)) \"\"))
            collect (cons k v))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 35 (face font-lock-function-name-face fontified t) 35 43 (fontified t) 43 125 (face font-lock-doc-face fontified t) 125 129 (fontified t) 129 131 (face font-lock-keyword-face fontified t) 131 184 (fontified t) 184 188 (face font-lock-keyword-face fontified t) 188 223 (fontified t) 223 233 (face font-lock-builtin-face fontified t) 233 234 (fontified t) 234 237 (face font-lock-string-face fontified t) 237 384 (fontified t) 384 386 (face font-lock-keyword-face fontified t) 386 410 (fontified t) 410 412 (face font-lock-string-face fontified t) 412 415 (fontified t) 415 448 (fontified t)) . 7384) (undo-tree-id0 . -448) (undo-tree-id1 . -448) (undo-tree-id2 . -1) (undo-tree-id3 . -448) (undo-tree-id4 . -448) (t 26984 7636 0 0)) nil (26984 8168 25029 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 7384)) nil (26995 19248 176110 0) 0 nil])
([nil nil ((#("*" 0 1 (face font-lock-variable-name-face fontified t)) . -1535) (undo-tree-id19 . -1) (undo-tree-id20 . -1) 1536 (t 26993 53276 0 0)) nil (26995 19495 241036 0) 0 nil] [nil nil ((228 . 231) (t 26993 53276 0 0)) ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . 228) (undo-tree-id1 . -3) (undo-tree-id2 . -3) (undo-tree-id3 . -3) (undo-tree-id4 . -1) (undo-tree-id5 . -1)) (26995 19247 790402 0) 0 nil])
([nil nil ((#("*" 0 1 (face font-lock-variable-name-face fontified t)) . 1540)) nil (26995 19495 241034 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 281 . 282) (nil fontified nil 281 . 282) (nil fontified nil 268 . 281) (nil fontified nil 267 . 268) (nil fontified nil 245 . 267) (nil fontified nil 244 . 245) (nil fontified nil 232 . 244) (nil fontified nil 231 . 232) (231 . 282)) ((#("(:import-from :lumen.core.http-range :respond-file)" 0 1 (fontified nil) 1 13 (face font-lock-builtin-face fontified nil) 13 14 (fontified nil) 14 36 (face font-lock-builtin-face fontified nil) 36 37 (fontified nil) 37 50 (face font-lock-builtin-face fontified nil) 50 51 (rear-nonsticky nil fontified nil)) . 231) (undo-tree-id0 . -51) (nil rear-nonsticky t 281 . 282)) (26995 19247 790317 0) 0 nil])
([nil nil ((1540 . 1542)) nil (26995 19495 241034 0) 0 nil])
nil
([nil nil ((1542 . 1543)) nil (26995 19495 241033 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1584 . 1585) (nil fontified nil 1584 . 1585) (nil fontified nil 1570 . 1584) (nil fontified nil 1543 . 1570) (1543 . 1585)) nil (26995 19495 241032 0) 0 nil])
([nil nil ((#("DATABASE_URL" 0 12 (face font-lock-string-face fontified t)) . -1571) (undo-tree-id18 . -12) 1583) nil (26995 19495 241031 0) 0 nil])
([nil nil ((1571 . 1572)) nil (26995 19495 241030 0) 0 nil])
([nil nil ((1572 . 1575)) nil (26995 19495 241030 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-string-face fontified t)) . -1571) (undo-tree-id14 . -1) (#("B" 0 1 (face font-lock-string-face fontified t)) . -1572) (undo-tree-id15 . -1) (#("U" 0 1 (face font-lock-string-face fontified t)) . -1573) (undo-tree-id16 . -1) (#("G" 0 1 (face font-lock-string-face fontified t)) . -1574) (undo-tree-id17 . -1) 1575) nil (26995 19495 241029 0) 0 nil])
([nil nil ((1571 . 1581)) nil (26995 19495 241026 0) 0 nil])
([nil nil ((#("n" 0 1 (fontified t)) . -1584) (undo-tree-id13 . -1) 1585) nil (26995 19495 241025 0) 0 nil])
([nil nil ((#("l" 0 1 (fontified t)) . 1584) (#("i" 0 1 (fontified t)) . 1584)) nil (26995 19495 241024 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -1583) (undo-tree-id12 . -1) 1584) nil (26995 19495 241023 0) 0 nil])
([nil nil ((1611 . 1612)) nil (26995 19495 241022 0) 0 nil])
([nil nil ((1612 . 1613)) nil (26995 19495 241022 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -1611) (undo-tree-id10 . -1) (#(":" 0 1 (face font-lock-comment-face fontified t)) . -1612) (undo-tree-id11 . -1) 1613) nil (26995 19495 241021 0) 0 nil])
([nil nil ((1582 . 1583)) nil (26995 19495 241019 0) 0 nil])
([nil nil ((1583 . 1591)) nil (26995 19495 241018 0) 0 nil])
([nil nil ((1591 . 1592)) nil (26995 19495 241018 0) 0 nil])
([nil nil ((1592 . 1595)) nil (26995 19495 241017 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . -58534) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) 58535) nil (26995 19495 241016 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . -58539) (undo-tree-id6 . -1) 58540) nil (26995 19495 241009 0) 0 nil])
([nil nil ((58539 . 58541)) nil (26995 19495 240985 0) 0 nil])
([nil nil ((#(":*debug*" 0 8 (face font-lock-builtin-face fontified t)) . -957) (undo-tree-id7 . -8) 965 (t 26995 19495 0 0)) nil (26995 43499 659477 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -956) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 957) nil (26995 43499 659473 0) 0 nil])
([nil nil ((#("#|
(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
		 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR.

Options:
- AUTO-INDEX      : T â†’ gÃ©nÃ¨re un listing HTML si pas d'index.
- TRY-INDEX       : nom d'index Ã  servir (string) ou NIL pour dÃ©sactiver.
- REDIRECT-DIR    : T â†’ redirige /chemin â†’ /chemin/ (301) pour les dossiers.
- HIDE-DOTFILES   : T â†’ masque fichiers/dirs commenÃ§ant par '.' dans le listing.
- FILE-CACHE-SECS : Â« Cache-Control Â» pour fichiers (par dÃ©faut 3600).
- DIR-CACHE-SECS  : Â« Cache-Control Â» pour index/dir (par dÃ©faut 300).
- SPA-FALLBACK : string (ex. \\\"index.html\\\") servi quand *aucun fichier*
  ne correspond sous PREFIX, pour GET/HEAD uniquement (idÃ©al pour SPA).

NB: Le corps est envoyÃ© en octets (vecteur (unsigned-byte 8)).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (lumen.utils:str-prefix-p prefix* path)	      
              (let* ((rel    (subseq path plen)) ; peut Ãªtre \"\" ou \"foo/bar\"
                     (target (safe-join root* rel))
                     (dir-truename (ignore-errors (lumen.utils:probe-directory
						   target)))
		     (ut (file-write-date pathname)))
                (handler-case
                    (cond
                      ;; -------- Dossier ----------
                      (dir-truename
                       (let* ((has-slash (and (> (length path) 0)
                                              (char= (char path (1- (length path))) #\\/)))
                              (dir* (uiop:ensure-directory-pathname dir-truename)))
                         (cond
                           ;; /dir â†’ /dir/
                           ((and redirect-dir (not has-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                          (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                           :body \"\"))
                           ;; index.html si prÃ©sent
                           ((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn (merge-pathnames try-index dir*))
                                   (bytes (read-file-bytes pn)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" (guess-content-type pn))
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body bytes)))
                           ;; listing auto
                           (auto-index
                            (let* ((html (directory-index-html dir* (if (plusp (length path)) path \"/\")
                                                               :hide-dotfiles hide-dotfiles)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body html)))
                           (t
			    ;; pas d'index ni listing â†’ fallback SPA si demandÃ©, sinon 404
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn (merge-pathnames spa-fallback root*))
                                       (bytes (read-file-bytes pn)))
                                  (make-instance 'lumen.core.http:response
                                                 :status 200
                                                 :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                                (cons \"cache-control\" \"no-store\"))
                                                 :body bytes))
                                (lumen.core.http:respond-404 \"Directory index disabled\"))))))
                      ;; -------- Fichier ----------
                      ((probe-file target)
		       (let* ((bytes (read-file-bytes target)))
                         (make-instance 'lumen.core.http:response
                                        :status 200
                                        :headers (list (cons \"content-type\" (guess-content-type target))
						       (cons \"cache-control\" (format nil \"public, max-age=~D\" file-cache-secs)))
                                        :body bytes)))
                      ;; -------- Rien pour ce prefix â†’ passe au suivant ----------
                      (t
		       (if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn (merge-pathnames spa-fallback root*))
                                  (bytes (read-file-bytes pn)))
                             (make-instance 'lumen.core.http:response
                                            :status 200
                                            :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                           (cons \"cache-control\" \"no-store\"))
                                            :body bytes))
                           (funcall next req))))
                  (error ()
		    (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passe au suivant
(funcall next req)))))))
|#
#|
(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
                 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR (optimisÃ© streaming/Range).

Options:
- AUTO-INDEX      : T â†’ gÃ©nÃ¨re un listing HTML si pas d'index.
- TRY-INDEX       : nom d'index Ã  servir (string) ou NIL pour dÃ©sactiver.
- REDIRECT-DIR    : T â†’ redirige /chemin â†’ /chemin/ (301) pour les dossiers.
- HIDE-DOTFILES   : T â†’ masque fichiers/dirs commenÃ§ant par '.' dans le listing.
- FILE-CACHE-SECS : Â« Cache-Control Â» pour fichiers (par dÃ©faut 3600).
- DIR-CACHE-SECS  : Â« Cache-Control Â» pour index/dir (par dÃ©faut 300).
- SPA-FALLBACK    : string (ex. \\\"index.html\\\") servi quand *aucun fichier*
  ne correspond sous PREFIX, pour GET/HEAD uniquement (idÃ©al pour SPA).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (and (>= (length path) plen)
                   (string= prefix* path :end2 plen)) ; Ã©vite dÃ©pendre dâ€™un util ici
              (let* ((rel    (subseq path plen))         ; \"\" ou \"foo/bar\"
                     (target (safe-join root* rel))
                     (dir-truename (ignore-errors (lumen.utils:probe-directory target))))
                (handler-case
                    (cond
                      ;; -------- Dossier ----------
                      (dir-truename
                       (let* ((has-slash (and (> (length path) 0)
                                              (char= (char path (1- (length path))) #\\/)))
                              (dir* (uiop:ensure-directory-pathname dir-truename)))
                         (cond
                           ;; /dir â†’ /dir/ (301)
                           ((and redirect-dir (not has-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                          (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                           :body \"\"))
                           ;; index.html si prÃ©sent â†’ respond-file (streaming + Range)
                           ((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn   (merge-pathnames try-index dir*))
                                   (ct   (guess-content-type pn))
                                   (lm   (%file-rfc1123 pn))
                                   (etag (%weak-etag-from-file pn))
                                   (resp (lumen.core.http-range:respond-file
                                          req pn
                                          :content-type ct
                                          :last-modified-rfc1123 lm
                                          :etag etag)))
                              (setf (lumen.core.http:resp-headers resp)
                                    (lumen.utils:ensure-header
				     (lumen.core.http:resp-headers resp)
                                     \"cache-control\"
                                     (format nil \"public, max-age=~D\" dir-cache-secs)))
                              resp))
                           ;; listing auto (gÃ©nÃ¨re HTML en mÃ©moire)
                           (auto-index
                            (let* ((html (directory-index-html
					  dir* (if (plusp (length path)) path \"/\")
                                          :hide-dotfiles hide-dotfiles))
                                   (lm   (%file-rfc1123 dir*))
                                   (hdrs (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                               (cons \"cache-control\"
						     (format nil \"public, max-age=~D\"
							     dir-cache-secs)))))
                              (when lm
                                (setf hdrs (lumen.utils:ensure-header
                                            hdrs \"last-modified\" lm)))
                              (make-instance 'lumen.core.http:response
                                             :status 200 :headers hdrs :body html)))
                           ;; pas d'index ni listing â†’ SPA fallback si demandÃ©, sinon 404
			   (t
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn   (merge-pathnames spa-fallback root*))
                                       (lm   (%file-rfc1123 pn))
                                       (resp (lumen.core.http-range:respond-file
                                              req pn
                                              :content-type \"text/html; charset=utf-8\"
                                              :last-modified-rfc1123 lm)))
                                  ;; SPA: pas de cache persistant
                                  (setf (lumen.core.http:resp-headers resp)
                                        (lumen.utils:ensure-header
                                         (lumen.core.http:resp-headers resp)
                                         \"cache-control\" \"no-store\"))
                                  resp)
                                (lumen.core.http:respond-404 \"Directory index disabled\"))))))
		      
                      ;; -------- Fichier ----------
                      ((probe-file target)
                       (let* ((ct   (guess-content-type target))
                              (lm   (%file-rfc1123 target))
                              (etag (%weak-etag-from-file target))
                              (resp (lumen.core.http-range:respond-file
                                     req target
                                     :content-type ct
                                     :last-modified-rfc1123 lm
                                     :etag etag)))
                         (setf (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                          \"cache-control\"
                                                          (format nil \"public, max-age=~D\" file-cache-secs)))
			 (setf (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header
				(lumen.core.http:resp-headers resp)
                                \"Vary\" \"Accept-Encoding\"))
                         resp))
		      
                      ;; -------- Rien pour ce prefix ----------
                      (t
                       (if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn   (merge-pathnames spa-fallback root*))
                                  (lm   (%file-rfc1123 pn))
                                  (resp (lumen.core.http-range:respond-file
                                         req pn
                                         :content-type \"text/html; charset=utf-8\"
                                         :last-modified-rfc1123 lm)))
                             (setf (lumen.core.http:resp-headers resp)
                                   (lumen.utils:ensure-header
                                    (lumen.core.http:resp-headers resp)
                                    \"cache-control\" \"no-store\"))
                             resp)
                           (funcall next req))))
                  (error ()
                    (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passer au suivant
              (funcall next req)))))))
|#" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 627 (face font-lock-comment-face fontified t) 627 659 (face font-lock-comment-face fontified t) 659 2159 (face font-lock-comment-face fontified t) 2159 2184 (face font-lock-comment-face fontified t) 2184 3684 (face font-lock-comment-face fontified t) 3684 3701 (face font-lock-comment-face fontified t) 3701 5201 (face font-lock-comment-face fontified t) 5201 5269 (face font-lock-comment-face fontified t) 5269 6311 (face font-lock-comment-face fontified t) 6311 6313 (face font-lock-comment-delimiter-face fontified t) 6313 6314 (fontified t) 6314 6316 (face font-lock-comment-delimiter-face fontified t) 6316 6769 (face font-lock-comment-face fontified t) 6769 6782 (face font-lock-comment-face fontified t) 6782 8282 (face font-lock-comment-face fontified t) 8282 8314 (face font-lock-comment-face fontified t) 8314 9814 (face font-lock-comment-face fontified t) 9814 9870 (face font-lock-comment-face fontified t) 9870 11370 (face font-lock-comment-face fontified t) 11370 11384 (face font-lock-comment-face fontified t) 11384 12884 (face font-lock-comment-face fontified t) 12884 12966 (face font-lock-comment-face fontified t) 12966 14414 (face font-lock-comment-face fontified t) 14414 14416 (face font-lock-comment-delimiter-face fontified t)) . 28524) (undo-tree-id0 . -14416) (t 26995 43499 0 0)) nil (26996 48191 829889 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 28524)) nil (26996 48191 829870 0) 0 nil])
([nil nil ((1510 . 1512) (t 26996 48191 0 0)) nil (26996 50813 362667 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1511) (undo-tree-id17 . -1) (#("
" 0 1 (fontified t)) . -1512) (undo-tree-id18 . -1) 1513) nil (26996 50813 362666 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.core.middleware
  (:use :cl :alexandria)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date)
  (:import-from :lumen.core.mime :guess-content-type)
  (:import-from :lumen.core.body :parse-urlencoded)
  (:import-from :lumen.core.session :session-id :session-data :session-get :session-set! :session-del! :verify-signed-sid :sign-sid :store-get :store-put! :store-del! :rand-bytes :*session-ttl* :*session-cookie* :*secure-cookie*)
  (:import-from :lumen.core.jwt :*jwt-secret* :jwt-encode :jwt-decode)
  (:import-from :lumen.core.ratelimit :allow?)
  (:import-from :lumen.core.http-range :respond-file)
  (:export :define-middleware :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :cors-auto :static-many
	   :form-parser :multipart-parser
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :request-context :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
   :csrf
	   :auth-jwt
   :https-redirect
	   :auth-required :roles-allowed :rate-limit
	   :request-timeout :max-body-size :access-log-json))

(in-package :lumen.core.middleware)" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 52 (face font-lock-type-face fontified t) 52 56 (fontified t) 56 60 (face font-lock-builtin-face fontified t) 60 61 (fontified t) 61 64 (face font-lock-builtin-face fontified t) 64 65 (fontified t) 65 76 (face font-lock-builtin-face fontified t) 76 81 (fontified t) 81 93 (face font-lock-builtin-face fontified t) 93 94 (fontified t) 94 110 (face font-lock-builtin-face fontified t) 110 111 (fontified t) 111 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 129 (face font-lock-builtin-face fontified t) 129 130 (fontified t) 130 140 (face font-lock-builtin-face fontified t) 140 141 (fontified t) 141 153 (face font-lock-builtin-face fontified t) 153 157 (fontified t) 157 170 (face font-lock-builtin-face fontified t) 170 171 (fontified t) 171 183 (face font-lock-builtin-face fontified t) 183 184 (fontified t) 184 196 (face font-lock-builtin-face fontified t) 196 197 (fontified t) 197 207 (face font-lock-builtin-face fontified t) 207 208 (fontified t) 208 216 (face font-lock-builtin-face fontified t) 216 217 (fontified t) 217 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 243 (face font-lock-builtin-face fontified t) 243 244 (fontified t) 244 256 (face font-lock-builtin-face fontified t) 256 257 (fontified t) 257 260 (face font-lock-builtin-face fontified t) 260 261 (fontified t) 261 265 (face font-lock-builtin-face fontified t) 265 266 (fontified t) 266 279 (face font-lock-builtin-face fontified t) 279 280 (fontified t) 280 294 (face font-lock-builtin-face fontified t) 294 295 (fontified t) 295 311 (face font-lock-builtin-face fontified t) 311 314 (fontified t) 314 331 (face font-lock-builtin-face fontified t) 331 336 (fontified t) 336 348 (face font-lock-builtin-face fontified t) 348 349 (fontified t) 349 365 (face font-lock-builtin-face fontified t) 365 366 (fontified t) 366 385 (face font-lock-builtin-face fontified t) 385 390 (fontified t) 390 402 (face font-lock-builtin-face fontified t) 402 403 (fontified t) 403 419 (face font-lock-builtin-face fontified t) 419 420 (fontified t) 420 437 (face font-lock-builtin-face fontified t) 437 442 (fontified t) 442 454 (face font-lock-builtin-face fontified t) 454 455 (fontified t) 455 474 (face font-lock-builtin-face fontified t) 474 475 (fontified t) 475 486 (face font-lock-builtin-face fontified t) 486 487 (fontified t) 487 500 (face font-lock-builtin-face fontified t) 500 501 (fontified t) 501 513 (face font-lock-builtin-face fontified t) 513 514 (fontified t) 514 527 (face font-lock-builtin-face fontified t) 527 528 (fontified t) 528 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 560 (face font-lock-builtin-face fontified t) 560 561 (fontified t) 561 570 (face font-lock-builtin-face fontified t) 570 571 (fontified t) 571 581 (face font-lock-builtin-face fontified t) 581 582 (fontified t) 582 593 (face font-lock-builtin-face fontified t) 593 594 (fontified t) 594 605 (face font-lock-builtin-face fontified t) 605 606 (fontified t) 606 617 (face font-lock-builtin-face fontified t) 617 618 (fontified t) 618 632 (face font-lock-builtin-face fontified t) 632 633 (fontified t) 633 650 (face font-lock-builtin-face fontified t) 650 651 (fontified t) 651 667 (face font-lock-builtin-face fontified t) 667 672 (fontified t) 672 684 (face font-lock-builtin-face fontified t) 684 685 (fontified t) 685 700 (face font-lock-builtin-face fontified t) 700 701 (fontified t) 701 714 (face font-lock-builtin-face fontified t) 714 715 (fontified t) 715 726 (face font-lock-builtin-face fontified t) 726 727 (fontified t) 727 738 (face font-lock-builtin-face fontified t) 738 743 (fontified t) 743 755 (face font-lock-builtin-face fontified t) 755 756 (fontified t) 756 777 (face font-lock-builtin-face fontified t) 777 778 (fontified t) 778 785 (face font-lock-builtin-face fontified t) 785 790 (fontified t) 790 802 (face font-lock-builtin-face fontified t) 802 803 (fontified t) 803 825 (face font-lock-builtin-face fontified t) 825 826 (fontified t) 826 839 (face font-lock-builtin-face fontified t) 839 844 (fontified t) 844 851 (face font-lock-builtin-face fontified t) 851 852 (fontified t) 852 870 (face font-lock-builtin-face fontified t) 870 871 (fontified t) 871 882 (face font-lock-builtin-face fontified t) 882 883 (fontified t) 883 889 (face font-lock-builtin-face fontified t) 889 890 (fontified t) 890 897 (face font-lock-builtin-face fontified t) 897 898 (fontified t) 898 908 (face font-lock-builtin-face fontified t) 908 909 (fontified t) 909 922 (face font-lock-builtin-face fontified t) 922 927 (fontified t) 927 955 (face font-lock-builtin-face fontified t) 955 956 (fontified t) 956 965 (face font-lock-builtin-face fontified t) 965 966 (fontified t) 966 987 (face font-lock-builtin-face fontified t) 987 992 (fontified t) 992 998 (face font-lock-builtin-face fontified t) 998 999 (fontified t) 999 1004 (face font-lock-builtin-face fontified t) 1004 1005 (fontified t) 1005 1012 (face font-lock-builtin-face fontified t) 1012 1013 (fontified t) 1013 1018 (face font-lock-builtin-face fontified t) 1018 1019 (fontified t) 1019 1029 (face font-lock-builtin-face fontified t) 1029 1030 (fontified t) 1030 1042 (face font-lock-builtin-face fontified t) 1042 1047 (fontified t) 1047 1059 (face font-lock-builtin-face fontified t) 1059 1060 (fontified t) 1060 1077 (face font-lock-builtin-face fontified t) 1077 1082 (fontified t) 1082 1085 (face font-lock-comment-delimiter-face fontified t) 1085 1101 (face font-lock-comment-face fontified t) 1101 1104 (fontified t) 1104 1120 (face font-lock-builtin-face fontified t) 1120 1121 (fontified t) 1121 1135 (face font-lock-builtin-face fontified t) 1135 1139 (fontified t) 1139 1142 (face font-lock-comment-delimiter-face fontified t) 1142 1150 (face font-lock-comment-face fontified t) 1150 1153 (fontified t) 1153 1164 (face font-lock-builtin-face fontified t) 1164 1165 (fontified t) 1165 1181 (face font-lock-builtin-face fontified t) 1181 1182 (fontified t) 1182 1194 (face font-lock-builtin-face fontified t) 1194 1195 (fontified t) 1195 1202 (face font-lock-builtin-face fontified t) 1202 1203 (fontified t) 1203 1218 (face font-lock-builtin-face fontified t) 1218 1222 (fontified t) 1222 1225 (face font-lock-comment-delimiter-face fontified t) 1225 1230 (face font-lock-comment-face fontified t) 1230 1233 (fontified t) 1233 1238 (face font-lock-builtin-face fontified t) 1238 1242 (fontified t) 1242 1245 (face font-lock-comment-delimiter-face fontified t) 1245 1257 (face font-lock-comment-face fontified t) 1257 1260 (fontified t) 1260 1272 (face font-lock-builtin-face fontified t) 1272 1276 (fontified t) 1276 1302 (face font-lock-builtin-face fontified t) 1302 1306 (fontified t) 1306 1309 (face font-lock-comment-delimiter-face fontified t) 1309 1317 (face font-lock-comment-face fontified t) 1317 1321 (fontified t) 1321 1329 (face font-lock-builtin-face fontified t) 1329 1333 (fontified t) 1333 1338 (face font-lock-builtin-face fontified t) 1338 1343 (fontified t) 1343 1352 (face font-lock-builtin-face fontified t) 1352 1356 (fontified t) 1356 1371 (face font-lock-builtin-face fontified t) 1371 1376 (fontified t) 1376 1390 (face font-lock-builtin-face fontified t) 1390 1391 (fontified t) 1391 1405 (face font-lock-builtin-face fontified t) 1405 1406 (fontified t) 1406 1417 (face font-lock-builtin-face fontified t) 1417 1422 (fontified t) 1422 1438 (face font-lock-builtin-face fontified t) 1438 1439 (fontified t) 1439 1453 (face font-lock-builtin-face fontified t) 1453 1454 (fontified t) 1454 1470 (face font-lock-builtin-face fontified t) 1470 1474 (fontified t) 1474 1475 (fontified t) 1475 1485 (face font-lock-keyword-face fontified t) 1485 1486 (fontified t) 1486 1500 (face font-lock-builtin-face fontified t) 1500 1508 (face font-lock-builtin-face fontified t) 1508 1509 (fontified t)) . 1) (undo-tree-id16 . -1509)) nil (26996 50813 362663 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1739 . 1740) (nil fontified nil 1 . 1740) (1 . 1740)) nil (26996 50813 362662 0) 0 nil])
([nil nil ((1740 . 1742)) nil (26996 50813 362662 0) 0 nil])
([nil nil ((1741 . 1743)) nil (26996 50813 362661 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5297 . 5298) (nil fontified nil 1743 . 5298) (1743 . 5298)) nil (26996 50813 362661 0) 0 nil])
([nil nil ((5300 . 5302)) nil (26996 50813 362660 0) 0 nil])
([nil nil ((7170 . 7172)) nil (26996 50813 362660 0) 0 nil])
([nil nil ((#("
#|
(define-middleware logger (req next)
  (let* ((start (get-internal-real-time))
         (resp (funcall next req))
         (end  (get-internal-real-time))
         (ms   (floor (* 1000.0 (/ (- end start)
                                   internal-time-units-per-second)))))
    (when *debug*
      (format t \"~&[lumen] ~A ~A -> ~A (~A ms)~%\"
              (slot-value req 'lumen.core.http::method)
              (slot-value req 'lumen.core.http::path)
              (lumen.core.http:resp-status resp)
              ms))
    resp))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 536 (face font-lock-comment-face fontified t) 536 538 (face font-lock-comment-delimiter-face fontified t)) . 7172) (undo-tree-id15 . -538)) nil (26996 50813 362659 0) 0 nil])
([nil nil ((#("

(defun %status-color (status)
  (cond
    ((<= 200 status 299) \"32\")  ; vert
    ((<= 300 status 399) \"36\")  ; cyan
    ((<= 400 status 499) \"33\")  ; jaune
    (t                          \"31\"))) ; rouge

(defun %emacs-repl-p ()
  \"Vrai si on est dans un REPL Emacs (SLIME/SLY) ou INSIDE_EMACS.\"
  (or (member :swank *features*)
      (member :slynk *features*)
      (uiop:getenv \"INSIDE_EMACS\")))

(defun %supports-ansi-p (stream)
  (declare (ignore stream))
  (and (not (%emacs-repl-p))
       (not (member :win32 *features*))
       (let ((term (uiop:getenv \"TERM\")))
         (and term (not (string= term \"\")) (not (string-equal term \"dumb\"))))))

(defun logger (&key (stream *terminal-io*) (color :auto))
  \"Logger concis: [ts] ip METHOD host path -> status (ms).
COLOR âˆˆ (:auto T NIL) â€” par dÃ©faut :auto (dÃ©sactivÃ© sur consoles sans ANSI).\"
  (let ((color-enabled (if (eq color :auto) (%supports-ansi-p stream) (not (null color)))))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0   (get-internal-real-time))
                 ;; IP: XFF â†’ X-Real-IP â†’ ctx[:remote-addr] â†’ \"-\"
                 (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                             (and xff (string-trim \" \" (car (uiop:split-string xff :separator \",\")))))
                           (h \"x-real-ip\")
                           (lumen.core.http:ctx-get req :remote-addr)
                           \"-\"))
                 (host (or (h \"host\") \"\"))
                 (meth (or (lumen.core.http:req-method req) \"GET\"))
                 (path (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms   (/ (- (get-internal-real-time) t0)
                          (/ internal-time-units-per-second 1000.0)))
                 (msi  (round ms))
                 (st   (lumen.core.http:resp-status resp))
                 (ts   (local-time:format-timestring
                        nil (local-time:now)
                        :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                  (:hour 2) \":\" (:min 2) \":\" (:sec 2)))))
            (if color-enabled
                ;; Placeholders: ts ip meth host path ESC color st ESC msi
                (format stream \"~&[~A] ~A ~A ~A ~A -> ~C[0;~am~D~C[0m (~D ms)~%\"
                        ts ip meth host path
                        #\\Esc (%status-color st) st #\\Esc msi)
              (format stream \"~&[~A] ~A ~A ~A ~A -> ~D (~D ms)~%\"
                      ts ip meth host path st msi))
            (finish-output stream)
            resp))))))
" 0 1 (fontified t) 1 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-function-name-face fontified t) 22 35 (fontified t) 35 39 (face font-lock-keyword-face fontified t) 39 65 (fontified t) 65 69 (face font-lock-string-face fontified t) 69 72 (fontified t) 72 79 (face font-lock-comment-face fontified t) 79 104 (fontified t) 104 108 (face font-lock-string-face fontified t) 108 111 (fontified t) 111 118 (face font-lock-comment-face fontified t) 118 143 (fontified t) 143 147 (face font-lock-string-face fontified t) 147 150 (fontified t) 150 158 (face font-lock-comment-face fontified t) 158 190 (fontified t) 190 194 (face font-lock-string-face fontified t) 194 198 (fontified t) 198 206 (face font-lock-comment-face fontified t) 206 208 (fontified t) 208 213 (face font-lock-keyword-face fontified t) 213 214 (fontified t) 214 227 (face font-lock-function-name-face fontified t) 227 233 (fontified t) 233 297 (face font-lock-doc-face fontified t) 297 312 (fontified t) 312 318 (face font-lock-builtin-face fontified t) 318 345 (fontified t) 345 351 (face font-lock-builtin-face fontified t) 351 383 (fontified t) 383 397 (face font-lock-string-face fontified t) 397 403 (fontified t) 403 408 (face font-lock-keyword-face fontified t) 408 409 (fontified t) 409 425 (face font-lock-function-name-face fontified t) 425 438 (fontified t) 438 445 (face font-lock-keyword-face fontified t) 445 512 (fontified t) 512 518 (face font-lock-builtin-face fontified t) 518 540 (fontified t) 540 543 (face font-lock-keyword-face fontified t) 543 564 (fontified t) 564 570 (face font-lock-string-face fontified t) 570 606 (fontified t) 606 612 (fontified t) 612 614 (face font-lock-string-face fontified t) 614 641 (fontified t) 641 647 (face font-lock-string-face fontified t) 647 654 (fontified t) 654 655 (fontified t) 655 656 (fontified t) 656 661 (face font-lock-keyword-face fontified t) 661 662 (fontified t) 662 668 (face font-lock-function-name-face fontified t) 668 670 (fontified t) 670 674 (face font-lock-type-face fontified t) 674 699 (fontified t) 699 705 (fontified t) 705 710 (face font-lock-builtin-face fontified t) 710 713 (fontified t) 713 715 (fontified t) 715 849 (face font-lock-doc-face fontified t) 849 853 (fontified t) 853 856 (face font-lock-keyword-face fontified t) 856 874 (fontified t) 874 876 (face font-lock-keyword-face fontified t) 876 887 (fontified t) 887 892 (face font-lock-builtin-face fontified t) 892 947 (fontified t) 947 953 (face font-lock-keyword-face fontified t) 953 961 (fontified t) 961 963 (fontified t) 963 968 (fontified t) 968 974 (face font-lock-keyword-face fontified t) 974 981 (fontified t) 981 990 (fontified t) 990 996 (face font-lock-keyword-face fontified t) 996 1078 (fontified t) 1078 1083 (face font-lock-builtin-face fontified t) 1083 1114 (fontified t) 1114 1118 (face font-lock-keyword-face fontified t) 1118 1169 (fontified t) 1169 1172 (face font-lock-comment-delimiter-face fontified t) 1172 1218 (face font-lock-comment-face fontified t) 1218 1246 (fontified t) 1246 1250 (face font-lock-keyword-face fontified t) 1250 1260 (fontified t) 1260 1277 (face font-lock-string-face fontified t) 1277 1332 (fontified t) 1332 1335 (face font-lock-string-face fontified t) 1335 1364 (fontified t) 1364 1374 (face font-lock-builtin-face fontified t) 1374 1375 (fontified t) 1375 1378 (face font-lock-string-face fontified t) 1378 1414 (fontified t) 1414 1425 (face font-lock-string-face fontified t) 1425 1483 (fontified t) 1483 1495 (face font-lock-builtin-face fontified t) 1495 1498 (fontified t) 1498 1501 (fontified t) 1501 1524 (fontified t) 1524 1527 (face font-lock-string-face fontified t) 1527 1530 (fontified t) 1530 1560 (fontified t) 1560 1566 (face font-lock-string-face fontified t) 1566 1568 (fontified t) 1568 1570 (face font-lock-string-face fontified t) 1570 1633 (fontified t) 1633 1638 (face font-lock-string-face fontified t) 1638 1699 (fontified t) 1699 1702 (face font-lock-string-face fontified t) 1702 2092 (fontified t) 2092 2099 (face font-lock-builtin-face fontified t) 2099 2102 (fontified t) 2102 2107 (face font-lock-builtin-face fontified t) 2107 2108 (fontified t) 2108 2111 (face font-lock-string-face fontified t) 2111 2113 (fontified t) 2113 2119 (face font-lock-builtin-face fontified t) 2119 2123 (fontified t) 2123 2126 (face font-lock-string-face fontified t) 2126 2128 (fontified t) 2128 2132 (face font-lock-builtin-face fontified t) 2132 2136 (fontified t) 2136 2139 (face font-lock-string-face fontified t) 2139 2154 (fontified t) 2154 2175 (fontified t) 2175 2180 (face font-lock-builtin-face fontified t) 2180 2184 (fontified t) 2184 2187 (face font-lock-string-face fontified t) 2187 2189 (fontified t) 2189 2193 (face font-lock-builtin-face fontified t) 2193 2197 (fontified t) 2197 2200 (face font-lock-string-face fontified t) 2200 2202 (fontified t) 2202 2206 (face font-lock-builtin-face fontified t) 2206 2214 (fontified t) 2214 2227 (fontified t) 2227 2229 (face font-lock-keyword-face fontified t) 2229 2260 (fontified t) 2260 2263 (face font-lock-comment-delimiter-face fontified t) 2263 2319 (face font-lock-comment-face fontified t) 2319 2350 (fontified t) 2350 2399 (face font-lock-string-face fontified t) 2399 2537 (fontified t) 2537 2573 (face font-lock-string-face fontified t) 2573 2684 (fontified t)) . -7172) (undo-tree-id13 . -2684) (undo-tree-id14 . -981) 9856) nil (26996 50813 362658 0) 0 nil])
([nil nil ((#("
#|
(defparameter debug-p (lumen.core.config:cfg-get \"DEBUG_MODE\" :default nil))  ;; active les prints si T

(defvar *app* (lambda (req)
                (declare (ignore req))
                (lumen.core.http:respond-404 \"No handler\"))
  \"La pile de middlewares active. Toujours mise Ã  jour via (set-app!).\")

(defvar *pipeline-signature* nil
  \"Liste symbolique des middlewares dans l'ordre actuel.\")

(defstruct mw-entry
  name   ;; string (affichage)
  fn)    ;; le factory: (next) -> (lambda (req) ...)

(defun %entry-name (x)
  (etypecase x
    (mw-entry (mw-entry-name x))
    (function \"<fn>\")))  ;; fallback lisible

(defun %entry-fn (x)
  (etypecase x
    (mw-entry (mw-entry-fn x))
    (function x)))

(defun named (name fn-factory)
  \"Wrappe un middleware factory avec un nom (string).\"
  (make-mw-entry :name (string name) :fn fn-factory))

(defmacro ->mw (name form)
  `(lumen.core.middleware:named ,name ,form))

(defun set-app! (&rest middlewares)
  \"Compose la pile. Chaque Ã©lÃ©ment peut Ãªtre:
   - un FUNCTION (factory classique),
   - ou (named \\\"Nom\\\" FUNCTION).\"
  (let* ((fns   (mapcar #'%entry-fn   middlewares))
         (names (mapcar #'%entry-name middlewares)))
    (setf *app* (apply #'my-compose fns)
          *pipeline-signature* names)))

(defun header-ref (headers name)
  (cdr (assoc (string-downcase name) headers :test #'string=)))

(defun my-compose (&rest middlewares)
  \"Construit (req -> resp) en enchaÃ®nant les middlewares dans lâ€™ordre donnÃ©.\"
  (let ((terminal (lambda (req)
                    (declare (ignore req))
                    (respond-404 \"No handler\"))))
    (dolist (mw (reverse middlewares) terminal)
      (setf terminal (funcall mw terminal)))))  ; <-- APPELLE le mw AVEC `next`

(defmacro define-middleware (name (req-sym next-sym) &body body)
  `(defun ,name (,next-sym)
     (lambda (,req-sym)
       ,@body)))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 4 (face font-lock-comment-face fontified t) 4 5 (face font-lock-comment-face fontified t) 5 17 (face font-lock-comment-face fontified t) 17 18 (face font-lock-comment-face fontified t) 18 25 (face font-lock-comment-face fontified t) 25 53 (face font-lock-comment-face fontified t) 53 65 (face font-lock-comment-face fontified t) 65 66 (face font-lock-comment-face fontified t) 66 74 (face font-lock-comment-face fontified t) 74 82 (face font-lock-comment-face fontified t) 82 85 (face font-lock-comment-face fontified t) 85 92 (face font-lock-comment-face fontified t) 92 108 (face font-lock-comment-face fontified t) 108 110 (face font-lock-comment-face fontified t) 110 116 (face font-lock-comment-face fontified t) 116 117 (face font-lock-comment-face fontified t) 117 122 (face font-lock-comment-face fontified t) 122 124 (face font-lock-comment-face fontified t) 124 130 (face font-lock-comment-face fontified t) 130 154 (face font-lock-comment-face fontified t) 154 161 (face font-lock-comment-face fontified t) 161 221 (face font-lock-comment-face fontified t) 221 233 (face font-lock-comment-face fontified t) 233 238 (face font-lock-comment-face fontified t) 238 307 (face font-lock-comment-face fontified t) 307 311 (face font-lock-comment-face fontified t) 311 317 (face font-lock-comment-face fontified t) 317 318 (face font-lock-comment-face fontified t) 318 338 (face font-lock-comment-face fontified t) 338 345 (face font-lock-comment-face fontified t) 345 400 (face font-lock-comment-face fontified t) 400 404 (face font-lock-comment-face fontified t) 404 413 (face font-lock-comment-face fontified t) 413 414 (face font-lock-comment-face fontified t) 414 422 (face font-lock-comment-face fontified t) 422 432 (face font-lock-comment-face fontified t) 432 435 (face font-lock-comment-face fontified t) 435 454 (face font-lock-comment-face fontified t) 454 463 (face font-lock-comment-face fontified t) 463 466 (face font-lock-comment-face fontified t) 466 507 (face font-lock-comment-face fontified t) 507 509 (face font-lock-comment-face fontified t) 509 514 (face font-lock-comment-face fontified t) 514 515 (face font-lock-comment-face fontified t) 515 526 (face font-lock-comment-face fontified t) 526 534 (face font-lock-comment-face fontified t) 534 543 (face font-lock-comment-face fontified t) 543 593 (face font-lock-comment-face fontified t) 593 599 (face font-lock-comment-face fontified t) 599 604 (face font-lock-comment-face fontified t) 604 607 (face font-lock-comment-face fontified t) 607 624 (face font-lock-comment-face fontified t) 624 626 (face font-lock-comment-face fontified t) 626 631 (face font-lock-comment-face fontified t) 631 632 (face font-lock-comment-face fontified t) 632 641 (face font-lock-comment-face fontified t) 641 649 (face font-lock-comment-face fontified t) 649 658 (face font-lock-comment-face fontified t) 658 713 (face font-lock-comment-face fontified t) 713 718 (face font-lock-comment-face fontified t) 718 719 (face font-lock-comment-face fontified t) 719 724 (face font-lock-comment-face fontified t) 724 745 (face font-lock-comment-face fontified t) 745 797 (face font-lock-comment-face fontified t) 797 815 (face font-lock-comment-face fontified t) 815 820 (face font-lock-comment-face fontified t) 820 835 (face font-lock-comment-face fontified t) 835 838 (face font-lock-comment-face fontified t) 838 854 (face font-lock-comment-face fontified t) 854 862 (face font-lock-comment-face fontified t) 862 863 (face font-lock-comment-face fontified t) 863 867 (face font-lock-comment-face fontified t) 867 928 (face font-lock-comment-face fontified t) 928 933 (face font-lock-comment-face fontified t) 933 934 (face font-lock-comment-face fontified t) 934 942 (face font-lock-comment-face fontified t) 942 944 (face font-lock-comment-face fontified t) 944 949 (face font-lock-comment-face fontified t) 949 965 (face font-lock-comment-face fontified t) 965 1081 (face font-lock-comment-face fontified t) 1081 1085 (face font-lock-comment-face fontified t) 1085 1089 (face font-lock-comment-face fontified t) 1089 1249 (face font-lock-comment-face fontified t) 1249 1268 (face font-lock-comment-face fontified t) 1268 1270 (face font-lock-comment-face fontified t) 1270 1275 (face font-lock-comment-face fontified t) 1275 1276 (face font-lock-comment-face fontified t) 1276 1286 (face font-lock-comment-face fontified t) 1286 1347 (face font-lock-comment-face fontified t) 1347 1352 (face font-lock-comment-face fontified t) 1352 1367 (face font-lock-comment-face fontified t) 1367 1368 (face font-lock-comment-face fontified t) 1368 1373 (face font-lock-comment-face fontified t) 1373 1374 (face font-lock-comment-face fontified t) 1374 1384 (face font-lock-comment-face fontified t) 1384 1386 (face font-lock-comment-face fontified t) 1386 1391 (face font-lock-comment-face fontified t) 1391 1407 (face font-lock-comment-face fontified t) 1407 1482 (face font-lock-comment-face fontified t) 1482 1486 (face font-lock-comment-face fontified t) 1486 1489 (face font-lock-comment-face fontified t) 1489 1502 (face font-lock-comment-face fontified t) 1502 1503 (face font-lock-comment-face fontified t) 1503 1504 (face font-lock-comment-face fontified t) 1504 1508 (face font-lock-comment-face fontified t) 1508 1515 (face font-lock-comment-face fontified t) 1515 1536 (face font-lock-comment-face fontified t) 1536 1543 (face font-lock-comment-face fontified t) 1543 1591 (face font-lock-comment-face fontified t) 1591 1592 (face font-lock-comment-face fontified t) 1592 1603 (face font-lock-comment-face fontified t) 1603 1608 (face font-lock-comment-face fontified t) 1608 1613 (face font-lock-comment-face fontified t) 1613 1619 (face font-lock-comment-face fontified t) 1619 1704 (face font-lock-comment-face fontified t) 1704 1736 (face font-lock-comment-face fontified t) 1736 1738 (face font-lock-comment-face fontified t) 1738 1746 (face font-lock-comment-face fontified t) 1746 1747 (face font-lock-comment-face fontified t) 1747 1764 (face font-lock-comment-face fontified t) 1764 1790 (face font-lock-comment-face fontified t) 1790 1795 (face font-lock-comment-face fontified t) 1795 1806 (face font-lock-comment-face fontified t) 1806 1811 (face font-lock-comment-face fontified t) 1811 1836 (face font-lock-comment-face fontified t) 1836 1842 (face font-lock-comment-face fontified t) 1842 1871 (face font-lock-comment-face fontified t) 1871 1873 (face font-lock-comment-delimiter-face fontified t)) . 5299) (undo-tree-id12 . -1873)) nil (26996 50813 362657 0) 0 nil])
([nil nil ((#("#|
(defun cors (&key (origins '(\"*\")) (methods '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\"))
                  (headers '(\"Content-Type\" \"Authorization\"))
                  (expose '()) (credentials nil) (max-age 600))
  \"CORS middleware. RÃ©pond aux prÃ©flights (OPTIONS) et enrichit toutes les rÃ©ponses.\"
  (lambda (next)
    (lambda (req)
      (let* ((req-h (lumen.core.http:req-headers req))
             (origin (cdr (assoc \"origin\" req-h :test #'string-equal)))
             (req-method (cdr (assoc \"access-control-request-method\" req-h :test #'string-equal)))
             (preflight (and (stringp req-method)
                             (string= (slot-value req 'lumen.core.http::method) \"OPTIONS\")))
             (allow-origin (cond
                             ((or (null origin) (member \"*\" origins :test #'string=)) \"*\")
                             ((member origin origins :test #'string=) origin)
                             (t nil))))
        (labels ((decorate (resp)
                   (when allow-origin
                     (setf (lumen.core.http:resp-headers resp)
                           (-> (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header \"access-control-allow-origin\" allow-origin)
                               (lumen.utils:ensure-header \"vary\" \"Origin\"))))
                   (when credentials
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                          \"access-control-allow-credentials\" \"true\")))
                   (when expose
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                          \"access-control-expose-headers\"
                                          (format nil \"~{~A~^, ~}\" expose))))
                   resp))
          (if preflight
              (let ((resp (make-instance 'lumen.core.http:response
                                         :status 204 :headers nil :body \"\")))
                (when allow-origin
                  (setf (lumen.core.http:resp-headers resp)
                        (-> (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header \"access-control-allow-origin\" allow-origin)
                            (lumen.utils:ensure-header \"access-control-allow-methods\" (format nil \"~{~A~^, ~}\" methods))
                            (lumen.utils:ensure-header \"access-control-allow-headers\" (format nil \"~{~A~^, ~}\" headers))
                            (lumen.utils:ensure-header \"access-control-max-age\" (princ-to-string max-age)))))
                (when credentials
                  (setf (lumen.core.http:resp-headers resp)
                        (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                       \"access-control-allow-credentials\" \"true\")))
                resp)
(decorate (funcall next req))))))))
|#
" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 1139 (face font-lock-comment-face fontified t) 1139 1157 (face font-lock-comment-face fontified t) 1157 2657 (face font-lock-comment-face fontified t) 2657 2756 (face font-lock-comment-face fontified t) 2756 3079 (face font-lock-comment-face fontified t) 3079 3081 (face font-lock-comment-delimiter-face fontified t) 3081 3082 (fontified t)) . -10255) (undo-tree-id10 . -3082) (undo-tree-id11 . -1527) 13337) nil (26996 50813 362656 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -10254) (undo-tree-id8 . -1) (undo-tree-id9 . -1) 10255) nil (26996 50813 362654 0) 0 nil])
([nil nil ((#(";; --- Query parser -----------------------------------------------------------
(defun %url-decode (s)
  \"Decode minimal: %HH et '+' -> espace.\"
  (when s
    (with-output-to-string (out)
      (loop for i from 0 below (length s) do
            (let ((c (char s i)))
              (cond
                ((char= c #\\+) (write-char #\\Space out))
                ((and (char= c #\\%)
                      (<= (+ i 2) (1- (length s))))
                 (let* ((h1 (digit-char-p (char s (1+ i)) 16))
                        (h2 (digit-char-p (char s (+ i 2)) 16)))
                   (if (and h1 h2)
                       (progn
                         (write-char (code-char (+ (* h1 16) h2)) out)
                         (incf i 2))
                       (write-char c out))))
                (t (write-char c out))))))))

(defun parse-query-string-to-alist (qs)
  \"Transforme \\\"a=1&q[s][!=]=done\\\" -> ((\\\"a\\\" . \\\"1\\\") (\\\"q[s][!=]\\\" . \\\"done\\\")).
   GÃ¨re intelligemment les opÃ©rateurs !=, >=, <= dans les clÃ©s.\"
  (if (or (null qs) (zerop (length qs)))
      nil
      (loop for pair in (uiop:split-string qs :separator \"&\")
            ;; On cherche la position du sÃ©parateur '='
            for p = (let ((len (length pair)))
                      (loop for i from 0 below len
                            ;; On a trouvÃ© un '='
                            when (char= (char pair i) #\\=)
                              ;; EST-CE LE VRAI SÃ‰PARATEUR ?
                              ;; Oui si c'est le tout premier caractÃ¨re (clÃ© vide)
                              ;; OU si le caractÃ¨re prÃ©cÃ©dent n'est PAS un morceau d'opÃ©rateur (!, >, <)
                              when (or (zerop i)
                                       (not (member (char pair (1- i)) '(#\\! #\\> #\\<))))
                                return i))
            
            ;; Extraction ClÃ© / Valeur
            for k = (%url-decode (subseq pair 0 (or p (length pair))))
            for v = (%url-decode (if p (subseq pair (1+ p)) \"\"))
            collect (cons k v))))

(define-middleware query-parser (req next)
  ;; Si req-query est une string, on la remplace par une alist.
  (let* ((q (lumen.core.http:req-query req)))
    (when (stringp q)
      (setf (lumen.core.http:req-query req) (parse-query-string-to-alist q)))
    (funcall next req)))

(defun path-matches? (path paths prefixes)
  (or (and paths (member path paths :test #'string=))
      (and prefixes
           (some (lambda (pfx)
                   (and (<= (length pfx) (length path))
                        (string= pfx path :end2 (length pfx))))
                 prefixes))))

(defun json-only (&key paths prefixes exclude-paths exclude-prefixes (respect-existing t))
  \"Forcer JSON uniquement pour les endpoints API ciblÃ©s,
   sans Ã©craser les assets (MIME issu de lumen.core.mime).\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (path (lumen.core.http:req-path req))
             ;; MIME dÃ©duit de lâ€™URL (utile pour URLs statiques /app/...):
             (guess (lumen.core.mime:content-type-for path))
             (ct (cdr (assoc \"content-type\" (lumen.core.http:resp-headers resp)
                             :test #'string-equal)))
             (should-apply (and (path-matches? path paths prefixes)
                                (not (path-matches? path exclude-paths exclude-prefixes))
                                ;; si lâ€™URL ressemble Ã  un asset connu (js, css, â€¦), on nâ€™applique pas
                                (not (string/= guess \"application/octet-stream\")) ; => connu
                                ;; on veut **forcer** JSON uniquement si guess n'est PAS un type dâ€™asset
                                ;; donc on inverse : n'appliquer que si guess est octet-stream (inconnu)
                                )))
        ;; Si la route est explicitement API (ex: /api, /auth, /openapi.json),
        ;; passe plutÃ´t paths/prefixes pour matcher celles-ci. Exemple dâ€™usage plus bas.
        (cond
          ;; si lâ€™URL est un asset (guess â‰  octet-stream), NE RIEN FAIRE
          ((and guess (not (string= (string-downcase guess) \"application/octet-stream\")))
           resp)
          ;; si on respecte un type existant non JSON (SSE, CSV, etc.), NE RIEN FAIRE
          ((and respect-existing ct
                (not (cl-ppcre:scan \"^application/json\" (string-downcase ct))))
           resp)
          ;; si SSE, NE RIEN FAIRE
          ((and ct (string= (string-downcase ct) \"text/event-stream\"))
           resp)
          ;; pour les endpoints API sans CT explicite : forcer JSON
          ((path-matches? path paths prefixes)
           (setf (lumen.core.http:resp-headers resp)
                 (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                            \"content-type\"
                                            \"application/json; charset=utf-8\"))
           resp)
          (t resp))))))

;;;; ----------------------------------------------------------------------------
;;;; CORS dual-mode (dev permissif / prod strict) + factory via lumen.core.config
;;;; ----------------------------------------------------------------------------
(defun cors (&key (mode :dev)                       ; :dev | :prod
                  (origins '(\"*\"))                  ; whitelist en :prod, ou '(\"*\") en :dev
                  (methods '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\"))
                  (headers '(\"Content-Type\" \"Authorization\"))
                  (expose '()) (credentials nil) (max-age 600))
  \"CORS middleware dual-mode (dev permissif / prod strict).
- MODE       : :dev (permissif) | :prod (strict whitelist)
- ORIGINS    : liste d'origines autorisÃ©es (prod) ou '(\\\"*\\\") (dev)
- CREDENTIALS: si T, on nâ€™Ã©met jamais \\\"*\\\" ; on renvoie lâ€™Origin effectif si autorisÃ©
- MAX-AGE    : secondes de cache prÃ©flight\"
  (lambda (next)
    (lambda (req)
      (let* ((req-h (lumen.core.http:req-headers req))
             (origin (cdr (assoc \"origin\" req-h :test #'string-equal)))
             (acr-method (cdr (assoc \"access-control-request-method\" req-h :test #'string-equal)))
             (acr-headers-req (cdr (assoc \"access-control-request-headers\" req-h :test #'string-equal)))
             (is-options (string= (slot-value req 'lumen.core.http::method) \"OPTIONS\"))
             (preflight (and is-options (stringp acr-method)))
             (allow-origin
               (cond
                 ((eq mode :dev)
                  ;; En dev: permissif ; si credentials, renvoyer origin (si prÃ©sent) plutÃ´t que \"*\"
                  (or (and credentials origin) \"*\"))
                 ((eq mode :prod)
                  (cond
                    ((and origin (member origin origins :test #'string=)) origin)
                    ((member \"*\" origins :test #'string=) \"*\") ; si on veut forcer permissif en prod (dÃ©conseillÃ©)
                    (t nil)))
                 (t nil))))
        (labels
            ((%ensure (resp name value)
               (setf (lumen.core.http:resp-headers resp)
                     (lumen.utils:ensure-header (lumen.core.http:resp-headers resp) name value)))
             (decorate (resp)
               ;; Toujours Vary: Origin (CDN-safe)
               (%ensure resp \"vary\" \"Origin\")
               ;; Allow-Origin (+ credentials si applicable)
               (when allow-origin
                 (let ((effective
                         (if (and credentials (string= allow-origin \"*\") (stringp origin))
                             origin
                             allow-origin)))
                   (%ensure resp \"access-control-allow-origin\" effective)
                   (when (and credentials (not (string= effective \"*\")))
                     (%ensure resp \"access-control-allow-credentials\" \"true\"))))
               ;; Expose-Headers
               (when expose
                 (%ensure resp \"access-control-expose-headers\" (format nil \"~{~A~^, ~}\" expose)))
               resp))
          (if preflight
              (let ((resp (make-instance 'lumen.core.http:response
                                         :status 204 :headers nil :body \"\")))
                ;; Vary complet pour prÃ©flight
                (dolist (h '(\"Origin\" \"Access-Control-Request-Method\" \"Access-Control-Request-Headers\"))
                  (%ensure resp \"vary\" h))
                (when allow-origin
                  (let* ((effective
                           (if (and credentials (string= allow-origin \"*\") (stringp origin))
                               origin
                               allow-origin))
                         (allow-headers
                           ;; Ã©cho des headers demandÃ©s par le client + base configurÃ©e
                           (let ((base (format nil \"~{~A~^, ~}\" headers)))
                             (if (and acr-headers-req (plusp (length acr-headers-req)))
                                 (format nil \"~A, ~A\" base acr-headers-req)
                                 base))))
                    (%ensure resp \"access-control-allow-origin\" effective)
                    (%ensure resp \"access-control-allow-methods\" (format nil \"~{~A~^, ~}\" methods))
                    (%ensure resp \"access-control-allow-headers\" allow-headers)
                    (%ensure resp \"access-control-max-age\" (princ-to-string max-age))
                    (when (and credentials (not (string= effective \"*\")))
                      (%ensure resp \"access-control-allow-credentials\" \"true\"))))
                resp)
              (decorate (funcall next req))))))))

;;; --------------------------------------------------------------------------
;;; Factory branchÃ©e sur lumen.core.config
;;; --------------------------------------------------------------------------

(eval-when (:compile-toplevel :load-toplevel :execute)
  (unless (find-package :lumen.core.config)
    (error \"Le package :lumen.core.config doit Ãªtre chargÃ© avant cors-auto.\")))

(defun %prod-profile-p (profile)
  \"Renvoie T si le profil indique un environnement de prod/staging.\"
  (member profile '(:prod :production :staging) :test #'eq))

(defun cors-auto ()
  \"Construit un mw CORS depuis lumen.core.config.
ClÃ©s supportÃ©es (profilÃ©es par ENV grÃ¢ce Ã  lumen.core.config):
  - :cors/origins        â†’ liste (CSV ou multiple) dâ€™origines autorisÃ©es
  - :cors/credentials    â†’ bool
  - :cors/max-age        â†’ durÃ©e (ex: \\\"600s\\\", \\\"10m\\\")
  - :cors/headers        â†’ liste dâ€™en-tÃªtes acceptÃ©s au prÃ©flight
  - :cors/methods        â†’ liste de mÃ©thodes autorisÃ©es
  - :cors/expose         â†’ liste dâ€™en-tÃªtes exposÃ©s cÃ´tÃ© client\"
  (let* ((profile (lumen.core.config:cfg-profile))
         (mode    (if (%prod-profile-p profile) :prod :dev))
         (origins (or (lumen.core.config:cfg-get-list :cors/origins) (if (eq mode :prod) '() '(\"*\"))))
         (creds   (or (lumen.core.config:cfg-get-bool :cors/credentials :default nil) nil))
         (max-age (or (lumen.core.config:cfg-get-duration :cors/max-age :default \"600s\") 600))
         (hdrs    (or (lumen.core.config:cfg-get-list :cors/headers) '(\"Content-Type\" \"Authorization\")))
         (meths   (or (lumen.core.config:cfg-get-list :cors/methods)
                      '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\")))
         (xpose   (or (lumen.core.config:cfg-get-list :cors/expose) '())))
    (cors :mode mode
          :origins origins
          :credentials creds
          :max-age max-age
          :headers hdrs
          :methods meths
          :expose xpose)))

#|
(defun guess-content-type (pathname)
  (let* ((s (string-downcase (or (pathname-type pathname) \"\"))))
    (cond
      ((string= s \"html\") \"text/html; charset=utf-8\")
      ((string= s \"css\")  \"text/css; charset=utf-8\")
      ((string= s \"js\")   \"application/javascript; charset=utf-8\")
      ((member s '(\"png\" \"jpg\" \"jpeg\" \"gif\" \"webp\") :test #'string=) (format nil \"image/~A\" s))
      ((string= s \"svg\")  \"image/svg+xml\")
      ((string= s \"json\") \"application/json; charset=utf-8\")
      (t \"application/octet-stream\"))))
|#
" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 80 (face font-lock-comment-face fontified t) 80 81 (fontified t) 81 86 (face font-lock-keyword-face fontified t) 86 87 (fontified t) 87 98 (face font-lock-function-name-face fontified t) 98 105 (fontified t) 105 144 (face font-lock-doc-face fontified t) 144 148 (fontified t) 148 152 (face font-lock-keyword-face fontified t) 152 160 (fontified t) 160 181 (face font-lock-keyword-face fontified t) 181 195 (fontified t) 195 199 (face font-lock-keyword-face fontified t) 199 246 (fontified t) 246 249 (face font-lock-keyword-face fontified t) 249 282 (fontified t) 282 286 (face font-lock-keyword-face fontified t) 286 345 (fontified t) 345 380 (fontified t) 380 450 (fontified t) 450 454 (face font-lock-keyword-face fontified t) 454 580 (fontified t) 580 582 (face font-lock-keyword-face fontified t) 582 619 (fontified t) 619 624 (face font-lock-keyword-face fontified t) 624 824 (fontified t) 824 825 (fontified t) 825 830 (face font-lock-keyword-face fontified t) 830 831 (fontified t) 831 858 (face font-lock-function-name-face fontified t) 858 866 (fontified t) 866 1012 (face font-lock-doc-face fontified t) 1012 1016 (fontified t) 1016 1018 (face font-lock-keyword-face fontified t) 1018 1029 (fontified t) 1029 1054 (fontified t) 1054 1071 (fontified t) 1071 1075 (face font-lock-keyword-face fontified t) 1075 1110 (fontified t) 1110 1120 (face font-lock-builtin-face fontified t) 1120 1121 (fontified t) 1121 1124 (face font-lock-string-face fontified t) 1124 1138 (fontified t) 1138 1141 (face font-lock-comment-delimiter-face fontified t) 1141 1182 (face font-lock-comment-face fontified t) 1182 1203 (fontified t) 1203 1206 (face font-lock-keyword-face fontified t) 1206 1252 (fontified t) 1252 1256 (face font-lock-keyword-face fontified t) 1256 1308 (fontified t) 1308 1311 (face font-lock-comment-delimiter-face fontified t) 1311 1330 (face font-lock-comment-face fontified t) 1330 1419 (fontified t) 1419 1422 (face font-lock-comment-delimiter-face fontified t) 1422 1450 (face font-lock-comment-face fontified t) 1450 1480 (fontified t) 1480 1483 (face font-lock-comment-delimiter-face fontified t) 1483 1499 (face font-lock-comment-face fontified t) 1499 1500 (face font-lock-comment-face fontified t) 1500 1533 (face font-lock-comment-face fontified t) 1533 1563 (fontified t) 1563 1566 (face font-lock-comment-delimiter-face fontified t) 1566 1638 (face font-lock-comment-face fontified t) 1638 1844 (fontified t) 1844 1847 (face font-lock-comment-delimiter-face fontified t) 1847 1871 (face font-lock-comment-face fontified t) 1871 1976 (fontified t) 1976 1978 (face font-lock-keyword-face fontified t) 1978 2002 (fontified t) 2002 2004 (face font-lock-string-face fontified t) 2004 2043 (fontified t) 2043 2060 (face font-lock-keyword-face fontified t) 2060 2087 (fontified t) 2087 2090 (face font-lock-comment-delimiter-face fontified t) 2090 2149 (face font-lock-comment-face fontified t) 2149 2152 (fontified t) 2152 2156 (face font-lock-keyword-face fontified t) 2156 2200 (fontified t) 2200 2204 (face font-lock-keyword-face fontified t) 2204 2322 (fontified t) 2322 2327 (face font-lock-keyword-face fontified t) 2327 2328 (fontified t) 2328 2341 (face font-lock-function-name-face fontified t) 2341 2400 (fontified t) 2400 2405 (face font-lock-builtin-face fontified t) 2405 2456 (fontified t) 2456 2462 (face font-lock-keyword-face fontified t) 2462 2554 (fontified t) 2554 2567 (fontified t) 2567 2572 (face font-lock-builtin-face fontified t) 2572 2589 (fontified t) 2589 2620 (fontified t) 2620 2621 (fontified t) 2621 2626 (face font-lock-keyword-face fontified t) 2626 2627 (fontified t) 2627 2636 (face font-lock-function-name-face fontified t) 2636 2638 (fontified t) 2638 2642 (face font-lock-type-face fontified t) 2642 2713 (fontified t) 2713 2827 (face font-lock-doc-face fontified t) 2827 2831 (fontified t) 2831 2837 (face font-lock-keyword-face fontified t) 2837 2850 (fontified t) 2850 2856 (face font-lock-keyword-face fontified t) 2856 2870 (fontified t) 2870 2874 (face font-lock-keyword-face fontified t) 2874 2966 (fontified t) 2966 2969 (face font-lock-comment-delimiter-face fontified t) 2969 3028 (face font-lock-comment-face fontified t) 3028 3033 (fontified t) 3033 3089 (fontified t) 3089 3118 (fontified t) 3118 3132 (face font-lock-string-face fontified t) 3132 3198 (fontified t) 3198 3203 (face font-lock-builtin-face fontified t) 3203 3412 (fontified t) 3412 3415 (face font-lock-comment-delimiter-face fontified t) 3415 3483 (face font-lock-comment-face fontified t) 3483 3536 (fontified t) 3536 3562 (face font-lock-string-face fontified t) 3562 3565 (fontified t) 3565 3576 (face font-lock-comment-face fontified t) 3576 3608 (fontified t) 3608 3611 (face font-lock-comment-delimiter-face fontified t) 3611 3681 (face font-lock-comment-face fontified t) 3681 3713 (fontified t) 3713 3716 (face font-lock-comment-delimiter-face fontified t) 3716 3786 (face font-lock-comment-face fontified t) 3786 3830 (fontified t) 3830 3833 (face font-lock-comment-delimiter-face fontified t) 3833 3901 (face font-lock-comment-face fontified t) 3901 3909 (fontified t) 3909 3912 (face font-lock-comment-delimiter-face fontified t) 3912 3990 (face font-lock-comment-face fontified t) 3990 3999 (fontified t) 3999 4003 (face font-lock-keyword-face fontified t) 4003 4014 (fontified t) 4014 4017 (face font-lock-comment-delimiter-face fontified t) 4017 4077 (face font-lock-comment-face fontified t) 4077 4137 (fontified t) 4137 4163 (face font-lock-string-face fontified t) 4163 4194 (fontified t) 4194 4197 (face font-lock-comment-delimiter-face fontified t) 4197 4270 (face font-lock-comment-face fontified t) 4270 4342 (fontified t) 4342 4361 (face font-lock-string-face fontified t) 4361 4413 (fontified t) 4413 4416 (face font-lock-comment-delimiter-face fontified t) 4416 4438 (face font-lock-comment-face fontified t) 4438 4487 (fontified t) 4487 4506 (face font-lock-string-face fontified t) 4506 4536 (fontified t) 4536 4539 (face font-lock-comment-delimiter-face fontified t) 4539 4589 (face font-lock-comment-face fontified t) 4589 4594 (face font-lock-comment-face fontified t) 4594 4818 (fontified t) 4818 4832 (face font-lock-string-face fontified t) 4832 4877 (fontified t) 4877 4910 (face font-lock-string-face fontified t) 4910 4954 (fontified t) 4954 4955 (fontified t) 4955 4960 (face font-lock-comment-delimiter-face fontified t) 4960 5037 (face font-lock-comment-face fontified t) 5037 5042 (face font-lock-comment-delimiter-face fontified t) 5042 5119 (face font-lock-comment-face fontified t) 5119 5124 (face font-lock-comment-delimiter-face fontified t) 5124 5201 (face font-lock-comment-face fontified t) 5201 5202 (fontified t) 5202 5207 (face font-lock-keyword-face fontified t) 5207 5208 (fontified t) 5208 5212 (face font-lock-function-name-face fontified t) 5212 5214 (fontified t) 5214 5218 (face font-lock-type-face fontified t) 5218 5225 (fontified t) 5225 5229 (face font-lock-builtin-face fontified t) 5229 5253 (fontified t) 5253 5268 (face font-lock-comment-face fontified t) 5268 5297 (fontified t) 5297 5300 (face font-lock-string-face fontified t) 5300 5320 (fontified t) 5320 5360 (face font-lock-comment-face fontified t) 5360 5389 (fontified t) 5389 5394 (face font-lock-string-face fontified t) 5394 5395 (fontified t) 5395 5401 (face font-lock-string-face fontified t) 5401 5402 (fontified t) 5402 5407 (face font-lock-string-face fontified t) 5407 5408 (fontified t) 5408 5415 (face font-lock-string-face fontified t) 5415 5416 (fontified t) 5416 5424 (face font-lock-string-face fontified t) 5424 5425 (fontified t) 5425 5434 (face font-lock-string-face fontified t) 5434 5466 (fontified t) 5466 5480 (face font-lock-string-face fontified t) 5480 5481 (fontified t) 5481 5496 (face font-lock-string-face fontified t) 5496 5565 (fontified t) 5565 5880 (face font-lock-doc-face fontified t) 5880 5884 (fontified t) 5884 5890 (face font-lock-keyword-face fontified t) 5890 5903 (fontified t) 5903 5909 (face font-lock-keyword-face fontified t) 5909 5923 (fontified t) 5923 5927 (face font-lock-keyword-face fontified t) 5927 6004 (fontified t) 6004 6012 (face font-lock-string-face fontified t) 6012 6019 (fontified t) 6019 6024 (face font-lock-builtin-face fontified t) 6024 6080 (fontified t) 6080 6111 (face font-lock-string-face fontified t) 6111 6118 (fontified t) 6118 6123 (face font-lock-builtin-face fontified t) 6123 6128 (fontified t) 6128 6142 (fontified t) 6142 6184 (fontified t) 6184 6216 (face font-lock-string-face fontified t) 6216 6223 (fontified t) 6223 6228 (face font-lock-builtin-face fontified t) 6228 6323 (fontified t) 6323 6332 (face font-lock-string-face fontified t) 6332 6441 (fontified t) 6441 6445 (face font-lock-keyword-face fontified t) 6445 6454 (fontified t) 6454 6455 (fontified t) 6455 6473 (fontified t) 6473 6477 (face font-lock-builtin-face fontified t) 6477 6479 (fontified t) 6479 6497 (fontified t) 6497 6500 (face font-lock-comment-delimiter-face fontified t) 6500 6580 (face font-lock-comment-face fontified t) 6580 6627 (fontified t) 6627 6630 (face font-lock-string-face fontified t) 6630 6660 (fontified t) 6660 6665 (face font-lock-builtin-face fontified t) 6665 6686 (fontified t) 6686 6690 (face font-lock-keyword-face fontified t) 6690 6747 (fontified t) 6747 6752 (face font-lock-builtin-face fontified t) 6752 6802 (fontified t) 6802 6805 (face font-lock-string-face fontified t) 6805 6814 (fontified t) 6814 6819 (face font-lock-builtin-face fontified t) 6819 6831 (fontified t) 6831 6834 (face font-lock-string-face fontified t) 6834 6836 (fontified t) 6836 6888 (face font-lock-comment-face fontified t) 6888 6955 (fontified t) 6955 6961 (face font-lock-keyword-face fontified t) 6961 7202 (fontified t) 7202 7205 (face font-lock-comment-delimiter-face fontified t) 7205 7238 (face font-lock-comment-face fontified t) 7238 7267 (fontified t) 7267 7273 (face font-lock-string-face fontified t) 7273 7274 (fontified t) 7274 7282 (face font-lock-string-face fontified t) 7282 7299 (fontified t) 7299 7302 (face font-lock-comment-delimiter-face fontified t) 7302 7345 (face font-lock-comment-face fontified t) 7345 7361 (fontified t) 7361 7365 (face font-lock-keyword-face fontified t) 7365 7397 (fontified t) 7397 7400 (face font-lock-keyword-face fontified t) 7400 7439 (fontified t) 7439 7441 (face font-lock-keyword-face fontified t) 7441 7481 (fontified t) 7481 7484 (face font-lock-string-face fontified t) 7484 7618 (fontified t) 7618 7647 (face font-lock-string-face fontified t) 7647 7679 (fontified t) 7679 7683 (face font-lock-keyword-face fontified t) 7683 7725 (fontified t) 7725 7728 (face font-lock-string-face fontified t) 7728 7767 (fontified t) 7767 7801 (face font-lock-string-face fontified t) 7801 7802 (fontified t) 7802 7808 (face font-lock-string-face fontified t) 7808 7828 (fontified t) 7828 7831 (face font-lock-comment-delimiter-face fontified t) 7831 7846 (face font-lock-comment-face fontified t) 7846 7862 (fontified t) 7862 7866 (face font-lock-keyword-face fontified t) 7866 7905 (fontified t) 7905 7936 (face font-lock-string-face fontified t) 7936 7949 (fontified t) 7949 7961 (face font-lock-string-face fontified t) 7961 7979 (fontified t) 7979 7994 (fontified t) 7994 8005 (fontified t) 8005 8007 (face font-lock-keyword-face fontified t) 8007 8033 (fontified t) 8033 8036 (face font-lock-keyword-face fontified t) 8036 8126 (fontified t) 8126 8133 (face font-lock-builtin-face fontified t) 8133 8138 (fontified t) 8138 8146 (face font-lock-builtin-face fontified t) 8146 8151 (fontified t) 8151 8156 (face font-lock-builtin-face fontified t) 8156 8157 (fontified t) 8157 8159 (face font-lock-string-face fontified t) 8159 8179 (fontified t) 8179 8182 (face font-lock-comment-delimiter-face fontified t) 8182 8210 (face font-lock-comment-face fontified t) 8210 8227 (fontified t) 8227 8233 (face font-lock-keyword-face fontified t) 8233 8239 (fontified t) 8239 8247 (face font-lock-string-face fontified t) 8247 8248 (fontified t) 8248 8279 (face font-lock-string-face fontified t) 8279 8280 (fontified t) 8280 8312 (face font-lock-string-face fontified t) 8312 8347 (fontified t) 8347 8353 (face font-lock-string-face fontified t) 8353 8375 (fontified t) 8375 8379 (face font-lock-keyword-face fontified t) 8379 8412 (fontified t) 8412 8416 (face font-lock-keyword-face fontified t) 8416 8457 (fontified t) 8457 8459 (face font-lock-keyword-face fontified t) 8459 8499 (fontified t) 8499 8502 (face font-lock-string-face fontified t) 8502 8673 (fontified t) 8673 8676 (face font-lock-comment-delimiter-face fontified t) 8676 8734 (face font-lock-comment-face fontified t) 8734 8762 (fontified t) 8762 8765 (face font-lock-keyword-face fontified t) 8765 8785 (fontified t) 8785 8797 (face font-lock-string-face fontified t) 8797 8839 (fontified t) 8839 8841 (face font-lock-keyword-face fontified t) 8841 8942 (fontified t) 8942 8950 (face font-lock-string-face fontified t) 8950 9049 (fontified t) 9049 9078 (face font-lock-string-face fontified t) 9078 9124 (fontified t) 9124 9154 (face font-lock-string-face fontified t) 9154 9167 (fontified t) 9167 9179 (face font-lock-string-face fontified t) 9179 9224 (fontified t) 9224 9254 (face font-lock-string-face fontified t) 9254 9304 (fontified t) 9304 9328 (face font-lock-string-face fontified t) 9328 9377 (fontified t) 9377 9381 (face font-lock-keyword-face fontified t) 9381 9423 (fontified t) 9423 9426 (face font-lock-string-face fontified t) 9426 9466 (fontified t) 9466 9494 (face font-lock-string-face fontified t) 9494 9500 (face font-lock-string-face fontified t) 9500 9501 (fontified t) 9501 9507 (face font-lock-string-face fontified t) 9507 9512 (fontified t) 9512 9585 (fontified t) 9585 9589 (face font-lock-comment-delimiter-face fontified t) 9589 9664 (face font-lock-comment-face fontified t) 9664 9668 (face font-lock-comment-delimiter-face fontified t) 9668 9707 (face font-lock-comment-face fontified t) 9707 9711 (face font-lock-comment-delimiter-face fontified t) 9711 9786 (face font-lock-comment-face fontified t) 9786 9788 (fontified t) 9788 9797 (face font-lock-keyword-face fontified t) 9797 9799 (fontified t) 9799 9816 (face font-lock-builtin-face fontified t) 9816 9817 (fontified t) 9817 9831 (face font-lock-builtin-face fontified t) 9831 9832 (fontified t) 9832 9840 (face font-lock-builtin-face fontified t) 9840 9845 (fontified t) 9845 9851 (face font-lock-keyword-face fontified t) 9851 9866 (fontified t) 9866 9884 (face font-lock-builtin-face fontified t) 9884 9891 (fontified t) 9891 9896 (face font-lock-warning-face fontified t) 9896 9897 (fontified t) 9897 9962 (face font-lock-string-face fontified t) 9962 9968 (fontified t) 9968 9973 (face font-lock-keyword-face fontified t) 9973 9974 (fontified t) 9974 9989 (face font-lock-function-name-face fontified t) 9989 10002 (fontified t) 10002 10068 (face font-lock-doc-face fontified t) 10068 10089 (fontified t) 10089 10094 (face font-lock-builtin-face fontified t) 10094 10095 (fontified t) 10095 10106 (face font-lock-builtin-face fontified t) 10106 10107 (fontified t) 10107 10115 (face font-lock-builtin-face fontified t) 10115 10117 (fontified t) 10117 10122 (face font-lock-builtin-face fontified t) 10122 10131 (fontified t) 10131 10132 (fontified t) 10132 10137 (face font-lock-keyword-face fontified t) 10137 10138 (fontified t) 10138 10147 (face font-lock-function-name-face fontified t) 10147 10153 (fontified t) 10153 10612 (face font-lock-doc-face fontified t) 10612 10616 (fontified t) 10616 10620 (face font-lock-keyword-face fontified t) 10620 10683 (fontified t) 10683 10685 (face font-lock-keyword-face fontified t) 10685 10712 (fontified t) 10712 10717 (face font-lock-builtin-face fontified t) 10717 10718 (fontified t) 10718 10722 (face font-lock-builtin-face fontified t) 10722 10779 (fontified t) 10779 10792 (face font-lock-builtin-face fontified t) 10792 10795 (fontified t) 10795 10797 (face font-lock-keyword-face fontified t) 10797 10807 (fontified t) 10807 10812 (face font-lock-builtin-face fontified t) 10812 10820 (fontified t) 10820 10823 (face font-lock-string-face fontified t) 10823 10882 (fontified t) 10882 10899 (face font-lock-builtin-face fontified t) 10899 10900 (fontified t) 10900 10908 (face font-lock-builtin-face fontified t) 10908 10978 (fontified t) 10978 10991 (face font-lock-builtin-face fontified t) 10991 10992 (fontified t) 10992 11000 (face font-lock-builtin-face fontified t) 11000 11001 (fontified t) 11001 11007 (face font-lock-string-face fontified t) 11007 11012 (fontified t) 11012 11015 (fontified t) 11015 11069 (fontified t) 11069 11082 (face font-lock-builtin-face fontified t) 11082 11086 (fontified t) 11086 11100 (face font-lock-string-face fontified t) 11100 11101 (fontified t) 11101 11116 (face font-lock-string-face fontified t) 11116 11174 (fontified t) 11174 11187 (face font-lock-builtin-face fontified t) 11187 11213 (fontified t) 11213 11218 (face font-lock-string-face fontified t) 11218 11219 (fontified t) 11219 11225 (face font-lock-string-face fontified t) 11225 11226 (fontified t) 11226 11231 (face font-lock-string-face fontified t) 11231 11232 (fontified t) 11232 11239 (face font-lock-string-face fontified t) 11239 11240 (fontified t) 11240 11248 (face font-lock-string-face fontified t) 11248 11249 (fontified t) 11249 11258 (face font-lock-string-face fontified t) 11258 11316 (fontified t) 11316 11328 (face font-lock-builtin-face fontified t) 11328 11347 (fontified t) 11347 11352 (face font-lock-builtin-face fontified t) 11352 11368 (fontified t) 11368 11376 (face font-lock-builtin-face fontified t) 11376 11395 (fontified t) 11395 11407 (face font-lock-builtin-face fontified t) 11407 11424 (fontified t) 11424 11432 (face font-lock-builtin-face fontified t) 11432 11451 (fontified t) 11451 11459 (face font-lock-builtin-face fontified t) 11459 11475 (fontified t) 11475 11483 (face font-lock-builtin-face fontified t) 11483 11500 (fontified t) 11500 11507 (face font-lock-builtin-face fontified t) 11507 11518 (fontified t) 11518 11520 (face font-lock-comment-delimiter-face fontified t) 11520 12047 (face font-lock-comment-face fontified t) 12047 12049 (face font-lock-comment-delimiter-face fontified t) 12049 12050 (fontified t)) . -5300) (undo-tree-id6 . -12050) (undo-tree-id7 . -11385) 17350) nil (26996 50813 362652 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13131 . 13132) (nil fontified nil 5300 . 13132) (5300 . 13132)) nil (26996 50813 362650 0) 0 nil])
([nil nil ((13132 . 13134)) nil (26996 50813 362649 0) 0 nil])
([nil nil ((#("
#|
(defun safe-join (root rel)
  \"ConcatÃ¨ne ROOT et REL en empÃªchant tout Ã©chappement (.., backslashes, drive, etc.).\"
  (print \"IN SAFE JOIN\")
  (let* ((rel* (or rel \"\"))
         ;; remplace backslashes et retire .. :
         (rel1 (substitute #\\/ #\\\\ rel*))
         (rel2 (with-output-to-string (s)
                 (dolist (part (remove-if #'(lambda (p) (or (string= p \"\")
                                                            (string= p \".\")))
                                          (uiop:split-string rel1 :separator \"/\")))
                   (unless (string= part \"..\")
                     (format s \"~A/\" part)))))
         ;; retire le slash final ajoutÃ© si rel ne devait pas en avoir
         (rel3 (if (and (> (length rel2) 0)
                        (char= (char rel2 (1- (length rel2))) #\\/)
                        (not (and (> (length rel1) 0)
                                  (char= (char rel1 (1- (length rel1))) #\\/))))
                  (subseq rel2 0 (1- (length rel2)))
                  rel2))
         (abs (merge-pathnames rel3 (uiop:ensure-directory-pathname (truename root)))))
    ;; sÃ©curitÃ© : lâ€™abs doit rester sous root
    (let* ((root* (namestring (uiop:ensure-directory-pathname (truename root))))
           (abs*  (namestring (truename abs))))
      (if (and (>= (length abs*) (length root*))
               (string= root* abs* :end2 (length root*)))
          abs
          (uiop:merge-pathnames* #P\"__forbidden__\" (truename root))))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 219 (face font-lock-comment-face fontified t) 219 221 (face font-lock-comment-face fontified t) 221 406 (face font-lock-comment-face fontified t) 406 458 (face font-lock-comment-face fontified t) 458 1255 (face font-lock-comment-face fontified t) 1255 1293 (face font-lock-comment-face fontified t) 1293 1486 (face font-lock-comment-face fontified t) 1486 1488 (face font-lock-comment-delimiter-face fontified t)) . 13380) (undo-tree-id5 . -1488)) nil (26996 50813 362649 0) 0 nil])
([nil nil ((13380 . 13381)) nil (26996 50813 362648 0) 0 nil])
([nil nil ((#("(defun read-file-bytes (pathname)
  (with-open-file (in pathname :element-type '(unsigned-byte 8))
    (let* ((size (file-length in))
           (buf  (make-array size :element-type '(unsigned-byte 8))))
      (read-sequence buf in)
      buf)))

(defun safe-join (root rel)
  \"ConcatÃ¨ne ROOT et REL en empÃªchant tout Ã©chappement (.., backslashes, drive, etc.).
   Ne signale pas d'erreur si la cible n'existe pas ; renvoie un pathname sous ROOT.\"
  (labels ((forbidden ()
             ;; retourne une cible sÃ»re sous root qui ne matche rien
             (merge-pathnames #P\"__forbidden__\" (uiop:ensure-directory-pathname (truename root)))))
    (handler-case
        (let* ((rel* (or rel \"\"))
               ;; normalise sÃ©parateurs et purifie les segments
               (rel1 (substitute #\\/ #\\\\ rel*))
               ;; refuse une notation drive Windows \"C:\" en tÃªte
               (drive-pos (position #\\: rel1))
               (starts-with-drive (and drive-pos (= drive-pos 1))) ; ex: \"C:/...\"
               ;; reconstruit sans \".\" ni \"..\"
               (rel2 (with-output-to-string (s)
                       (dolist (part
                                (remove-if (lambda (p) (or (string= p \"\")
                                                           (string= p \".\")
                                                           (string= p \"..\")))
                                           (uiop:split-string rel1 :separator \"/\")))
                         (when (> (length part) 0)
                           (format s \"~A/\" part)))))
               ;; retire Ã©ventuellement le slash final ajoutÃ© si lâ€™original nâ€™en avait pas
               (rel3 (if (and (> (length rel2) 0)
                              (char= (char rel2 (1- (length rel2))) #\\/)
                              (not (and (> (length rel1) 0)
                                        (char= (char rel1 (1- (length rel1))) #\\/))))
                         (subseq rel2 0 (1- (length rel2)))
                         rel2))
               (root-dir (uiop:ensure-directory-pathname (truename root)))
               ;; IMPORTANT : ne pas faire (truename abs) ici !
               (abs (merge-pathnames rel3 root-dir)))
          (if starts-with-drive
              (forbidden)
              ;; VÃ©rification simple de confinement (au cas oÃ¹)
              (let* ((root-str (namestring root-dir))
                     (abs-str  (namestring (uiop:ensure-pathname abs))))
                (if (and (>= (length abs-str) (length root-str))
                         (string= root-str abs-str :end2 (length root-str)))
                    abs
                    (forbidden)))))
      (error () (forbidden)))))

(defun directory-index-html (dir rel-url &key (hide-dotfiles t))
  \"GÃ©nÃ¨re un index HTML simple pour DIR.
REL-URL doit commencer par / et prÃ©ciser le chemin demandÃ© (avec / final pour les dossiers).\"
  (let* ((rel (or rel-url \"/\"))
         (rel* (if (char= (char rel (1- (length rel))) #\\/) rel (concatenate 'string rel \"/\")))
         (files (uiop:directory-files dir))
         (subs  (uiop:subdirectories dir)))
    (labels ((visible-p (pn)
               (let ((name (car (last (uiop:split-string (namestring pn) :separator \"/\")))))
                 (or (not hide-dotfiles)
                     (and name (not (and (> (length name) 0) (char= (char name 0) #\\.))))))))
      (with-output-to-string (s)
        (format s \"<!doctype html><meta charset='utf-8'><title>Index of ~A</title>\" rel*)
        (format s \"<style>body{font:14px system-ui,Segoe UI,Roboto,sans-serif;margin:24px}ul{list-style:none;padding-left:0}li{margin:2px 0}</style>\")
        (format s \"<h1>Index of ~A</h1><ul>\" rel*)
        (when (> (length rel*) 1)
          ;; lien vers le parent
          (let* ((trim (if (char= (char rel* (1- (length rel*))) #\\/)
                           (subseq rel* 0 (1- (length rel*)))
                           rel*))
                 (pidx (or (position #\\/ trim :from-end t) 0))
                 (up (if (= pidx 0) \"/\" (subseq trim 0 pidx))))
            (format s \"<li>â†©ï¸Ž <a href='~A'>..</a></li>\" up)))
        (dolist (sd (sort (remove-if-not #'visible-p subs) #'string< :key #'namestring))
          (let* ((nm (car (last (uiop:split-string (namestring sd) :separator \"/\")))))
            (format s \"<li>ðŸ“ <a href='~A/'>~A/</a></li>\" nm nm)))
        (dolist (f (sort (remove-if-not #'visible-p files) #'string< :key #'namestring))
          (let* ((nm (car (last (uiop:split-string (namestring f) :separator \"/\")))))
            (format s \"<li>ðŸ“„ <a href='~A'>~A</a></li>\" nm nm)))
        (format s \"</ul>\")))))

(defun method-get-or-head-p (req)
  (let ((m (slot-value req 'lumen.core.http::method)))
    (or (string= m \"GET\") (string= m \"HEAD\"))))

(defun %file-rfc1123 (pn)
  (let ((ut (ignore-errors (file-write-date pn))))
    (and ut (lumen.utils:format-http-date ut))))

(defun %weak-etag-from-file (pn)
  \"Weak ETag sans lecture du contenu: taille+mtime.\"
  (handler-case
      (let* ((size (with-open-file (in pn :direction :input :element-type '(unsigned-byte 8))
                     (file-length in)))
             (mt   (file-write-date pn)))
        (format nil \"W/\\\"~X-~X\\\"\" size mt))
    (error () nil)))

;;; ---------- Static middleware ------------------------------------------------
(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
                 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR (200 plein + Range/206).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (labels
        ;; ---------- Helpers ----------
        ((read-file-bytes (pn)
           (with-open-file (in pn :direction :input :element-type '(unsigned-byte 8))
             (let* ((len (file-length in))
                    (buf (make-array len :element-type '(unsigned-byte 8))))
               (read-sequence buf in)
               buf)))

         (file-size (pn)
           (with-open-file (in pn :direction :input :element-type '(unsigned-byte 8))
             (file-length in)))

         (header (req name)
           (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal)))

         (ensure-h (hdrs k v)
           (lumen.utils:ensure-header hdrs k v))

         (vary-accept-encoding (resp)
           (setf (lumen.core.http:resp-headers resp)
                 (ensure-h (lumen.core.http:resp-headers resp) \"Vary\" \"Accept-Encoding\"))
           resp)

         ;; Parse simple â€œRange: bytes=start-endâ€ (une seule plage). Retourne (values start end ok?)
         (parse-range (s total)
           (handler-case
               (progn
                 (cl-ppcre:register-groups-bind (a b)
                     (\"^bytes=([0-9]*)-([0-9]*)$\" (string-trim '(#\\Space) s))
                   (let* ((sa (and a (> (length a) 0) (parse-integer a :junk-allowed t)))
                          (sb (and b (> (length b) 0) (parse-integer b :junk-allowed t))))
                     (cond
                       ;; bytes=START- (jusqu'Ã  fin)
                       ((and sa (null sb) (>= sa 0) (< sa total))
                        (values sa (1- total) t))
                       ;; bytes=-SUFFIX  (les sb derniers octets)
                       ((and (null sa) sb (> sb 0))
                        (let* ((len (min sb total))
                               (st  (- total len)))
                          (values st (1- total) t)))
                       ;; bytes=START-END
                       ((and sa sb (>= sa 0) (>= sb sa) (< sa total))
                        (values sa (min sb (1- total)) t))
                       (t (values 0 0 nil))))))
             (error () (values 0 0 nil))))

         ;; 200 plein (octets) â€“ HEAD renvoie juste les headers.
         (serve-file-200 (req pn &key content-type cache-secs etag last-modified)
           (let* ((ct   (or content-type (lumen.core.mime:guess-content-type pn)))
                  (lm   last-modified)
                  (etag etag)
                  (hdrs (list (cons \"content-type\" ct)
                              (cons \"accept-ranges\" \"bytes\")
                              (cons \"cache-control\" (format nil \"public, max-age=~D\" (or cache-secs 0))))))
             (when lm   (setf hdrs (ensure-h hdrs \"last-modified\" lm)))
             (when etag (setf hdrs (ensure-h hdrs \"etag\"           etag)))
             (if (string= (lumen.core.http:req-method req) \"HEAD\")
                 (make-instance 'lumen.core.http:response
                                :status 200 :headers hdrs :body \"\")
               (make-instance 'lumen.core.http:response
                              :status 200 :headers hdrs :body (read-file-bytes pn)))))

         ;; 206 Range â€“ writer **bornÃ©** (retourne) + Content-Length exact.
         (serve-file-206 (req pn start end &key content-type cache-secs etag last-modified)
           (let* ((total (file-size pn))
                  (len   (max 0 (1+ (- end start))))
                  (ct    (or content-type (lumen.core.mime:guess-content-type pn)))
                  (hdrs  (list
                          (cons \"content-type\" ct)
                          (cons \"accept-ranges\" \"bytes\")
                          (cons \"content-range\" (format nil \"bytes ~D-~D/~D\" start end total))
                          (cons \"content-length\" (write-to-string len))
                          (cons \"cache-control\" (format nil \"public, max-age=~D\" (or cache-secs 0))))))
             (when last-modified (setf hdrs (ensure-h hdrs \"last-modified\" last-modified)))
             (when etag          (setf hdrs (ensure-h hdrs \"etag\"          etag)))
             (if (string= (lumen.core.http:req-method req) \"HEAD\")
                 (make-instance 'lumen.core.http:response
                                :status 206 :headers hdrs :body \"\")
               (make-instance 'lumen.core.http:response
                              :status 206
                              :headers hdrs
                              :body (lambda (send)
                                      (with-open-file (in pn :direction :input :element-type '(unsigned-byte 8))
                                        (file-position in start)
                                        (let ((buf (make-array (min len 65536)
                                                               :element-type '(unsigned-byte 8)))
                                              (left len))
                                          (loop while (> left 0) do
                                            (let* ((n (min left (length buf)))
                                                   (rd (read-sequence buf in :end n)))
                                              (when (or (null rd) (= rd 0)) (return))
                                              (funcall send (if (= rd (length buf))
                                                                buf
                                                                (subseq buf 0 rd)))
                                              (decf left rd))))))))))
         )

      (lambda (next)
        (lambda (req)
          (let ((path (lumen.core.http:req-path req)))
            (if (and (>= (length path) plen)
                     (string= prefix* path :end2 plen))
                (let* ((rel    (subseq path plen)) ; \"\" ou \"foo/bar\"
                       (target (safe-join root* rel))
                       (dir-truename (ignore-errors (lumen.utils:probe-directory target)))
                       (rng-h (header req \"Range\")))
                  (handler-case
                      (cond
                        ;; -------- Dossier ----------
                        (dir-truename
                         (let* ((has-slash (and (> (length path) 0)
                                                (char= (char path (1- (length path))) #\\/)))
                                (dir* (uiop:ensure-directory-pathname dir-truename)))
                           (cond
                             ;; /dir â†’ /dir/ (301)
                             ((and redirect-dir (not has-slash))
                              (make-instance 'lumen.core.http:response
                                             :status 301
                                             :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body \"\"))

                             ;; index.html prÃ©sent
                             ((and try-index (probe-file (merge-pathnames try-index dir*)))
                              (let* ((pn   (merge-pathnames try-index dir*))
                                     (ct   (lumen.core.mime:guess-content-type pn))
                                     (lm   (%file-rfc1123 pn))
                                     (etag (%weak-etag-from-file pn)))
                                (multiple-value-bind (st en ok)
                                    (and rng-h (parse-range rng-h (file-size pn)))
                                  (let ((resp (if ok
                                                  (serve-file-206 req pn st en
                                                                  :content-type ct
                                                                  :cache-secs dir-cache-secs
                                                                  :etag etag
                                                                  :last-modified lm)
                                                  (serve-file-200 req pn
                                                                  :content-type ct
                                                                  :cache-secs dir-cache-secs
                                                                  :etag etag
                                                                  :last-modified lm))))
                                    (vary-accept-encoding resp)))))

                             ;; listing auto
                             (auto-index
                              (let* ((html (directory-index-html
                                            dir* (if (plusp (length path)) path \"/\")
                                            :hide-dotfiles hide-dotfiles))
                                     (lm   (%file-rfc1123 dir*))
                                     (hdrs (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                 (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))))
                                (when lm
                                  (setf hdrs (ensure-h hdrs \"last-modified\" lm)))
                                (make-instance 'lumen.core.http:response
                                               :status 200 :headers hdrs :body html)))

                             ;; pas d'index â†’ SPA fallback ?
                             (t
                              (if (and spa-fallback (method-get-or-head-p req)
                                       (probe-file (merge-pathnames spa-fallback root*)))
                                  (let* ((pn   (merge-pathnames spa-fallback root*))
                                         (lm   (%file-rfc1123 pn))
                                         (resp (serve-file-200 req pn
                                                               :content-type \"text/html; charset=utf-8\"
                                                               :cache-secs 0
                                                               :last-modified lm)))
                                    ;; SPA : no-store
                                    (setf (lumen.core.http:resp-headers resp)
                                          (ensure-h (lumen.core.http:resp-headers resp)
                                                    \"cache-control\" \"no-store\"))
                                    resp)
                                  (lumen.core.http:respond-404 \"Directory index disabled\"))))))

                        ;; -------- Fichier ----------
                        ((probe-file target)
                         (let* ((ct   (lumen.core.mime:guess-content-type target))
                                (lm   (%file-rfc1123 target))
                                (etag (%weak-etag-from-file target)))
                           (multiple-value-bind (st en ok)
                               (and rng-h (parse-range rng-h (file-size target)))
                             (let ((resp (if ok
                                             (serve-file-206 req target st en
                                                             :content-type ct
                                                             :cache-secs file-cache-secs
                                                             :etag etag
                                                             :last-modified lm)
                                             (serve-file-200 req target
                                                             :content-type ct
                                                             :cache-secs file-cache-secs
                                                             :etag etag
                                                             :last-modified lm))))
                               (vary-accept-encoding resp)))))

                        ;; -------- Rien pour ce prefix ----------
                        (t
                         (if (and spa-fallback (method-get-or-head-p req)
                                  (probe-file (merge-pathnames spa-fallback root*)))
                             (let* ((pn   (merge-pathnames spa-fallback root*))
                                    (lm   (%file-rfc1123 pn))
                                    (resp (serve-file-200 req pn
                                                          :content-type \"text/html; charset=utf-8\"
                                                          :cache-secs 0
                                                          :last-modified lm)))
                               (setf (lumen.core.http:resp-headers resp)
                                     (ensure-h (lumen.core.http:resp-headers resp)
                                               \"cache-control\" \"no-store\"))
                               resp)
                             (funcall next req))))
                    (error ()
                      (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passer au suivant
              (funcall next req))))))))
 
(defun static-many (&rest mounts)
  \"Monte plusieurs middlewares static en cascade.
MOUNTS: soit des PLISTs pour (static ...), soit des factories (next->handler).\"
  (let* ((factories
           (mapcar (lambda (m)
                     (etypecase m
                       (function m)                 ; dÃ©jÃ  une factory
                       (list     (apply #'static m)))) ; spec â†’ factory
                   mounts)))
    (lambda (next)
      (let ((acc next))
        (dolist (f (reverse factories) acc)
          (let ((wrapped (funcall f acc)))
            (unless (functionp wrapped)
              (error \"static-many: chaque element doit etre une FACTORY (next->handler). ~
                      Cet element a retourne ~S, pas une fonction. ~%~
                      Indice: ne passe pas un HANDLER (req->resp), mais une FACTORY.\"
                     wrapped))
            (setf acc wrapped)))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 22 (face font-lock-function-name-face fontified t) 22 37 (fontified t) 37 51 (face font-lock-keyword-face fontified t) 51 65 (fontified t) 65 78 (face font-lock-builtin-face fontified t) 78 104 (fontified t) 104 108 (face font-lock-keyword-face fontified t) 108 168 (fontified t) 168 181 (face font-lock-builtin-face fontified t) 181 233 (fontified t) 233 246 (fontified t) 246 247 (fontified t) 247 248 (fontified t) 248 253 (face font-lock-keyword-face fontified t) 253 254 (fontified t) 254 263 (face font-lock-function-name-face fontified t) 263 277 (fontified t) 277 447 (face font-lock-doc-face fontified t) 447 451 (fontified t) 451 457 (face font-lock-keyword-face fontified t) 457 479 (fontified t) 479 486 (fontified t) 486 489 (face font-lock-comment-delimiter-face fontified t) 489 542 (face font-lock-comment-face fontified t) 542 574 (fontified t) 574 589 (face font-lock-string-face fontified t) 589 647 (fontified t) 647 659 (face font-lock-keyword-face fontified t) 659 669 (fontified t) 669 673 (face font-lock-keyword-face fontified t) 673 689 (fontified t) 689 691 (face font-lock-string-face fontified t) 691 709 (fontified t) 709 712 (face font-lock-comment-delimiter-face fontified t) 712 716 (face font-lock-comment-face fontified t) 716 758 (face font-lock-comment-face fontified t) 758 821 (fontified t) 821 824 (face font-lock-comment-delimiter-face fontified t) 824 871 (face font-lock-comment-face fontified t) 871 985 (fontified t) 985 1000 (face font-lock-comment-face fontified t) 1000 1015 (fontified t) 1015 1018 (face font-lock-comment-delimiter-face fontified t) 1018 1047 (face font-lock-comment-face fontified t) 1047 1069 (fontified t) 1069 1090 (face font-lock-keyword-face fontified t) 1090 1119 (fontified t) 1119 1125 (face font-lock-keyword-face fontified t) 1125 1176 (fontified t) 1176 1182 (face font-lock-keyword-face fontified t) 1182 1202 (fontified t) 1202 1204 (face font-lock-string-face fontified t) 1204 1276 (fontified t) 1276 1279 (face font-lock-string-face fontified t) 1279 1351 (fontified t) 1351 1355 (face font-lock-string-face fontified t) 1355 1426 (fontified t) 1426 1436 (face font-lock-builtin-face fontified t) 1436 1437 (fontified t) 1437 1440 (face font-lock-string-face fontified t) 1440 1470 (fontified t) 1470 1474 (face font-lock-keyword-face fontified t) 1474 1532 (fontified t) 1532 1537 (face font-lock-string-face fontified t) 1537 1551 (fontified t) 1551 1563 (fontified t) 1563 1566 (face font-lock-comment-delimiter-face fontified t) 1566 1639 (face font-lock-comment-face fontified t) 1639 1661 (fontified t) 1661 1663 (face font-lock-keyword-face fontified t) 1663 1734 (fontified t) 1734 1747 (fontified t) 1747 1762 (fontified t) 1762 2042 (fontified t) 2042 2075 (fontified t) 2075 2090 (fontified t) 2090 2093 (face font-lock-comment-delimiter-face fontified t) 2093 2139 (face font-lock-comment-face fontified t) 2139 2204 (fontified t) 2204 2206 (face font-lock-keyword-face fontified t) 2206 2265 (fontified t) 2265 2268 (face font-lock-comment-delimiter-face fontified t) 2268 2315 (face font-lock-comment-face fontified t) 2315 2330 (fontified t) 2330 2334 (face font-lock-keyword-face fontified t) 2334 2459 (fontified t) 2459 2461 (face font-lock-keyword-face fontified t) 2461 2558 (fontified t) 2558 2563 (face font-lock-builtin-face fontified t) 2563 2651 (fontified t) 2651 2656 (face font-lock-warning-face fontified t) 2656 2677 (fontified t) 2677 2678 (fontified t) 2678 2683 (face font-lock-keyword-face fontified t) 2683 2684 (fontified t) 2684 2704 (face font-lock-function-name-face fontified t) 2704 2718 (fontified t) 2718 2722 (face font-lock-type-face fontified t) 2722 2744 (fontified t) 2744 2876 (face font-lock-doc-face fontified t) 2876 2880 (fontified t) 2880 2884 (face font-lock-keyword-face fontified t) 2884 2903 (fontified t) 2903 2906 (face font-lock-string-face fontified t) 2906 2925 (fontified t) 2925 2927 (face font-lock-keyword-face fontified t) 2927 2998 (fontified t) 2998 3001 (face font-lock-string-face fontified t) 3001 3098 (fontified t) 3098 3104 (face font-lock-keyword-face fontified t) 3104 3138 (fontified t) 3138 3141 (face font-lock-keyword-face fontified t) 3141 3195 (fontified t) 3195 3205 (face font-lock-builtin-face fontified t) 3205 3206 (fontified t) 3206 3209 (face font-lock-string-face fontified t) 3209 3262 (fontified t) 3262 3350 (fontified t) 3350 3357 (fontified t) 3357 3378 (face font-lock-keyword-face fontified t) 3378 3401 (fontified t) 3401 3466 (face font-lock-string-face fontified t) 3466 3491 (fontified t) 3491 3575 (face font-lock-string-face fontified t) 3575 3622 (face font-lock-string-face fontified t) 3622 3624 (fontified t) 3624 3642 (fontified t) 3642 3668 (face font-lock-string-face fontified t) 3668 3684 (fontified t) 3684 3688 (face font-lock-keyword-face fontified t) 3688 3719 (fontified t) 3719 3722 (face font-lock-comment-delimiter-face fontified t) 3722 3742 (face font-lock-comment-face fontified t) 3742 3753 (fontified t) 3753 3757 (face font-lock-keyword-face fontified t) 3757 3766 (fontified t) 3766 3768 (face font-lock-keyword-face fontified t) 3768 3954 (fontified t) 3954 3963 (face font-lock-builtin-face fontified t) 3963 3993 (fontified t) 3993 3995 (face font-lock-keyword-face fontified t) 3995 4007 (fontified t) 4007 4010 (face font-lock-string-face fontified t) 4010 4057 (fontified t) 4057 4090 (face font-lock-string-face fontified t) 4090 4106 (fontified t) 4106 4112 (face font-lock-keyword-face fontified t) 4112 4166 (fontified t) 4166 4170 (face font-lock-builtin-face fontified t) 4170 4197 (fontified t) 4197 4201 (face font-lock-keyword-face fontified t) 4201 4253 (fontified t) 4253 4263 (face font-lock-builtin-face fontified t) 4263 4264 (fontified t) 4264 4267 (face font-lock-string-face fontified t) 4267 4295 (fontified t) 4295 4329 (face font-lock-string-face fontified t) 4329 4348 (fontified t) 4348 4354 (face font-lock-keyword-face fontified t) 4354 4408 (fontified t) 4408 4412 (face font-lock-builtin-face fontified t) 4412 4439 (fontified t) 4439 4443 (face font-lock-keyword-face fontified t) 4443 4494 (fontified t) 4494 4504 (face font-lock-builtin-face fontified t) 4504 4505 (fontified t) 4505 4508 (face font-lock-string-face fontified t) 4508 4536 (fontified t) 4536 4568 (face font-lock-string-face fontified t) 4568 4596 (fontified t) 4596 4603 (face font-lock-string-face fontified t) 4603 4611 (fontified t) 4611 4616 (face font-lock-keyword-face fontified t) 4616 4617 (fontified t) 4617 4637 (face font-lock-function-name-face fontified t) 4637 4647 (fontified t) 4647 4650 (face font-lock-keyword-face fontified t) 4650 4718 (fontified t) 4718 4723 (face font-lock-string-face fontified t) 4723 4736 (fontified t) 4736 4742 (face font-lock-string-face fontified t) 4742 4749 (fontified t) 4749 4754 (face font-lock-keyword-face fontified t) 4754 4755 (fontified t) 4755 4768 (face font-lock-function-name-face fontified t) 4768 4777 (fontified t) 4777 4780 (face font-lock-keyword-face fontified t) 4780 4787 (fontified t) 4787 4800 (face font-lock-keyword-face fontified t) 4800 4850 (fontified t) 4850 4874 (fontified t) 4874 4875 (fontified t) 4875 4876 (fontified t) 4876 4881 (face font-lock-keyword-face fontified t) 4881 4882 (fontified t) 4882 4902 (face font-lock-function-name-face fontified t) 4902 4910 (fontified t) 4910 4960 (face font-lock-doc-face fontified t) 4960 4964 (fontified t) 4964 4976 (face font-lock-keyword-face fontified t) 4976 4984 (fontified t) 4984 4988 (face font-lock-keyword-face fontified t) 4988 4997 (fontified t) 4997 5011 (face font-lock-keyword-face fontified t) 5011 5019 (fontified t) 5019 5029 (face font-lock-builtin-face fontified t) 5029 5030 (fontified t) 5030 5036 (face font-lock-builtin-face fontified t) 5036 5037 (fontified t) 5037 5050 (face font-lock-builtin-face fontified t) 5050 5124 (fontified t) 5124 5153 (fontified t) 5153 5173 (fontified t) 5173 5186 (face font-lock-string-face fontified t) 5186 5202 (fontified t) 5202 5207 (face font-lock-warning-face fontified t) 5207 5219 (fontified t) 5219 5223 (face font-lock-comment-delimiter-face fontified t) 5223 5301 (face font-lock-comment-face fontified t) 5301 5302 (fontified t) 5302 5307 (face font-lock-keyword-face fontified t) 5307 5308 (fontified t) 5308 5314 (face font-lock-function-name-face fontified t) 5314 5316 (fontified t) 5316 5320 (face font-lock-type-face fontified t) 5320 5392 (fontified t) 5392 5404 (face font-lock-string-face fontified t) 5404 5592 (fontified t) 5592 5690 (face font-lock-doc-face fontified t) 5690 5694 (fontified t) 5694 5698 (face font-lock-keyword-face fontified t) 5698 5720 (fontified t) 5720 5723 (face font-lock-string-face fontified t) 5723 5802 (fontified t) 5802 5808 (face font-lock-keyword-face fontified t) 5808 5817 (fontified t) 5817 5820 (face font-lock-comment-delimiter-face fontified t) 5820 5850 (face font-lock-comment-face fontified t) 5850 5893 (fontified t) 5893 5907 (face font-lock-keyword-face fontified t) 5907 5915 (fontified t) 5915 5925 (face font-lock-builtin-face fontified t) 5925 5926 (fontified t) 5926 5932 (face font-lock-builtin-face fontified t) 5932 5933 (fontified t) 5933 5946 (face font-lock-builtin-face fontified t) 5946 5981 (fontified t) 5981 5985 (face font-lock-keyword-face fontified t) 5985 6051 (fontified t) 6051 6064 (face font-lock-builtin-face fontified t) 6064 6185 (fontified t) 6185 6199 (face font-lock-keyword-face fontified t) 6199 6207 (fontified t) 6207 6217 (face font-lock-builtin-face fontified t) 6217 6218 (fontified t) 6218 6224 (face font-lock-builtin-face fontified t) 6224 6225 (fontified t) 6225 6238 (face font-lock-builtin-face fontified t) 6238 6374 (fontified t) 6374 6382 (fontified t) 6382 6387 (face font-lock-builtin-face fontified t) 6387 6406 (fontified t) 6406 6641 (fontified t) 6641 6647 (face font-lock-string-face fontified t) 6647 6648 (fontified t) 6648 6653 (face font-lock-string-face fontified t) 6653 6665 (face font-lock-string-face fontified t) 6665 6668 (fontified t) 6668 6695 (fontified t) 6695 6698 (face font-lock-comment-delimiter-face fontified t) 6698 6787 (face font-lock-comment-face fontified t) 6787 6831 (fontified t) 6831 6843 (face font-lock-keyword-face fontified t) 6843 6860 (fontified t) 6860 6865 (face font-lock-keyword-face fontified t) 6865 6942 (fontified t) 6942 6969 (face font-lock-string-face fontified t) 6969 7018 (fontified t) 7018 7022 (face font-lock-keyword-face fontified t) 7022 7069 (fontified t) 7069 7082 (face font-lock-builtin-face fontified t) 7082 7159 (fontified t) 7159 7172 (face font-lock-builtin-face fontified t) 7172 7201 (fontified t) 7201 7205 (face font-lock-keyword-face fontified t) 7205 7229 (fontified t) 7229 7232 (face font-lock-comment-delimiter-face fontified t) 7232 7259 (face font-lock-comment-face fontified t) 7259 7398 (fontified t) 7398 7401 (face font-lock-comment-delimiter-face fontified t) 7401 7441 (face font-lock-comment-face fontified t) 7441 7518 (fontified t) 7518 7522 (face font-lock-keyword-face fontified t) 7522 7673 (fontified t) 7673 7676 (face font-lock-comment-delimiter-face fontified t) 7676 7692 (face font-lock-comment-face fontified t) 7692 7883 (fontified t) 7883 7888 (face font-lock-warning-face fontified t) 7888 7906 (fontified t) 7906 7912 (fontified t) 7912 7922 (fontified t) 7922 7925 (face font-lock-comment-delimiter-face fontified t) 7925 7978 (face font-lock-comment-face fontified t) 7978 8011 (fontified t) 8011 8015 (face font-lock-type-face fontified t) 8015 8072 (fontified t) 8072 8076 (face font-lock-keyword-face fontified t) 8076 8248 (fontified t) 8248 8262 (face font-lock-string-face fontified t) 8262 8303 (fontified t) 8303 8318 (face font-lock-string-face fontified t) 8318 8319 (fontified t) 8319 8326 (face font-lock-string-face fontified t) 8326 8364 (fontified t) 8364 8379 (face font-lock-string-face fontified t) 8379 8392 (fontified t) 8392 8412 (face font-lock-string-face fontified t) 8412 8450 (fontified t) 8450 8454 (face font-lock-keyword-face fontified t) 8454 8486 (fontified t) 8486 8501 (face font-lock-string-face fontified t) 8501 8522 (fontified t) 8522 8526 (face font-lock-keyword-face fontified t) 8526 8558 (fontified t) 8558 8564 (face font-lock-string-face fontified t) 8564 8597 (fontified t) 8597 8599 (face font-lock-keyword-face fontified t) 8599 8642 (fontified t) 8642 8648 (face font-lock-string-face fontified t) 8648 8740 (fontified t) 8740 8747 (face font-lock-builtin-face fontified t) 8747 8752 (fontified t) 8752 8760 (face font-lock-builtin-face fontified t) 8760 8766 (fontified t) 8766 8771 (face font-lock-builtin-face fontified t) 8771 8772 (fontified t) 8772 8774 (face font-lock-string-face fontified t) 8774 8862 (fontified t) 8862 8869 (face font-lock-builtin-face fontified t) 8869 8874 (fontified t) 8874 8882 (face font-lock-builtin-face fontified t) 8882 8888 (fontified t) 8888 8893 (face font-lock-builtin-face fontified t) 8893 8929 (fontified t) 8929 8932 (face font-lock-comment-delimiter-face fontified t) 8932 8996 (face font-lock-comment-face fontified t) 8996 9039 (fontified t) 9039 9043 (face font-lock-type-face fontified t) 9043 9100 (fontified t) 9100 9104 (face font-lock-keyword-face fontified t) 9104 9329 (fontified t) 9329 9343 (face font-lock-string-face fontified t) 9343 9380 (fontified t) 9380 9395 (face font-lock-string-face fontified t) 9395 9396 (fontified t) 9396 9403 (face font-lock-string-face fontified t) 9403 9412 (fontified t) 9412 9437 (fontified t) 9437 9452 (face font-lock-string-face fontified t) 9452 9465 (fontified t) 9465 9481 (face font-lock-string-face fontified t) 9481 9500 (fontified t) 9500 9532 (fontified t) 9532 9548 (face font-lock-string-face fontified t) 9548 9604 (fontified t) 9604 9619 (face font-lock-string-face fontified t) 9619 9632 (fontified t) 9632 9652 (face font-lock-string-face fontified t) 9652 9690 (fontified t) 9690 9694 (face font-lock-keyword-face fontified t) 9694 9735 (fontified t) 9735 9750 (face font-lock-string-face fontified t) 9750 9782 (fontified t) 9782 9786 (face font-lock-keyword-face fontified t) 9786 9827 (fontified t) 9827 9833 (face font-lock-string-face fontified t) 9833 9865 (fontified t) 9865 9867 (face font-lock-keyword-face fontified t) 9867 9910 (fontified t) 9910 9916 (face font-lock-string-face fontified t) 9916 10008 (fontified t) 10008 10015 (face font-lock-builtin-face fontified t) 10015 10020 (fontified t) 10020 10028 (face font-lock-builtin-face fontified t) 10028 10034 (fontified t) 10034 10039 (face font-lock-builtin-face fontified t) 10039 10040 (fontified t) 10040 10042 (face font-lock-string-face fontified t) 10042 10130 (fontified t) 10130 10137 (face font-lock-builtin-face fontified t) 10137 10172 (fontified t) 10172 10180 (face font-lock-builtin-face fontified t) 10180 10216 (fontified t) 10216 10221 (face font-lock-builtin-face fontified t) 10221 10223 (fontified t) 10223 10229 (face font-lock-keyword-face fontified t) 10229 10276 (fontified t) 10276 10290 (face font-lock-keyword-face fontified t) 10290 10298 (fontified t) 10298 10308 (face font-lock-builtin-face fontified t) 10308 10309 (fontified t) 10309 10315 (face font-lock-builtin-face fontified t) 10315 10316 (fontified t) 10316 10329 (face font-lock-builtin-face fontified t) 10329 10456 (fontified t) 10456 10459 (face font-lock-keyword-face fontified t) 10459 10557 (fontified t) 10557 10570 (face font-lock-builtin-face fontified t) 10570 10693 (fontified t) 10693 10697 (face font-lock-keyword-face fontified t) 10697 10763 (fontified t) 10763 10767 (face font-lock-keyword-face fontified t) 10767 10874 (fontified t) 10874 10878 (face font-lock-builtin-face fontified t) 10878 10931 (fontified t) 10931 10935 (face font-lock-keyword-face fontified t) 10935 10961 (fontified t) 10961 10967 (face font-lock-keyword-face fontified t) 10967 11000 (fontified t) 11000 11031 (fontified t) 11031 11033 (face font-lock-keyword-face fontified t) 11033 11054 (fontified t) 11054 11295 (fontified t) 11295 11301 (face font-lock-keyword-face fontified t) 11301 11318 (fontified t) 11318 11324 (face font-lock-keyword-face fontified t) 11324 11342 (fontified t) 11342 11345 (face font-lock-keyword-face fontified t) 11345 11399 (fontified t) 11399 11401 (face font-lock-keyword-face fontified t) 11401 11474 (fontified t) 11474 11479 (face font-lock-builtin-face fontified t) 11479 11504 (fontified t) 11504 11508 (face font-lock-keyword-face fontified t) 11508 11538 (fontified t) 11538 11556 (face font-lock-comment-face fontified t) 11556 11648 (fontified t) 11648 11661 (face font-lock-keyword-face fontified t) 11661 11743 (fontified t) 11743 11750 (face font-lock-string-face fontified t) 11750 11773 (fontified t) 11773 11785 (face font-lock-keyword-face fontified t) 11785 11809 (fontified t) 11809 11813 (face font-lock-keyword-face fontified t) 11813 11838 (fontified t) 11838 11841 (face font-lock-comment-delimiter-face fontified t) 11841 11869 (face font-lock-comment-face fontified t) 11869 11933 (fontified t) 11933 11937 (face font-lock-keyword-face fontified t) 11937 12182 (fontified t) 12182 12186 (face font-lock-keyword-face fontified t) 12186 12216 (fontified t) 12216 12219 (face font-lock-comment-delimiter-face fontified t) 12219 12238 (face font-lock-comment-face fontified t) 12238 12419 (fontified t) 12419 12426 (face font-lock-builtin-face fontified t) 12426 12476 (fontified t) 12476 12484 (face font-lock-builtin-face fontified t) 12484 12497 (fontified t) 12497 12507 (face font-lock-string-face fontified t) 12507 12534 (fontified t) 12534 12537 (face font-lock-string-face fontified t) 12537 12554 (fontified t) 12554 12606 (fontified t) 12606 12621 (face font-lock-string-face fontified t) 12621 12634 (fontified t) 12634 12654 (face font-lock-string-face fontified t) 12654 12673 (fontified t) 12673 12718 (fontified t) 12718 12723 (face font-lock-builtin-face fontified t) 12723 12724 (fontified t) 12724 12726 (face font-lock-string-face fontified t) 12726 12759 (fontified t) 12759 12762 (face font-lock-comment-delimiter-face fontified t) 12762 12781 (face font-lock-comment-face fontified t) 12781 12904 (fontified t) 12904 12908 (face font-lock-keyword-face fontified t) 12908 13201 (fontified t) 13201 13220 (face font-lock-keyword-face fontified t) 13220 13350 (fontified t) 13350 13353 (face font-lock-keyword-face fontified t) 13353 13362 (fontified t) 13362 13364 (face font-lock-keyword-face fontified t) 13364 13513 (fontified t) 13513 13526 (face font-lock-builtin-face fontified t) 13526 13596 (fontified t) 13596 13607 (face font-lock-builtin-face fontified t) 13607 13689 (fontified t) 13689 13694 (face font-lock-builtin-face fontified t) 13694 13766 (fontified t) 13766 13780 (face font-lock-builtin-face fontified t) 13780 13924 (fontified t) 13924 13937 (face font-lock-builtin-face fontified t) 13937 14007 (fontified t) 14007 14018 (face font-lock-builtin-face fontified t) 14018 14100 (fontified t) 14100 14105 (face font-lock-builtin-face fontified t) 14105 14173 (fontified t) 14173 14177 (fontified t) 14177 14191 (face font-lock-builtin-face fontified t) 14191 14199 (fontified t) 14199 14297 (fontified t) 14297 14300 (face font-lock-comment-delimiter-face fontified t) 14300 14313 (face font-lock-comment-face fontified t) 14313 14385 (fontified t) 14385 14389 (face font-lock-keyword-face fontified t) 14389 14469 (fontified t) 14469 14471 (face font-lock-keyword-face fontified t) 14471 14499 (fontified t) 14499 14502 (face font-lock-string-face fontified t) 14502 14548 (fontified t) 14548 14562 (face font-lock-builtin-face fontified t) 14562 14699 (fontified t) 14699 14713 (face font-lock-string-face fontified t) 14713 14714 (fontified t) 14714 14740 (face font-lock-string-face fontified t) 14740 14797 (fontified t) 14797 14812 (face font-lock-string-face fontified t) 14812 14825 (fontified t) 14825 14845 (face font-lock-string-face fontified t) 14845 14899 (fontified t) 14899 14903 (face font-lock-keyword-face fontified t) 14903 14967 (fontified t) 14967 14982 (face font-lock-string-face fontified t) 14982 15109 (fontified t) 15109 15116 (face font-lock-builtin-face fontified t) 15116 15121 (fontified t) 15121 15129 (face font-lock-builtin-face fontified t) 15129 15135 (fontified t) 15135 15140 (face font-lock-builtin-face fontified t) 15140 15179 (fontified t) 15179 15182 (face font-lock-comment-delimiter-face fontified t) 15182 15211 (face font-lock-comment-face fontified t) 15211 15274 (fontified t) 15274 15276 (face font-lock-keyword-face fontified t) 15276 15447 (fontified t) 15447 15451 (face font-lock-keyword-face fontified t) 15451 15697 (fontified t) 15697 15699 (face font-lock-builtin-face fontified t) 15699 15710 (face font-lock-builtin-face fontified t) 15710 15711 (fontified t) 15711 15737 (face font-lock-string-face fontified t) 15737 15738 (fontified t) 15738 15801 (fontified t) 15801 15812 (face font-lock-builtin-face fontified t) 15812 15878 (fontified t) 15878 15892 (face font-lock-builtin-face fontified t) 15892 15935 (fontified t) 15935 15938 (face font-lock-comment-delimiter-face fontified t) 15938 15953 (face font-lock-comment-face fontified t) 15953 16171 (fontified t) 16171 16186 (face font-lock-string-face fontified t) 16186 16187 (fontified t) 16187 16197 (face font-lock-string-face fontified t) 16197 16305 (fontified t) 16305 16331 (face font-lock-string-face fontified t) 16331 16363 (fontified t) 16363 16366 (face font-lock-comment-delimiter-face fontified t) 16366 16394 (face font-lock-comment-face fontified t) 16394 16465 (fontified t) 16465 16469 (face font-lock-keyword-face fontified t) 16469 16682 (fontified t) 16682 16701 (face font-lock-keyword-face fontified t) 16701 16825 (fontified t) 16825 16828 (face font-lock-keyword-face fontified t) 16828 16837 (fontified t) 16837 16839 (face font-lock-keyword-face fontified t) 16839 16982 (fontified t) 16982 16995 (face font-lock-builtin-face fontified t) 16995 17060 (fontified t) 17060 17071 (face font-lock-builtin-face fontified t) 17071 17149 (fontified t) 17149 17154 (face font-lock-builtin-face fontified t) 17154 17221 (fontified t) 17221 17235 (face font-lock-builtin-face fontified t) 17235 17238 (fontified t) 17238 17240 (fontified t) 17240 17373 (fontified t) 17373 17386 (face font-lock-builtin-face fontified t) 17386 17451 (fontified t) 17451 17462 (face font-lock-builtin-face fontified t) 17462 17540 (fontified t) 17540 17545 (face font-lock-builtin-face fontified t) 17545 17612 (fontified t) 17612 17626 (face font-lock-builtin-face fontified t) 17626 17722 (fontified t) 17722 17725 (face font-lock-comment-delimiter-face fontified t) 17725 17765 (face font-lock-comment-face fontified t) 17765 17818 (fontified t) 17818 17820 (face font-lock-keyword-face fontified t) 17820 17981 (fontified t) 17981 17985 (face font-lock-keyword-face fontified t) 17985 18216 (fontified t) 18216 18229 (face font-lock-builtin-face fontified t) 18229 18230 (fontified t) 18230 18256 (face font-lock-string-face fontified t) 18256 18315 (fontified t) 18315 18326 (face font-lock-builtin-face fontified t) 18326 18387 (fontified t) 18387 18401 (face font-lock-builtin-face fontified t) 18401 18611 (fontified t) 18611 18626 (face font-lock-string-face fontified t) 18626 18627 (fontified t) 18627 18637 (face font-lock-string-face fontified t) 18637 18740 (fontified t) 18740 18749 (fontified t) 18749 18754 (face font-lock-warning-face fontified t) 18754 18758 (fontified t) 18758 18809 (fontified t) 18809 18821 (face font-lock-string-face fontified t) 18821 18840 (fontified t) 18840 18843 (face font-lock-comment-delimiter-face fontified t) 18843 18884 (face font-lock-comment-face fontified t) 18884 18927 (fontified t) 18927 18932 (face font-lock-keyword-face fontified t) 18932 18933 (fontified t) 18933 18944 (face font-lock-function-name-face fontified t) 18944 18946 (fontified t) 18946 18951 (face font-lock-type-face fontified t) 18951 18962 (fontified t) 18962 19089 (face font-lock-doc-face fontified t) 19089 19093 (fontified t) 19093 19097 (face font-lock-keyword-face fontified t) 19097 19130 (fontified t) 19130 19136 (face font-lock-keyword-face fontified t) 19136 19163 (fontified t) 19163 19172 (face font-lock-keyword-face fontified t) 19172 19227 (fontified t) 19227 19246 (face font-lock-comment-face fontified t) 19246 19301 (fontified t) 19301 19318 (face font-lock-comment-face fontified t) 19318 19352 (fontified t) 19352 19358 (face font-lock-keyword-face fontified t) 19358 19373 (fontified t) 19373 19376 (face font-lock-keyword-face fontified t) 19376 19399 (fontified t) 19399 19405 (face font-lock-keyword-face fontified t) 19405 19445 (fontified t) 19445 19448 (face font-lock-keyword-face fontified t) 19448 19490 (fontified t) 19490 19496 (face font-lock-keyword-face fontified t) 19496 19532 (fontified t) 19532 19537 (face font-lock-warning-face fontified t) 19537 19538 (fontified t) 19538 19764 (face font-lock-string-face fontified t) 19764 19833 (fontified t)) . 13135) (undo-tree-id4 . -19833)) nil (26996 50813 362647 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22880 . 22881) (nil fontified nil 13135 . 22881) (13135 . 22881)) nil (26996 50813 362646 0) 0 nil])
([nil nil ((22881 . 22882)) nil (26996 50813 362645 0) 0 nil])
([nil nil ((#(";;; ---------------- Cookies ----------------------------------------------------

(define-middleware cookies-parser (req next)
  \"Parse Cookie: â€¦ â†’ req-cookies (alist).\"
  (let* ((h (lumen.core.http:req-headers req))
         (raw (cdr (assoc \"cookie\" h :test #'string-equal))))
    (when raw
      (setf (lumen.core.http:req-cookies req)
            (lumen.core.http:parse-cookie-header raw))))
  (funcall next req))

(defun cookie (req name)
  \"Lit un cookie par nom (string), ou NIL.\"
  (cdr (assoc name (lumen.core.http:req-cookies req) :test #'string=)))

(defun set-cookie! (resp name value &rest opts)
  \"Ajoute un header Set-Cookie formatÃ© Ã  la rÃ©ponse.\"
  (lumen.core.http:add-set-cookie
   resp
   (apply #'lumen.core.http:format-set-cookie name value opts)))

;;; ---------------- Error wrapper ---------------------------------------------

(defparameter *error-handler*
  (lambda (e req)
    (declare (ignore req))
    ;; Rendu JSON par dÃ©faut ; en dev on imprime une backtrace
    (let* ((msg (princ-to-string e))
           (bt  (when debug-p
                  (with-output-to-string (s)
                    (ignore-errors (uiop:print-backtrace :stream s)))))
           (payload `((:error . ((:type . \"internal\")
                                  (:message . ,msg)
                                  ,@(when bt (list (cons :backtrace bt))))))))
      (lumen.core.http:respond-json payload :status 500))))

(define-middleware error-wrapper (req next)
  \"Capture toute condition et rend une 500 propre via *error-handler*.\"
  (handler-case
      (funcall next req)
    (error (e)
      (funcall *error-handler* e req))))

;;; ---------------- Request-ID -------------------------------------------------

(defun %rand-hex (nbytes)
  (let ((hex \"0123456789abcdef\"))
    (with-output-to-string (s)
      (dotimes (i (* 2 nbytes))
        (write-char (char hex (random 16)) s)))))

(defun make-request-id ()
  \"UUIDv4-ish (hex) simple, suffisant pour corrÃ©lation de logs.\"
  (let ((h (%rand-hex 16)))
    ;; 8-4-4-4-12 avec bits de version 4 (optionnel simplifiÃ©)
    (format nil \"~A-~A-4~A-~A~A-~A\"
            (subseq h 0 8) (subseq h 8 12) (subseq h 13 16)
            (subseq h 16 17) (subseq h 17 20) (subseq h 20 32))))

(define-middleware request-id (req next)
  \"Injecte un X-Request-ID dans la rÃ©ponse, disponible aussi via req-ctx.\"
  (let* ((rid (or (lumen.core.http:ctx-get req :request-id)
                  (make-request-id)))
         (resp (progn
                 (lumen.core.http:ctx-set! req :request-id rid)
                 (funcall next req))))
    (setf (lumen.core.http:resp-headers resp)
          (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                         \"x-request-id\" rid))
    resp))

;; Form parser
(define-middleware form-parser (req next)
  \"Parse application/x-www-form-urlencoded â†’ ctx[:form] (alist).\"
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((headers (lumen.core.http:req-headers req))
           (ct  (cdr (assoc \"content-type\" headers :test #'string-equal)))
           (len (cdr (assoc \"content-length\" headers :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0)
                 (search \"application/x-www-form-urlencoded\" (string-downcase ct)))
        (lumen.core.http:ctx-set! req :form
          (lumen.core.body:parse-urlencoded (lumen.core.http:req-body-stream req) len*))
        (lumen.core.http:ctx-set! req :body-consumed t))))
  (funcall next req))

(define-middleware multipart-parser (req next)
  \"Parse multipart/form-data â†’ ctx[:files], ctx[:fields].\"
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((h (lumen.core.http:req-headers req))
           (ct (cdr (assoc \"content-type\" h :test #'string-equal)))
           (len (cdr (assoc \"content-length\" h :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0)
                 (search \"multipart/form-data\" (string-downcase ct)))
        (let ((res (lumen.core.body:parse-multipart
		    (lumen.core.http:req-body-stream req) len* ct)))
	  ;;(print \"FILES\")
	  ;;(print res)
          (when res
            (lumen.core.http:ctx-set! req :fields (cdr (assoc :fields res)))
            (lumen.core.http:ctx-set! req :files  (cdr (assoc :files  res)))
            (lumen.core.http:ctx-set! req :body-consumed t))))))
  (funcall next req))" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 82 (face font-lock-comment-face fontified t) 82 84 (fontified t) 84 101 (face font-lock-keyword-face fontified t) 101 130 (fontified t) 130 170 (face font-lock-string-face fontified t) 170 174 (fontified t) 174 178 (face font-lock-keyword-face fontified t) 178 244 (fontified t) 244 252 (face font-lock-string-face fontified t) 252 255 (fontified t) 255 260 (face font-lock-builtin-face fontified t) 260 285 (fontified t) 285 289 (face font-lock-keyword-face fontified t) 289 421 (fontified t) 421 424 (face font-lock-keyword-face fontified t) 424 426 (face font-lock-keyword-face fontified t) 426 427 (fontified t) 427 433 (face font-lock-function-name-face fontified t) 433 445 (fontified t) 445 447 (fontified t) 447 488 (face font-lock-doc-face fontified t) 488 542 (fontified t) 542 547 (face font-lock-builtin-face fontified t) 547 562 (fontified t) 562 563 (fontified t) 563 568 (face font-lock-keyword-face fontified t) 568 569 (fontified t) 569 580 (face font-lock-function-name-face fontified t) 580 598 (fontified t) 598 603 (face font-lock-type-face fontified t) 603 612 (fontified t) 612 663 (face font-lock-doc-face fontified t) 663 664 (fontified t) 664 772 (fontified t) 772 776 (face font-lock-comment-delimiter-face fontified t) 776 853 (face font-lock-comment-face fontified t) 853 855 (fontified t) 855 867 (face font-lock-keyword-face fontified t) 867 868 (fontified t) 868 883 (face font-lock-variable-name-face fontified t) 883 887 (fontified t) 887 893 (face font-lock-keyword-face fontified t) 893 907 (fontified t) 907 914 (face font-lock-keyword-face fontified t) 914 933 (fontified t) 933 936 (face font-lock-comment-delimiter-face fontified t) 936 992 (face font-lock-comment-face fontified t) 992 997 (fontified t) 997 1001 (face font-lock-keyword-face fontified t) 1001 1046 (fontified t) 1046 1050 (face font-lock-keyword-face fontified t) 1050 1078 (fontified t) 1078 1099 (face font-lock-keyword-face fontified t) 1099 1125 (fontified t) 1125 1138 (face font-lock-keyword-face fontified t) 1138 1161 (fontified t) 1161 1168 (face font-lock-builtin-face fontified t) 1168 1199 (fontified t) 1199 1205 (face font-lock-builtin-face fontified t) 1205 1210 (fontified t) 1210 1215 (face font-lock-builtin-face fontified t) 1215 1218 (fontified t) 1218 1228 (face font-lock-string-face fontified t) 1228 1265 (fontified t) 1265 1273 (face font-lock-builtin-face fontified t) 1273 1319 (fontified t) 1319 1323 (face font-lock-keyword-face fontified t) 1323 1339 (fontified t) 1339 1349 (face font-lock-builtin-face fontified t) 1349 1405 (fontified t) 1405 1412 (face font-lock-builtin-face fontified t) 1412 1422 (fontified t) 1422 1423 (fontified t) 1423 1440 (face font-lock-keyword-face fontified t) 1440 1468 (fontified t) 1468 1499 (face font-lock-string-face fontified t) 1499 1500 (face font-lock-string-face fontified t) 1500 1537 (face font-lock-string-face fontified t) 1537 1538 (fontified t) 1538 1541 (fontified t) 1541 1553 (face font-lock-keyword-face fontified t) 1553 1584 (fontified t) 1584 1589 (face font-lock-warning-face fontified t) 1589 1636 (fontified t) 1636 1640 (face font-lock-comment-delimiter-face fontified t) 1640 1718 (face font-lock-comment-face fontified t) 1718 1720 (fontified t) 1720 1725 (face font-lock-keyword-face fontified t) 1725 1726 (fontified t) 1726 1735 (face font-lock-function-name-face fontified t) 1735 1748 (fontified t) 1748 1751 (face font-lock-keyword-face fontified t) 1751 1758 (fontified t) 1758 1776 (face font-lock-string-face fontified t) 1776 1784 (fontified t) 1784 1805 (face font-lock-keyword-face fontified t) 1805 1817 (fontified t) 1817 1824 (face font-lock-keyword-face fontified t) 1824 1894 (fontified t) 1894 1899 (face font-lock-keyword-face fontified t) 1899 1900 (fontified t) 1900 1915 (face font-lock-function-name-face fontified t) 1915 1921 (fontified t) 1921 1983 (face font-lock-doc-face fontified t) 1983 1987 (fontified t) 1987 1990 (face font-lock-keyword-face fontified t) 1990 2016 (fontified t) 2016 2019 (face font-lock-comment-delimiter-face fontified t) 2019 2075 (face font-lock-comment-face fontified t) 2075 2091 (fontified t) 2091 2110 (face font-lock-string-face fontified t) 2110 2164 (fontified t) 2164 2171 (fontified t) 2171 2239 (fontified t) 2239 2256 (face font-lock-keyword-face fontified t) 2256 2281 (fontified t) 2281 2353 (face font-lock-string-face fontified t) 2353 2357 (fontified t) 2357 2361 (face font-lock-keyword-face fontified t) 2361 2401 (fontified t) 2401 2412 (face font-lock-builtin-face fontified t) 2412 2468 (fontified t) 2468 2473 (face font-lock-keyword-face fontified t) 2473 2521 (fontified t) 2521 2532 (face font-lock-builtin-face fontified t) 2532 2737 (fontified t) 2737 2751 (face font-lock-string-face fontified t) 2751 2770 (fontified t) 2770 2773 (face font-lock-comment-delimiter-face fontified t) 2773 2785 (face font-lock-comment-face fontified t) 2785 2786 (fontified t) 2786 2803 (face font-lock-keyword-face fontified t) 2803 2829 (fontified t) 2829 2892 (face font-lock-string-face fontified t) 2892 2896 (fontified t) 2896 2902 (face font-lock-keyword-face fontified t) 2902 2932 (fontified t) 2932 2946 (face font-lock-builtin-face fontified t) 2946 2953 (fontified t) 2953 2957 (face font-lock-keyword-face fontified t) 2957 3031 (fontified t) 3031 3038 (face font-lock-string-face fontified t) 3038 3045 (face font-lock-string-face fontified t) 3045 3054 (fontified t) 3054 3059 (face font-lock-builtin-face fontified t) 3059 3078 (fontified t) 3078 3106 (fontified t) 3106 3122 (face font-lock-string-face fontified t) 3122 3131 (fontified t) 3131 3136 (face font-lock-builtin-face fontified t) 3136 3173 (fontified t) 3173 3177 (face font-lock-keyword-face fontified t) 3177 3201 (fontified t) 3201 3214 (face font-lock-builtin-face fontified t) 3214 3228 (fontified t) 3228 3232 (face font-lock-keyword-face fontified t) 3232 3282 (fontified t) 3282 3317 (face font-lock-string-face fontified t) 3317 3379 (fontified t) 3379 3384 (face font-lock-builtin-face fontified t) 3384 3512 (fontified t) 3512 3526 (face font-lock-builtin-face fontified t) 3526 3557 (fontified t) 3557 3574 (face font-lock-keyword-face fontified t) 3574 3605 (fontified t) 3605 3661 (face font-lock-string-face fontified t) 3661 3665 (fontified t) 3665 3671 (face font-lock-keyword-face fontified t) 3671 3701 (fontified t) 3701 3715 (face font-lock-builtin-face fontified t) 3715 3722 (fontified t) 3722 3726 (face font-lock-keyword-face fontified t) 3726 3793 (fontified t) 3793 3807 (face font-lock-string-face fontified t) 3807 3810 (fontified t) 3810 3815 (face font-lock-builtin-face fontified t) 3815 3862 (fontified t) 3862 3878 (face font-lock-string-face fontified t) 3878 3881 (fontified t) 3881 3886 (face font-lock-builtin-face fontified t) 3886 3923 (fontified t) 3923 3927 (face font-lock-keyword-face fontified t) 3927 3951 (fontified t) 3951 3964 (face font-lock-builtin-face fontified t) 3964 3978 (fontified t) 3978 3982 (face font-lock-keyword-face fontified t) 3982 4032 (fontified t) 4032 4053 (face font-lock-string-face fontified t) 4053 4086 (fontified t) 4086 4089 (face font-lock-keyword-face fontified t) 4089 4187 (fontified t) 4187 4189 (face font-lock-comment-delimiter-face fontified t) 4189 4205 (face font-lock-comment-face fontified t) 4205 4208 (fontified t) 4208 4210 (face font-lock-comment-delimiter-face fontified t) 4210 4222 (face font-lock-comment-face fontified t) 4222 4233 (fontified t) 4233 4237 (face font-lock-keyword-face fontified t) 4237 4284 (fontified t) 4284 4291 (face font-lock-builtin-face fontified t) 4291 4304 (fontified t) 4304 4311 (face font-lock-builtin-face fontified t) 4311 4361 (fontified t) 4361 4367 (face font-lock-builtin-face fontified t) 4367 4381 (fontified t) 4381 4387 (face font-lock-builtin-face fontified t) 4387 4438 (fontified t) 4438 4452 (face font-lock-builtin-face fontified t) 4452 4482 (fontified t)) . 22883) (undo-tree-id3 . -4482)) nil (26996 50813 362645 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27503 . 27504) (nil fontified nil 22883 . 27504) (22883 . 27504)) nil (26996 50813 362644 0) 0 nil])
([nil nil ((#("(defmiddleware multipart-parser-middleware 
    ((max-size :initarg :max-size :initform (* 10 1024 1024))) ;; 10MB default
    (req next)
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((h (lumen.core.http:req-headers req))
           (ct (cdr (assoc \"content-type\" h :test #'string-equal)))
           (len (cdr (assoc \"content-length\" h :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0) (search \"multipart/form-data\" (string-downcase ct)))
        ;; TODO: Utiliser max-size pour sÃ©curiser le parser
        (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
          (when res
            (lumen.core.http:ctx-set! req :fields (cdr (assoc :fields res)))
            (lumen.core.http:ctx-set! req :files  (cdr (assoc :files  res)))
            (lumen.core.http:ctx-set! req :body-consumed t))))))
  (funcall next req))" 0 59 (fontified t) 59 67 (face font-lock-builtin-face fontified t) 67 68 (fontified t) 68 77 (face font-lock-builtin-face fontified t) 77 78 (fontified t) 78 87 (face font-lock-builtin-face fontified t) 87 107 (fontified t) 107 110 (face font-lock-comment-delimiter-face fontified t) 110 123 (face font-lock-comment-face fontified t) 123 141 (fontified t) 141 147 (face font-lock-keyword-face fontified t) 147 177 (fontified t) 177 191 (face font-lock-builtin-face fontified t) 191 198 (fontified t) 198 202 (face font-lock-keyword-face fontified t) 202 269 (fontified t) 269 283 (face font-lock-string-face fontified t) 283 286 (fontified t) 286 291 (face font-lock-builtin-face fontified t) 291 338 (fontified t) 338 354 (face font-lock-string-face fontified t) 354 357 (fontified t) 357 362 (face font-lock-builtin-face fontified t) 362 399 (fontified t) 399 403 (face font-lock-keyword-face fontified t) 403 427 (fontified t) 427 440 (face font-lock-builtin-face fontified t) 440 454 (fontified t) 454 458 (face font-lock-keyword-face fontified t) 458 491 (fontified t) 491 512 (face font-lock-string-face fontified t) 512 544 (fontified t) 544 547 (face font-lock-comment-delimiter-face fontified t) 547 596 (face font-lock-comment-face fontified t) 596 605 (fontified t) 605 608 (face font-lock-keyword-face fontified t) 608 708 (fontified t) 708 712 (face font-lock-keyword-face fontified t) 712 759 (fontified t) 759 766 (face font-lock-builtin-face fontified t) 766 779 (fontified t) 779 786 (face font-lock-builtin-face fontified t) 786 836 (fontified t) 836 842 (face font-lock-builtin-face fontified t) 842 856 (fontified t) 856 862 (face font-lock-builtin-face fontified t) 862 913 (fontified t) 913 927 (face font-lock-builtin-face fontified t) 927 956 (fontified t) 956 957 (fontified t rear-nonsticky t)) . 26547) (undo-tree-id2 . -957)) nil (26996 50813 362643 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28808 . 28809) (nil fontified nil 26547 . 28809) (26547 . 28809)) nil (26996 50813 362642 0) 0 nil])
([nil nil ((28507 . 28514)) nil (26996 50813 362642 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28545 . 28546) (nil fontified nil 28514 . 28546) (28514 . 28546)) nil (26996 50813 362641 0) 0 nil])
([nil nil ((28848 . 28850)) nil (26996 50813 362641 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 30407 . 30408) (nil fontified nil 28850 . 30408) (28850 . 30408)) nil (26996 50813 362640 0) 0 nil])
([nil nil ((331 . 333)) nil (26996 50813 362639 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1786 . 1787) (nil fontified nil 1785 . 1787) (nil fontified nil 1769 . 1785) (nil fontified nil 1768 . 1769) (nil fontified nil 1754 . 1768) (nil fontified nil 1753 . 1754) (nil fontified nil 1737 . 1753) (nil fontified nil 1732 . 1737) (nil fontified nil 1721 . 1732) (nil fontified nil 1720 . 1721) (nil fontified nil 1706 . 1720) (nil fontified nil 1705 . 1706) (nil fontified nil 1691 . 1705) (nil fontified nil 1686 . 1691) (nil fontified nil 1671 . 1686) (nil fontified nil 1667 . 1671) (nil fontified nil 1658 . 1667) (nil fontified nil 1653 . 1658) (nil fontified nil 1648 . 1653) (nil fontified nil 1644 . 1648) (nil fontified nil 1636 . 1644) (nil fontified nil 1632 . 1636) (nil fontified nil 1624 . 1632) (nil fontified nil 1621 . 1624) (nil fontified nil 1617 . 1621) (nil fontified nil 1591 . 1617) (nil fontified nil 1587 . 1591) (nil fontified nil 1575 . 1587) (nil fontified nil 1572 . 1575) (nil fontified nil 1560 . 1572) (nil fontified nil 1557 . 1560) (nil fontified nil 1553 . 1557) (nil fontified nil 1548 . 1553) (nil fontified nil 1545 . 1548) (nil fontified nil 1540 . 1545) (nil fontified nil 1537 . 1540) (nil fontified nil 1533 . 1537) (nil fontified nil 1518 . 1533) (nil fontified nil 1517 . 1518) (nil fontified nil 1510 . 1517) (nil fontified nil 1509 . 1510) (nil fontified nil 1497 . 1509) (nil fontified nil 1496 . 1497) (nil fontified nil 1480 . 1496) (nil fontified nil 1479 . 1480) (nil fontified nil 1468 . 1479) (nil fontified nil 1465 . 1468) (nil fontified nil 1457 . 1465) (nil fontified nil 1454 . 1457) (nil fontified nil 1450 . 1454) (nil fontified nil 1436 . 1450) (nil fontified nil 1435 . 1436) (nil fontified nil 1419 . 1435) (nil fontified nil 1416 . 1419) (nil fontified nil 1400 . 1416) (nil fontified nil 1397 . 1400) (nil fontified nil 1392 . 1397) (nil fontified nil 1375 . 1392) (nil fontified nil 1374 . 1375) (nil fontified nil 1362 . 1374) (nil fontified nil 1357 . 1362) (nil fontified nil 1345 . 1357) (nil fontified nil 1344 . 1345) (nil fontified nil 1334 . 1344) (nil fontified nil 1333 . 1334) (nil fontified nil 1328 . 1333) (nil fontified nil 1327 . 1328) (nil fontified nil 1320 . 1327) (nil fontified nil 1319 . 1320) (nil fontified nil 1314 . 1319) (nil fontified nil 1313 . 1314) (nil fontified nil 1307 . 1313) (nil fontified nil 1302 . 1307) (nil fontified nil 1281 . 1302) (nil fontified nil 1280 . 1281) (nil fontified nil 1271 . 1280) (nil fontified nil 1270 . 1271) (nil fontified nil 1242 . 1270) (nil fontified nil 1237 . 1242) (nil fontified nil 1224 . 1237) (nil fontified nil 1223 . 1224) (nil fontified nil 1213 . 1223) (nil fontified nil 1212 . 1213) (nil fontified nil 1205 . 1212) (nil fontified nil 1204 . 1205) (nil fontified nil 1198 . 1204) (nil fontified nil 1197 . 1198) (nil fontified nil 1186 . 1197) (nil fontified nil 1185 . 1186) (nil fontified nil 1167 . 1185) (nil fontified nil 1166 . 1167) (nil fontified nil 1159 . 1166) (nil fontified nil 1154 . 1159) (nil fontified nil 1141 . 1154) (nil fontified nil 1140 . 1141) (nil fontified nil 1118 . 1140) (nil fontified nil 1117 . 1118) (nil fontified nil 1105 . 1117) (nil fontified nil 1100 . 1105) (nil fontified nil 1093 . 1100) (nil fontified nil 1092 . 1093) (nil fontified nil 1071 . 1092) (nil fontified nil 1070 . 1071) (nil fontified nil 1058 . 1070) (nil fontified nil 1053 . 1058) (nil fontified nil 1042 . 1053) (nil fontified nil 1041 . 1042) (nil fontified nil 1030 . 1041) (nil fontified nil 1029 . 1030) (nil fontified nil 1016 . 1029) (nil fontified nil 1015 . 1016) (nil fontified nil 1000 . 1015) (nil fontified nil 999 . 1000) (nil fontified nil 987 . 999) (nil fontified nil 982 . 987) (nil fontified nil 966 . 982) (nil fontified nil 965 . 966) (nil fontified nil 948 . 965) (nil fontified nil 947 . 948) (nil fontified nil 933 . 947) (nil fontified nil 932 . 933) (nil fontified nil 921 . 932) (nil fontified nil 920 . 921) (nil fontified nil 909 . 920) (nil fontified nil 908 . 909) (nil fontified nil 897 . 908) (nil fontified nil 896 . 897) (nil fontified nil 886 . 896) (nil fontified nil 885 . 886) (nil fontified nil 876 . 885) (nil fontified nil 875 . 876) (nil fontified nil 857 . 875) (nil fontified nil 856 . 857) (nil fontified nil 843 . 856) (nil fontified nil 842 . 843) (nil fontified nil 829 . 842) (nil fontified nil 828 . 829) (nil fontified nil 816 . 828) (nil fontified nil 815 . 816) (nil fontified nil 802 . 815) (nil fontified nil 801 . 802) (nil fontified nil 790 . 801) (nil fontified nil 789 . 790) (nil fontified nil 770 . 789) (nil fontified nil 769 . 770) (nil fontified nil 757 . 769) (nil fontified nil 752 . 757) (nil fontified nil 735 . 752) (nil fontified nil 734 . 735) (nil fontified nil 718 . 734) (nil fontified nil 717 . 718) (nil fontified nil 705 . 717) (nil fontified nil 700 . 705) (nil fontified nil 681 . 700) (nil fontified nil 680 . 681) (nil fontified nil 664 . 680) (nil fontified nil 663 . 664) (nil fontified nil 651 . 663) (nil fontified nil 646 . 651) (nil fontified nil 629 . 646) (nil fontified nil 626 . 629) (nil fontified nil 610 . 626) (nil fontified nil 609 . 610) (nil fontified nil 595 . 609) (nil fontified nil 594 . 595) (nil fontified nil 581 . 594) (nil fontified nil 580 . 581) (nil fontified nil 576 . 580) (nil fontified nil 575 . 576) (nil fontified nil 572 . 575) (nil fontified nil 571 . 572) (nil fontified nil 559 . 571) (nil fontified nil 558 . 559) (nil fontified nil 546 . 558) (nil fontified nil 541 . 546) (nil fontified nil 532 . 541) (nil fontified nil 531 . 532) (nil fontified nil 523 . 531) (nil fontified nil 522 . 523) (nil fontified nil 512 . 522) (nil fontified nil 511 . 512) (nil fontified nil 499 . 511) (nil fontified nil 498 . 499) (nil fontified nil 486 . 498) (nil fontified nil 485 . 486) (nil fontified nil 472 . 485) (nil fontified nil 468 . 472) (nil fontified nil 456 . 468) (nil fontified nil 455 . 456) (nil fontified nil 445 . 455) (nil fontified nil 444 . 445) (nil fontified nil 435 . 444) (nil fontified nil 434 . 435) (nil fontified nil 426 . 434) (nil fontified nil 425 . 426) (nil fontified nil 409 . 425) (nil fontified nil 408 . 409) (nil fontified nil 396 . 408) (nil fontified nil 391 . 396) (nil fontified nil 380 . 391) (nil fontified nil 379 . 380) (nil fontified nil 376 . 379) (nil fontified nil 375 . 376) (nil fontified nil 371 . 375) (nil fontified nil 367 . 371) (nil fontified nil 345 . 367) (nil fontified nil 344 . 345) (nil fontified nil 334 . 344) (nil fontified nil 333 . 334) (333 . 1787)) nil (26996 50813 362635 0) 0 nil])
([nil nil ((#("
(defpackage :lumen.core.middleware
  (:use :cl)
  (:import-from :lumen.core.pipeline :middleware :handle)
  (:export :defmiddleware
           ;; Exports des classes gÃ©nÃ©rÃ©es standards
           :logger-middleware
           :cors-middleware
           :session-middleware))

(in-package :lumen.core.middleware)" 0 2 (fontified t) 2 12 (face font-lock-keyword-face fontified t) 12 13 (fontified t) 13 35 (face font-lock-type-face fontified t) 35 39 (fontified t) 39 43 (face font-lock-builtin-face fontified t) 43 44 (fontified t) 44 47 (face font-lock-builtin-face fontified t) 47 52 (fontified t) 52 64 (face font-lock-builtin-face fontified t) 64 65 (fontified t) 65 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 97 (face font-lock-builtin-face fontified t) 97 98 (fontified t) 98 105 (face font-lock-builtin-face fontified t) 105 110 (fontified t) 110 117 (face font-lock-builtin-face fontified t) 117 118 (fontified t) 118 132 (face font-lock-builtin-face fontified t) 132 144 (fontified t) 144 147 (face font-lock-comment-delimiter-face fontified t) 147 186 (face font-lock-comment-face fontified t) 186 197 (fontified t) 197 215 (face font-lock-builtin-face fontified t) 215 227 (fontified t) 227 243 (face font-lock-builtin-face fontified t) 243 255 (fontified t) 255 274 (face font-lock-builtin-face fontified t) 274 278 (fontified t) 278 279 (fontified t) 279 289 (face font-lock-keyword-face fontified t) 289 290 (fontified t) 290 312 (face font-lock-builtin-face fontified t) 312 313 (fontified t)) . 18) (undo-tree-id0 . -313) (undo-tree-id1 . -313)) nil (26996 50813 362620 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 18)) nil (26996 50813 362603 0) 0 nil])
([nil nil ((438 . 439)) nil (26996 50813 362736 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.core.body :parse-urlencoded )" 0 1 (fontified t) 1 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 33 (face font-lock-builtin-face fontified t) 33 34 (fontified t) 34 51 (face font-lock-builtin-face fontified t) 51 52 (fontified t) 52 53 (fontified t)) . 387) (undo-tree-id43 . -53)) nil (26996 51113 222630 0) 0 nil] [nil nil ((nil fontified nil 539 . 540) (nil fontified nil 522 . 539) (nil fontified nil 521 . 522) (nil fontified nil 520 . 521) (nil fontified nil 519 . 520) (nil fontified nil 502 . 519) (nil fontified nil 501 . 502) (nil fontified nil 500 . 501) (nil fontified nil 499 . 500) (nil fontified nil 484 . 499) (nil fontified nil 483 . 484) (nil fontified nil 479 . 483) (nil fontified nil 478 . 479) (nil fontified nil 477 . 478) (nil fontified nil 466 . 477) (nil fontified nil 465 . 466) (nil fontified nil 456 . 465) (nil fontified nil 455 . 456) (nil fontified nil 439 . 455) (439 . 540)) ((#(":parse-multipart :json-get :parse-json 
	   :read-exact-bytes :bytes->string-utf8 :string->bytes-utf8" 0 16 (face font-lock-builtin-face fontified nil) 16 17 (fontified nil) 17 26 (face font-lock-builtin-face fontified nil) 26 27 (fontified nil) 27 38 (face font-lock-builtin-face fontified nil) 38 39 (fontified nil) 39 40 (fontified nil) 40 44 (fontified nil) 44 45 (face font-lock-builtin-face fontified nil) 45 60 (face font-lock-builtin-face fontified nil) 60 61 (face font-lock-builtin-face fontified nil rear-nonsticky t) 61 62 (fontified nil) 62 63 (face font-lock-builtin-face fontified nil) 63 80 (face font-lock-builtin-face fontified nil) 80 81 (face font-lock-builtin-face fontified nil rear-nonsticky t) 81 82 (fontified nil) 82 83 (face font-lock-builtin-face fontified nil) 83 100 (face font-lock-builtin-face fontified nil) 100 101 (face font-lock-builtin-face fontified nil rear-nonsticky t)) . 439) (undo-tree-id19 . -101) (nil fontified t 478 . 479) (nil fontified t 539 . 540)) (26996 50813 362598 0) 0 nil])
([nil nil ((77 . 78)) nil (26996 51113 222628 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 93 . 94) (nil fontified nil 78 . 94) (78 . 94)) nil (26996 51113 222628 0) 0 nil])
([nil nil ((#("
;;; ---------------- Middleware ----------------" 0 1 (fontified t) 1 5 (face font-lock-comment-delimiter-face fontified t) 5 49 (face font-lock-comment-face fontified t)) . 40470) (undo-tree-id42 . -49)) nil (26996 51113 222746 0) 0 nil])
([nil nil ((#(";;; ---------------- ETag ----------------
;; FNV-1a 64-bit (simple, sans dÃ©pendance)
(defun %fnv1a-64 (bytes)
  (let* ((hash #xCBF29CE484222325)
         (prime #x100000001B3))
    (dotimes (i (length bytes))
      (setf hash (logxor hash (aref bytes i)))
      (setf hash (mod (* hash prime) (expt 2 64))))
    hash))

(defun %hex64 (u64)
  (format nil \"~16,'0X\" u64))

(defun %body->bytes (body)
  (etypecase body
    (string (trivial-utf-8:string-to-utf-8-bytes body))
    ((vector (unsigned-byte 8)) body)
    (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))

(defun compute-etag (body &key (weak t))
  \"Retourne une chaÃ®ne ETag, ex: W/\\\"AB12...-1234\\\"\"
  (let* ((bytes (%body->bytes body))
         (h (%hex64 (%fnv1a-64 bytes)))
         (sig (format nil \"~A-~D\" h (length bytes))))
    (if weak
        (format nil \"W/~S\" sig)   ; \"W/\" + quoted-string
        (format nil \"~S\" sig)))   ; strong: juste quoted-string

  )

(defun %parse-if-none-match (h)
  \"Retourne une liste de tags (strings) tels que reÃ§us, ex: (\\\"W/\\\\\\\"SIG\\\\\\\"\\\" \\\"\\\\\\\"SIG2\\\\\\\"\\\").\"
  (when (and h (plusp (length h)))
    (mapcar (lambda (s) (string-trim '(#\\Space #\\Tab) s))
            (uiop:split-string h :separator \",\"))))

(defun %strip-weak (tag)
  \"Retire le prÃ©fixe W/ si prÃ©sent.\"
  (let ((s (string-trim '(#\\Space #\\Tab) tag)))
    (if (and (>= (length s) 2)
             (char-equal (char s 0) #\\W)
             (char=      (char s 1) #\\/))
        (subseq s 2)
        s)))

(defun %weak-match-p (client-tag server-tag)
  \"RÃ¨gle de weak comparison (RFC 7232 Â§2.3.2).
   client-tag et server-tag incluent les guillemets.\"
  (string= (%strip-weak client-tag) (%strip-weak server-tag)))

;;; Middleware ETag rendu 'safe' :
;;; - Ne tente PAS de calculer un ETag si le corps est un writer (fonction).
;;; - Si un ETag est DÃ‰JÃ€ prÃ©sent (ex: respond-file), utilise-le pour 304.
(defun etag (&key (weak t) (only-status '(200)) (add-cache-control nil))
  \"Ajoute/valide ETag et gÃ¨re 304 si If-None-Match matche.
   - WEAK : si T (dÃ©faut), gÃ©nÃ¨re un ETag faible (W/\\\"...\\\").
   - ONLY-STATUS : liste de statuts concernÃ©s (par dÃ©faut (200)).
   - ADD-CACHE-CONTROL : string optionnelle, ex: \\\"public, max-age=300\\\".\"
  (lambda (next)
    (lambda (req)
      (let* ((resp   (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels
            ((ensure-etag! (resp)
               (let* ((hdrs (lumen.core.http:resp-headers resp))
                      (existing (cdr (assoc \"etag\" hdrs :test #'string=))))
                 (cond
                   ;; ETag dÃ©jÃ  posÃ© (ex: respond-file) â†’ on le laisse.
                   (existing
                    (when add-cache-control
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                       \"cache-control\" add-cache-control)))
                    existing)
                   ;; Corps fonction (writer) â†’ on ne peut pas calculer â†’ on n'ajoute pas
                   ((functionp (lumen.core.http:resp-body resp))
                    (when add-cache-control
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                       \"cache-control\" add-cache-control)))
                    nil)
                   ;; Corps string / octets â†’ on calcule
                   (t
                    (let* ((val (compute-etag (lumen.core.http:resp-body resp) :weak weak)))
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header hdrs \"etag\" val))
                      (when add-cache-control
                        (setf (lumen.core.http:resp-headers resp)
                              (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                         \"cache-control\" add-cache-control)))
                      val))))))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((etag-val (ensure-etag! resp))
                     (inm (cdr (assoc \"if-none-match\"
                                      (lumen.core.http:req-headers req)
                                      :test #'string-equal))))
                (if (and etag-val inm
                         (or (some (lambda (x) (string= x \"*\"))
                                   (%parse-if-none-match inm))
                             (some (lambda (x) (%weak-match-p x etag-val))
                                   (%parse-if-none-match inm))))
                    ;; 304 Not Modified : pas de corps
                    (make-instance 'lumen.core.http:response
                                   :status 304
                                   :headers (lumen.utils:ensure-header
                                             (copy-list (lumen.core.http:resp-headers resp))
                                             \"etag\" etag-val)
                                   :body \"\")
                    resp))
              ;; Pas concernÃ© â†’ renvoyer tel quel
              resp))))))

;;; ---------------- Helpers Accept-Encoding ----------------
(defun %parse-accept-encoding (h)
  \"Retourne une alist '( (\\\"gzip\\\" . q) (\\\"deflate\\\" . q) ... ) triÃ©e par q desc.\"
  (labels ((parse-q (s)
             (handler-case
                 (let* ((v (read-from-string s nil nil)))
                   (if (numberp v) (coerce v 'float) 1.0))
               (error () 1.0))))
    (when (and h (plusp (length h)))
      (let* ((tokens (uiop:split-string h :separator \",\"))
             (pairs
               (mapcar (lambda (tok)
                         (let* ((t1 (string-trim '(#\\Space #\\Tab) tok))
                                (pos (position #\\; t1))
                                (enc (string-downcase
                                      (string-trim '(#\\Space #\\Tab)
                                                   (subseq t1 0 (or pos (length t1))))))
                                (q   (if pos
                                         (let* ((p2 (position #\\= t1 :start (1+ pos))))
                                           (if p2
                                               (parse-q (string-trim '(#\\Space #\\Tab)
                                                                     (subseq t1 (1+ p2))))
                                               1.0))
                                         1.0)))
                           (cons enc q)))
                       tokens)))
	;; filtre q=0, trie desc
        (sort (remove-if (lambda (c) (<= (cdr c) 0.0)) pairs)
              #'> :key #'cdr)))))

(defun %client-wants-gzip-p (headers)
  (let ((ae (cdr (assoc \"accept-encoding\" headers :test #'string-equal))))
    (member \"gzip\" (mapcar #'car (%parse-accept-encoding ae))
            :test #'string=)))

(defun %choose-encoding (headers &key (supported '(\"gzip\" \"deflate\")))
  \"Renvoie \\\"gzip\\\" ou \\\"deflate\\\" selon Accept-Encoding et q-values, ou NIL si rien.\"
  (let* ((ae (cdr (assoc \"accept-encoding\" headers :test #'string-equal)))
         (prefs (%parse-accept-encoding ae)))
    (some (lambda (p)
            (let ((enc (car p)))
              (when (member enc supported :test #'string=)
                enc)))
          prefs)))

(defun %content-type (headers)
  (cdr (assoc \"content-type\" headers :test #'string=)))

(defun %type-prefixed-p (ct prefixes)
  \"Vrai si le Content-Type CT commence par un des PREFIXES (strings).\"
  (and ct prefixes
       (let ((ct* (string-downcase ct)))
         (some (lambda (pfx) (lumen.utils:str-prefix-p (string-downcase pfx) ct*))
               prefixes))))

;;; ---------------- Compressors ----------------
(defun %bytes (body)
  (etypecase body
    (string (trivial-utf-8:string-to-utf-8-bytes body))
    ((vector (unsigned-byte 8)) body)
    (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))

(defun gzip-bytes (u8vec)
  \"Retourne un nouveau vecteur d'octets gzip du contenu U8VEC.\"
  (let ((out (flexi-streams:make-in-memory-output-stream
              :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:gzip-compressor :stream out)
      (dotimes (i (length u8vec))
        (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

(defun deflate-bytes (u8vec)
  \"Retourne un nouveau vecteur d'octets *deflate* (zlib wrapper, RFC1950) du contenu U8VEC.\"
  (let ((out (flexi-streams:make-in-memory-output-stream
              :element-type '(unsigned-byte 8))))
    ;; NB: 'deflate' cÃ´tÃ© HTTP signifie gÃ©nÃ©ralement zlib-wrapped (pas raw)
    (salza2:with-compressor (c 'salza2:zlib-compressor :stream out)
      (dotimes (i (length u8vec))
        (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

;; ---------- DÃ©tection contenus dÃ©jÃ  compressÃ©s / peu compressibles ----------
(defun %starts-with (vec &rest bytes)
  (when (and (vectorp vec)
             (subtypep (array-element-type vec) '(unsigned-byte 8))
             (<= (length bytes) (length vec)))
    (loop for i from 0 below (length bytes)
          always (= (aref vec i) (nth i bytes)))))

(defun %looks-gzip-p   (bytes) (%starts-with bytes #x1F #x8B))                ; GZIP
(defun %looks-zlib-p   (bytes) (or (%starts-with bytes #x78 #x01)             ; ZLIB/deflate
                                   (%starts-with bytes #x78 #x9C)
                                   (%starts-with bytes #x78 #xDA)))
(defun %looks-png-p    (bytes) (%starts-with bytes #x89 #x50 #x4E #x47 #x0D #x0A #x1A #x0A))
(defun %looks-jpeg-p   (bytes) (%starts-with bytes #xFF #xD8 #xFF))
(defun %looks-gif-p    (bytes)
  (and (>= (length bytes) 6)
       (let ((s (map 'string #'code-char (subseq bytes 0 6))))
         (or (string= s \"GIF87a\") (string= s \"GIF89a\")))))
(defun %looks-webp-p   (bytes)
  (and (>= (length bytes) 12)
       (string= (map 'string #'code-char (subseq bytes 0 4))  \"RIFF\")
       (string= (map 'string #'code-char (subseq bytes 8 12)) \"WEBP\")))
(defun %looks-zip-p    (bytes) (%starts-with bytes #x50 #x4B #x03 #x04))
(defun %looks-pdf-p    (bytes)
  (and (>= (length bytes) 4)
       (string= (map 'string #'code-char (subseq bytes 0 4)) \"%PDF\")))

(defun %incompressible-magic-p (bytes)
  \"Renvoie T si BYTES semble dÃ©jÃ  compressÃ© (gzip/zlib) ou de type peu compressible (images, zip, pdf).\"
  (or (%looks-gzip-p bytes)
      (%looks-zlib-p bytes)
      (%looks-png-p  bytes)
      (%looks-jpeg-p bytes)
      (%looks-gif-p  bytes)
      (%looks-webp-p bytes)
      (%looks-zip-p  bytes)
      (%looks-pdf-p  bytes)))

(defun compression
    (&key (threshold 1024)
       (add-vary t)
       (skip-types '(\"image/\" \"video/\" \"audio/\"
                     \"application/zip\" \"application/pdf\"
                     \"application/x-gzip\" \"application/x-7z-compressed\"
                     \"application/x-rar-compressed\" \"application/x-tar\"))
       (only-types nil)
       (min-ratio 0.95)
       (skip-if nil))		     ; (lambda (req resp) ...) -> bool
  \"Compresse la rÃ©ponse (gzip/deflate) si pertinent.
Options:
  - THRESHOLD  : octets minimum du corps original
  - ADD-VARY   : ajoute Vary: Accept-Encoding
  - SKIP-TYPES : liste de prÃ©fixes MIME Ã  ignorer
  - ONLY-TYPES : liste de prÃ©fixes MIME autorisÃ©s (si non-NIL, restreint la compression)
  - MIN-RATIO  : ne garde pas la compression si (compressed/original) > MIN-RATIO
  - SKIP-IF    : prÃ©dicat (req resp) â†’ T pour dÃ©sactiver la compression\"
  (labels
      ((decorate-vary (hdrs)
         (if add-vary
             (let* ((existing (cdr (assoc \"vary\" hdrs :test #'string=)))
                    (new (if existing
                             (if (search \"accept-encoding\" (string-downcase existing))
                                 existing
                                 (format nil \"~A, Accept-Encoding\" existing))
                             \"Accept-Encoding\")))
               (lumen.utils:ensure-header hdrs \"vary\" new))
             hdrs)))
    (lambda (next)
      (lambda (req)
        (let* ((resp    (funcall next req))
               (status  (lumen.core.http:resp-status resp))
               (req-h   (lumen.core.http:req-headers req))
               (resp-h  (lumen.core.http:resp-headers resp))
               (ct      (%content-type resp-h)))

          (cond
            ;; Jamais compresser ces statuts / si dÃ©jÃ  encodÃ©
            ((or (member status '(204 304))
                 (assoc \"content-encoding\" resp-h :test #'string=))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter un Ã©ventuel prÃ©dicat dâ€™exclusion
            ((and skip-if (funcall skip-if req resp))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter ONLY-TYPES (si fourni)
            ((and only-types (not (%type-prefixed-p ct only-types)))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Ne pas compresser si CT est dans SKIP-TYPES
            ((%type-prefixed-p ct skip-types)
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; NÃ©gociation de contenu
            (t
             (let ((chosen (%choose-encoding req-h :supported '(\"gzip\" \"deflate\"))))
               (if (null chosen)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
                   (let* ((orig (lumen.core.http:resp-body resp))
                          (bytes (etypecase orig
                                   (string (trivial-utf-8:string-to-utf-8-bytes orig))
                                   ((vector (unsigned-byte 8)) orig)
                                   (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))
                          (len (length bytes)))

                     (cond
                       ((< len threshold)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       ((%incompressible-magic-p bytes)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       (t
                        (let* ((encoded (ecase (intern (string-upcase chosen) :keyword)
                                          (:GZIP    (gzip-bytes bytes))
                                          (:DEFLATE (deflate-bytes bytes))))
                               (ratio (if (plusp len)
                                          (/ (float (length encoded)) (float len))
                                          1.0)))
                          (if (> ratio min-ratio)
                              ;; Gain insuffisant
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (decorate-vary (lumen.core.http:resp-headers resp)))
                                resp)
                              ;; Conserver compression
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (-> (lumen.core.http:resp-headers resp)
                                          (lumen.utils:ensure-header \"content-encoding\" chosen)
                                          (decorate-vary)))
                                (setf (lumen.core.http:resp-body resp) encoded)
                                resp)))))))))))))))" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 43 (face font-lock-comment-face fontified t) 43 46 (face font-lock-comment-delimiter-face fontified t) 46 86 (face font-lock-comment-face fontified t) 86 87 (fontified t) 87 92 (face font-lock-keyword-face fontified t) 92 93 (fontified t) 93 94 (face font-lock-function-name-face fontified t) 94 102 (face font-lock-function-name-face fontified t) 102 111 (fontified t) 111 114 (fontified t) 114 118 (face font-lock-keyword-face fontified t) 118 160 (fontified t) 160 178 (fontified t) 178 183 (fontified t) 183 190 (face font-lock-keyword-face fontified t) 190 322 (fontified t) 322 327 (face font-lock-keyword-face fontified t) 327 328 (fontified t) 328 334 (face font-lock-function-name-face fontified t) 334 355 (fontified t) 355 364 (face font-lock-string-face fontified t) 364 373 (fontified t) 373 378 (face font-lock-keyword-face fontified t) 378 379 (fontified t) 379 391 (face font-lock-function-name-face fontified t) 391 402 (fontified t) 402 411 (face font-lock-keyword-face fontified t) 411 518 (fontified t) 518 558 (fontified t) 558 560 (face font-lock-string-face fontified t) 560 565 (fontified t) 565 567 (fontified t) 567 572 (face font-lock-keyword-face fontified t) 572 573 (fontified t) 573 585 (face font-lock-function-name-face fontified t) 585 592 (fontified t) 592 596 (face font-lock-type-face fontified t) 596 609 (fontified t) 609 659 (face font-lock-doc-face fontified t) 659 663 (fontified t) 663 667 (face font-lock-keyword-face fontified t) 667 763 (fontified t) 763 770 (face font-lock-string-face fontified t) 770 796 (fontified t) 796 798 (face font-lock-keyword-face fontified t) 798 824 (fontified t) 824 830 (face font-lock-string-face fontified t) 830 838 (fontified t) 838 861 (face font-lock-comment-face fontified t) 861 881 (fontified t) 881 885 (face font-lock-string-face fontified t) 885 895 (fontified t) 895 925 (face font-lock-comment-face fontified t) 925 932 (fontified t) 932 937 (face font-lock-keyword-face fontified t) 937 938 (fontified t) 938 958 (face font-lock-function-name-face fontified t) 958 965 (fontified t) 965 1061 (face font-lock-doc-face fontified t) 1061 1065 (fontified t) 1065 1069 (face font-lock-keyword-face fontified t) 1069 1110 (fontified t) 1110 1116 (face font-lock-keyword-face fontified t) 1116 1188 (fontified t) 1188 1198 (face font-lock-builtin-face fontified t) 1198 1199 (fontified t) 1199 1200 (face font-lock-string-face fontified t) 1200 1202 (face font-lock-string-face fontified t) 1202 1207 (fontified t) 1207 1209 (fontified t) 1209 1214 (face font-lock-keyword-face fontified t) 1214 1215 (fontified t) 1215 1226 (face font-lock-function-name-face fontified t) 1226 1235 (fontified t) 1235 1269 (face font-lock-doc-face fontified t) 1269 1273 (fontified t) 1273 1276 (face font-lock-keyword-face fontified t) 1276 1323 (fontified t) 1323 1325 (face font-lock-keyword-face fontified t) 1325 1467 (fontified t) 1467 1468 (fontified t) 1468 1473 (face font-lock-keyword-face fontified t) 1473 1474 (fontified t) 1474 1476 (face font-lock-function-name-face fontified t) 1476 1487 (face font-lock-function-name-face fontified t) 1487 1499 (fontified t) 1499 1512 (fontified t) 1512 1514 (fontified t) 1514 1611 (face font-lock-doc-face fontified t) 1611 1612 (face font-lock-doc-face fontified t) 1612 1613 (fontified t) 1613 1677 (fontified t) 1677 1678 (face font-lock-comment-delimiter-face fontified t) 1678 1681 (fontified t face font-lock-comment-delimiter-face) 1681 1712 (fontified t face font-lock-comment-face) 1712 1716 (face font-lock-comment-delimiter-face fontified t) 1716 1789 (face font-lock-comment-face fontified t) 1789 1793 (face font-lock-comment-delimiter-face fontified t) 1793 1864 (face font-lock-comment-face fontified t) 1864 1865 (fontified t) 1865 1870 (face font-lock-keyword-face fontified t) 1870 1871 (fontified t) 1871 1875 (face font-lock-function-name-face fontified t) 1875 1877 (fontified t) 1877 1881 (face font-lock-type-face fontified t) 1881 1939 (fontified t) 1939 2065 (face font-lock-doc-face fontified t) 2065 2124 (face font-lock-doc-face fontified t) 2124 2198 (face font-lock-doc-face fontified t) 2198 2202 (fontified t) 2202 2208 (face font-lock-keyword-face fontified t) 2208 2221 (fontified t) 2221 2227 (face font-lock-keyword-face fontified t) 2227 2241 (fontified t) 2241 2245 (face font-lock-keyword-face fontified t) 2245 2342 (fontified t) 2342 2348 (face font-lock-keyword-face fontified t) 2348 2399 (fontified t) 2399 2403 (face font-lock-keyword-face fontified t) 2403 2492 (fontified t) 2492 2498 (face font-lock-string-face fontified t) 2498 2504 (fontified t) 2504 2509 (face font-lock-builtin-face fontified t) 2509 2542 (fontified t) 2542 2546 (face font-lock-keyword-face fontified t) 2546 2566 (fontified t) 2566 2569 (face font-lock-comment-delimiter-face fontified t) 2569 2619 (face font-lock-comment-face fontified t) 2619 2669 (fontified t) 2669 2673 (face font-lock-keyword-face fontified t) 2673 2902 (fontified t) 2902 2917 (face font-lock-string-face fontified t) 2917 2988 (fontified t) 2988 2991 (face font-lock-comment-delimiter-face fontified t) 2991 3059 (face font-lock-comment-face fontified t) 3059 3113 (fontified t) 3113 3124 (fontified t) 3124 3145 (fontified t) 3145 3149 (face font-lock-keyword-face fontified t) 3149 3212 (fontified t) 3212 3232 (fontified t) 3232 3378 (fontified t) 3378 3393 (face font-lock-string-face fontified t) 3393 3459 (fontified t) 3459 3462 (face font-lock-comment-delimiter-face fontified t) 3462 3497 (face font-lock-comment-face fontified t) 3497 3540 (fontified t) 3540 3544 (face font-lock-keyword-face fontified t) 3544 3598 (fontified t) 3598 3603 (face font-lock-builtin-face fontified t) 3603 3624 (fontified t) 3624 3676 (fontified t) 3676 3736 (fontified t) 3736 3742 (face font-lock-string-face fontified t) 3742 3772 (fontified t) 3772 3776 (face font-lock-keyword-face fontified t) 3776 4011 (fontified t) 4011 4026 (face font-lock-string-face fontified t) 4026 4091 (fontified t) 4091 4093 (face font-lock-keyword-face fontified t) 4093 4189 (fontified t) 4189 4193 (face font-lock-keyword-face fontified t) 4193 4264 (fontified t) 4264 4279 (face font-lock-string-face fontified t) 4279 4390 (fontified t) 4390 4395 (face font-lock-builtin-face fontified t) 4395 4432 (fontified t) 4432 4434 (face font-lock-keyword-face fontified t) 4434 4489 (fontified t) 4489 4495 (face font-lock-keyword-face fontified t) 4495 4511 (fontified t) 4511 4514 (face font-lock-string-face fontified t) 4514 4616 (fontified t) 4616 4622 (face font-lock-keyword-face fontified t) 4622 4732 (fontified t) 4732 4740 (fontified t) 4740 4743 (face font-lock-comment-delimiter-face fontified t) 4743 4775 (face font-lock-comment-face fontified t) 4775 4871 (fontified t) 4871 4878 (face font-lock-builtin-face fontified t) 4878 4918 (fontified t) 4918 4926 (face font-lock-builtin-face fontified t) 4926 5092 (fontified t) 5092 5098 (face font-lock-string-face fontified t) 5098 5144 (fontified t) 5144 5149 (face font-lock-builtin-face fontified t) 5149 5150 (fontified t) 5150 5152 (face font-lock-string-face fontified t) 5152 5176 (fontified t) 5176 5181 (fontified t) 5181 5195 (fontified t) 5195 5198 (face font-lock-comment-delimiter-face fontified t) 5198 5231 (face font-lock-comment-face fontified t) 5231 5257 (fontified t) 5257 5261 (face font-lock-comment-delimiter-face fontified t) 5261 5319 (face font-lock-comment-face fontified t) 5319 5320 (fontified t) 5320 5325 (face font-lock-keyword-face fontified t) 5325 5326 (fontified t) 5326 5348 (face font-lock-function-name-face fontified t) 5348 5355 (fontified t) 5355 5435 (face font-lock-doc-face fontified t) 5435 5439 (fontified t) 5439 5445 (face font-lock-keyword-face fontified t) 5445 5474 (fontified t) 5474 5486 (face font-lock-keyword-face fontified t) 5486 5505 (fontified t) 5505 5509 (face font-lock-keyword-face fontified t) 5509 5565 (fontified t) 5565 5567 (face font-lock-keyword-face fontified t) 5567 5620 (fontified t) 5620 5625 (face font-lock-warning-face fontified t) 5625 5642 (fontified t) 5642 5646 (face font-lock-keyword-face fontified t) 5646 5681 (fontified t) 5681 5685 (face font-lock-keyword-face fontified t) 5685 5716 (fontified t) 5716 5726 (face font-lock-builtin-face fontified t) 5726 5727 (fontified t) 5727 5730 (face font-lock-string-face fontified t) 5730 5777 (fontified t) 5777 5783 (face font-lock-keyword-face fontified t) 5783 5816 (fontified t) 5816 5820 (face font-lock-keyword-face fontified t) 5820 6167 (fontified t) 6167 6169 (face font-lock-keyword-face fontified t) 6169 6216 (fontified t) 6216 6220 (face font-lock-keyword-face fontified t) 6220 6243 (fontified t) 6243 6249 (face font-lock-builtin-face fontified t) 6249 6275 (fontified t) 6275 6306 (fontified t) 6306 6308 (face font-lock-keyword-face fontified t) 6308 6312 (fontified t) 6312 6666 (fontified t) 6666 6669 (face font-lock-comment-delimiter-face fontified t) 6669 6681 (face font-lock-comment-face fontified t) 6681 6691 (face font-lock-comment-face fontified t) 6691 6717 (fontified t) 6717 6723 (face font-lock-keyword-face fontified t) 6723 6771 (fontified t) 6771 6775 (face font-lock-builtin-face fontified t) 6775 6789 (fontified t) 6789 6794 (face font-lock-keyword-face fontified t) 6794 6795 (fontified t) 6795 6815 (face font-lock-function-name-face fontified t) 6815 6829 (fontified t) 6829 6832 (face font-lock-keyword-face fontified t) 6832 6850 (fontified t) 6850 6867 (face font-lock-string-face fontified t) 6867 6876 (fontified t) 6876 6881 (face font-lock-builtin-face fontified t) 6881 6913 (fontified t) 6913 6919 (face font-lock-string-face fontified t) 6919 6975 (fontified t) 6975 6980 (face font-lock-builtin-face fontified t) 6980 6996 (fontified t) 6996 7001 (face font-lock-keyword-face fontified t) 7001 7002 (fontified t) 7002 7018 (face font-lock-function-name-face fontified t) 7018 7028 (fontified t) 7028 7032 (face font-lock-type-face fontified t) 7032 7046 (fontified t) 7046 7052 (face font-lock-string-face fontified t) 7052 7053 (fontified t) 7053 7062 (face font-lock-string-face fontified t) 7062 7068 (fontified t) 7068 7152 (face font-lock-doc-face fontified t) 7152 7156 (fontified t) 7156 7160 (face font-lock-keyword-face fontified t) 7160 7178 (fontified t) 7178 7195 (face font-lock-string-face fontified t) 7195 7204 (fontified t) 7204 7209 (face font-lock-builtin-face fontified t) 7209 7285 (fontified t) 7285 7291 (face font-lock-keyword-face fontified t) 7291 7309 (fontified t) 7309 7312 (face font-lock-keyword-face fontified t) 7312 7344 (fontified t) 7344 7348 (face font-lock-keyword-face fontified t) 7348 7371 (fontified t) 7371 7376 (face font-lock-builtin-face fontified t) 7376 7432 (fontified t) 7432 7437 (face font-lock-keyword-face fontified t) 7437 7438 (fontified t) 7438 7451 (face font-lock-function-name-face fontified t) 7451 7476 (fontified t) 7476 7490 (face font-lock-string-face fontified t) 7490 7499 (fontified t) 7499 7504 (face font-lock-builtin-face fontified t) 7504 7520 (fontified t) 7520 7525 (face font-lock-keyword-face fontified t) 7525 7526 (fontified t) 7526 7542 (face font-lock-function-name-face fontified t) 7542 7559 (fontified t) 7559 7627 (face font-lock-doc-face fontified t) 7627 7655 (fontified t) 7655 7658 (face font-lock-keyword-face fontified t) 7658 7704 (fontified t) 7704 7710 (face font-lock-keyword-face fontified t) 7710 7800 (fontified t) 7800 7804 (face font-lock-comment-delimiter-face fontified t) 7804 7812 (face font-lock-comment-face fontified t) 7812 7850 (fontified t face font-lock-comment-face) 7850 7851 (fontified t) 7851 7856 (face font-lock-keyword-face fontified t) 7856 7857 (fontified t) 7857 7863 (face font-lock-function-name-face fontified t) 7863 7874 (fontified t) 7874 7883 (face font-lock-keyword-face fontified t) 7883 8030 (fontified t) 8030 8032 (face font-lock-string-face fontified t) 8032 8038 (fontified t) 8038 8039 (fontified t) 8039 8044 (face font-lock-keyword-face fontified t) 8044 8045 (fontified t) 8045 8055 (face font-lock-function-name-face fontified t) 8055 8066 (fontified t) 8066 8127 (face font-lock-doc-face fontified t) 8127 8131 (fontified t) 8131 8134 (face font-lock-keyword-face fontified t) 8134 8191 (fontified t) 8191 8199 (fontified t) 8199 8212 (face font-lock-builtin-face fontified t) 8212 8235 (fontified t) 8235 8240 (fontified t) 8240 8262 (face font-lock-keyword-face fontified t) 8262 8290 (fontified t) 8290 8297 (face font-lock-builtin-face fontified t) 8297 8310 (fontified t) 8310 8317 (face font-lock-keyword-face fontified t) 8317 8443 (fontified t) 8443 8448 (face font-lock-keyword-face fontified t) 8448 8449 (fontified t) 8449 8462 (face font-lock-function-name-face fontified t) 8462 8473 (fontified t) 8473 8563 (face font-lock-doc-face fontified t) 8563 8567 (fontified t) 8567 8570 (face font-lock-keyword-face fontified t) 8570 8635 (fontified t) 8635 8648 (face font-lock-builtin-face fontified t) 8648 8675 (fontified t) 8675 8678 (face font-lock-comment-delimiter-face fontified t) 8678 8747 (face font-lock-comment-face fontified t) 8747 8752 (fontified t) 8752 8774 (face font-lock-keyword-face fontified t) 8774 8802 (fontified t) 8802 8809 (face font-lock-builtin-face fontified t) 8809 8822 (fontified t) 8822 8829 (face font-lock-keyword-face fontified t) 8829 8953 (fontified t) 8953 8954 (fontified t) 8954 8957 (face font-lock-comment-delimiter-face fontified t) 8957 9034 (face font-lock-comment-face fontified t) 9034 9035 (fontified t) 9035 9040 (face font-lock-keyword-face fontified t) 9040 9041 (fontified t) 9041 9053 (face font-lock-function-name-face fontified t) 9053 9059 (fontified t) 9059 9064 (face font-lock-type-face fontified t) 9064 9075 (fontified t) 9075 9079 (face font-lock-keyword-face fontified t) 9079 9219 (fontified t) 9219 9223 (face font-lock-keyword-face fontified t) 9223 9301 (fontified t) 9301 9309 (fontified t) 9309 9311 (fontified t) 9311 9316 (face font-lock-keyword-face fontified t) 9316 9317 (fontified t) 9317 9330 (face font-lock-function-name-face fontified t) 9330 9388 (fontified t) 9388 9395 (face font-lock-comment-face fontified t) 9395 9396 (fontified t) 9396 9401 (face font-lock-keyword-face fontified t) 9401 9402 (fontified t) 9402 9415 (face font-lock-function-name-face fontified t) 9415 9473 (fontified t) 9473 9475 (face font-lock-comment-face fontified t) 9475 9488 (face font-lock-comment-face fontified t) 9488 9623 (fontified t) 9623 9628 (face font-lock-keyword-face fontified t) 9628 9629 (fontified t) 9629 9641 (face font-lock-function-name-face fontified t) 9641 9686 (fontified t) 9686 9715 (fontified t) 9715 9716 (fontified t) 9716 9721 (face font-lock-keyword-face fontified t) 9721 9722 (fontified t) 9722 9735 (face font-lock-function-name-face fontified t) 9735 9784 (fontified t) 9784 9789 (face font-lock-keyword-face fontified t) 9789 9790 (fontified t) 9790 9802 (face font-lock-function-name-face fontified t) 9802 9851 (fontified t) 9851 9854 (face font-lock-keyword-face fontified t) 9854 9930 (fontified t) 9930 9938 (face font-lock-string-face fontified t) 9938 9951 (fontified t) 9951 9959 (face font-lock-string-face fontified t) 9959 9966 (fontified t) 9966 9971 (face font-lock-keyword-face fontified t) 9971 9972 (fontified t) 9972 9985 (face font-lock-function-name-face fontified t) 9985 10088 (fontified t) 10088 10094 (face font-lock-string-face fontified t) 10094 10158 (fontified t) 10158 10164 (face font-lock-string-face fontified t) 10164 10169 (fontified t) 10169 10174 (face font-lock-keyword-face fontified t) 10174 10175 (fontified t) 10175 10187 (face font-lock-function-name-face fontified t) 10187 10242 (fontified t) 10242 10247 (face font-lock-keyword-face fontified t) 10247 10248 (fontified t) 10248 10260 (face font-lock-function-name-face fontified t) 10260 10362 (fontified t) 10362 10368 (face font-lock-string-face fontified t) 10368 10373 (fontified t) 10373 10374 (fontified t) 10374 10379 (face font-lock-keyword-face fontified t) 10379 10380 (fontified t) 10380 10403 (face font-lock-function-name-face fontified t) 10403 10414 (fontified t) 10414 10454 (face font-lock-doc-face fontified t) 10454 10516 (face font-lock-doc-face fontified t) 10516 10517 (fontified t) 10517 10629 (fontified t) 10629 10744 (fontified t) 10744 10745 (fontified t) 10745 10750 (face font-lock-keyword-face fontified t) 10750 10751 (fontified t) 10751 10762 (face font-lock-function-name-face fontified t) 10762 10768 (fontified t) 10768 10772 (face font-lock-type-face fontified t) 10772 10809 (fontified t) 10809 10810 (fontified t) 10810 10831 (fontified t) 10831 10839 (face font-lock-string-face fontified t) 10839 10840 (fontified t) 10840 10848 (face font-lock-string-face fontified t) 10848 10849 (fontified t) 10849 10857 (face font-lock-string-face fontified t) 10857 10879 (fontified t) 10879 10895 (face font-lock-string-face fontified t) 10895 10896 (face font-lock-string-face fontified t) 10896 10897 (fontified t) 10897 10914 (face font-lock-string-face fontified t) 10914 10915 (fontified t) 10915 10936 (fontified t) 10936 10956 (face font-lock-string-face fontified t) 10956 10957 (fontified t) 10957 10986 (face font-lock-string-face fontified t) 10986 11008 (fontified t) 11008 11038 (face font-lock-string-face fontified t) 11038 11039 (fontified t) 11039 11058 (face font-lock-string-face fontified t) 11058 11137 (fontified t) 11137 11171 (face font-lock-comment-face fontified t) 11171 11173 (fontified t) 11173 11215 (face font-lock-doc-face fontified t) 11215 11224 (face font-lock-doc-face fontified t) 11224 11263 (face font-lock-doc-face fontified t) 11263 11622 (face font-lock-doc-face fontified t) 11622 11626 (fontified t) 11626 11632 (face font-lock-keyword-face fontified t) 11632 11672 (fontified t) 11672 11674 (face font-lock-keyword-face fontified t) 11674 11698 (fontified t) 11698 11702 (face font-lock-keyword-face fontified t) 11702 11726 (fontified t) 11726 11732 (face font-lock-string-face fontified t) 11732 11738 (fontified t) 11738 11743 (face font-lock-builtin-face fontified t) 11743 11783 (fontified t) 11783 11785 (face font-lock-keyword-face fontified t) 11785 11825 (fontified t) 11825 11827 (face font-lock-keyword-face fontified t) 11827 11836 (fontified t) 11836 11853 (face font-lock-string-face fontified t) 11853 11969 (fontified t) 11969 11990 (face font-lock-string-face fontified t) 11990 12017 (fontified t) 12017 12031 (fontified t) 12031 12048 (face font-lock-string-face fontified t) 12048 12052 (fontified t) 12052 12099 (fontified t) 12099 12105 (face font-lock-string-face fontified t) 12105 12138 (fontified t) 12138 12144 (face font-lock-keyword-face fontified t) 12144 12159 (fontified t) 12159 12165 (face font-lock-keyword-face fontified t) 12165 12181 (fontified t) 12181 12185 (face font-lock-keyword-face fontified t) 12185 12415 (fontified t) 12415 12445 (fontified t) 12445 12457 (fontified t) 12457 12461 (face font-lock-keyword-face fontified t) 12461 12474 (fontified t) 12474 12477 (face font-lock-comment-delimiter-face fontified t) 12477 12524 (face font-lock-comment-face fontified t) 12524 12592 (fontified t) 12592 12610 (face font-lock-string-face fontified t) 12610 12618 (fontified t) 12618 12623 (face font-lock-builtin-face fontified t) 12623 12724 (fontified t) 12724 12763 (fontified t) 12763 12795 (fontified t) 12795 12798 (face font-lock-comment-delimiter-face fontified t) 12798 12841 (face font-lock-comment-face fontified t) 12841 13054 (fontified t) 13054 13057 (face font-lock-comment-delimiter-face fontified t) 13057 13090 (face font-lock-comment-face fontified t) 13090 13318 (fontified t) 13318 13321 (face font-lock-comment-delimiter-face fontified t) 13321 13365 (face font-lock-comment-face fontified t) 13365 13552 (fontified t) 13552 13557 (fontified t) 13557 13570 (fontified t) 13570 13573 (face font-lock-comment-delimiter-face fontified t) 13573 13596 (face font-lock-comment-face fontified t) 13596 13625 (fontified t) 13625 13628 (face font-lock-keyword-face fontified t) 13628 13662 (fontified t) 13662 13672 (face font-lock-builtin-face fontified t) 13672 13675 (fontified t) 13675 13681 (face font-lock-string-face fontified t) 13681 13682 (fontified t) 13682 13691 (face font-lock-string-face fontified t) 13691 13712 (fontified t) 13712 13714 (face font-lock-keyword-face fontified t) 13714 13749 (fontified t) 13749 13754 (face font-lock-keyword-face fontified t) 13754 13945 (fontified t) 13945 13949 (face font-lock-keyword-face fontified t) 13949 13991 (fontified t) 13991 14025 (fontified t) 14025 14034 (face font-lock-keyword-face fontified t) 14034 14263 (fontified t) 14263 14274 (fontified t) 14274 14276 (face font-lock-string-face fontified t) 14276 14281 (fontified t) 14281 14352 (fontified t) 14352 14356 (face font-lock-keyword-face fontified t) 14356 14866 (fontified t) 14866 14870 (face font-lock-keyword-face fontified t) 14870 14882 (fontified t) 14882 14887 (face font-lock-keyword-face fontified t) 14887 14919 (fontified t) 14919 14927 (face font-lock-builtin-face fontified t) 14927 14972 (fontified t) 14972 14977 (face font-lock-builtin-face fontified t) 14977 15044 (fontified t) 15044 15052 (face font-lock-builtin-face fontified t) 15052 15057 (fontified t) 15057 15078 (fontified t) 15078 15117 (fontified t) 15117 15119 (face font-lock-keyword-face fontified t) 15119 15291 (fontified t) 15291 15293 (face font-lock-keyword-face fontified t) 15293 15344 (fontified t) 15344 15347 (face font-lock-comment-delimiter-face fontified t) 15347 15364 (face font-lock-comment-face fontified t) 15364 15395 (fontified t) 15395 15400 (face font-lock-keyword-face fontified t) 15400 15491 (fontified t) 15491 15566 (fontified t) 15566 15634 (fontified t) 15634 15637 (face font-lock-comment-delimiter-face fontified t) 15637 15659 (face font-lock-comment-face fontified t) 15659 15690 (fontified t) 15690 15695 (face font-lock-keyword-face fontified t) 15695 15781 (fontified t) 15781 15848 (fontified t) 15848 15917 (fontified t) 15917 15935 (face font-lock-string-face fontified t) 15935 16135 (fontified t)) . 31517) (undo-tree-id49 . -16135)) nil (26996 52268 614241 0) 0 nil] [nil nil ((#("ZLIB/deflate
                                   (%starts-with bytes #x78 #x9C)
                                   (%starts-with bytes #x78 #xDA)))
(defun %looks-png-p    (bytes) (%starts-with bytes #x89 #x50 #x4E #x47 #x0D #x0A #x1A #x0A))
(defun %looks-jpeg-p   (bytes) (%starts-with bytes #xFF #xD8 #xFF))
(defun %looks-gif-p    (bytes)
  (and (>= (length bytes) 6)
       (let ((s (map 'string #'code-char (subseq bytes 0 6))))
         (or (string= s \"GIF87a\") (string= s \"GIF89a\")))))
(defun %looks-webp-p   (bytes)
  (and (>= (length bytes) 12)
       (string= (map 'string #'code-char (subseq bytes 0 4))  \"RIFF\")
       (string= (map 'string #'code-char (subseq bytes 8 12)) \"WEBP\")))
(defun %looks-zip-p    (bytes) (%starts-with bytes #x50 #x4B #x03 #x04))
(defun %looks-pdf-p    (bytes)
  (and (>= (length bytes) 4)
       (string= (map 'string #'code-char (subseq bytes 0 4)) \"%PDF\")))

(defun %incompressible-magic-p (bytes)
  \"Renvoie T si BYTES semble dÃ©jÃ  compressÃ© (gzip/zlib) ou de type peu compressible (images, zip, pdf).\"
  (or (%looks-gzip-p bytes)
      (%looks-zlib-p bytes)
      (%looks-png-p  bytes)
      (%looks-jpeg-p bytes)
      (%looks-gif-p  bytes)
      (%looks-webp-p bytes)
      (%looks-zip-p  bytes)
      (%looks-pdf-p  bytes)))

(defun compression
    (&key (threshold 1024)
       (add-vary t)
       (skip-types '(\"image/\" \"video/\" \"audio/\"
                     \"application/zip\" \"application/pdf\"
                     \"application/x-gzip\" \"application/x-7z-compressed\"
                     \"application/x-rar-compressed\" \"application/x-tar\"))
       (only-types nil)
       (min-ratio 0.95)
       (skip-if nil))		     ; (lambda (req resp) ...) -> bool
  \"Compresse la rÃ©ponse (gzip/deflate) si pertinent.
Options:
  - THRESHOLD  : octets minimum du corps original
  - ADD-VARY   : ajoute Vary: Accept-Encoding
  - SKIP-TYPES : liste de prÃ©fixes MIME Ã  ignorer
  - ONLY-TYPES : liste de prÃ©fixes MIME autorisÃ©s (si non-NIL, restreint la compression)
  - MIN-RATIO  : ne garde pas la compression si (compressed/original) > MIN-RATIO
  - SKIP-IF    : prÃ©dicat (req resp) â†’ T pour dÃ©sactiver la compression\"
  (labels
      ((decorate-vary (hdrs)
         (if add-vary
             (let* ((existing (cdr (assoc \"vary\" hdrs :test #'string=)))
                    (new (if existing
                             (if (search \"accept-encoding\" (string-downcase existing))
                                 existing
                                 (format nil \"~A, Accept-Encoding\" existing))
                             \"Accept-Encoding\")))
               (lumen.utils:ensure-header hdrs \"vary\" new))
             hdrs)))
    (lambda (next)
      (lambda (req)
        (let* ((resp    (funcall next req))
               (status  (lumen.core.http:resp-status resp))
               (req-h   (lumen.core.http:req-headers req))
               (resp-h  (lumen.core.http:resp-headers resp))
               (ct      (%content-type resp-h)))

          (cond
            ;; Jamais compresser ces statuts / si dÃ©jÃ  encodÃ©
            ((or (member status '(204 304))
                 (assoc \"content-encoding\" resp-h :test #'string=))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter un Ã©ventuel prÃ©dicat dâ€™exclusion
            ((and skip-if (funcall skip-if req resp))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter ONLY-TYPES (si fourni)
            ((and only-types (not (%type-prefixed-p ct only-types)))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Ne pas compresser si CT est dans SKIP-TYPES
            ((%type-prefixed-p ct skip-types)
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; NÃ©gociation de contenu
            (t
             (let ((chosen (%choose-encoding req-h :supported '(\"gzip\" \"deflate\"))))
               (if (null chosen)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
                   (let* ((orig (lumen.core.http:resp-body resp))
                          (bytes (etypecase orig
                                   (string (trivial-utf-8:string-to-utf-8-bytes orig))
                                   ((vector (unsigned-byte 8)) orig)
                                   (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))
                          (len (length bytes)))

                     (cond
                       ((< len threshold)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       ((%incompressible-magic-p bytes)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       (t
                        (let* ((encoded (ecase (intern (string-upcase chosen) :keyword)
                                          (:GZIP    (gzip-bytes bytes))
                                          (:DEFLATE (deflate-bytes bytes))))
                               (ratio (if (plusp len)
                                          (/ (float (length encoded)) (float len))
                                          1.0)))
                          (if (> ratio min-ratio)
                              ;; Gain insuffisant
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (decorate-vary (lumen.core.http:resp-headers resp)))
                                resp)
                              ;; Conserver compression
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (-> (lumen.core.http:resp-headers resp)
                                          (lumen.utils:ensure-header \"content-encoding\" chosen)
                                          (decorate-vary)))
                                (setf (lumen.core.http:resp-body resp) encoded)
                                resp)))))))))))))))
" 0 13 (face font-lock-comment-face fontified t) 13 148 (fontified t) 148 153 (face font-lock-keyword-face fontified t) 153 154 (fontified t) 154 166 (face font-lock-function-name-face fontified t) 166 211 (fontified t) 211 240 (fontified t) 240 241 (fontified t) 241 246 (face font-lock-keyword-face fontified t) 246 247 (fontified t) 247 260 (face font-lock-function-name-face fontified t) 260 309 (fontified t) 309 314 (face font-lock-keyword-face fontified t) 314 315 (fontified t) 315 327 (face font-lock-function-name-face fontified t) 327 376 (fontified t) 376 379 (face font-lock-keyword-face fontified t) 379 455 (fontified t) 455 463 (face font-lock-string-face fontified t) 463 476 (fontified t) 476 484 (face font-lock-string-face fontified t) 484 491 (fontified t) 491 496 (face font-lock-keyword-face fontified t) 496 497 (fontified t) 497 510 (face font-lock-function-name-face fontified t) 510 613 (fontified t) 613 619 (face font-lock-string-face fontified t) 619 683 (fontified t) 683 689 (face font-lock-string-face fontified t) 689 694 (fontified t) 694 699 (face font-lock-keyword-face fontified t) 699 700 (fontified t) 700 712 (face font-lock-function-name-face fontified t) 712 767 (fontified t) 767 772 (face font-lock-keyword-face fontified t) 772 773 (fontified t) 773 785 (face font-lock-function-name-face fontified t) 785 887 (fontified t) 887 893 (face font-lock-string-face fontified t) 893 898 (fontified t) 898 899 (fontified t) 899 904 (face font-lock-keyword-face fontified t) 904 905 (fontified t) 905 928 (face font-lock-function-name-face fontified t) 928 939 (fontified t) 939 979 (face font-lock-doc-face fontified t) 979 1041 (face font-lock-doc-face fontified t) 1041 1042 (fontified t) 1042 1154 (fontified t) 1154 1269 (fontified t) 1269 1270 (fontified t) 1270 1275 (face font-lock-keyword-face fontified t) 1275 1276 (fontified t) 1276 1287 (face font-lock-function-name-face fontified t) 1287 1293 (fontified t) 1293 1297 (face font-lock-type-face fontified t) 1297 1334 (fontified t) 1334 1335 (fontified t) 1335 1356 (fontified t) 1356 1364 (face font-lock-string-face fontified t) 1364 1365 (fontified t) 1365 1373 (face font-lock-string-face fontified t) 1373 1374 (fontified t) 1374 1382 (face font-lock-string-face fontified t) 1382 1404 (fontified t) 1404 1421 (face font-lock-string-face fontified t) 1421 1422 (fontified t) 1422 1439 (face font-lock-string-face fontified t) 1439 1461 (fontified t) 1461 1481 (face font-lock-string-face fontified t) 1481 1482 (fontified t) 1482 1511 (face font-lock-string-face fontified t) 1511 1533 (fontified t) 1533 1563 (face font-lock-string-face fontified t) 1563 1564 (fontified t) 1564 1583 (face font-lock-string-face fontified t) 1583 1662 (fontified t) 1662 1696 (face font-lock-comment-face fontified t) 1696 1698 (fontified t) 1698 1740 (face font-lock-doc-face fontified t) 1740 1749 (face font-lock-doc-face fontified t) 1749 1788 (face font-lock-doc-face fontified t) 1788 2147 (face font-lock-doc-face fontified t) 2147 2151 (fontified t) 2151 2157 (face font-lock-keyword-face fontified t) 2157 2197 (fontified t) 2197 2199 (face font-lock-keyword-face fontified t) 2199 2223 (fontified t) 2223 2227 (face font-lock-keyword-face fontified t) 2227 2251 (fontified t) 2251 2257 (face font-lock-string-face fontified t) 2257 2263 (fontified t) 2263 2268 (face font-lock-builtin-face fontified t) 2268 2308 (fontified t) 2308 2310 (face font-lock-keyword-face fontified t) 2310 2350 (fontified t) 2350 2352 (face font-lock-keyword-face fontified t) 2352 2361 (fontified t) 2361 2378 (face font-lock-string-face fontified t) 2378 2494 (fontified t) 2494 2515 (face font-lock-string-face fontified t) 2515 2542 (fontified t) 2542 2556 (fontified t) 2556 2573 (face font-lock-string-face fontified t) 2573 2577 (fontified t) 2577 2624 (fontified t) 2624 2630 (face font-lock-string-face fontified t) 2630 2663 (fontified t) 2663 2669 (face font-lock-keyword-face fontified t) 2669 2684 (fontified t) 2684 2690 (face font-lock-keyword-face fontified t) 2690 2706 (fontified t) 2706 2710 (face font-lock-keyword-face fontified t) 2710 2982 (fontified t) 2982 2986 (face font-lock-keyword-face fontified t) 2986 2999 (fontified t) 2999 3002 (face font-lock-comment-delimiter-face fontified t) 3002 3049 (face font-lock-comment-face fontified t) 3049 3117 (fontified t) 3117 3135 (face font-lock-string-face fontified t) 3135 3143 (fontified t) 3143 3148 (face font-lock-builtin-face fontified t) 3148 3249 (fontified t) 3249 3288 (fontified t) 3288 3320 (fontified t) 3320 3323 (face font-lock-comment-delimiter-face fontified t) 3323 3366 (face font-lock-comment-face fontified t) 3366 3579 (fontified t) 3579 3582 (face font-lock-comment-delimiter-face fontified t) 3582 3615 (face font-lock-comment-face fontified t) 3615 3843 (fontified t) 3843 3846 (face font-lock-comment-delimiter-face fontified t) 3846 3890 (face font-lock-comment-face fontified t) 3890 4077 (fontified t) 4077 4082 (fontified t) 4082 4095 (fontified t) 4095 4098 (face font-lock-comment-delimiter-face fontified t) 4098 4121 (face font-lock-comment-face fontified t) 4121 4150 (fontified t) 4150 4153 (face font-lock-keyword-face fontified t) 4153 4187 (fontified t) 4187 4197 (face font-lock-builtin-face fontified t) 4197 4200 (fontified t) 4200 4206 (face font-lock-string-face fontified t) 4206 4207 (fontified t) 4207 4216 (face font-lock-string-face fontified t) 4216 4237 (fontified t) 4237 4239 (face font-lock-keyword-face fontified t) 4239 4274 (fontified t) 4274 4279 (face font-lock-keyword-face fontified t) 4279 4470 (fontified t) 4470 4474 (face font-lock-keyword-face fontified t) 4474 4550 (fontified t) 4550 4559 (face font-lock-keyword-face fontified t) 4559 4788 (fontified t) 4788 4799 (fontified t) 4799 4801 (face font-lock-string-face fontified t) 4801 4806 (fontified t) 4806 4877 (fontified t) 4877 4881 (face font-lock-keyword-face fontified t) 4881 5391 (fontified t) 5391 5395 (face font-lock-keyword-face fontified t) 5395 5407 (fontified t) 5407 5412 (face font-lock-keyword-face fontified t) 5412 5444 (fontified t) 5444 5452 (face font-lock-builtin-face fontified t) 5452 5497 (fontified t) 5497 5502 (face font-lock-builtin-face fontified t) 5502 5569 (fontified t) 5569 5577 (face font-lock-builtin-face fontified t) 5577 5582 (fontified t) 5582 5603 (fontified t) 5603 5642 (fontified t) 5642 5644 (face font-lock-keyword-face fontified t) 5644 5816 (fontified t) 5816 5818 (face font-lock-keyword-face fontified t) 5818 5869 (fontified t) 5869 5872 (face font-lock-comment-delimiter-face fontified t) 5872 5889 (face font-lock-comment-face fontified t) 5889 5920 (fontified t) 5920 5925 (face font-lock-keyword-face fontified t) 5925 6159 (fontified t) 6159 6162 (face font-lock-comment-delimiter-face fontified t) 6162 6184 (face font-lock-comment-face fontified t) 6184 6215 (fontified t) 6215 6220 (face font-lock-keyword-face fontified t) 6220 6306 (fontified t) 6306 6373 (fontified t) 6373 6442 (fontified t) 6442 6460 (face font-lock-string-face fontified t) 6460 6661 (fontified t)) . 40992) (undo-tree-id20 . -6661) (undo-tree-id21 . -6660) (undo-tree-id22 . -6661) (undo-tree-id23 . -1154) (undo-tree-id24 . -1098) (undo-tree-id25 . -1042) (undo-tree-id26 . -937) (undo-tree-id27 . -897) (undo-tree-id28 . -797) (undo-tree-id29 . -693) (undo-tree-id30 . -551) (undo-tree-id31 . -490) (undo-tree-id32 . -431) (undo-tree-id33 . -368) (undo-tree-id34 . -339) (undo-tree-id35 . -308) (undo-tree-id36 . -240) (undo-tree-id37 . -233) (undo-tree-id38 . -147) (undo-tree-id39 . -79) (undo-tree-id40 . -13) (undo-tree-id41 . -6661)) ((40992 . 47653)) (26996 51113 222623 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37508 . 37509) (nil fontified nil 31517 . 37509) (31517 . 37509)) nil (26996 52268 614240 0) 0 nil])
nil
([nil nil ((#(";;; If-Modified-Since â†’ 304 ----------------------------------------
(defun last-modified-conditional (&key (only-status '(200)))
  \"Si la rÃ©ponse porte Last-Modified, compare If-Modified-Since et renvoie 304 si applicable.
   Respecte la rÃ¨gle de prioritÃ© : si If-None-Match est prÃ©sent, on laisse l'autre middleware (ETag) dÃ©cider.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp   (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels ((->304 (resp lm)
                   (make-instance 'lumen.core.http:response
                                  :status 304
                                  :headers (lumen.utils:ensure-header
                                            (copy-list (lumen.core.http:resp-headers resp))
                                            \"last-modified\" lm)
                                  :body \"\")))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((req-h  (lumen.core.http:req-headers req))
                     (resp-h (lumen.core.http:resp-headers resp))
                     (ims    (cdr (assoc \"if-modified-since\" req-h :test #'string-equal)))
                     (inm    (cdr (assoc \"if-none-match\" req-h :test #'string-equal))) ; prioritÃ© ETag
                     (lm     (cdr (assoc \"last-modified\" resp-h :test #'string=))))
                (if (and lm ims (null inm))
                    (let* ((ims-ut (lumen.utils:parse-http-date ims))
                           (lm-ut  (lumen.utils:parse-http-date lm)))
                      (if (and ims-ut lm-ut (>= ims-ut lm-ut))
                          (->304 resp lm)
                          resp))
                    resp))
              resp))))))

;;; Session
(defun session (&key secret (ttl lumen.core.session:*session-ttl*)
                     (cookie-name lumen.core.session:*session-cookie*)
                     (http-only t) (secure lumen.core.session:*secure-cookie*)
                     (path \"/\"))
  \"Sessions mÃ©moire via cookie signÃ©. SECRET requis.\"
  (assert (and secret (plusp (length secret))) () \"session: :secret requis.\")
  (lambda (next)
    (lambda (req)
      ;; lecture cookie
      (let* ((raw (or (cookie req cookie-name) \"\"))
             (sid (and (> (length raw) 0)
                       (lumen.core.session:verify-signed-sid raw secret)))
             (data (and sid (lumen.core.session:store-get sid))))
        ;; si pas de session â†’ crÃ©er
        (unless sid
          (setf sid (lumen.core.session:make-session-id))
          (setf data '()))
        ;; mettre en ctx
        (lumen.core.http:ctx-set! req :session-id sid)
        (lumen.core.http:ctx-set! req :session    data)
        ;; suite
        (let* ((resp (funcall next req))
               (sid* (lumen.core.session:session-id req))
               (dat* (lumen.core.session:session-data req)))
          ;; persister si non-vide (ou toujours, Ã  toi de voir)
          (lumen.core.session:store-put! sid* dat* ttl)
          ;; cookie signÃ©
          (let* ((signed (lumen.core.session:sign-sid sid* secret)))
            (set-cookie! resp cookie-name signed
                         :path path :http-only http-only :secure secure
                         :max-age ttl))
          resp)))))

;;; CSRF
#|
- On gÃ©nÃ¨re un token alÃ©atoire, stockÃ© en session (:csrf) et envoyÃ© aussi au client (cookie csrf_token).
- Pour les mÃ©thodes mutables (POST, PUT, PATCH, DELETE), on vÃ©rifie que la requÃªte fournit le mÃªme token via header X-CSRF-Token ou champ de formulaire (ctx :form â†’ key \"csrf_token\").
- Si absent/incorrect â†’ 403.
|#
(defun %random-token ()
  (let* ((b (lumen.core.session:rand-bytes 32)))
    (cl-base64:usb8-array-to-base64-string b :uri t))) ; base64url

(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\")
                  (except-prefixes '())   ; ex: '(\"/login\" \"/api/webhook\")
                  (except-exact '())      ; ex: '(\"/login\" \"/signup\")
                  (skip-if nil))          ; (lambda (req) -> boolean)
  (labels ((path-exempt-p (req)
             (let ((p (lumen.core.http:req-path req)))
               (or
                ;; skip par prÃ©dicat custom
                (and skip-if (funcall skip-if req))
                ;; skip par match exact
                (member p except-exact :test #'string=)
                ;; skip par prÃ©fixe
                (some (lambda (pre)
                        (and (<= (length pre) (length p))
                             (string= pre p :end2 (length pre))))
                      except-prefixes)))))
    (lambda (next)
      (lambda (req)
        ;; (1) session requise (middleware :session doit Ãªtre avant)
        (let* ((method (lumen.core.http:req-method req))
               (mut?   (member method methods :test #'string=))
               ;; token en session (crÃ©Ã© si absent)
               (tok (or (lumen.core.session:session-get req :csrf)
                        (let ((tkn (%random-token)))
                          (lumen.core.session:session-set! req :csrf tkn) tkn))))
          (labels ((emit-cookie (resp)
                     (set-cookie! resp cookie-name tok :path path :http-only nil)))
            (cond
              ;; Cas exemptÃ© â†’ pas de vÃ©rif, mais on Ã©met/rafraÃ®chit le cookie
              ((or (not mut?) (path-exempt-p req))
               (let ((resp (funcall next req)))
                 (emit-cookie resp)
                 resp))

              ;; MÃ©thode mutable + pas exemptÃ© â†’ vÃ©rification stricte
              (t
               (let* ((hdr (lumen.core.http:req-headers req))
                      (hdr-raw (cdr (assoc header-name hdr :test #'string-equal)))
                      ;; tolÃ©rance: si on reÃ§oit littÃ©ralement \"csrf_token\", lire la valeur dans les cookies
                      (hdr-tok (if (and hdr-raw (string= hdr-raw cookie-name))
                                   (cdr (assoc cookie-name (lumen.core.http:req-cookies req) :test #'string=))
                                   hdr-raw))
                      (form (lumen.core.http:ctx-get req :form))
                      (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                      (ok (or (and hdr-tok (string= hdr-tok tok))
                              (and field-tok (string= field-tok tok)))))
                 (if ok
                     (let ((resp (funcall next req)))
                       (emit-cookie resp)
                       resp)
                     (let ((resp (lumen.core.http:respond-json
                                  '((:error . ((:type . \"csrf\")
                                               (:message . \"invalid or missing CSRF token\"))))
                                  :status 403)))
                       (emit-cookie resp) ; pour que le client rÃ©cupÃ¨re le bon token
                       resp)))))))))))

(defun %bearer-token-from (headers)
  \"Extrait proprement le Bearer token (case-insensitive, espaces tolÃ©rÃ©s).\"
  (let* ((raw (cdr (assoc \"authorization\" headers :test #'string-equal))))
    (when raw
      (let* ((s (string-trim \" \" raw)))
        (labels ((starts-with-ci (needle hay)
                   (and (>= (length hay) (length needle))
                        (string-equal needle hay :end2 (length needle)))))
          (cond
            ((starts-with-ci \"Bearer \" s) (subseq s 7))
            ((starts-with-ci \"bearer \" s) (subseq s 7))
            (t nil)))))))

(defun %alist-get-ci (alist key)
  \"getf/assoc tolÃ©rant clÃ© string/keyword (case-insensitive).\"
  (or (cdr (assoc key alist :test #'equal))
      (and (stringp key)
           (or (cdr (assoc (intern (string-upcase key) :keyword) alist :test #'eq))
               (cdr (assoc (string-downcase key) alist :test #'string=))
               (cdr (assoc (string-upcase key) alist :test #'string=))))
      (and (keywordp key)
           (or (cdr (assoc (string-downcase (symbol-name key)) alist :test #'string=))
               (cdr (assoc (string-upcase   (symbol-name key)) alist :test #'string=))))))

(defun %cookie (req name)
  (cdr (assoc name (lumen.core.http:req-cookies req) :test #'string=)))

(defun %query-token-from (req &key (keys '(\"access\" \"token\")))
  (let ((qp (lumen.core.http:req-query req)))
    (loop for k in keys
          for v = (or (%alist-get-ci qp k)
                      (%alist-get-ci qp (intern (string-upcase k) :keyword)))
          when (and v (stringp v) (> (length v) 0))
          do (return v))))

(defun auth-jwt (&key (secret nil secret-supplied-p)
                   (required-p nil)
                   (roles-allow nil)
                   (scopes-allow nil)
                   (scopes-mode :any)
                   (leeway-sec 60)
                   (allow-query-token-p t)
                   (qs-keys '(\"access\" \"token\"))
                   ;; ---- Nouveaux switches ----
                   (admin-roles '(\"admin\"))
                   (admin-bypass-roles-p t)
                   (admin-bypass-scopes-p t))
  (print \"******* IN AUTH JWT\")
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (normalize-scopes (v)
               (handler-case
                   (let* ((lst (cond
                                 ((null v) '())
                                 ((stringp v)
                                  (let* ((s (string-trim \" \" v)))
                                    (cond
                                      ((and (> (length s) 1)
                                            (char= (char s 0) #\\[)
                                            (char= (char s (1- (length s))) #\\]))
                                       (let* ((inner (subseq s 1 (1- (length s))))
                                              (parts (cl-ppcre:split \"\\\\s*,\\\\s*\" inner)))
                                         (mapcar (lambda (x) (string-trim \" \\\"\" x)) parts)))
                                      ((search \",\" s)
                                       (cl-ppcre:split \"\\\\s*,\\\\s*\" s))
                                      (t (list s)))))
                                 ((listp v) v)
                                 ((vectorp v)
                                  (if (every #'characterp v)
                                      (list (coerce v 'string))
                                      (loop for x across v append (if (stringp x) (list x) (list (princ-to-string x))))))
                                 (t (list (princ-to-string v))))))
                     (remove-duplicates
                      (remove-if (lambda (s) (or (null s) (string= s \"\")))
                                 (mapcar (lambda (s) (substitute #\\: #\\. (string s))) lst))
                      :test #'string=))
                 (error () '())))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (or (%bearer-token-from hdrs)
                           (and allow-query-token-p (%query-token-from req :keys qs-keys))
                           (%cookie req \"access_token\"))))
            ;; DÃ©codage du JWT
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                   (lumen.core.jwt:jwt-decode tok :secret secret :verify t
						  :leeway leeway-sec :debug t))
		;;(format t \"~&TOKEN: ~A~%\" tok)
		;;(format t \"~&PAYLOAD: ~A~%\" payload)
		;;(format t \"~&OK: ~A~%\" ok)
                (when ok
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (or (%alist-get-ci payload :tenant)
                                     (%alist-get-ci payload \"tenant\")))
                         (tenant-id (or (%alist-get-ci payload :tenant-id)
                                        (%alist-get-ci payload \"tenant_id\")
                                        tenant)))
                    (when tenant-id (lumen.core.http:ctx-set! req :tenant-id tenant-id))
                    (when tenant    (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt   (lumen.core.http:ctx-get req :jwt))
                   (role  (and jwt (or (%alist-get-ci jwt :role)
                                       (%alist-get-ci jwt \"role\"))))
                   (sc    (normalize-scopes (and jwt (%alist-get-ci jwt :scopes))))
                   (is-admin (and role (member role admin-roles :test #'string=)))
                   (roles-ok
                     (or (null roles-allow)
                         (member role roles-allow :test #'string=)
                         (and is-admin admin-bypass-roles-p)))
                   (scopes-ok
                     (or (null scopes-allow)
                         (has-scopes? scopes-allow sc)
                         (and is-admin admin-bypass-scopes-p))))
	      ;;(format t \"~&JWT: ~A~%\" jwt)
	      ;;(format t \"~&IS ADMIN: ~A~%\" is-admin)
	      ;;(format t \"~&IS REQUIRED ? ~A~%\" required-p)
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((not roles-ok)
                 (fail 403 \"forbidden\"))
                ((not scopes-ok)
                 (fail 403 \"insufficient_scope\"))
                (t
                 ;; Audit : note quâ€™un bypass admin a Ã©tÃ© utilisÃ© (si câ€™est le cas)
                 (when (and is-admin (or (and roles-allow admin-bypass-roles-p)
                                         (and scopes-allow admin-bypass-scopes-p)))
                   (lumen.core.http:ctx-set! req :auth-bypass \"admin\"))
                 (funcall next req))))))))))

(defun auth-required (&key (admin-bypass-roles-p t)
                           (admin-bypass-scopes-p t)
                           (allow-query-token-p t)
                           (qs-keys '(\"access\" \"token\")))
  \"JWT requis, sans contrainte de rÃ´le/scope. Bypass admin actif par dÃ©faut.\"
  (auth-jwt :required-p t
            :admin-bypass-roles-p admin-bypass-roles-p
            :admin-bypass-scopes-p admin-bypass-scopes-p
            :allow-query-token-p   allow-query-token-p
            :qs-keys               qs-keys))

(defun roles-allowed (roles &key (admin-bypass-roles-p t)
                                 (admin-bypass-scopes-p t)
                                 (allow-query-token-p t)
                                 (qs-keys '(\"access\" \"token\")))
  \"JWT requis + appartenance Ã  lâ€™un des ROLES (admin bypass par dÃ©faut).\"
  (auth-jwt :required-p t
            :roles-allow roles
            :admin-bypass-roles-p admin-bypass-roles-p
            :admin-bypass-scopes-p admin-bypass-scopes-p
            :allow-query-token-p   allow-query-token-p
            :qs-keys               qs-keys))" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 69 (face font-lock-comment-face fontified t) 69 70 (fontified t) 70 75 (face font-lock-keyword-face fontified t) 75 76 (fontified t) 76 101 (face font-lock-function-name-face fontified t) 101 103 (fontified t) 103 107 (face font-lock-type-face fontified t) 107 132 (fontified t) 132 334 (face font-lock-doc-face fontified t) 334 338 (fontified t) 338 344 (face font-lock-keyword-face fontified t) 344 357 (fontified t) 357 363 (face font-lock-keyword-face fontified t) 363 377 (fontified t) 377 381 (face font-lock-keyword-face fontified t) 381 441 (fontified t) 441 469 (fontified t) 469 476 (fontified t) 476 478 (fontified t) 478 484 (face font-lock-keyword-face fontified t) 484 503 (fontified t) 503 597 (fontified t) 597 604 (face font-lock-builtin-face fontified t) 604 643 (fontified t) 643 651 (face font-lock-builtin-face fontified t) 651 815 (fontified t) 815 830 (face font-lock-string-face fontified t) 830 869 (fontified t) 869 874 (face font-lock-builtin-face fontified t) 874 875 (fontified t) 875 877 (face font-lock-string-face fontified t) 877 892 (fontified t) 892 894 (face font-lock-keyword-face fontified t) 894 929 (fontified t) 929 975 (fontified t) 975 990 (fontified t) 990 994 (face font-lock-keyword-face fontified t) 994 1146 (fontified t) 1146 1165 (face font-lock-string-face fontified t) 1165 1172 (fontified t) 1172 1177 (face font-lock-builtin-face fontified t) 1177 1211 (fontified t) 1211 1237 (fontified t) 1237 1252 (face font-lock-string-face fontified t) 1252 1259 (fontified t) 1259 1264 (face font-lock-builtin-face fontified t) 1264 1283 (fontified t) 1283 1299 (face font-lock-comment-face fontified t) 1299 1340 (fontified t) 1340 1355 (face font-lock-string-face fontified t) 1355 1363 (fontified t) 1363 1368 (face font-lock-builtin-face fontified t) 1368 1400 (fontified t) 1400 1402 (face font-lock-keyword-face fontified t) 1402 1448 (fontified t) 1448 1452 (face font-lock-keyword-face fontified t) 1452 1498 (fontified t) 1498 1499 (fontified t) 1499 1500 (fontified t) 1500 1567 (fontified t) 1567 1590 (fontified t) 1590 1592 (face font-lock-keyword-face fontified t) 1592 1758 (fontified t) 1758 1762 (face font-lock-comment-delimiter-face fontified t) 1762 1770 (face font-lock-comment-face fontified t) 1770 1771 (fontified t) 1771 1776 (face font-lock-keyword-face fontified t) 1776 1777 (fontified t) 1777 1784 (face font-lock-function-name-face fontified t) 1784 1786 (fontified t) 1786 1790 (face font-lock-type-face fontified t) 1790 1969 (fontified t) 1969 1987 (fontified t) 1987 2003 (fontified t) 2003 2014 (fontified t) 2014 2017 (face font-lock-string-face fontified t) 2017 2020 (fontified t) 2020 2022 (fontified t) 2022 2073 (face font-lock-doc-face fontified t) 2073 2077 (fontified t) 2077 2083 (face font-lock-warning-face fontified t) 2083 2124 (fontified t) 2124 2150 (face font-lock-string-face fontified t) 2150 2155 (fontified t) 2155 2161 (face font-lock-keyword-face fontified t) 2161 2174 (fontified t) 2174 2180 (face font-lock-keyword-face fontified t) 2180 2193 (fontified t) 2193 2196 (face font-lock-comment-delimiter-face fontified t) 2196 2211 (face font-lock-comment-face fontified t) 2211 2218 (fontified t) 2218 2222 (face font-lock-keyword-face fontified t) 2222 2258 (fontified t) 2258 2260 (face font-lock-string-face fontified t) 2260 2454 (fontified t) 2454 2457 (face font-lock-comment-delimiter-face fontified t) 2457 2483 (face font-lock-comment-face fontified t) 2483 2492 (fontified t) 2492 2498 (face font-lock-keyword-face fontified t) 2498 2596 (fontified t) 2596 2599 (face font-lock-comment-delimiter-face fontified t) 2599 2613 (face font-lock-comment-face fontified t) 2613 2651 (fontified t) 2651 2662 (face font-lock-builtin-face fontified t) 2662 2668 (fontified t) 2668 2706 (fontified t) 2706 2714 (face font-lock-builtin-face fontified t) 2714 2732 (fontified t) 2732 2735 (face font-lock-comment-delimiter-face fontified t) 2735 2741 (face font-lock-comment-face fontified t) 2741 2750 (fontified t) 2750 2754 (face font-lock-keyword-face fontified t) 2754 2799 (fontified t) 2799 2840 (fontified t) 2840 2911 (fontified t) 2911 2914 (face font-lock-comment-delimiter-face fontified t) 2914 2965 (face font-lock-comment-face fontified t) 2965 3031 (fontified t) 3031 3034 (face font-lock-comment-delimiter-face fontified t) 3034 3047 (face font-lock-comment-face fontified t) 3047 3058 (fontified t) 3058 3062 (face font-lock-keyword-face fontified t) 3062 3067 (fontified t) 3067 3116 (fontified t) 3116 3190 (fontified t) 3190 3195 (face font-lock-builtin-face fontified t) 3195 3201 (fontified t) 3201 3211 (face font-lock-builtin-face fontified t) 3211 3222 (fontified t) 3222 3229 (face font-lock-builtin-face fontified t) 3229 3262 (fontified t) 3262 3270 (face font-lock-builtin-face fontified t) 3270 3298 (fontified t) 3298 3302 (face font-lock-comment-delimiter-face fontified t) 3302 3307 (face font-lock-comment-face fontified t) 3307 3309 (face font-lock-comment-delimiter-face fontified t) 3309 3520 (face font-lock-comment-face fontified t) 3520 3562 (face font-lock-comment-face fontified t) 3562 3599 (face font-lock-comment-face fontified t) 3599 3628 (face font-lock-comment-face fontified t) 3628 3630 (face font-lock-comment-delimiter-face fontified t) 3630 3632 (fontified t) 3632 3637 (face font-lock-keyword-face fontified t) 3637 3638 (fontified t) 3638 3651 (face font-lock-function-name-face fontified t) 3651 3658 (fontified t) 3658 3662 (face font-lock-keyword-face fontified t) 3662 3749 (fontified t) 3749 3753 (face font-lock-builtin-face fontified t) 3753 3759 (fontified t) 3759 3771 (face font-lock-comment-face fontified t) 3771 3772 (fontified t) 3772 3773 (fontified t) 3773 3778 (face font-lock-keyword-face fontified t) 3778 3779 (fontified t) 3779 3783 (face font-lock-function-name-face fontified t) 3783 3785 (fontified t) 3785 3789 (face font-lock-type-face fontified t) 3789 3803 (fontified t) 3803 3815 (face font-lock-string-face fontified t) 3815 3848 (fontified t) 3848 3862 (face font-lock-string-face fontified t) 3862 3893 (fontified t) 3893 3899 (face font-lock-string-face fontified t) 3899 3900 (fontified t) 3900 3905 (face font-lock-string-face fontified t) 3905 3906 (fontified t) 3906 3913 (face font-lock-string-face fontified t) 3913 3914 (fontified t) 3914 3922 (face font-lock-string-face fontified t) 3922 3949 (fontified t) 3949 3952 (face font-lock-string-face fontified t) 3952 3996 (fontified t) 3996 4029 (face font-lock-comment-face fontified t) 4029 4071 (fontified t) 4071 4099 (face font-lock-comment-face fontified t) 4099 4141 (fontified t) 4141 4169 (face font-lock-comment-face fontified t) 4169 4172 (fontified t) 4172 4178 (face font-lock-keyword-face fontified t) 4178 4215 (fontified t) 4215 4218 (face font-lock-keyword-face fontified t) 4218 4291 (fontified t) 4291 4294 (face font-lock-comment-delimiter-face fontified t) 4294 4319 (face font-lock-comment-face fontified t) 4319 4387 (fontified t) 4387 4390 (face font-lock-comment-delimiter-face fontified t) 4390 4411 (face font-lock-comment-face fontified t) 4411 4450 (fontified t) 4450 4455 (face font-lock-builtin-face fontified t) 4455 4483 (fontified t) 4483 4486 (face font-lock-comment-delimiter-face fontified t) 4486 4503 (face font-lock-comment-face fontified t) 4503 4526 (fontified t) 4526 4532 (face font-lock-keyword-face fontified t) 4532 4641 (fontified t) 4641 4646 (face font-lock-builtin-face fontified t) 4646 4711 (fontified t) 4711 4717 (face font-lock-keyword-face fontified t) 4717 4732 (fontified t) 4732 4738 (face font-lock-keyword-face fontified t) 4738 4753 (fontified t) 4753 4756 (face font-lock-comment-delimiter-face fontified t) 4756 4814 (face font-lock-comment-face fontified t) 4814 4823 (fontified t) 4823 4827 (face font-lock-keyword-face fontified t) 4827 4917 (fontified t) 4917 4922 (face font-lock-builtin-face fontified t) 4922 4950 (fontified t) 4950 4953 (face font-lock-comment-delimiter-face fontified t) 4953 4987 (face font-lock-comment-face fontified t) 4987 5047 (fontified t) 5047 5052 (face font-lock-builtin-face fontified t) 5052 5062 (fontified t) 5062 5079 (fontified t) 5079 5082 (face font-lock-keyword-face fontified t) 5082 5099 (fontified t) 5099 5107 (fontified t) 5107 5170 (fontified t) 5170 5175 (face font-lock-builtin-face fontified t) 5175 5200 (fontified t) 5200 5206 (face font-lock-keyword-face fontified t) 5206 5283 (fontified t) 5283 5288 (face font-lock-builtin-face fontified t) 5288 5294 (fontified t) 5294 5304 (face font-lock-builtin-face fontified t) 5304 5325 (fontified t) 5325 5329 (face font-lock-keyword-face fontified t) 5329 5344 (fontified t) 5344 5347 (face font-lock-comment-delimiter-face fontified t) 5347 5409 (face font-lock-comment-face fontified t) 5409 5476 (fontified t) 5476 5479 (face font-lock-keyword-face fontified t) 5479 5583 (fontified t) 5583 5586 (face font-lock-comment-delimiter-face fontified t) 5586 5639 (face font-lock-comment-face fontified t) 5639 5672 (fontified t) 5672 5676 (face font-lock-keyword-face fontified t) 5676 5777 (fontified t) 5777 5782 (face font-lock-builtin-face fontified t) 5782 5823 (fontified t) 5823 5826 (face font-lock-comment-delimiter-face fontified t) 5826 5910 (face font-lock-comment-face fontified t) 5910 5942 (fontified t) 5942 5944 (face font-lock-keyword-face fontified t) 5944 6082 (fontified t) 6082 6087 (face font-lock-builtin-face fontified t) 6087 6202 (fontified t) 6202 6207 (face font-lock-builtin-face fontified t) 6207 6255 (fontified t) 6255 6267 (face font-lock-string-face fontified t) 6267 6273 (fontified t) 6273 6278 (face font-lock-builtin-face fontified t) 6278 6449 (fontified t) 6449 6451 (face font-lock-keyword-face fontified t) 6451 6477 (fontified t) 6477 6480 (face font-lock-keyword-face fontified t) 6480 6602 (fontified t) 6602 6605 (face font-lock-keyword-face fontified t) 6605 6607 (fontified t) 6607 6643 (fontified t) 6643 6680 (fontified t) 6680 6686 (face font-lock-builtin-face fontified t) 6686 6691 (fontified t) 6691 6696 (face font-lock-builtin-face fontified t) 6696 6699 (fontified t) 6699 6705 (face font-lock-string-face fontified t) 6705 6755 (fontified t) 6755 6763 (face font-lock-builtin-face fontified t) 6763 6766 (fontified t) 6766 6797 (face font-lock-string-face fontified t) 6797 6836 (fontified t) 6836 6843 (face font-lock-builtin-face fontified t) 6843 6893 (fontified t) 6893 6936 (face font-lock-comment-face fontified t) 6936 6977 (fontified t) 6977 6982 (face font-lock-keyword-face fontified t) 6982 6983 (fontified t) 6983 7001 (face font-lock-function-name-face fontified t) 7001 7014 (fontified t) 7014 7087 (face font-lock-doc-face fontified t) 7087 7091 (fontified t) 7091 7095 (face font-lock-keyword-face fontified t) 7095 7114 (fontified t) 7114 7129 (face font-lock-string-face fontified t) 7129 7138 (fontified t) 7138 7143 (face font-lock-builtin-face fontified t) 7143 7168 (fontified t) 7168 7172 (face font-lock-keyword-face fontified t) 7172 7184 (fontified t) 7184 7188 (face font-lock-keyword-face fontified t) 7188 7206 (fontified t) 7206 7209 (face font-lock-string-face fontified t) 7209 7226 (fontified t) 7226 7232 (face font-lock-keyword-face fontified t) 7232 7370 (fontified t) 7370 7375 (face font-lock-builtin-face fontified t) 7375 7407 (fontified t) 7407 7411 (face font-lock-keyword-face fontified t) 7411 7441 (fontified t) 7441 7450 (face font-lock-string-face fontified t) 7450 7497 (fontified t) 7497 7506 (face font-lock-string-face fontified t) 7506 7552 (fontified t) 7552 7557 (face font-lock-keyword-face fontified t) 7557 7558 (fontified t) 7558 7571 (face font-lock-function-name-face fontified t) 7571 7586 (fontified t) 7586 7646 (face font-lock-doc-face fontified t) 7646 7675 (fontified t) 7675 7680 (face font-lock-builtin-face fontified t) 7680 7771 (fontified t) 7771 7779 (face font-lock-builtin-face fontified t) 7779 7787 (fontified t) 7787 7792 (face font-lock-builtin-face fontified t) 7792 7855 (fontified t) 7855 7860 (face font-lock-builtin-face fontified t) 7860 7926 (fontified t) 7926 7931 (face font-lock-builtin-face fontified t) 7931 8041 (fontified t) 8041 8046 (face font-lock-builtin-face fontified t) 8046 8128 (fontified t) 8128 8133 (face font-lock-builtin-face fontified t) 8133 8143 (fontified t) 8143 8150 (fontified t) 8150 8152 (fontified t) 8152 8157 (face font-lock-keyword-face fontified t) 8157 8158 (fontified t) 8158 8165 (face font-lock-function-name-face fontified t) 8165 8230 (fontified t) 8230 8235 (face font-lock-builtin-face fontified t) 8235 8251 (fontified t) 8251 8256 (face font-lock-keyword-face fontified t) 8256 8257 (fontified t) 8257 8274 (face font-lock-function-name-face fontified t) 8274 8280 (fontified t) 8280 8284 (face font-lock-type-face fontified t) 8284 8293 (fontified t) 8293 8301 (face font-lock-string-face fontified t) 8301 8302 (fontified t) 8302 8309 (face font-lock-string-face fontified t) 8309 8316 (fontified t) 8316 8319 (face font-lock-keyword-face fontified t) 8319 8364 (fontified t) 8364 8368 (face font-lock-keyword-face fontified t) 8368 8492 (fontified t) 8492 8500 (face font-lock-builtin-face fontified t) 8500 8570 (fontified t) 8570 8576 (face font-lock-keyword-face fontified t) 8576 8584 (fontified t) 8584 8585 (fontified t) 8585 8590 (face font-lock-keyword-face fontified t) 8590 8591 (fontified t) 8591 8599 (face font-lock-function-name-face fontified t) 8599 8601 (fontified t) 8601 8605 (face font-lock-type-face fontified t) 8605 8780 (fontified t) 8780 8784 (face font-lock-builtin-face fontified t) 8784 8894 (fontified t) 8894 8902 (face font-lock-string-face fontified t) 8902 8903 (fontified t) 8903 8910 (face font-lock-string-face fontified t) 8910 8932 (fontified t) 8932 8935 (face font-lock-comment-delimiter-face fontified t) 8935 8963 (face font-lock-comment-face fontified t) 8963 8997 (fontified t) 8997 9004 (face font-lock-string-face fontified t) 9004 9106 (fontified t) 9106 9127 (face font-lock-string-face fontified t) 9127 9132 (fontified t) 9132 9135 (face font-lock-keyword-face fontified t) 9135 9146 (fontified t) 9146 9148 (face font-lock-keyword-face fontified t) 9148 9210 (fontified t) 9210 9216 (face font-lock-keyword-face fontified t) 9216 9231 (fontified t) 9231 9237 (face font-lock-keyword-face fontified t) 9237 9253 (fontified t) 9253 9259 (face font-lock-keyword-face fontified t) 9259 9356 (fontified t) 9356 9362 (face font-lock-builtin-face fontified t) 9362 9367 (fontified t) 9367 9372 (face font-lock-builtin-face fontified t) 9372 9375 (fontified t) 9375 9381 (face font-lock-string-face fontified t) 9381 9384 (fontified t) 9384 9392 (face font-lock-builtin-face fontified t) 9392 9420 (fontified t) 9420 9427 (face font-lock-builtin-face fontified t) 9427 9488 (fontified t) 9488 9500 (face font-lock-keyword-face fontified t) 9500 9521 (fontified t) 9521 9525 (face font-lock-keyword-face fontified t) 9525 9533 (fontified t) 9533 9537 (face font-lock-keyword-face fontified t) 9537 9650 (fontified t) 9650 9667 (fontified t) 9667 9671 (face font-lock-keyword-face fontified t) 9671 9689 (fontified t) 9689 9692 (face font-lock-string-face fontified t) 9692 9698 (fontified t) 9698 9735 (fontified t) 9735 9739 (face font-lock-keyword-face fontified t) 9739 9990 (fontified t) 9990 9994 (face font-lock-keyword-face fontified t) 9994 10102 (fontified t) 10102 10113 (face font-lock-string-face fontified t) 10113 10173 (fontified t) 10173 10179 (face font-lock-keyword-face fontified t) 10179 10197 (fontified t) 10197 10202 (face font-lock-string-face fontified t) 10202 10263 (fontified t) 10263 10266 (face font-lock-string-face fontified t) 10266 10325 (fontified t) 10325 10336 (face font-lock-string-face fontified t) 10336 10523 (fontified t) 10523 10525 (face font-lock-keyword-face fontified t) 10525 10652 (fontified t) 10652 10656 (face font-lock-keyword-face fontified t) 10656 10680 (fontified t) 10680 10682 (face font-lock-keyword-face fontified t) 10682 10876 (fontified t) 10876 10882 (face font-lock-keyword-face fontified t) 10882 10911 (fontified t) 10911 10913 (face font-lock-string-face fontified t) 10913 10959 (fontified t) 10959 10965 (face font-lock-keyword-face fontified t) 10965 11031 (fontified t) 11031 11036 (face font-lock-builtin-face fontified t) 11036 11067 (fontified t) 11067 11072 (face font-lock-warning-face fontified t) 11072 11139 (fontified t) 11139 11143 (face font-lock-keyword-face fontified t) 11143 11198 (fontified t) 11198 11213 (fontified t) 11213 11217 (face font-lock-builtin-face fontified t) 11217 11219 (fontified t) 11219 11245 (fontified t) 11245 11251 (face font-lock-keyword-face fontified t) 11251 11271 (fontified t) 11271 11276 (face font-lock-builtin-face fontified t) 11276 11344 (fontified t) 11344 11350 (face font-lock-keyword-face fontified t) 11350 11370 (fontified t) 11370 11375 (face font-lock-builtin-face fontified t) 11375 11411 (fontified t) 11411 11415 (face font-lock-keyword-face fontified t) 11415 11586 (fontified t) 11586 11591 (face font-lock-builtin-face fontified t) 11591 11642 (fontified t) 11642 11656 (face font-lock-string-face fontified t) 11656 11673 (fontified t) 11673 11676 (face font-lock-comment-delimiter-face fontified t) 11676 11692 (face font-lock-comment-face fontified t) 11692 11705 (fontified t) 11705 11709 (face font-lock-keyword-face fontified t) 11709 11729 (fontified t) 11729 11733 (face font-lock-keyword-face fontified t) 11733 11748 (face font-lock-keyword-face fontified t) 11748 11781 (fontified t) 11781 11794 (face font-lock-keyword-face fontified t) 11794 11845 (fontified t) 11845 11852 (face font-lock-builtin-face fontified t) 11852 11860 (fontified t) 11860 11867 (face font-lock-builtin-face fontified t) 11867 11878 (fontified t) 11878 11885 (face font-lock-builtin-face fontified t) 11885 11897 (fontified t) 11897 11903 (face font-lock-builtin-face fontified t) 11903 11910 (fontified t) 11910 11912 (face font-lock-comment-delimiter-face fontified t) 11912 11943 (face font-lock-comment-face fontified t) 11943 11945 (fontified t) 11945 11947 (face font-lock-comment-delimiter-face fontified t) 11947 11984 (face font-lock-comment-face fontified t) 11984 11986 (fontified t) 11986 11988 (face font-lock-comment-delimiter-face fontified t) 11988 12015 (face font-lock-comment-face fontified t) 12015 12032 (fontified t) 12032 12036 (face font-lock-keyword-face fontified t) 12036 12088 (fontified t) 12088 12092 (face font-lock-builtin-face fontified t) 12092 12121 (fontified t) 12121 12125 (face font-lock-keyword-face fontified t) 12125 12162 (fontified t) 12162 12169 (face font-lock-builtin-face fontified t) 12169 12231 (fontified t) 12231 12239 (face font-lock-string-face fontified t) 12239 12306 (fontified t) 12306 12316 (face font-lock-builtin-face fontified t) 12316 12381 (fontified t) 12381 12392 (face font-lock-string-face fontified t) 12392 12465 (fontified t) 12465 12469 (face font-lock-keyword-face fontified t) 12469 12510 (fontified t) 12510 12520 (face font-lock-builtin-face fontified t) 12520 12554 (fontified t) 12554 12558 (face font-lock-keyword-face fontified t) 12558 12599 (fontified t) 12599 12606 (face font-lock-builtin-face fontified t) 12606 12632 (fontified t) 12632 12635 (face font-lock-comment-delimiter-face fontified t) 12635 12650 (face font-lock-comment-face fontified t) 12650 12663 (fontified t) 12663 12667 (face font-lock-keyword-face fontified t) 12667 12705 (fontified t) 12705 12709 (face font-lock-builtin-face fontified t) 12709 12719 (fontified t) 12719 12770 (fontified t) 12770 12775 (face font-lock-builtin-face fontified t) 12775 12777 (fontified t) 12777 12835 (fontified t) 12835 12841 (face font-lock-string-face fontified t) 12841 12918 (fontified t) 12918 12925 (face font-lock-builtin-face fontified t) 12925 12994 (fontified t) 12994 12999 (face font-lock-builtin-face fontified t) 12999 13136 (fontified t) 13136 13141 (face font-lock-builtin-face fontified t) 13141 13233 (fontified t) 13233 13246 (fontified t) 13246 13418 (fontified t) 13418 13420 (face font-lock-comment-delimiter-face fontified t) 13420 13449 (face font-lock-comment-face fontified t) 13449 13456 (fontified t) 13456 13458 (face font-lock-comment-delimiter-face fontified t) 13458 13497 (face font-lock-comment-face fontified t) 13497 13504 (fontified t) 13504 13506 (face font-lock-comment-delimiter-face fontified t) 13506 13551 (face font-lock-comment-face fontified t) 13551 13566 (fontified t) 13566 13570 (face font-lock-keyword-face fontified t) 13570 13643 (fontified t) 13643 13669 (face font-lock-string-face fontified t) 13669 13731 (fontified t) 13731 13742 (face font-lock-string-face fontified t) 13742 13805 (fontified t) 13805 13825 (face font-lock-string-face fontified t) 13825 13864 (fontified t) 13864 13867 (face font-lock-comment-delimiter-face fontified t) 13867 13931 (face font-lock-comment-face fontified t) 13931 13949 (fontified t) 13949 13953 (face font-lock-keyword-face fontified t) 13953 14144 (fontified t) 14144 14156 (face font-lock-builtin-face fontified t) 14156 14157 (fontified t) 14157 14164 (face font-lock-string-face fontified t) 14164 14213 (fontified t) 14213 14214 (fontified t) 14214 14219 (face font-lock-keyword-face fontified t) 14219 14220 (fontified t) 14220 14233 (face font-lock-function-name-face fontified t) 14233 14235 (fontified t) 14235 14239 (face font-lock-type-face fontified t) 14239 14277 (fontified t) 14277 14318 (fontified t) 14318 14407 (fontified t) 14407 14415 (face font-lock-string-face fontified t) 14415 14416 (fontified t) 14416 14423 (face font-lock-string-face fontified t) 14423 14429 (fontified t) 14429 14504 (face font-lock-doc-face fontified t) 14504 14517 (fontified t) 14517 14528 (face font-lock-builtin-face fontified t) 14528 14543 (fontified t) 14543 14564 (face font-lock-builtin-face fontified t) 14564 14598 (fontified t) 14598 14620 (face font-lock-builtin-face fontified t) 14620 14655 (fontified t) 14655 14675 (face font-lock-builtin-face fontified t) 14675 14710 (fontified t) 14710 14718 (face font-lock-builtin-face fontified t) 14718 14745 (fontified t) 14745 14750 (face font-lock-keyword-face fontified t) 14750 14751 (fontified t) 14751 14764 (face font-lock-function-name-face fontified t) 14764 14772 (fontified t) 14772 14776 (face font-lock-type-face fontified t) 14776 14962 (fontified t) 14962 14970 (face font-lock-string-face fontified t) 14970 14971 (fontified t) 14971 14978 (face font-lock-string-face fontified t) 14978 14984 (fontified t) 14984 15055 (face font-lock-doc-face fontified t) 15055 15068 (fontified t) 15068 15079 (face font-lock-builtin-face fontified t) 15079 15094 (fontified t) 15094 15106 (face font-lock-builtin-face fontified t) 15106 15125 (fontified t) 15125 15146 (face font-lock-builtin-face fontified t) 15146 15180 (fontified t) 15180 15202 (face font-lock-builtin-face fontified t) 15202 15237 (fontified t) 15237 15257 (face font-lock-builtin-face fontified t) 15257 15292 (fontified t) 15292 15300 (face font-lock-builtin-face fontified t) 15300 15324 (fontified t)) . 37511) (undo-tree-id48 . -15324)) nil (26996 52268 614239 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 47985 . 47986) (nil fontified nil 37511 . 47986) (37511 . 47986)) nil (26996 52268 614238 0) 0 nil])
([nil nil ((#(";;; HTTPS
(defun %bool (x) (and x t))

(defun %request-secure-p (req)
  \"Vrai si la requÃªte est dÃ©jÃ  HTTPS (socket TLS ou proxy qui lâ€™indique).\"
  (or (lumen.core.http:ctx-get req :secure)
      (let* ((h (lumen.core.http:req-headers req))
             (xfp (cdr (assoc \"x-forwarded-proto\" h :test #'string-equal)))
             (xfs (cdr (assoc \"x-forwarded-ssl\"   h :test #'string-equal))))
        (or (and xfp (string-equal xfp \"https\"))
            (and xfs (string-equal xfs \"on\"))))))

(defun %path-has-prefix-p (path prefix)
  (and (<= (length prefix) (length path))
       (string= prefix path :end2 (length prefix))))

(defun %build-query (req)
  \"Reconstruit la query string si possible.\"
  (let ((q (lumen.core.http:req-query req)))
    (cond
      ((null q) \"\")
      ((stringp q) (if (plusp (length q)) (concatenate 'string \"?\" q) \"\"))
      ((listp q)
       (let ((parts
               (mapcar (lambda (cell)
                         (let ((k (car cell)) (v (cdr cell)))
                           ;; k/v peuvent Ãªtre keywords ou strings
                           (format nil \"~A=~A\"
                                   (etypecase k
                                     (string k)
                                     (symbol (string-downcase (symbol-name k))))
                                   (etypecase v
                                     (string v)
                                     (symbol (string-downcase (symbol-name v)))
                                     (t (princ-to-string v))))))
                       q)))
         (if parts
             (concatenate 'string \"?\" (map 'string #'identity
                                           (with-output-to-string (s)
                                             (format s \"~{~A~^&~}\" parts))))
             \"\")))
      (t \"\"))))

(defun host-without-port (host)
  (let ((pos (position #\\: host)))
    (if pos (subseq host 0 pos) host)))

(defun %https-location (req &key ssl-port)
  \"Construit lâ€™URL de redirection https (conserve host, path, query).
   Ajoute :ssl-port si non standard (â‰ 443).\"
  (let* ((h    (lumen.core.http:req-headers req))
         (host (or (cdr (assoc \"x-forwarded-host\" h :test #'string-equal))
                   (cdr (assoc \"host\"             h :test #'string-equal))
                   \"localhost\"))
	 (host0 (host-without-port host))
         (path (lumen.core.http:req-path req))
         (qs   (%build-query req))
         (port-suffix (if (and ssl-port (not (= ssl-port 443)))
                          (format nil \":~D\" ssl-port) \"\"))
         (scheme \"https://\"))
    (format nil \"~A~A~A~A~A\" scheme host0 port-suffix path qs)))

(defun https-redirect (&key
                         (prefixes '(\"/\"))            ; prÃ©fixes Ã  forcer en HTTPS
                         (except-prefixes nil)         ; prÃ©fixes EXCLUS (pas de redirect/HSTS)
                         (ssl-port 443)                ; port public HTTPS
                         (hsts nil)                    ; t â‡’ ajoute Strict-Transport-Security (sur HTTPS)
                         (hsts-max-age 15552000)       ; 180 jours
                         (hsts-include-subdomains t)
                         (hsts-preload nil))
  \"Redirige HTTP â†’ HTTPS (301) pour les chemins dont le prÃ©fixe matche.
Options:
- PREFIXES         : liste de prÃ©fixes (strings) Ã  forcer en https (\\\"/\\\" pour tout).
- EXCEPT-PREFIXES  : liste de prÃ©fixes Ã  EXCLURE (pas de redirect, pas de HSTS).
- SSL-PORT         : port https externe (443 par dÃ©faut).
- HSTS             : si T, ajoute Strict-Transport-Security *sur les rÃ©ponses HTTPS*
                     (sauf si le chemin est exclu par EXCEPT-PREFIXES).\"
  (labels ((matches-any-p (path lst)
             (and lst (some (lambda (pfx) (%path-has-prefix-p path pfx)) lst))))
    (lambda (next)
      (lambda (req)
        (let* ((path     (lumen.core.http:req-path req))
               (in-scope (matches-any-p path prefixes))
               (excluded (matches-any-p path except-prefixes))
               (secure?  (%request-secure-p req)))
          (cond
            ;; DÃ©jÃ  en HTTPS : on passe au suivant, et on pose HSTS si demandÃ© (et non exclu)
            (secure?
             (let ((resp (funcall next req)))
               (when (and hsts (not excluded))
                 (let* ((hdrs (lumen.core.http:resp-headers resp))
                        (val  (with-output-to-string (s)
                                (format s \"max-age=~D\" hsts-max-age)
                                (when hsts-include-subdomains (format s \"; includeSubDomains\"))
                                (when hsts-preload           (format s \"; preload\")))))
                   (setf (lumen.core.http:resp-headers resp)
                         (lumen.utils:ensure-header hdrs \"strict-transport-security\" val))))
               resp))

            ;; HTTP + ciblÃ© + non exclu â†’ 301 vers HTTPS
            ((and in-scope (not excluded) (not secure?))
             (let* ((loc (%https-location req :ssl-port ssl-port))
                    (headers (list (cons \"location\" loc)
                                   (cons \"cache-control\" \"no-store\"))))
               (make-instance 'lumen.core.http:response
                              :status 301 :headers headers :body \"\")))

            ;; HTTP hors-scope ou exclu â†’ passer au suivant
            (t
             (funcall next req))))))))

;;Le rate limiting contrÃ´le combien de fois un client peut appeler une route
;; dans une pÃ©riode donnÃ©e. Câ€™est une protection anti-abus / DDoS / brute-force.
(defun rate-limit (&key (capacity 10) (refill-per-sec 1) (route-key \"default\"))
  (lambda (next)
    (lambda (req)
      (if (lumen.core.ratelimit:allow? req :capacity capacity
					   :refill-per-sec refill-per-sec
					   :route-key route-key)
          (funcall next req)
          (lumen.core.http:respond-json
           '((:error . ((:type . \"rate_limit\") (:message . \"Too Many Requests\"))))
           :status 429)))))

;;; Request Timeout (504 si le handler dÃ©passe N ms)
(defun request-timeout (&key (ms 5000))
  (lambda (next)
    (lambda (req)
      (let* ((lock (bordeaux-threads:make-lock \"rt-lock\"))
             (cv   (bordeaux-threads:make-condition-variable))
             (resp nil))
	(bordeaux-threads:make-thread
	 (lambda ()
	   (let ((r (funcall next req)))
             (bordeaux-threads:with-lock-held (lock)
               (setf resp r)
               (bordeaux-threads:condition-notify cv)))))
	(bordeaux-threads:with-lock-held (lock)
	  (unless (bordeaux-threads:condition-wait cv lock :timeout (/ ms 1000.0))
            ;; timeout â†’ 504
            (return-from request-timeout
              (lumen.core.http:respond-json
               '((:error . ((:type . \"timeout\") (:message . \"gateway timeout\"))))
               :status 504))))
	resp))))

;;; max-body-size (413 si Content-Length trop grand)
(defun max-body-size (&key (bytes (* 2 1024 1024))) ; 2 MiB
  (lambda (next)
    (lambda (req)
      (let* ((clen (cdr (assoc \"content-length\" (lumen.core.http:req-headers req)
                               :test #'string-equal)))
             (n (and clen (parse-integer clen :junk-allowed t))))
	(when (and n (> n bytes))
	  (return-from max-body-size
            (lumen.core.http:respond-json
             `((:error . ((:type . \"payload_too_large\")
			  (:message . ,(format nil \"max ~D bytes\" bytes)))))
             :status 413))))
      ;; pour les cas sans Content-Length, on laisse les parseurs respecter une limite via ctx si tu veux
      (lumen.core.http:ctx-set! req :max-body-size bytes)
      (funcall next req))))" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 10 (face font-lock-comment-face fontified t) 10 11 (fontified t) 11 16 (face font-lock-keyword-face fontified t) 16 17 (fontified t) 17 22 (face font-lock-function-name-face fontified t) 22 40 (fontified t) 40 45 (face font-lock-keyword-face fontified t) 45 46 (fontified t) 46 63 (face font-lock-function-name-face fontified t) 63 72 (fontified t) 72 144 (face font-lock-doc-face fontified t) 144 180 (fontified t) 180 187 (face font-lock-builtin-face fontified t) 187 196 (fontified t) 196 200 (face font-lock-keyword-face fontified t) 200 270 (fontified t) 270 289 (face font-lock-string-face fontified t) 289 292 (fontified t) 292 297 (face font-lock-builtin-face fontified t) 297 346 (fontified t) 346 363 (face font-lock-string-face fontified t) 363 368 (fontified t) 368 373 (face font-lock-builtin-face fontified t) 373 432 (fontified t) 432 439 (face font-lock-string-face fontified t) 439 481 (fontified t) 481 485 (face font-lock-string-face fontified t) 485 492 (fontified t) 492 494 (fontified t) 494 499 (face font-lock-keyword-face fontified t) 499 500 (fontified t) 500 518 (face font-lock-function-name-face fontified t) 518 603 (fontified t) 603 608 (face font-lock-builtin-face fontified t) 608 629 (fontified t) 629 630 (fontified t) 630 635 (face font-lock-keyword-face fontified t) 635 636 (fontified t) 636 648 (face font-lock-function-name-face fontified t) 648 657 (fontified t) 657 699 (face font-lock-doc-face fontified t) 699 703 (fontified t) 703 706 (face font-lock-keyword-face fontified t) 706 712 (fontified t) 712 745 (fontified t) 745 750 (fontified t) 750 754 (face font-lock-keyword-face fontified t) 754 771 (fontified t) 771 773 (face font-lock-string-face fontified t) 773 795 (fontified t) 795 797 (face font-lock-keyword-face fontified t) 797 838 (fontified t) 838 841 (face font-lock-string-face fontified t) 841 845 (fontified t) 845 847 (face font-lock-string-face fontified t) 847 875 (fontified t) 875 878 (face font-lock-keyword-face fontified t) 878 911 (fontified t) 911 917 (face font-lock-keyword-face fontified t) 917 951 (fontified t) 951 954 (face font-lock-keyword-face fontified t) 954 1014 (fontified t) 1014 1017 (face font-lock-comment-delimiter-face fontified t) 1017 1054 (face font-lock-comment-face fontified t) 1054 1093 (fontified t) 1093 1100 (face font-lock-string-face fontified t) 1100 1137 (fontified t) 1137 1146 (face font-lock-keyword-face fontified t) 1146 1314 (fontified t) 1314 1323 (face font-lock-keyword-face fontified t) 1323 1557 (fontified t) 1557 1559 (face font-lock-keyword-face fontified t) 1559 1600 (fontified t) 1600 1603 (face font-lock-string-face fontified t) 1603 1672 (fontified t) 1672 1693 (face font-lock-keyword-face fontified t) 1693 1753 (fontified t) 1753 1764 (face font-lock-string-face fontified t) 1764 1788 (fontified t) 1788 1790 (face font-lock-string-face fontified t) 1790 1803 (fontified t) 1803 1805 (face font-lock-string-face fontified t) 1805 1812 (fontified t) 1812 1817 (face font-lock-keyword-face fontified t) 1817 1818 (fontified t) 1818 1835 (face font-lock-function-name-face fontified t) 1835 1846 (fontified t) 1846 1849 (face font-lock-keyword-face fontified t) 1849 1883 (fontified t) 1883 1885 (face font-lock-keyword-face fontified t) 1885 1919 (fontified t) 1919 1920 (fontified t) 1920 1925 (face font-lock-keyword-face fontified t) 1925 1926 (fontified t) 1926 1941 (face font-lock-function-name-face fontified t) 1941 1947 (fontified t) 1947 1951 (face font-lock-type-face fontified t) 1951 1964 (fontified t) 1964 1992 (face font-lock-doc-face fontified t) 1992 2032 (face font-lock-doc-face fontified t) 2032 2076 (face font-lock-doc-face fontified t) 2076 2080 (fontified t) 2080 2084 (face font-lock-keyword-face fontified t) 2084 2158 (fontified t) 2158 2176 (face font-lock-string-face fontified t) 2176 2179 (fontified t) 2179 2184 (face font-lock-builtin-face fontified t) 2184 2233 (fontified t) 2233 2239 (face font-lock-string-face fontified t) 2239 2245 (fontified t) 2245 2254 (fontified t) 2254 2259 (face font-lock-builtin-face fontified t) 2259 2277 (fontified t) 2277 2296 (fontified t) 2296 2307 (face font-lock-string-face fontified t) 2307 2450 (fontified t) 2450 2452 (face font-lock-keyword-face fontified t) 2452 2529 (fontified t) 2529 2534 (face font-lock-string-face fontified t) 2534 2545 (fontified t) 2545 2547 (face font-lock-string-face fontified t) 2547 2567 (fontified t) 2567 2577 (face font-lock-string-face fontified t) 2577 2596 (fontified t) 2596 2608 (face font-lock-string-face fontified t) 2608 2646 (fontified t) 2646 2647 (fontified t) 2647 2652 (face font-lock-keyword-face fontified t) 2652 2653 (fontified t) 2653 2667 (face font-lock-function-name-face fontified t) 2667 2669 (fontified t) 2669 2673 (face font-lock-type-face fontified t) 2673 2711 (fontified t) 2711 2714 (face font-lock-string-face fontified t) 2714 2728 (fontified t) 2728 2757 (face font-lock-comment-face fontified t) 2757 2812 (fontified t) 2812 2853 (face font-lock-comment-face fontified t) 2853 2908 (fontified t) 2908 2928 (face font-lock-comment-face fontified t) 2928 2983 (fontified t) 2983 3034 (face font-lock-comment-face fontified t) 3034 3089 (fontified t) 3089 3101 (face font-lock-comment-face fontified t) 3101 3201 (fontified t) 3201 3662 (face font-lock-doc-face fontified t) 3662 3666 (fontified t) 3666 3672 (face font-lock-keyword-face fontified t) 3672 3729 (fontified t) 3729 3735 (face font-lock-keyword-face fontified t) 3735 3777 (fontified t) 3777 3781 (fontified t) 3781 3786 (fontified t) 3786 3792 (face font-lock-keyword-face fontified t) 3792 3807 (fontified t) 3807 3813 (face font-lock-keyword-face fontified t) 3813 3829 (fontified t) 3829 3833 (face font-lock-keyword-face fontified t) 3833 4058 (fontified t) 4058 4062 (face font-lock-keyword-face fontified t) 4062 4075 (fontified t) 4075 4078 (face font-lock-comment-delimiter-face fontified t) 4078 4157 (face font-lock-comment-face fontified t) 4157 4192 (fontified t) 4192 4195 (face font-lock-keyword-face fontified t) 4195 4240 (fontified t) 4240 4244 (face font-lock-keyword-face fontified t) 4244 4289 (fontified t) 4289 4293 (face font-lock-keyword-face fontified t) 4293 4369 (fontified t) 4369 4390 (face font-lock-keyword-face fontified t) 4390 4437 (fontified t) 4437 4449 (face font-lock-string-face fontified t) 4449 4497 (fontified t) 4497 4501 (face font-lock-keyword-face fontified t) 4501 4536 (fontified t) 4536 4557 (face font-lock-string-face fontified t) 4557 4593 (fontified t) 4593 4597 (face font-lock-keyword-face fontified t) 4597 4631 (fontified t) 4631 4642 (face font-lock-string-face fontified t) 4642 4766 (fontified t) 4766 4793 (face font-lock-string-face fontified t) 4793 4837 (fontified t) 4837 4840 (face font-lock-comment-delimiter-face fontified t) 4840 4882 (face font-lock-comment-face fontified t) 4882 4953 (fontified t) 4953 4957 (face font-lock-keyword-face fontified t) 4957 4985 (fontified t) 4985 4994 (face font-lock-builtin-face fontified t) 4994 5047 (fontified t) 5047 5057 (face font-lock-string-face fontified t) 5057 5104 (fontified t) 5104 5119 (face font-lock-string-face fontified t) 5119 5120 (fontified t) 5120 5130 (face font-lock-string-face fontified t) 5130 5221 (fontified t) 5221 5228 (face font-lock-builtin-face fontified t) 5228 5233 (fontified t) 5233 5241 (face font-lock-builtin-face fontified t) 5241 5250 (fontified t) 5250 5255 (face font-lock-builtin-face fontified t) 5255 5256 (fontified t) 5256 5258 (face font-lock-string-face fontified t) 5258 5275 (fontified t) 5275 5278 (face font-lock-comment-delimiter-face fontified t) 5278 5281 (face font-lock-comment-face fontified t) 5281 5323 (face font-lock-comment-face fontified t) 5323 5378 (fontified t) 5378 5380 (face font-lock-comment-delimiter-face fontified t) 5380 5455 (face font-lock-comment-face fontified t) 5455 5458 (face font-lock-comment-delimiter-face fontified t) 5458 5536 (face font-lock-comment-face fontified t) 5536 5537 (fontified t) 5537 5542 (face font-lock-keyword-face fontified t) 5542 5543 (fontified t) 5543 5553 (face font-lock-function-name-face fontified t) 5553 5555 (fontified t) 5555 5559 (face font-lock-type-face fontified t) 5559 5604 (fontified t) 5604 5613 (face font-lock-string-face fontified t) 5613 5619 (fontified t) 5619 5625 (face font-lock-keyword-face fontified t) 5625 5638 (fontified t) 5638 5644 (face font-lock-keyword-face fontified t) 5644 5658 (fontified t) 5658 5660 (face font-lock-keyword-face fontified t) 5660 5694 (fontified t) 5694 5703 (face font-lock-builtin-face fontified t) 5703 5721 (fontified t) 5721 5736 (face font-lock-builtin-face fontified t) 5736 5760 (fontified t) 5760 5770 (face font-lock-builtin-face fontified t) 5770 5865 (fontified t) 5865 5871 (face font-lock-builtin-face fontified t) 5871 5876 (fontified t) 5876 5881 (face font-lock-builtin-face fontified t) 5881 5884 (fontified t) 5884 5896 (face font-lock-string-face fontified t) 5896 5899 (fontified t) 5899 5907 (face font-lock-builtin-face fontified t) 5907 5910 (fontified t) 5910 5929 (face font-lock-string-face fontified t) 5929 5945 (fontified t) 5945 5952 (face font-lock-builtin-face fontified t) 5952 5963 (fontified t) 5963 5967 (face font-lock-comment-delimiter-face fontified t) 5967 6016 (face font-lock-comment-face fontified t) 6016 6017 (fontified t) 6017 6022 (face font-lock-keyword-face fontified t) 6022 6023 (fontified t) 6023 6038 (face font-lock-function-name-face fontified t) 6038 6040 (fontified t) 6040 6044 (face font-lock-type-face fontified t) 6044 6059 (fontified t) 6059 6065 (face font-lock-keyword-face fontified t) 6065 6078 (fontified t) 6078 6084 (face font-lock-keyword-face fontified t) 6084 6098 (fontified t) 6098 6102 (face font-lock-keyword-face fontified t) 6102 6138 (fontified t) 6138 6147 (face font-lock-string-face fontified t) 6147 6272 (fontified t) 6272 6278 (face font-lock-keyword-face fontified t) 6278 6287 (fontified t) 6287 6290 (face font-lock-keyword-face fontified t) 6290 6330 (fontified t) 6330 6361 (face font-lock-keyword-face fontified t) 6361 6458 (fontified t) 6458 6489 (face font-lock-keyword-face fontified t) 6489 6501 (fontified t) 6501 6507 (face font-lock-keyword-face fontified t) 6507 6549 (fontified t) 6549 6557 (face font-lock-builtin-face fontified t) 6557 6585 (fontified t) 6585 6588 (face font-lock-comment-delimiter-face fontified t) 6588 6602 (face font-lock-comment-face fontified t) 6602 6615 (fontified t) 6615 6626 (face font-lock-keyword-face fontified t) 6626 6705 (fontified t) 6705 6711 (face font-lock-builtin-face fontified t) 6711 6716 (fontified t) 6716 6721 (face font-lock-builtin-face fontified t) 6721 6724 (fontified t) 6724 6733 (face font-lock-string-face fontified t) 6733 6736 (fontified t) 6736 6744 (face font-lock-builtin-face fontified t) 6744 6747 (fontified t) 6747 6764 (face font-lock-string-face fontified t) 6764 6784 (fontified t) 6784 6791 (face font-lock-builtin-face fontified t) 6791 6811 (fontified t) 6811 6815 (face font-lock-comment-delimiter-face fontified t) 6815 6823 (face font-lock-comment-face fontified t) 6823 6864 (fontified t face font-lock-comment-face) 6864 6865 (fontified t) 6865 6870 (face font-lock-keyword-face fontified t) 6870 6871 (fontified t) 6871 6884 (face font-lock-function-name-face fontified t) 6884 6886 (fontified t) 6886 6890 (face font-lock-type-face fontified t) 6890 6916 (fontified t) 6916 6924 (face font-lock-comment-face fontified t) 6924 6927 (fontified t) 6927 6933 (face font-lock-keyword-face fontified t) 6933 6946 (fontified t) 6946 6952 (face font-lock-keyword-face fontified t) 6952 6966 (fontified t) 6966 6970 (face font-lock-keyword-face fontified t) 6970 6990 (fontified t) 6990 7006 (face font-lock-string-face fontified t) 7006 7072 (fontified t) 7072 7077 (face font-lock-builtin-face fontified t) 7077 7142 (fontified t) 7142 7155 (face font-lock-builtin-face fontified t) 7155 7164 (fontified t) 7164 7168 (face font-lock-keyword-face fontified t) 7168 7193 (fontified t) 7193 7204 (face font-lock-keyword-face fontified t) 7204 7277 (fontified t) 7277 7283 (face font-lock-builtin-face fontified t) 7283 7288 (fontified t) 7288 7293 (face font-lock-builtin-face fontified t) 7293 7296 (fontified t) 7296 7315 (face font-lock-string-face fontified t) 7315 7323 (fontified t) 7323 7331 (face font-lock-builtin-face fontified t) 7331 7347 (fontified t) 7347 7361 (face font-lock-string-face fontified t) 7361 7386 (fontified t) 7386 7393 (face font-lock-builtin-face fontified t) 7393 7408 (fontified t) 7408 7411 (face font-lock-comment-delimiter-face fontified t) 7411 7508 (face font-lock-comment-face fontified t) 7508 7544 (fontified t) 7544 7558 (face font-lock-builtin-face fontified t) 7558 7593 (fontified t)) . -47988) (undo-tree-id46 . -6456) (undo-tree-id47 . -7593) 55581) nil (26996 52268 614236 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 53805 . 53806) (nil fontified nil 47988 . 53806) (47988 . 53806)) nil (26996 52268 614235 0) 0 nil])
([nil nil ((#(";;; Access Log JSON
(defun %open-log-file (path)
  (open path :direction :output :if-exists :append :if-does-not-exist :create
             :external-format :utf-8))

(defun %rfc3339-now ()
  (local-time:format-timestring
   nil (local-time:now)
   :format '(:year \"-\" (:month 2) \"-\" (:day 2) \"T\" (:hour 2) \":\" (:min 2) \":\" (:sec 2) \"Z\")))

(defun %plist->alist (plist)
  (loop for (k v) on plist by #'cddr collect (cons k v)))

(defun %normalize-fields (fields req resp ms bytes)
  \"Retourne une alist Ã  partir de FIELDS (NIL | alist | plist | fn).\"
  (cond
    ((null fields) nil)
    ((and (listp fields)
          (every #'consp fields)) fields)                  ; dÃ©jÃ  alist
    ((and (listp fields) (evenp (length fields))) (%plist->alist fields)) ; plist
    ((functionp fields) (let ((res (funcall fields req resp ms bytes)))
                          (cond
                            ((null res) nil)
                            ((and (listp res) (every #'consp res)) res)
                            ((and (listp res) (evenp (length res))) (%plist->alist res))
                            (t nil))))
    (t nil)))

(defun %merge-alist (base extras &key (test #'equal))
  \"Merge en donnant prioritÃ© Ã  EXTRAS (override).\"
  (let ((res (copy-list base)))
    (dolist (kv extras)
      (let* ((k (car kv))
             (cell (assoc k res :test test)))
        (if cell
            (setf (cdr cell) (cdr kv))
            (push kv res))))
    (nreverse res)))

(defun access-log-json (&key stream to-file fields)
  \"Middleware: Ã©crit une ligne JSON par requÃªte.
:fields accepte NIL, alist, plist, ou (lambda (req resp ms bytes) -> alist/plist).\"
  (let* ((out (or (and to-file (%open-log-file to-file))
                  (or stream *standard-output*)))
         (lock (bordeaux-threads:make-lock \"access-log-json\")))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0  (get-internal-real-time))
                 (rid (or (lumen.core.http:ctx-get req :request-id) \"\"))
                 (ip  (or (let* ((xff (h \"x-forwarded-for\")))
                            (and xff (car (uiop:split-string xff :separator \",\"))))
                          (h \"x-real-ip\") \"\"))
                 (mth (or (lumen.core.http:req-method req) \"GET\"))
                 (host (or (h \"host\") \"\"))
                 (pth (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms  (/ (- (get-internal-real-time) t0)
                         (/ internal-time-units-per-second 1000.0)))
                 (body (lumen.core.http:resp-body resp))
                 (bytes (cond
                          ((stringp body) (length (trivial-utf-8:string-to-utf-8-bytes body)))
                          ((typep body '(simple-array (unsigned-byte 8) (*))) (length body))
                          (t nil))) ; streaming inconnu â†’ omis
                 (base `((:ts . ,(%rfc3339-now))
                         (:request_id . ,rid)
                         (:ip . ,ip)
                         (:method . ,mth)
                         (:host . ,host)
                         (:path . ,pth)
                         (:status . ,(lumen.core.http:resp-status resp))
                         (:ms . ,(round ms))
                         ,@(when bytes `((:bytes . ,bytes)))))
                 (extra (%normalize-fields fields req resp ms bytes))
                 (obj   (%merge-alist base extra :test
                                      (lambda (a b)
                                        (string-equal (if (symbolp a) (symbol-name a) (format nil \"~A\" a))
                                                      (if (symbolp b) (symbol-name b) (format nil \"~A\" b)))))))
            (bordeaux-threads:with-lock-held (lock)
              (handler-case
                  (progn
                    (write-string (cl-json:encode-json-to-string obj) out)
                    (terpri out)
                    (finish-output out))
                (error (_)
                  (declare (ignore _))
                  (format out \"~S~%\" obj)
                  (finish-output out))))
            resp))))))

;;;--------------------------------------------------------------------------
;;; Le middleware request-context (lÃ©ger, idempotent) qui remplit ctx avec :ip, :ua, :tenant-id (dÃ©jÃ  posÃ© par ton tenant-from-host) et garantit :request-id (+ renvoi dans le header X-Request-ID)
;;;--------------------------------------------------------------------------
;; ---- Helpers ---------------------------------------------------------------
(defun %header (req name)
  (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal)))

(defun %peer-ip (req)
  \"IP client en respectant les proxys (X-Forwarded-For / X-Real-IP),
   ou ctx[:remote-addr] posÃ©e par le serveur, sinon \\\"-\\\".\"
  (or (let* ((xff (%header req \"x-forwarded-for\")))
        (when xff
          (string-trim \" \" (car (uiop:split-string xff :separator \",\")))))
      (%header req \"x-real-ip\")
      (lumen.core.http:ctx-get req :remote-addr)
      \"-\"))

(defun %user-agent (req)
  (or (%header req \"user-agent\") \"\"))

(defun %aget-ci (alist &rest keys)
  (loop for k in keys
        for v = (or (cdr (assoc k alist :test #'string=))
                    (and (symbolp k) (cdr (assoc (intern (string-upcase (symbol-name k)) :keyword) alist))))
        when v do (return v)))

(defun %normalize-scopes-loose (v)
  \"Accepte liste/vecteur/csv/[...] string â†’ liste de scopes normalisÃ©s (courriers.read â†’ courriers:read).\"
  (handler-case
      (let* ((lst (cond
                    ((null v) '())
                    ((listp v) v)
                    ((vectorp v) (loop for x across v collect x))
                    ((stringp v)
                     (let ((s (string-trim \" \" v)))
                       (cond
                         ((and (> (length s) 1)
                               (char= (char s 0) #\\[)
                               (char= (char s (1- (length s))) #\\]))
                          (let* ((inner (subseq s 1 (1- (length s))))
                                 (parts (cl-ppcre:split \"\\\\s*,\\\\s*\" inner)))
                            (mapcar (lambda (x) (string-trim \" \\\"\" x)) parts)))
                         ((search \",\" s)
                          (cl-ppcre:split \"\\\\s*,\\\\s*\" s))
                         (t (list s)))))
                    (t (list (princ-to-string v))))))
        (remove-duplicates
         (remove-if (lambda (s) (or (null s) (string= s \"\")))
                    (mapcar (lambda (s) (substitute #\\: #\\. (string s))) lst))
         :test #'string=))
    (error () '())))

;; ---- Middleware request-context -------------------------------------------
(defun request-context (&key (generate-request-id-p t) (audit-config-key :audit/enabled))
  \"Middleware: enrichit req.ctx avec actor-id, role, scopes, tenant-id/tenant-code (si prÃ©sents),
   request-id, ip, ua et audit?.\"
  (lambda (next)
    (lambda (req)
      ;; request-id (si pas dÃ©jÃ  posÃ© par un autre mw)
      (print \"IN REQUEST-CONTEXT\")
      (when generate-request-id-p
        (unless (lumen.core.http:ctx-get req :request-id)
          (lumen.core.http:ctx-set! req :request-id (lumen.utils:gen-uuid-string))))
      ;; ip / ua
      (let* ((hdrs (lumen.core.http:req-headers req))
             (ip  (%peer-ip req))
         (ua  (%user-agent req)))
        (when ua (lumen.core.http:ctx-set! req :ua ua))
        (when ip (lumen.core.http:ctx-set! req :ip ip)))
      ;; JWT dÃ©jÃ  dÃ©codÃ© par auth-jwt â†’ current-user-id/role/scopes
      (let* ((actor (lumen.core.http:current-user-id req))
             (role  (lumen.core.http:current-role req))
             (jwt   (lumen.core.http:ctx-get req :jwt))
             (sc    (%normalize-scopes-loose (%aget-ci jwt :scopes \"scopes\")))
             (tenant-id (or (lumen.core.http:ctx-get req :tenant-id)
                            (%aget-ci jwt :tenant-id \"tenant_id\" :tenant \"tenant\"))))
        (when actor (lumen.core.http:ctx-set! req :actor-id actor))
        (when role  (lumen.core.http:ctx-set! req :role role))
        (when sc    (lumen.core.http:ctx-set! req :scopes sc))
        (when tenant-id (lumen.core.http:ctx-set! req :tenant-id tenant-id)))
      ;; audit?
      (let ((audit? (lumen.core.config:cfg-get audit-config-key :default t)))
        (lumen.core.http:ctx-set! req :audit? audit?))
      (funcall next req))))
" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 20 (face font-lock-comment-face fontified t) 20 21 (fontified t) 21 26 (face font-lock-keyword-face fontified t) 26 27 (fontified t) 27 41 (face font-lock-function-name-face fontified t) 41 62 (fontified t) 62 72 (face font-lock-builtin-face fontified t) 72 73 (fontified t) 73 80 (face font-lock-builtin-face fontified t) 80 81 (fontified t) 81 91 (face font-lock-builtin-face fontified t) 91 92 (fontified t) 92 99 (face font-lock-builtin-face fontified t) 99 100 (fontified t) 100 118 (face font-lock-builtin-face fontified t) 118 119 (fontified t) 119 126 (face font-lock-builtin-face fontified t) 126 140 (fontified t) 140 156 (face font-lock-builtin-face fontified t) 156 157 (fontified t) 157 163 (face font-lock-builtin-face fontified t) 163 168 (fontified t) 168 173 (face font-lock-keyword-face fontified t) 173 174 (fontified t) 174 186 (face font-lock-function-name-face fontified t) 186 249 (fontified t) 249 256 (face font-lock-builtin-face fontified t) 256 259 (fontified t) 259 264 (face font-lock-builtin-face fontified t) 264 265 (fontified t) 265 268 (face font-lock-string-face fontified t) 268 270 (fontified t) 270 276 (face font-lock-builtin-face fontified t) 276 280 (fontified t) 280 283 (face font-lock-string-face fontified t) 283 285 (fontified t) 285 289 (face font-lock-builtin-face fontified t) 289 293 (fontified t) 293 296 (face font-lock-string-face fontified t) 296 298 (fontified t) 298 303 (face font-lock-builtin-face fontified t) 303 307 (fontified t) 307 310 (face font-lock-string-face fontified t) 310 312 (fontified t) 312 316 (face font-lock-builtin-face fontified t) 316 320 (fontified t) 320 323 (face font-lock-string-face fontified t) 323 325 (fontified t) 325 329 (face font-lock-builtin-face fontified t) 329 333 (fontified t) 333 336 (face font-lock-string-face fontified t) 336 342 (fontified t) 342 347 (face font-lock-keyword-face fontified t) 347 348 (fontified t) 348 361 (face font-lock-function-name-face fontified t) 361 373 (fontified t) 373 377 (face font-lock-keyword-face fontified t) 377 429 (fontified t) 429 430 (fontified t) 430 435 (face font-lock-keyword-face fontified t) 435 436 (fontified t) 436 453 (face font-lock-function-name-face fontified t) 453 483 (fontified t) 483 550 (face font-lock-doc-face fontified t) 550 554 (fontified t) 554 558 (face font-lock-keyword-face fontified t) 558 642 (fontified t) 642 667 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t) 667 679 (help-echo "Easy to misread; consider moving the element to the next line" face (font-lock-warning-face font-lock-comment-face) fontified t) 679 680 (face font-lock-comment-face fontified t) 680 754 (fontified t) 754 755 (face font-lock-comment-face fontified t) 755 762 (face font-lock-comment-face fontified t) 762 769 (fontified t) 769 787 (fontified t) 787 790 (face font-lock-keyword-face fontified t) 790 834 (fontified t) 834 861 (fontified t) 861 865 (face font-lock-keyword-face fontified t) 865 1127 (fontified t) 1127 1132 (face font-lock-keyword-face fontified t) 1132 1133 (fontified t) 1133 1145 (face font-lock-function-name-face fontified t) 1145 1159 (fontified t) 1159 1163 (face font-lock-type-face fontified t) 1163 1182 (fontified t) 1182 1230 (face font-lock-doc-face fontified t) 1230 1234 (fontified t) 1234 1237 (face font-lock-keyword-face fontified t) 1237 1268 (fontified t) 1268 1274 (face font-lock-keyword-face fontified t) 1274 1294 (fontified t) 1294 1298 (face font-lock-keyword-face fontified t) 1298 1345 (fontified t) 1345 1350 (face font-lock-builtin-face fontified t) 1350 1368 (fontified t) 1368 1370 (face font-lock-keyword-face fontified t) 1370 1466 (fontified t) 1466 1467 (fontified t) 1467 1472 (face font-lock-keyword-face fontified t) 1472 1473 (fontified t) 1473 1488 (face font-lock-function-name-face fontified t) 1488 1490 (fontified t) 1490 1494 (face font-lock-type-face fontified t) 1494 1520 (fontified t) 1520 1650 (face font-lock-doc-face fontified t) 1650 1654 (fontified t) 1654 1658 (face font-lock-keyword-face fontified t) 1658 1801 (fontified t) 1801 1818 (face font-lock-string-face fontified t) 1818 1827 (fontified t) 1827 1833 (face font-lock-keyword-face fontified t) 1833 1848 (fontified t) 1848 1854 (face font-lock-keyword-face fontified t) 1854 1870 (fontified t) 1870 1876 (face font-lock-keyword-face fontified t) 1876 1958 (fontified t) 1958 1963 (face font-lock-builtin-face fontified t) 1963 1994 (fontified t) 1994 1998 (face font-lock-keyword-face fontified t) 1998 2086 (fontified t) 2086 2097 (face font-lock-builtin-face fontified t) 2097 2099 (fontified t) 2099 2101 (face font-lock-string-face fontified t) 2101 2131 (fontified t) 2131 2135 (face font-lock-keyword-face fontified t) 2135 2145 (fontified t) 2145 2162 (face font-lock-string-face fontified t) 2162 2231 (fontified t) 2231 2241 (face font-lock-builtin-face fontified t) 2241 2242 (fontified t) 2242 2245 (face font-lock-string-face fontified t) 2245 2262 (fontified t) 2262 2279 (fontified t) 2279 2290 (face font-lock-string-face fontified t) 2290 2292 (fontified t) 2292 2294 (face font-lock-string-face fontified t) 2294 2297 (fontified t) 2297 2334 (fontified t) 2334 2356 (fontified t) 2356 2361 (face font-lock-string-face fontified t) 2361 2364 (fontified t) 2364 2394 (fontified t) 2394 2400 (face font-lock-string-face fontified t) 2400 2402 (fontified t) 2402 2404 (face font-lock-string-face fontified t) 2404 2464 (fontified t) 2464 2467 (face font-lock-string-face fontified t) 2467 2721 (fontified t) 2721 2725 (face font-lock-keyword-face fontified t) 2725 2950 (fontified t) 2950 2977 (face font-lock-comment-face fontified t) 2977 3003 (fontified t) 3003 3006 (face font-lock-builtin-face fontified t) 3006 3052 (fontified t) 3052 3063 (face font-lock-builtin-face fontified t) 3063 3098 (fontified t) 3098 3101 (face font-lock-builtin-face fontified t) 3101 3135 (fontified t) 3135 3142 (face font-lock-builtin-face fontified t) 3142 3177 (fontified t) 3177 3182 (face font-lock-builtin-face fontified t) 3182 3218 (fontified t) 3218 3223 (face font-lock-builtin-face fontified t) 3223 3258 (fontified t) 3258 3265 (face font-lock-builtin-face fontified t) 3265 3331 (fontified t) 3331 3334 (face font-lock-builtin-face fontified t) 3334 3378 (fontified t) 3378 3382 (face font-lock-keyword-face fontified t) 3382 3392 (fontified t) 3392 3398 (face font-lock-builtin-face fontified t) 3398 3532 (fontified t) 3532 3537 (face font-lock-builtin-face fontified t) 3537 3577 (fontified t) 3577 3583 (face font-lock-keyword-face fontified t) 3583 3645 (fontified t) 3645 3647 (face font-lock-keyword-face fontified t) 3647 3688 (fontified t) 3688 3692 (face font-lock-string-face fontified t) 3692 3752 (fontified t) 3752 3754 (face font-lock-keyword-face fontified t) 3754 3795 (fontified t) 3795 3797 (face font-lock-string-face fontified t) 3797 3799 (face font-lock-string-face fontified t) 3799 3809 (fontified t) 3809 3822 (fontified t) 3822 3853 (face font-lock-keyword-face fontified t) 3853 3876 (fontified t) 3876 3888 (face font-lock-keyword-face fontified t) 3888 3908 (fontified t) 3908 3913 (face font-lock-keyword-face fontified t) 3913 4080 (fontified t) 4080 4085 (face font-lock-warning-face fontified t) 4085 4109 (fontified t) 4109 4116 (face font-lock-keyword-face fontified t) 4116 4159 (fontified t) 4159 4165 (face font-lock-string-face fontified t) 4165 4236 (fontified t) 4236 4239 (face font-lock-comment-delimiter-face fontified t) 4239 4314 (face font-lock-comment-face fontified t) 4314 4318 (face font-lock-comment-delimiter-face fontified t) 4318 4510 (face font-lock-comment-face fontified t) 4510 4513 (face font-lock-comment-delimiter-face fontified t) 4513 4588 (face font-lock-comment-face fontified t) 4588 4591 (face font-lock-comment-delimiter-face fontified t) 4591 4668 (face font-lock-comment-face fontified t) 4668 4669 (fontified t) 4669 4674 (face font-lock-keyword-face fontified t) 4674 4675 (fontified t) 4675 4682 (face font-lock-function-name-face fontified t) 4682 4747 (fontified t) 4747 4752 (face font-lock-builtin-face fontified t) 4752 4773 (fontified t) 4773 4778 (face font-lock-keyword-face fontified t) 4778 4779 (fontified t) 4779 4787 (face font-lock-function-name-face fontified t) 4787 4796 (fontified t) 4796 4922 (face font-lock-doc-face fontified t) 4922 4930 (fontified t) 4930 4934 (face font-lock-keyword-face fontified t) 4934 4954 (fontified t) 4954 4971 (face font-lock-string-face fontified t) 4971 4984 (fontified t) 4984 4988 (face font-lock-keyword-face fontified t) 4988 5016 (fontified t) 5016 5019 (face font-lock-string-face fontified t) 5019 5048 (fontified t) 5048 5058 (face font-lock-builtin-face fontified t) 5058 5059 (fontified t) 5059 5062 (face font-lock-string-face fontified t) 5062 5087 (fontified t) 5087 5098 (face font-lock-string-face fontified t) 5098 5135 (fontified t) 5135 5147 (face font-lock-builtin-face fontified t) 5147 5155 (fontified t) 5155 5158 (face font-lock-string-face fontified t) 5158 5163 (fontified t) 5163 5168 (face font-lock-keyword-face fontified t) 5168 5169 (fontified t) 5169 5180 (face font-lock-function-name-face fontified t) 5180 5206 (fontified t) 5206 5218 (face font-lock-string-face fontified t) 5218 5220 (fontified t) 5220 5222 (face font-lock-string-face fontified t) 5222 5226 (fontified t) 5226 5227 (fontified t) 5227 5232 (face font-lock-keyword-face fontified t) 5232 5233 (fontified t) 5233 5241 (face font-lock-function-name-face fontified t) 5241 5249 (fontified t) 5249 5254 (face font-lock-type-face fontified t) 5254 5264 (fontified t) 5264 5268 (face font-lock-keyword-face fontified t) 5268 5309 (fontified t) 5309 5323 (fontified t) 5323 5328 (face font-lock-builtin-face fontified t) 5328 5341 (fontified t) 5341 5430 (fontified t) 5430 5438 (face font-lock-builtin-face fontified t) 5438 5469 (fontified t) 5469 5475 (face font-lock-keyword-face fontified t) 5475 5483 (fontified t) 5483 5488 (face font-lock-keyword-face fontified t) 5488 5489 (fontified t) 5489 5512 (face font-lock-function-name-face fontified t) 5512 5519 (fontified t) 5519 5623 (face font-lock-doc-face fontified t) 5623 5627 (fontified t) 5627 5639 (face font-lock-keyword-face fontified t) 5639 5647 (fontified t) 5647 5651 (face font-lock-keyword-face fontified t) 5651 5659 (fontified t) 5659 5663 (face font-lock-keyword-face fontified t) 5663 5767 (fontified t) 5767 5771 (face font-lock-keyword-face fontified t) 5771 5854 (fontified t) 5854 5857 (face font-lock-keyword-face fontified t) 5857 5875 (fontified t) 5875 5878 (face font-lock-string-face fontified t) 5878 5908 (fontified t) 5908 5912 (face font-lock-keyword-face fontified t) 5912 6111 (fontified t) 6111 6115 (face font-lock-keyword-face fontified t) 6115 6210 (fontified t) 6210 6221 (face font-lock-string-face fontified t) 6221 6268 (fontified t) 6268 6274 (face font-lock-keyword-face fontified t) 6274 6292 (fontified t) 6292 6297 (face font-lock-string-face fontified t) 6297 6345 (fontified t) 6345 6348 (face font-lock-string-face fontified t) 6348 6394 (fontified t) 6394 6405 (face font-lock-string-face fontified t) 6405 6553 (fontified t) 6553 6559 (face font-lock-keyword-face fontified t) 6559 6588 (fontified t) 6588 6590 (face font-lock-string-face fontified t) 6590 6623 (fontified t) 6623 6629 (face font-lock-keyword-face fontified t) 6629 6682 (fontified t) 6682 6687 (face font-lock-builtin-face fontified t) 6687 6705 (fontified t) 6705 6710 (face font-lock-warning-face fontified t) 6710 6722 (fontified t) 6722 6725 (face font-lock-comment-delimiter-face fontified t) 6725 6801 (face font-lock-comment-face fontified t) 6801 6802 (fontified t) 6802 6807 (face font-lock-keyword-face fontified t) 6807 6808 (fontified t) 6808 6823 (face font-lock-function-name-face fontified t) 6823 6825 (fontified t) 6825 6829 (face font-lock-type-face fontified t) 6829 6841 (fontified t) 6841 6874 (fontified t) 6874 6888 (face font-lock-builtin-face fontified t) 6888 6891 (fontified t) 6891 6893 (fontified t) 6893 7022 (face font-lock-doc-face fontified t) 7022 7026 (fontified t) 7026 7032 (face font-lock-keyword-face fontified t) 7032 7045 (fontified t) 7045 7051 (face font-lock-keyword-face fontified t) 7051 7064 (fontified t) 7064 7067 (face font-lock-comment-delimiter-face fontified t) 7067 7113 (face font-lock-comment-face fontified t) 7113 7126 (fontified t) 7126 7146 (face font-lock-string-face fontified t) 7146 7155 (fontified t) 7155 7159 (face font-lock-keyword-face fontified t) 7159 7191 (fontified t) 7191 7197 (face font-lock-keyword-face fontified t) 7197 7227 (fontified t) 7227 7238 (face font-lock-builtin-face fontified t) 7238 7280 (fontified t) 7280 7291 (face font-lock-builtin-face fontified t) 7291 7331 (fontified t) 7331 7334 (face font-lock-comment-delimiter-face fontified t) 7334 7342 (face font-lock-comment-face fontified t) 7342 7349 (fontified t) 7349 7353 (face font-lock-keyword-face fontified t) 7353 7473 (fontified t) 7473 7477 (face font-lock-keyword-face fontified t) 7477 7511 (fontified t) 7511 7514 (face font-lock-builtin-face fontified t) 7514 7529 (fontified t) 7529 7533 (face font-lock-keyword-face fontified t) 7533 7567 (fontified t) 7567 7570 (face font-lock-builtin-face fontified t) 7570 7583 (fontified t) 7583 7586 (face font-lock-comment-delimiter-face fontified t) 7586 7645 (face font-lock-comment-face fontified t) 7645 7652 (fontified t) 7652 7656 (face font-lock-keyword-face fontified t) 7656 7809 (fontified t) 7809 7813 (face font-lock-builtin-face fontified t) 7813 7875 (fontified t) 7875 7882 (face font-lock-builtin-face fontified t) 7882 7883 (fontified t) 7883 7891 (face font-lock-string-face fontified t) 7891 7952 (fontified t) 7952 7962 (face font-lock-builtin-face fontified t) 7962 8006 (fontified t) 8006 8016 (face font-lock-builtin-face fontified t) 8016 8017 (fontified t) 8017 8028 (face font-lock-string-face fontified t) 8028 8029 (fontified t) 8029 8036 (face font-lock-builtin-face fontified t) 8036 8037 (fontified t) 8037 8045 (face font-lock-string-face fontified t) 8045 8059 (fontified t) 8059 8063 (face font-lock-keyword-face fontified t) 8063 8100 (fontified t) 8100 8109 (face font-lock-builtin-face fontified t) 8109 8127 (fontified t) 8127 8131 (face font-lock-keyword-face fontified t) 8131 8168 (fontified t) 8168 8173 (face font-lock-builtin-face fontified t) 8173 8190 (fontified t) 8190 8194 (face font-lock-keyword-face fontified t) 8194 8231 (fontified t) 8231 8238 (face font-lock-builtin-face fontified t) 8238 8253 (fontified t) 8253 8257 (face font-lock-keyword-face fontified t) 8257 8298 (fontified t) 8298 8308 (face font-lock-builtin-face fontified t) 8308 8328 (fontified t) 8328 8331 (face font-lock-comment-delimiter-face fontified t) 8331 8338 (face font-lock-comment-face fontified t) 8338 8345 (fontified t) 8345 8348 (face font-lock-keyword-face fontified t) 8348 8391 (fontified t) 8391 8402 (fontified t) 8402 8410 (face font-lock-builtin-face fontified t) 8410 8416 (fontified t) 8416 8454 (fontified t) 8454 8461 (face font-lock-builtin-face fontified t) 8461 8499 (fontified t)) . -53808) (undo-tree-id44 . -7430) (undo-tree-id45 . -8499) 62307) nil (26996 52268 614233 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 58468 . 58469) (nil fontified nil 53808 . 58469) (53808 . 58469)) nil (26996 52268 614222 0) 0 nil])
([nil nil ((58469 . 58470)) nil (26996 52268 614218 0) 0 nil])
([nil nil ((#(":my-compose :*app*" 0 11 (face font-lock-builtin-face fontified t) 11 12 (fontified t) 12 18 (face font-lock-builtin-face fontified t)) . -837) (undo-tree-id80 . -18) 855 (t 26996 52268 0 0)) nil (26996 54369 616247 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -836) (undo-tree-id78 . -1) (undo-tree-id79 . -1) 837) nil (26996 54369 616246 0) 0 nil])
([nil nil ((#("logger" 0 6 (face font-lock-builtin-face fontified t)) . -838) (undo-tree-id77 . -6) 844) nil (26996 54369 616244 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 854 . 855) (nil fontified nil 838 . 855) (838 . 855)) nil (26996 54369 616242 0) 0 nil])
([nil nil ((#(":json-only" 0 10 (face font-lock-builtin-face fontified t)) . -856) (undo-tree-id76 . -10) 866) nil (26996 54369 616241 0) 0 nil])
([nil nil ((856 . 857)) nil (26996 54369 616240 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 876 . 877) (nil fontified nil 857 . 877) (857 . 877)) nil (26996 54369 616239 0) 0 nil])
([nil nil ((877 . 878)) nil (26996 54369 616239 0) 0 nil])
([nil nil ((878 . 879)) nil (26996 54369 616239 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 893 . 894) (nil fontified nil 879 . 894) (879 . 894)) nil (26996 54369 616238 0) 0 nil])
([nil nil ((895 . 899) (#(" " 0 1 (fontified nil)) . 895) (894 . 895)) nil (26996 54369 616237 0) 0 nil])
([nil nil ((#(":cors" 0 5 (face font-lock-builtin-face fontified t)) . -1003) (undo-tree-id75 . -5) 1008) nil (26996 54369 616237 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 1003)) nil (26996 54369 616236 0) 0 nil])
([nil nil ((#(":cors-auto" 0 10 (face font-lock-builtin-face fontified t)) . -1003) (undo-tree-id74 . -10) 1013) nil (26996 54369 616235 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 1003)) nil (26996 54369 616234 0) 0 nil])
([nil nil ((878 . 881) (#(" " 0 1 (fontified nil)) . 877) (undo-tree-id73 . -1) (878 . 879)) nil (26996 54369 616233 0) 0 nil])
([nil nil ((897 . 898)) nil (26996 54369 616232 0) 0 nil])
([nil nil ((898 . 899)) nil (26996 54369 616232 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 907 . 908) (nil fontified nil 899 . 908) (899 . 908)) nil (26996 54369 616231 0) 0 nil])
([nil nil ((908 . 909)) nil (26996 54369 616231 0) 0 nil])
([nil nil ((909 . 910)) nil (26996 54369 616230 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 926 . 927) (nil fontified nil 910 . 927) (910 . 927)) nil (26996 54369 616230 0) 0 nil])
([nil nil ((927 . 928)) nil (26996 54369 616229 0) 0 nil])
([nil nil ((928 . 929)) nil (26996 54369 616229 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -927) (undo-tree-id71 . -1) (#(":" 0 1 (fontified t)) . -928) (undo-tree-id72 . -1) 929) nil (26996 54369 616228 0) 0 nil])
([nil nil ((927 . 928)) nil (26996 54369 616226 0) 0 nil])
([nil nil ((928 . 929)) nil (26996 54369 616226 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 945 . 946) (nil fontified nil 929 . 946) (929 . 946)) nil (26996 54369 616225 0) 0 nil])
([nil nil ((946 . 950)) nil (26996 54369 616225 0) 0 nil])
([nil nil ((950 . 951)) nil (26996 54369 616224 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 972 . 973) (nil fontified nil 951 . 973) (951 . 973)) nil (26996 54369 616224 0) 0 nil])
([nil nil ((973 . 974)) nil (26996 54369 616223 0) 0 nil])
([nil nil ((974 . 975)) nil (26996 54369 616222 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 996 . 997) (nil fontified nil 981 . 997) (nil fontified nil 975 . 981) (975 . 997)) nil (26996 54369 616305 0) 0 nil])
([nil nil ((#(":query-parser" 0 13 (face font-lock-builtin-face fontified t)) . -1002) (undo-tree-id84 . -13) 1015) nil (26996 54520 745169 0) 0 nil] [nil nil ((#("(defmiddleware query-parser-middleware () (req next)
  (let ((q (lumen.core.http:req-query req)))
    (when (stringp q)
      (setf (lumen.core.http:req-query req) (parse-query-string-to-alist q)))
    (funcall next req)))" 0 22 (fontified t) 22 53 (fontified t) 53 56 (fontified t) 56 59 (face font-lock-keyword-face fontified t) 59 103 (fontified t) 103 107 (face font-lock-keyword-face fontified t) 107 198 (fontified t) 198 208 (fontified t) 208 222 (fontified t)) . 7809) (undo-tree-id50 . -222) (undo-tree-id51 . -20) (undo-tree-id52 . -20) (undo-tree-id53 . -20) (undo-tree-id54 . -20) (undo-tree-id55 . -20) (undo-tree-id56 . -20) (undo-tree-id57 . -20) (undo-tree-id58 . -111) (undo-tree-id59 . -111) (undo-tree-id60 . -111) (undo-tree-id61 . -111) (undo-tree-id62 . -111) (undo-tree-id63 . -111) (undo-tree-id64 . -111) (undo-tree-id65 . -111) (undo-tree-id66 . -111) (undo-tree-id67 . -198) (undo-tree-id68 . -222) (undo-tree-id69 . -222) (undo-tree-id70 . -222) 8031) ((7809 . 8031)) (26996 54369 616217 0) 0 nil])
([nil nil ((1002 . 1003)) nil (26996 54520 745167 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 1025 . 1026) (nil fontified nil 1010 . 1026) (nil fontified nil 1003 . 1010) (1003 . 1026)) nil (26996 54520 745167 0) 0 nil])
([nil nil ((1026 . 1027)) nil (26996 54520 745166 0) 0 nil])
([nil nil ((1027 . 1028)) nil (26996 54520 745166 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1044 . 1045) (nil fontified nil 1028 . 1045) (1028 . 1045)) nil (26996 54520 745165 0) 0 nil])
([nil nil ((#("
	 " 0 1 (fontified t) 1 3 (fontified t)) . -997) (undo-tree-id83 . -3) 1000) nil (26996 54520 745164 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 997)) nil (26996 54520 745162 0) 0 nil])
([nil nil ((#(" :static-middleware" 0 1 (fontified t) 1 2 (face font-lock-builtin-face fontified t) 2 18 (face font-lock-builtin-face fontified t) 18 19 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -1022) (undo-tree-id81 . -19) (undo-tree-id82 . -19) 1041) nil (26996 54520 745162 0) 0 nil])
([nil nil ((1022 . 1026)) nil (26996 54520 745151 0) 0 nil])
([nil nil ((1026 . 1027)) nil (26996 54520 745151 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1047 . 1048) (nil fontified nil 1027 . 1048) (1027 . 1048)) nil (26996 54520 745150 0) 0 nil])
([nil nil ((1048 . 1049)) nil (26996 54520 745149 0) 0 nil])
([nil nil ((1049 . 1050)) nil (26996 54520 745148 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1065 . 1066) (nil fontified nil 1050 . 1066) (1050 . 1066)) nil (26996 54520 745148 0) 0 nil])
([nil nil ((1066 . 1067)) nil (26996 54520 745147 0) 0 nil])
([nil nil ((1067 . 1068)) nil (26996 54520 745147 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1089 . 1090) (nil fontified nil 1068 . 1090) (1068 . 1090)) nil (26996 54520 745146 0) 0 nil])
([nil nil ((1092 . 1096) (1023 . 1027) (#("   " 0 3 (fontified nil)) . 1023) (1090 . 1091)) nil (26996 54520 745145 0) 0 nil])
([nil nil ((1096 . 1097)) nil (26996 54520 745144 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1123 . 1124) (nil fontified nil 1097 . 1124) (1097 . 1124)) nil (26996 54520 745144 0) 0 nil])
([nil nil ((1124 . 1125)) nil (26996 54520 975802 0) 0 nil])
([nil nil ((1125 . 1126)) nil (26996 56199 105638 0) 0 nil] [nil nil ((1125 . 1126)) ((#(";" 0 1 (face font-lock-comment-face fontified t)) . 1125) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1)) (26996 54520 745219 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1140 . 1141) (nil fontified nil 1126 . 1141) (1126 . 1141)) nil (26996 56199 105637 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1140 . 1141) (nil fontified nil 1126 . 1141) (1126 . 1141)) ((#("etag-middleware" 0 14 (face font-lock-comment-face fontified nil) 14 15 (face font-lock-comment-face rear-nonsticky nil fontified nil)) . 1126) (undo-tree-id85 . -15) (nil rear-nonsticky t 1140 . 1141)) (26996 54520 745138 0) 0 nil])
([nil nil ((1141 . 1142)) nil (26996 56199 105637 0) 0 nil])
nil
([nil nil ((1142 . 1143)) nil (26996 56199 105636 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1164 . 1165) (nil fontified nil 1143 . 1165) (1143 . 1165)) nil (26996 56199 105636 0) 0 nil])
([nil nil ((1165 . 1168) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1095) (1095 . 1096) (#("	" 0 1 (fontified nil)) . 1095) (1092 . 1095) (1165 . 1166)) nil (26996 56199 105635 0) 0 nil])
([nil nil ((1168 . 1169)) nil (26996 56199 105634 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1192 . 1193) (nil fontified nil 1174 . 1193) (nil fontified nil 1169 . 1174) (1169 . 1193)) nil (26996 56199 105634 0) 0 nil])
([nil nil ((1193 . 1194)) nil (26996 56199 105633 0) 0 nil])
([nil nil ((1194 . 1195)) nil (26996 56199 105632 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1212 . 1213) (nil fontified nil 1208 . 1213) (nil fontified nil 1195 . 1208) (1195 . 1213)) nil (26996 56199 105632 0) 0 nil])
([nil nil ((1213 . 1214)) nil (26996 56199 105631 0) 0 nil])
([nil nil ((1214 . 1215)) nil (26996 56199 105631 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1229 . 1230) (nil fontified nil 1215 . 1230) (1215 . 1230)) nil (26996 56199 105630 0) 0 nil])
([nil nil ((1232 . 1236) (1165 . 1169) (#("   " 0 3 (fontified nil)) . 1165) (1230 . 1231)) nil (26996 56199 105629 0) 0 nil])
([nil nil ((1236 . 1237)) nil (26996 56199 105629 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1251 . 1252) (nil fontified nil 1237 . 1252) (1237 . 1252)) nil (26996 56199 105628 0) 0 nil])
([nil nil ((1252 . 1253)) nil (26996 56199 105627 0) 0 nil])
([nil nil ((1253 . 1254)) nil (26996 56199 105627 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1266 . 1267) (nil fontified nil 1254 . 1267) (1254 . 1267)) nil (26996 56199 105627 0) 0 nil])
([nil nil ((1267 . 1268)) nil (26996 56199 105626 0) 0 nil])
([nil nil ((1268 . 1269)) nil (26996 56199 105626 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1281 . 1282) (nil fontified nil 1269 . 1282) (1269 . 1282)) nil (26996 56199 105625 0) 0 nil])
([nil nil ((1282 . 1285) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1235) (1235 . 1236) (#("	" 0 1 (fontified nil)) . 1235) (1232 . 1235) (1282 . 1283)) nil (26996 56199 105624 0) 0 nil])
([nil nil ((1285 . 1286)) nil (26996 56199 105623 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -1285) (undo-tree-id99 . -1) 1286) nil (26996 56199 105623 0) 0 nil])
([nil nil ((1285 . 1286)) nil (26996 56199 105622 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1310 . 1311) (nil fontified nil 1300 . 1311) (nil fontified nil 1286 . 1300) (1286 . 1311)) nil (26996 56199 105621 0) 0 nil])
([nil nil ((1311 . 1312)) nil (26996 56199 105621 0) 0 nil])
([nil nil ((1312 . 1313)) nil (26996 56199 105620 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1333 . 1334) (nil fontified nil 1313 . 1334) (1313 . 1334)) nil (26996 56199 105620 0) 0 nil])
([nil nil ((1334 . 1335)) nil (26996 56199 105619 0) 0 nil])
([nil nil ((1335 . 1336)) nil (26996 56199 105619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1353 . 1354) (nil fontified nil 1338 . 1354) (nil fontified nil 1336 . 1338) (1336 . 1354)) nil (26996 56199 105618 0) 0 nil])
([nil nil ((1356 . 1360) (1282 . 1286) (#("   " 0 3 (fontified nil)) . 1282) (1354 . 1355)) nil (26996 56199 105617 0) 0 nil])
([nil nil ((1360 . 1361)) nil (26996 56199 105616 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1384 . 1385) (nil fontified nil 1366 . 1385) (nil fontified nil 1361 . 1366) (1361 . 1385)) nil (26996 56199 105616 0) 0 nil])
([nil nil ((1385 . 1386)) nil (26996 56199 105615 0) 0 nil])
([nil nil ((1386 . 1387)) nil (26996 56199 105615 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1404 . 1405) (nil fontified nil 1387 . 1405) (1387 . 1405)) nil (26996 56199 105614 0) 0 nil])
([nil nil ((1405 . 1406)) nil (26996 56199 105613 0) 0 nil])
([nil nil ((1406 . 1407)) nil (26996 56199 105613 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1427 . 1428) (nil fontified nil 1407 . 1428) (1407 . 1428)) nil (26996 56199 105612 0) 0 nil])
([nil nil ((#(":set-app! :*pipeline-signature*
	   :named :->mw :static :static-many
	   :form-parser :multipart-parser" 0 9 (face font-lock-builtin-face fontified t) 9 10 (fontified t) 10 31 (face font-lock-builtin-face fontified t) 31 32 (fontified t) 32 36 (fontified t) 36 42 (face font-lock-builtin-face fontified t) 42 43 (fontified t) 43 48 (face font-lock-builtin-face fontified t) 48 49 (fontified t) 49 56 (face font-lock-builtin-face fontified t) 56 57 (fontified t) 57 69 (face font-lock-builtin-face fontified t) 69 70 (fontified t) 70 74 (fontified t) 74 86 (face font-lock-builtin-face fontified t) 86 87 (fontified t) 87 104 (face font-lock-builtin-face fontified t)) . 1462) (undo-tree-id98 . -104)) nil (26996 56199 105612 0) 0 nil])
([nil nil ((#("
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper" 0 1 (fontified t) 1 5 (fontified t) 5 8 (face font-lock-comment-delimiter-face fontified t) 8 24 (face font-lock-comment-face fontified t) 24 27 (fontified t) 27 43 (face font-lock-builtin-face fontified t) 43 44 (fontified t) 44 58 (face font-lock-builtin-face fontified t)) . -1462) (undo-tree-id97 . -58) 1520) nil (26996 56199 105610 0) 0 nil])
([nil nil ((#("
   ;; Cookies
   :request-id :request-context :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
   :csrf
	   :auth-jwt
   :https-redirect
	   :auth-required :roles-allowed :rate-limit
	   :request-timeout :max-body-size :access-log-json" 0 1 (fontified t) 1 4 (fontified t) 4 7 (face font-lock-comment-delimiter-face fontified t) 7 15 (face font-lock-comment-face fontified t) 15 18 (fontified t) 18 29 (face font-lock-builtin-face fontified t) 29 30 (fontified t) 30 46 (face font-lock-builtin-face fontified t) 46 47 (fontified t) 47 59 (face font-lock-builtin-face fontified t) 59 60 (fontified t) 60 67 (face font-lock-builtin-face fontified t) 67 68 (fontified t) 68 83 (face font-lock-builtin-face fontified t) 83 87 (fontified t) 87 90 (face font-lock-comment-delimiter-face fontified t) 90 95 (face font-lock-comment-face fontified t) 95 98 (fontified t) 98 103 (face font-lock-builtin-face fontified t) 103 107 (fontified t) 107 110 (face font-lock-comment-delimiter-face fontified t) 110 122 (face font-lock-comment-face fontified t) 122 125 (fontified t) 125 137 (face font-lock-builtin-face fontified t) 137 141 (fontified t) 141 167 (face font-lock-builtin-face fontified t) 167 171 (fontified t) 171 174 (face font-lock-comment-delimiter-face fontified t) 174 182 (face font-lock-comment-face fontified t) 182 186 (fontified t) 186 194 (face font-lock-builtin-face fontified t) 194 198 (fontified t) 198 203 (face font-lock-builtin-face fontified t) 203 208 (fontified t) 208 217 (face font-lock-builtin-face fontified t) 217 221 (fontified t) 221 236 (face font-lock-builtin-face fontified t) 236 241 (fontified t) 241 255 (face font-lock-builtin-face fontified t) 255 256 (fontified t) 256 270 (face font-lock-builtin-face fontified t) 270 271 (fontified t) 271 282 (face font-lock-builtin-face fontified t) 282 287 (fontified t) 287 303 (face font-lock-builtin-face fontified t) 303 304 (fontified t) 304 318 (face font-lock-builtin-face fontified t) 318 319 (fontified t) 319 335 (face font-lock-builtin-face fontified t)) . -1462) (undo-tree-id96 . -335) 1797) nil (26996 56199 105609 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -1461) (undo-tree-id94 . -1) (undo-tree-id95 . -1) 1462) nil (26996 56199 105608 0) 0 nil])
([nil nil ((#(":define-middleware" 0 18 (face font-lock-builtin-face fontified t)) . -818) (undo-tree-id93 . -18) 836) nil (26996 56199 105604 0) 0 nil])
([nil nil ((818 . 819)) nil (26996 56199 105594 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 831 . 832) (nil fontified nil 819 . 832) (819 . 832)) nil (26996 56199 105590 0) 0 nil])
([nil nil ((31536 . 31538) (t 26996 56199 0 0)) nil (26996 56502 12251 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -31536) (undo-tree-id3 . -1) (#("
" 0 1 (fontified t)) . -31537) (undo-tree-id4 . -1) 31538) nil (26996 56502 12250 0) 0 nil])
([nil nil ((58491 . 58492)) nil (26996 56502 12248 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 59374 . 59375) (nil fontified nil 59356 . 59375) (nil fontified nil 59307 . 59356) (nil fontified nil 59304 . 59307) (nil fontified nil 59296 . 59304) (nil fontified nil 59221 . 59296) (nil fontified nil 59218 . 59221) (nil fontified nil 59171 . 59218) (nil fontified nil 59160 . 59171) (nil fontified nil 59050 . 59160) (nil fontified nil 59048 . 59050) (nil fontified nil 59038 . 59048) (nil fontified nil 58981 . 59038) (nil fontified nil 58978 . 58981) (nil fontified nil 58974 . 58978) (nil fontified nil 58907 . 58974) (nil fontified nil 58904 . 58907) (nil fontified nil 58900 . 58904) (nil fontified nil 58858 . 58900) (nil fontified nil 58855 . 58858) (nil fontified nil 58851 . 58855) (nil fontified nil 58788 . 58851) (nil fontified nil 58785 . 58788) (nil fontified nil 58781 . 58785) (nil fontified nil 58757 . 58781) (nil fontified nil 58754 . 58757) (nil fontified nil 58721 . 58754) (nil fontified nil 58718 . 58721) (nil fontified nil 58690 . 58718) (nil fontified nil 58613 . 58690) (nil fontified nil 58610 . 58613) (nil fontified nil 58606 . 58610) (nil fontified nil 58532 . 58606) (nil fontified nil 58529 . 58532) (nil fontified nil 58524 . 58529) (nil fontified nil 58492 . 58524) (58492 . 59375)) nil (26996 56502 12246 0) 0 nil])
([nil nil ((58491 . 58492)) nil (26996 56502 12243 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 58685 . 58686) (nil fontified nil 58611 . 58686) (nil fontified nil 58607 . 58611) (nil fontified nil 58576 . 58607) (nil fontified nil 58572 . 58576) (nil fontified nil 58496 . 58572) (nil fontified nil 58492 . 58496) (58492 . 58686)) nil (26996 56502 12242 0) 0 nil])
([nil nil ((#("24. ACCESS LOG JSON" 0 19 (face font-lock-comment-face fontified t)) . -58576) (undo-tree-id0 . -19) (undo-tree-id1 . -19) (undo-tree-id2 . -19) 58595) nil (26996 56502 12240 0) 0 nil])
([nil nil ((58576 . 58587)) nil (26996 56502 12225 0) 0 nil])
([nil nil ((58587 . 58591)) nil (26996 56502 12223 0) 0 nil])
([nil nil ((59566 . 59567) 58902) nil (26996 56502 12219 0) 0 nil])
([nil nil ((1120 . 1121) (t 26996 56502 0 0)) nil (26996 56523 16504 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1137 . 1138) (nil fontified nil 1121 . 1138) (1121 . 1138)) nil (26996 56523 16502 0) 0 nil])
([nil nil ((1138 . 1142)) nil (26996 56523 16498 0) 0 nil])
([nil nil ((59589 . 59590) (t 26996 56523 0 0)) nil (26996 57021 837609 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62956 . 62957) (nil fontified nil 62951 . 62957) (nil fontified nil 62943 . 62951) (nil fontified nil 62942 . 62943) (nil fontified nil 62921 . 62942) (nil fontified nil 62888 . 62921) (nil fontified nil 62874 . 62888) (nil fontified nil 62851 . 62874) (nil fontified nil 62843 . 62851) (nil fontified nil 62842 . 62843) (nil fontified nil 62822 . 62842) (nil fontified nil 62789 . 62822) (nil fontified nil 62776 . 62789) (nil fontified nil 62723 . 62776) (nil fontified nil 62722 . 62723) (nil fontified nil 62717 . 62722) (nil fontified nil 62681 . 62717) (nil fontified nil 62675 . 62681) (nil fontified nil 62664 . 62675) (nil fontified nil 62663 . 62664) (nil fontified nil 62658 . 62663) (nil fontified nil 62657 . 62658) (nil fontified nil 62630 . 62657) (nil fontified nil 62626 . 62630) (nil fontified nil 62624 . 62626) (nil fontified nil 62570 . 62624) (nil fontified nil 62502 . 62570) (nil fontified nil 62499 . 62502) (nil fontified nil 62467 . 62499) (nil fontified nil 62460 . 62467) (nil fontified nil 62446 . 62460) (nil fontified nil 62440 . 62446) (nil fontified nil 62415 . 62440) (nil fontified nil 62412 . 62415) (nil fontified nil 62404 . 62412) (nil fontified nil 62401 . 62404) (nil fontified nil 62393 . 62401) (nil fontified nil 62390 . 62393) (nil fontified nil 62385 . 62390) (nil fontified nil 62380 . 62385) (nil fontified nil 62374 . 62380) (nil fontified nil 62358 . 62374) (nil fontified nil 62287 . 62358) (nil fontified nil 62264 . 62287) (nil fontified nil 62261 . 62264) (nil fontified nil 62203 . 62261) (nil fontified nil 62194 . 62203) (nil fontified nil 62182 . 62194) (nil fontified nil 62145 . 62182) (nil fontified nil 62141 . 62145) (nil fontified nil 62120 . 62141) (nil fontified nil 62110 . 62120) (nil fontified nil 62049 . 62110) (nil fontified nil 62022 . 62049) (nil fontified nil 62019 . 62022) (nil fontified nil 62007 . 62019) (nil fontified nil 62006 . 62007) (nil fontified nil 62002 . 62006) (nil fontified nil 62001 . 62002) (nil fontified nil 61880 . 62001) (nil fontified nil 61878 . 61880) (nil fontified nil 61851 . 61878) (nil fontified nil 61832 . 61851) (nil fontified nil 61814 . 61832) (nil fontified nil 61787 . 61814) (nil fontified nil 61770 . 61787) (nil fontified nil 61741 . 61770) (nil fontified nil 61729 . 61741) (nil fontified nil 61724 . 61729) (nil fontified nil 61695 . 61724) (nil fontified nil 61683 . 61695) (nil fontified nil 61654 . 61683) (nil fontified nil 61592 . 61654) (nil fontified nil 61589 . 61592) (nil fontified nil 61497 . 61589) (nil fontified nil 61493 . 61497) (nil fontified nil 61408 . 61493) (nil fontified nil 61404 . 61408) (nil fontified nil 61377 . 61404) (nil fontified nil 61351 . 61377) (nil fontified nil 61334 . 61351) (nil fontified nil 61325 . 61334) (nil fontified nil 61322 . 61325) (nil fontified nil 61297 . 61322) (nil fontified nil 61271 . 61297) (nil fontified nil 61254 . 61271) (nil fontified nil 61217 . 61254) (nil fontified nil 61216 . 61217) (nil fontified nil 61212 . 61216) (nil fontified nil 61174 . 61212) (nil fontified nil 61169 . 61174) (nil fontified nil 61166 . 61169) (nil fontified nil 61151 . 61166) (nil fontified nil 61112 . 61151) (nil fontified nil 61093 . 61112) (nil fontified nil 61090 . 61093) (nil fontified nil 61088 . 61090) (nil fontified nil 61085 . 61088) (nil fontified nil 61072 . 61085) (nil fontified nil 60993 . 61072) (nil fontified nil 60989 . 60993) (nil fontified nil 60945 . 60989) (nil fontified nil 60939 . 60945) (nil fontified nil 60889 . 60939) (nil fontified nil 60879 . 60889) (nil fontified nil 60858 . 60879) (nil fontified nil 60855 . 60858) (nil fontified nil 60836 . 60855) (nil fontified nil 60835 . 60836) (nil fontified nil 60819 . 60835) (nil fontified nil 60817 . 60819) (nil fontified nil 60808 . 60817) (nil fontified nil 60807 . 60808) (nil fontified nil 60795 . 60807) (nil fontified nil 60794 . 60795) (nil fontified nil 60786 . 60794) (nil fontified nil 60768 . 60786) (nil fontified nil 60764 . 60768) (nil fontified nil 60755 . 60764) (nil fontified nil 60754 . 60755) (nil fontified nil 60740 . 60754) (nil fontified nil 60739 . 60740) (nil fontified nil 60731 . 60739) (nil fontified nil 60705 . 60731) (nil fontified nil 60696 . 60705) (nil fontified nil 60695 . 60696) (nil fontified nil 60682 . 60695) (nil fontified nil 60681 . 60682) (nil fontified nil 60673 . 60681) (nil fontified nil 60621 . 60673) (nil fontified nil 60588 . 60621) (nil fontified nil 60586 . 60588) (nil fontified nil 60551 . 60586) (nil fontified nil 60548 . 60551) (nil fontified nil 60538 . 60548) (nil fontified nil 60534 . 60538) (nil fontified nil 60524 . 60534) (nil fontified nil 60509 . 60524) (nil fontified nil 60508 . 60509) (nil fontified nil 60503 . 60508) (nil fontified nil 60501 . 60503) (nil fontified nil 60480 . 60501) (nil fontified nil 60475 . 60480) (nil fontified nil 60460 . 60475) (nil fontified nil 60454 . 60460) (nil fontified nil 60438 . 60454) (nil fontified nil 60416 . 60438) (nil fontified nil 60411 . 60416) (nil fontified nil 60403 . 60411) (nil fontified nil 60390 . 60403) (nil fontified nil 60352 . 60390) (nil fontified nil 60347 . 60352) (nil fontified nil 60344 . 60347) (nil fontified nil 60326 . 60344) (nil fontified nil 60265 . 60326) (nil fontified nil 60262 . 60265) (nil fontified nil 60252 . 60262) (nil fontified nil 60240 . 60252) (nil fontified nil 60239 . 60240) (nil fontified nil 60234 . 60239) (nil fontified nil 60233 . 60234) (nil fontified nil 60155 . 60233) (nil fontified nil 60150 . 60155) (nil fontified nil 60122 . 60150) (nil fontified nil 60117 . 60122) (nil fontified nil 60039 . 60117) (nil fontified nil 60034 . 60039) (nil fontified nil 60013 . 60034) (nil fontified nil 60008 . 60013) (nil fontified nil 59989 . 60008) (nil fontified nil 59983 . 59989) (nil fontified nil 59918 . 59983) (nil fontified nil 59906 . 59918) (nil fontified nil 59905 . 59906) (nil fontified nil 59900 . 59905) (nil fontified nil 59878 . 59900) (nil fontified nil 59873 . 59878) (nil fontified nil 59849 . 59873) (nil fontified nil 59836 . 59849) (nil fontified nil 59800 . 59836) (nil fontified nil 59795 . 59800) (nil fontified nil 59776 . 59795) (nil fontified nil 59758 . 59776) (nil fontified nil 59738 . 59758) (nil fontified nil 59728 . 59738) (nil fontified nil 59708 . 59728) (nil fontified nil 59633 . 59708) (nil fontified nil 59624 . 59633) (nil fontified nil 59597 . 59624) (nil fontified nil 59596 . 59597) (nil fontified nil 59591 . 59596) (nil fontified nil 59590 . 59591) (59590 . 62957)) nil (26996 57021 837605 0) 0 nil])
([nil nil ((806 . 809)) nil (26996 57021 837592 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 918 . 919) (nil fontified nil 918 . 919) (nil fontified nil 903 . 918) (nil fontified nil 902 . 903) (nil fontified nil 884 . 902) (nil fontified nil 880 . 884) (nil fontified nil 861 . 880) (nil fontified nil 860 . 861) (nil fontified nil 842 . 860) (nil fontified nil 841 . 842) (nil fontified nil 823 . 841) (nil fontified nil 822 . 823) (nil fontified nil 810 . 822) (nil fontified nil 809 . 810) (809 . 919)) nil (26996 57021 837591 0) 0 nil])
([nil nil ((1592 . 1595) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1563) (1563 . 1564) (#("	" 0 1 (fontified nil)) . 1563) (1560 . 1563) (1592 . 1593)) nil (26996 57021 837589 0) 0 nil])
([nil nil ((1595 . 1596)) nil (26996 57021 837588 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1612 . 1613) (nil fontified nil 1596 . 1613) (1596 . 1613)) nil (26996 57021 837587 0) 0 nil])
([nil nil ((1613 . 1614)) nil (26996 57021 837587 0) 0 nil])
([nil nil ((1614 . 1615)) nil (26996 57021 837586 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1631 . 1632) (nil fontified nil 1615 . 1632) (1615 . 1632)) nil (26996 57021 837585 0) 0 nil])
([nil nil ((#("middleware" 0 9 (face font-lock-builtin-face fontified t) 9 10 (face font-lock-builtin-face rear-nonsticky t fontified t)) . 1622) (undo-tree-id5 . -10) (undo-tree-id6 . -10) (undo-tree-id7 . -10) (undo-tree-id8 . -10) (undo-tree-id9 . -10)) nil (26996 57021 837584 0) 0 nil])
([nil nil ((1622 . 1626)) nil (26996 57021 837567 0) 0 nil])
([nil nil ((63104 . 63105) (t 26996 57021 0 0)) nil (26996 57322 71751 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 66539 . 66540) (nil fontified nil 63105 . 66540) (63105 . 66540)) nil (26996 57322 71751 0) 0 nil])
([nil nil ((1626 . 1627)) nil (26996 57322 71750 0) 0 nil])
([nil nil ((1627 . 1628)) nil (26996 57322 71750 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1649 . 1650) (nil fontified nil 1628 . 1650) (1628 . 1650)) nil (26996 57322 71749 0) 0 nil])
([nil nil ((66564 . 66565)) nil (26996 57322 71745 0) 0 nil])
([nil nil ((#(";;;; -----------------------------------------------------------------------------
;;;; TENANT FROM HOST MIDDLEWARE
;;;; -----------------------------------------------------------------------------
(defun %host-header (req)
  (let ((h (lumen.core.http:req-headers req)))
    (or (cdr (assoc \"x-forwarded-host\" h :test #'string-equal))
        (cdr (assoc \"x-real-host\"      h :test #'string-equal))
        (cdr (assoc \"host\"             h :test #'string-equal)))))

(defun %normalize-host (raw)
  (when raw
    (let ((pos (position #\\: raw)))
      (if pos (subseq raw 0 pos) raw))))

(defmiddleware tenant-middleware
    ((require-host :initarg :require-host :initform nil)
     (allow-headers :initarg :allow-headers :initform t)
     (resolver-fn :initarg :resolver-fn :initform 'lumen.data.tenant:tenant-id-for-host))
    (req next)
  
  (with-slots (require-host allow-headers resolver-fn) mw
    (labels ((fallback-from-headers ()
               (let* ((h (lumen.core.http:req-headers req))
                      (tid (cdr (assoc \"x-tenant-id\" h :test #'string-equal)))
                      (tcd (cdr (assoc \"x-tenant-code\" h :test #'string-equal))))
                 (cond
                   (tid (values tid (lumen.data.tenant:tenant-code-by-id tid)))
                   (tcd (let ((tid2 (lumen.data.tenant:tenant-id-by-code tcd)))
                          (when tid2 (values tid2 tcd))))
                   (t (values nil nil))))))
      
      (let* ((host-raw (%host-header req))
             (host (%normalize-host host-raw))
             ;; On utilise funcall pour permettre l'injection de mock en test
             (tid (and host (handler-case (funcall resolver-fn host) (error () nil))))
             (code (and tid (lumen.data.tenant:tenant-code-by-id tid))))
        
        (multiple-value-bind (tid2 code2)
            (if tid
                (values tid code)
                (and allow-headers (fallback-from-headers)))
          
          (cond
            ;; Cas SuccÃ¨s : Tenant TrouvÃ©
            (tid2
             (lumen.core.http:ctx-set! req :tenant-id tid2)
             (when code2 (lumen.core.http:ctx-set! req :tenant-code code2))
             (funcall next req))
            
            ;; Cas Ã‰chec Strict : 404
            (require-host
             (lumen.core.http:respond-json 
              '((:error . ((:type . \"tenant\") (:message . \"Unknown tenant for host\")))) 
              :status 404))
            
            ;; Cas Ã‰chec Permissif : On continue (Mode \"Public\" ou \"Admin global\")
            (t 
             (funcall next req))))))))

;;; Factory Helper (Optionnel)
(defun tenant-auto ()
  \"Configure le middleware Tenant via ENV.\"
  (make-instance 'tenant-middleware
                 :require-host (lumen.core.config:cfg-get-bool :tenant/require-host :default nil)
                 :allow-headers (lumen.core.config:cfg-get-bool :tenant/allow-headers :default t)))
" 0 5 (face font-lock-comment-delimiter-face fontified t) 5 83 (face font-lock-comment-face fontified t) 83 88 (face font-lock-comment-delimiter-face fontified t) 88 116 (face font-lock-comment-face fontified t) 116 121 (face font-lock-comment-delimiter-face fontified t) 121 199 (face font-lock-comment-face fontified t) 199 200 (fontified t) 200 205 (face font-lock-keyword-face fontified t) 205 206 (fontified t) 206 218 (face font-lock-function-name-face fontified t) 218 228 (fontified t) 228 231 (face font-lock-keyword-face fontified t) 231 292 (fontified t) 292 310 (face font-lock-string-face fontified t) 310 313 (fontified t) 313 318 (face font-lock-builtin-face fontified t) 318 356 (fontified t) 356 369 (face font-lock-string-face fontified t) 369 377 (fontified t) 377 382 (face font-lock-builtin-face fontified t) 382 420 (fontified t) 420 426 (face font-lock-string-face fontified t) 426 441 (fontified t) 441 446 (face font-lock-builtin-face fontified t) 446 469 (fontified t) 469 474 (face font-lock-keyword-face fontified t) 474 475 (fontified t) 475 490 (face font-lock-function-name-face fontified t) 490 500 (fontified t) 500 504 (face font-lock-keyword-face fontified t) 504 514 (fontified t) 514 517 (face font-lock-keyword-face fontified t) 517 552 (fontified t) 552 554 (face font-lock-keyword-face fontified t) 554 587 (fontified t) 587 619 (fontified t) 619 639 (fontified t) 639 647 (face font-lock-builtin-face fontified t) 647 648 (fontified t) 648 661 (face font-lock-builtin-face fontified t) 661 662 (fontified t) 662 671 (face font-lock-builtin-face fontified t) 671 697 (fontified t) 697 705 (face font-lock-builtin-face fontified t) 705 706 (fontified t) 706 720 (face font-lock-builtin-face fontified t) 720 721 (fontified t) 721 730 (face font-lock-builtin-face fontified t) 730 752 (fontified t) 752 760 (face font-lock-builtin-face fontified t) 760 761 (fontified t) 761 773 (face font-lock-builtin-face fontified t) 773 774 (fontified t) 774 783 (face font-lock-builtin-face fontified t) 783 845 (fontified t) 845 855 (face font-lock-keyword-face fontified t) 855 905 (fontified t) 905 911 (face font-lock-keyword-face fontified t) 911 955 (fontified t) 955 959 (face font-lock-keyword-face fontified t) 959 1038 (fontified t) 1038 1051 (face font-lock-string-face fontified t) 1051 1054 (fontified t) 1054 1059 (face font-lock-builtin-face fontified t) 1059 1117 (fontified t) 1117 1132 (face font-lock-string-face fontified t) 1132 1135 (fontified t) 1135 1140 (face font-lock-builtin-face fontified t) 1140 1178 (fontified t) 1178 1182 (face font-lock-keyword-face fontified t) 1182 1288 (fontified t) 1288 1291 (face font-lock-keyword-face fontified t) 1291 1370 (fontified t) 1370 1374 (face font-lock-keyword-face fontified t) 1374 1459 (fontified t) 1459 1463 (face font-lock-keyword-face fontified t) 1463 1555 (fontified t) 1555 1558 (face font-lock-comment-delimiter-face fontified t) 1558 1620 (face font-lock-comment-face fontified t) 1620 1649 (fontified t) 1649 1661 (face font-lock-keyword-face fontified t) 1661 1690 (fontified t) 1690 1695 (face font-lock-warning-face fontified t) 1695 1798 (fontified t) 1798 1817 (face font-lock-keyword-face fontified t) 1817 1844 (fontified t) 1844 1846 (face font-lock-keyword-face fontified t) 1846 1968 (fontified t) 1968 1972 (face font-lock-keyword-face fontified t) 1972 1985 (fontified t) 1985 1988 (face font-lock-comment-delimiter-face fontified t) 1988 2015 (face font-lock-comment-face fontified t) 2015 2076 (fontified t) 2076 2086 (face font-lock-builtin-face fontified t) 2086 2107 (fontified t) 2107 2111 (face font-lock-keyword-face fontified t) 2111 2119 (fontified t) 2119 2148 (fontified t) 2148 2160 (face font-lock-builtin-face fontified t) 2160 2169 (fontified t) 2169 2227 (fontified t) 2227 2230 (face font-lock-comment-delimiter-face fontified t) 2230 2253 (face font-lock-comment-face fontified t) 2253 2340 (fontified t) 2340 2346 (face font-lock-builtin-face fontified t) 2346 2351 (fontified t) 2351 2356 (face font-lock-builtin-face fontified t) 2356 2359 (fontified t) 2359 2367 (face font-lock-string-face fontified t) 2367 2370 (fontified t) 2370 2378 (face font-lock-builtin-face fontified t) 2378 2381 (fontified t) 2381 2406 (face font-lock-string-face fontified t) 2406 2426 (fontified t) 2426 2433 (face font-lock-builtin-face fontified t) 2433 2465 (fontified t) 2465 2468 (face font-lock-comment-delimiter-face fontified t) 2468 2536 (face font-lock-comment-face fontified t) 2536 2592 (fontified t) 2592 2596 (face font-lock-comment-delimiter-face fontified t) 2596 2623 (face font-lock-comment-face fontified t) 2623 2624 (fontified t) 2624 2629 (face font-lock-keyword-face fontified t) 2629 2630 (fontified t) 2630 2641 (face font-lock-function-name-face fontified t) 2641 2647 (fontified t) 2647 2688 (face font-lock-doc-face fontified t) 2688 2742 (fontified t) 2742 2755 (face font-lock-builtin-face fontified t) 2755 2788 (fontified t) 2788 2808 (face font-lock-builtin-face fontified t) 2808 2809 (fontified t) 2809 2817 (face font-lock-builtin-face fontified t) 2817 2840 (fontified t) 2840 2854 (face font-lock-builtin-face fontified t) 2854 2887 (fontified t) 2887 2908 (face font-lock-builtin-face fontified t) 2908 2909 (fontified t) 2909 2917 (face font-lock-builtin-face fontified t) 2917 2923 (fontified t)) . 60205) (undo-tree-id3 . -2202) (undo-tree-id4 . -619) (undo-tree-id5 . -2923) 63128 (t 26996 57322 0 0)) nil (26996 58297 619344 0) 0 nil])
([nil nil ((#(":tenant-middleware :tenant-auto" 0 18 (face font-lock-builtin-face fontified t) 18 19 (fontified t) 19 31 (face font-lock-builtin-face fontified t)) . 1595) (undo-tree-id2 . -31) 1626) nil (26996 58297 619340 0) 0 nil])
([nil nil ((#("
   " 0 1 (fontified t) 1 4 (fontified t)) . -1591) (undo-tree-id0 . -4) (undo-tree-id1 . -4) 1595) nil (26996 58297 619335 0) 0 nil])
([nil nil ((#("(:import-from :lumen.data.tenant :tenant-code-by-id :tenant-id-for-host
   :tenant-id-by-code :normalize-host)" 0 1 (fontified t) 1 13 (face font-lock-builtin-face fontified t) 13 14 (fontified t) 14 32 (face font-lock-builtin-face fontified t) 32 33 (fontified t) 33 51 (face font-lock-builtin-face fontified t) 51 52 (fontified t) 52 71 (face font-lock-builtin-face fontified t) 71 75 (fontified t) 75 93 (face font-lock-builtin-face fontified t) 93 94 (fontified t) 94 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t)) . 809) (undo-tree-id10 . -110) 919 (t 26996 58297 0 0)) nil (26996 58489 53859 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . 806) (undo-tree-id6 . -3) (undo-tree-id7 . -2) (undo-tree-id8 . -3) (undo-tree-id9 . -3)) nil (26996 58489 53854 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1771 . 1772) (nil fontified nil 1718 . 1772) (1718 . 1772) (t 26996 58489 0 0)) nil (26996 61685 947450 0) 0 nil])
([nil nil ((2967 . 2968)) nil (26996 61685 947449 0) 0 nil])
([nil nil ((2968 . 2969)) nil (26996 61685 947448 0) 0 nil])
([nil nil ((2972 . 2974) (2959 . 2961) (2881 . 2883) (2784 . 2786) (2692 . 2694) (2603 . 2605) (2531 . 2533) (#("       " 0 7 (fontified t)) . 2531) (2488 . 2490) (#("       " 0 7 (fontified t)) . 2488) (2426 . 2428) (2399 . 2401) (2353 . 2355) (#("       " 0 7 (fontified t)) . 2353) (2305 . 2307) (#("       " 0 7 (fontified t)) . 2305) (2295 . 2297) (2213 . 2215) (2179 . 2181) (1853 . 1855) (1773 . 1775) 1718) nil (26996 61685 947447 0) 0 nil])
([nil nil ((#("(rng-h (cdr (assoc \"range\" (lumen.core.http:req-headers req) :test #'string-equal)))" 0 4 (fontified t) 4 19 (fontified t) 19 26 (face font-lock-string-face fontified t) 26 61 (fontified t) 61 66 (face font-lock-builtin-face fontified t) 66 84 (fontified t)) . -19113) (undo-tree-id0 . -84) (undo-tree-id1 . -1) (undo-tree-id2 . -4) (undo-tree-id3 . -4) (undo-tree-id4 . -4) (undo-tree-id5 . -4) (undo-tree-id6 . -4) (undo-tree-id7 . -5) (undo-tree-id8 . -5) (undo-tree-id9 . -5) (undo-tree-id10 . -5) (undo-tree-id11 . -5) (undo-tree-id12 . -5) (undo-tree-id13 . -5) (undo-tree-id14 . -5) (undo-tree-id15 . -84) (undo-tree-id16 . -84) (undo-tree-id17 . -84) (undo-tree-id18 . -84) (undo-tree-id19 . -84) (undo-tree-id20 . -84) 19197) nil (26996 61685 947441 0) 0 nil])
([nil nil ((#("(rng-h (cdr (assoc \"range\" (lumen.core.http:req-headers req) :test #'string-equal)))" 0 19 (fontified t) 19 26 (face font-lock-string-face fontified t) 26 61 (fontified t) 61 66 (face font-lock-builtin-face fontified t) 66 84 (fontified t)) . -22338) (undo-tree-id21 . -84) (undo-tree-id22 . -4) (undo-tree-id23 . -4) (undo-tree-id24 . -4) (undo-tree-id25 . -4) (undo-tree-id26 . -4) (undo-tree-id27 . -4) (undo-tree-id28 . -4) (undo-tree-id29 . -4) (undo-tree-id30 . -5) (undo-tree-id31 . -5) (undo-tree-id32 . -5) (undo-tree-id33 . -5) (undo-tree-id34 . -6) (undo-tree-id35 . -6) (undo-tree-id36 . -6) (undo-tree-id37 . -6) (undo-tree-id38 . -6) (undo-tree-id39 . -6) (undo-tree-id40 . -6) (undo-tree-id41 . -6) (undo-tree-id42 . -6) (undo-tree-id43 . -6) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -84) (undo-tree-id55 . -84) (undo-tree-id56 . -84) (undo-tree-id57 . -84) (undo-tree-id58 . -84) (undo-tree-id59 . -84) 22422 (t 26996 61685 0 0)) nil (26996 61926 582561 0) 0 nil])
([nil nil ((#("(defmiddleware logger-middleware
    ((stream :initarg :stream 
             :initform *terminal-io* :accessor logger-stream)
     (color  :initarg :color  
             :initform :auto)
     ;; Slot interne optimisÃ© (calculÃ© 1 seule fois Ã  l'init)
     (color-enabled-p :initform nil 
                      :accessor logger-color-p))
    (req next)
  
  ;; --- Logique Handle ---
  (labels ((h (name)
             (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
    (let* ((t0   (get-internal-real-time))
           ;; IP Extraction Logic
           (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                       (and xff (string-trim \" \" (car (uiop:split-string xff :separator \",\")))))
                     (h \"x-real-ip\")
                     (lumen.core.http:ctx-get req :remote-addr)
                     \"-\"))
           (host (or (h \"host\") \"\"))
           (meth (or (lumen.core.http:req-method req) \"GET\"))
           (path (or (lumen.core.http:req-path req) \"/\"))
           
           ;; ExÃ©cution de la chaÃ®ne
           (resp (funcall next req))
           
           ;; Calculs post-exÃ©cution
           (ms    (/ (- (get-internal-real-time) t0)
                     (/ internal-time-units-per-second 1000.0)))
           (msi   (round ms))
           (st    (lumen.core.http:resp-status resp))
           (ts    (local-time:format-timestring
                   nil (local-time:now)
                   :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                             (:hour 2) \":\" (:min 2) \":\" (:sec 2))))
           ;; AccÃ¨s aux slots de l'instance via 'mw'
           (out   (slot-value mw 'stream))
           (use-color (slot-value mw 'color-enabled-p)))

      ;; Ã‰criture Thread-Safe
      (bt:with-lock-held ((lumen.core.server::get-output-lock out)) 
        ;; Note: J'invente un lock fictif ou on utilise format ~& pour atomiser un peu
        (if use-color
            (format out \"~&[~A] ~A ~A ~A ~A -> ~C[0;~am~D~C[0m (~D ms)~%\"
                    ts ip meth host path
                    #\\Esc (%status-color st) st #\\Esc msi)
            (format out \"~&[~A] ~A ~A ~A ~A -> ~D (~D ms)~%\"
                    ts ip meth host path st msi))
        (finish-output out))
      
      resp)))" 0 46 (fontified t) 46 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 62 (face font-lock-builtin-face fontified t) 62 77 (fontified t) 77 86 (face font-lock-builtin-face fontified t) 86 101 (fontified t) 101 110 (face font-lock-builtin-face fontified t) 110 139 (fontified t) 139 147 (face font-lock-builtin-face fontified t) 147 148 (fontified t) 148 154 (face font-lock-builtin-face fontified t) 154 170 (fontified t) 170 179 (face font-lock-builtin-face fontified t) 179 180 (fontified t) 180 185 (face font-lock-builtin-face fontified t) 185 192 (fontified t) 192 195 (face font-lock-comment-delimiter-face fontified t) 195 249 (face font-lock-comment-face fontified t) 249 271 (fontified t) 271 280 (face font-lock-builtin-face fontified t) 280 308 (fontified t) 308 317 (face font-lock-builtin-face fontified t) 317 355 (fontified t) 355 358 (face font-lock-comment-delimiter-face fontified t) 358 381 (face font-lock-comment-face fontified t) 381 384 (fontified t) 384 390 (face font-lock-keyword-face fontified t) 390 466 (fontified t) 466 471 (face font-lock-builtin-face fontified t) 471 496 (fontified t) 496 500 (face font-lock-keyword-face fontified t) 500 545 (fontified t) 545 548 (face font-lock-comment-delimiter-face fontified t) 548 568 (face font-lock-comment-face fontified t) 568 590 (fontified t) 590 594 (face font-lock-keyword-face fontified t) 594 604 (fontified t) 604 621 (face font-lock-string-face fontified t) 621 670 (fontified t) 670 673 (face font-lock-string-face fontified t) 673 702 (fontified t) 702 712 (face font-lock-builtin-face fontified t) 712 713 (fontified t) 713 716 (face font-lock-string-face fontified t) 716 746 (fontified t) 746 757 (face font-lock-string-face fontified t) 757 809 (fontified t) 809 821 (face font-lock-builtin-face fontified t) 821 844 (fontified t) 844 847 (face font-lock-string-face fontified t) 847 874 (fontified t) 874 880 (face font-lock-string-face fontified t) 880 882 (fontified t) 882 884 (face font-lock-string-face fontified t) 884 941 (fontified t) 941 946 (face font-lock-string-face fontified t) 946 1001 (fontified t) 1001 1004 (face font-lock-string-face fontified t) 1004 1030 (fontified t) 1030 1033 (face font-lock-comment-delimiter-face fontified t) 1033 1056 (face font-lock-comment-face fontified t) 1056 1116 (fontified t) 1116 1119 (face font-lock-comment-delimiter-face fontified t) 1119 1142 (face font-lock-comment-face fontified t) 1142 1451 (fontified t) 1451 1458 (face font-lock-builtin-face fontified t) 1458 1461 (fontified t) 1461 1466 (face font-lock-builtin-face fontified t) 1466 1467 (fontified t) 1467 1470 (face font-lock-string-face fontified t) 1470 1472 (fontified t) 1472 1478 (face font-lock-builtin-face fontified t) 1478 1482 (fontified t) 1482 1485 (face font-lock-string-face fontified t) 1485 1487 (fontified t) 1487 1491 (face font-lock-builtin-face fontified t) 1491 1495 (fontified t) 1495 1498 (face font-lock-string-face fontified t) 1498 1529 (fontified t) 1529 1534 (face font-lock-builtin-face fontified t) 1534 1538 (fontified t) 1538 1541 (face font-lock-string-face fontified t) 1541 1543 (fontified t) 1543 1547 (face font-lock-builtin-face fontified t) 1547 1551 (fontified t) 1551 1554 (face font-lock-string-face fontified t) 1554 1556 (fontified t) 1556 1560 (face font-lock-builtin-face fontified t) 1560 1578 (fontified t) 1578 1581 (face font-lock-comment-delimiter-face fontified t) 1581 1620 (face font-lock-comment-face fontified t) 1620 1727 (fontified t) 1727 1730 (face font-lock-comment-delimiter-face fontified t) 1730 1751 (face font-lock-comment-face fontified t) 1751 1758 (fontified t) 1758 1775 (face font-lock-keyword-face fontified t) 1775 1812 (fontified t) 1812 1828 (fontified t) 1828 1831 (face font-lock-comment-delimiter-face fontified t) 1831 1907 (face font-lock-comment-face fontified t) 1907 1916 (fontified t) 1916 1918 (face font-lock-keyword-face fontified t) 1918 1953 (fontified t) 1953 2002 (face font-lock-string-face fontified t) 2002 2127 (fontified t) 2127 2163 (face font-lock-string-face fontified t) 2163 2263 (fontified t)) . -3956) (undo-tree-id0 . -2263) (undo-tree-id1 . -1392) (undo-tree-id2 . -157) (undo-tree-id3 . -187) (undo-tree-id4 . -534) (undo-tree-id5 . -1007) (undo-tree-id6 . -1432) (undo-tree-id7 . -1432) (undo-tree-id8 . -1432) (undo-tree-id9 . -1432) (undo-tree-id10 . -1432) (undo-tree-id11 . -1432) (undo-tree-id12 . -1432) (undo-tree-id13 . -1432) (undo-tree-id14 . -1432) (undo-tree-id15 . -1432) (undo-tree-id16 . -1432) (undo-tree-id17 . -1432) (undo-tree-id18 . -1432) (undo-tree-id19 . -1432) (undo-tree-id20 . -1432) (undo-tree-id21 . -1432) (undo-tree-id22 . -1432) (undo-tree-id23 . -1432) (undo-tree-id24 . -1432) (undo-tree-id25 . -1432) (undo-tree-id26 . -1432) (undo-tree-id27 . -1432) (undo-tree-id28 . -1432) (undo-tree-id29 . -1432) (undo-tree-id30 . -1432) (undo-tree-id31 . -1432) (undo-tree-id32 . -1432) (undo-tree-id33 . -1432) (undo-tree-id34 . -1432) (undo-tree-id35 . -1432) (undo-tree-id36 . -1432) (undo-tree-id37 . -1432) (undo-tree-id38 . -1432) (undo-tree-id39 . -1260) (undo-tree-id40 . -1195) (undo-tree-id41 . -1105) (undo-tree-id42 . -1019) (undo-tree-id43 . -1019) (undo-tree-id44 . -1019) (undo-tree-id45 . -1019) (undo-tree-id46 . -1019) (undo-tree-id47 . -2263) (undo-tree-id48 . -2263) (undo-tree-id49 . -2263) (undo-tree-id50 . -2263) (undo-tree-id51 . -2263) (undo-tree-id52 . -2263) (undo-tree-id53 . -2263) (undo-tree-id54 . -2263) (undo-tree-id55 . -2263) (undo-tree-id56 . -1788) (undo-tree-id57 . -1788) (undo-tree-id58 . -1788) (undo-tree-id59 . -1788) (undo-tree-id60 . -1788) (undo-tree-id61 . -1788) (undo-tree-id62 . -1778) (undo-tree-id63 . -1812) (undo-tree-id64 . -1812) (undo-tree-id65 . -1778) (undo-tree-id66 . -1778) (undo-tree-id67 . -1812) (undo-tree-id68 . -1812) (undo-tree-id69 . -1812) (undo-tree-id70 . -1812) (undo-tree-id71 . -1812) (undo-tree-id72 . -1812) (undo-tree-id73 . -1812) (undo-tree-id74 . -1812) (undo-tree-id75 . -1812) (undo-tree-id76 . -1812) (undo-tree-id77 . -1812) (undo-tree-id78 . -1812) (undo-tree-id79 . -1812) (undo-tree-id80 . -1812) (undo-tree-id81 . -1432) (undo-tree-id82 . -1093) (undo-tree-id83 . -722) (undo-tree-id84 . -722) (undo-tree-id85 . -722) (undo-tree-id86 . -722) (undo-tree-id87 . -722) (undo-tree-id88 . -722) (undo-tree-id89 . -2263) (undo-tree-id90 . -2263) (undo-tree-id91 . -1778) (undo-tree-id92 . -2250) (undo-tree-id93 . -2263) (undo-tree-id94 . -2263) 6219 (t 26996 61926 0 0)) nil (26996 62866 409367 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6188 . 6189) (nil fontified nil 3956 . 6189) (3956 . 6189)) nil (26996 62866 409302 0) 0 nil])
([nil nil ((#(";;; ---------------------------------------------------------------------------
;;; LA MACRO MAGIQUE (Defclass + Defmethod wrapper)
;;; ---------------------------------------------------------------------------
(eval-when (:compile-toplevel :load-toplevel :execute)
  (defmacro defmiddleware (name slots-and-args (req-var next-var) &body body)
    \"DÃ©finit un middleware CLOS.
   
   Exemple:
   (defmiddleware cors-middleware 
       ((origin :initarg :origin :initform \\\"*\\\")) ;; Slots CLOS classiques
       (req next)
     (let ((res (funcall next req))) ;; Corps de la mÃ©thode handle
       (acons \\\"Access-Control-Allow-Origin\\\" (slot-value mw 'origin) res)))\"
  
    (let ((class-name name)
          (mw-var (intern \"MW\"))) ;; Nom de variable pour l'instance (this/self)
    
      `(progn
	 ;; 1. DÃ©finition de la classe (Configuration)
	 (defclass ,class-name (middleware)
           ,slots-and-args
           (:documentation ,(format nil \"Middleware ~A\" class-name)))

	 ;; 2. DÃ©finition de la mÃ©thode (Logique)
	 (defmethod handle ((,mw-var ,class-name) ,req-var ,next-var)
           ;; On rend les slots accessibles comme des variables locales via with-slots ?
           ;; Simplification: l'utilisateur utilisera (slot-value mw '...) ou des accessors
           ;; Pour plus de confort, on peut wrapper dans un symbol-macrolet plus tard.
         
           (declare (ignorable ,mw-var)) ;; Au cas oÃ¹ le mw n'a pas de config
           ,@body))))
  )" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 80 (face font-lock-comment-face fontified t) 80 84 (face font-lock-comment-delimiter-face fontified t) 84 132 (face font-lock-comment-face fontified t) 132 136 (face font-lock-comment-delimiter-face fontified t) 136 212 (face font-lock-comment-face fontified t) 212 213 (fontified t) 213 222 (face font-lock-keyword-face fontified t) 222 224 (fontified t) 224 241 (face font-lock-builtin-face fontified t) 241 242 (fontified t) 242 256 (face font-lock-builtin-face fontified t) 256 257 (fontified t) 257 265 (face font-lock-builtin-face fontified t) 265 270 (fontified t) 270 278 (face font-lock-keyword-face fontified t) 278 279 (fontified t) 279 292 (face font-lock-function-name-face fontified t) 292 333 (fontified t) 333 338 (face font-lock-type-face fontified t) 338 349 (fontified t) 349 667 (face font-lock-doc-face fontified t) 667 676 (fontified t) 676 679 (face font-lock-keyword-face fontified t) 679 725 (fontified t) 725 729 (face font-lock-string-face fontified t) 729 733 (fontified t) 733 736 (face font-lock-comment-delimiter-face fontified t) 736 780 (face font-lock-comment-face fontified t) 780 793 (fontified t) 793 798 (face font-lock-keyword-face fontified t) 798 801 (fontified t) 801 804 (face font-lock-comment-delimiter-face fontified t) 804 847 (face font-lock-comment-face fontified t) 847 850 (fontified t) 850 858 (face font-lock-keyword-face fontified t) 858 923 (fontified t) 923 937 (face font-lock-builtin-face fontified t) 937 951 (fontified t) 951 966 (face font-lock-string-face fontified t) 966 984 (fontified t) 984 987 (face font-lock-comment-delimiter-face fontified t) 987 1025 (face font-lock-comment-face fontified t) 1025 1028 (fontified t) 1028 1037 (face font-lock-keyword-face fontified t) 1037 1038 (fontified t) 1038 1044 (face font-lock-function-name-face fontified t) 1044 1099 (fontified t) 1099 1102 (face font-lock-comment-delimiter-face fontified t) 1102 1177 (face font-lock-comment-face fontified t) 1177 1188 (fontified t) 1188 1191 (face font-lock-comment-delimiter-face fontified t) 1191 1269 (face font-lock-comment-face fontified t) 1269 1280 (fontified t) 1280 1283 (face font-lock-comment-delimiter-face fontified t) 1283 1356 (face font-lock-comment-face fontified t) 1356 1378 (fontified t) 1378 1385 (face font-lock-keyword-face fontified t) 1385 1407 (fontified t) 1407 1410 (face font-lock-comment-delimiter-face fontified t) 1410 1444 (face font-lock-comment-face fontified t) 1444 1469 (fontified t)) . 1506) (undo-tree-id101 . -1469) (undo-tree-id102 . -378) 2975 (t 26996 62866 0 0)) nil (26996 63874 157534 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1506) (#("
" 0 1 (fontified t)) . 1506) (#("
" 0 1 (fontified t)) . 1506)) nil (26996 63874 157532 0) 0 nil])
([nil nil ((#(":defmiddleware" 0 14 (face font-lock-builtin-face fontified t)) . 818) (undo-tree-id100 . -14) 832) nil (26996 63874 157531 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -817) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) 818) nil (26996 63874 157526 0) 0 nil])
([nil nil ((95 . 98) (t 26996 63874 0 0)) nil (26996 64446 821036 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 148 . 149) (nil fontified nil 148 . 149) (nil fontified nil 129 . 148) (nil fontified nil 128 . 129) (nil fontified nil 112 . 128) (nil fontified nil 111 . 112) (nil fontified nil 99 . 111) (nil fontified nil 98 . 99) (98 . 149)) nil (26996 64446 821035 0) 0 nil])
([nil nil ((#("(:import-from :lumen.core.mime :guess-content-type)" 0 1 (fontified t) 1 13 (face font-lock-builtin-face fontified t) 13 14 (fontified t) 14 30 (face font-lock-builtin-face fontified t) 30 31 (fontified t) 31 50 (face font-lock-builtin-face fontified t) 50 51 (rear-nonsticky t fontified t)) . -98) (undo-tree-id0 . -51) (undo-tree-id1 . -51) (undo-tree-id2 . -51) (undo-tree-id3 . -51) (undo-tree-id4 . -51) (undo-tree-id5 . -51) (undo-tree-id6 . -51) (undo-tree-id7 . -51) (undo-tree-id8 . -51) 149) nil (26996 64446 821032 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 167 . 168) (nil fontified nil 98 . 168) (98 . 168)) nil (26996 64446 821012 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 904 . 905) (nil fontified nil 891 . 905) (891 . 905)) nil (26996 64446 821011 0) 0 nil])
([nil nil ((905 . 906)) nil (26996 64446 821007 0) 0 nil])
([nil nil ((1577 . 1579) (t 26996 64446 0 0)) nil (26996 64856 361064 0) 0 nil])
([nil nil ((1579 . 1580)) nil (26996 64856 361063 0) 0 nil])
([nil nil ((1580 . 1584)) nil (26996 64856 361063 0) 0 nil])
([nil nil ((1580 . 1590) (#("in-p" 0 4 (fontified t)) . -1580) (undo-tree-id0 . -4) 1584) nil (26996 64856 361062 0) 0 nil])
([nil nil ((1590 . 1591)) nil (26996 64856 361049 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1612 . 1613) (nil fontified nil 1591 . 1613) (1591 . 1613)) nil (26996 64856 361048 0) 0 nil])
([nil nil ((1613 . 1614)) nil (26996 64856 361044 0) 0 nil])
([nil nil ((94 . 95) (t 26996 64856 0 0)) nil (26996 65068 400181 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 110 . 111) (nil fontified nil 95 . 111) (95 . 111)) nil (26996 65068 400179 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)" 0 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 33 (face font-lock-builtin-face fontified t) 33 34 (fontified t) 34 42 (face font-lock-builtin-face fontified t) 42 43 (fontified t) 43 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 63 (face font-lock-builtin-face fontified t) 63 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 80 (fontified t) 80 93 (face font-lock-builtin-face fontified t) 93 94 (fontified t) 94 106 (face font-lock-builtin-face fontified t) 106 107 (fontified t) 107 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 139 (face font-lock-builtin-face fontified t) 139 140 (fontified t) 140 149 (face font-lock-builtin-face fontified t) 149 150 (fontified t)) . 185) (undo-tree-id1 . -150) (undo-tree-id2 . -17) (undo-tree-id3 . -17) (undo-tree-id4 . -17) (undo-tree-id5 . -17) (undo-tree-id6 . -17) (undo-tree-id7 . -17) (undo-tree-id8 . -17) (undo-tree-id9 . -33) (undo-tree-id10 . -33) (undo-tree-id11 . -17) (undo-tree-id12 . -17) (undo-tree-id13 . -33) (undo-tree-id14 . -33) (undo-tree-id15 . -33) (undo-tree-id16 . -33) (undo-tree-id17 . -33) (undo-tree-id18 . -33) (undo-tree-id19 . -33) (undo-tree-id20 . -33) (undo-tree-id21 . -17) (undo-tree-id22 . -150) (undo-tree-id23 . -150) (undo-tree-id24 . -150) (undo-tree-id25 . -150) (undo-tree-id26 . -150)) nil (26996 65068 400176 0) 0 nil])
([nil nil ((746 . 749) (t 26996 65068 0 0)) nil (26996 65275 83017 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 799 . 800) (nil fontified nil 799 . 800) (nil fontified nil 786 . 799) (nil fontified nil 785 . 786) (nil fontified nil 763 . 785) (nil fontified nil 762 . 763) (nil fontified nil 750 . 762) (nil fontified nil 749 . 750) (749 . 800)) nil (26996 65275 83016 0) 0 nil])
([nil nil ((#("http-range" 0 10 (face font-lock-builtin-face fontified t)) . -775) (undo-tree-id28 . -10) 785) nil (26996 65275 83015 0) 0 nil])
([nil nil ((775 . 781)) nil (26996 65275 83013 0) 0 nil])
([nil nil ((#("respond-file" 0 12 (face font-lock-builtin-face fontified t)) . -783) (undo-tree-id27 . -12) 795) nil (26996 65275 83012 0) 0 nil])
([nil nil ((783 . 791)) nil (26996 65275 82999 0) 0 nil])
([nil nil ((61909 . 61910) (t 26996 65275 0 0)) nil (26997 3104 275560 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62840 . 62841) (nil fontified nil 61910 . 62841) (61910 . 62841)) nil (26997 3104 275559 0) 0 nil])
([nil nil ((61909 . 61910)) nil (26997 3104 275558 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62099 . 62100) (nil fontified nil 62025 . 62100) (nil fontified nil 62021 . 62025) (nil fontified nil 61994 . 62021) (nil fontified nil 61990 . 61994) (nil fontified nil 61979 . 61990) (nil fontified nil 61914 . 61979) (nil fontified nil 61910 . 61914) (61910 . 62100)) nil (26997 3104 275557 0) 0 nil])
([nil nil ((#("TRUST PROXY MIDDLEWARE" 0 22 (face font-lock-comment-face fontified t)) . -61998) (undo-tree-id0 . -22) 62020) nil (26997 3104 275555 0) 0 nil])
([nil nil ((61998 . 62011)) nil (26997 3104 275540 0) 0 nil])
([nil nil ((63023 . 63024)) nil (26997 3134 350358 0) 0 nil])
([nil nil ((1488 . 1489)) nil (26997 3136 427290 0) 0 nil] [nil nil ((1487 . 1488) (t 26997 3104 0 0)) ((#(" " 0 1 (fontified t)) . 1487) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1)) (26997 3133 965951 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1508 . 1509) (nil fontified nil 1489 . 1509) (1489 . 1509)) nil (26997 3136 427286 0) 0 nil])
([nil nil ((1488 . 1489)) ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . 1488) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1)) (26997 3133 469839 0) 0 nil])
([nil nil ((1489 . 1490) (t 26997 3136 0 0)) nil (26997 3138 234603 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1508 . 1509) (nil fontified nil 1489 . 1509) (1489 . 1509)) ((#("inspector-middleware" 0 19 (face font-lock-builtin-face fontified nil) 19 20 (face font-lock-builtin-face rear-nonsticky nil fontified nil)) . 1489) (undo-tree-id1 . -20) (undo-tree-id2 . -20) (undo-tree-id3 . -20) (undo-tree-id4 . -20) (undo-tree-id5 . -20) (undo-tree-id6 . -20) (undo-tree-id7 . -20) (nil rear-nonsticky t 1508 . 1509) (t 26997 3131 0 0)) (26997 3131 847407 0) 0 nil])
([nil nil ((#("(defun %gzip-bytes (u8vec)
  (let ((out (flexi-streams:make-in-memory-output-stream :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:gzip-compressor :stream out)
      (dotimes (i (length u8vec)) (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

(defun %deflate-bytes (u8vec)
  (let ((out (flexi-streams:make-in-memory-output-stream :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:zlib-compressor :stream out)
      (dotimes (i (length u8vec)) (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 18 (face font-lock-function-name-face fontified t) 18 30 (fontified t) 30 33 (face font-lock-keyword-face fontified t) 33 84 (fontified t) 84 97 (face font-lock-builtin-face fontified t) 97 125 (fontified t) 125 147 (face font-lock-keyword-face fontified t) 147 175 (fontified t) 175 182 (face font-lock-builtin-face fontified t) 182 195 (fontified t) 195 202 (face font-lock-keyword-face fontified t) 202 320 (fontified t) 320 325 (face font-lock-keyword-face fontified t) 325 326 (fontified t) 326 340 (face font-lock-function-name-face fontified t) 340 352 (fontified t) 352 355 (face font-lock-keyword-face fontified t) 355 406 (fontified t) 406 419 (face font-lock-builtin-face fontified t) 419 447 (fontified t) 447 469 (face font-lock-keyword-face fontified t) 469 497 (fontified t) 497 504 (face font-lock-builtin-face fontified t) 504 517 (fontified t) 517 524 (face font-lock-keyword-face fontified t) 524 639 (fontified t)) . -33236) (undo-tree-id0 . -174) (undo-tree-id1 . -174) (undo-tree-id2 . -174) (undo-tree-id3 . -174) (undo-tree-id4 . -174) (undo-tree-id5 . -639) (undo-tree-id6 . -147) (undo-tree-id7 . -147) (undo-tree-id8 . -147) (undo-tree-id9 . -147) (undo-tree-id10 . -147) (undo-tree-id11 . -147) (undo-tree-id12 . -147) (undo-tree-id13 . -147) (undo-tree-id14 . -147) (undo-tree-id15 . -147) (undo-tree-id16 . -125) (undo-tree-id17 . -125) (undo-tree-id18 . -125) (undo-tree-id19 . -125) (undo-tree-id20 . -125) (undo-tree-id21 . -125) (undo-tree-id22 . -125) (undo-tree-id23 . -125) (undo-tree-id24 . -125) (undo-tree-id25 . -125) (undo-tree-id26 . -125) (undo-tree-id27 . -125) (undo-tree-id28 . -125) (undo-tree-id29 . -125) (undo-tree-id30 . -125) (undo-tree-id31 . -131) (undo-tree-id32 . -131) (undo-tree-id33 . -131) (undo-tree-id34 . -131) (undo-tree-id35 . -131) (undo-tree-id36 . -131) (undo-tree-id37 . -131) (undo-tree-id38 . -131) (undo-tree-id39 . -125) (undo-tree-id40 . -587) (undo-tree-id41 . -639) (undo-tree-id42 . -639) 33875 (t 26997 3138 0 0)) nil (26998 3789 629281 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 34302 . 34303) (nil fontified nil 33236 . 34303) (33236 . 34303)) nil (26998 3789 629234 0) 0 nil])
([nil nil ((#("(defun %gzip-bytes (u8vec)
  (let ((out (flexi-streams:make-in-memory-output-stream :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:gzip-compressor 
                               ;; CORRECTION : On utilise :callback au lieu de :stream
                               :callback (lambda (chunk end)
                                           (write-sequence chunk out :end end)))
      ;; Optimisation : compression par vecteur entier au lieu d'octet par octet
      (salza2:compress-octet-vector c u8vec))
    (flexi-streams:get-output-stream-sequence out)))

(defun %deflate-bytes (u8vec)
  (let ((out (flexi-streams:make-in-memory-output-stream :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:zlib-compressor 
                               ;; CORRECTION : Idem pour ZLIB
                               :callback (lambda (chunk end)
                                           (write-sequence chunk out :end end)))
      (salza2:compress-octet-vector c u8vec))
    (flexi-streams:get-output-stream-sequence out)))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 18 (face font-lock-function-name-face fontified t) 18 30 (fontified t) 30 33 (face font-lock-keyword-face fontified t) 33 84 (fontified t) 84 97 (face font-lock-builtin-face fontified t) 97 125 (fontified t) 125 147 (face font-lock-keyword-face fontified t) 147 207 (fontified t) 207 210 (face font-lock-comment-delimiter-face fontified t) 210 263 (face font-lock-comment-face fontified t) 263 294 (fontified t) 294 303 (face font-lock-builtin-face fontified t) 303 305 (fontified t) 305 311 (face font-lock-keyword-face fontified t) 311 393 (fontified t) 393 397 (face font-lock-builtin-face fontified t) 397 411 (fontified t) 411 414 (face font-lock-comment-delimiter-face fontified t) 414 486 (face font-lock-comment-face fontified t) 486 587 (fontified t) 587 592 (face font-lock-keyword-face fontified t) 592 593 (fontified t) 593 607 (face font-lock-function-name-face fontified t) 607 619 (fontified t) 619 622 (face font-lock-keyword-face fontified t) 622 673 (fontified t) 673 686 (face font-lock-builtin-face fontified t) 686 714 (fontified t) 714 736 (face font-lock-keyword-face fontified t) 736 796 (fontified t) 796 799 (face font-lock-comment-delimiter-face fontified t) 799 827 (face font-lock-comment-face fontified t) 827 858 (fontified t) 858 867 (face font-lock-builtin-face fontified t) 867 869 (fontified t) 869 875 (face font-lock-keyword-face fontified t) 875 957 (fontified t) 957 961 (face font-lock-builtin-face fontified t) 961 1066 (fontified t) 1066 1067 (rear-nonsticky t fontified t)) . -33236) (undo-tree-id62 . -1067) (undo-tree-id63 . -1067) (undo-tree-id64 . -736) (undo-tree-id65 . -1067) 34303 (t 26998 3789 0 0)) nil (26998 4255 630824 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 34187 . 34188) (nil fontified nil 33236 . 34188) (33236 . 34188)) nil (26998 4255 630819 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -33234) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) 33235) nil (26998 4255 630818 0) 0 nil])
([nil nil ((#(";; CORRECTION ICI AUSSI
      " 0 3 (face font-lock-comment-delimiter-face fontified t) 3 24 (face font-lock-comment-face fontified t) 24 30 (fontified t)) . -34065) (undo-tree-id51 . -30) (undo-tree-id52 . -24) (undo-tree-id53 . -30) (undo-tree-id54 . -30) (undo-tree-id55 . -30) (undo-tree-id56 . -30) (undo-tree-id57 . -30) (undo-tree-id58 . -30) 34095) nil (26998 4255 630815 0) 0 nil])
([nil nil ((#(";; CORRECTION ICI : Le vecteur de donnÃ©es EN PREMIER, le compresseur EN SECOND
      " 0 3 (face font-lock-comment-delimiter-face fontified t) 3 79 (face font-lock-comment-face fontified t) 79 85 (fontified t)) . -33559) (undo-tree-id43 . -85) (undo-tree-id44 . -79) (undo-tree-id45 . -85) (undo-tree-id46 . -85) (undo-tree-id47 . -85) (undo-tree-id48 . -85) (undo-tree-id49 . -85) (undo-tree-id50 . -85) 33644) nil (26998 4255 630808 0) 0 nil])
([nil nil ((#("(defun compute-etag (body &key (weak t))
  (let* ((bytes (etypecase body
                  (string (trivial-utf-8:string-to-utf-8-bytes body))
                  ((vector (unsigned-byte 8)) body)
                  (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))
         (h (format nil \"~16,'0X\" (%fnv1a-64 bytes)))
         (sig (format nil \"~A-~D\" h (length bytes))))
    (if weak (format nil \"W/\\\"~S\\\"\" sig) (format nil \"\\\"~S\\\"\" sig))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 16 (face font-lock-function-name-face fontified t) 16 19 (face font-lock-function-name-face fontified t) 19 26 (fontified t) 26 30 (face font-lock-type-face fontified t) 30 44 (fontified t) 44 48 (face font-lock-keyword-face fontified t) 48 58 (fontified t) 58 67 (face font-lock-keyword-face fontified t) 67 256 (fontified t) 256 258 (face font-lock-string-face fontified t) 258 287 (fontified t) 287 296 (face font-lock-string-face fontified t) 296 343 (fontified t) 343 350 (face font-lock-string-face fontified t) 350 376 (fontified t) 376 378 (face font-lock-keyword-face fontified t) 378 396 (fontified t) 396 406 (face font-lock-string-face fontified t) 406 424 (fontified t) 424 432 (face font-lock-string-face fontified t) 432 440 (fontified t)) . -30430) (undo-tree-id66 . -440) (undo-tree-id67 . -16) (undo-tree-id68 . -16) (undo-tree-id69 . -16) (undo-tree-id70 . -16) (undo-tree-id71 . -16) (undo-tree-id72 . -16) (undo-tree-id73 . -16) (undo-tree-id74 . -16) (undo-tree-id75 . -440) (undo-tree-id76 . -440) (undo-tree-id77 . -371) (undo-tree-id78 . -440) (undo-tree-id79 . -440) 30870 (t 26998 4255 0 0)) nil (26998 4464 637887 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 30955 . 30956) (nil fontified nil 30430 . 30956) (30430 . 30956)) nil (26998 4464 637864 0) 0 nil])
([nil nil ((#("(setf (lumen.core.http:resp-headers resp)
                                     (lumen.utils:ensure-header (lumen.core.http:resp-headers resp) \"content-encoding\" \"gzip\"))
                               (setf (lumen.core.http:resp-body resp) encoded)" 0 142 (fontified t) 142 160 (face font-lock-string-face fontified t) 160 161 (fontified t) 161 167 (face font-lock-string-face fontified t) 167 248 (fontified t)) . -35999) (undo-tree-id80 . -248) (undo-tree-id81 . -248) (undo-tree-id82 . -248) (undo-tree-id83 . -248) (undo-tree-id84 . -248) (undo-tree-id85 . -170) (undo-tree-id86 . -248) (undo-tree-id87 . -248) 36247 (t 26998 4464 0 0)) nil (26998 5800 368508 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 36654 . 36655) (nil fontified nil 35999 . 36655) (35999 . 36655)) nil (26998 5800 368490 0) 0 nil])
([nil nil ((34159 . 34160) (t 26998 5800 0 0)) nil (26998 6032 164686 0) 0 nil])
([nil nil ((34160 . 34162)) nil (26998 6032 164685 0) 0 nil])
([nil nil ((36707 . 36709)) nil (26998 6032 164685 0) 0 nil])
([nil nil ((36709 . 36710)) nil (26998 6032 164684 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 40077 . 40078) (nil fontified nil 36710 . 40078) (36710 . 40078)) nil (26998 6032 164680 0) 0 nil])
([nil nil ((38098 . 38104) (t 26998 6032 0 0)) nil (26998 6390 213153 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38117 . 38118) (nil fontified nil 38104 . 38118) (38104 . 38118)) nil (26998 6390 213148 0) 0 nil])
([nil nil ((#("(defmethod %serve-file (req pn (mw static-middleware))
  ;; Logique de service fichier (200 + 206)
  ;; Note: J'ai extrait une version simplifiÃ©e pour la lisibilitÃ©, mais vous pouvez remettre le bloc complet
  (let* ((file-cache-secs (slot-value mw 'file-cache-secs))
         (ct (lumen.core.mime:guess-content-type pn))
         (lm (%file-rfc1123 pn))
         (etag (%weak-etag-from-file pn))
         (size (with-open-file (in pn :element-type '(unsigned-byte 8)) (file-length in)))
         )
    
    (make-instance 'lumen.core.http:response 
                   :status 200 
                   :headers `((\"content-type\" . ,ct)
                              (\"accept-ranges\" . \"bytes\")
                              (\"content-length\" . ,(write-to-string size))
                              (\"cache-control\" . ,(format nil \"public, max-age=~D\" file-cache-secs))
                              ,@(when lm `((\"last-modified\" . ,lm)))
                              ,@(when etag `((\"etag\" . ,etag))))
                   :body (lambda (out) 
                           (with-open-file (in pn :element-type '(unsigned-byte 8))
                             (let ((buf (make-array 4096 :element-type '(unsigned-byte 8))))
                               (loop for n = (read-sequence buf in)
                                     while (plusp n)
                                     do (funcall out (subseq buf 0 n)))))))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 22 (face font-lock-function-name-face fontified t) 22 57 (fontified t) 57 60 (face font-lock-comment-delimiter-face fontified t) 60 99 (face font-lock-comment-face fontified t) 99 101 (fontified t) 101 104 (face font-lock-comment-delimiter-face fontified t) 104 208 (face font-lock-comment-face fontified t) 208 211 (fontified t) 211 215 (face font-lock-keyword-face fontified t) 215 413 (fontified t) 413 427 (face font-lock-keyword-face fontified t) 427 435 (fontified t) 435 448 (face font-lock-builtin-face fontified t) 448 569 (fontified t) 569 576 (face font-lock-builtin-face fontified t) 576 601 (fontified t) 601 609 (face font-lock-builtin-face fontified t) 609 613 (fontified t) 613 627 (face font-lock-string-face fontified t) 627 666 (fontified t) 666 668 (face font-lock-string-face fontified t) 668 681 (face font-lock-string-face fontified t) 681 684 (fontified t) 684 691 (face font-lock-string-face fontified t) 691 693 (fontified t) 693 724 (fontified t) 724 740 (face font-lock-string-face fontified t) 740 799 (fontified t) 799 814 (face font-lock-string-face fontified t) 814 830 (fontified t) 830 850 (face font-lock-string-face fontified t) 850 902 (fontified t) 902 906 (face font-lock-keyword-face fontified t) 906 913 (fontified t) 913 928 (face font-lock-string-face fontified t) 928 971 (fontified t) 971 975 (face font-lock-keyword-face fontified t) 975 984 (fontified t) 984 990 (face font-lock-string-face fontified t) 990 1022 (fontified t) 1022 1027 (face font-lock-builtin-face fontified t) 1027 1029 (fontified t) 1029 1035 (face font-lock-keyword-face fontified t) 1035 1071 (fontified t) 1071 1085 (face font-lock-keyword-face fontified t) 1085 1093 (fontified t) 1093 1106 (face font-lock-builtin-face fontified t) 1106 1157 (fontified t) 1157 1160 (face font-lock-keyword-face fontified t) 1160 1184 (fontified t) 1184 1197 (face font-lock-builtin-face fontified t) 1197 1252 (fontified t) 1252 1256 (face font-lock-keyword-face fontified t) 1256 1418 (fontified t)) . -20384) (undo-tree-id88 . -1418) (undo-tree-id89 . -397) (undo-tree-id90 . -22) (undo-tree-id91 . -22) (undo-tree-id92 . -22) (undo-tree-id93 . -22) (undo-tree-id94 . -22) (undo-tree-id95 . -22) (undo-tree-id96 . -22) (undo-tree-id97 . -22) (undo-tree-id98 . -22) (undo-tree-id99 . -22) (undo-tree-id100 . -22) (undo-tree-id101 . -1418) (undo-tree-id102 . -1418) (undo-tree-id103 . -1418) (undo-tree-id104 . -1341) (undo-tree-id105 . -1418) (undo-tree-id106 . -1418) 21802 (t 26998 6390 0 0)) nil (26998 6410 668944 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21986 . 21987) (nil fontified nil 20384 . 21987) (20384 . 21987)) nil (26998 6410 668919 0) 0 nil])
([nil nil ((792 . 795) (t 26998 6410 0 0)) nil (26998 21110 403664 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 877 . 878) (nil fontified nil 795 . 878) (795 . 878)) nil (26998 21110 403660 0) 0 nil])
([nil nil ((67402 . 67403) (t 26998 21110 0 0)) nil (26998 21962 72285 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69046 . 69047) (nil fontified nil 67403 . 69047) (67403 . 69047)) nil (26998 21962 72284 0) 0 nil])
([nil nil ((1596 . 1600)) nil (26998 21962 72284 0) 0 nil])
([nil nil ((1600 . 1601)) nil (26998 21962 72283 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1616 . 1617) (nil fontified nil 1601 . 1617) (1601 . 1617)) nil (26998 21962 72282 0) 0 nil])
([nil nil ((69068 . 69069)) nil (26998 21962 72278 0) 0 nil])
([nil nil ((#("(lumen.core.middleware:defmiddleware trace-middleware
    ((threshold-ms :initarg :threshold-ms :initform 500 \"Log si plus lent que X ms\")
     (force-header :initarg :force-header :initform \"x-trace-debug\"))
    (req next)
  
  ;; On initialise les variables dynamiques Ã  NIL pour ce thread
  (let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    
    ;; On dÃ©marre la racine \"HTTP Request\"
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      (let ((resp (funcall next req)))
        
        ;; Logique de fin de requÃªte
        (let* ((root lumen.core.trace:*trace-root*)
               (dur (if (and root (lumen.core.trace::trace-end root))
                        (lumen.core.trace::%ms (- (lumen.core.trace::trace-end root) 
                                                  (lumen.core.trace::trace-start root)))
                        0)))
          
          ;; Condition d'affichage : Erreur (500), Lenteur, ou Header demandÃ©
          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    (lumen.core.http:req-header req (slot-value mw 'force-header)))
            
            ;; On dump le waterfall dans la console
            (lumen.core.trace:print-trace-waterfall)
            
            ;; Bonus : On injecte le JSON dans un header pour les outils de dev ?
            ;; Attention Ã  la taille des headers.
            ))
        
        resp))))" 0 53 (fontified t) 53 73 (fontified t) 73 81 (face font-lock-builtin-face fontified t) 81 82 (fontified t) 82 95 (face font-lock-builtin-face fontified t) 95 96 (fontified t) 96 105 (face font-lock-builtin-face fontified t) 105 110 (fontified t) 110 137 (face font-lock-string-face fontified t) 137 158 (fontified t) 158 166 (face font-lock-builtin-face fontified t) 166 167 (fontified t) 167 180 (face font-lock-builtin-face fontified t) 180 181 (fontified t) 181 190 (face font-lock-builtin-face fontified t) 190 191 (fontified t) 191 206 (face font-lock-string-face fontified t) 206 229 (fontified t) 229 232 (face font-lock-comment-delimiter-face fontified t) 232 292 (face font-lock-comment-face fontified t) 292 295 (fontified t) 295 298 (face font-lock-keyword-face fontified t) 298 393 (fontified t) 393 396 (face font-lock-comment-delimiter-face fontified t) 396 432 (face font-lock-comment-face fontified t) 432 437 (fontified t) 437 466 (face font-lock-keyword-face fontified t) 466 468 (fontified t) 468 482 (face font-lock-string-face fontified t) 482 520 (fontified t) 520 525 (face font-lock-builtin-face fontified t) 525 593 (fontified t) 593 600 (face font-lock-builtin-face fontified t) 600 642 (fontified t) 642 645 (face font-lock-keyword-face fontified t) 645 691 (fontified t) 691 694 (face font-lock-comment-delimiter-face fontified t) 694 720 (face font-lock-comment-face fontified t) 720 729 (fontified t) 729 733 (face font-lock-keyword-face fontified t) 733 793 (fontified t) 793 795 (face font-lock-keyword-face fontified t) 795 1067 (fontified t) 1067 1070 (face font-lock-comment-delimiter-face fontified t) 1070 1135 (face font-lock-comment-face fontified t) 1135 1146 (fontified t) 1146 1150 (face font-lock-keyword-face fontified t) 1150 1366 (fontified t) 1366 1369 (face font-lock-comment-delimiter-face fontified t) 1369 1406 (face font-lock-comment-face fontified t) 1406 1484 (fontified t) 1484 1487 (face font-lock-comment-delimiter-face fontified t) 1487 1500 (face font-lock-comment-face fontified t) 1500 1553 (face font-lock-comment-face fontified t) 1553 1554 (face font-lock-comment-face fontified t) 1554 1566 (fontified t) 1566 1569 (face font-lock-comment-delimiter-face fontified t) 1569 1604 (face font-lock-comment-face fontified t) 1604 1628 (fontified t) 1628 1643 (fontified t) 1643 1644 (fontified t rear-nonsticky t)) . -67424) (undo-tree-id0 . -42) (undo-tree-id1 . -37) (undo-tree-id2 . -60) (undo-tree-id3 . -432) (undo-tree-id4 . -1644) (undo-tree-id5 . -336) (undo-tree-id6 . -1278) (undo-tree-id7 . -1309) (undo-tree-id8 . -1309) (undo-tree-id9 . -1309) (undo-tree-id10 . -1309) (undo-tree-id11 . -1278) (undo-tree-id12 . -1644) (undo-tree-id13 . -1278) (undo-tree-id14 . -1304) (undo-tree-id15 . -1304) (undo-tree-id16 . -1304) (undo-tree-id17 . -1304) (undo-tree-id18 . -1304) (undo-tree-id19 . -1304) (undo-tree-id20 . -1304) (undo-tree-id21 . -1304) (undo-tree-id22 . -1304) (undo-tree-id23 . -1304) (undo-tree-id24 . -336) (undo-tree-id25 . -1304) (undo-tree-id26 . -1304) (undo-tree-id27 . -336) (undo-tree-id28 . -720) (undo-tree-id29 . -1304) (undo-tree-id30 . -1644) (undo-tree-id31 . -1644) (undo-tree-id32 . -1644) (undo-tree-id33 . -1278) (undo-tree-id34 . -1628) (undo-tree-id35 . -1644) (undo-tree-id36 . -1644) 69068 (t 26998 21962 0 0)) nil (26998 22359 662684 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69460 . 69461) (nil fontified nil 67424 . 69461) (67424 . 69461)) nil (26998 22359 662643 0) 0 nil])
([nil nil ((#("((threshold-ms :initarg :threshold-ms :initform 500 \"Log si plus lent que X ms\")
     (force-header :initarg :force-header :initform \"x-trace-debug\"))" 0 15 (fontified t) 15 23 (face font-lock-builtin-face fontified t) 23 24 (fontified t) 24 37 (face font-lock-builtin-face fontified t) 37 38 (fontified t) 38 47 (face font-lock-builtin-face fontified t) 47 52 (fontified t) 52 79 (face font-lock-string-face fontified t) 79 100 (fontified t) 100 108 (face font-lock-builtin-face fontified t) 108 109 (fontified t) 109 122 (face font-lock-builtin-face fontified t) 122 123 (fontified t) 123 132 (face font-lock-builtin-face fontified t) 132 133 (fontified t) 133 148 (face font-lock-string-face fontified t) 148 150 (fontified t)) . -67460) (undo-tree-id37 . -150) (undo-tree-id38 . -150) (undo-tree-id39 . -150) (undo-tree-id40 . -81) (undo-tree-id41 . -150) (undo-tree-id42 . -150) (undo-tree-id43 . -150) (undo-tree-id44 . -150) (undo-tree-id45 . -150) (undo-tree-id46 . -150) 67610 (t 26998 22359 0 0)) nil (26998 22519 908741 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 67728 . 67729) (nil fontified nil 67460 . 67729) (67460 . 67729)) nil (26998 22519 908724 0) 0 nil])
([nil nil ((#(";; <-- CORRECTION : Ajout de :documentation" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 43 (face font-lock-comment-face fontified t)) . -67596) (undo-tree-id60 . -43) (undo-tree-id61 . -43) (undo-tree-id62 . -43) 67639 (t 26998 22519 0 0)) nil (26998 22523 352760 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -67595) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) 67596) nil (26998 22523 352755 0) 0 nil])
([nil nil ((#("(defmiddleware trace-middleware
    ((threshold-ms :initarg :threshold-ms 
                   :initform 500 
                   :documentation \"Log si plus lent que X ms\")
     (force-header :initarg :force-header 
                   :initform \"x-trace-debug\"))
    (req next)
  
  ;; Initialisation du contexte de trace pour ce thread
  (let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    
    ;; DÃ©marrage de la trace racine
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      (let ((resp (funcall next req)))
        
        ;; Logique de fin de requÃªte (Calcul durÃ©e + dÃ©cision de log)
        (let* ((root lumen.core.trace:*trace-root*)
               (dur (if (and root (lumen.core.trace::trace-end root))
                        (lumen.core.trace::%ms (- (lumen.core.trace::trace-end root) 
                                                  (lumen.core.trace::trace-start root)))
                        0))
               ;; CORRECTION ICI : Extraction manuelle du header dans l'alist
               (debug-requested-p 
                (cdr (assoc (slot-value mw 'force-header) 
                            (lumen.core.http:req-headers req) 
                            :test #'string-equal))))
          
          ;; Condition d'affichage : Erreur (500), Lenteur, ou Header \"x-trace-debug\" prÃ©sent
          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    debug-requested-p)
            
            ;; On dump le waterfall dans la console
            (format t \"~&[TRACE] Triggered by: ~A (Duration: ~,2Fms)~%\" 
                    (cond ((>= (lumen.core.http:resp-status resp) 500) \"Error 500\")
                          (debug-requested-p \"Header Request\")
                          (t \"Slow Request\"))
                    dur)
            (lumen.core.trace:print-trace-waterfall)))
        
        resp))))" 0 51 (fontified t) 51 59 (face font-lock-builtin-face fontified t) 59 60 (fontified t) 60 73 (face font-lock-builtin-face fontified t) 73 94 (fontified t) 94 103 (face font-lock-builtin-face fontified t) 103 128 (fontified t) 128 142 (face font-lock-builtin-face fontified t) 142 143 (fontified t) 143 170 (face font-lock-doc-face fontified t) 170 191 (fontified t) 191 199 (face font-lock-builtin-face fontified t) 199 200 (fontified t) 200 213 (face font-lock-builtin-face fontified t) 213 234 (fontified t) 234 243 (face font-lock-builtin-face fontified t) 243 244 (fontified t) 244 259 (face font-lock-string-face fontified t) 259 282 (fontified t) 282 285 (face font-lock-comment-delimiter-face fontified t) 285 336 (face font-lock-comment-face fontified t) 336 339 (fontified t) 339 342 (face font-lock-keyword-face fontified t) 342 437 (fontified t) 437 440 (face font-lock-comment-delimiter-face fontified t) 440 469 (face font-lock-comment-face fontified t) 469 474 (fontified t) 474 503 (face font-lock-keyword-face fontified t) 503 505 (fontified t) 505 519 (face font-lock-string-face fontified t) 519 557 (fontified t) 557 562 (face font-lock-builtin-face fontified t) 562 630 (fontified t) 630 637 (face font-lock-builtin-face fontified t) 637 686 (fontified t) 686 689 (face font-lock-keyword-face fontified t) 689 735 (fontified t) 735 738 (face font-lock-comment-delimiter-face fontified t) 738 797 (face font-lock-comment-face fontified t) 797 806 (fontified t) 806 810 (face font-lock-keyword-face fontified t) 810 870 (fontified t) 870 872 (face font-lock-keyword-face fontified t) 872 929 (fontified t) 929 1005 (fontified t) 1005 1137 (fontified t) 1137 1140 (face font-lock-comment-delimiter-face fontified t) 1140 1200 (face font-lock-comment-face fontified t) 1200 1385 (fontified t) 1385 1390 (face font-lock-builtin-face fontified t) 1390 1431 (fontified t) 1431 1434 (face font-lock-comment-delimiter-face fontified t) 1434 1515 (face font-lock-comment-face fontified t) 1515 1526 (fontified t) 1526 1530 (face font-lock-keyword-face fontified t) 1530 1701 (fontified t) 1701 1704 (face font-lock-comment-delimiter-face fontified t) 1704 1741 (face font-lock-comment-face fontified t) 1741 1763 (fontified t) 1763 1812 (face font-lock-string-face fontified t) 1812 1835 (fontified t) 1835 1839 (face font-lock-keyword-face fontified t) 1839 1885 (fontified t) 1885 1896 (face font-lock-string-face fontified t) 1896 1943 (fontified t) 1943 1959 (face font-lock-string-face fontified t) 1959 1990 (fontified t) 1990 2004 (face font-lock-string-face fontified t) 2004 2112 (fontified t)) . -67424) (undo-tree-id0 . -2112) (undo-tree-id1 . -1235) (undo-tree-id2 . -1005) (undo-tree-id3 . -469) (undo-tree-id4 . -469) (undo-tree-id5 . -1814) (undo-tree-id6 . -1814) (undo-tree-id7 . -1814) (undo-tree-id8 . -1814) (undo-tree-id9 . -1814) (undo-tree-id10 . -1814) (undo-tree-id11 . -1814) (undo-tree-id12 . -1814) (undo-tree-id13 . -1814) (undo-tree-id14 . -1814) (undo-tree-id15 . -1814) (undo-tree-id16 . -1814) (undo-tree-id17 . -1637) (undo-tree-id18 . -1579) (undo-tree-id19 . -1507) (undo-tree-id20 . -1357) (undo-tree-id21 . -1122) (undo-tree-id22 . -1122) (undo-tree-id23 . -1122) (undo-tree-id24 . -1122) (undo-tree-id25 . -1122) (undo-tree-id26 . -2112) (undo-tree-id27 . -2112) (undo-tree-id28 . -2096) (undo-tree-id29 . -2112) (undo-tree-id30 . -2112) 69536 (t 26998 22523 0 0)) nil (26998 24379 153321 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69395 . 69396) (nil fontified nil 67424 . 69396) (67424 . 69396)) nil (26998 24379 153285 0) 0 nil])
([nil nil ((67795 . 67800) (t 26998 24379 0 0)) nil (26998 25051 277856 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 67881 . 67882) (nil fontified nil 67800 . 67882) (67800 . 67882)) nil (26998 25051 277853 0) 0 nil])
([nil nil ((#("(defmiddleware trace-middleware
    ((threshold-ms :initarg :threshold-ms 
                   :initform 500 
                   :documentation \"Log si plus lent que X ms\")
     (force-header :initarg :force-header 
                   :initform \"x-trace-debug\"))
    (req next)
  
  (let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    (declare (special lumen.core.trace:*trace-root* lumen.core.trace:*trace-current*))
    
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      (let ((resp (funcall next req)))
        
        ;; 1. CALCUL MANUEL DE LA DURÃ‰E (FIX)
        (let* ((root lumen.core.trace:*trace-root*)
               (now  (get-internal-real-time))
               (start (if root (lumen.core.trace::trace-start root) now))
               ;; On calcule la durÃ©e Ã©coulÃ©e jusqu'Ã  maintenant
               (dur  (lumen.core.trace::%ms (- now start)))
               (debug-requested-p 
                (cdr (assoc (slot-value mw 'force-header) 
                            (lumen.core.http:req-headers req) 
                            :test #'string-equal))))
          
          ;; 2. INJECTION DE LA DURÃ‰E POUR L'AFFICHAGE
          ;; On force la date de fin sur le nÅ“ud racine pour que le waterfall soit complet
          (when root
            (setf (lumen.core.trace::trace-end root) now))

          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    debug-requested-p)
            
            (format t \"~&[TRACE] Triggered by: ~A (Duration: ~,2Fms)~%\" 
                    (cond ((>= (lumen.core.http:resp-status resp) 500) \"Error 500\")
                          (debug-requested-p \"Header Request\")
                          (t \"Slow Request\"))
                    dur)
            (lumen.core.trace:print-trace-waterfall)))
        
        resp))))" 0 51 (fontified t) 51 59 (face font-lock-builtin-face fontified t) 59 60 (fontified t) 60 73 (face font-lock-builtin-face fontified t) 73 94 (fontified t) 94 103 (face font-lock-builtin-face fontified t) 103 128 (fontified t) 128 142 (face font-lock-builtin-face fontified t) 142 143 (fontified t) 143 170 (face font-lock-doc-face fontified t) 170 191 (fontified t) 191 199 (face font-lock-builtin-face fontified t) 199 200 (fontified t) 200 213 (face font-lock-builtin-face fontified t) 213 234 (fontified t) 234 243 (face font-lock-builtin-face fontified t) 243 244 (fontified t) 244 259 (face font-lock-string-face fontified t) 259 283 (fontified t) 283 286 (face font-lock-keyword-face fontified t) 286 335 (fontified t) 335 372 (fontified t) 372 377 (fontified t) 377 384 (face font-lock-keyword-face fontified t) 384 469 (fontified t) 469 498 (face font-lock-keyword-face fontified t) 498 500 (fontified t) 500 514 (face font-lock-string-face fontified t) 514 552 (fontified t) 552 557 (face font-lock-builtin-face fontified t) 557 625 (fontified t) 625 632 (face font-lock-builtin-face fontified t) 632 681 (fontified t) 681 684 (face font-lock-keyword-face fontified t) 684 730 (fontified t) 730 733 (face font-lock-comment-delimiter-face fontified t) 733 768 (face font-lock-comment-face fontified t) 768 777 (fontified t) 777 781 (face font-lock-keyword-face fontified t) 781 890 (fontified t) 890 892 (face font-lock-keyword-face fontified t) 892 956 (fontified t) 956 959 (face font-lock-comment-delimiter-face fontified t) 959 1006 (face font-lock-comment-face fontified t) 1006 1251 (fontified t) 1251 1256 (face font-lock-builtin-face fontified t) 1256 1297 (fontified t) 1297 1300 (face font-lock-comment-delimiter-face fontified t) 1300 1342 (face font-lock-comment-face fontified t) 1342 1352 (fontified t) 1352 1355 (face font-lock-comment-delimiter-face fontified t) 1355 1433 (face font-lock-comment-face fontified t) 1433 1444 (fontified t) 1444 1448 (face font-lock-keyword-face fontified t) 1448 1525 (fontified t) 1525 1529 (face font-lock-keyword-face fontified t) 1529 1710 (fontified t) 1710 1759 (face font-lock-string-face fontified t) 1759 1782 (fontified t) 1782 1786 (face font-lock-keyword-face fontified t) 1786 1832 (fontified t) 1832 1843 (face font-lock-string-face fontified t) 1843 1872 (fontified t) 1872 1890 (fontified t) 1890 1906 (face font-lock-string-face fontified t) 1906 1908 (fontified t) 1908 1937 (fontified t) 1937 1951 (face font-lock-string-face fontified t) 1951 2059 (fontified t)) . -67424) (undo-tree-id0 . -2059) (undo-tree-id1 . -1276) 69483 (t 26998 25051 0 0)) nil (26998 25690 940254 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69486 . 69487) (nil fontified nil 67424 . 69487) (67424 . 69487)) nil (26998 25690 940236 0) 0 nil])
([nil nil ((#(";; -----------------------------------------------------------
  ;; FIX CRITIQUE : On force la liaison DYNAMIQUE (Thread-Local)
  ;; -----------------------------------------------------------
  (let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    (declare (special lumen.core.trace:*trace-root* lumen.core.trace:*trace-current*)) 
    
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      (let ((resp (funcall next req)))
        
        ;; Calculs de fin
        (let* ((root lumen.core.trace:*trace-root*)
               (now  (get-internal-real-time))
               (start (if root (lumen.core.trace::trace-start root) now))
               (dur  (lumen.core.trace::%ms (- now start)))
               (debug-requested-p 
                (cdr (assoc (slot-value mw 'force-header) 
                            (lumen.core.http:req-headers req) 
                            :test #'string-equal))))
          
          ;; Force la fin du root pour l'affichage
          (when root (setf (lumen.core.trace::trace-end root) now))

          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    debug-requested-p)
            
            (format t \"~&[TRACE] Triggered by: ~A (Duration: ~,2Fms)~%\" 
                    (cond ((>= (lumen.core.http:resp-status resp) 500) \"Error 500\")
                          (debug-requested-p \"Header Request\")
                          (t \"Slow Request\"))
                    dur)
            (lumen.core.trace:print-trace-waterfall)))
        
        resp)))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 63 (face font-lock-comment-face fontified t) 63 65 (fontified t) 65 68 (face font-lock-comment-delimiter-face fontified t) 68 128 (face font-lock-comment-face fontified t) 128 130 (fontified t) 130 133 (face font-lock-comment-delimiter-face fontified t) 133 193 (face font-lock-comment-face fontified t) 193 196 (fontified t) 196 199 (face font-lock-keyword-face fontified t) 199 290 (fontified t) 290 297 (face font-lock-keyword-face fontified t) 297 383 (fontified t) 383 412 (face font-lock-keyword-face fontified t) 412 414 (fontified t) 414 428 (face font-lock-string-face fontified t) 428 466 (fontified t) 466 471 (face font-lock-builtin-face fontified t) 471 539 (fontified t) 539 546 (face font-lock-builtin-face fontified t) 546 595 (fontified t) 595 598 (face font-lock-keyword-face fontified t) 598 644 (fontified t) 644 647 (face font-lock-comment-delimiter-face fontified t) 647 662 (face font-lock-comment-face fontified t) 662 671 (fontified t) 671 675 (face font-lock-keyword-face fontified t) 675 773 (fontified t) 773 784 (fontified t) 784 786 (face font-lock-keyword-face fontified t) 786 835 (fontified t) 835 1080 (fontified t) 1080 1085 (face font-lock-builtin-face fontified t) 1085 1126 (fontified t) 1126 1129 (face font-lock-comment-delimiter-face fontified t) 1129 1167 (face font-lock-comment-face fontified t) 1167 1178 (fontified t) 1178 1182 (face font-lock-keyword-face fontified t) 1182 1247 (fontified t) 1247 1251 (face font-lock-keyword-face fontified t) 1251 1432 (fontified t) 1432 1481 (face font-lock-string-face fontified t) 1481 1504 (fontified t) 1504 1508 (face font-lock-keyword-face fontified t) 1508 1554 (fontified t) 1554 1565 (face font-lock-string-face fontified t) 1565 1612 (fontified t) 1612 1628 (face font-lock-string-face fontified t) 1628 1659 (fontified t) 1659 1673 (face font-lock-string-face fontified t) 1673 1780 (fontified t)) . -67706) (undo-tree-id3 . -1780) (undo-tree-id4 . -989) (undo-tree-id5 . -929) (undo-tree-id6 . -1765) (undo-tree-id7 . -1765) (undo-tree-id8 . -1780) (undo-tree-id9 . -1780) (undo-tree-id10 . -1780) (undo-tree-id11 . -1780) 69486 (t 26998 25690 0 0)) nil (26998 26409 395112 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69260 . 69261) (nil fontified nil 67706 . 69261) (67706 . 69261)) nil (26998 26409 395104 0) 0 nil])
([nil nil ((69262 . 69263)) nil (26998 26409 395102 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -69262) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 69263) nil (26998 26409 395099 0) 0 nil])
([nil nil ((#(";; On utilise PROGV ici aussi pour initialiser les globales dynamiquement
  (progv (list 'lumen.core.trace:*trace-root* 'lumen.core.trace:*trace-current*)
         (list nil nil)
    
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      (let ((resp (funcall next req)))
        
        ;; Logique de fin (identique Ã  avant)
        (let* ((root lumen.core.trace:*trace-root*)
               (now  (get-internal-real-time))
               (start (if root (lumen.core.trace::trace-start root) now))
               (dur  (lumen.core.trace::%ms (- now start)))
               (debug-requested-p 
                (cdr (assoc (slot-value mw 'force-header) 
                            (lumen.core.http:req-headers req) 
                            :test #'string-equal))))
          
          (when root (setf (lumen.core.trace::trace-end root) now))

          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    debug-requested-p)
            
            (format t \"~&[TRACE] Triggered by: ~A (Duration: ~,2Fms)~%\" 
                    (cond ((>= (lumen.core.http:resp-status resp) 500) \"Error 500\")
                          (debug-requested-p \"Header Request\")
                          (t \"Slow Request\"))
                    dur)
            (lumen.core.trace:print-trace-waterfall)))
        
        resp)))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 74 (face font-lock-comment-face fontified t) 74 77 (fontified t) 77 82 (face font-lock-keyword-face fontified t) 82 189 (fontified t) 189 218 (face font-lock-keyword-face fontified t) 218 220 (fontified t) 220 234 (face font-lock-string-face fontified t) 234 272 (fontified t) 272 277 (face font-lock-builtin-face fontified t) 277 345 (fontified t) 345 352 (face font-lock-builtin-face fontified t) 352 401 (fontified t) 401 404 (face font-lock-keyword-face fontified t) 404 450 (fontified t) 450 453 (face font-lock-comment-delimiter-face fontified t) 453 488 (face font-lock-comment-face fontified t) 488 497 (fontified t) 497 501 (face font-lock-keyword-face fontified t) 501 610 (fontified t) 610 612 (face font-lock-keyword-face fontified t) 612 906 (fontified t) 906 911 (face font-lock-builtin-face fontified t) 911 953 (fontified t) 953 957 (face font-lock-keyword-face fontified t) 957 1022 (fontified t) 1022 1026 (face font-lock-keyword-face fontified t) 1026 1207 (fontified t) 1207 1256 (face font-lock-string-face fontified t) 1256 1279 (fontified t) 1279 1283 (face font-lock-keyword-face fontified t) 1283 1293 (fontified t) 1293 1329 (fontified t) 1329 1340 (face font-lock-string-face fontified t) 1340 1342 (fontified t) 1342 1387 (fontified t) 1387 1403 (face font-lock-string-face fontified t) 1403 1434 (fontified t) 1434 1448 (face font-lock-string-face fontified t) 1448 1555 (fontified t)) . -67706) (undo-tree-id2 . -1053) (undo-tree-id3 . -1053) (undo-tree-id4 . -1555) (undo-tree-id5 . -1185) (undo-tree-id6 . -1555) (undo-tree-id7 . -1555) (undo-tree-id8 . -1555) (undo-tree-id9 . -1555) (undo-tree-id10 . -1053) (undo-tree-id11 . -1540) (undo-tree-id12 . -1555) (undo-tree-id13 . -1555) 69261 (t 26998 26409 0 0)) nil (26998 27309 665562 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 68987 . 68988) (nil fontified nil 67706 . 68988) (67706 . 68988)) nil (26998 27309 665554 0) 0 nil])
([nil nil ((68989 . 68990)) nil (26998 27309 665553 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -68989) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 68990) nil (26998 27309 665552 0) 0 nil])
([nil nil ((68989 . 68990)) nil (26998 27309 665535 0) 0 nil])
([nil nil ((#(";; Initialisation propre des variables globales pour ce thread
  ;; Comme ces variables sont DEFVAR dans trace.lisp, ce LET est dynamique.
  (let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      (let ((resp (funcall next req)))
        
        ;; Logique de fin
        (let* ((root lumen.core.trace:*trace-root*)
               (now  (get-internal-real-time))
               (start (if root (lumen.core.trace::trace-start root) now))
               (dur  (lumen.core.trace::%ms (- now start)))
               (debug-requested-p 
                (cdr (assoc (slot-value mw 'force-header) 
                            (lumen.core.http:req-headers req) 
                            :test #'string-equal))))
          
          (when root (setf (lumen.core.trace::trace-end root) now))

          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    debug-requested-p)
            (lumen.core.trace:print-trace-waterfall))
        
        resp))))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 63 (face font-lock-comment-face fontified t) 63 65 (fontified t) 65 68 (face font-lock-comment-delimiter-face fontified t) 68 139 (face font-lock-comment-face fontified t) 139 142 (fontified t) 142 145 (face font-lock-keyword-face fontified t) 145 241 (fontified t) 241 268 (face font-lock-keyword-face fontified t) 268 270 (face font-lock-keyword-face fontified t) 270 272 (fontified t) 272 286 (face font-lock-string-face fontified t) 286 288 (fontified t) 288 324 (fontified t) 324 329 (face font-lock-builtin-face fontified t) 329 397 (fontified t) 397 404 (face font-lock-builtin-face fontified t) 404 453 (fontified t) 453 456 (face font-lock-keyword-face fontified t) 456 502 (fontified t) 502 505 (face font-lock-comment-delimiter-face fontified t) 505 520 (face font-lock-comment-face fontified t) 520 529 (fontified t) 529 533 (face font-lock-keyword-face fontified t) 533 642 (fontified t) 642 644 (face font-lock-keyword-face fontified t) 644 938 (fontified t) 938 943 (face font-lock-builtin-face fontified t) 943 985 (fontified t) 985 989 (face font-lock-keyword-face fontified t) 989 1054 (fontified t) 1054 1058 (face font-lock-keyword-face fontified t) 1058 1283 (fontified t)) . -67706) (undo-tree-id0 . -1283) (undo-tree-id1 . -1107) (undo-tree-id2 . -288) (undo-tree-id3 . -231) (undo-tree-id4 . -231) (undo-tree-id5 . -231) (undo-tree-id6 . -231) (undo-tree-id7 . -231) (undo-tree-id8 . -231) (undo-tree-id9 . -231) (undo-tree-id10 . -231) (undo-tree-id11 . -231) (undo-tree-id12 . -231) (undo-tree-id13 . -231) (undo-tree-id14 . -231) (undo-tree-id15 . -231) (undo-tree-id16 . -231) (undo-tree-id17 . -231) (undo-tree-id18 . -231) (undo-tree-id19 . -1107) (undo-tree-id20 . -1107) (undo-tree-id21 . -1107) (undo-tree-id22 . -1107) (undo-tree-id23 . -1107) (undo-tree-id24 . -1107) (undo-tree-id25 . -1107) (undo-tree-id26 . -1107) (undo-tree-id27 . -1107) (undo-tree-id28 . -1107) (undo-tree-id29 . -1107) (undo-tree-id30 . -1107) (undo-tree-id31 . -1107) (undo-tree-id32 . -1107) (undo-tree-id33 . -1107) (undo-tree-id34 . -1107) (undo-tree-id35 . -1107) (undo-tree-id36 . -1107) (undo-tree-id37 . -1107) (undo-tree-id38 . -1043) (undo-tree-id39 . -1043) (undo-tree-id40 . -1043) (undo-tree-id41 . -1043) (undo-tree-id42 . -1043) (undo-tree-id43 . -1145) (undo-tree-id44 . -1267) (undo-tree-id45 . -1283) (undo-tree-id46 . -1283) (undo-tree-id47 . -1283) (undo-tree-id48 . -1283) (undo-tree-id49 . -1283) (undo-tree-id50 . -1283) 68989 (t 26998 27309 0 0)) nil (26998 27465 343307 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69185 . 69186) (nil fontified nil 67706 . 69186) (67706 . 69186)) nil (26998 27465 343266 0) 0 nil])
([nil nil ((69187 . 69188)) nil (26998 27465 343261 0) 0 nil])
([nil nil ((#("(let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    
    ;; --- FIX CRITIQUE ---
    ;; On force le compilateur Ã  traiter ces variables comme DYNAMIQUES
    ;; Cela permet Ã  la fonction 'call-with-tracing' (dans un autre package) de voir ces valeurs.
    (declare (special lumen.core.trace:*trace-root* lumen.core.trace:*trace-current*)) 
    
    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      (let ((resp (funcall next req)))
        
        ;; Logique de fin
        (let* ((root lumen.core.trace:*trace-root*)
               (now  (get-internal-real-time))
               (start (if root (lumen.core.trace::trace-start root) now))
               (dur  (lumen.core.trace::%ms (- now start)))
               (debug-requested-p 
                (cdr (assoc (slot-value mw 'force-header) 
                            (lumen.core.http:req-headers req) 
                            :test #'string-equal))))
          
          (when root (setf (lumen.core.trace::trace-end root) now))

          (when (or (>= (lumen.core.http:resp-status resp) 500)
                    (> dur (slot-value mw 'threshold-ms))
                    debug-requested-p)
            (lumen.core.trace:print-trace-waterfall))
        
        resp))))" 0 1 (fontified t) 1 4 (face font-lock-keyword-face fontified t) 4 99 (fontified t) 99 102 (face font-lock-comment-delimiter-face fontified t) 102 123 (face font-lock-comment-face fontified t) 123 127 (fontified t) 127 130 (face font-lock-comment-delimiter-face fontified t) 130 195 (face font-lock-comment-face fontified t) 195 199 (fontified t) 199 202 (face font-lock-comment-delimiter-face fontified t) 202 293 (face font-lock-comment-face fontified t) 293 298 (fontified t) 298 305 (face font-lock-keyword-face fontified t) 305 391 (fontified t) 391 420 (face font-lock-keyword-face fontified t) 420 422 (fontified t) 422 436 (face font-lock-string-face fontified t) 436 474 (fontified t) 474 479 (face font-lock-builtin-face fontified t) 479 547 (fontified t) 547 554 (face font-lock-builtin-face fontified t) 554 603 (fontified t) 603 606 (face font-lock-keyword-face fontified t) 606 652 (fontified t) 652 655 (face font-lock-comment-delimiter-face fontified t) 655 670 (face font-lock-comment-face fontified t) 670 679 (fontified t) 679 683 (face font-lock-keyword-face fontified t) 683 792 (fontified t) 792 794 (face font-lock-keyword-face fontified t) 794 1088 (fontified t) 1088 1093 (face font-lock-builtin-face fontified t) 1093 1135 (fontified t) 1135 1139 (face font-lock-keyword-face fontified t) 1139 1204 (fontified t) 1204 1208 (face font-lock-keyword-face fontified t) 1208 1417 (fontified t) 1417 1431 (fontified t) 1431 1432 (rear-nonsticky t fontified t) 1432 1433 (fontified t)) . -67754) (undo-tree-id53 . -635) (undo-tree-id54 . -635) (undo-tree-id55 . -635) (undo-tree-id56 . -1433) (undo-tree-id57 . -635) (undo-tree-id58 . -1257) (undo-tree-id59 . -1193) (undo-tree-id60 . -1124) (undo-tree-id61 . -997) (undo-tree-id62 . -997) (undo-tree-id63 . -997) (undo-tree-id64 . -997) (undo-tree-id65 . -997) (undo-tree-id66 . -1433) (undo-tree-id67 . -1433) (undo-tree-id68 . -1417) (undo-tree-id69 . -1433) (undo-tree-id70 . -1433) 69187 (t 26998 27465 0 0)) nil (26998 27721 60996 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69576 . 69577) (nil fontified nil 67754 . 69577) (67754 . 69577)) nil (26998 27721 60985 0) 0 nil])
([nil nil ((69578 . 69579)) nil (26998 27721 60983 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -69578) (undo-tree-id51 . -1) (undo-tree-id52 . -1) 69579) nil (26998 27721 60980 0) 0 nil])
([nil nil ((#("(let ((lumen.core.trace:*trace-root* nil)
        (lumen.core.trace:*trace-current* nil))
    
    ;; TEST SCIENTIFIQUE : Est-ce que le compilateur a obÃ©i ?
    (format t \"~&[DEBUG 1] Avant With-Tracing. Bound? ~A~%\" 
            (boundp 'lumen.core.trace:*trace-current*))

    (lumen.core.trace:with-tracing (\"HTTP Request\" 
                                    :path (lumen.core.http:req-path req)
                                    :method (lumen.core.http:req-method req))
      
      ;; Ã€ ce stade, *trace-current* devrait pointer sur le nÅ“ud \"HTTP Request\"
      ;; TEST CRITIQUE :
      (let ((val-direct lumen.core.trace:*trace-current*)
            (val-dynamic (if (boundp 'lumen.core.trace:*trace-current*)
                             (symbol-value 'lumen.core.trace:*trace-current*)
                             :unbound)))
        
        (format t \"~&--------------------------------------------------~%\")
        (format t \"[DIAGNOSTIC MIDDLEWARE]~%\")
        (format t \"1. Valeur Directe (Locale)  : ~A~%\" val-direct)
        (format t \"2. Valeur Dynamique (Globale): ~A~%\" val-dynamic)
        (format t \"3. Symbole Exact            : ~S (Pkg: ~A)~%\" 
                'lumen.core.trace:*trace-current*
                (package-name (symbol-package 'lumen.core.trace:*trace-current*)))
        (format t \"4. VERDICT: ~A~%\" 
                (if (eq val-direct val-dynamic) 
                    \"OK (Liaison Dynamique)\" 
                    \"ECHEC (Liaison Lexicale - Le compilateur ignore DEFVAR)\"))
        (format t \"--------------------------------------------------~%\"))

      (let ((resp (funcall next req)))
        
        ;; (Logique de fin simplifiÃ©e pour le test)
        (when (>= (lumen.core.http:resp-status resp) 200)
             (lumen.core.trace:print-trace-waterfall))
        resp)))" 0 1 (fontified t) 1 4 (face font-lock-keyword-face fontified t) 4 99 (fontified t) 99 102 (face font-lock-comment-delimiter-face fontified t) 102 157 (face font-lock-comment-face fontified t) 157 171 (fontified t) 171 216 (face font-lock-string-face fontified t) 216 280 (fontified t) 280 309 (face font-lock-keyword-face fontified t) 309 311 (fontified t) 311 325 (face font-lock-string-face fontified t) 325 363 (fontified t) 363 368 (face font-lock-builtin-face fontified t) 368 436 (fontified t) 436 443 (face font-lock-builtin-face fontified t) 443 491 (fontified t) 491 494 (face font-lock-comment-delimiter-face fontified t) 494 565 (face font-lock-comment-face fontified t) 565 571 (fontified t) 571 574 (face font-lock-comment-delimiter-face fontified t) 574 590 (face font-lock-comment-face fontified t) 590 597 (fontified t) 597 600 (face font-lock-keyword-face fontified t) 600 674 (fontified t) 674 676 (face font-lock-keyword-face fontified t) 676 827 (fontified t) 827 835 (face font-lock-builtin-face fontified t) 835 866 (fontified t) 866 922 (face font-lock-string-face fontified t) 922 942 (fontified t) 942 969 (face font-lock-string-face fontified t) 969 989 (fontified t) 989 1025 (face font-lock-string-face fontified t) 1025 1056 (fontified t) 1056 1093 (face font-lock-string-face fontified t) 1093 1125 (fontified t) 1125 1171 (face font-lock-string-face fontified t) 1171 1324 (fontified t) 1324 1342 (face font-lock-string-face fontified t) 1342 1361 (fontified t) 1361 1363 (face font-lock-keyword-face fontified t) 1363 1413 (fontified t) 1413 1437 (face font-lock-string-face fontified t) 1437 1459 (fontified t) 1459 1498 (face font-lock-string-face fontified t) 1498 1516 (face font-lock-string-face fontified t) 1516 1519 (fontified t) 1519 1537 (fontified t) 1537 1591 (face font-lock-string-face fontified t) 1591 1602 (fontified t) 1602 1605 (face font-lock-keyword-face fontified t) 1605 1651 (fontified t) 1651 1654 (face font-lock-comment-delimiter-face fontified t) 1654 1695 (face font-lock-comment-face fontified t) 1695 1704 (fontified t) 1704 1708 (face font-lock-keyword-face fontified t) 1708 1808 (fontified t) 1808 1822 (fontified t) 1822 1823 (rear-nonsticky t fontified t)) . -67754) (undo-tree-id74 . -848) (undo-tree-id75 . -1823) (undo-tree-id76 . -848) 69577 (t 26998 27721 0 0)) nil (26998 28420 985929 0) 0 nil])
([nil nil ((#(";; On initialise les variables pour ce thread" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 45 (face font-lock-comment-face fontified t)) . -67706) (undo-tree-id71 . -45) (undo-tree-id72 . -45) (undo-tree-id73 . -45) 67751) nil (26998 28420 985925 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 69356 . 69357) (nil fontified nil 67706 . 69357) (67706 . 69357)) nil (26998 28420 985912 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 69357) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (#(" " 0 1 (fontified t)) . 69357) (#("
" 0 1 (fontified t)) . 69357) (t 26998 28420 0 0)) nil (26998 28432 197439 0) 0 nil])
([nil nil ((69358 . 69359)) nil (26998 28432 197436 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -69358) (undo-tree-id77 . -1) 69359) nil (26998 28432 197433 0) 0 nil])
([nil nil ((#("(defmiddleware timeout-middleware
    ((ms :initarg :ms :initform 5000))
    (req next)
  
  (let* ((lock (bt:make-lock \"rt-lock\"))
         (cv   (bt:make-condition-variable))
         (resp nil)
         (done nil))
    
    (bt:make-thread
     (lambda ()
       (let ((r (funcall next req)))
         (bt:with-lock-held (lock)
           (setf resp r done t)
           (bt:condition-notify cv)))))
    
    (bt:with-lock-held (lock)
      (unless done
        (unless (bt:condition-wait cv lock :timeout (/ (slot-value mw 'ms) 1000.0))
          (return-from handle 
            (lumen.core.http:respond-json '((:error . ((:type . \"timeout\") (:message . \"gateway timeout\")))) :status 504)))))
    resp))" 0 33 (fontified t) 33 43 (fontified t) 43 51 (face font-lock-builtin-face fontified t) 51 52 (fontified t) 52 55 (face font-lock-builtin-face fontified t) 55 56 (fontified t) 56 65 (face font-lock-builtin-face fontified t) 65 94 (fontified t) 94 98 (face font-lock-keyword-face fontified t) 98 120 (fontified t) 120 129 (face font-lock-string-face fontified t) 129 249 (fontified t) 249 255 (face font-lock-keyword-face fontified t) 255 267 (fontified t) 267 270 (face font-lock-keyword-face fontified t) 270 306 (fontified t) 306 323 (face font-lock-keyword-face fontified t) 323 413 (fontified t) 413 430 (face font-lock-keyword-face fontified t) 430 445 (fontified t) 445 451 (face font-lock-keyword-face fontified t) 451 466 (fontified t) 466 472 (face font-lock-keyword-face fontified t) 472 500 (fontified t) 500 508 (face font-lock-builtin-face fontified t) 508 552 (fontified t) 552 563 (face font-lock-keyword-face fontified t) 563 617 (fontified t) 617 623 (face font-lock-builtin-face fontified t) 623 628 (fontified t) 628 633 (face font-lock-builtin-face fontified t) 633 636 (fontified t) 636 645 (face font-lock-string-face fontified t) 645 648 (fontified t) 648 656 (face font-lock-builtin-face fontified t) 656 659 (fontified t) 659 676 (face font-lock-string-face fontified t) 676 681 (fontified t) 681 688 (face font-lock-builtin-face fontified t) 688 708 (fontified t)) . -55039) (undo-tree-id93 . -708) 55747 (t 26998 28432 0 0)) nil (26998 29335 796764 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56119 . 56120) (nil fontified nil 55039 . 56120) (55039 . 56120)) nil (26998 29335 796763 0) 0 nil])
([nil nil ((877 . 878)) nil (26998 29335 796762 0) 0 nil])
([nil nil ((878 . 889)) nil (26998 29335 796762 0) 0 nil])
([nil nil ((878 . 893) (#("current-con" 0 11 (fontified t)) . -878) (undo-tree-id90 . -11) (undo-tree-id91 . -11) (undo-tree-id92 . -11) 889) nil (26998 29335 796761 0) 0 nil])
([nil nil ((893 . 894)) nil (26998 29335 796759 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 933 . 934) (nil fontified nil 894 . 934) (894 . 934)) nil (26998 29335 796758 0) 0 nil])
([nil nil ((#("lumen.core.trace" 0 16 (fontified t)) . -894) (undo-tree-id87 . -16) (undo-tree-id88 . -16) (undo-tree-id89 . -16) 910) nil (26998 29335 796757 0) 0 nil])
([nil nil ((878 . 879)) nil (26998 29335 796754 0) 0 nil])
([nil nil ((878 . 880) (#(" " 0 1 (fontified nil)) . 878) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (877 . 878)) nil (26998 29335 796751 0) 0 nil])
([nil nil ((#("(defmiddleware inspector-middleware
    ;; On lui passe le pipeline qu'il doit inspecter
    ((target-pipeline :initarg :pipeline 
                      :initform nil 
                      :accessor inspector-target)
     (path :initarg :path :initform \"/_pipeline\")) 
    (req next)
  
  (if (and (string= (lumen.core.http:req-path req) (slot-value mw 'path))
           (string= (lumen.core.http:req-method req) \"GET\"))
      
      ;; 1. Interception : On renvoie le JSON du pipeline
      (let* ((p (slot-value mw 'target-pipeline))
             (data (if p 
                       (lumen.core.pipeline:pipeline-to-list p)
                       '((:error . \"No pipeline attached to inspector\")))))
        (lumen.core.http:respond-json 
         `((:meta . ((:version . \"Lumen 2.0\") (:env . ,(lumen.core.config:cfg-profile))))
           (:pipeline . ,data))))
      
      ;; 2. Sinon : Passe-plat
      (funcall next req)))" 0 40 (fontified t) 40 43 (face font-lock-comment-delimiter-face fontified t) 43 77 (face font-lock-comment-face fontified t) 77 89 (face font-lock-comment-face fontified t) 89 111 (fontified t) 111 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 129 (face font-lock-builtin-face fontified t) 129 153 (fontified t) 153 162 (face font-lock-builtin-face fontified t) 162 190 (fontified t) 190 199 (face font-lock-builtin-face fontified t) 199 229 (fontified t) 229 237 (face font-lock-builtin-face fontified t) 237 238 (fontified t) 238 243 (face font-lock-builtin-face fontified t) 243 244 (fontified t) 244 253 (face font-lock-builtin-face fontified t) 253 254 (fontified t) 254 266 (face font-lock-string-face fontified t) 266 291 (fontified t) 291 293 (face font-lock-keyword-face fontified t) 293 415 (fontified t) 415 420 (face font-lock-string-face fontified t) 420 436 (fontified t) 436 439 (face font-lock-comment-delimiter-face fontified t) 439 488 (face font-lock-comment-face fontified t) 488 495 (fontified t) 495 499 (face font-lock-keyword-face fontified t) 499 558 (fontified t) 558 560 (face font-lock-keyword-face fontified t) 560 654 (fontified t) 654 660 (face font-lock-builtin-face fontified t) 660 663 (fontified t) 663 698 (face font-lock-string-face fontified t) 698 755 (fontified t) 755 760 (face font-lock-builtin-face fontified t) 760 765 (fontified t) 765 773 (face font-lock-builtin-face fontified t) 773 776 (fontified t) 776 787 (face font-lock-string-face fontified t) 787 790 (fontified t) 790 794 (face font-lock-builtin-face fontified t) 794 845 (fontified t) 845 854 (face font-lock-builtin-face fontified t) 854 880 (fontified t) 880 883 (face font-lock-comment-delimiter-face fontified t) 883 905 (face font-lock-comment-face fontified t) 905 931 (fontified t)) . -66908) (undo-tree-id94 . -931) 67839 (t 26998 29335 0 0)) nil (26999 45021 76690 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 68106 . 68107) (nil fontified nil 66908 . 68107) (66908 . 68107)) nil (26999 45021 76675 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 67728 . 67729) (nil fontified nil 67719 . 67729) (67719 . 67729) (t 26999 45021 0 0)) nil (27000 63509 586131 0) 0 nil])
([nil nil ((67729 . 67730)) nil (27000 63509 586130 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -67729) (undo-tree-id15 . -1) 67730) nil (27000 63509 586129 0) 0 nil])
([nil nil ((67729 . 67730)) nil (27000 63509 586128 0) 0 nil])
([nil nil ((#("middleware" 0 9 (fontified t) 9 10 (rear-nonsticky t fontified t)) . -67719) (undo-tree-id13 . -10) (undo-tree-id14 . -10) 67729) nil (27000 63509 586128 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 67738 . 67739) (nil fontified nil 67719 . 67739) (67719 . 67739)) nil (27000 63509 586126 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -67719) (undo-tree-id12 . -1) 67720) nil (27000 63509 586125 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 67890 . 67891) (nil fontified nil 67871 . 67891) (67871 . 67891)) nil (27000 63509 586123 0) 0 nil])
([nil nil ((67891 . 67892)) nil (27000 63509 586122 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -67871) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) 67872) nil (27000 63509 586121 0) 0 nil])
([nil nil ((67658 . 67663) (#(" " 0 1 (fontified nil)) . 67657) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (67658 . 67659)) nil (27000 63509 586117 0) 0 nil])
([nil current ((#("       " 0 7 (fontified t)) . -67920) (#("       " 0 7 (fontified t)) . -67841) (#("       " 0 7 (fontified t)) . -67779) (#("       " 0 7 (fontified t)) . -67704) 66908) nil (27000 63509 586094 0) 0 nil])
nil
