(undo-tree-save-format-version . 1)
"487a57cd0138d731f994fc7e3ea8d57a35655629"
[nil nil nil nil (26790 8105 954414 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 531 . 532) (nil fontified nil 1 . 532) (1 . 532) (t . -1)) nil (26790 8105 954413 0) 0 nil])
([nil nil ((530 . 537) (506 . 511) (478 . 480) 413) nil (26790 8105 954412 0) 0 nil])
([nil nil ((414 . 416) (331 . 334) (286 . 288) 251) nil (26790 8105 954412 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -249) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 250) nil (26790 8105 954411 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -416) (undo-tree-id6 . -1) 417) nil (26790 8105 954407 0) 0 nil])
([nil nil ((345 . 348) (#(" " 0 1 (fontified nil)) . 344) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (345 . 346)) nil (26790 8105 954405 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -415) (undo-tree-id3 . -3) 418) nil (26790 8105 954403 0) 0 nil])
([nil nil ((17 . 18)) nil (26790 8105 954402 0) 0 nil])
([nil nil ((146 . 151) (77 . 82) 19) nil (26790 8105 954402 0) 0 nil])
([nil nil ((196 . 197)) nil (26790 8105 954401 0) 0 nil])
([nil nil ((54 . 56) (#(" " 0 1 (fontified nil)) . 53) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (54 . 55)) nil (26790 8105 954400 0) 0 nil])
([nil nil ((#("	    " 0 1 (fontified nil) 1 5 (fontified nil)) . -147) (147 . 148) (#("	" 0 1 (fontified nil)) . 147) (145 . 147) (#("	    " 0 1 (fontified nil) 1 5 (fontified nil)) . -81) (81 . 82) (#("	" 0 1 (fontified nil)) . 81) (79 . 81) 19) nil (26790 8105 954397 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -229) (undo-tree-id0 . -1) 230) nil (26790 8105 954395 0) 0 nil])
([nil nil ((558 . 559)) nil (26790 8105 954376 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -558) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 559 (t 26790 8105 0 0)) nil (26790 8894 681189 0) 0 nil])
([nil nil ((264 . 267)) nil (26790 8894 681174 0) 0 nil])
([nil nil ((561 . 562)) nil (26790 8894 681170 0) 0 nil])
([nil nil ((426 . 428) (t 26790 8894 0 0)) nil (26790 30997 455225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 686 . 687) (nil fontified nil 428 . 687) (428 . 687)) nil (26790 30997 455224 0) 0 nil])
([nil nil ((435 . 438)) nil (26790 30997 455223 0) 0 nil])
([nil nil ((#("
(defun my-compose (&rest middlewares)
  (reduce (lambda (acc mw) (funcall mw acc))
	  middlewares
	  :initial-value (lambda (req) (declare (ignore req)) (respond-500))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 39 (fontified t) 39 50 (fontified t) 50 56 (face font-lock-keyword-face fontified t) 56 99 (fontified t) 99 102 (fontified t) 102 116 (face font-lock-builtin-face fontified t) 116 118 (fontified t) 118 124 (face font-lock-keyword-face fontified t) 124 132 (fontified t) 132 139 (face font-lock-keyword-face fontified t) 139 170 (fontified t)) . 256) (undo-tree-id2 . -170)) nil (26790 30997 455222 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 256)) nil (26790 30997 455205 0) 0 nil])
([nil nil ((519 . 521) (t 26790 30997 0 0)) nil (26791 6639 874942 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 888 . 889) (nil fontified nil 521 . 889) (521 . 889)) nil (26791 6639 874937 0) 0 nil])
([nil nil ((143 . 144) (t 26791 6639 0 0)) nil (26792 22517 814708 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 155 . 156) (nil fontified nil 144 . 156) (144 . 156)) nil (26792 22517 814707 0) 0 nil])
([nil nil ((#("5" 0 1 (face font-lock-builtin-face fontified t)) . 153)) nil (26792 22517 814704 0) 0 nil])
([nil nil ((153 . 154)) nil (26792 22517 814699 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -155) (undo-tree-id0 . -1) 156 (t 26792 22517 0 0)) nil (26792 22521 943730 0) 0 nil])
([nil nil ((155 . 156)) nil (26792 22521 943694 0) 0 nil])
([nil nil ((1038 . 1039) (t 26792 22521 0 0)) nil (26793 38724 176704 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3178 . 3179) (nil fontified nil 1039 . 3179) (1039 . 3179)) nil (26793 38724 176702 0) 0 nil])
([nil nil ((#("(defparameter *debug* nil)  ;; active les prints si T" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 21 (face font-lock-variable-name-face fontified t) 21 28 (fontified t) 28 31 (face font-lock-comment-delimiter-face fontified t) 31 53 (face font-lock-comment-face fontified t)) . 1039)) nil (26793 38724 176701 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1037) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (#("
" 0 1 (fontified t)) . -1038) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 1039) nil (26793 38724 176700 0) 0 nil])
([nil nil ((268 . 269)) nil (26793 38724 176694 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 321 . 322) (nil fontified nil 300 . 322) (nil fontified nil 297 . 300) (nil fontified nil 290 . 297) (nil fontified nil 283 . 290) (nil fontified nil 282 . 283) (nil fontified nil 270 . 282) (nil fontified nil 269 . 270) (269 . 322)) nil (26793 38724 176692 0) 0 nil])
([nil nil ((3178 . 3179)) nil (26793 38724 176690 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4349 . 4350) (nil fontified nil 3179 . 4350) (3179 . 4350)) nil (26793 38724 176689 0) 0 nil])
([nil nil ((322 . 324)) nil (26793 38724 176688 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 419 . 420) (nil fontified nil 324 . 420) (324 . 420)) nil (26793 38724 176687 0) 0 nil])
([nil nil ((#("

(defun my-compose (&rest middlewares)
  (reduce (lambda (next mw) (funcall mw next))
          (reverse middlewares)
          :initial-value (lambda (req)
                           (declare (ignore req))
                           (respond-404 \"No handler\"))))" 0 1 (fontified t) 1 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 19 (face font-lock-function-name-face fontified t) 19 21 (fontified t) 21 26 (face font-lock-type-face fontified t) 26 51 (fontified t) 51 57 (face font-lock-keyword-face fontified t) 57 129 (fontified t) 129 143 (face font-lock-builtin-face fontified t) 143 145 (fontified t) 145 151 (face font-lock-keyword-face fontified t) 151 186 (fontified t) 186 193 (face font-lock-keyword-face fontified t) 193 248 (fontified t) 248 260 (face font-lock-string-face fontified t) 260 264 (fontified t)) . 420) (undo-tree-id0 . -264)) nil (26793 38724 176685 0) 0 nil])
([nil nil ((189 . 192)) nil (26793 38724 176666 0) 0 nil])
([nil nil ((206 . 207)) nil (26793 38724 176665 0) 0 nil])
([nil nil ((207 . 214)) nil (26793 38724 176665 0) 0 nil])
([nil nil ((214 . 215)) nil (26793 38724 176664 0) 0 nil])
([nil nil ((215 . 225)) nil (26793 38724 176663 0) 0 nil])
([nil nil ((225 . 226)) nil (26793 38724 176663 0) 0 nil])
([nil nil ((226 . 227)) nil (26793 38724 176662 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 238 . 239) (nil fontified nil 227 . 239) (227 . 239)) nil (26793 38724 176661 0) 0 nil])
([nil nil ((239 . 244)) nil (26793 38724 176659 0) 0 nil])
([nil nil ((244 . 251)) nil (26793 38724 176659 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 271 . 272) (nil fontified nil 244 . 272) (244 . 272)) nil (26793 38724 176657 0) 0 nil])
([nil nil ((272 . 273)) nil (26793 38724 176650 0) 0 nil])
([nil nil ((280 . 281) (t 26793 38724 0 0)) nil (26793 38822 412375 0) 0 nil])
([nil nil ((2918 . 2921) (t 26793 38822 0 0)) nil (26794 5030 879715 0) 0 nil])
([nil nil ((2921 . 2926)) nil (26794 5030 879714 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -2925) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 2926) nil (26794 5030 879713 0) 0 nil])
([nil nil ((2925 . 2927)) nil (26794 5030 879696 0) 0 nil])
([nil nil ((2927 . 2928)) nil (26794 5030 879696 0) 0 nil])
([nil nil ((2928 . 2931)) nil (26794 5030 879695 0) 0 nil])
([nil nil ((2931 . 2932)) nil (26794 5030 879695 0) 0 nil])
([nil nil ((2932 . 2937)) nil (26794 5030 879694 0) 0 nil])
([nil nil ((2937 . 2938)) nil (26794 5030 879694 0) 0 nil])
([nil nil ((2938 . 2941)) nil (26794 5030 879693 0) 0 nil])
([nil nil ((2941 . 2946)) nil (26794 5030 879689 0) 0 nil])
([nil nil ((2921 . 2922) (t 26794 5030 0 0)) nil (26794 5103 592251 0) 0 nil])
([nil nil ((#("k" 0 1 (fontified t)) . -2921) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) 2922) nil (26794 5103 592250 0) 0 nil])
([nil nil ((#("(print \"IN QUERY PARSER\")" 0 7 (fontified t) 7 24 (face font-lock-string-face fontified t) 24 25 (fontified t)) . 2921) (undo-tree-id10 . -25) (undo-tree-id11 . -25) (undo-tree-id12 . -25) (undo-tree-id13 . -25) (undo-tree-id14 . -25) (undo-tree-id15 . -25) (undo-tree-id16 . -25) (undo-tree-id17 . -25) (undo-tree-id18 . -25) (undo-tree-id19 . -25) (undo-tree-id20 . -25)) nil (26794 5103 592243 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 2918) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1)) nil (26794 5103 592236 0) 0 nil])
([nil nil ((2966 . 2971)) nil (26794 5103 592226 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2995 . 2996) (nil fontified nil 2995 . 2996) (nil fontified nil 2978 . 2995) (nil fontified nil 2971 . 2978) (2971 . 2996)) nil (26794 5103 592222 0) 0 nil])
([nil nil ((#("
    (print \"IN QUERY PARSER\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 29 (face font-lock-string-face fontified t) 29 30 (rear-nonsticky t fontified t)) . 2966) (undo-tree-id30 . -30) (undo-tree-id31 . -30) (undo-tree-id32 . -5) (undo-tree-id33 . -30) (undo-tree-id34 . -30) (undo-tree-id35 . -30) (undo-tree-id36 . -30) (undo-tree-id37 . -30) (undo-tree-id38 . -30) (undo-tree-id39 . -30) (undo-tree-id40 . -30) (undo-tree-id41 . -30) (undo-tree-id42 . -30) (undo-tree-id43 . -30) (undo-tree-id44 . -30) (undo-tree-id45 . -30) (undo-tree-id46 . -30) (undo-tree-id47 . -5) (undo-tree-id48 . -30) (t 26794 5103 0 0)) nil (26794 5133 928544 0) 0 nil])
([nil nil ((2966 . 2971) (t 26794 5133 0 0)) nil (26794 5165 613683 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2995 . 2996) (nil fontified nil 2995 . 2996) (nil fontified nil 2978 . 2995) (nil fontified nil 2971 . 2978) (2971 . 2996)) nil (26794 5165 613679 0) 0 nil])
([nil nil ((#("
    (print \"IN QUERY PARSER\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 29 (face font-lock-string-face fontified t) 29 30 (rear-nonsticky t fontified t)) . 2966) (undo-tree-id49 . -30) (undo-tree-id50 . -30) (undo-tree-id51 . -5) (undo-tree-id52 . -1) (undo-tree-id53 . -30) (undo-tree-id54 . -30) (undo-tree-id55 . -30) (undo-tree-id56 . -30) (undo-tree-id57 . -30) (undo-tree-id58 . -30) (undo-tree-id59 . -30) (undo-tree-id60 . -30) (undo-tree-id61 . -30) (undo-tree-id62 . -30) (undo-tree-id63 . -30) (undo-tree-id64 . -30) (undo-tree-id65 . -30) (undo-tree-id66 . -30) (undo-tree-id67 . -30) (undo-tree-id68 . -30) (undo-tree-id69 . -30) (undo-tree-id70 . -30) (undo-tree-id71 . -5) (undo-tree-id72 . -30) (t 26794 5165 0 0)) nil (26794 5192 322012 0) 0 nil])
([nil nil ((2919 . 2921) (#("  " 0 2 (face font-lock-comment-face fontified nil)) . 2918) (undo-tree-id73 . -1) (undo-tree-id74 . -2) (undo-tree-id75 . -2) (undo-tree-id76 . -2) (undo-tree-id77 . -2) (undo-tree-id78 . -2) (undo-tree-id79 . -2) (undo-tree-id80 . -2) (undo-tree-id81 . -2) (2920 . 2921) (t 26794 5192 0 0)) nil (26794 7894 145291 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3028 . 3029) (nil fontified nil 2921 . 3029) (2921 . 3029)) nil (26794 7894 145278 0) 0 nil])
([nil nil ((3175 . 3180)) nil (26794 7894 145277 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3287 . 3288) (nil fontified nil 3180 . 3288) (3180 . 3288)) nil (26794 7894 145274 0) 0 nil])
([nil nil ((#("nil" 0 3 (fontified t)) . -369) (undo-tree-id82 . -3) (undo-tree-id83 . -2) (undo-tree-id84 . -2) (undo-tree-id85 . -2) (undo-tree-id86 . -2) (undo-tree-id87 . -2) (undo-tree-id88 . -3) (undo-tree-id89 . -3) (undo-tree-id90 . -3) (undo-tree-id91 . -3) 372 (t 26794 7894 0 0)) nil (26794 9793 728525 0) 0 nil])
([nil nil ((369 . 370)) nil (26794 9793 728507 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -369) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) 370 (t 26794 9793 0 0)) nil (26794 9926 995500 0) 0 nil])
([nil nil ((369 . 372)) nil (26794 9926 995481 0) 0 nil])
([nil nil ((156 . 157) (t 26794 9926 0 0)) nil (26794 10550 189171 0) 0 nil])
([nil nil ((157 . 166)) nil (26794 10550 189170 0) 0 nil])
([nil nil ((157 . 158)) nil (26794 10550 189166 0) 0 nil])
([nil nil ((411 . 413) (t 26794 10550 0 0)) nil (26794 11341 457871 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 561 . 562) (nil fontified nil 413 . 562) (413 . 562)) nil (26794 11341 457871 0) 0 nil])
([nil nil ((292 . 293)) nil (26794 11341 457870 0) 0 nil])
([nil nil ((293 . 294)) nil (26794 11341 457868 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 301 . 302) (nil fontified nil 294 . 302) (294 . 302)) nil (26794 11341 457865 0) 0 nil])
([nil nil ((502 . 504) (t 26794 11341 0 0)) nil (26794 11926 106694 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 795 . 796) (nil fontified nil 504 . 796) (504 . 796)) nil (26794 11926 106694 0) 0 nil])
([nil nil ((#("
(defvar *app* (lambda (req) (declare (ignore req)) (respond-404 \"No handler\")))" 0 1 (fontified t) 1 2 (fontified t) 2 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 14 (face font-lock-variable-name-face fontified t) 14 16 (fontified t) 16 22 (face font-lock-keyword-face fontified t) 22 30 (fontified t) 30 37 (face font-lock-keyword-face fontified t) 37 65 (fontified t) 65 77 (face font-lock-string-face fontified t) 77 80 (fontified t)) . 422) (undo-tree-id107 . -80)) nil (26794 11926 106693 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -421) (undo-tree-id105 . -1) (undo-tree-id106 . -1) 422) nil (26794 11926 106691 0) 0 nil])
([nil nil ((785 . 787)) nil (26794 11926 106689 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1258 . 1259) (nil fontified nil 787 . 1259) (787 . 1259)) nil (26794 11926 106689 0) 0 nil])
([nil nil ((#("
(defun set-app! (&rest mws)
  (setf *app* (apply #'my-compose mws)))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 29 (fontified t) 29 68 (fontified t) 68 69 (fontified t rear-nonsticky t) 69 70 (fontified t)) . 716) (undo-tree-id104 . -70)) nil (26794 11926 106688 0) 0 nil])
([nil nil ((302 . 303)) nil (26794 11926 106686 0) 0 nil])
([nil nil ((303 . 304)) nil (26794 11926 106685 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 323 . 324) (nil fontified nil 304 . 324) (304 . 324)) nil (26794 11926 106684 0) 0 nil])
([nil nil ((#("(defparameter *app* nil)
" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 19 (face font-lock-variable-name-face fontified t) 19 25 (fontified t)) . -365) (undo-tree-id103 . -25) 390) nil (26794 11926 106681 0) 0 nil])
([nil nil ((1020 . 1024) (t 26794 11926 0 0)) nil (26794 12119 874659 0) 0 nil])
([nil nil ((#("i" 0 1 (fontified t)) . -1023) (undo-tree-id109 . -1) 1024) nil (26794 12119 874658 0) 0 nil])
([nil nil ((1023 . 1026)) nil (26794 12119 874656 0) 0 nil])
([nil nil ((1026 . 1027)) nil (26794 12119 874656 0) 0 nil])
([nil nil ((1073 . 1074)) nil (26794 12119 874655 0) 0 nil])
([nil nil ((1027 . 1038) (#(" " 0 1 (fontified nil)) . 1026) (undo-tree-id108 . -1) (1027 . 1028)) nil (26794 12119 874655 0) 0 nil])
([nil nil ((1026 . 1038)) nil (26794 12119 874643 0) 0 nil])
([nil nil ((1038 . 1044)) nil (26794 12119 874642 0) 0 nil])
([nil nil ((1044 . 1045)) nil (26794 12119 874642 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1075 . 1076) (nil fontified nil 1045 . 1076) (1045 . 1076)) nil (26794 12119 874641 0) 0 nil])
([nil nil ((1076 . 1077)) nil (26794 12119 874641 0) 0 nil])
([nil nil ((1077 . 1089)) nil (26794 12119 874640 0) 0 nil])
([nil nil ((1089 . 1095)) nil (26794 12119 874640 0) 0 nil])
([nil nil ((1095 . 1096)) nil (26794 12119 874639 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1140 . 1141) (nil fontified nil 1096 . 1141) (1096 . 1141)) nil (26794 12119 874638 0) 0 nil])
([nil nil ((1141 . 1142)) nil (26794 12119 874634 0) 0 nil])
([nil nil ((712 . 714) (t 26794 12119 0 0)) nil (26794 12528 162094 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1161 . 1162) (nil fontified nil 714 . 1162) (714 . 1162)) nil (26794 12528 162093 0) 0 nil])
([nil nil ((1771 . 1773)) nil (26794 12528 162092 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2112 . 2113) (nil fontified nil 1773 . 2113) (1773 . 2113)) nil (26794 12528 162092 0) 0 nil])
([nil nil ((#("
(defun set-app! (&rest middlewares)
  \"Compose les MIDDLEWARES et installe la nouvelle pile dans *app*.\"
  (setf *app* (apply #'my-compose middlewares)
        *pipeline-signature* (mapcar (lambda (mw)
                                       (etypecase mw
                                         (function (progn
						     (print (function-lambda-expression mw))
						     (print (symbol-name (function-lambda-expression mw)))
						     (symbol-name (function-lambda-expression mw))))
                                         (t (princ-to-string mw))))
                                     middlewares)))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 39 (fontified t) 39 105 (face font-lock-doc-face fontified t) 105 191 (fontified t) 191 197 (face font-lock-keyword-face fontified t) 197 243 (fontified t) 243 252 (face font-lock-keyword-face fontified t) 252 256 (fontified t) 256 308 (fontified t) 308 313 (face font-lock-keyword-face fontified t) 313 314 (fontified t) 314 332 (fontified t) 332 362 (fontified t) 362 363 (fontified t rear-nonsticky t) 363 365 (fontified t) 365 383 (fontified t) 383 427 (fontified t) 427 428 (fontified t rear-nonsticky t) 428 429 (fontified t) 429 430 (fontified t) 430 441 (fontified t) 441 489 (fontified t) 489 557 (fontified t) 557 607 (fontified t) 607 608 (fontified t rear-nonsticky t) 608 609 (fontified t)) . 1163) (undo-tree-id110 . -609) (undo-tree-id111 . -429)) nil (26794 12528 162090 0) 0 nil])
([nil nil ((324 . 325)) nil (26794 12528 162079 0) 0 nil])
([nil nil ((325 . 331)) nil (26794 12528 162075 0) 0 nil])
([nil nil ((1169 . 1171) (t 26794 12528 0 0)) nil (26794 12695 395328 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1242 . 1243) (nil fontified nil 1171 . 1243) (1171 . 1243)) nil (26794 12695 395327 0) 0 nil])
([nil nil ((331 . 332)) nil (26794 12695 395326 0) 0 nil])
([nil nil ((332 . 333)) nil (26794 12695 395325 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 336 . 337) (nil fontified nil 333 . 337) (333 . 337)) nil (26794 12695 395322 0) 0 nil])
([nil nil ((5677 . 5678) (t 26794 12695 0 0)) nil (26794 17052 156586 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8270 . 8271) (nil fontified nil 5678 . 8271) (5678 . 8271)) nil (26794 17052 156585 0) 0 nil])
([nil nil ((5676 . 5678)) nil (26794 17052 156584 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8658 . 8659) (nil fontified nil 5678 . 8659) (5678 . 8659)) nil (26794 17052 156584 0) 0 nil])
([nil nil ((168 . 171)) nil (26794 17052 156583 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 172 . 173) (nil fontified nil 171 . 173) (171 . 173)) nil (26794 17052 156583 0) 0 nil])
([nil nil ((173 . 174)) nil (26794 17052 156582 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 175 . 176) (nil fontified nil 174 . 176) (174 . 176)) nil (26794 17052 156581 0) 0 nil])
([nil nil ((nil fontified nil 176 . 177) (176 . 177)) nil (26794 17052 156581 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 195 . 196) (nil fontified nil 185 . 196) (nil fontified nil 184 . 185) (nil fontified nil 172 . 184) (nil fontified nil 171 . 172) (171 . 196)) nil (26794 17052 156580 0) 0 nil])
([nil nil ((196 . 197)) nil (26794 17052 156579 0) 0 nil])
([nil nil ((197 . 198)) nil (26794 17052 156578 0) 0 nil])
([nil nil ((201 . 202)) nil (26794 17052 156578 0) 0 nil])
([nil nil ((#("core" 0 3 (face font-lock-builtin-face fontified t) 3 4 (face font-lock-builtin-face rear-nonsticky t fontified t)) . 192)) nil (26794 17052 156577 0) 0 nil])
([nil nil ((192 . 197)) nil (26794 17052 156576 0) 0 nil])
([nil nil ((206 . 207)) nil (26794 17052 156575 0) 0 nil])
([nil nil ((11293 . 11294) 942) nil (26794 17052 156572 0) 0 nil])
([nil nil ((9472 . 9474) (t 26794 17052 0 0)) nil (26795 1355 891480 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16025 . 16026) (nil fontified nil 9474 . 16026) (9474 . 16026)) nil (26795 1355 891480 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t rear-nonsticky t)) . -16025) (undo-tree-id194 . -1) 16026) nil (26795 1355 891479 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11870 . 11871) (nil fontified nil 11870 . 11871) (11870 . 11871)) nil (26795 1355 891478 0) 0 nil])
([nil nil ((#("ðŸ“" 0 1 (face font-lock-string-face fontified t)) . -11868) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -11869) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (#("ðŸ“" 0 1 (face font-lock-string-face rear-nonsticky t fontified t)) . -11870) (undo-tree-id193 . -1) 11871) nil (26795 1355 891477 0) 0 nil])
([nil nil ((#("ðŸ“„" 0 1 (face font-lock-string-face fontified t)) . -12093) (undo-tree-id187 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -12094) (undo-tree-id188 . -1) 12095) nil (26795 1355 891474 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -16018) (undo-tree-id184 . -1) (#(")" 0 1 (fontified t)) . -16019) (undo-tree-id185 . -1) (#(")" 0 1 (fontified t)) . -16020) (undo-tree-id186 . -1) 16021) nil (26795 1355 891472 0) 0 nil])
([nil nil ((#("          " 0 10 (fontified t)) . -15831) (#("   " 0 3 (fontified t)) . -15780) (#("        " 0 8 (fontified t)) . -15753) (#("        " 0 8 (fontified t)) . -15719) (#("        " 0 8 (fontified t)) . -15690) (#("                     " 0 21 (fontified t)) . -15661) (#("      " 0 6 (fontified t)) . -15594) (#("      " 0 6 (fontified t)) . -15480) (#("      " 0 6 (fontified t)) . -15434) (#("      " 0 6 (fontified t)) . -15359) (#("      " 0 6 (fontified t)) . -15300) (#("      " 0 6 (fontified t)) . -15262) (#("      " 0 6 (fontified t)) . -15233) (#("    " 0 4 (fontified t)) . -15156) (#("    " 0 4 (fontified t)) . -15129) (#("                 " 0 7 (fontified t) 7 17 (fontified t)) . -15092) (#("  " 0 2 (fontified t)) . -14998) (#("  " 0 2 (fontified t)) . -14943) (#("  " 0 2 (fontified t)) . -14859) (#("  " 0 2 (fontified t)) . -14792) (#("  " 0 2 (fontified t)) . -14656) (#("  " 0 2 (fontified t)) . -14618) (#("  " 0 2 (fontified t)) . -14575) (#("               " 0 15 (fontified t)) . -14535) (12938 . 12939) (#("              " 0 14 (fontified t)) . 12938) 12161) nil (26795 1355 891466 0) 0 nil])
([nil nil ((364 . 368) (#(" " 0 1 (fontified nil)) . 363) (undo-tree-id183 . -1) (364 . 365)) nil (26795 1355 891464 0) 0 nil])
([nil nil ((380 . 381)) nil (26795 1355 891463 0) 0 nil])
([nil nil ((381 . 388)) nil (26795 1355 891462 0) 0 nil])
([nil nil ((388 . 389)) nil (26795 1355 891462 0) 0 nil])
([nil nil ((389 . 394)) nil (26795 1355 891461 0) 0 nil])
([nil nil ((#("
(defun static (&key prefix dir)
  \"Servez les fichiers de DIR quand PATH commence par PREFIX.\"
  (let* ((prefix* (if (and prefix (plusp (length prefix))) prefix \"/\"))
         (dir*    (truename dir)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (and (>= (length path) (length prefix*))
                   (string= prefix* path :end2 (length prefix*)))
              (let* ((rel (subseq path (length prefix*)))
                     ;; sÃ©curiser : pas de .., pas de backslashes
                     (clean (if (search \"..\" rel) \"\" rel))
                     (pn (merge-pathnames clean dir*)))
                (handler-case
                    (if (and (probe-file pn)
                             (not (sb-posix:stat-mode-ifdir (sb-posix:stat pn)))) ; optionnel SBCL: refuser dossiers
                        (let* ((bytes (read-file-bytes pn))
                               (resp  (make-instance 'lumen.core.http:response
                                                     :status 200
                                                     :headers (list (cons \"content-type\" (guess-content-type pn))
                                                                    (cons \"cache-control\" \"public, max-age=3600\"))
                                                     :body (trivial-utf-8:utf-8-bytes-to-string bytes))))
                          ;; NB: ton write-response attend une string; si tu veux pousser des octets,
                          ;; fais Ã©voluer response pour accepter un (vector (unsigned-byte 8)).
                          resp)
                        (lumen.core.http:respond-404 \"File not found\"))
                  (error ()
                    (lumen.core.http:respond-404 \"File error\"))))
              (funcall next req)))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (fontified t) 16 20 (face font-lock-type-face fontified t) 20 35 (fontified t) 35 95 (face font-lock-doc-face fontified t) 95 99 (fontified t) 99 103 (face font-lock-keyword-face fontified t) 103 115 (fontified t) 115 117 (face font-lock-keyword-face fontified t) 117 162 (fontified t) 162 165 (face font-lock-string-face fontified t) 165 208 (fontified t) 208 214 (face font-lock-keyword-face fontified t) 214 229 (fontified t) 229 235 (face font-lock-keyword-face fontified t) 235 251 (fontified t) 251 254 (face font-lock-keyword-face fontified t) 254 306 (fontified t) 306 308 (face font-lock-keyword-face fontified t) 308 391 (fontified t) 391 396 (face font-lock-builtin-face fontified t) 396 431 (fontified t) 431 435 (face font-lock-keyword-face fontified t) 435 472 (fontified t) 472 474 (fontified t) 474 495 (fontified t) 495 498 (face font-lock-comment-delimiter-face fontified t) 498 540 (face font-lock-comment-face fontified t) 540 569 (fontified t) 569 571 (face font-lock-keyword-face fontified t) 571 580 (fontified t) 580 584 (face font-lock-string-face fontified t) 584 590 (fontified t) 590 592 (face font-lock-string-face fontified t) 592 643 (fontified t) 643 655 (fontified t) 655 672 (fontified t) 672 684 (face font-lock-keyword-face fontified t) 684 706 (fontified t) 706 708 (face font-lock-keyword-face fontified t) 708 726 (fontified t) 726 727 (fontified t) 727 730 (fontified t) 730 812 (fontified t) 812 847 (face font-lock-comment-face fontified t) 847 872 (fontified t) 872 876 (face font-lock-keyword-face fontified t) 876 1039 (fontified t) 1039 1046 (face font-lock-builtin-face fontified t) 1046 1104 (fontified t) 1104 1112 (face font-lock-builtin-face fontified t) 1112 1125 (fontified t) 1125 1139 (face font-lock-string-face fontified t) 1139 1239 (fontified t) 1239 1254 (face font-lock-string-face fontified t) 1254 1255 (fontified t) 1255 1277 (face font-lock-string-face fontified t) 1277 1324 (fontified t) 1324 1333 (fontified t) 1333 1338 (face font-lock-builtin-face fontified t) 1338 1386 (fontified t) 1386 1388 (fontified t) 1388 1412 (fontified t) 1412 1415 (face font-lock-comment-delimiter-face fontified t) 1415 1463 (face font-lock-comment-face fontified t) 1463 1488 (face font-lock-comment-face fontified t) 1488 1498 (fontified t) 1498 1500 (fontified t) 1500 1514 (fontified t) 1514 1517 (face font-lock-comment-delimiter-face fontified t) 1517 1584 (face font-lock-comment-face fontified t) 1584 1669 (fontified t) 1669 1685 (face font-lock-string-face fontified t) 1685 1707 (fontified t) 1707 1712 (face font-lock-warning-face fontified t) 1712 1765 (fontified t) 1765 1777 (face font-lock-string-face fontified t) 1777 1782 (fontified t) 1782 1819 (fontified t) 1819 1820 (fontified t rear-nonsticky t) 1820 1821 (fontified t)) . -15870) (undo-tree-id153 . -369) (undo-tree-id154 . -814) (undo-tree-id155 . -1821) (undo-tree-id156 . -1) (undo-tree-id157 . -1386) (undo-tree-id158 . -655) (undo-tree-id159 . -655) (undo-tree-id160 . -655) (undo-tree-id161 . -655) (undo-tree-id162 . -655) (undo-tree-id163 . -655) (undo-tree-id164 . -655) (undo-tree-id165 . -655) (undo-tree-id166 . -599) (undo-tree-id167 . -168) (undo-tree-id168 . -898) (undo-tree-id169 . -1821) (undo-tree-id170 . -1821) (undo-tree-id171 . -1821) (undo-tree-id172 . -1821) (undo-tree-id173 . -1821) (undo-tree-id174 . -1821) (undo-tree-id175 . -1821) (undo-tree-id176 . -1821) (undo-tree-id177 . -1821) (undo-tree-id178 . -1821) (undo-tree-id179 . -1821) (undo-tree-id180 . -1821) (undo-tree-id181 . -1821) (undo-tree-id182 . -1821) 17691) nil (26795 1355 891460 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -15869) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) (undo-tree-id150 . -1) (undo-tree-id151 . -1) (undo-tree-id152 . -1) 15870) nil (26795 1355 891444 0) 0 nil])
([nil nil ((15869 . 15870) 15300) nil (26795 1355 891409 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -14566) (undo-tree-id209 . -1) 14567 (t 26795 1355 0 0)) nil (26795 1768 112939 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15121) (undo-tree-id208 . -1) 15122) nil (26795 1768 112938 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15690) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) (undo-tree-id207 . -1) 15691) nil (26795 1768 112936 0) 0 nil])
([nil nil ((15866 . 15867)) nil (26795 1768 112919 0) 0 nil])
([nil nil ((15867 . 15869)) nil (26795 1768 112918 0) 0 nil])
([nil nil ((15766 . 15769) (#("    " 0 4 (fontified t)) . 15766) (15716 . 15719) (15685 . 15689) (#("          " 0 10 (fontified t)) . 15685) (15653 . 15661) (#("              " 0 14 (fontified t)) . 15653) (15630 . 15638) (#("              " 0 14 (fontified t)) . 15630) (15612 . 15616) (#("                   " 0 19 (fontified t)) . 15612) (15558 . 15564) (15439 . 15444) (#("                                  " 0 34 (fontified t)) . 15439) (15422 . 15427) (#("                                  " 0 34 (fontified t)) . 15422) (15377 . 15381) (#("                   " 0 19 (fontified t)) . 15377) (15331 . 15337) (15287 . 15293) (15252 . 15258) (15171 . 15175) (15138 . 15144) (#("                       " 0 23 (fontified t)) . 15138) (15123 . 15125) (15027 . 15029) (14970 . 14972) (14884 . 14886) (14815 . 14817) (14677 . 14679) (14637 . 14639) (14592 . 14594) 12179) nil (26795 1768 112913 0) 0 nil])
([nil nil ((12742 . 12744) (t 26795 1768 0 0)) nil (26795 3561 91837 0) 0 nil])
([nil nil ((12744 . 12750)) nil (26795 3561 91836 0) 0 nil])
([nil nil ((12750 . 12751)) nil (26795 3561 91836 0) 0 nil])
([nil nil ((12751 . 12754)) nil (26795 3561 91836 0) 0 nil])
([nil nil ((12754 . 12755)) nil (26795 3561 91835 0) 0 nil])
([nil nil ((12755 . 12763)) nil (26795 3561 91830 0) 0 nil])
([nil nil ((12816 . 12820) (t 26795 3561 0 0)) nil (26795 3836 444419 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12838 . 12839) (nil fontified nil 12838 . 12839) (nil fontified nil 12827 . 12838) (nil fontified nil 12820 . 12827) (12820 . 12839)) nil (26795 3836 444419 0) 0 nil])
([nil nil ((#("\"IN STATIC\"" 0 11 (face font-lock-string-face fontified t)) . -12827) (undo-tree-id218 . -11) 12838) nil (26795 3836 444418 0) 0 nil])
([nil nil ((12827 . 12831)) nil (26795 3836 444417 0) 0 nil])
([nil nil ((12832 . 12836)) nil (26795 3836 444417 0) 0 nil])
([nil nil ((nil fontified nil 12847 . 12848) (nil fontified nil 12836 . 12847) (12836 . 12848)) nil (26795 3836 444416 0) 0 nil])
([nil nil ((#("path" 0 4 (fontified t)) . -12843) (undo-tree-id217 . -4) 12847) nil (26795 3836 444416 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12852 . 12853) (nil fontified nil 12843 . 12853) (12843 . 12853)) nil (26795 3836 444415 0) 0 nil])
([nil nil ((12832 . 12836)) nil (26795 3836 444414 0) 0 nil])
([nil nil ((nil fontified nil 12847 . 12848) (nil fontified nil 12836 . 12847) (12836 . 12848)) nil (26795 3836 444414 0) 0 nil])
([nil nil ((#("path" 0 4 (fontified t)) . -12843) (undo-tree-id214 . -4) (undo-tree-id215 . -4) (undo-tree-id216 . -4) 12847) nil (26795 3836 444413 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12848 . 12849) (nil fontified nil 12843 . 12849) (12843 . 12849)) nil (26795 3836 444411 0) 0 nil])
([nil nil ((12849 . 12850)) nil (26795 3836 444411 0) 0 nil])
([nil nil ((12982 . 12990)) nil (26795 3836 444410 0) 0 nil])
([nil nil ((nil fontified nil 13007 . 13008) (nil fontified nil 13006 . 13007) (nil fontified nil 12997 . 13006) (nil fontified nil 12990 . 12997) (12990 . 13008)) nil (26795 3836 444410 0) 0 nil])
([nil nil ((#("prefix-len" 0 9 (fontified t) 9 10 (fontified t rear-nonsticky t)) . -12997) (undo-tree-id211 . -10) (undo-tree-id212 . -10) (undo-tree-id213 . -10) 13007) nil (26795 3836 444409 0) 0 nil])
([nil nil ((12997 . 13003)) nil (26795 3836 444406 0) 0 nil])
([nil nil ((#("Ã©" 0 1 (face font-lock-string-face fontified t)) . -13002) (undo-tree-id210 . -1) 13003) nil (26795 3836 444405 0) 0 nil])
([nil nil ((13002 . 13003)) nil (26795 3836 444398 0) 0 nil])
([nil nil ((13136 . 13139)) nil (26795 3836 444398 0) 0 nil])
([nil nil ((nil fontified nil 13152 . 13153) (nil fontified nil 13146 . 13152) (nil fontified nil 13139 . 13146) (13139 . 13153)) nil (26795 3836 444397 0) 0 nil])
([nil nil ((13151 . 13152)) nil (26795 3836 444396 0) 0 nil])
([nil nil ((13152 . 13153)) nil (26795 3836 444392 0) 0 nil])
([nil nil ((#("prefix" 0 5 (fontified t) 5 6 (rear-nonsticky t fontified t)) . -12843) (undo-tree-id226 . -6) 12849 (t 26795 3836 0 0)) nil (26795 4013 598702 0) 0 nil])
([nil nil ((12843 . 12847)) nil (26795 4013 598701 0) 0 nil])
([nil nil ((10580 . 10585)) nil (26795 4013 598700 0) 0 nil])
([nil nil ((10585 . 10591)) nil (26795 4013 598700 0) 0 nil])
([nil nil ((10591 . 10592)) nil (26795 4013 598700 0) 0 nil])
([nil nil ((10592 . 10597)) nil (26795 4013 598699 0) 0 nil])
([nil nil ((10597 . 10598)) nil (26795 4013 598699 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-string-face fontified t)) . -10594) (undo-tree-id222 . -1) (#("F" 0 1 (face font-lock-string-face fontified t)) . -10595) (undo-tree-id223 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -10596) (undo-tree-id224 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -10597) (undo-tree-id225 . -1) 10598) nil (26795 4013 598698 0) 0 nil])
([nil nil ((10594 . 10597)) nil (26795 4013 598695 0) 0 nil])
([nil nil ((10597 . 10598)) nil (26795 4013 598695 0) 0 nil])
([nil nil ((10598 . 10602)) nil (26795 4013 598694 0) 0 nil])
([nil nil ((10602 . 10603)) nil (26795 4013 598694 0) 0 nil])
([nil nil ((10603 . 10606)) nil (26795 4013 598693 0) 0 nil])
([nil nil ((10781 . 10788)) nil (26795 4013 598693 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10808 . 10809) (nil fontified nil 10808 . 10809) (nil fontified nil 10795 . 10808) (nil fontified nil 10788 . 10795) (10788 . 10809)) nil (26795 4013 598692 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -10806) (undo-tree-id219 . -1) (undo-tree-id220 . -1) (undo-tree-id221 . -1) 10807) nil (26795 4013 598690 0) 0 nil])
([nil nil ((10806 . 10807)) nil (26795 4013 598678 0) 0 nil])
([nil nil ((9607 . 9610) (t 26795 4013 0 0)) nil (26795 4111 432787 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9630 . 9631) (nil fontified nil 9630 . 9631) (nil fontified nil 9617 . 9630) (nil fontified nil 9610 . 9617) (9610 . 9631)) nil (26795 4111 432786 0) 0 nil])
([nil nil ((9618 . 9620)) nil (26795 4111 432786 0) 0 nil])
([nil nil ((9620 . 9621)) nil (26795 4111 432785 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . 9631)) nil (26795 4111 432785 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -9630) (undo-tree-id241 . -1) 9631) nil (26795 4111 432784 0) 0 nil])
([nil nil ((10123 . 10126)) nil (26795 4111 432783 0) 0 nil])
([nil nil ((10126 . 10128)) nil (26795 4111 432783 0) 0 nil])
([nil nil ((10128 . 10129)) nil (26795 4111 432783 0) 0 nil])
([nil nil ((10129 . 10135)) nil (26795 4111 432782 0) 0 nil])
([nil nil ((10135 . 10136)) nil (26795 4111 432782 0) 0 nil])
([nil nil ((10136 . 10140)) nil (26795 4111 432781 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -10139) (undo-tree-id240 . -1) 10140) nil (26795 4111 432781 0) 0 nil])
([nil nil ((10139 . 10142)) nil (26795 4111 432780 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -10141) (undo-tree-id239 . -1) 10142) nil (26795 4111 432779 0) 0 nil])
([nil nil ((10141 . 10142)) nil (26795 4111 432777 0) 0 nil])
([nil nil ((9750 . 9753)) nil (26795 4111 432777 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9768 . 9769) (nil fontified nil 9753 . 9769) (9753 . 9769)) nil (26795 4111 432777 0) 0 nil])
([nil nil ((#("2" 0 1 (fontified t)) . -9766) (undo-tree-id232 . -1) (undo-tree-id233 . -1) (undo-tree-id234 . -1) (undo-tree-id235 . -1) (undo-tree-id236 . -1) (undo-tree-id237 . -1) (undo-tree-id238 . -1) 9767) nil (26795 4111 432776 0) 0 nil])
([nil nil ((9766 . 9767)) nil (26795 4111 432772 0) 0 nil])
([nil nil ((10555 . 10558)) nil (26795 4111 432772 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10573 . 10574) (nil fontified nil 10558 . 10574) (10558 . 10574)) nil (26795 4111 432771 0) 0 nil])
([nil nil ((#("2" 0 1 (fontified t)) . -10571) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -1) 10572) nil (26795 4111 432770 0) 0 nil])
([nil nil ((10571 . 10572)) nil (26795 4163 447584 0) 0 nil])
([nil nil ((13138 . 13146) (t 26795 4111 0 0)) nil (26795 4366 306125 0) 0 nil] [nil nil ((13189 . 13195) (t 26795 4111 0 0)) ((#("
			  " 0 1 (fontified t) 1 6 (fontified t)) . 13189) (undo-tree-id243 . -6) (undo-tree-id244 . -1) (undo-tree-id245 . -1) (undo-tree-id246 . -6) (undo-tree-id247 . -6) (undo-tree-id248 . -6) (undo-tree-id249 . -6)) (26795 4162 758507 0) 0 nil])
([nil nil ((13146 . 13152)) nil (26795 4366 306125 0) 0 nil])
([nil nil ((13195 . 13201)) ((#("(print" 0 6 (fontified t)) . 13195) (undo-tree-id242 . -6)) (26795 4162 758462 0) 0 nil])
([nil nil ((13152 . 13153)) nil (26795 4366 306124 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 13176 . 13177) (nil fontified nil 13153 . 13177) (13153 . 13177)) nil (26795 4366 306124 0) 0 nil])
([nil nil ((13177 . 13178)) nil (26795 4366 306123 0) 0 nil])
([nil nil ((#("(print \"OKKK\")
	      (print (subseq path prefix-len))" 0 7 (fontified t) 7 13 (face font-lock-string-face fontified t) 13 14 (fontified t rear-nonsticky t) 14 15 (fontified t) 15 29 (fontified t) 29 52 (fontified t) 52 53 (rear-nonsticky t fontified t) 53 54 (fontified t)) . 13124) (undo-tree-id253 . -14) (undo-tree-id254 . -54) 13178) nil (26795 4366 306123 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13116)) nil (26795 4366 306121 0) 0 nil])
([nil nil ((13274 . 13277)) nil (26795 4366 306121 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13330 . 13331) (nil fontified nil 13330 . 13331) (nil fontified nil 13329 . 13330) (nil fontified nil 13306 . 13329) (nil fontified nil 13292 . 13306) (nil fontified nil 13291 . 13292) (nil fontified nil 13290 . 13291) (nil fontified nil 13284 . 13290) (nil fontified nil 13277 . 13284) (13277 . 13331)) nil (26795 4366 306120 0) 0 nil])
([nil nil ((#("
		(print \"OKKK\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 16 (face font-lock-string-face fontified t) 16 17 (fontified t rear-nonsticky t)) . 13274) (undo-tree-id252 . -17)) nil (26795 4366 306119 0) 0 nil])
([nil nil ((13274 . 13277)) nil (26795 4366 306118 0) 0 nil])
([nil nil ((nil fontified nil 13292 . 13293) (nil fontified nil 13284 . 13292) (nil fontified nil 13277 . 13284) (13277 . 13293)) nil (26795 4366 306118 0) 0 nil])
([nil nil ((#("\"OKKK 1\"" 0 8 (face font-lock-string-face fontified t)) . -13284) (undo-tree-id251 . -8) 13292) nil (26795 4366 306117 0) 0 nil])
([nil nil ((13284 . 13290)) nil (26795 4366 306115 0) 0 nil])
([nil nil ((13480 . 13490)) nil (26795 4366 306115 0) 0 nil])
([nil nil ((nil fontified nil 13505 . 13506) (nil fontified nil 13497 . 13505) (nil fontified nil 13490 . 13497) (13490 . 13506)) nil (26795 4366 306114 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -13503) (undo-tree-id250 . -1) 13504) nil (26795 4366 306112 0) 0 nil])
([nil nil ((13503 . 13504)) nil (26795 4366 306101 0) 0 nil])
([nil nil ((12313 . 12315) (t 26795 4366 0 0)) nil (26795 5405 680073 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18991 . 18992) (nil fontified nil 12315 . 18992) (12315 . 18992)) nil (26795 5405 680072 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t rear-nonsticky t)) . -18991) (undo-tree-id10 . -1) 18992) nil (26795 5405 680071 0) 0 nil])
([nil nil ((#("

(defun static (&key prefix dir (auto-index t) (try-index \"index.html\") (redirect-dir t))
  \"Servez fichiers ET dossiers.
  - prefix: URL base (ex: \\\"/public\\\")
  - dir   : rÃ©pertoire racine (pathname)
  - auto-index: si T, gÃ©nÃ¨re un index HTML pour les dossiers
  - try-index : nom de fichier dâ€™index Ã  servir si prÃ©sent (NIL pour dÃ©sactiver)
  - redirect-dir: rediriger vers lâ€™URL avec slash si dossier sans slash\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (prefix-len (length prefix*)))
    (lambda (next)
      (lambda (req)
	(print \"IN STATIC\")
        (let ((path (lumen.core.http:req-path req)))
	  (print path)
	  (print root*)
	  (print prefix-len)
          (if (and (>= (length path) prefix-len)
                   (string= prefix* path :end2 prefix-len))	      
              (let* ((rel (subseq path prefix-len)) ; peut Ãªtre \"\" ou \"sub/..\"
                     (target (safe-join root* rel)))
		(print \"OKKK 1\")
		(print target)
	      (print (subseq path prefix-len))
                (handler-case
                    (cond
                      ;; Dossier ?
                      ((uiop:directory-pathname-p target)
		       (print \"OKKK 3\")
                       (let* ((has-trailing-slash (and (> (length path) 0)
                                                       (char= (char path (1- (length path))) #\\/))))
                         (cond
                           ;; Redirection /path â†’ /path/
                           ((and redirect-dir (not has-trailing-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\")))
                                           :body \"\"))
                           ;; index.html ?
                           ((and try-index
                                 (probe-file (merge-pathnames try-index (uiop:ensure-directory-pathname target))))
                            (let* ((pn (merge-pathnames try-index (uiop:ensure-directory-pathname target)))
                                   (bytes (read-file-bytes pn)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" (guess-content-type pn))
                                                            (cons \"cache-control\" \"public, max-age=300\")))
                              :body bytes))
                           ;; listing auto ?
                           (auto-index
                            (let* ((html (directory-index-html (uiop:ensure-directory-pathname target)
                                                               (if (plusp (length path)) path \"/\"))))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")))
                              :body html))
			   (t
                            (lumen.core.http:respond-404 \"Directory index disabled\")))))
                      ;; Fichier ?
                      ((probe-file target)
                       (let ((bytes (read-file-bytes target)))
			 (make-instance 'lumen.core.http:response
					:status 200
					:headers (list (cons \"content-type\" (guess-content-type target))
                                                       (cons \"cache-control\" \"public, max-age=3600\")))
			 :body bytes))
		      ;; Rien trouvÃ©
		      (t (funcall next req)))
		  (error ()
                    (lumen.core.http:respond-404 \"File error\")))))
	  (funcall next req))))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 14 (face font-lock-function-name-face fontified t) 14 15 (face font-lock-function-name-face fontified t) 15 17 (fontified t) 17 21 (face font-lock-type-face fontified t) 21 59 (fontified t) 59 71 (face font-lock-string-face fontified t) 71 93 (fontified t) 93 384 (face font-lock-doc-face fontified t) 384 417 (face font-lock-doc-face fontified t) 417 418 (fontified t) 418 421 (fontified t) 421 425 (face font-lock-keyword-face fontified t) 425 447 (fontified t) 447 450 (face font-lock-string-face fontified t) 450 532 (fontified t) 532 538 (face font-lock-keyword-face fontified t) 538 553 (fontified t) 553 559 (face font-lock-keyword-face fontified t) 559 574 (fontified t) 574 585 (face font-lock-string-face fontified t) 585 596 (fontified t) 596 599 (face font-lock-keyword-face fontified t) 599 706 (fontified t) 706 708 (face font-lock-keyword-face fontified t) 708 785 (fontified t) 785 790 (face font-lock-builtin-face fontified t) 790 826 (fontified t) 826 830 (face font-lock-keyword-face fontified t) 830 863 (fontified t) 863 890 (face font-lock-comment-face fontified t) 890 952 (fontified t) 952 960 (face font-lock-string-face fontified t) 960 1036 (fontified t) 1036 1048 (face font-lock-keyword-face fontified t) 1048 1070 (fontified t) 1070 1074 (face font-lock-keyword-face fontified t) 1074 1097 (fontified t) 1097 1100 (face font-lock-comment-delimiter-face fontified t) 1100 1110 (face font-lock-comment-face fontified t) 1110 1184 (fontified t) 1184 1192 (face font-lock-string-face fontified t) 1192 1218 (fontified t) 1218 1222 (face font-lock-keyword-face fontified t) 1222 1396 (fontified t) 1396 1400 (face font-lock-keyword-face fontified t) 1400 1428 (fontified t) 1428 1431 (face font-lock-comment-delimiter-face fontified t) 1431 1458 (face font-lock-comment-face fontified t) 1458 1501 (fontified t) 1501 1514 (fontified t) 1514 1530 (fontified t) 1530 1642 (fontified t) 1642 1649 (face font-lock-builtin-face fontified t) 1649 1697 (fontified t) 1697 1705 (face font-lock-builtin-face fontified t) 1705 1718 (fontified t) 1718 1728 (face font-lock-string-face fontified t) 1728 1755 (fontified t) 1755 1758 (face font-lock-string-face fontified t) 1758 1805 (fontified t) 1805 1810 (face font-lock-builtin-face fontified t) 1810 1811 (fontified t) 1811 1813 (face font-lock-string-face fontified t) 1813 1843 (fontified t) 1843 1846 (face font-lock-comment-delimiter-face fontified t) 1846 1859 (face font-lock-comment-face fontified t) 1859 1918 (fontified t) 1918 2017 (fontified t) 2017 2046 (fontified t) 2046 2050 (face font-lock-keyword-face fontified t) 2050 2306 (fontified t) 2306 2313 (face font-lock-builtin-face fontified t) 2313 2363 (fontified t) 2363 2371 (face font-lock-builtin-face fontified t) 2371 2384 (fontified t) 2384 2398 (face font-lock-string-face fontified t) 2398 2490 (fontified t) 2490 2505 (face font-lock-string-face fontified t) 2505 2506 (fontified t) 2506 2527 (face font-lock-string-face fontified t) 2527 2561 (fontified t) 2561 2566 (face font-lock-builtin-face fontified t) 2566 2602 (fontified t) 2602 2605 (face font-lock-comment-delimiter-face fontified t) 2605 2620 (face font-lock-comment-face fontified t) 2620 2688 (fontified t) 2688 2692 (face font-lock-keyword-face fontified t) 2692 2826 (fontified t) 2826 2828 (face font-lock-keyword-face fontified t) 2828 2856 (fontified t) 2856 2859 (face font-lock-string-face fontified t) 2859 2980 (fontified t) 2980 2987 (face font-lock-builtin-face fontified t) 2987 3030 (fontified t) 3030 3037 (fontified t) 3037 3045 (face font-lock-builtin-face fontified t) 3045 3058 (fontified t) 3058 3072 (face font-lock-string-face fontified t) 3072 3073 (fontified t) 3073 3099 (face font-lock-string-face fontified t) 3099 3103 (fontified t) 3103 3133 (fontified t) 3133 3138 (face font-lock-builtin-face fontified t) 3138 3212 (fontified t) 3212 3238 (face font-lock-string-face fontified t) 3238 3266 (fontified t) 3266 3269 (face font-lock-comment-delimiter-face fontified t) 3269 3279 (face font-lock-comment-face fontified t) 3279 3346 (fontified t) 3346 3349 (face font-lock-keyword-face fontified t) 3349 3435 (fontified t) 3435 3442 (face font-lock-builtin-face fontified t) 3442 3452 (fontified t) 3452 3460 (face font-lock-builtin-face fontified t) 3460 3473 (fontified t) 3473 3487 (face font-lock-string-face fontified t) 3487 3578 (fontified t) 3578 3593 (face font-lock-string-face fontified t) 3593 3594 (fontified t) 3594 3616 (face font-lock-string-face fontified t) 3616 3624 (fontified t) 3624 3629 (face font-lock-builtin-face fontified t) 3629 3646 (fontified t) 3646 3649 (face font-lock-comment-delimiter-face fontified t) 3649 3661 (face font-lock-comment-face fontified t) 3661 3698 (fontified t) 3698 3703 (face font-lock-warning-face fontified t) 3703 3756 (fontified t) 3756 3768 (face font-lock-string-face fontified t) 3768 3800 (fontified t)) . -18991) (undo-tree-id8 . -3800) (undo-tree-id9 . -2318) 22791) nil (26795 5405 680068 0) 0 nil])
([nil nil ((18758 . 18766) (#("                    " 0 20 (fontified t)) . 18758) (18744 . 18748) (18701 . 18702) (18616 . 18617) (18578 . 18579) (18457 . 18464) (#("                                                       " 0 55 (fontified t)) . 18457) (18391 . 18392) (18338 . 18339) (18256 . 18257) (18187 . 18190) (#("                       " 0 23 (fontified t)) . 18187) (18165 . 18166) (18111 . 18112) (15451 . 15452) (#("                " 0 16 (fontified t)) . 15451) 14331) nil (26795 5405 680065 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -14329) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 14330) nil (26795 5405 680059 0) 0 nil])
([nil nil ((#("uiop" 0 4 (fontified t)) . -15582) (undo-tree-id11 . -4) 15586 (t 26795 5405 0 0)) nil (26795 5573 264841 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . 15582)) nil (26795 5573 264833 0) 0 nil])
([nil nil ((15582 . 15594)) nil (26795 5573 264829 0) 0 nil])
([nil nil ((18818 . 18819) (t 26795 5573 0 0)) nil (26795 5615 564623 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18914) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 18915) nil (26795 5615 564619 0) 0 nil])
([nil nil ((18731 . 18732) (t 26795 5615 0 0)) nil (26795 5659 81620 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18819) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) 18820) nil (26795 5659 81617 0) 0 nil])
([nil nil ((18094 . 18095) (t 26795 5659 0 0)) nil (26795 5753 67413 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18732) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) 18733) nil (26795 5753 67412 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18818) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) 18819) nil (26795 5753 67402 0) 0 nil])
([nil nil ((18913 . 18914)) nil (26795 5753 67370 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15361 . 15362) (nil fontified nil 15319 . 15362) (15319 . 15362) (t 26795 5753 0 0)) nil (26795 6500 592142 0) 0 nil])
([nil nil ((15362 . 15370)) nil (26795 6500 592141 0) 0 nil])
([nil nil ((#("(and (>= (length path) plen)
                   (string= prefix* path :end2 plen))" 0 29 (fontified t) 29 70 (fontified t) 70 75 (face font-lock-builtin-face fontified t) 75 82 (fontified t)) . -15370) (undo-tree-id97 . -82) 15452) nil (26795 6500 592140 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 15362)) nil (26795 6500 592139 0) 0 nil])
([nil nil ((#("core" 0 4 (fontified t)) . -15326) (undo-tree-id96 . -4) 15330) nil (26795 6500 592138 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . 15326)) nil (26795 6500 592137 0) 0 nil])
([nil nil ((15330 . 15331)) nil (26795 6500 592137 0) 0 nil])
([nil nil ((206 . 207)) nil (26795 6500 592137 0) 0 nil])
([nil nil ((207 . 223)) nil (26795 6500 592136 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-builtin-face fontified t)) . -211) (undo-tree-id93 . -1) (#("n" 0 1 (face font-lock-builtin-face fontified t)) . -212) (undo-tree-id94 . -1) (#("g" 0 1 (face font-lock-builtin-face fontified t)) . -213) (undo-tree-id95 . -1) 214) nil (26795 6500 592135 0) 0 nil])
([nil nil ((#("

(defun ensure-header (headers name value)
  \"Remplace/insÃ¨re (name . value) en insensibilitÃ© de casse.\"
  (let* ((lname (string-downcase name))
         (found (assoc lname headers :test #'string=)))
    (if found
        (progn (setf (cdr found) value) headers)
        (append headers (list (cons lname value))))))" 0 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-function-name-face fontified t) 22 46 (fontified t) 46 105 (face font-lock-doc-face fontified t) 105 109 (fontified t) 109 113 (face font-lock-keyword-face fontified t) 113 183 (fontified t) 183 188 (face font-lock-builtin-face fontified t) 188 207 (fontified t) 207 209 (face font-lock-keyword-face fontified t) 209 225 (fontified t) 225 230 (face font-lock-keyword-face fontified t) 230 318 (fontified t)) . 4575) (undo-tree-id92 . -318)) nil (26795 6500 592133 0) 0 nil])
([nil nil ((5249 . 5259)) nil (26795 6500 592132 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -5258) (undo-tree-id91 . -1) 5259) nil (26795 6500 592131 0) 0 nil])
([nil nil ((5258 . 5260)) nil (26795 6500 592130 0) 0 nil])
([nil nil ((#("i" 0 1 (fontified t)) . -5258) (undo-tree-id89 . -1) (#("l" 0 1 (fontified t)) . -5259) (undo-tree-id90 . -1) 5260) nil (26795 6500 592129 0) 0 nil])
([nil nil ((5258 . 5261)) nil (26795 6500 592206 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6639 . 6640) (nil fontified nil 6629 . 6640) (6629 . 6640)) nil (26795 6643 913412 0) 0 nil] [nil nil ((nil rear-nonsticky nil 5286 . 5287) (nil fontified nil 5274 . 5287) (5274 . 5287)) ((#("ensure-header" 0 12 (fontified nil) 12 13 (rear-nonsticky nil fontified nil)) . 5274) (undo-tree-id98 . -13) (nil rear-nonsticky t 5286 . 5287)) (26795 6500 592114 0) 0 nil])
([nil nil ((6640 . 6641)) nil (26795 6643 913412 0) 0 nil])
nil
([nil nil ((#("e" 0 1 (rear-nonsticky t fontified t)) . 6636) (#("r" 0 1 (fontified t)) . 6636) (#("o" 0 1 (fontified t)) . 6636) (#("c" 0 1 (fontified t)) . 6636)) nil (26795 6643 913411 0) 0 nil])
([nil nil ((6636 . 6640)) nil (26795 6643 913410 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -6639) (undo-tree-id107 . -1) 6640) nil (26795 6643 913410 0) 0 nil])
([nil nil ((6639 . 6641)) nil (26795 6643 913409 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . 6629)) nil (26795 6643 913408 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6742 . 6743) (nil fontified nil 6742 . 6743) (nil fontified nil 6731 . 6742) (6731 . 6743)) nil (26795 6643 913408 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6916 . 6917) (nil fontified nil 6916 . 6917) (nil fontified nil 6905 . 6916) (6905 . 6917)) nil (26795 6643 913407 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7188 . 7189) (nil fontified nil 7188 . 7189) (nil fontified nil 7177 . 7188) (7177 . 7189)) nil (26795 6643 913406 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7785 . 7786) (nil fontified nil 7785 . 7786) (nil fontified nil 7774 . 7785) (7774 . 7786)) nil (26795 6643 913406 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7884 . 7885) (nil fontified nil 7884 . 7885) (nil fontified nil 7873 . 7884) (7873 . 7885)) nil (26795 6643 913405 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8005 . 8006) (nil fontified nil 8005 . 8006) (nil fontified nil 7994 . 8005) (7994 . 8006)) nil (26795 6643 913404 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8126 . 8127) (nil fontified nil 8126 . 8127) (nil fontified nil 8115 . 8126) (8115 . 8127)) nil (26795 6643 913404 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8326 . 8327) (nil fontified nil 8326 . 8327) (nil fontified nil 8315 . 8326) (8315 . 8327)) nil (26795 6643 913403 0) 0 nil])
([nil nil ((220 . 221)) nil (26795 6643 913402 0) 0 nil])
([nil nil ((221 . 229)) nil (26795 6643 913402 0) 0 nil])
([nil nil ((221 . 235) (#(":ensure-" 0 8 (face font-lock-builtin-face fontified t)) . -221) (undo-tree-id106 . -8) 229) nil (26795 6643 913401 0) 0 nil])
([nil nil ((#("e" 0 1 (face font-lock-builtin-face fontified t)) . -229) (undo-tree-id100 . -1) (#("x" 0 1 (face font-lock-builtin-face fontified t)) . -230) (undo-tree-id101 . -1) (#("p" 0 1 (face font-lock-builtin-face fontified t)) . -231) (undo-tree-id102 . -1) (#("o" 0 1 (face font-lock-builtin-face fontified t)) . -232) (undo-tree-id103 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -233) (undo-tree-id104 . -1) (#("t" 0 1 (face font-lock-builtin-face fontified t)) . -234) (undo-tree-id105 . -1) 235) nil (26795 6643 913399 0) 0 nil])
([nil nil ((229 . 231)) nil (26795 6643 913393 0) 0 nil])
([nil nil ((221 . 235) (#(":ensure-he" 0 10 (face font-lock-builtin-face fontified t)) . -221) (undo-tree-id99 . -10) 231) nil (26795 6643 913390 0) 0 nil])
([nil nil ((#("
(defun directory-index-html (dir rel-url)
  \"GÃ©nÃ¨re un listing minimal (UTF-8) pour DIR. rel-url commence par /.\"
  (let* ((entries (uiop:directory-files dir))
         (subdirs (uiop:subdirectories dir)))
    (with-output-to-string (s)
      (format s \"<!doctype html><meta charset='utf-8'><title>Index of ~A</title>\" rel-url)
      (format s \"<h1>Index of ~A</h1><ul>\" rel-url)
      (when (and (> (length rel-url) 1))
        (let* ((up (if (char= (char rel-url (1- (length rel-url))) #\\/)
                       (subseq rel-url 0 (max 1 (position #\\/ rel-url :from-end t :end (1- (length rel-url)))))
                       (subseq rel-url 0 (max 1 (position #\\/ rel-url :from-end t))))))
          (format s \"<li><a href='~A'>..</a></li>\" up)))
      (dolist (sd (sort (copy-list subdirs) #'string< :key #'namestring))
        (let* ((name (car (last (uiop:split-string (namestring sd) :separator \"/\")))))
          (format s \"<li><a href='~A/'>~A/</a></li>\" name name)))
      (dolist (f (sort (copy-list entries) #'string< :key #'namestring))
        (let* ((name (car (last (uiop:split-string (namestring f) :separator \"/\")))))
          (format s \"<li><a href='~A'>~A</a></li>\" name name)))
      (format s \"</ul>\"))))
" 0 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 45 (fontified t) 45 114 (face font-lock-doc-face fontified t) 114 118 (fontified t) 118 122 (face font-lock-keyword-face fontified t) 122 212 (fontified t) 212 233 (face font-lock-keyword-face fontified t) 233 254 (fontified t) 254 319 (face font-lock-string-face fontified t) 319 345 (fontified t) 345 371 (face font-lock-string-face fontified t) 371 388 (fontified t) 388 392 (face font-lock-keyword-face fontified t) 392 431 (fontified t) 431 435 (face font-lock-keyword-face fontified t) 435 442 (fontified t) 442 444 (face font-lock-keyword-face fontified t) 444 564 (fontified t) 564 573 (face font-lock-builtin-face fontified t) 573 576 (fontified t) 576 580 (face font-lock-builtin-face fontified t) 580 676 (fontified t) 676 685 (face font-lock-builtin-face fontified t) 685 714 (fontified t) 714 744 (face font-lock-string-face fontified t) 744 758 (fontified t) 758 764 (face font-lock-keyword-face fontified t) 764 805 (fontified t) 805 809 (face font-lock-builtin-face fontified t) 809 834 (fontified t) 834 838 (face font-lock-keyword-face fontified t) 838 892 (fontified t) 892 902 (face font-lock-builtin-face fontified t) 902 903 (fontified t) 903 906 (face font-lock-string-face fontified t) 906 932 (fontified t) 932 964 (face font-lock-string-face fontified t) 964 985 (fontified t) 985 991 (face font-lock-keyword-face fontified t) 991 1031 (fontified t) 1031 1035 (face font-lock-builtin-face fontified t) 1035 1060 (fontified t) 1060 1064 (face font-lock-keyword-face fontified t) 1064 1117 (fontified t) 1117 1127 (face font-lock-builtin-face fontified t) 1127 1128 (fontified t) 1128 1131 (face font-lock-string-face fontified t) 1131 1157 (fontified t) 1157 1187 (face font-lock-string-face fontified t) 1187 1217 (fontified t) 1217 1224 (face font-lock-string-face fontified t) 1224 1229 (fontified t)) . -10916) (undo-tree-id0 . -1229) (undo-tree-id1 . -28) (undo-tree-id2 . -28) (undo-tree-id3 . -28) (undo-tree-id4 . -28) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1051) (undo-tree-id8 . -1229) 12145 (t 26795 6643 0 0)) nil (26795 14565 540668 0) 0 nil])
([nil nil ((#("
	 (x (print rel1))" 0 19 (fontified t)) . 9581) (undo-tree-id15 . -19) (t 26795 14565 0 0)) nil (26795 15182 349301 0) 0 nil])
([nil nil ((#("
	 (x (print rel2))" 0 19 (fontified t)) . 9954) (undo-tree-id14 . -19)) nil (26795 15182 349300 0) 0 nil])
([nil nil ((#("
	 (x (print rel3))" 0 19 (fontified t)) . 10348) (undo-tree-id13 . -19)) nil (26795 15182 349298 0) 0 nil])
([nil nil ((#("
    (print \"SAFE JOIN 1\")" 0 12 (fontified t) 12 25 (face font-lock-string-face fontified t) 25 26 (fontified t)) . 10436) (undo-tree-id12 . -26)) nil (26795 15182 349297 0) 0 nil])
([nil nil ((#("
      (print \"SAFE JOIN 2\")" 0 14 (fontified t) 14 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 10611) (undo-tree-id9 . -28) (undo-tree-id10 . -28) (undo-tree-id11 . -28)) nil (26795 15182 349293 0) 0 nil])
([nil nil ((#("
  (when *debug* (format t \"~&[mw] query-parser HIT (before): ~A~%\" (type-of (lumen.core.http:req-query req))))" 0 1 (face font-lock-comment-face fontified t) 1 4 (fontified t) 4 8 (face font-lock-keyword-face fontified t) 8 27 (fontified t) 27 67 (face font-lock-string-face fontified t) 67 111 (fontified t)) . 4195) (undo-tree-id16 . -111) (undo-tree-id17 . -111) (undo-tree-id18 . -111) (undo-tree-id19 . -111) (undo-tree-id20 . -111) (undo-tree-id21 . -111) (undo-tree-id22 . -111) (undo-tree-id23 . -111) (undo-tree-id24 . -111) (undo-tree-id25 . -111) (t 26795 15182 0 0)) nil (26795 16032 486933 0) 0 nil])
([nil nil ((#("
    (when *debug* (format t \"~&[mw] query-parser OUT (after):  ~A~%\" (type-of (lumen.core.http:req-query req))))" 0 6 (fontified t) 6 10 (face font-lock-keyword-face fontified t) 10 29 (fontified t) 29 69 (face font-lock-string-face fontified t) 69 97 (fontified t) 97 113 (fontified t)) . 4341) (undo-tree-id0 . -113) (undo-tree-id1 . -35) (undo-tree-id2 . -35) (undo-tree-id3 . -35) (undo-tree-id4 . -35) (undo-tree-id5 . -35) (undo-tree-id6 . -35) (undo-tree-id7 . -113) (undo-tree-id8 . -113) (undo-tree-id9 . -113) (undo-tree-id10 . -113) (undo-tree-id11 . -113) (undo-tree-id12 . -113) (undo-tree-id13 . -113) (undo-tree-id14 . -113) (undo-tree-id15 . -113)) nil (26795 16032 486922 0) 0 nil])
([nil nil ((17146 . 17147) (t 26795 16032 0 0)) nil (26795 17742 317034 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18015 . 18016) (nil fontified nil 17147 . 18016) (17147 . 18016)) nil (26795 17742 317032 0) 0 nil])
([nil nil ((18016 . 18017)) nil (26795 17742 317029 0) 0 nil])
([nil nil ((17714 . 17715) (#("     " 0 5 (fontified t)) . 17714) (17638 . 17639) (#("                        " 0 24 (fontified t)) . 17638) 17147 (t 26795 17742 0 0)) nil (26795 19013 778072 0) 0 nil])
([nil nil ((12513 . 12515)) nil (26795 19013 778071 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12650 . 12651) (nil fontified nil 12515 . 12651) (12515 . 12651)) nil (26795 19013 778071 0) 0 nil])
([nil nil ((12986 . 12990)) nil (26795 19013 778070 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13007 . 13008) (nil fontified nil 12990 . 13008) (12990 . 13008)) nil (26795 19013 778070 0) 0 nil])
([nil nil ((13532 . 13533)) nil (26795 19013 778069 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13676 . 13677) (nil fontified nil 13533 . 13677) (13533 . 13677)) nil (26795 19013 778068 0) 0 nil])
([nil nil ((13677 . 13679)) nil (26795 19013 778068 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13740 . 13741) (nil fontified nil 13679 . 13741) (13679 . 13741)) nil (26795 19013 778067 0) 0 nil])
([nil nil ((16606 . 16614)) nil (26795 19013 778067 0) 0 nil])
([nil nil ((#("
                            (lumen.core.http:respond-404 \"Directory index disabled\")" 0 1 (fontified t) 1 58 (fontified t) 58 84 (face font-lock-string-face fontified t) 84 85 (fontified t)) . 16614) (undo-tree-id13 . -85)) nil (26795 19013 778066 0) 0 nil])
([nil nil ((16608 . 16615) (#("			    " 0 7 (fontified nil)) . 16607) (undo-tree-id11 . -7) (undo-tree-id12 . -7) (16614 . 16615)) nil (26795 19013 778065 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -16606) (undo-tree-id9 . -1) (undo-tree-id10 . -1) 16607) nil (26795 19013 778063 0) 0 nil])
([nil nil ((16606 . 16614)) nil (26795 19013 778062 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17523 . 17524) (nil fontified nil 16614 . 17524) (16614 . 17524)) nil (26795 19013 778061 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -17522) (undo-tree-id7 . -1) (#(")" 0 1 (rear-nonsticky t fontified t)) . -17523) (undo-tree-id8 . -1) 17524) nil (26795 19013 778060 0) 0 nil])
([nil nil ((#("(t
                            " 0 31 (fontified t)) . -16704) (undo-tree-id6 . -31) 16735) nil (26795 19013 778058 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 16676)) nil (26795 19013 778056 0) 0 nil])
([nil nil ((16704 . 16705) (16676 . 16677)) nil (26795 19013 778055 0) 0 nil])
([nil nil ((#("
			    " 0 1 (fontified t) 1 8 (fontified t)) . -17492) (undo-tree-id5 . -8) 17500) nil (26795 19013 778055 0) 0 nil])
([nil nil ((#("	     " 0 6 (fontified nil)) . -18172) (18172 . 18173) (#("	" 0 1 (fontified nil)) . 18172) (18168 . 18172) (#("    " 0 4 (fontified t)) . -18156) (#(" " 0 1 (fontified t)) . -18114) (#(" " 0 1 (fontified t)) . -18030) (#(" " 0 1 (fontified t)) . -17993) (#("	" 0 1 (fontified nil)) . -17879) (17879 . 17880) (#("	" 0 1 (fontified nil)) . 17879) (17872 . 17879) (#(" " 0 1 (fontified t)) . -17801) (#(" " 0 1 (fontified t)) . -17749) (#(" " 0 1 (fontified t)) . -17668) (#("	" 0 1 (fontified nil)) . -17602) (17602 . 17603) (#("	" 0 1 (fontified nil)) . 17602) (17595 . 17602) (#(" " 0 1 (fontified t)) . -17572) (#(" " 0 1 (fontified t)) . -17519) 12735) nil (26795 19013 778053 0) 0 nil])
([nil nil ((#("(funcall next req)" 0 18 (fontified t)) . -18117) (undo-tree-id4 . -18) 18135) nil (26795 19013 778051 0) 0 nil])
([nil nil ((18117 . 18126) (#(" " 0 1 (fontified nil)) . 18116) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (18117 . 18118)) nil (26795 19013 778050 0) 0 nil])
([nil nil ((18116 . 18126)) nil (26795 19013 778047 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18829 . 18830) (nil fontified nil 18126 . 18830) (18126 . 18830)) nil (26795 19013 778047 0) 0 nil])
([nil nil ((#("
		       " 0 1 (fontified t) 1 10 (fontified t)) . -18830) (undo-tree-id1 . -10) 18840) nil (26795 19013 778046 0) 0 nil])
([nil nil ((19008 . 19009)) nil (26795 19013 778043 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -19008) (undo-tree-id0 . -1) 19009) nil (26795 19013 778040 0) 0 nil])
([nil nil ((423 . 424) (t 26795 19013 0 0)) nil (26795 19979 61678 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 430 . 431) (nil fontified nil 424 . 431) (424 . 431)) nil (26795 19979 61677 0) 0 nil])
([nil nil ((431 . 436)) nil (26795 19979 61672 0) 0 nil])
([nil nil ((19866 . 19867) (t 26795 19979 0 0)) nil (26795 21090 42160 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20772 . 20773) (nil fontified nil 19867 . 20773) (19867 . 20773)) nil (26795 21090 42159 0) 0 nil])
([nil nil ((#("

(defun static-many (&rest mounts)
  \"Monte plusieurs middlewares static en cascade.
MOUNTS est une liste de specs, chacune Ã©tant:
  - une PLIST de paramÃ¨tres pour (static ...) (ex: '(:prefix \\\"/public\\\" :dir #P\\\"./public/\\\"))
  - OU directement un middleware (static :prefix ... :dir ...).

PrioritÃ©: l'ordre donnÃ©. Chaque static essaie â†’ sinon passe au suivant â†’ sinon NEXT.\"
  (let* ((mws
           (mapcar (lambda (m)
                     (etypecase m
                       (function m)	; dÃ©jÃ  un middleware
                       (list     (apply #'static m)))) ; spec plist â†’ construire
                   mounts)))
    (lambda (next)
      ;; on enrobe NEXT par les statics du dernier au premier (classique)
      (reduce (lambda (n mw) (funcall mw n))
              mws
              :from-end t
              :initial-value next))))" 0 2 (fontified t) 2 3 (fontified t) 3 8 (fontified t face font-lock-keyword-face) 8 9 (fontified t) 9 20 (fontified t face font-lock-function-name-face) 20 22 (fontified t) 22 27 (face font-lock-type-face fontified t) 27 38 (fontified t) 38 378 (face font-lock-doc-face fontified t) 378 382 (fontified t) 382 386 (face font-lock-keyword-face fontified t) 386 413 (fontified t) 413 419 (face font-lock-keyword-face fontified t) 419 446 (fontified t) 446 455 (face font-lock-keyword-face fontified t) 455 494 (fontified t) 494 515 (face font-lock-comment-face fontified t) 515 570 (fontified t) 570 596 (face font-lock-comment-face fontified t) 596 630 (fontified t) 630 636 (face font-lock-keyword-face fontified t) 636 650 (fontified t) 650 653 (face font-lock-comment-delimiter-face fontified t) 653 718 (face font-lock-comment-face fontified t) 718 733 (fontified t) 733 739 (face font-lock-keyword-face fontified t) 739 795 (fontified t) 795 804 (face font-lock-builtin-face fontified t) 804 821 (fontified t) 821 835 (face font-lock-builtin-face fontified t) 835 844 (fontified t)) . 19021) (undo-tree-id0 . -844) (undo-tree-id1 . -20) (undo-tree-id2 . -844) (undo-tree-id3 . -844)) nil (26795 21090 42157 0) 0 nil])
([nil nil ((19929 . 19930) 19021) nil (26795 21090 42135 0) 0 nil])
([nil nil ((19930 . 19931) (t 26795 21090 0 0)) nil (26796 29881 522111 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22901 . 22902) (nil fontified nil 19931 . 22902) (19931 . 22902)) nil (26796 29881 522110 0) 0 nil])
([nil nil ((22902 . 22903)) nil (26796 29881 522105 0) 0 nil])
([nil nil ((436 . 441) (t 26796 29881 0 0)) nil (26796 30136 982320 0) 0 nil])
([nil nil ((441 . 442)) nil (26796 30136 982319 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -441) (undo-tree-id12 . -1) 442) nil (26796 30136 982319 0) 0 nil])
([nil nil ((441 . 443)) nil (26796 30136 982318 0) 0 nil])
([nil nil ((443 . 444)) nil (26796 30136 982317 0) 0 nil])
([nil nil ((444 . 451)) nil (26796 30136 982316 0) 0 nil])
([nil nil ((451 . 456)) nil (26796 30136 982316 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 465 . 466) (nil fontified nil 456 . 466) (456 . 466)) nil (26796 30136 982315 0) 0 nil])
([nil nil ((456 . 457)) nil (26796 30136 982315 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -456) (undo-tree-id11 . -1) 457) nil (26796 30136 982313 0) 0 nil])
([nil nil ((456 . 457)) nil (26796 30136 982311 0) 0 nil])
([nil nil ((467 . 468)) nil (26796 30136 982309 0) 0 nil])
([nil nil ((436 . 441)) nil (26796 30136 982308 0) 0 nil])
([nil nil ((441 . 443)) nil (26796 30136 982308 0) 0 nil])
([nil nil ((443 . 444)) nil (26796 30136 982305 0) 0 nil])
([nil nil ((444 . 446)) nil (26796 30136 982304 0) 0 nil])
([nil nil ((#("o" 0 1 (face font-lock-comment-face fontified t)) . -445) (undo-tree-id10 . -1) 446) nil (26796 30136 982303 0) 0 nil])
([nil nil ((445 . 450)) nil (26796 30136 982300 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-comment-face fontified t)) . -447) (undo-tree-id7 . -1) (#("e" 0 1 (face font-lock-comment-face fontified t)) . -448) (undo-tree-id8 . -1) (#("r" 0 1 (face font-lock-comment-face fontified t)) . -449) (undo-tree-id9 . -1) 450) nil (26796 30136 982299 0) 0 nil])
([nil nil ((447 . 450)) nil (26796 30136 982294 0) 0 nil])
([nil nil ((450 . 451)) nil (26796 30136 982293 0) 0 nil])
([nil nil ((451 . 459)) nil (26796 30136 982293 0) 0 nil])
([nil nil ((459 . 464)) nil (26796 30136 982292 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 478 . 479) (nil fontified nil 464 . 479) (464 . 479)) nil (26796 30136 982291 0) 0 nil])
([nil nil ((464 . 466)) nil (26796 30136 982290 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -465) (undo-tree-id6 . -1) 466) nil (26796 30136 982290 0) 0 nil])
([nil nil ((512 . 513)) nil (26796 30136 982288 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -512) (undo-tree-id5 . -1) 513) nil (26796 30136 982287 0) 0 nil])
([nil nil ((512 . 513)) nil (26796 30136 982285 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 523 . 524) (nil fontified nil 513 . 524) (513 . 524)) nil (26796 30136 982285 0) 0 nil])
([nil nil ((524 . 525)) nil (26796 30136 982284 0) 0 nil])
([nil nil ((525 . 532)) nil (26796 30136 982283 0) 0 nil])
([nil nil ((532 . 533)) nil (26796 30136 982282 0) 0 nil])
([nil nil ((533 . 534)) nil (26796 30136 982282 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 547 . 548) (nil fontified nil 534 . 548) (534 . 548)) nil (26796 30136 982281 0) 0 nil])
([nil nil ((480 . 483) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -463) (463 . 464) (#("	" 0 1 (fontified nil)) . 463) (460 . 463) (480 . 481)) nil (26796 30136 982280 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 492 . 493) (nil fontified nil 486 . 493) (nil fontified nil 483 . 486) (483 . 493)) nil (26796 30136 982278 0) 0 nil])
([nil nil ((#("Cookies" 0 6 (face font-lock-comment-face fontified t) 6 7 (face font-lock-comment-face rear-nonsticky t fontified t)) . 486)) nil (26796 30136 982277 0) 0 nil])
([nil nil ((486 . 494)) nil (26796 30136 982277 0) 0 nil])
([nil nil ((494 . 498)) nil (26796 30136 982276 0) 0 nil])
([nil nil ((498 . 508)) nil (26796 30136 982276 0) 0 nil])
([nil nil ((508 . 515)) nil (26796 30136 982275 0) 0 nil])
([nil nil ((#("
   ;; Redirect
   :respond-redirect" 0 1 (fontified t) 1 4 (fontified t) 4 7 (face font-lock-comment-delimiter-face fontified t) 7 16 (face font-lock-comment-face fontified t) 16 19 (fontified t) 19 36 (face font-lock-builtin-face fontified t)) . 479) (undo-tree-id4 . -36)) nil (26796 30136 982271 0) 0 nil])
([nil nil ((#("core" 0 4 (fontified t)) . -22881) (undo-tree-id13 . -4) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -4) (undo-tree-id20 . -4) (undo-tree-id21 . -4) (undo-tree-id22 . -4) 22885 (t 26796 30136 0 0)) nil (26796 30260 107670 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . 22881)) nil (26796 30260 107653 0) 0 nil])
([nil nil ((22885 . 22886)) nil (26796 30260 107649 0) 0 nil])
([nil nil ((479 . 480) (t 26796 30260 0 0)) nil (26796 30335 324996 0) 0 nil])
([nil nil ((480 . 494)) nil (26796 30335 324992 0) 0 nil])
([nil nil ((21006 . 21008) (t 26796 30335 0 0)) nil (26796 31779 344713 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21215 . 21216) (nil fontified nil 21008 . 21216) (21008 . 21216)) nil (26796 31779 344709 0) 0 nil])
([nil nil ((#("

(defun set-cookie! (resp name value &rest opts)
  \"Ajoute un header Set-Cookie formatÃ© Ã  la rÃ©ponse.\"
  (apply #'lumen.core.http:add-set-cookie
         resp
         (lumen.core.http:format-set-cookie name value
                                            ;; transfÃ¨re les :keys passÃ©es
                                            (loop for (k v) on opts by #'cddr append (list k v)))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 20 (face font-lock-function-name-face fontified t) 20 38 (fontified t) 38 43 (face font-lock-type-face fontified t) 43 52 (fontified t) 52 103 (face font-lock-doc-face fontified t) 103 259 (fontified t) 259 262 (face font-lock-comment-delimiter-face fontified t) 262 290 (face font-lock-comment-face fontified t) 290 335 (fontified t) 335 339 (face font-lock-keyword-face fontified t) 339 389 (fontified t)) . 20617) (undo-tree-id23 . -389) (undo-tree-id24 . -214) (undo-tree-id25 . -169) (undo-tree-id26 . -323) (undo-tree-id27 . -323) (undo-tree-id28 . -323) (undo-tree-id29 . -323) (undo-tree-id30 . -251) (undo-tree-id31 . -251) (undo-tree-id32 . -251) (undo-tree-id33 . -251) (undo-tree-id34 . -251) (undo-tree-id35 . -251) (undo-tree-id36 . -389) (undo-tree-id37 . -389) (undo-tree-id38 . -389) (undo-tree-id39 . -323) (undo-tree-id40 . -389) (t 26796 31779 0 0)) nil (26796 31799 215862 0) 0 nil])
([nil nil ((22846 . 22847) (t 26796 31799 0 0)) nil (26796 37597 321812 0) 0 nil])
([nil nil ((22847 . 22849)) nil (26796 37597 321812 0) 0 nil])
([nil nil ((22849 . 22850)) nil (26796 37597 321811 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-delimiter-face fontified nil)) . 22849) (undo-tree-id47 . -1) (22850 . 22851)) nil (26796 37597 321811 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24311 . 24312) (nil fontified nil 22850 . 24312) (22850 . 24312)) nil (26796 37597 321810 0) 0 nil])
([nil nil ((22849 . 22850)) nil (26796 37597 321809 0) 0 nil])
([nil nil ((22850 . 22854)) nil (26796 37597 321809 0) 0 nil])
([nil nil ((22854 . 22855)) nil (26796 37597 321809 0) 0 nil])
([nil nil ((22855 . 22861)) nil (26796 37597 321808 0) 0 nil])
([nil nil ((167 . 168)) nil (26796 37597 321808 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 185 . 186) (nil fontified nil 178 . 186) (nil fontified nil 177 . 178) (nil fontified nil 176 . 177) (nil fontified nil 175 . 176) (nil fontified nil 169 . 175) (nil fontified nil 168 . 169) (168 . 186)) nil (26796 37597 321807 0) 0 nil])
([nil nil ((#("setf (getf (lumen.core.http:req-ctx" 0 35 (fontified t)) . -23388) (undo-tree-id46 . -35) 23423) nil (26796 37597 321806 0) 0 nil])
([nil nil ((23388 . 23396)) nil (26796 37597 321805 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23403 . 23404) (nil fontified nil 23388 . 23404) (23388 . 23404)) nil (26796 37597 321804 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -23416) (undo-tree-id45 . -1) 23417) nil (26796 37597 321804 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -23422) (undo-tree-id44 . -1) 23423) nil (26796 37597 321803 0) 0 nil])
([nil nil ((23423 . 23427) (#("            " 0 12 (fontified t)) . 23423) 22881) nil (26796 37597 321801 0) 0 nil])
([nil nil ((23461 . 23466) (#(" " 0 1 (fontified nil)) . 23461) (23460 . 23461)) nil (26796 37597 321801 0) 0 nil])
([nil nil ((23536 . 23538)) nil (26796 37597 321800 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24224 . 24225) (nil fontified nil 23538 . 24225) (23538 . 24225)) nil (26796 37597 321800 0) 0 nil])
([nil nil ((23584 . 23587)) nil (26796 37597 321799 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23642 . 23643) (nil fontified nil 23587 . 23643) (23587 . 23643)) nil (26796 37597 321799 0) 0 nil])
([nil nil ((#("

(define-middleware multipart-parser (req next)
  \"Parse multipart/form-data â†’ ctx[:files], ctx[:fields].\"
  (let* ((headers (lumen.core.http:req-headers req))
         (ct      (cdr (assoc \"content-type\" headers :test #'string-equal)))
         (len     (cdr (assoc \"content-length\" headers :test #'string-equal)))
         (len*    (when len (parse-integer len :junk-allowed t))))
    (when (and ct len* (> len* 0)
               (search \"multipart/form-data\" (string-downcase ct)))
      (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
        (when res
          (setf (getf (lumen.core.http:req-ctx req) :fields) (getf res :fields))
          (setf (getf (lumen.core.http:req-ctx req) :files)  (getf res :files)))))
    (funcall next req)))" 0 1 (fontified t) 1 3 (fontified t) 3 20 (face font-lock-keyword-face fontified t) 20 51 (fontified t) 51 107 (face font-lock-string-face fontified t) 107 111 (fontified t) 111 115 (face font-lock-keyword-face fontified t) 115 191 (fontified t) 191 205 (face font-lock-string-face fontified t) 205 214 (fontified t) 214 219 (face font-lock-builtin-face fontified t) 219 268 (fontified t) 268 284 (face font-lock-string-face fontified t) 284 293 (fontified t) 293 298 (face font-lock-builtin-face fontified t) 298 336 (fontified t) 336 340 (face font-lock-keyword-face fontified t) 340 364 (fontified t) 364 377 (face font-lock-builtin-face fontified t) 377 389 (fontified t) 389 393 (face font-lock-keyword-face fontified t) 393 441 (fontified t) 441 462 (face font-lock-string-face fontified t) 462 493 (fontified t) 493 496 (face font-lock-keyword-face fontified t) 496 594 (fontified t) 594 598 (face font-lock-keyword-face fontified t) 598 655 (fontified t) 655 662 (face font-lock-builtin-face fontified t) 662 674 (fontified t) 674 681 (face font-lock-builtin-face fontified t) 681 736 (fontified t) 736 742 (face font-lock-builtin-face fontified t) 742 755 (fontified t) 755 761 (face font-lock-builtin-face fontified t) 761 790 (fontified t) 790 791 (fontified t rear-nonsticky t)) . 24284) (undo-tree-id43 . -791)) nil (26796 37597 321798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22619 . 22620) (nil fontified nil 22574 . 22620) (22574 . 22620)) nil (26796 37597 321797 0) 0 nil])
([nil nil ((#("(setf (getf " 0 12 (fontified t)) . 22620)) nil (26796 37597 321796 0) 0 nil])
([nil nil ((#("(lumen.core.http:req-ctx " 0 19 (fontified t) 19 25 (fontified t)) . 22620) (undo-tree-id42 . -25)) nil (26796 37597 321796 0) 0 nil])
([nil nil ((#("req) :request-id) rid)" 0 5 (fontified t) 5 16 (help-echo "Easy to misread; consider moving the element to the next line" face (font-lock-warning-face font-lock-builtin-face) fontified t) 16 18 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t) 18 22 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . 22620) (undo-tree-id41 . -22)) nil (26796 37597 321794 0) 0 nil])
([nil nil ((158 . 160) (156 . 157)) nil (26796 37597 321784 0) 0 nil])
([nil nil ((24274 . 24275) 160) nil (26796 37597 321781 0) 0 nil])
([nil nil ((#("set-ctx" 0 6 (fontified t) 6 7 (fontified t)) . -23394) (undo-tree-id60 . -7) 23401 (t 26796 37597 0 0)) nil (26796 37702 6734 0) 0 nil])
([nil nil ((23394 . 23399)) nil (26796 37702 6732 0) 0 nil])
([nil nil ((23378 . 23402) (#("lumen.core.http:ctx-s!" 0 15 (fontified t) 15 16 (fontified t rear-nonsticky t) 16 21 (fontified t) 21 22 (fontified t)) . 23378) (undo-tree-id48 . -16) (undo-tree-id49 . -21) (undo-tree-id50 . -16) (undo-tree-id51 . -19) (undo-tree-id52 . -19) (undo-tree-id53 . -19) (undo-tree-id54 . -19) (undo-tree-id55 . -19) (undo-tree-id56 . -20) (undo-tree-id57 . -20) (undo-tree-id58 . -21) (undo-tree-id59 . -21) 23399) nil (26796 37702 6729 0) 0 nil])
([nil nil ((258 . 261) (t 26796 37701 0 0)) nil (26796 37877 739090 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 325 . 326) (nil fontified nil 325 . 326) (nil fontified nil 311 . 325) (nil fontified nil 310 . 311) (nil fontified nil 297 . 310) (nil fontified nil 296 . 297) (nil fontified nil 292 . 296) (nil fontified nil 291 . 292) (nil fontified nil 288 . 291) (nil fontified nil 287 . 288) (nil fontified nil 275 . 287) (nil fontified nil 274 . 275) (nil fontified nil 262 . 274) (nil fontified nil 261 . 262) (261 . 326)) nil (26796 37877 739089 0) 0 nil])
([nil nil ((#("utils" 0 5 (face font-lock-builtin-face fontified t)) . -282) (undo-tree-id66 . -5) 287) nil (26796 37877 739088 0) 0 nil])
([nil nil ((282 . 291)) nil (26796 37877 739086 0) 0 nil])
([nil nil ((#("-> :->> :str-prefix-p :ensure-header" 0 2 (face font-lock-builtin-face fontified t) 2 3 (fontified t) 3 7 (face font-lock-builtin-face fontified t) 7 8 (fontified t) 8 21 (face font-lock-builtin-face fontified t) 21 22 (fontified t) 22 36 (face font-lock-builtin-face fontified t)) . -293) (undo-tree-id65 . -36) 329) nil (26796 37877 739086 0) 0 nil])
([nil nil ((293 . 297)) nil (26796 37877 739084 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-builtin-face fontified t)) . -293) (undo-tree-id61 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -294) (undo-tree-id62 . -1) (#("l" 0 1 (face font-lock-builtin-face fontified t)) . -295) (undo-tree-id63 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -296) (undo-tree-id64 . -1) 297) nil (26796 37877 739082 0) 0 nil])
([nil nil ((293 . 309)) nil (26796 37877 739067 0) 0 nil])
([nil nil ((24327 . 24328) (t 26796 37877 0 0)) nil (26796 39883 441238 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28742 . 28743) (nil fontified nil 24328 . 28743) (24328 . 28743)) nil (26796 39883 441237 0) 0 nil])
([nil nil ((#("

;;; ---------------- Middleware ---------------" 0 2 (fontified t) 2 6 (face font-lock-comment-delimiter-face fontified t) 6 49 (face font-lock-comment-face fontified t)) . 26117) (undo-tree-id4 . -49)) nil (26796 39883 441237 0) 0 nil])
([nil nil ((#("helpers" 0 7 (face font-lock-comment-face fontified t)) . -24354) (undo-tree-id3 . -7) 24361) nil (26796 39883 441236 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -24353) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 24354) nil (26796 39883 441234 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 24370)) nil (26796 39883 441232 0) 0 nil])
([nil nil ((#("
(defun method-get-or-head-p (req)
  (let ((m (slot-value req 'lumen.core.http::method)))
    (or (string= m \"GET\") (string= m \"HEAD\"))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 38 (fontified t) 38 41 (face font-lock-keyword-face fontified t) 41 90 (fontified t) 90 109 (fontified t) 109 114 (face font-lock-string-face fontified t) 114 127 (fontified t) 127 133 (face font-lock-string-face fontified t) 133 137 (fontified t)) . 25971) (undo-tree-id0 . -137)) nil (26796 39883 441231 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 25971)) nil (26796 39883 441217 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -28167) (28182 . 28193)) nil (26796 39883 441217 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -26981) (26996 . 27007) (#("lumen.core.util" 0 15 (fontified t)) . -26748) (26763 . 26774)) nil (26796 39883 441216 0) 0 nil])
([nil nil ((27037 . 27045) (#(" " 0 1 (fontified nil)) . 27037) (27036 . 27037)) nil (26796 39883 441215 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 27050)) nil (26796 39883 441214 0) 0 nil])
([nil nil ((#("    " 0 4 (fontified nil)) . -27107) (27050 . 27051)) nil (26796 39883 441214 0) 0 nil])
([nil nil ((27123 . 27130) (#(" " 0 1 (fontified nil)) . 27123) (27122 . 27123)) nil (26796 39883 441213 0) 0 nil])
([nil nil ((636 . 639) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -587) (587 . 588) (#("	" 0 1 (fontified nil)) . 587) (584 . 587) (636 . 637)) nil (26796 39883 441212 0) 0 nil])
([nil nil ((639 . 641)) nil (26796 39883 441211 0) 0 nil])
([nil nil ((641 . 642)) nil (26796 39883 441210 0) 0 nil])
([nil nil ((642 . 646)) nil (26796 39883 441210 0) 0 nil])
([nil nil ((646 . 650)) nil (26796 39883 441210 0) 0 nil])
([nil nil ((650 . 651)) nil (26796 39883 441209 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 654 . 655) (nil fontified nil 651 . 655) (651 . 655)) nil (26796 39883 441208 0) 0 nil])
([nil nil ((28565 . 28566)) nil (26796 39883 441204 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27758) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 27759 (t 26796 39883 0 0)) nil (26796 39934 279584 0) 0 nil])
([nil nil ((27758 . 27760)) nil (26796 39934 279581 0) 0 nil])
([nil nil ((#("x" 0 1 (fontified t)) . -27759) (undo-tree-id18 . -1) 27760) nil (26796 39934 279581 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27770) (undo-tree-id17 . -1) 27771) nil (26796 39934 279579 0) 0 nil])
([nil nil ((27770 . 27771)) nil (26796 39934 279578 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27885) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 27886) nil (26796 39934 279577 0) 0 nil])
([nil nil ((27885 . 27886)) nil (26796 39934 279566 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27903) (undo-tree-id5 . -1) 27904) nil (26796 39934 279564 0) 0 nil])
([nil nil ((27903 . 27904)) nil (26796 39934 279551 0) 0 nil])
([nil nil ((25520 . 25522) (t 26796 39934 0 0)) nil (26796 40128 551415 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25796 . 25797) (nil fontified nil 25522 . 25797) (25522 . 25797)) nil (26796 40128 551414 0) 0 nil])
([nil nil ((#("
(defun %parse-if-none-match (h)
  \"Retourne une liste de tags (strings) tels que reÃ§us, ex: (\\\"W/\\\\\\\"SIG\\\\\\\"\\\" \\\"\\\\\\\"SIG2\\\\\\\"\\\")\"
  (when (and h (plusp (length h)))
    (mapcar #'string-trim
            (uiop:split-string h :separator \",\"))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 35 (fontified t) 35 130 (face font-lock-doc-face fontified t) 130 134 (fontified t) 134 138 (face font-lock-keyword-face fontified t) 138 192 (fontified t) 192 225 (fontified t) 225 235 (face font-lock-builtin-face fontified t) 235 236 (fontified t) 236 239 (face font-lock-string-face fontified t) 239 244 (fontified t)) . 25277) (undo-tree-id22 . -244) (undo-tree-id23 . -13) (undo-tree-id24 . -13) (undo-tree-id25 . -13) (undo-tree-id26 . -13) (undo-tree-id27 . -9) (undo-tree-id28 . -14) (undo-tree-id29 . -14) (undo-tree-id30 . -180) (undo-tree-id31 . -9) (undo-tree-id32 . -14) (undo-tree-id33 . -14) (undo-tree-id34 . -14) (undo-tree-id35 . -14) (undo-tree-id36 . -14) (undo-tree-id37 . -14) (undo-tree-id38 . -14) (undo-tree-id39 . -14) (undo-tree-id40 . -14) (undo-tree-id41 . -14) (undo-tree-id42 . -14) (undo-tree-id43 . -8) (undo-tree-id44 . -28) (undo-tree-id45 . -28) (undo-tree-id46 . -9) (undo-tree-id47 . -8) (undo-tree-id48 . -28) (undo-tree-id49 . -28) (undo-tree-id50 . -28) (undo-tree-id51 . -28) (undo-tree-id52 . -191) (undo-tree-id53 . -191) (undo-tree-id54 . -191) (undo-tree-id55 . -191) (undo-tree-id56 . -191) (undo-tree-id57 . -191) (undo-tree-id58 . -191) (undo-tree-id59 . -191) (undo-tree-id60 . -191) (undo-tree-id61 . -243) (undo-tree-id62 . -243) (undo-tree-id63 . -243) (undo-tree-id64 . -243) (undo-tree-id65 . -243) (undo-tree-id66 . 1) (undo-tree-id67 . -244) (undo-tree-id68 . -1) (undo-tree-id69 . -192) (undo-tree-id70 . -244) (undo-tree-id71 . -244) (undo-tree-id72 . -244) (undo-tree-id73 . -8) (undo-tree-id74 . -244) (undo-tree-id75 . -244) (undo-tree-id76 . -244) (undo-tree-id77 . -244)) nil (26796 40128 551410 0) 0 nil])
([nil nil ((23571 . 23578) (t 26796 40128 0 0)) nil (26796 44274 853560 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23624 . 23625) (nil fontified nil 23578 . 23625) (23578 . 23625)) nil (26796 44274 853560 0) 0 nil])
([nil nil ((24373 . 24377)) nil (26796 44274 853559 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24423 . 24424) (nil fontified nil 24377 . 24424) (24377 . 24424)) nil (26796 44274 853559 0) 0 nil])
([nil nil ((28704 . 28705)) nil (26796 44274 853558 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33886 . 33887) (nil fontified nil 28705 . 33887) (28705 . 33887)) nil (26796 44274 853557 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -30605) (undo-tree-id85 . -1) 30606) nil (26796 44274 853557 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -28766) (undo-tree-id84 . -1) 28767) nil (26796 44274 853556 0) 0 nil])
([nil nil ((30169 . 30170) (30133 . 30134) (30101 . 30102) (30017 . 30018) (29946 . 29954) (#("                                                               " 0 63 (fontified t)) . 29946) (29910 . 29911) (29818 . 29819) (29747 . 29748) (29555 . 29556) (29458 . 29459) (29396 . 29397) (29328 . 29329) (29211 . 29212) (29157 . 29158) (29080 . 29081) (29035 . 29036) 28767) nil (26796 44274 853554 0) 0 nil])
([nil nil ((29044 . 29051) (#(" " 0 1 (fontified nil)) . 29043) (undo-tree-id83 . -1) (29044 . 29045)) nil (26796 44274 853552 0) 0 nil])
([nil nil ((#("       " 0 7 (fontified t)) . -30072) (#("       " 0 7 (fontified t)) . -30043) (#("       " 0 7 (fontified t)) . -30018) (#("       " 0 7 (fontified t)) . -29941) (#("	" 0 1 (fontified nil)) . -29884) (29884 . 29885) (#("	" 0 1 (fontified nil)) . 29884) (29883 . 29884) (#("       " 0 7 (fontified t)) . -29841) (#("       " 0 7 (fontified t)) . -29756) (#("       " 0 7 (fontified t)) . -29692) (#("       " 0 7 (fontified t)) . -29625) (#("       " 0 7 (fontified t)) . -29514) (#("       " 0 7 (fontified t)) . -29424) (#("       " 0 7 (fontified t)) . -29369) (#("       " 0 7 (fontified t)) . -29308) (#("       " 0 7 (fontified t)) . -29198) (#("       " 0 7 (fontified t)) . -29151) (#("       " 0 7 (fontified t)) . -29081) 28767) nil (26796 44274 853550 0) 0 nil])
([nil nil ((29220 . 29228) (#(" " 0 1 (fontified nil)) . 29219) (undo-tree-id82 . -1) (29220 . 29221)) nil (26796 44274 853548 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -32426) (undo-tree-id78 . -1) (#(" " 0 1 (fontified t)) . -32427) (undo-tree-id79 . -1) (#(" " 0 1 (fontified t)) . -32428) (undo-tree-id80 . -1) (#(" " 0 1 (fontified t)) . -32429) (undo-tree-id81 . -1) 32430) nil (26796 44274 853546 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -33517) (33532 . 33543) (#("lumen.core.util" 0 15 (fontified t)) . -33432) (33447 . 33458) (#("lumen.core.util" 0 15 (fontified t)) . -32220) (32235 . 32246)) nil (26796 44274 853533 0) 0 nil])
([nil nil ((33739 . 33740) 33528) nil (26796 44274 853529 0) 0 nil])
([nil nil ((131 . 141) (t 26796 44274 0 0)) nil (26796 44345 891161 0) 0 nil])
([nil nil ((141 . 142)) nil (26796 44345 891160 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -131) (undo-tree-id106 . -1) 132) nil (26796 44345 891160 0) 0 nil])
([nil nil ((131 . 132)) nil (26796 44345 891159 0) 0 nil])
([nil nil ((141 . 142)) nil (26796 44345 891158 0) 0 nil])
([nil nil ((142 . 151)) nil (26796 44345 891158 0) 0 nil])
([nil nil ((#("t" 0 1 (face font-lock-builtin-face fontified t)) . -150) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) 151) nil (26796 44345 891157 0) 0 nil])
([nil nil ((150 . 151)) nil (26796 44345 891155 0) 0 nil])
([nil nil ((#("a" 0 1 (face font-lock-builtin-face fontified t)) . -149) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (#("t" 0 1 (face font-lock-builtin-face fontified t)) . -150) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) 151) nil (26796 44345 891154 0) 0 nil])
([nil nil ((149 . 153)) nil (26796 44345 891147 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-builtin-face fontified t)) . -152) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) 153) nil (26796 44345 891145 0) 0 nil])
([nil nil ((152 . 154)) nil (26796 44345 891128 0) 0 nil])
([nil nil ((156 . 158) (154 . 155) (t 26796 44345 0 0)) nil (26796 44355 17387 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -183) (undo-tree-id107 . -3) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -3) (undo-tree-id111 . -3) (undo-tree-id112 . -3) (undo-tree-id113 . -3) (undo-tree-id114 . -3) (undo-tree-id115 . -3) 186) nil (26796 44355 17383 0) 0 nil])
([nil nil ((30939 . 30946) (t 26796 44355 0 0)) nil (26796 45302 256911 0) 0 nil])
([nil nil ((30946 . 30947)) nil (26796 45302 256910 0) 0 nil])
([nil nil ((30247 . 30249)) nil (26796 45302 256909 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31690 . 31691) (nil fontified nil 30249 . 31691) (30249 . 31691)) nil (26796 45302 256909 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -31690) (undo-tree-id117 . -1) 31691) nil (26796 45302 256908 0) 0 nil])
([nil nil ((31594 . 31596)) nil (26796 45302 256906 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31619 . 31620) (nil fontified nil 31599 . 31620) (nil fontified nil 31596 . 31599) (31596 . 31620)) nil (26796 45302 256905 0) 0 nil])
([nil nil ((#("
(defun %parse-accept-encoding (h)
  \"Retourne une alist '( (\\\"gzip\\\" . q) (\\\"deflate\\\" . q) ... ) triÃ©e par q desc.
   Si header manquant â†’ NIL.\"
  (when (and h (plusp (length h)))
    (let* ((tokens (uiop:split-string h :separator \",\"))
           (pairs
             (mapcar
	      (lambda (tok)
                (let* ((t1 (string-trim '(#\\Space #\\Tab) tok))
                       (pos (position #\\; t1))
                       (enc (string-downcase
			     (string-trim '(#\\Space #\\Tab)
                                                          (subseq t1 0 (or pos (length t1))))))
                       (q   (if (and pos
                                     (let* ((p2 (position #\\= t1 :start (1+ pos)))
                                            (k  (and p2 (string-trim '(#\\Space #\\Tab)
                                                                     (subseq t1 (1+ pos) p2)))))
                                       (and p2 (string-equal k \"q\"))))
                                (let* ((p2 (position #\\= t1 :start (1+ pos)))
                                       (raw (string-trim '(#\\Space #\\Tab)
							 (subseq t1 (1+ p2)))))
                                  (or (ignore-errors (parse-number raw)) 0.0))
                                1.0)))
                  (cons enc q)))
              tokens)))
      ;; filtre q=0, trie desc
      (sort (remove-if (lambda (c) (<= (cdr c) 0.0)) pairs)
            #'>
            :key #'cdr))))
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 30 (face font-lock-function-name-face fontified t) 30 37 (fontified t) 37 146 (face font-lock-doc-face fontified t) 146 150 (fontified t) 150 154 (face font-lock-keyword-face fontified t) 154 187 (fontified t) 187 191 (face font-lock-keyword-face fontified t) 191 222 (fontified t) 222 232 (face font-lock-builtin-face fontified t) 232 233 (fontified t) 233 236 (face font-lock-string-face fontified t) 236 257 (fontified t) 257 286 (fontified t) 286 292 (face font-lock-keyword-face fontified t) 292 299 (fontified t) 299 316 (fontified t) 316 320 (face font-lock-keyword-face fontified t) 320 362 (fontified t) 362 409 (fontified t) 409 492 (fontified t) 492 588 (fontified t) 588 617 (fontified t) 617 619 (face font-lock-keyword-face fontified t) 619 629 (fontified t) 629 667 (fontified t) 667 671 (face font-lock-keyword-face fontified t) 671 694 (fontified t) 694 700 (face font-lock-builtin-face fontified t) 700 712 (fontified t) 712 798 (fontified t) 798 895 (fontified t) 895 958 (fontified t) 958 961 (face font-lock-string-face fontified t) 961 966 (fontified t) 966 999 (fontified t) 999 1003 (face font-lock-keyword-face fontified t) 1003 1026 (fontified t) 1026 1032 (face font-lock-builtin-face fontified t) 1032 1044 (fontified t) 1044 1118 (fontified t) 1118 1126 (fontified t) 1126 1149 (fontified t) 1149 1188 (fontified t) 1188 1201 (face font-lock-keyword-face fontified t) 1201 1228 (fontified t) 1228 1267 (fontified t) 1267 1300 (fontified t) 1300 1314 (fontified t) 1314 1324 (fontified t) 1324 1330 (fontified t) 1330 1333 (face font-lock-comment-delimiter-face fontified t) 1333 1355 (face font-lock-comment-face fontified t) 1355 1371 (fontified t) 1371 1379 (fontified t) 1379 1385 (face font-lock-keyword-face fontified t) 1385 1415 (fontified t) 1415 1431 (fontified t) 1431 1443 (fontified t) 1443 1447 (face font-lock-builtin-face fontified t) 1447 1458 (fontified t)) . 28790) (undo-tree-id116 . -1458)) nil (26796 45302 256904 0) 0 nil])
([nil nil ((33343 . 33351)) nil (26796 45302 256894 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33369 . 33370) (nil fontified nil 33351 . 33370) (33351 . 33370)) nil (26796 45302 256893 0) 0 nil])
([nil nil ((33370 . 33371)) nil (26796 45302 256893 0) 0 nil])
([nil nil ((33370 . 33371)) nil (26796 45302 256892 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33377 . 33378) (nil fontified nil 33371 . 33378) (33371 . 33378)) nil (26796 45302 256892 0) 0 nil])
([nil nil ((33718 . 33726)) nil (26796 45302 256890 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33797 . 33798) (nil fontified nil 33726 . 33798) (33726 . 33798)) nil (26796 45302 256882 0) 0 nil])
([nil nil ((679 . 683) (t 26796 45302 0 0)) nil (26796 45337 48225 0) 0 nil])
([nil nil ((683 . 685)) nil (26796 45337 48224 0) 0 nil])
([nil nil ((685 . 686)) nil (26796 45337 48224 0) 0 nil])
([nil nil ((686 . 697)) nil (26796 45337 48223 0) 0 nil])
([nil nil ((697 . 701)) nil (26796 45337 48223 0) 0 nil])
([nil nil ((701 . 703)) nil (26796 45337 48222 0) 0 nil])
([nil nil ((#("c" 0 1 (fontified t)) . -701) (undo-tree-id118 . -1) (#("o" 0 1 (fontified t)) . -702) (undo-tree-id119 . -1) 703) nil (26796 45337 48221 0) 0 nil])
([nil nil ((701 . 710)) nil (26796 45337 48207 0) 0 nil])
([nil nil ((710 . 713)) nil (26796 45337 48203 0) 0 nil])
([nil nil ((30499 . 30501) (t 26796 45337 0 0)) nil (26796 45939 30359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 30934 . 30935) (nil fontified nil 30501 . 30935) (30501 . 30935)) nil (26796 45939 30358 0) 0 nil])
([nil nil ((31570 . 31572)) nil (26796 45939 30357 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 32081 . 32082) (nil fontified nil 31572 . 32082) (31572 . 32082)) nil (26796 45939 30356 0) 0 nil])
([nil nil ((#("GZIP" 0 4 (face font-lock-comment-face fontified t)) . -30958) (undo-tree-id125 . -4) 30962) nil (26796 45939 30355 0) 0 nil])
([nil nil ((30958 . 30969)) nil (26796 45939 30354 0) 0 nil])
([nil nil ((33819 . 33826)) nil (26796 45939 30353 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 34126 . 34127) (nil fontified nil 33826 . 34127) (33826 . 34127)) nil (26796 45939 30352 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 34748 . 34749) (nil fontified nil 34542 . 34749) (34542 . 34749)) nil (26796 45939 30351 0) 0 nil])
([nil nil ((34749 . 34755)) nil (26796 45939 30350 0) 0 nil])
([nil nil ((34755 . 34757)) nil (26796 45939 30349 0) 0 nil])
([nil nil ((#("\"gzip\"" 0 6 (face font-lock-string-face fontified t)) . -35068) (undo-tree-id124 . -6) 35074) nil (26796 45939 30348 0) 0 nil])
([nil nil ((35068 . 35074)) nil (26796 45939 30346 0) 0 nil])
([nil nil ((#("gz" 0 2 (fontified t)) . -35176) (undo-tree-id123 . -2) 35178) nil (26796 45939 30345 0) 0 nil])
([nil nil ((35176 . 35179)) nil (26796 45939 30343 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -35178) (undo-tree-id122 . -1) 35179) nil (26796 45939 30343 0) 0 nil])
([nil nil ((35178 . 35182)) nil (26796 45939 30341 0) 0 nil])
([nil nil ((#("gz" 0 2 (fontified t)) . -35375) (undo-tree-id121 . -2) 35377) nil (26796 45939 30339 0) 0 nil])
([nil nil ((35375 . 35378)) nil (26796 45939 30336 0) 0 nil])
([nil nil ((#("d" 0 1 (fontified t)) . -35377) (undo-tree-id120 . -1) 35378) nil (26796 45939 30334 0) 0 nil])
([nil nil ((35377 . 35382)) nil (26796 45939 30322 0) 0 nil])
([nil nil ((35419 . 35420)) nil (26796 45939 30320 0) 0 nil])
([nil nil ((35420 . 35421)) nil (26796 45939 30315 0) 0 nil])
([nil nil ((32139 . 32140) (t 26796 45939 0 0)) nil (26796 47478 57680 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37939 . 37940) (nil fontified nil 32140 . 37940) (32140 . 37940)) nil (26796 47478 57679 0) 0 nil])
([nil nil ((#("

(defun compression (&key (threshold 1024) (encodings '(\"gzip\")) (add-vary t))
  \"Compresse la rÃ©ponse si pertinent.
   - THRESHOLD : taille mini du corps (octets) pour compresser (def. 1024)
   - ENCODINGS : liste d'encodages supportÃ©s (actuellement \\\"gzip\\\" seulement)
   - ADD-VARY  : si T, ajoute (ou complÃ¨te) Vary: Accept-Encoding\"
  (declare (ignore encodings)) ; gzip only pour lâ€™instant
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (status (lumen.core.http:resp-status resp))
             (headers (lumen.core.http:resp-headers resp)))
        (labels ((decorate-vary (hdrs)
                   (if add-vary
                       (let* ((existing (cdr (assoc \"vary\" hdrs :test #'string=)))
                              (new (if existing
                                       (if (search \"accept-encoding\" (string-downcase existing))
                                           existing
                                           (format nil \"~A, Accept-Encoding\" existing))
                                       \"Accept-Encoding\")))
                         (lumen.utils:ensure-header hdrs \"vary\" new))
                       hdrs)))
          (cond
            ;; Ne compresse jamais ces cas
            ((or (member status '(204 304))                         ; pas de corps
                 (cdr (assoc \"content-encoding\" headers :test #'string=)) ; dÃ©jÃ  encodÃ©
                 (not (%client-wants-gzip-p (lumen.core.http:req-headers req)))) ; client ne veut pas
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)
            (t
	     (let* ((chosen (%choose-encoding req-h :supported '(\"gzip\" \"deflate\"))))
               (if (null chosen)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
             (let* ((body-bytes (%bytes (lumen.core.http:resp-body resp)))
                    (len (length body-bytes)))
               (if (< len threshold)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
                   ;; compresser
                   (let* ((encoded (ecase (intern (string-upcase chosen) :keyword)
                                           (:GZIP    (gzip-bytes bytes))
                                           (:DEFLATE (deflate-bytes bytes))))
			  ;;(gz (gzip-bytes body-bytes))
                          (hdrs (lumen.core.http:resp-headers resp)))
		     ;; Content-Encoding ;; Vary 
                     (setf (lumen.core.http:resp-headers resp)
                           (-> hdrs
                               (lumen.utils:ensure-header \"content-encoding\" chosen)
                               (lumen.utils:ensure-header \"content-length\" (princ-to-string (length chosen)))
                               (decorate-vary)))
		     ;; Corps compressÃ© â†’ write-response recalculera Content-Length tout seul
                     (setf (lumen.core.http:resp-body resp) encoded)
                     resp))))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 20 (face font-lock-function-name-face fontified t) 20 22 (fontified t) 22 26 (face font-lock-type-face fontified t) 26 57 (fontified t) 57 63 (face font-lock-string-face fontified t) 63 82 (fontified t) 82 134 (face font-lock-doc-face fontified t) 134 193 (face font-lock-doc-face fontified t) 193 338 (face font-lock-doc-face fontified t) 338 342 (fontified t) 342 348 (face font-lock-keyword-face fontified t) 348 349 (face font-lock-keyword-face fontified t) 349 370 (fontified t) 370 397 (face font-lock-comment-face fontified t) 397 400 (fontified t) 400 406 (face font-lock-keyword-face fontified t) 406 419 (fontified t) 419 425 (face font-lock-keyword-face fontified t) 425 439 (fontified t) 439 443 (face font-lock-keyword-face fontified t) 443 482 (fontified t) 482 483 (fontified t) 483 513 (fontified t) 513 528 (fontified t) 528 574 (fontified t) 574 588 (fontified t) 588 597 (fontified t) 597 603 (face font-lock-keyword-face fontified t) 603 609 (fontified t) 609 627 (fontified t) 627 647 (fontified t) 647 648 (face font-lock-keyword-face fontified t) 648 649 (face font-lock-keyword-face fontified t) 649 659 (fontified t) 659 683 (fontified t) 683 687 (face font-lock-keyword-face fontified t) 687 711 (fontified t) 711 717 (face font-lock-string-face fontified t) 717 723 (fontified t) 723 728 (face font-lock-builtin-face fontified t) 728 778 (fontified t) 778 780 (face font-lock-keyword-face fontified t) 780 816 (fontified t) 816 830 (fontified t) 830 832 (face font-lock-keyword-face fontified t) 832 841 (fontified t) 841 858 (face font-lock-string-face fontified t) 858 887 (fontified t) 887 994 (fontified t) 994 1015 (face font-lock-string-face fontified t) 1015 1066 (fontified t) 1066 1077 (face font-lock-string-face fontified t) 1077 1083 (face font-lock-string-face fontified t) 1083 1087 (fontified t) 1087 1113 (fontified t) 1113 1124 (fontified t) 1124 1144 (fontified t) 1144 1150 (face font-lock-string-face fontified t) 1150 1157 (fontified t) 1157 1199 (fontified t) 1199 1203 (face font-lock-keyword-face fontified t) 1203 1204 (fontified t) 1204 1216 (fontified t) 1216 1219 (face font-lock-comment-delimiter-face fontified t) 1219 1247 (face font-lock-comment-face fontified t) 1247 1252 (fontified t) 1252 1313 (fontified t) 1313 1315 (fontified t) 1315 1330 (face font-lock-comment-face fontified t) 1330 1359 (fontified t) 1359 1377 (face font-lock-string-face fontified t) 1377 1386 (fontified t) 1386 1391 (face font-lock-builtin-face fontified t) 1391 1397 (fontified t) 1397 1404 (fontified t) 1404 1418 (face font-lock-comment-face fontified t) 1418 1449 (fontified t) 1449 1451 (fontified t) 1451 1499 (fontified t) 1499 1501 (face font-lock-comment-face fontified t) 1501 1520 (face font-lock-comment-face fontified t) 1520 1666 (fontified t) 1666 1681 (fontified t) 1681 1687 (fontified t) 1687 1688 (fontified t) 1688 1692 (face font-lock-keyword-face fontified t) 1692 1726 (fontified t) 1726 1736 (face font-lock-builtin-face fontified t) 1736 1739 (fontified t) 1739 1745 (face font-lock-string-face fontified t) 1745 1746 (fontified t) 1746 1755 (face font-lock-string-face fontified t) 1755 1776 (fontified t) 1776 1778 (face font-lock-keyword-face fontified t) 1778 1813 (fontified t) 1813 1818 (face font-lock-keyword-face fontified t) 1818 1987 (fontified t) 1987 1988 (fontified t rear-nonsticky t) 1988 1989 (fontified t) 1989 2001 (fontified t) 2001 2003 (fontified t) 2003 2007 (face font-lock-keyword-face fontified t) 2007 2064 (fontified t) 2064 2127 (fontified t) 2127 2129 (face font-lock-keyword-face fontified t) 2129 2168 (fontified t) 2168 2173 (face font-lock-keyword-face fontified t) 2173 2205 (fontified t) 2205 2237 (fontified t) 2237 2363 (fontified t) 2363 2366 (face font-lock-comment-delimiter-face fontified t) 2366 2377 (face font-lock-comment-face fontified t) 2377 2397 (fontified t) 2397 2401 (face font-lock-keyword-face fontified t) 2401 2403 (fontified t) 2403 2413 (fontified t) 2413 2418 (face font-lock-keyword-face fontified t) 2418 2450 (fontified t) 2450 2458 (face font-lock-builtin-face fontified t) 2458 2504 (fontified t) 2504 2509 (face font-lock-builtin-face fontified t) 2509 2533 (fontified t) 2533 2577 (fontified t) 2577 2585 (face font-lock-builtin-face fontified t) 2585 2609 (fontified t) 2609 2610 (fontified t rear-nonsticky t) 2610 2611 (fontified t) 2611 2616 (fontified t) 2616 2618 (face font-lock-comment-delimiter-face fontified t) 2618 2646 (face font-lock-comment-face fontified t) 2646 2647 (face font-lock-comment-face fontified t) 2647 2682 (fontified t) 2682 2717 (fontified t) 2717 2724 (fontified t) 2724 2727 (face font-lock-comment-delimiter-face fontified t) 2727 2742 (face font-lock-comment-face fontified t) 2742 2743 (face font-lock-comment-face fontified t rear-nonsticky t) 2743 2744 (face font-lock-comment-face fontified t) 2744 2750 (face font-lock-comment-face fontified t) 2750 2751 (face font-lock-comment-face fontified t rear-nonsticky t) 2751 2752 (face font-lock-comment-face fontified t) 2752 2753 (face font-lock-comment-face fontified t) 2753 2852 (fontified t) 2852 2884 (fontified t) 2884 2895 (fontified t) 2895 2910 (fontified t) 2910 2928 (face font-lock-string-face fontified t) 2928 2935 (fontified t) 2935 2937 (fontified t) 2937 2969 (fontified t) 2969 2980 (fontified t) 2980 2995 (fontified t) 2995 3011 (face font-lock-string-face fontified t) 3011 3020 (fontified t) 3020 3047 (fontified t) 3047 3096 (fontified t) 3096 3103 (fontified t) 3103 3106 (face font-lock-comment-delimiter-face fontified t) 3106 3174 (face font-lock-comment-face fontified t) 3174 3175 (face font-lock-comment-face fontified t rear-nonsticky t) 3175 3176 (face font-lock-comment-face fontified t) 3176 3245 (fontified t) 3245 3279 (fontified t) 3279 3280 (fontified t rear-nonsticky t) 3280 3282 (fontified t)) . -37940) (undo-tree-id128 . -1087) (undo-tree-id129 . -3175) (undo-tree-id130 . -1681) (undo-tree-id131 . -3282) (undo-tree-id132 . -3282) 41222) nil (26796 47478 57678 0) 0 nil])
([nil nil ((#("(defun %content-type (headers)
  (cdr (assoc \"content-type\" headers :test #'string=)))

(defun %type-prefixed-p (ct prefixes)
  \"Vrai si le Content-Type CT commence par un des PREFIXES (strings).\"
  (and ct prefixes
       (let ((ct* (string-downcase ct)))
         (some (lambda (pfx) (lumen.core.util:str-prefix-p (string-downcase pfx) ct*))
               prefixes))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 45 (fontified t) 45 59 (face font-lock-string-face fontified t) 59 68 (fontified t) 68 73 (face font-lock-builtin-face fontified t) 73 89 (fontified t) 89 94 (face font-lock-keyword-face fontified t) 94 95 (fontified t) 95 111 (face font-lock-function-name-face fontified t) 111 128 (fontified t) 128 196 (face font-lock-doc-face fontified t) 196 224 (fontified t) 224 227 (face font-lock-keyword-face fontified t) 227 273 (fontified t) 273 279 (face font-lock-keyword-face fontified t) 279 371 (fontified t)) . 32140) (undo-tree-id127 . -371)) nil (26796 47478 57672 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 32140) (#("
" 0 1 (fontified t)) . 32140)) nil (26796 47478 57669 0) 0 nil])
([nil nil ((30935 . 30937)) nil (26796 47478 57668 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31307 . 31308) (nil fontified nil 31216 . 31308) (nil fontified nil 31210 . 31216) (nil fontified nil 31164 . 31210) (nil fontified nil 31161 . 31164) (nil fontified nil 31133 . 31161) (nil fontified nil 31065 . 31133) (nil fontified nil 31048 . 31065) (nil fontified nil 31032 . 31048) (nil fontified nil 31031 . 31032) (nil fontified nil 31026 . 31031) (nil fontified nil 31010 . 31026) (nil fontified nil 31005 . 31010) (nil fontified nil 30996 . 31005) (nil fontified nil 30982 . 30996) (nil fontified nil 30957 . 30982) (nil fontified nil 30944 . 30957) (nil fontified nil 30943 . 30944) (nil fontified nil 30938 . 30943) (nil fontified nil 30937 . 30938) (30937 . 31308)) nil (26796 47478 57667 0) 0 nil])
([nil nil ((154 . 155)) nil (26796 47478 57664 0) 0 nil])
([nil nil ((155 . 156)) nil (26796 47478 57663 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 167 . 168) (nil fontified nil 156 . 168) (156 . 168)) nil (26796 47478 57662 0) 0 nil])
([nil nil ((156 . 158) (154 . 155)) nil (26796 47478 57661 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -171) (undo-tree-id126 . -3) 174) nil (26796 47478 57659 0) 0 nil])
([nil nil ((32913 . 32920) (#("           " 0 11 (fontified nil)) . 32913) (#("   " 0 3 (fontified t)) . -32899) (#("   " 0 3 (fontified t)) . -32875) (#("   " 0 3 (fontified t)) . -32851) (#("   " 0 3 (fontified t)) . -32791) (#("   " 0 3 (fontified t)) . -32719) (#("   " 0 3 (fontified t)) . -32662) (#("   " 0 3 (fontified t)) . -32600) (#("   " 0 3 (fontified t)) . -32580) 32527) nil (26796 47478 57641 0) 0 nil])
([nil nil (("lumen.core.util" . -37674) (37689 . 37700) (#("lumen.core.util" 0 15 (fontified t)) . -33851) (t 26796 47478 0 0) (33866 . 33877) (t 26796 47478 0 0)) nil (26796 47490 421489 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -31238) (t 26796 47490 0 0) (31253 . 31264) (t 26796 47490 0 0)) nil (26796 47501 526956 0) 0 nil])
([nil nil ((37915 . 37916) (t 26796 47501 0 0)) nil (26796 49382 300209 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 39614 . 39615) (nil fontified nil 37916 . 39615) (37916 . 39615)) nil (26796 49382 300208 0) 0 nil])
([nil nil ((37915 . 37916)) nil (26796 49382 300207 0) 0 nil])
([nil nil ((37916 . 37919)) nil (26796 49382 300207 0) 0 nil])
([nil nil ((37919 . 37920)) nil (26796 49382 300207 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37942 . 37943) (nil fontified nil 37920 . 37943) (37920 . 37943)) nil (26796 49382 300206 0) 0 nil])
([nil nil ((37943 . 37944)) nil (26796 49382 300206 0) 0 nil])
([nil nil ((37944 . 37965)) nil (26796 49382 300205 0) 0 nil])
([nil nil ((37965 . 37984)) nil (26796 49382 300205 0) 0 nil])
([nil nil ((#("â€‘" 0 1 (face font-lock-comment-face fontified t)) . 37922)) nil (26796 49382 300205 0) 0 nil])
([nil nil ((37922 . 37923)) nil (26796 49382 300204 0) 0 nil])
([nil nil ((#("â€‘" 0 1 (face font-lock-comment-face fontified t)) . -37931) (undo-tree-id135 . -1) 37932) nil (26796 49382 300204 0) 0 nil])
([nil nil ((37931 . 37932)) nil (26796 49382 300203 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -39449) (39464 . 39475) (#("lumen.core.util" 0 15 (fontified t)) . -39379) (39394 . 39405) (#("lumen.core.util" 0 15 (fontified t)) . -38569) (38584 . 38595)) nil (26796 49382 300202 0) 0 nil])
([nil nil ((295 . 296)) nil (26796 49382 300201 0) 0 nil])
([nil nil ((296 . 297)) nil (26796 49382 300201 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 311 . 312) (nil fontified nil 297 . 312) (297 . 312)) nil (26796 49382 300200 0) 0 nil])
([nil nil ((312 . 313)) nil (26796 49382 300199 0) 0 nil])
([nil nil ((313 . 320)) nil (26796 49382 300199 0) 0 nil])
([nil nil ((313 . 329) (#("format-" 0 7 (fontified t)) . -313) (undo-tree-id134 . -7) 320) nil (26796 49382 300198 0) 0 nil])
([nil nil ((313 . 314)) nil (26796 49382 300197 0) 0 nil])
([nil nil ((313 . 315) (#(" " 0 1 (fontified nil)) . 312) (undo-tree-id133 . -1) (313 . 314)) nil (26796 49382 300195 0) 0 nil])
([nil nil ((39709 . 39710) 315) nil (26796 49382 300182 0) 0 nil])
([nil nil ((766 . 770) (749 . 753) (#("   " 0 3 (fontified nil)) . 749) (764 . 765) (t 26796 49382 0 0)) nil (26796 49741 601456 0) 0 nil])
([nil nil ((770 . 771)) nil (26796 49741 601455 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 795 . 796) (nil fontified nil 771 . 796) (771 . 796)) nil (26796 49741 601455 0) 0 nil])
([nil nil ((#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -768) (768 . 769) (#("	" 0 1 (fontified nil)) . 768) (765 . 768) (#("	   " 0 4 (fontified nil)) . -647) (647 . 648) (#("	" 0 1 (fontified nil)) . 647) (644 . 647) 19) nil (26796 49741 601454 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -749) (undo-tree-id142 . -1) (#(" " 0 1 (fontified t)) . -750) (undo-tree-id143 . -1) (#(" " 0 1 (fontified t)) . -751) (undo-tree-id144 . -1) 752) nil (26796 49741 601452 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -751) (undo-tree-id136 . -1) (#(" " 0 1 (fontified t)) . -752) (undo-tree-id137 . -1) (#(" " 0 1 (fontified t)) . -753) (undo-tree-id138 . -1) (#(" " 0 1 (fontified t)) . -754) (undo-tree-id139 . -1) (#(" " 0 1 (fontified nil)) . -755) (undo-tree-id140 . -1) (#("	" 0 1 (fontified nil)) . 756) (undo-tree-id141 . -1) (748 . 756) 749) nil (26796 49741 601445 0) 0 nil])
([nil nil ((14580 . 14589) (#(" " 0 1 (fontified nil)) . 14580) (14579 . 14580) (t 26796 49741 0 0)) nil (26796 50658 162219 0) 0 nil])
([nil nil ((14598 . 14606)) nil (26796 50658 162218 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14636 . 14637) (nil fontified nil 14606 . 14637) (14606 . 14637)) nil (26796 50658 162218 0) 0 nil])
([nil nil ((19427 . 19428)) nil (26796 50658 162217 0) 0 nil])
([nil nil ((13105 . 13106)) nil (26796 50658 162217 0) 0 nil])
([nil nil ((13105 . 13107)) nil (26796 50658 162217 0) 0 nil])
([nil nil ((#("              " 0 14 (face font-lock-comment-face fontified nil)) . -19391) (19429 . 19430)) nil (26796 50658 162216 0) 0 nil])
([nil nil ((19416 . 19418)) nil (26796 50658 162216 0) 0 nil])
([nil nil ((19418 . 19420)) nil (26796 50658 162215 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27252 . 27253) (nil fontified nil 19420 . 27253) (19420 . 27253)) nil (26796 50658 162215 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -27252) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) 27253) nil (26796 50658 162214 0) 0 nil])
([nil nil ((27252 . 27253)) nil (26796 50658 162210 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -27252) (undo-tree-id145 . -1) (undo-tree-id146 . -1) 27253) nil (26796 50658 162207 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -26783) (26798 . 26809) (#("lumen.core.util" 0 15 (fontified t)) . -26649) (26664 . 26675) (#("lumen.core.util" 0 15 (fontified t)) . -25739) (25754 . 25765) (#("lumen.core.util" 0 15 (fontified t)) . -25613) (25628 . 25639) (#("lumen.core.util" 0 15 (fontified t)) . -24796) (24811 . 24822) (#("lumen.core.util" 0 15 (fontified t)) . -24652) (24667 . 24678) (#("lumen.core.util" 0 15 (fontified t)) . -23658) (23673 . 23684) (#("lumen.core.util" 0 15 (fontified t)) . -23522) (23537 . 23548) (#("lumen.core.util" 0 15 (fontified t)) . -22667) (22682 . 22693) (#("lumen.core.util" 0 15 (fontified t)) . -22531) (t 26796 50658 0 0) (22546 . 22557) (t 26796 50658 0 0)) nil (26796 50672 180361 0) 0 nil])
([nil nil ((47574 . 47575) (t 26796 50672 0 0)) nil (26797 27361 393744 0) 0 nil])
([nil nil ((47575 . 47577)) nil (26797 27361 393743 0) 0 nil])
([nil nil ((47577 . 47578)) nil (26797 27361 393743 0) 0 nil])
([nil nil ((47578 . 47579)) nil (26797 27361 393742 0) 0 nil])
([nil nil ((47579 . 47586)) nil (26797 27361 393742 0) 0 nil])
([nil nil ((47586 . 47587)) nil (26797 27361 393742 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 49113 . 49114) (nil fontified nil 47587 . 49114) (47587 . 49114)) nil (26797 27361 393741 0) 0 nil])
([nil nil ((793 . 797)) nil (26797 27361 393741 0) 0 nil])
([nil nil ((797 . 799)) nil (26797 27361 393740 0) 0 nil])
([nil nil ((799 . 800)) nil (26797 27361 393740 0) 0 nil])
([nil nil ((800 . 807)) nil (26797 27361 393739 0) 0 nil])
([nil nil ((807 . 811)) nil (26797 27361 393739 0) 0 nil])
([nil nil ((811 . 819)) nil (26797 27361 393738 0) 0 nil])
([nil nil ((821 . 825) (808 . 812) (#("   " 0 3 (fontified nil)) . 808) (819 . 820)) nil (26797 27361 393738 0) 0 nil])
([nil nil ((825 . 830)) nil (26797 27361 393737 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-builtin-face fontified t)) . -827) (undo-tree-id189 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -828) (undo-tree-id190 . -1) (#("f" 0 1 (face font-lock-builtin-face fontified t)) . -829) (undo-tree-id191 . -1) 830) nil (26797 27361 393736 0) 0 nil])
([nil nil ((827 . 830)) nil (26797 27361 393731 0) 0 nil])
([nil nil ((49151 . 49153)) nil (26797 27361 393731 0) 0 nil])
([nil nil ((49153 . 49155)) nil (26797 27361 393731 0) 0 nil])
([nil nil ((49155 . 49156)) nil (26797 27361 393730 0) 0 nil])
([nil nil ((49156 . 49157)) nil (26797 27361 393730 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -49155) (undo-tree-id187 . -1) (#(";" 0 1 (face font-lock-comment-face fontified t)) . -49156) (undo-tree-id188 . -1) 49157) nil (26797 27361 393729 0) 0 nil])
([nil nil ((49155 . 49156)) nil (26797 27361 393727 0) 0 nil])
([nil nil ((49156 . 49157)) nil (26797 27361 393727 0) 0 nil])
([nil nil ((49157 . 49161)) nil (26797 27361 393726 0) 0 nil])
([nil nil ((49161 . 49162)) nil (26797 27361 393726 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50794 . 50795) (nil fontified nil 49162 . 50795) (49162 . 50795)) nil (26797 27361 393726 0) 0 nil])
([nil nil ((49161 . 49162)) nil (26797 27361 393725 0) 0 nil])
([nil nil ((49162 . 49164)) nil (26797 27361 393724 0) 0 nil])
([nil nil ((49164 . 49165)) nil (26797 27361 393724 0) 0 nil])
([nil nil ((49165 . 49167)) nil (26797 27361 393724 0) 0 nil])
([nil nil ((49164 . 49165)) nil (26797 27361 393723 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 49477 . 49478) (nil fontified nil 49165 . 49478) (49165 . 49478)) nil (26797 27361 393723 0) 0 nil])
([nil nil ((49165 . 49166)) nil (26797 27361 393722 0) 0 nil])
([nil nil ((49166 . 49167)) nil (26797 27361 393722 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -49270) (undo-tree-id186 . -1) 49271) nil (26797 27361 393721 0) 0 nil])
([nil nil ((49270 . 49271)) nil (26797 27361 393720 0) 0 nil])
([nil nil ((49271 . 49272)) nil (26797 27361 393720 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -49454) (undo-tree-id185 . -1) 49455) nil (26797 27361 393720 0) 0 nil])
([nil nil ((49454 . 49455)) nil (26797 27361 393719 0) 0 nil])
([nil nil ((49455 . 49456)) nil (26797 27361 393718 0) 0 nil])
([nil nil ((709 . 710)) nil (26797 27361 393718 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -709) (undo-tree-id184 . -1) 710) nil (26797 27361 393717 0) 0 nil])
([nil nil ((385 . 388)) nil (26797 27361 393716 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 436 . 437) (nil fontified nil 436 . 437) (nil fontified nil 419 . 436) (nil fontified nil 418 . 419) (nil fontified nil 402 . 418) (nil fontified nil 401 . 402) (nil fontified nil 389 . 401) (nil fontified nil 388 . 389) (388 . 437)) nil (26797 27361 393716 0) 0 nil])
([nil nil ((#("body" 0 4 (face font-lock-builtin-face fontified t)) . 414)) nil (26797 27361 393715 0) 0 nil])
([nil nil ((414 . 421)) nil (26797 27361 393714 0) 0 nil])
([nil nil ((#(":parse-urlencoded" 0 17 (face font-lock-builtin-face fontified t)) . -422) (undo-tree-id183 . -17) 439) nil (26797 27361 393714 0) 0 nil])
([nil nil ((nil fontified nil 505 . 506) (nil fontified nil 489 . 505) (nil fontified nil 476 . 489) (nil fontified nil 475 . 476) (nil fontified nil 474 . 475) (nil fontified nil 462 . 474) (nil fontified nil 461 . 462) (nil fontified nil 460 . 461) (nil fontified nil 448 . 460) (nil fontified nil 447 . 448) (nil fontified nil 435 . 447) (nil fontified nil 434 . 435) (nil fontified nil 433 . 434) (nil fontified nil 426 . 433) (nil fontified nil 422 . 426) (422 . 506)) nil (26797 27361 393712 0) 0 nil])
([nil nil ((506 . 507)) nil (26797 27361 393711 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 541 . 542) (nil fontified nil 532 . 542) (nil fontified nil 531 . 532) (nil fontified nil 530 . 531) (nil fontified nil 520 . 530) (nil fontified nil 519 . 520) (nil fontified nil 518 . 519) (nil fontified nil 508 . 518) (nil fontified nil 507 . 508) (507 . 542)) nil (26797 27361 393710 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -506) (undo-tree-id181 . -1) (undo-tree-id182 . -1) 507) nil (26797 27361 393709 0) 0 nil])
([nil nil ((507 . 508)) nil (26797 27361 393707 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 515 . 516) (nil fontified nil 508 . 516) (508 . 516)) nil (26797 27361 393707 0) 0 nil])
([nil nil ((516 . 517)) nil (26797 27361 393706 0) 0 nil])
([nil nil ((551 . 552)) nil (26797 27361 393706 0) 0 nil])
([nil nil ((552 . 553)) nil (26797 27361 393705 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 562 . 563) (nil fontified nil 553 . 563) (553 . 563)) nil (26797 27361 393705 0) 0 nil])
([nil nil ((50310 . 50312)) nil (26797 27361 393704 0) 0 nil])
([nil nil ((50399 . 50401)) nil (26797 27361 393704 0) 0 nil])
([nil nil ((50404 . 50406)) nil (26797 27361 393704 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -50724) (undo-tree-id180 . -10) 50734) nil (26797 27361 393703 0) 0 nil])
([nil nil ((50724 . 50733)) nil (26797 27361 393702 0) 0 nil])
([nil nil ((#("header-name" 0 11 (fontified t)) . 50734) (undo-tree-id179 . -11) 50745) nil (26797 27361 393702 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -50734) (undo-tree-id178 . -1) 50735) nil (26797 27361 393701 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50748 . 50749) (nil fontified nil 50738 . 50749) (50738 . 50749)) nil (26797 27361 393700 0) 0 nil])
([nil nil ((#(":test" 0 5 (fontified t)) . 50749)) nil (26797 27361 393699 0) 0 nil])
([nil nil ((#(" #'string" 0 9 (fontified t)) . 50749)) nil (26797 27361 393699 0) 0 nil])
([nil nil ((#("-equal" 0 6 (fontified t)) . 50749)) nil (26797 27361 393698 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -50751) (undo-tree-id177 . -1) 50752) nil (26797 27361 393698 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50729 . 50730) (nil fontified nil 50724 . 50730) (50724 . 50730)) nil (26797 27361 393697 0) 0 nil])
([nil nil ((50730 . 50736)) nil (26797 27361 393696 0) 0 nil])
([nil nil ((#("cdr (assoc " 0 11 (fontified t)) . -50861) (undo-tree-id176 . -11) 50872) nil (26797 27361 393696 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 50882 . 50883) (nil fontified nil 50873 . 50883) (nil fontified nil 50867 . 50873) (nil fontified nil 50866 . 50867) (nil fontified nil 50861 . 50866) (50861 . 50883)) nil (26797 27361 393695 0) 0 nil])
([nil nil ((50883 . 50887)) nil (26797 27361 393694 0) 0 nil])
([nil nil ((50887 . 50888)) nil (26797 27361 393693 0) 0 nil])
([nil nil ((#("form" 0 4 (fontified t)) . -50901) (undo-tree-id175 . -4) 50905) nil (26797 27361 393693 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -50900) (undo-tree-id173 . -1) (undo-tree-id174 . -1) 50901) nil (26797 27361 393692 0) 0 nil])
([nil nil ((50901 . 50914) (#(" " 0 1 (fontified nil)) . 50900) (undo-tree-id172 . -1) (50901 . 50902)) nil (26797 27361 393690 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -50931) (undo-tree-id171 . -1) 50932) nil (26797 27361 393689 0) 0 nil])
([nil nil ((51227 . 51233) (#(" " 0 1 (fontified nil)) . 51226) (undo-tree-id170 . -1) (51227 . 51228)) nil (26797 27361 393686 0) 0 nil])
([nil nil ((51322 . 51324)) nil (26797 27361 393685 0) 0 nil])
([nil nil ((51324 . 51327)) nil (26797 27361 393685 0) 0 nil])
([nil nil ((51327 . 51328)) nil (26797 27361 393684 0) 0 nil])
([nil nil ((51328 . 51331)) nil (26797 27361 393684 0) 0 nil])
([nil nil ((51331 . 51332)) nil (26797 27361 393684 0) 0 nil])
([nil nil ((51332 . 51339)) nil (26797 27361 393683 0) 0 nil])
([nil nil ((51339 . 51340)) nil (26797 27361 393683 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 52053 . 52054) (nil fontified nil 51340 . 52054) (51340 . 52054)) nil (26797 27361 393682 0) 0 nil])
([nil nil ((#("str:starts-with?" 0 16 (fontified t)) . -51701) (undo-tree-id169 . -16) 51717) nil (26797 27361 393682 0) 0 nil])
([nil nil ((51701 . 51709)) nil (26797 27361 393681 0) 0 nil])
([nil nil ((51701 . 51713) (#("lumen.ut" 0 8 (fontified t)) . -51701) (undo-tree-id168 . -8) 51709) nil (26797 27361 393680 0) 0 nil])
([nil nil ((51713 . 51716)) nil (26797 27361 393679 0) 0 nil])
([nil nil ((51701 . 51717) (#("lumen.utils:str" 0 15 (fontified t)) . -51701) (undo-tree-id167 . -15) 51716) nil (26797 27361 393679 0) 0 nil])
([nil nil ((51717 . 51718)) nil (26797 27361 393678 0) 0 nil])
([nil nil ((51701 . 51725) (#("lumen.utils:str-p" 0 17 (fontified t)) . -51701) (undo-tree-id166 . -17) 51718) nil (26797 27361 393677 0) 0 nil])
([nil nil ((564 . 567)) nil (26797 27361 393676 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 615 . 616) (nil fontified nil 615 . 616) (nil fontified nil 598 . 615) (nil fontified nil 597 . 598) (nil fontified nil 581 . 597) (nil fontified nil 580 . 581) (nil fontified nil 568 . 580) (nil fontified nil 567 . 568) (567 . 616)) nil (26797 27361 393675 0) 0 nil])
([nil nil ((#("body" 0 4 (face font-lock-builtin-face fontified t)) . 593)) nil (26797 27361 393674 0) 0 nil])
([nil nil ((593 . 596)) nil (26797 27361 393674 0) 0 nil])
([nil nil ((596 . 597)) nil (26797 27361 393673 0) 0 nil])
([nil nil ((597 . 602)) nil (26797 27361 393673 0) 0 nil])
([nil nil ((597 . 607) (#("jwt-e" 0 5 (fontified t)) . -597) (undo-tree-id165 . -5) 602) nil (26797 27361 393672 0) 0 nil])
([nil nil ((607 . 608)) nil (26797 27361 393671 0) 0 nil])
([nil nil ((608 . 613)) nil (26797 27361 393670 0) 0 nil])
([nil nil ((608 . 618) (#("jwt-d" 0 5 (fontified t)) . -608) (undo-tree-id154 . -5) (undo-tree-id155 . -4) (undo-tree-id156 . -4) (undo-tree-id157 . -4) (undo-tree-id158 . -4) (undo-tree-id159 . -4) (undo-tree-id160 . -4) (undo-tree-id161 . -4) (undo-tree-id162 . -4) (undo-tree-id163 . -5) (undo-tree-id164 . -5) 613) nil (26797 27361 786970 0) 0 nil])
([nil nil ((#(" :parse" 0 1 (fontified t) 1 7 (face font-lock-builtin-face fontified t)) . 618)) nil (26797 27883 958760 0) 0 nil] [nil nil ((#(" :parse-urlencoded)
  (:export :define-middleware :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :*debug* :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :static-many
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
	   :csrf))" 0 1 (fontified t) 1 18 (face font-lock-builtin-face fontified t) 18 19 (rear-nonsticky t fontified t) 19 20 (fontified t) 20 23 (fontified t) 23 30 (face font-lock-builtin-face fontified t) 30 31 (fontified t) 31 49 (face font-lock-builtin-face fontified t) 49 50 (fontified t) 50 61 (face font-lock-builtin-face fontified t) 61 62 (fontified t) 62 68 (face font-lock-builtin-face fontified t) 68 69 (fontified t) 69 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 87 (face font-lock-builtin-face fontified t) 87 88 (fontified t) 88 101 (face font-lock-builtin-face fontified t) 101 106 (fontified t) 106 134 (face font-lock-builtin-face fontified t) 134 135 (fontified t) 135 143 (face font-lock-builtin-face fontified t) 143 144 (fontified t) 144 153 (face font-lock-builtin-face fontified t) 153 154 (fontified t) 154 175 (face font-lock-builtin-face fontified t) 175 180 (fontified t) 180 186 (face font-lock-builtin-face fontified t) 186 187 (fontified t) 187 192 (face font-lock-builtin-face fontified t) 192 193 (fontified t) 193 200 (face font-lock-builtin-face fontified t) 200 201 (fontified t) 201 206 (face font-lock-builtin-face fontified t) 206 207 (fontified t) 207 219 (face font-lock-builtin-face fontified t) 219 224 (fontified t) 224 227 (face font-lock-comment-delimiter-face fontified t) 227 243 (face font-lock-comment-face fontified t) 243 246 (fontified t) 246 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 277 (face font-lock-builtin-face fontified t) 277 278 (fontified t) 278 281 (fontified t) 281 284 (face font-lock-comment-delimiter-face fontified t) 284 292 (face font-lock-comment-face fontified t) 292 295 (fontified t) 295 306 (face font-lock-builtin-face fontified t) 306 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 327 (face font-lock-builtin-face fontified t) 327 328 (fontified t) 328 343 (face font-lock-builtin-face fontified t) 343 344 (fontified t) 344 347 (fontified t) 347 350 (face font-lock-comment-delimiter-face fontified t) 350 355 (face font-lock-comment-face fontified t) 355 358 (fontified t) 358 359 (face font-lock-builtin-face fontified t) 359 362 (face font-lock-builtin-face fontified t) 362 363 (face font-lock-builtin-face fontified t rear-nonsticky t) 363 364 (fontified t) 364 367 (fontified t) 367 370 (face font-lock-comment-delimiter-face fontified t) 370 382 (face font-lock-comment-face fontified t) 382 385 (fontified t) 385 397 (face font-lock-builtin-face fontified t) 397 398 (fontified t) 398 401 (fontified t) 401 402 (face font-lock-builtin-face fontified t) 402 426 (face font-lock-builtin-face fontified t) 426 427 (face font-lock-builtin-face fontified t rear-nonsticky t) 427 428 (fontified t) 428 431 (fontified t) 431 434 (face font-lock-comment-delimiter-face fontified t) 434 442 (face font-lock-comment-face fontified t) 442 446 (fontified t) 446 454 (face font-lock-builtin-face fontified t) 454 455 (fontified t) 455 459 (fontified t) 459 464 (face font-lock-builtin-face fontified t) 464 466 (fontified t)) . 618) (undo-tree-id151 . -20) (undo-tree-id152 . -20) (undo-tree-id153 . -466)) ((618 . 1084)) (26797 27361 393786 0) 0 nil])
([nil nil ((#("-urlencoded" 0 11 (fontified t)) . 618)) nil (26797 27883 958759 0) 0 nil])
([nil nil ((#("

(in-package :lumen.core.middleware)" 0 1 (fontified t) 1 3 (fontified t) 3 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 36 (face font-lock-builtin-face fontified t) 36 37 (fontified t)) . 618) (undo-tree-id150 . -37)) ((618 . 655)) (26797 27361 393657 0) 0 nil])
([nil nil ((608 . 609)) nil (26797 27883 958759 0) 0 nil])
nil
([nil nil ((597 . 598)) nil (26797 27883 958758 0) 0 nil])
([nil nil ((1066 . 1069) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1060) (1060 . 1061) (#("	" 0 1 (fontified nil)) . 1060) (1057 . 1060) (1066 . 1067)) nil (26797 27883 958757 0) 0 nil])
([nil nil ((1069 . 1075)) nil (26797 27883 958756 0) 0 nil])
([nil nil ((1066 . 1070) (#("   " 0 3 (fontified t)) . 1066) 1075) nil (26797 27883 958755 0) 0 nil])
([nil nil ((1076 . 1079)) nil (26797 27883 958753 0) 0 nil])
([nil nil ((52132 . 52133)) nil (26797 27883 958750 0) 0 nil])
([nil nil ((488 . 489) (t 26797 27883 0 0)) nil (26797 28579 736731 0) 0 nil])
([nil nil ((564 . 565) (t 26797 28579 0 0)) nil (26797 28918 120145 0) 0 nil])
([nil nil ((565 . 566)) nil (26797 28918 120144 0) 0 nil])
([nil nil ((nil rear-nonsticky (face) 578 . 579) (nil fontified nil 566 . 579) (566 . 579)) nil (26797 28918 120144 0) 0 nil])
([nil nil ((567 . 574) (#("SESSION" 0 7 (face font-lock-builtin-face fontified t rear-nonsticky (face) slime-repl-output t)) . 567)) nil (26797 28918 120143 0) 0 nil])
([nil nil ((574 . 578) (#("-TTL" 0 4 (face font-lock-builtin-face fontified t rear-nonsticky (face) slime-repl-output t)) . 574)) nil (26797 28918 120143 0) 0 nil])
([nil nil ((578 . 579)) nil (26797 28918 120142 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t slime-repl-output t)) . -578) (undo-tree-id193 . -1) 579) nil (26797 28918 120142 0) 0 nil])
([nil nil ((579 . 580)) nil (26797 28918 120140 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 595 . 596) (nil fontified nil 580 . 596) (580 . 596)) nil (26797 28918 120139 0) 0 nil])
([nil nil ((580 . 581)) nil (26797 28918 120139 0) 0 nil])
([nil nil ((#("!" 0 1 (fontified t)) . -580) (undo-tree-id192 . -1) 581) nil (26797 28918 120138 0) 0 nil])
([nil nil ((580 . 581)) nil (26797 28918 120129 0) 0 nil])
([nil nil ((597 . 598)) nil (26797 28918 120129 0) 0 nil])
([nil nil ((598 . 599)) nil (26797 28918 120129 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 614 . 615) (nil fontified nil 599 . 615) (599 . 615)) nil (26797 28918 120128 0) 0 nil])
([nil nil ((#("session" 0 7 (face font-lock-builtin-face fontified t)) . 600)) nil (26797 28918 120127 0) 0 nil])
([nil nil ((600 . 604)) nil (26797 28918 120126 0) 0 nil])
([nil nil ((604 . 606)) nil (26797 28918 120122 0) 0 nil])
([nil nil ((#("%" 0 1 (fontified t)) . 48388) (t 26797 28918 0 0)) nil (26797 29525 406058 0) 0 nil])
([nil nil ((#(" :wrap nil" 0 1 (fontified t) 1 6 (face font-lock-builtin-face fontified t) 6 10 (fontified t)) . -49915) (undo-tree-id5 . -10) (undo-tree-id6 . -10) (undo-tree-id7 . -10) (undo-tree-id8 . -10) 49925 (t 26797 29525 0 0)) nil (26797 29652 220379 0) 0 nil])
([nil nil ((#("
     " 0 1 (fontified t) 1 6 (fontified t)) . -49902) (undo-tree-id0 . -6) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -6) (undo-tree-id4 . -6) 49908) nil (26797 29652 220373 0) 0 nil])
([nil nil ((40760 . 40761) (t 26797 29652 0 0)) nil (26797 30684 73944 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 42548 . 42549) (nil fontified nil 40761 . 42549) (40761 . 42549)) nil (26797 30684 73943 0) 0 nil])
([nil nil ((42549 . 42550)) nil (26797 30684 73939 0) 0 nil])
([nil nil ((52304 . 52306) (t 26797 30684 0 0)) nil (26797 31245 519742 0) 0 nil])
([nil nil ((52306 . 52312)) nil (26797 31245 519742 0) 0 nil])
([nil nil ((52312 . 52313)) nil (26797 31245 519742 0) 0 nil])
([nil nil ((52313 . 52315)) nil (26797 31245 519741 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -52314) (undo-tree-id10 . -1) 52315) nil (26797 31245 519741 0) 0 nil])
([nil nil ((52314 . 52315)) nil (26797 31245 519739 0) 0 nil])
([nil nil ((52315 . 52317)) nil (26797 31245 519739 0) 0 nil])
([nil nil ((52317 . 52323)) nil (26797 31245 519738 0) 0 nil])
([nil nil ((52323 . 52324)) nil (26797 31245 519738 0) 0 nil])
([nil nil ((52324 . 52327)) nil (26797 31245 519737 0) 0 nil])
([nil nil ((52327 . 52329)) nil (26797 31245 519737 0) 0 nil])
([nil nil ((52329 . 52335)) nil (26797 31245 519736 0) 0 nil])
([nil nil ((52335 . 52336)) nil (26797 31245 519735 0) 0 nil])
([nil nil ((52336 . 52340)) nil (26797 31245 519735 0) 0 nil])
([nil nil ((52327 . 52329)) nil (26797 31245 519735 0) 0 nil])
([nil nil ((52329 . 52335)) nil (26797 31245 519734 0) 0 nil])
([nil nil ((52335 . 52336)) nil (26797 31245 519734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 52377 . 52378) (nil fontified nil 52377 . 52378) (nil fontified nil 52372 . 52377) (nil fontified nil 52336 . 52372) (52336 . 52378)) nil (26797 31245 519733 0) 0 nil])
([nil nil ((52378 . 52379)) nil (26797 31245 519733 0) 0 nil])
([nil nil ((53056 . 53059)) nil (26797 31245 519732 0) 0 nil])
([nil nil ((53059 . 53065)) nil (26797 31245 519732 0) 0 nil])
([nil nil ((53065 . 53066)) nil (26797 31245 519731 0) 0 nil])
([nil nil ((53066 . 53071)) nil (26797 31245 519731 0) 0 nil])
([nil nil ((53071 . 53074)) nil (26797 31245 519730 0) 0 nil])
([nil nil ((53074 . 53079)) nil (26797 31245 519730 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -53078) (undo-tree-id9 . -1) 53079) nil (26797 31245 519729 0) 0 nil])
([nil nil ((53078 . 53080)) nil (26797 31245 519720 0) 0 nil])
([nil nil ((53080 . 53081)) nil (26797 31245 519720 0) 0 nil])
([nil nil ((53081 . 53085)) nil (26797 31245 519719 0) 0 nil])
([nil nil ((53085 . 53088)) nil (26797 31245 519718 0) 0 nil])
([nil nil ((53088 . 53094)) nil (26797 31245 519718 0) 0 nil])
([nil nil ((53094 . 53095)) nil (26797 31245 519718 0) 0 nil])
([nil nil ((53095 . 53103)) nil (26797 31245 519717 0) 0 nil])
([nil nil ((53103 . 53106)) nil (26797 31245 519716 0) 0 nil])
([nil nil ((53106 . 53112)) nil (26797 31245 519715 0) 0 nil])
([nil nil ((53112 . 53113)) nil (26797 31245 519714 0) 0 nil])
([nil nil ((53113 . 53118)) nil (26797 31245 519711 0) 0 nil])
([nil nil ((53366 . 53368) (t 26797 31245 0 0)) nil (26797 32269 587643 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55072 . 55073) (nil fontified nil 53368 . 55073) (53368 . 55073)) nil (26797 32269 587642 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -55072) (undo-tree-id16 . -1) 55073) nil (26797 32269 587641 0) 0 nil])
([nil nil ((#("(print m)
	(print ok)
	(print (lumen.core.session:session-get req :csrf))
	(print tok)" 0 10 (fontified t) 10 22 (fontified t) 22 30 (fontified t) 30 66 (fontified t) 66 71 (face font-lock-builtin-face fontified t) 71 72 (rear-nonsticky t fontified t) 72 73 (fontified t) 73 74 (fontified t) 74 86 (fontified t)) . 52306) (undo-tree-id15 . -86) 52392) nil (26797 32269 587640 0) 0 nil])
([nil nil ((53913 . 53915)) nil (26797 32269 587639 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 54000 . 54001) (nil fontified nil 53989 . 54001) (nil fontified nil 53988 . 53989) (nil fontified nil 53987 . 53988) (nil fontified nil 53986 . 53987) (nil fontified nil 53981 . 53986) (nil fontified nil 53945 . 53981) (nil fontified nil 53937 . 53945) (nil fontified nil 53925 . 53937) (nil fontified nil 53915 . 53925) (53915 . 54001)) nil (26797 32269 587638 0) 0 nil])
([nil nil ((#("m" 0 1 (fontified t)) . -53922) (undo-tree-id14 . -1) 53923) nil (26797 32269 587637 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 53927 . 53928) (nil fontified nil 53922 . 53928) (53922 . 53928)) nil (26797 32269 587635 0) 0 nil])
([nil nil ((#("ok" 0 2 (fontified t)) . -53938) (undo-tree-id13 . -2) 53940) nil (26797 32269 587635 0) 0 nil])
([nil nil ((53938 . 53941)) nil (26797 32269 587634 0) 0 nil])
([nil nil ((53941 . 53942)) nil (26797 32269 587633 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . -53941) (undo-tree-id12 . -1) 53942) nil (26797 32269 587633 0) 0 nil])
([nil nil ((53941 . 53942)) nil (26797 32269 587631 0) 0 nil])
([nil nil ((#("(print \"OK\")
		(print hdr)
		(print hdr-tok)
		(print form)" 0 7 (fontified t) 7 11 (face font-lock-string-face fontified t) 11 13 (fontified t) 13 27 (fontified t) 27 45 (fontified t) 45 59 (fontified t)) . 52973) (undo-tree-id11 . -59) 53032) nil (26797 32269 587712 0) 0 nil])
([nil nil ((54441 . 54447)) nil (26797 32282 121368 0) 0 nil] [nil nil ((nil rear-nonsticky nil 54499 . 54500) (nil fontified nil 54486 . 54500) (nil fontified nil 54468 . 54486) (nil fontified nil 54454 . 54468) (nil fontified nil 54452 . 54454) (nil fontified nil 54448 . 54452) (nil fontified nil 54441 . 54448) (54441 . 54500)) ((#("(print \"OK\")
		(print hdr)
		(print hdr-tok)
		(print form)" 0 7 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified nil) 7 11 (help-echo "Easy to misread; consider moving the element to the next line" face (font-lock-warning-face font-lock-string-face) fontified nil) 11 12 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified nil) 12 13 (fontified nil) 13 27 (fontified nil) 27 45 (fontified nil) 45 58 (fontified nil) 58 59 (rear-nonsticky nil fontified nil)) . 54441) (undo-tree-id17 . -59) (undo-tree-id18 . -45) (nil fontified t 54453 . 54454) (nil fontified t 54452 . 54453) (nil fontified t 54454 . 54468) (nil fontified t 54468 . 54486) (nil rear-nonsticky t 54499 . 54500)) (26797 32269 587619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 54505 . 54506) (nil fontified nil 54492 . 54506) (nil fontified nil 54474 . 54492) (nil fontified nil 54460 . 54474) (nil fontified nil 54458 . 54460) (nil fontified nil 54454 . 54458) (nil fontified nil 54447 . 54454) (54447 . 54506)) nil (26797 32282 121367 0) 0 nil])
nil
([nil nil ((#("
(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\"))
  (lambda (next)
    (lambda (req)
      ;; s'assurer qu'on a une session (middleware session avant csrf)
      (let* ((m  (lumen.core.http:req-method req))
             (ok (member m methods :test #'string=))
             (tok (or (lumen.core.session:session-get req :csrf)
                      (let ((tkn (%random-token)))
                        (lumen.core.session:session-set! req :csrf tkn) tkn))))
	
        ;; dÃ©poser/rafraÃ®chir le cookie token (lecture cÃ´tÃ© front)
        (let ((resp (funcall next req)))
          (set-cookie! resp cookie-name tok :path path :http-only nil)
          (if (not ok)
              resp
              (let* ((hdr (lumen.core.http:req-headers req))
                     (hdr-tok (lumen.utils:alist-get hdr header-name))
                     (form (lumen.core.http:ctx-get req :form))
                     (field-tok (lumen.utils:alist-get form \"csrf_token\"
						       :test #'string=))
                     (match (or (and hdr-tok (string= hdr-tok tok))
                                (and field-tok (string= field-tok tok)))))
		
                (if match
                    resp
                    (lumen.core.http:respond-json
                     '((:error . ((:type . \"csrf\")
				  (:message . \"invalid or missing CSRF token\"))))
                     :status 403)))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 14 (fontified t) 14 18 (face font-lock-type-face fontified t) 18 32 (fontified t) 32 44 (face font-lock-string-face fontified t) 44 77 (fontified t) 77 91 (face font-lock-string-face fontified t) 91 122 (fontified t) 122 128 (face font-lock-string-face fontified t) 128 129 (fontified t) 129 134 (face font-lock-string-face fontified t) 134 135 (fontified t) 135 142 (face font-lock-string-face fontified t) 142 143 (fontified t) 143 151 (face font-lock-string-face fontified t) 151 178 (fontified t) 178 181 (face font-lock-string-face fontified t) 181 187 (fontified t) 187 193 (face font-lock-keyword-face fontified t) 193 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 225 (fontified t) 225 228 (face font-lock-comment-delimiter-face fontified t) 228 290 (face font-lock-comment-face fontified t) 290 297 (fontified t) 297 301 (face font-lock-keyword-face fontified t) 301 376 (fontified t) 376 381 (face font-lock-builtin-face fontified t) 381 452 (fontified t) 452 457 (face font-lock-builtin-face fontified t) 457 482 (fontified t) 482 485 (face font-lock-keyword-face fontified t) 485 510 (fontified t) 510 571 (fontified t) 571 576 (face font-lock-builtin-face fontified t) 576 590 (fontified t) 590 591 (fontified t) 591 592 (fontified t) 592 600 (fontified t) 600 603 (face font-lock-comment-delimiter-face fontified t) 603 659 (face font-lock-comment-face fontified t) 659 668 (fontified t) 668 671 (face font-lock-keyword-face fontified t) 671 744 (fontified t) 744 749 (face font-lock-builtin-face fontified t) 749 755 (fontified t) 755 765 (face font-lock-builtin-face fontified t) 765 782 (fontified t) 782 784 (face font-lock-keyword-face fontified t) 784 828 (fontified t) 828 832 (face font-lock-keyword-face fontified t) 832 1001 (fontified t) 1001 1006 (face font-lock-builtin-face fontified t) 1006 1035 (fontified t) 1035 1069 (fontified t) 1069 1081 (face font-lock-string-face fontified t) 1081 1082 (fontified t) 1082 1095 (fontified t) 1095 1100 (face font-lock-builtin-face fontified t) 1100 1181 (fontified t) 1181 1256 (fontified t) 1256 1258 (fontified t) 1258 1259 (fontified t) 1259 1276 (fontified t) 1276 1278 (fontified t face font-lock-keyword-face) 1278 1384 (fontified t) 1384 1390 (fontified t face font-lock-builtin-face) 1390 1395 (fontified t) 1395 1400 (fontified t face font-lock-builtin-face) 1400 1403 (fontified t) 1403 1409 (fontified t face font-lock-string-face) 1409 1418 (fontified t) 1418 1426 (fontified t face font-lock-builtin-face) 1426 1429 (fontified t) 1429 1460 (fontified t face font-lock-string-face) 1460 1465 (fontified t) 1465 1485 (fontified t) 1485 1486 (fontified t) 1486 1493 (face font-lock-builtin-face fontified t) 1493 1505 (fontified t) 1505 1506 (fontified t)) . 51715) (undo-tree-id19 . -1506) (undo-tree-id20 . -340) (undo-tree-id21 . -416) (undo-tree-id22 . -1154) (undo-tree-id23 . -591) (undo-tree-id24 . -1258) (undo-tree-id25 . -1) (undo-tree-id26 . -1465) (undo-tree-id27 . -1506) (undo-tree-id28 . -1506) (undo-tree-id29 . -1506) (undo-tree-id30 . -1506) (undo-tree-id31 . -200) (undo-tree-id32 . -200) (undo-tree-id33 . -200) (undo-tree-id34 . -200) (undo-tree-id35 . -200) (undo-tree-id36 . -200) (undo-tree-id37 . -109)) nil (26797 32282 121365 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 51715)) nil (26797 32282 121339 0) 0 nil])
([nil nil ((52253 . 52255) (t 26797 32282 0 0)) nil (26797 32308 60258 0) 0 nil])
([nil nil ((52342 . 52344)) nil (26797 32308 60256 0) 0 nil])
([nil nil ((52347 . 52349)) nil (26797 32308 60253 0) 0 nil])
([nil nil ((53586 . 53588) (t 26797 32308 0 0)) nil (26797 33048 286642 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55755 . 55756) (nil fontified nil 53588 . 55756) (53588 . 55756)) nil (26797 33048 286642 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -55755) (undo-tree-id50 . -1) 55756) nil (26797 33048 286641 0) 0 nil])
([nil nil ((#("(print method)
	(print mut?)
	(print (lumen.core.session:session-get req :csrf))
	(print tok)" 0 7 (fontified t) 7 12 (fontified t) 12 13 (fontified t rear-nonsticky t) 13 15 (fontified t) 15 29 (fontified t) 29 37 (fontified t) 37 73 (fontified t) 73 78 (face font-lock-builtin-face fontified t) 78 79 (fontified t rear-nonsticky t) 79 80 (fontified t) 80 81 (fontified t) 81 92 (fontified t) 92 93 (fontified t rear-nonsticky t)) . 52355) (undo-tree-id49 . -93) 52448) nil (26797 33048 286640 0) 0 nil])
([nil nil ((54136 . 54138)) nil (26797 33048 286639 0) 0 nil])
([nil nil ((nil fontified nil 54230 . 54231) (nil fontified nil 54219 . 54230) (nil fontified nil 54218 . 54219) (nil fontified nil 54217 . 54218) (nil fontified nil 54216 . 54217) (nil fontified nil 54211 . 54216) (nil fontified nil 54175 . 54211) (nil fontified nil 54167 . 54175) (nil fontified nil 54153 . 54167) (nil fontified nil 54151 . 54153) (nil fontified nil 54150 . 54151) (nil fontified nil 54145 . 54150) (nil fontified nil 54138 . 54145) (54138 . 54231)) nil (26797 33048 286638 0) 0 nil])
([nil nil ((54129 . 54131)) nil (26797 33048 286636 0) 0 nil])
([nil nil ((54134 . 54136)) nil (26797 33048 286636 0) 0 nil])
([nil nil ((54042 . 54044)) nil (26797 33048 286635 0) 0 nil])
([nil nil ((#("(print \"OK\")
		(print hdr)
		(print hdr-tok)
		(print form)" 0 7 (fontified t) 7 11 (fontified t face font-lock-string-face) 11 13 (fontified t) 13 27 (fontified t) 27 45 (fontified t) 45 58 (fontified t) 58 59 (fontified t rear-nonsticky t)) . 52853) (undo-tree-id48 . -59) 52912) nil (26797 33048 286634 0) 0 nil])
([nil nil ((54708 . 54716)) nil (26797 33048 286633 0) 0 nil])
([nil nil ((nil fontified nil 54774 . 54775) (nil fontified nil 54761 . 54774) (nil fontified nil 54743 . 54761) (nil fontified nil 54729 . 54743) (nil fontified nil 54727 . 54729) (nil fontified nil 54723 . 54727) (nil fontified nil 54716 . 54723) (54716 . 54775)) nil (26797 33048 286632 0) 0 nil])
([nil nil ((#("
(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\"))
  (lambda (next)
    (lambda (req)
      ;; Assure session (middleware :session doit Ãªtre avant)
      (let* ((method (lumen.core.http:req-method req))
             (mut?   (member method methods :test #'string=))
             ;; token en session ou crÃ©ation
             (tok (or (lumen.core.session:session-get req :csrf)
                      (let ((tkn (%random-token)))
                        (lumen.core.session:session-set! req :csrf tkn) tkn))))
	
        ;; 1) VÃ©rifier AVANT dâ€™appeler next si mÃ©thode mutable
        (when mut?
          (let* ((hdr (lumen.core.http:req-headers req))
                 (hdr-tok (cdr (assoc header-name hdr :test #'string-equal)))
                 (form    (lumen.core.http:ctx-get req :form))
                 (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                 (match (or (and hdr-tok (string= hdr-tok tok))
                            (and field-tok (string= field-tok tok)))))
	    
            (unless match
              (return-from csrf
                (lambda (_req)
                  (declare (ignore _req))
                  (lumen.core.http:respond-json
                   '((:error . ((:type . \"csrf\")
                                (:message . \"invalid or missing CSRF token\"))))
                   :status 403))))))

        ;; 2) Appeler le handler
        (let ((resp (funcall next req)))
          ;; 3) Poser/rafraÃ®chir le cookie CSRF (lisible cÃ´tÃ© client)
          (set-cookie! resp cookie-name tok :path path :http-only nil)
          resp)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 14 (fontified t) 14 18 (face font-lock-type-face fontified t) 18 32 (fontified t) 32 44 (face font-lock-string-face fontified t) 44 77 (fontified t) 77 91 (face font-lock-string-face fontified t) 91 122 (fontified t) 122 128 (face font-lock-string-face fontified t) 128 129 (fontified t) 129 134 (face font-lock-string-face fontified t) 134 135 (fontified t) 135 142 (face font-lock-string-face fontified t) 142 143 (fontified t) 143 151 (face font-lock-string-face fontified t) 151 178 (fontified t) 178 181 (face font-lock-string-face fontified t) 181 187 (fontified t) 187 193 (face font-lock-keyword-face fontified t) 193 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 225 (fontified t) 225 228 (face font-lock-comment-delimiter-face fontified t) 228 281 (face font-lock-comment-face fontified t) 281 288 (fontified t) 288 292 (face font-lock-keyword-face fontified t) 292 380 (fontified t) 380 385 (face font-lock-builtin-face fontified t) 385 411 (fontified t) 411 414 (face font-lock-comment-delimiter-face fontified t) 414 443 (face font-lock-comment-face fontified t) 443 501 (fontified t) 501 506 (face font-lock-builtin-face fontified t) 506 508 (fontified t) 508 531 (fontified t) 531 534 (face font-lock-keyword-face fontified t) 534 559 (fontified t) 559 620 (fontified t) 620 625 (face font-lock-builtin-face fontified t) 625 639 (fontified t) 639 640 (fontified t) 640 641 (fontified t) 641 649 (fontified t) 649 652 (face font-lock-comment-delimiter-face fontified t) 652 704 (face font-lock-comment-face fontified t) 704 713 (fontified t) 713 717 (face font-lock-keyword-face fontified t) 717 734 (fontified t) 734 738 (face font-lock-keyword-face fontified t) 738 834 (fontified t) 834 839 (face font-lock-builtin-face fontified t) 839 913 (fontified t) 913 918 (face font-lock-builtin-face fontified t) 918 961 (fontified t) 961 973 (face font-lock-string-face fontified t) 973 979 (fontified t) 979 984 (face font-lock-builtin-face fontified t) 984 1062 (fontified t) 1062 1123 (fontified t) 1123 1133 (fontified t) 1133 1138 (fontified t) 1138 1139 (fontified t) 1139 1152 (fontified t) 1152 1158 (fontified t face font-lock-keyword-face) 1158 1180 (fontified t) 1180 1191 (fontified t face font-lock-keyword-face) 1191 1214 (fontified t) 1214 1220 (fontified t face font-lock-keyword-face) 1220 1247 (fontified t) 1247 1254 (fontified t face font-lock-keyword-face) 1254 1340 (fontified t) 1340 1346 (fontified t face font-lock-builtin-face) 1346 1351 (fontified t) 1351 1354 (fontified t face font-lock-builtin-face) 1354 1355 (fontified t face font-lock-builtin-face) 1355 1356 (fontified t face font-lock-builtin-face) 1356 1359 (fontified t) 1359 1365 (fontified t face font-lock-string-face) 1365 1367 (fontified t) 1367 1400 (fontified t) 1400 1408 (fontified t face font-lock-builtin-face) 1408 1411 (fontified t) 1411 1420 (fontified t face font-lock-string-face) 1420 1442 (fontified t face font-lock-string-face) 1442 1447 (fontified t) 1447 1466 (fontified t) 1466 1473 (fontified t face font-lock-builtin-face) 1473 1493 (fontified t) 1493 1496 (fontified t face font-lock-comment-delimiter-face) 1496 1515 (fontified t face font-lock-comment-face) 1515 1518 (fontified t face font-lock-comment-face) 1518 1527 (fontified t) 1527 1530 (fontified t face font-lock-keyword-face) 1530 1569 (fontified t) 1569 1572 (fontified t face font-lock-comment-delimiter-face) 1572 1629 (fontified t face font-lock-comment-face) 1629 1673 (fontified t) 1673 1678 (face font-lock-builtin-face fontified t) 1678 1684 (fontified t) 1684 1694 (face font-lock-builtin-face fontified t) 1694 1700 (fontified t) 1700 1719 (fontified t)) . 51715) (undo-tree-id38 . -1719) (undo-tree-id39 . -1) (undo-tree-id40 . -295) (undo-tree-id41 . -1132) (undo-tree-id42 . -634) (undo-tree-id43 . -537) (undo-tree-id44 . -538) (undo-tree-id45 . -640) (undo-tree-id46 . -1138) (undo-tree-id47 . -1719)) nil (26797 33048 286630 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 51715)) nil (26797 33048 286612 0) 0 nil])
([nil nil ((52676 . 52682) (t 26797 33048 0 0)) nil (26797 34997 996484 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 53017 . 53018) (nil fontified nil 52682 . 53018) (52682 . 53018)) nil (26797 34997 996483 0) 0 nil])
([nil nil ((#("
                   (hdr-tok (cdr (assoc header-name hdr :test #'string-equal)))" 0 1 (fontified t) 1 57 (fontified t) 57 62 (face font-lock-builtin-face fontified t) 62 80 (fontified t)) . 52596) (undo-tree-id62 . -80)) nil (26797 34997 996483 0) 0 nil])
([nil nil ((#("	" 0 1 (fontified nil)) . -53275) (53275 . 53276) (#("	" 0 1 (fontified nil)) . 53275) (53269 . 53275) (#("	" 0 1 (fontified nil)) . -53252) (53252 . 53253) (#("	" 0 1 (fontified nil)) . 53252) (53246 . 53252) (#("	" 0 1 (fontified nil)) . -53233) (53233 . 53234) (#("	" 0 1 (fontified nil)) . 53233) (53227 . 53233) (52880 . 52884) (#("                    " 0 20 (fontified t)) . 52880) (52800 . 52804) (#("                    " 0 20 (fontified t)) . 52800) (52738 . 52743) (#("       " 0 7 (fontified t)) . 52738) (52654 . 52659) (#("       " 0 7 (fontified t)) . 52654) (#("   " 0 3 (fontified t)) . -51878) (#("   " 0 3 (fontified t)) . -51820) (#("   " 0 3 (fontified t)) . -51776) 51716) nil (26797 34997 996481 0) 0 nil])
([nil nil ((51714 . 51716)) nil (26797 34997 996479 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 54911 . 54912) (nil fontified nil 51716 . 54912) (51716 . 54912)) nil (26797 34997 996478 0) 0 nil])
([nil nil ((#("

(defun csrf (&key (cookie-name \"csrf_token\")
               (header-name \"x-csrf-token\")
               (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
               (path \"/\"))
  (lambda (next)
    (lambda (req)
      ;; (1) session requise (middleware :session doit Ãªtre avant)
      (let* ((method (lumen.core.http:req-method req))
             (mut?   (member method methods :test #'string=))
             ;; token en session (crÃ©Ã© si absent)
             (tok (or (lumen.core.session:session-get req :csrf)
                      (let ((tkn (%random-token)))
                        (lumen.core.session:session-set! req :csrf tkn) tkn))))
	(print method)
	(print mut?)
	(print (lumen.core.session:session-get req :csrf))
	(print tok)
        (if mut?
            ;; MÃ©thode mutable â†’ valider AVANT d'appeler next
            (let* ((hdr (lumen.core.http:req-headers req))
		   (hdr-raw (cdr (assoc header-name hdr :test #'string-equal)))
		   ;; si le header vaut \"csrf_token\", on va lire la vraie valeur dans les cookies
		   (hdr-tok (if (and hdr-raw (string= hdr-raw cookie-name))
				(cdr (assoc cookie-name (lumen.core.http:req-cookies req) :test #'string=))
				hdr-raw))
                   (form    (lumen.core.http:ctx-get req :form)) ; nÃ©cessite form-parser AVANT csrf
                   (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                   (ok (or (and hdr-tok (string= hdr-tok tok))
                           (and field-tok (string= field-tok tok)))))
	      (print \"OK\")
	      (print hdr)
	      (print hdr-tok)
	      (print form)
              (if ok
                  (let ((resp (funcall next req)))
                    ;; RafraÃ®chir/exposer le cookie cÃ´tÃ© client
                    (set-cookie! resp cookie-name tok :path path :http-only nil)
                    resp)
                  ;; Token manquant/incorrect â†’ 403 immÃ©diat (sans RETURN-FROM)
                  (let ((resp (lumen.core.http:respond-json
                               '((:error . ((:type . \"csrf\")
                                            (:message . \"invalid or missing CSRF token\"))))
                               :status 403)))
                    ;; On en profite pour (rÃ©)Ã©mettre le cookie pour que le client lâ€™ait
                    (set-cookie! resp cookie-name tok :path path :http-only nil)
                    resp)))
            ;; MÃ©thode non mutable â†’ laisser passer et poser le cookie
            (let ((resp (funcall next req)))
              (set-cookie! resp cookie-name tok :path path :http-only nil)
              resp))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 13 (face font-lock-function-name-face fontified t) 13 15 (fontified t) 15 19 (face font-lock-type-face fontified t) 19 33 (fontified t) 33 45 (face font-lock-string-face fontified t) 45 47 (fontified t) 47 75 (fontified t) 75 89 (face font-lock-string-face fontified t) 89 91 (fontified t) 91 117 (fontified t) 117 123 (face font-lock-string-face fontified t) 123 124 (fontified t) 124 129 (face font-lock-string-face fontified t) 129 130 (fontified t) 130 137 (face font-lock-string-face fontified t) 137 138 (fontified t) 138 146 (face font-lock-string-face fontified t) 146 149 (fontified t) 149 170 (fontified t) 170 173 (face font-lock-string-face fontified t) 173 176 (fontified t) 176 179 (fontified t) 179 185 (face font-lock-keyword-face fontified t) 185 198 (fontified t) 198 204 (face font-lock-keyword-face fontified t) 204 217 (fontified t) 217 220 (face font-lock-comment-delimiter-face fontified t) 220 278 (face font-lock-comment-face fontified t) 278 285 (fontified t) 285 289 (face font-lock-keyword-face fontified t) 289 377 (fontified t) 377 382 (face font-lock-builtin-face fontified t) 382 408 (fontified t) 408 411 (face font-lock-comment-delimiter-face fontified t) 411 445 (face font-lock-comment-face fontified t) 445 503 (fontified t) 503 508 (face font-lock-builtin-face fontified t) 508 510 (fontified t) 510 533 (fontified t) 533 536 (face font-lock-keyword-face fontified t) 536 561 (fontified t) 561 622 (fontified t) 622 627 (face font-lock-builtin-face fontified t) 627 641 (fontified t) 641 642 (fontified t) 642 649 (fontified t) 649 654 (fontified t) 654 655 (fontified t rear-nonsticky t) 655 657 (fontified t) 657 671 (fontified t) 671 679 (fontified t) 679 715 (fontified t) 715 720 (face font-lock-builtin-face fontified t) 720 721 (fontified t rear-nonsticky t) 721 722 (fontified t) 722 723 (fontified t) 723 734 (fontified t) 734 735 (fontified t rear-nonsticky t) 735 736 (fontified t) 736 745 (fontified t) 745 747 (face font-lock-keyword-face fontified t) 747 765 (fontified t) 765 768 (face font-lock-comment-delimiter-face fontified t) 768 815 (face font-lock-comment-face fontified t) 815 828 (fontified t) 828 832 (face font-lock-keyword-face fontified t) 832 873 (fontified t) 873 874 (fontified t) 874 879 (fontified t) 879 916 (fontified t) 916 921 (face font-lock-builtin-face fontified t) 921 940 (fontified t) 940 945 (fontified t) 945 948 (face font-lock-comment-delimiter-face fontified t) 948 1024 (face font-lock-comment-face fontified t) 1024 1029 (fontified t) 1029 1039 (fontified t) 1039 1041 (face font-lock-keyword-face fontified t) 1041 1090 (fontified t) 1090 1148 (fontified t) 1148 1153 (face font-lock-builtin-face fontified t) 1153 1170 (fontified t) 1170 1178 (fontified t) 1178 1179 (fontified t rear-nonsticky t) 1179 1180 (fontified t) 1180 1191 (fontified t) 1191 1237 (fontified t) 1237 1242 (face font-lock-builtin-face fontified t) 1242 1245 (fontified t) 1245 1280 (face font-lock-comment-face fontified t) 1280 1322 (fontified t) 1322 1334 (face font-lock-string-face fontified t) 1334 1340 (fontified t) 1340 1345 (face font-lock-builtin-face fontified t) 1345 1422 (fontified t) 1422 1492 (fontified t) 1492 1499 (fontified t) 1499 1501 (fontified t) 1501 1506 (fontified t) 1506 1510 (face font-lock-string-face fontified t) 1510 1512 (fontified t) 1512 1531 (fontified t) 1531 1547 (fontified t) 1547 1554 (fontified t) 1554 1572 (fontified t) 1572 1573 (fontified t rear-nonsticky t) 1573 1574 (fontified t) 1574 1589 (fontified t) 1589 1591 (face font-lock-keyword-face fontified t) 1591 1614 (fontified t) 1614 1617 (face font-lock-keyword-face fontified t) 1617 1666 (fontified t) 1666 1669 (face font-lock-comment-delimiter-face fontified t) 1669 1710 (face font-lock-comment-face fontified t) 1710 1734 (fontified t) 1734 1764 (fontified t) 1764 1769 (face font-lock-builtin-face fontified t) 1769 1775 (fontified t) 1775 1785 (face font-lock-builtin-face fontified t) 1785 1791 (fontified t) 1791 1835 (fontified t) 1835 1838 (face font-lock-comment-delimiter-face fontified t) 1838 1897 (face font-lock-comment-face fontified t) 1897 1902 (fontified t) 1902 1916 (fontified t) 1916 1919 (face font-lock-keyword-face fontified t) 1919 1957 (fontified t) 1957 1991 (fontified t) 1991 1997 (face font-lock-builtin-face fontified t) 1997 2002 (fontified t) 2002 2007 (face font-lock-builtin-face fontified t) 2007 2010 (fontified t) 2010 2016 (face font-lock-string-face fontified t) 2016 2063 (fontified t) 2063 2071 (face font-lock-builtin-face fontified t) 2071 2074 (fontified t) 2074 2105 (face font-lock-string-face fontified t) 2105 2141 (fontified t) 2141 2148 (face font-lock-builtin-face fontified t) 2148 2176 (fontified t) 2176 2179 (face font-lock-comment-delimiter-face fontified t) 2179 2245 (face font-lock-comment-face fontified t) 2245 2299 (fontified t) 2299 2304 (face font-lock-builtin-face fontified t) 2304 2310 (fontified t) 2310 2320 (face font-lock-builtin-face fontified t) 2320 2353 (fontified t) 2353 2354 (fontified t) 2354 2366 (fontified t) 2366 2369 (face font-lock-comment-delimiter-face fontified t) 2369 2425 (face font-lock-comment-face fontified t) 2425 2438 (fontified t) 2438 2441 (face font-lock-keyword-face fontified t) 2441 2449 (fontified t) 2449 2466 (fontified t) 2466 2470 (fontified t) 2470 2518 (fontified t) 2518 2523 (face font-lock-builtin-face fontified t) 2523 2529 (fontified t) 2529 2539 (face font-lock-builtin-face fontified t) 2539 2544 (fontified t) 2544 2545 (fontified t) 2545 2569 (fontified t) 2569 2570 (fontified t)) . -54912) (undo-tree-id58 . -1) (undo-tree-id59 . -1422) (undo-tree-id60 . -817) (undo-tree-id61 . -2570) 57482) nil (26797 34997 996477 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -54911) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) 54912) nil (26797 34997 996475 0) 0 nil])
([nil nil ((54911 . 54914)) nil (26797 34997 996472 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -54911) (undo-tree-id51 . -1) (#(" " 0 1 (fontified t)) . -54912) (undo-tree-id52 . -1) (#(" " 0 1 (fontified t)) . -54913) (undo-tree-id53 . -1) 54914) nil (26797 34997 996470 0) 0 nil])
([nil nil ((54911 . 54914)) nil (26797 34997 996459 0) 0 nil])
([nil nil ((54911 . 54912)) nil (26797 34997 996456 0) 0 nil])
([nil nil ((53030 . 53032) (t 26797 34997 0 0)) nil (26797 35117 138133 0) 0 nil])
([nil nil ((53121 . 53123)) nil (26797 35117 138132 0) 0 nil])
([nil nil ((53126 . 53128)) nil (26797 35117 138129 0) 0 nil])
([nil nil ((55661 . 55662) (t 26797 35117 0 0)) nil (26797 52679 701880 0) 0 nil])
([nil nil ((55662 . 55665)) nil (26797 52679 701879 0) 0 nil])
([nil nil ((55665 . 55666)) nil (26797 52679 701878 0) 0 nil])
([nil nil ((55666 . 55671)) nil (26797 52679 701878 0) 0 nil])
([nil nil ((55671 . 55672)) nil (26797 52679 701877 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60323 . 60324) (nil fontified nil 55672 . 60324) (55672 . 60324)) nil (26797 52679 701877 0) 0 nil])
([nil nil ((1130 . 1135)) nil (26797 52679 701876 0) 0 nil])
([nil nil ((1135 . 1136)) nil (26797 52679 701876 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1149 . 1150) (nil fontified nil 1136 . 1150) (1136 . 1150)) nil (26797 52679 701875 0) 0 nil])
([nil nil ((60344 . 60345)) nil (26797 52679 701871 0) 0 nil])
([nil nil ((#("lumen.core.util" 0 15 (fontified t)) . -59757) (t 26797 52679 0 0) (59772 . 59783) (t 26797 52679 0 0)) nil (26797 52804 417407 0) 0 nil])
([nil nil ((#("(getf " 0 6 (fontified t)) . -30852) (undo-tree-id64 . -6) 30858 (t 26797 52804 0 0)) nil (26797 53018 767051 0) 0 nil])
([nil nil ((#("req" 0 3 (fontified t)) . -30869) (undo-tree-id63 . -3) 30872) nil (26797 53018 767047 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . 30869)) nil (26797 53018 767032 0) 0 nil])
([nil nil ((30872 . 30876)) nil (26797 53018 767030 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . 30880)) nil (26797 53018 767024 0) 0 nil])
([nil nil ((60334 . 60335) (t 26797 53018 0 0)) nil (26798 52308 232495 0) 0 nil])
([nil nil ((60335 . 60338)) nil (26798 52308 232494 0) 0 nil])
([nil nil ((60338 . 60339)) nil (26798 52308 232493 0) 0 nil])
([nil nil ((60339 . 60340)) nil (26798 52308 232493 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-comment-face fontified t)) . -60339) (undo-tree-id117 . -1) 60340) nil (26798 52308 232493 0) 0 nil])
([nil nil ((60339 . 60343)) nil (26798 52308 232492 0) 0 nil])
([nil nil ((60343 . 60344)) nil (26798 52308 232491 0) 0 nil])
([nil nil ((60344 . 60347)) nil (26798 52308 232491 0) 0 nil])
([nil nil ((60347 . 60348)) nil (26798 52308 232491 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 61361 . 61362) (nil fontified nil 60348 . 61362) (60348 . 61362)) nil (26798 52308 232490 0) 0 nil])
([nil nil ((#("U" 0 1 (face font-lock-comment-face fontified t)) . 60340)) nil (26798 52308 232490 0) 0 nil])
([nil nil ((60340 . 60341)) nil (26798 52308 232489 0) 0 nil])
([nil nil ((60568 . 60573) (60474 . 60477) (60452 . 60455) (60407 . 60413) (60389 . 60393) (60372 . 60374) 60348) nil (26798 52308 232489 0) 0 nil])
([nil nil ((60891 . 60896) (60867 . 60872) (60810 . 60811) (60716 . 60722) (60662 . 60668) (60644 . 60648) (60627 . 60629) 60592) nil (26798 52308 232488 0) 0 nil])
([nil nil ((60537 . 60548) (#(" " 0 1 (fontified nil)) . 60536) (undo-tree-id116 . -1) (60537 . 60538)) nil (26798 52308 232487 0) 0 nil])
([nil nil ((60776 . 60780) (#(" " 0 1 (fontified nil)) . 60775) (undo-tree-id115 . -1) (60776 . 60777)) nil (26798 52308 232485 0) 0 nil])
([nil nil ((60971 . 60984) (#(" " 0 1 (fontified nil)) . 60970) (undo-tree-id114 . -1) (60971 . 60972)) nil (26798 52308 232484 0) 0 nil])
([nil nil ((61012 . 61019) (#(" " 0 1 (fontified nil)) . 61012) (61011 . 61012)) nil (26798 52308 232483 0) 0 nil])
([nil nil ((61362 . 61367) (61338 . 61343) (61286 . 61289) (61263 . 61264) (61165 . 61171) (61111 . 61117) (61093 . 61097) (61076 . 61078) 61039) nil (26798 52308 232482 0) 0 nil])
([nil nil ((61216 . 61220) (#(" " 0 1 (fontified nil)) . 61215) (undo-tree-id113 . -1) (61216 . 61217)) nil (26798 52308 232481 0) 0 nil])
([nil nil ((61431 . 61444) (#(" " 0 1 (fontified nil)) . 61430) (undo-tree-id112 . -1) (61431 . 61432)) nil (26798 52308 232480 0) 0 nil])
([nil nil ((61481 . 61488) (#(" " 0 1 (fontified nil)) . 61480) (undo-tree-id111 . -1) (61481 . 61482)) nil (26798 52308 232479 0) 0 nil])
([nil nil ((61505 . 61507)) nil (26798 52308 232478 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62884 . 62885) (nil fontified nil 61507 . 62885) (61507 . 62885)) nil (26798 52308 232477 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -61711) (undo-tree-id110 . -1) 61712) nil (26798 52308 232477 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -61760) (undo-tree-id109 . -1) 61761) nil (26798 52308 232476 0) 0 nil])
([nil nil ((62203 . 62204)) nil (26798 52308 232475 0) 0 nil])
([nil nil ((62179 . 62180) (62168 . 62176) (62123 . 62131) (62070 . 62071) (62049 . 62053) (61958 . 61966) (61929 . 61931) (61904 . 61906) (61864 . 61866) (61805 . 61807) (61783 . 61785) 61761) nil (26798 52308 232474 0) 0 nil])
([nil nil ((62237 . 62245) (#(" " 0 1 (fontified nil)) . 62237) (62236 . 62237)) nil (26798 52308 232473 0) 0 nil])
([nil nil ((62218 . 62225) (#(" " 0 1 (fontified nil)) . 62217) (undo-tree-id108 . -1) (62218 . 62219)) nil (26798 52308 232472 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -62260) (undo-tree-id107 . -1) 62261) nil (26798 52308 232471 0) 0 nil])
([nil nil ((62570 . 62575) (62546 . 62551) (62516 . 62517) (62476 . 62482) (62458 . 62462) (62441 . 62443) (62352 . 62354) 62261) nil (26798 52308 232469 0) 0 nil])
([nil nil ((62641 . 62654) (#(" " 0 1 (fontified nil)) . 62640) (undo-tree-id106 . -1) (62641 . 62642)) nil (26798 52308 232468 0) 0 nil])
([nil nil ((62690 . 62697) (#(" " 0 1 (fontified nil)) . 62689) (undo-tree-id105 . -1) (62690 . 62691)) nil (26798 52308 232467 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -62714) (undo-tree-id104 . -1) 62715) nil (26798 52308 232465 0) 0 nil])
([nil nil ((62881 . 62887) (62832 . 62838) (62739 . 62741) 62716) nil (26798 52308 232464 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -62746) (undo-tree-id103 . -10) 62756) nil (26798 52308 232463 0) 0 nil])
([nil nil ((62746 . 62748)) nil (26798 52308 232462 0) 0 nil])
([nil nil ((#("l" 0 1 (fontified t)) . -62746) (undo-tree-id101 . -1) (#("=" 0 1 (fontified t)) . -62747) (undo-tree-id102 . -1) 62748) nil (26798 52308 232462 0) 0 nil])
([nil nil ((62746 . 62755)) nil (26798 52308 232460 0) 0 nil])
([nil nil ((62746 . 62748)) nil (26798 52308 232460 0) 0 nil])
([nil nil ((62748 . 62751)) nil (26798 52308 232459 0) 0 nil])
([nil nil ((#("m" 0 1 (fontified t)) . -62746) (undo-tree-id96 . -1) (#("u" 0 1 (fontified t)) . -62747) (undo-tree-id97 . -1) (#("m" 0 1 (fontified t)) . -62748) (undo-tree-id98 . -1) (#("e" 0 1 (fontified t)) . -62749) (undo-tree-id99 . -1) (#("n" 0 1 (fontified t)) . -62750) (undo-tree-id100 . -1) 62751) nil (26798 52308 232458 0) 0 nil])
([nil nil ((62746 . 62748)) nil (26798 52308 232455 0) 0 nil])
([nil nil ((#("L" 0 1 (fontified t)) . -62746) (undo-tree-id94 . -1) (#("u" 0 1 (fontified t)) . -62747) (undo-tree-id95 . -1) 62748) nil (26798 52308 232455 0) 0 nil])
([nil nil ((62746 . 62750)) nil (26798 52308 232453 0) 0 nil])
([nil nil ((#("Ã¹" 0 1 (fontified t)) . -62748) (undo-tree-id92 . -1) (#("e" 0 1 (fontified t)) . -62749) (undo-tree-id93 . -1) 62750) nil (26798 52308 232452 0) 0 nil])
([nil nil ((62748 . 62752)) nil (26798 52308 232451 0) 0 nil])
([nil nil ((#("Ã¹" 0 1 (fontified t)) . -62748) (undo-tree-id88 . -1) (#("e" 0 1 (fontified t)) . -62749) (undo-tree-id89 . -1) (#("n" 0 1 (fontified t)) . -62750) (undo-tree-id90 . -1) (#("." 0 1 (fontified t)) . -62751) (undo-tree-id91 . -1) 62752) nil (26798 52308 232450 0) 0 nil])
([nil nil ((62748 . 62750)) nil (26798 52308 232447 0) 0 nil])
([nil nil ((62750 . 62752)) nil (26798 52308 232447 0) 0 nil])
([nil nil ((#("?" 0 1 (fontified t)) . -62751) (undo-tree-id87 . -1) 62752) nil (26798 52308 232446 0) 0 nil])
([nil nil ((62751 . 62758)) nil (26798 52308 232445 0) 0 nil])
([nil nil ((#("\"x-forwarded-for\"" 0 17 (face font-lock-string-face fontified t)) . 62768) (undo-tree-id86 . -17) 62785) nil (26798 52308 232445 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -62767) (undo-tree-id84 . -1) (undo-tree-id85 . -1) 62768) nil (26798 52308 232443 0) 0 nil])
([nil nil ((62801 . 62802)) nil (26798 52308 232441 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 62818 . 62819) (nil fontified nil 62802 . 62819) (62802 . 62819)) nil (26798 52308 232440 0) 0 nil])
([nil nil ((#(" :test #'string-equal" 0 1 (fontified t) 1 6 (face font-lock-builtin-face fontified t) 6 21 (fontified t)) . -62819) (undo-tree-id83 . -21) 62840) nil (26798 52308 232439 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -62820) (undo-tree-id82 . -1) 62821) nil (26798 52308 232438 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 62887)) nil (26798 52308 232437 0) 0 nil])
([nil nil ((62916 . 62918) 62889) nil (26798 52308 232436 0) 0 nil])
([nil nil ((62944 . 62946) (#(" " 0 1 (fontified nil)) . 62943) (undo-tree-id81 . -1) (62944 . 62945)) nil (26798 52308 232435 0) 0 nil])
([nil nil ((54950 . 54951)) nil (26798 52308 232434 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 57191 . 57192) (nil fontified nil 54951 . 57192) (54951 . 57192)) nil (26798 52308 232571 0) 0 nil])
([nil nil ((55569 . 55573)) nil (26798 52392 846529 0) 0 nil] [nil nil ((#("
(defun auth-jwt (&key (secret \"change-me\") (header \"authorization\") (prefix \"Bearer \"))
  \"Extrait Authorization: Bearer <jwt> et place :jwt (payload) dans req-ctx si valide.\"
  (lambda (next)
    (lambda (req)
      (let* ((hdrs (lumen.core.http:req-headers req))
             (raw  (cdr (assoc header hdrs :test #'string-equal)))
             (tok  (and raw (lumen.utils:str-prefix-p prefix raw)
                        (subseq raw (length prefix)))))
        (when tok
          (multiple-value-bind (payload _)
              (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
            (declare (ignore _))
            (when payload (lumen.core.http:ctx-set! req :jwt payload))))
        (funcall next req)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 31 (fontified t) 31 42 (face font-lock-string-face fontified t) 42 52 (fontified t) 52 67 (face font-lock-string-face fontified t) 67 77 (fontified t) 77 86 (face font-lock-string-face fontified t) 86 91 (fontified t) 91 109 (face font-lock-doc-face fontified t) 109 175 (face font-lock-doc-face fontified t) 175 176 (face font-lock-doc-face fontified t) 176 177 (fontified t) 177 180 (fontified t) 180 186 (face font-lock-keyword-face fontified t) 186 194 (fontified t) 194 199 (fontified t) 199 205 (face font-lock-keyword-face fontified t) 205 219 (fontified t) 219 223 (face font-lock-keyword-face fontified t) 223 251 (fontified t) 251 266 (fontified t) 266 309 (fontified t) 309 314 (face font-lock-builtin-face fontified t) 314 334 (fontified t) 334 346 (fontified t) 346 399 (fontified t) 399 411 (fontified t) 411 418 (fontified t) 418 426 (fontified t) 426 455 (fontified t) 455 464 (fontified t) 464 468 (face font-lock-keyword-face fontified t) 468 473 (fontified t) 473 484 (fontified t) 484 488 (face font-lock-keyword-face fontified t) 488 503 (face font-lock-keyword-face fontified t) 503 516 (fontified t) 516 559 (fontified t) 559 561 (fontified t) 561 568 (face font-lock-builtin-face fontified t) 568 572 (fontified t) 572 576 (fontified t) 576 583 (face font-lock-builtin-face fontified t) 583 587 (fontified t) 587 600 (fontified t) 600 607 (face font-lock-keyword-face fontified t) 607 633 (fontified t) 633 637 (face font-lock-keyword-face fontified t) 637 676 (fontified t) 676 680 (face font-lock-builtin-face fontified t) 680 705 (fontified t) 705 723 (fontified t)) . -57192) (undo-tree-id65 . -1) (undo-tree-id66 . -723) (undo-tree-id67 . -15) (undo-tree-id68 . -15) (undo-tree-id69 . -15) (undo-tree-id70 . -15) (undo-tree-id71 . -15) (undo-tree-id72 . -15) (undo-tree-id73 . -15) (undo-tree-id74 . -47) (undo-tree-id75 . -47) (undo-tree-id76 . -666) (undo-tree-id77 . -666) (undo-tree-id78 . -666) (undo-tree-id79 . -666) (undo-tree-id80 . -693) 57915) ((57192 . 57915)) (26798 52308 232429 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55598 . 55599) (nil fontified nil 55573 . 55599) (55573 . 55599)) nil (26798 52392 846577 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 55607 . 55608) (nil fontified nil 55599 . 55608) (55599 . 55608)) nil (26798 57467 575281 0) 0 nil] [nil nil ((#("\"Bearer \"" 0 9 (face font-lock-string-face fontified t)) . 55650) (undo-tree-id118 . -9) (undo-tree-id119 . -2) (undo-tree-id120 . -2) (undo-tree-id121 . -9) (undo-tree-id122 . -9) (undo-tree-id123 . -9) (undo-tree-id124 . -9) (undo-tree-id125 . -9) (undo-tree-id126 . -9) (undo-tree-id127 . -9) 55659) ((55650 . 55659)) (26798 52392 846524 0) 0 nil])
([nil nil ((55608 . 55609)) nil (26798 57467 575280 0) 0 nil])
nil
([nil nil ((55609 . 55613)) nil (26798 57467 575280 0) 0 nil])
([nil nil ((55638 . 55640)) nil (26798 57467 575279 0) 0 nil])
([nil nil ((56035 . 56048) (#(" " 0 1 (fontified nil)) . 56035) (56034 . 56035)) nil (26798 57467 575279 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -56215) (undo-tree-id162 . -10) 56225) nil (26798 57467 575278 0) 0 nil])
([nil nil ((56215 . 56218)) nil (26798 57467 575277 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -56215) (undo-tree-id159 . -1) (#("l" 0 1 (fontified t)) . -56216) (undo-tree-id160 . -1) (#("i" 0 1 (fontified t)) . -56217) (undo-tree-id161 . -1) 56218) nil (26798 57467 575277 0) 0 nil])
([nil nil ((56215 . 56223)) nil (26798 57467 575275 0) 0 nil])
([nil nil ((56215 . 56227) (#("lumen.ut" 0 8 (fontified t)) . -56215) (undo-tree-id158 . -8) 56223) nil (26798 57467 575274 0) 0 nil])
([nil nil ((56227 . 56236)) nil (26798 57467 575273 0) 0 nil])
([nil nil ((56236 . 56237)) nil (26798 57467 575273 0) 0 nil])
([nil nil ((56237 . 56240)) nil (26798 57467 575272 0) 0 nil])
([nil nil ((#(" jwt" 0 4 (fontified t)) . 56248)) nil (26798 57467 575272 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -56249) (undo-tree-id157 . -1) 56250) nil (26798 57467 575272 0) 0 nil])
([nil nil ((#("cdr (assoc \"scopes\" jwt)" 0 11 (fontified t) 11 19 (face font-lock-string-face fontified t) 19 24 (fontified t)) . -56285) (undo-tree-id156 . -24) 56309) nil (26798 57467 575271 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56317 . 56318) (nil fontified nil 56311 . 56318) (nil fontified nil 56310 . 56311) (nil fontified nil 56285 . 56310) (56285 . 56318)) nil (26798 57467 575270 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -56311) (undo-tree-id155 . -1) 56312) nil (26798 57467 575269 0) 0 nil])
([nil nil ((56311 . 56312)) nil (26798 57467 575268 0) 0 nil])
([nil nil ((56318 . 56319)) nil (26798 57467 575268 0) 0 nil])
([nil nil ((56606 . 56611) (#(" " 0 1 (fontified nil)) . 56606) (56605 . 56606)) nil (26798 57467 575267 0) 0 nil])
([nil nil ((#("cdr (assoc :role jwt)" 0 11 (fontified t) 11 16 (face font-lock-builtin-face fontified t) 16 21 (fontified t)) . -56719) (undo-tree-id154 . -21) 56740) nil (26798 57467 575267 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56751 . 56752) (nil fontified nil 56745 . 56752) (nil fontified nil 56744 . 56745) (nil fontified nil 56719 . 56744) (56719 . 56752)) nil (26798 57467 575265 0) 0 nil])
([nil nil ((#("scopes" 0 5 (face font-lock-builtin-face fontified t) 5 6 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -56746) (undo-tree-id153 . -6) 56752) nil (26798 57467 575265 0) 0 nil])
([nil nil ((56746 . 56750)) nil (26798 57467 575258 0) 0 nil])
([nil nil ((56746 . 56754) (#(" " 0 1 (fontified nil)) . 56745) (undo-tree-id152 . -1) (#("      " 0 6 (fontified nil)) . -56693) (56752 . 56753)) nil (26798 57467 575257 0) 0 nil])
([nil nil ((#("cdr (assoc \"role\" jwt)" 0 11 (fontified t) 11 17 (face font-lock-string-face fontified t) 17 22 (fontified t)) . -56755) (undo-tree-id151 . -22) 56777) nil (26798 57467 575256 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56787 . 56788) (nil fontified nil 56781 . 56788) (nil fontified nil 56780 . 56781) (nil fontified nil 56755 . 56780) (56755 . 56788)) nil (26798 57467 575255 0) 0 nil])
([nil nil ((#("scopes" 0 5 (face font-lock-builtin-face fontified t) 5 6 (face font-lock-builtin-face rear-nonsticky t fontified t)) . -56782) (undo-tree-id150 . -6) 56788) nil (26798 57467 575254 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -56781) (undo-tree-id148 . -1) (undo-tree-id149 . -1) 56782) nil (26798 57467 575253 0) 0 nil])
([nil nil ((56781 . 56787)) nil (26798 57467 575250 0) 0 nil])
([nil nil ((#("  " 0 2 (fontified nil)) . -57252) (57298 . 57299)) nil (26798 57467 575249 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret \"change-me\") (header \"authorization\") (prefix \"Bearer \"))
  \"Extrait Authorization: Bearer <jwt> et place :jwt (payload) dans req-ctx si valide.\"
  (lambda (next)
    (lambda (req)
      (let* ((hdrs (lumen.core.http:req-headers req))
             (raw  (cdr (assoc header hdrs :test #'string-equal)))
             (tok  (and raw (lumen.utils:str-prefix-p prefix raw)
                        (subseq raw (length prefix)))))
        (when tok
          (multiple-value-bind (payload _)
              (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
            (declare (ignore _))
            (when payload (lumen.core.http:ctx-set! req :jwt payload))))
        (funcall next req)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 31 (fontified t) 31 42 (face font-lock-string-face fontified t) 42 52 (fontified t) 52 67 (face font-lock-string-face fontified t) 67 77 (fontified t) 77 86 (face font-lock-string-face fontified t) 86 91 (fontified t) 91 109 (face font-lock-doc-face fontified t) 109 175 (face font-lock-doc-face fontified t) 175 176 (face font-lock-doc-face fontified t) 176 177 (fontified t) 177 180 (fontified t) 180 186 (face font-lock-keyword-face fontified t) 186 194 (fontified t) 194 199 (fontified t) 199 205 (face font-lock-keyword-face fontified t) 205 212 (fontified t) 212 219 (fontified t) 219 223 (face font-lock-keyword-face fontified t) 223 251 (fontified t) 251 266 (fontified t) 266 309 (fontified t) 309 314 (face font-lock-builtin-face fontified t) 314 318 (fontified t) 318 333 (fontified t) 333 334 (fontified t) 334 346 (fontified t) 346 399 (fontified t) 399 411 (fontified t) 411 418 (fontified t) 418 426 (fontified t) 426 439 (fontified t) 439 455 (fontified t) 455 464 (fontified t) 464 468 (face font-lock-keyword-face fontified t) 468 473 (fontified t) 473 484 (fontified t) 484 488 (face font-lock-keyword-face fontified t) 488 489 (face font-lock-keyword-face fontified t) 489 503 (face font-lock-keyword-face fontified t) 503 516 (fontified t) 516 553 (fontified t) 553 559 (fontified t) 559 561 (fontified t) 561 568 (face font-lock-builtin-face fontified t) 568 572 (fontified t) 572 576 (fontified t) 576 583 (face font-lock-builtin-face fontified t) 583 587 (fontified t) 587 600 (fontified t) 600 607 (face font-lock-keyword-face fontified t) 607 633 (fontified t) 633 637 (face font-lock-keyword-face fontified t) 637 676 (fontified t) 676 680 (face font-lock-builtin-face fontified t) 680 705 (fontified t) 705 723 (fontified t) 723 724 (fontified t)) . -57297) (undo-tree-id147 . -724) 58021) nil (26798 57467 575249 0) 0 nil])
([nil nil ((57252 . 57254) 57223) nil (26798 57467 575248 0) 0 nil])
([nil nil ((#("(defparameter *rl-store* (make-hash-table :test 'equal)) ; key -> (tokens . last-refill)
(defparameter *rl-capacity* 10) ; 10 req / fenÃªtre
(defparameter *rl-refill-interval* 10) ; refill complet en 10 s

(defun %now () (truncate (get-universal-time)))

(defun %rl-take (key)
  (let* ((now (%now))
	 (cell (gethash key *rl-store* (cons *rl-capacity* now)))
	 (tokens (car cell)) (last (cdr cell))
	 (elapsed (- now last))
	 (refill (min *rl-capacity*
		      (+ tokens (floor (* (*rl-capacity*) (/ (max 0 elapsed) *rl-refill-interval*)))))))
    (if (> refill 0)
	(progn (setf (car cell) (1- refill) (cdr cell) now)
	       (setf (gethash key *rl-store*) cell)
	       t)
	(progn (setf (gethash key *rl-store*)
		     (cons refill now))
	       nil))))

(defun rate-limit (key-fn &key (capacity *rl-capacity*) (refill-sec *rl-refill-interval*))
  (declare (ignore capacity refill-sec)) ; simplifiÃ©: sâ€™appuie sur les defparams globaux
  (lambda (next)
    (lambda (req)
      (let ((key (funcall key-fn req)))
	(if (and key (%rl-take key))
	    (funcall next req)
	    (lumen.core.http:respond-json '((:error . ((:type . \"rate-limit\")
						       (:message . \"too many requests\"))))
					  :status 429))))))

(defun remote-ip (req)
  (or (lumen.utils:alist-get (lumen.core.http:req-headers req) \"x-forwarded-for\")
      (lumen.core.http:ctx-get req :remote-addr)
      \"unknown\"))

(defun rate-limit-login ()
  (rate-limit (lambda (req)
		(format nil \"login:~a\" (remote-ip req)))))" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 24 (face font-lock-variable-name-face fontified t) 24 42 (fontified t) 42 47 (face font-lock-builtin-face fontified t) 47 57 (fontified t) 57 89 (face font-lock-comment-face fontified t) 89 90 (fontified t) 90 102 (face font-lock-keyword-face fontified t) 102 103 (fontified t) 103 116 (face font-lock-variable-name-face fontified t) 116 121 (fontified t) 121 140 (face font-lock-comment-face fontified t) 140 141 (fontified t) 141 153 (face font-lock-keyword-face fontified t) 153 154 (fontified t) 154 174 (face font-lock-variable-name-face fontified t) 174 179 (fontified t) 179 204 (face font-lock-comment-face fontified t) 204 205 (fontified t) 205 206 (fontified t) 206 211 (face font-lock-keyword-face fontified t) 211 212 (fontified t) 212 216 (face font-lock-function-name-face fontified t) 216 253 (fontified t) 253 254 (fontified t) 254 255 (fontified t) 255 260 (face font-lock-keyword-face fontified t) 260 261 (fontified t) 261 269 (face font-lock-function-name-face fontified t) 269 276 (fontified t) 276 278 (fontified t) 278 279 (fontified t) 279 283 (face font-lock-keyword-face fontified t) 283 298 (fontified t) 298 300 (fontified t) 300 359 (fontified t) 359 399 (fontified t) 399 424 (fontified t) 424 459 (fontified t) 459 546 (fontified t) 546 547 (fontified t) 547 549 (face font-lock-keyword-face fontified t) 549 564 (fontified t) 564 565 (fontified t) 565 570 (face font-lock-keyword-face fontified t) 570 624 (fontified t) 624 669 (fontified t) 669 672 (fontified t) 672 673 (fontified t) 673 674 (fontified t) 674 679 (face font-lock-keyword-face fontified t) 679 737 (fontified t) 737 753 (fontified t) 753 754 (fontified t) 754 755 (fontified t) 755 760 (face font-lock-keyword-face fontified t) 760 761 (fontified t) 761 771 (face font-lock-function-name-face fontified t) 771 780 (fontified t) 780 784 (face font-lock-type-face fontified t) 784 845 (fontified t) 845 848 (fontified t) 848 855 (face font-lock-keyword-face fontified t) 855 886 (fontified t) 886 934 (face font-lock-comment-face fontified t) 934 936 (fontified t) 936 937 (fontified t) 937 943 (face font-lock-keyword-face fontified t) 943 955 (fontified t) 955 956 (fontified t) 956 962 (face font-lock-keyword-face fontified t) 962 975 (fontified t) 975 976 (fontified t) 976 979 (face font-lock-keyword-face fontified t) 979 1010 (fontified t) 1010 1011 (fontified t) 1011 1013 (face font-lock-keyword-face fontified t) 1013 1044 (fontified t) 1044 1063 (fontified t) 1063 1068 (fontified t) 1068 1101 (fontified t) 1101 1107 (face font-lock-builtin-face fontified t) 1107 1112 (fontified t) 1112 1117 (face font-lock-builtin-face fontified t) 1117 1120 (fontified t) 1120 1132 (face font-lock-string-face fontified t) 1132 1134 (fontified t) 1134 1148 (fontified t) 1148 1156 (face font-lock-builtin-face fontified t) 1156 1159 (fontified t) 1159 1178 (face font-lock-string-face fontified t) 1178 1183 (fontified t) 1183 1190 (fontified t) 1190 1197 (face font-lock-builtin-face fontified t) 1197 1207 (fontified t) 1207 1208 (fontified t) 1208 1209 (fontified t) 1209 1210 (fontified t) 1210 1215 (face font-lock-keyword-face fontified t) 1215 1216 (fontified t) 1216 1225 (face font-lock-function-name-face fontified t) 1225 1232 (fontified t) 1232 1260 (fontified t) 1260 1295 (fontified t) 1295 1311 (face font-lock-string-face fontified t) 1311 1312 (face font-lock-string-face fontified t rear-nonsticky t) 1312 1314 (fontified t) 1314 1320 (fontified t) 1320 1349 (fontified t) 1349 1361 (face font-lock-builtin-face fontified t) 1361 1363 (fontified t) 1363 1369 (fontified t) 1369 1378 (face font-lock-string-face fontified t) 1378 1380 (fontified t) 1380 1381 (fontified t) 1381 1382 (fontified t) 1382 1383 (fontified t) 1383 1388 (face font-lock-keyword-face fontified t) 1388 1389 (fontified t) 1389 1405 (face font-lock-function-name-face fontified t) 1405 1409 (fontified t) 1409 1411 (fontified t) 1411 1424 (fontified t) 1424 1430 (face font-lock-keyword-face fontified t) 1430 1451 (fontified t) 1451 1461 (face font-lock-string-face fontified t) 1461 1480 (fontified t) 1480 1481 (fontified t rear-nonsticky t)) . -63132) (undo-tree-id144 . -661) (undo-tree-id145 . -1381) (undo-tree-id146 . -1481) 64613) nil (26798 57467 575247 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 63540 . 63541) (nil fontified nil 63132 . 63541) (63132 . 63541)) nil (26798 57467 575245 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret lumen.core.jwt:*jwt-secret*)
                      (required-p nil) (roles-allow nil) (scopes-allow nil))
  \"Extrait Authorization: Bearer <jwt>, vÃ©rifie, pose :jwt dans req-ctx.
Options:
 - REQUIRED-P : 401 si token manquant/invalide
 - ROLES-ALLOW : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW : liste de scopes requis (OR logique par dÃ©faut ; mets :all pour AND)\"
  (lambda (next)
    (lambda (req)
      (let* ((hdrs (lumen.core.http:req-headers req))
             (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
             (tok  (and raw (>= (length raw) 7)
			(lumen.utils:str-prefix-p \"Bearer \" raw)
                        ;;(string= (subseq raw 0 7) \"Bearer \")
                        (subseq raw 7))))
        (when tok
          (multiple-value-bind (payload ok)
              (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
            (when ok (lumen.core.http:ctx-set! req :jwt payload))))
        (labels ((fail (status msg)
                   (lumen.core.http:respond-json `((:error . ((:type . \"auth\")
							      (:message . ,msg))))
                                                 :status status))
                 (has-scope-p (jwt required)
                   (let* ((sc (or (lumen.utils:alist-get jwt :scopes)
                                  (lumen.utils:alist-get jwt \"scopes\"))))
                     (cond
                       ((null scopes-allow) t)
                       ((eq scopes-allow :all)
                        (every (lambda (x) (member x sc :test #'string=)) required))
                       (t (some  (lambda (x) (member x sc :test #'string=))
				 required))))))
                (jwt (lumen.core.http:ctx-get req :jwt))
          (role (and jwt (or (lumen.utils:alist-get jwt :role)
			     (lumen.utils:alist-get jwt \"role\")))))
          (cond
            ((and required-p (null jwt)) (fail 401 \"missing or invalid token\"))
            ((and roles-allow jwt (not (member role roles-allow :test #'string=)))
             (fail 403 \"forbidden\"))
            ((and scopes-allow jwt (not (has-scope-p jwt scopes-allow)))
             (fail 403 \"insufficient_scope\"))
            (t (funcall next req))))))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 139 (fontified t) 139 406 (face font-lock-doc-face fontified t) 406 410 (fontified t) 410 416 (face font-lock-keyword-face fontified t) 416 429 (fontified t) 429 435 (face font-lock-keyword-face fontified t) 435 449 (fontified t) 449 453 (face font-lock-keyword-face fontified t) 453 527 (fontified t) 527 542 (face font-lock-string-face fontified t) 542 548 (fontified t) 548 553 (face font-lock-builtin-face fontified t) 553 572 (fontified t) 572 620 (fontified t) 620 623 (fontified t) 623 648 (fontified t) 648 649 (rear-nonsticky t fontified t) 649 657 (face font-lock-string-face fontified t) 657 658 (face font-lock-string-face rear-nonsticky t fontified t) 658 663 (fontified t) 663 664 (fontified t) 664 688 (fontified t) 688 690 (face font-lock-comment-delimiter-face fontified t) 690 716 (face font-lock-comment-face fontified t) 716 725 (face font-lock-comment-face fontified t) 725 727 (face font-lock-comment-face fontified t) 727 778 (fontified t) 778 782 (face font-lock-keyword-face fontified t) 782 798 (fontified t) 798 817 (face font-lock-keyword-face fontified t) 817 876 (fontified t) 876 883 (face font-lock-builtin-face fontified t) 883 891 (fontified t) 891 898 (face font-lock-builtin-face fontified t) 898 915 (fontified t) 915 919 (face font-lock-keyword-face fontified t) 919 953 (fontified t) 953 957 (face font-lock-builtin-face fontified t) 957 979 (fontified t) 979 985 (face font-lock-keyword-face fontified t) 985 1006 (fontified t) 1006 1058 (fontified t) 1058 1064 (face font-lock-builtin-face fontified t) 1064 1069 (fontified t) 1069 1074 (face font-lock-builtin-face fontified t) 1074 1077 (fontified t) 1077 1083 (face font-lock-string-face fontified t) 1083 1099 (fontified t) 1099 1107 (face font-lock-builtin-face fontified t) 1107 1119 (fontified t) 1119 1168 (fontified t) 1168 1175 (face font-lock-builtin-face fontified t) 1175 1230 (fontified t) 1230 1250 (fontified t) 1250 1254 (face font-lock-keyword-face fontified t) 1254 1265 (fontified t) 1265 1290 (fontified t) 1290 1291 (fontified t) 1291 1298 (face font-lock-builtin-face fontified t) 1298 1300 (fontified t) 1300 1335 (fontified t) 1335 1360 (fontified t) 1360 1361 (fontified t) 1361 1362 (face font-lock-string-face fontified t) 1362 1367 (face font-lock-string-face fontified t) 1367 1368 (face font-lock-string-face rear-nonsticky t fontified t) 1368 1369 (face font-lock-string-face fontified t) 1369 1374 (fontified t) 1374 1396 (fontified t) 1396 1400 (face font-lock-keyword-face fontified t) 1400 1489 (fontified t) 1489 1493 (face font-lock-builtin-face fontified t) 1493 1527 (fontified t) 1527 1533 (face font-lock-keyword-face fontified t) 1533 1551 (fontified t) 1551 1556 (face font-lock-builtin-face fontified t) 1556 1580 (fontified t) 1580 1614 (fontified t) 1614 1620 (face font-lock-keyword-face fontified t) 1620 1638 (fontified t) 1638 1643 (face font-lock-builtin-face fontified t) 1643 1676 (fontified t) 1676 1726 (fontified t) 1726 1730 (face font-lock-builtin-face fontified t) 1730 1733 (fontified t) 1733 1763 (fontified t) 1763 1788 (fontified t) 1788 1789 (fontified t) 1789 1794 (face font-lock-builtin-face fontified t) 1794 1796 (fontified t) 1796 1805 (fontified t) 1805 1830 (fontified t) 1830 1831 (fontified t) 1831 1837 (face font-lock-string-face fontified t) 1837 1843 (fontified t) 1843 1854 (fontified t) 1854 1858 (face font-lock-keyword-face fontified t) 1858 1910 (fontified t) 1910 1936 (face font-lock-string-face fontified t) 1936 2003 (fontified t) 2003 2008 (face font-lock-builtin-face fontified t) 2008 2045 (fontified t) 2045 2056 (face font-lock-string-face fontified t) 2056 2155 (fontified t) 2155 2175 (face font-lock-string-face fontified t) 2175 2218 (fontified t)) . 54950) (undo-tree-id143 . -2218)) nil (26798 57467 575244 0) 0 nil])
([nil nil ((54950 . 54951)) nil (26798 57467 575243 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 57544 . 57545) (nil fontified nil 54951 . 57545) (54951 . 57545)) nil (26798 57467 575243 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -57544) (undo-tree-id142 . -1) 57545) nil (26798 57467 575242 0) 0 nil])
([nil nil ((57544 . 57545)) nil (26798 57467 575241 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -57544) (undo-tree-id141 . -1) 57545) nil (26798 57467 575241 0) 0 nil])
([nil nil ((#("   " 0 3 (fontified t)) . -55133) (#("   " 0 3 (fontified t)) . -55096) (#("   " 0 3 (fontified t)) . -55060) 54988) nil (26798 57467 575240 0) 0 nil])
([nil nil ((#("
(in-package :lumen.core.middleware)
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 12 (face font-lock-keyword-face fontified t) 12 13 (fontified t) 13 35 (face font-lock-builtin-face fontified t) 35 37 (fontified t)) . 54950) (undo-tree-id140 . -37)) nil (26798 57467 575239 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -54932) (undo-tree-id138 . -1) (#(" " 0 1 (fontified t)) . -54933) (undo-tree-id139 . -1) 54934) nil (26798 57467 575238 0) 0 nil])
([nil nil ((63637 . 63645) (#(" " 0 1 (fontified nil)) . 63636) (undo-tree-id137 . -1) (63637 . 63638)) nil (26798 57467 575236 0) 0 nil])
([nil nil ((63676 . 63684) (#(" " 0 1 (fontified nil)) . 63675) (undo-tree-id136 . -1) (63676 . 63677)) nil (26798 57467 575235 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -62989) (undo-tree-id135 . -1) 62990) nil (26798 57467 575233 0) 0 nil])
([nil nil ((672 . 675)) nil (26798 57467 575232 0) 0 nil])
([nil nil ((675 . 678)) nil (26798 57467 575232 0) 0 nil])
([nil nil ((678 . 683)) nil (26798 57467 575232 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -682) (undo-tree-id134 . -1) 683) nil (26798 57467 575231 0) 0 nil])
([nil nil ((682 . 685)) nil (26798 57467 575230 0) 0 nil])
([nil nil ((676 . 688) (#(":import-f" 0 9 (face font-lock-builtin-face fontified t)) . -676) (undo-tree-id133 . -9) 685) nil (26798 57467 575230 0) 0 nil])
([nil nil ((688 . 689)) nil (26798 57467 575229 0) 0 nil])
([nil nil ((689 . 690)) nil (26798 57467 575228 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 716 . 717) (nil fontified nil 690 . 717) (690 . 717)) nil (26798 57467 575228 0) 0 nil])
([nil nil ((710 . 711)) nil (26798 57467 575227 0) 0 nil])
([nil nil ((718 . 719)) nil (26798 57467 575227 0) 0 nil])
([nil nil ((1197 . 1200) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -1181) (1181 . 1182) (#("	" 0 1 (fontified nil)) . 1181) (1178 . 1181) (1197 . 1198)) nil (26798 57467 575226 0) 0 nil])
([nil nil ((1200 . 1201)) nil (26798 57467 575225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1241 . 1242) (nil fontified nil 1201 . 1242) (1201 . 1242)) nil (26798 57467 575225 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -1201) (undo-tree-id132 . -1) 1202) nil (26798 57467 575224 0) 0 nil])
([nil nil ((57210 . 57221) (#(" " 0 1 (fontified nil)) . 57209) (undo-tree-id131 . -1) (57210 . 57211)) nil (26798 57467 575223 0) 0 nil])
([nil nil ((57252 . 57261) (#(" " 0 1 (fontified nil)) . 57251) (undo-tree-id130 . -1) (57252 . 57253)) nil (26798 57467 575221 0) 0 nil])
([nil nil ((57356 . 57366) (#(" " 0 1 (fontified nil)) . 57355) (undo-tree-id129 . -1) (57356 . 57357)) nil (26798 57467 575220 0) 0 nil])
([nil nil ((57397 . 57405) (#(" " 0 1 (fontified nil)) . 57396) (undo-tree-id128 . -1) (57397 . 57398)) nil (26798 57467 575216 0) 0 nil])
([nil nil ((64013 . 64014)) nil (26798 57467 575203 0) 0 nil])
([nil nil ((55039 . 55040) (t 26798 57467 0 0)) nil (26798 59603 210161 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 55222 . 55223) (nil fontified nil 55040 . 55223) (55040 . 55223)) nil (26798 59603 210161 0) 0 nil])
([nil nil ((55039 . 55040)) nil (26798 59603 210160 0) 0 nil])
([nil nil ((55040 . 55042)) nil (26798 59603 210160 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -55040) (undo-tree-id163 . -1) (#("-" 0 1 (face font-lock-string-face fontified t)) . -55041) (undo-tree-id164 . -1) 55042) nil (26798 59603 210159 0) 0 nil])
([nil nil ((55040 . 55041)) nil (26798 59603 210148 0) 0 nil])
([nil nil ((55041 . 55042)) nil (26798 59603 210147 0) 0 nil])
([nil nil ((55226 . 55227)) nil (26798 59603 210147 0) 0 nil])
([nil nil ((55227 . 55229)) nil (26798 59603 210147 0) 0 nil])
([nil nil ((63777 . 63779)) nil (26798 59603 210146 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 63930 . 63931) (nil fontified nil 63779 . 63931) (63779 . 63931)) nil (26798 59603 210146 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified nil)) . -63854) (63853 . 63854)) nil (26798 59603 210145 0) 0 nil])
([nil nil ((63854 . 63856)) nil (26798 59603 210144 0) 0 nil])
([nil nil ((63856 . 63857)) nil (26798 59603 210144 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 63881)) nil (26798 59603 210142 0) 0 nil])
([nil nil ((63881 . 63882)) nil (26798 59603 210139 0) 0 nil])
([nil nil ((648 . 649) (t 26798 59603 0 0)) nil (26798 59827 741727 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 660 . 661) (nil fontified nil 649 . 661) (649 . 661)) nil (26798 59827 741726 0) 0 nil])
([nil nil ((661 . 662)) nil (26798 59827 741721 0) 0 nil])
([nil nil ((63790 . 63791) (t 26798 59827 0 0)) nil (26798 60456 420785 0) 0 nil])
([nil nil ((57959 . 57961)) nil (26798 60456 420785 0) 0 nil])
([nil nil ((nil fontified nil 58035 . 58036) (nil fontified nil 58028 . 58035) (nil fontified nil 58016 . 58028) (nil fontified nil 58013 . 58016) (nil fontified nil 58002 . 58013) (nil fontified nil 57992 . 58002) (nil fontified nil 57990 . 57992) (nil fontified nil 57981 . 57990) (nil fontified nil 57975 . 57981) (nil fontified nil 57968 . 57975) (nil fontified nil 57967 . 57968) (nil fontified nil 57962 . 57967) (nil fontified nil 57961 . 57962) (57961 . 58036)) nil (26798 60456 420784 0) 0 nil])
([nil nil ((57973 . 57974)) nil (26798 60456 420782 0) 0 nil])
([nil nil ((#("o" 0 1 (face font-lock-function-name-face fontified t)) . -57969) (undo-tree-id178 . -1) (#("l" 0 1 (face font-lock-function-name-face fontified t)) . -57970) (undo-tree-id179 . -1) (#("e" 0 1 (face font-lock-function-name-face fontified t)) . -57971) (undo-tree-id180 . -1) (#("s" 0 1 (face font-lock-function-name-face fontified t)) . -57972) (undo-tree-id181 . -1) (#("s" 0 1 (face font-lock-function-name-face fontified t)) . -57973) (undo-tree-id182 . -1) 57974) nil (26798 60456 420781 0) 0 nil])
([nil nil ((57969 . 57970)) nil (26798 60456 420778 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-function-name-face fontified t)) . -57968) (undo-tree-id176 . -1) (#("s" 0 1 (face font-lock-function-name-face fontified t)) . -57969) (undo-tree-id177 . -1) 57970) nil (26798 60456 420777 0) 0 nil])
([nil nil ((57968 . 57974)) nil (26798 60456 420775 0) 0 nil])
([nil nil ((#("
(defun scopes-allowed (roles)
  (auth-jwt :required-p t :roles-allow roles))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (face font-lock-function-name-face fontified t) 16 22 (face font-lock-function-name-face fontified t) 22 31 (fontified t) 31 33 (fontified t) 33 43 (fontified t) 43 54 (face font-lock-builtin-face fontified t) 54 57 (fontified t) 57 69 (face font-lock-builtin-face fontified t) 69 76 (fontified t) 76 77 (fontified t rear-nonsticky t)) . 57960) (undo-tree-id172 . -77) (undo-tree-id173 . -14) (undo-tree-id174 . -14) (undo-tree-id175 . -14)) nil (26798 60456 420774 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -57959) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) 57960) nil (26798 60456 420771 0) 0 nil])
([nil nil ((#("
;;; Auth API
(defun auth-required ()
  (lambda (next)
    (lambda (req)
      (if (lumen.core.http:ctx-get req :jwt)
	  (funcall next req)
	  (lumen.core.http:respond-json '((:error . ((:type . \"auth\")
						     (:message . \"unauthorized\"))))
					:status 401)))))


(defun roles-allowed (&rest roles)
  (lambda (next)
    (lambda (req)
      (let* ((jwt (lumen.core.http:ctx-get req :jwt))
	     (role (and jwt (or (cdr (assoc :role jwt))
				(cdr (assoc \"role\" jwt :test #'string=))))))
	(if (and role (member role roles :test #'string-equal))
	    (funcall next req)
	    (lumen.core.http:respond-json '((:error . ((:type . \"auth\")
						       (:message . \"forbidden\"))))
					  :status 403))))))

(defun scopes-allowed (&rest scopes)
  (lambda (next)
    (lambda (req)
      (let* ((jwt (lumen.core.http:ctx-get req :jwt))
	     (have (and jwt (or (cdr (assoc :scopes jwt))
				(cdr (assoc \"scopes\" jwt :test #'string=))))))
	(if (and (listp have)
		 (intersection have scopes :test #'string-equal))
	    (funcall next req)
	    (lumen.core.http:respond-json '((:error . ((:type . \"auth\")
						       (:message . \"insufficient scope\"))))
					  :status 403))))))
" 0 1 (fontified t) 1 5 (face font-lock-comment-delimiter-face fontified t) 5 14 (face font-lock-comment-face fontified t) 14 15 (fontified t) 15 20 (face font-lock-keyword-face fontified t) 20 21 (fontified t) 21 28 (face font-lock-function-name-face fontified t) 28 34 (face font-lock-function-name-face fontified t) 34 38 (fontified t) 38 41 (fontified t) 41 47 (face font-lock-keyword-face fontified t) 47 59 (fontified t) 59 60 (fontified t) 60 66 (face font-lock-keyword-face fontified t) 66 79 (fontified t) 79 80 (fontified t) 80 82 (face font-lock-keyword-face fontified t) 82 112 (fontified t) 112 116 (face font-lock-builtin-face fontified t) 116 121 (fontified t) 121 140 (fontified t) 140 143 (fontified t) 143 176 (fontified t) 176 182 (face font-lock-builtin-face fontified t) 182 187 (fontified t) 187 192 (face font-lock-builtin-face fontified t) 192 195 (fontified t) 195 201 (face font-lock-string-face fontified t) 201 215 (fontified t) 215 223 (face font-lock-builtin-face fontified t) 223 226 (fontified t) 226 234 (face font-lock-string-face fontified t) 234 240 (face font-lock-string-face fontified t) 240 245 (fontified t) 245 250 (fontified t) 250 257 (face font-lock-builtin-face fontified t) 257 267 (fontified t) 267 269 (fontified t) 269 270 (fontified t) 270 275 (face font-lock-keyword-face fontified t) 275 276 (fontified t) 276 289 (face font-lock-function-name-face fontified t) 289 291 (fontified t) 291 296 (face font-lock-type-face fontified t) 296 304 (fontified t) 304 307 (fontified t) 307 313 (face font-lock-keyword-face fontified t) 313 325 (fontified t) 325 326 (fontified t) 326 332 (face font-lock-keyword-face fontified t) 332 345 (fontified t) 345 346 (fontified t) 346 350 (face font-lock-keyword-face fontified t) 350 379 (fontified t) 379 386 (fontified t) 386 390 (face font-lock-builtin-face fontified t) 390 393 (fontified t) 393 399 (fontified t) 399 430 (fontified t) 430 435 (face font-lock-builtin-face fontified t) 435 458 (fontified t) 458 464 (face font-lock-string-face fontified t) 464 469 (fontified t) 469 474 (face font-lock-builtin-face fontified t) 474 491 (fontified t) 491 492 (fontified t) 492 493 (fontified t) 493 495 (face font-lock-keyword-face fontified t) 495 525 (fontified t) 525 530 (face font-lock-builtin-face fontified t) 530 553 (fontified t) 553 572 (fontified t) 572 577 (fontified t) 577 610 (fontified t) 610 616 (face font-lock-builtin-face fontified t) 616 621 (fontified t) 621 626 (face font-lock-builtin-face fontified t) 626 629 (fontified t) 629 635 (face font-lock-string-face fontified t) 635 637 (fontified t) 637 651 (fontified t) 651 659 (face font-lock-builtin-face fontified t) 659 662 (fontified t) 662 673 (face font-lock-string-face fontified t) 673 678 (fontified t) 678 685 (fontified t) 685 692 (face font-lock-builtin-face fontified t) 692 702 (fontified t) 702 703 (fontified t) 703 704 (fontified t) 704 705 (fontified t) 705 710 (face font-lock-keyword-face fontified t) 710 711 (fontified t) 711 725 (face font-lock-function-name-face fontified t) 725 727 (fontified t) 727 732 (face font-lock-type-face fontified t) 732 741 (fontified t) 741 744 (fontified t) 744 750 (face font-lock-keyword-face fontified t) 750 762 (fontified t) 762 763 (fontified t) 763 769 (face font-lock-keyword-face fontified t) 769 782 (fontified t) 782 783 (fontified t) 783 787 (face font-lock-keyword-face fontified t) 787 823 (fontified t) 823 827 (face font-lock-builtin-face fontified t) 827 830 (fontified t) 830 836 (fontified t) 836 867 (fontified t) 867 874 (face font-lock-builtin-face fontified t) 874 897 (fontified t) 897 905 (face font-lock-string-face fontified t) 905 910 (fontified t) 910 915 (face font-lock-builtin-face fontified t) 915 932 (fontified t) 932 933 (fontified t) 933 934 (fontified t) 934 936 (face font-lock-keyword-face fontified t) 936 958 (fontified t) 958 984 (fontified t) 984 989 (face font-lock-builtin-face fontified t) 989 1012 (fontified t) 1012 1031 (fontified t) 1031 1036 (fontified t) 1036 1069 (fontified t) 1069 1075 (face font-lock-builtin-face fontified t) 1075 1080 (fontified t) 1080 1085 (face font-lock-builtin-face fontified t) 1085 1088 (fontified t) 1088 1094 (face font-lock-string-face fontified t) 1094 1096 (fontified t) 1096 1110 (fontified t) 1110 1118 (face font-lock-builtin-face fontified t) 1118 1121 (fontified t) 1121 1141 (face font-lock-string-face fontified t) 1141 1146 (fontified t) 1146 1153 (fontified t) 1153 1160 (face font-lock-builtin-face fontified t) 1160 1169 (fontified t) 1169 1170 (fontified t rear-nonsticky t) 1170 1171 (fontified t)) . -62620) (undo-tree-id165 . -393) (undo-tree-id166 . -1171) 63791) nil (26798 60456 420764 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60424 . 60425) (nil fontified nil 60423 . 60425) (60423 . 60425) (t 26798 60456 0 0)) nil (26798 61394 184721 0) 0 nil])
([nil nil ((57829 . 57831)) nil (26798 61394 184720 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60411 . 60412) (nil fontified nil 57831 . 60412) (57831 . 60412)) nil (26798 61394 184720 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret nil secret-supplied-p)
                   (required-p nil)
                   (roles-allow nil)
                   (scopes-allow nil))
  \"Middleware qui extrait Authorization: Bearer <jwt>, vÃ©rifie la signature,
et pose :jwt dans le contexte req-ctx.

Options:
 - SECRET : clÃ© HMAC (par dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P : 401 si token manquant/invalide
 - ROLES-ALLOW : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW : liste de scopes requis (:all pour AND logique)\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (let* ((hdrs (lumen.core.http:req-headers req))
               (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
               (tok  (and raw (>= (length raw) 7)
                          (string= (subseq raw 0 7) \"Bearer \")
                          (subseq raw 7))))
          ;; Si token prÃ©sent â†’ tenter decode
          (when tok
            (multiple-value-bind (payload ok)
                (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
              (when ok (lumen.core.http:ctx-set! req :jwt payload))))
          ;; VÃ©rifs
          (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                 (role (and jwt (or (cdr (assoc :role jwt))
                                    (cdr (assoc \"role\" jwt))))))
            (cond
              ((and required-p (null jwt))
               (lumen.core.http:respond-json
                '((:error . ((:type . \"auth\") (:message . \"missing or invalid token\"))))
                :status 401))
              ((and roles-allow jwt
                    (not (member role roles-allow :test #'string=)))
               (lumen.core.http:respond-json
                '((:error . ((:type . \"auth\") (:message . \"forbidden\"))))
                :status 403))
              ((and scopes-allow jwt
                    (not (let ((sc (or (cdr (assoc :scopes jwt))
                                       (cdr (assoc \"scopes\" jwt)))))
                           (cond
                             ((eq scopes-allow :all)
                              (every (lambda (x)
				       (member x sc :test #'string=))
				     scopes-allow))
                             (t
                              (some (lambda (x)
				      (member x sc :test #'string=))
				    scopes-allow))))))
               (lumen.core.http:respond-json
                '((:error . ((:type . \"auth\") (:message . \"insufficient_scope\"))))
                :status 403))
              (t (funcall next req)))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 54 (fontified t) 54 90 (fontified t) 90 127 (fontified t) 127 166 (fontified t) 166 168 (fontified t) 168 352 (face font-lock-doc-face fontified t) 352 520 (face font-lock-doc-face fontified t) 520 524 (fontified t) 524 527 (face font-lock-keyword-face fontified t) 527 538 (fontified t) 538 540 (face font-lock-keyword-face fontified t) 540 602 (fontified t) 602 608 (face font-lock-keyword-face fontified t) 608 623 (fontified t) 623 629 (face font-lock-keyword-face fontified t) 629 645 (fontified t) 645 649 (face font-lock-keyword-face fontified t) 649 725 (fontified t) 725 740 (face font-lock-string-face fontified t) 740 746 (fontified t) 746 751 (face font-lock-builtin-face fontified t) 751 872 (fontified t) 872 881 (face font-lock-string-face fontified t) 881 937 (fontified t) 937 940 (face font-lock-comment-delimiter-face fontified t) 940 973 (face font-lock-comment-face fontified t) 973 984 (fontified t) 984 988 (face font-lock-keyword-face fontified t) 988 1006 (fontified t) 1006 1025 (face font-lock-keyword-face fontified t) 1025 1086 (fontified t) 1086 1093 (face font-lock-builtin-face fontified t) 1093 1101 (fontified t) 1101 1108 (face font-lock-builtin-face fontified t) 1108 1127 (fontified t) 1127 1131 (face font-lock-keyword-face fontified t) 1131 1165 (fontified t) 1165 1169 (face font-lock-builtin-face fontified t) 1169 1192 (fontified t) 1192 1195 (face font-lock-comment-delimiter-face fontified t) 1195 1202 (face font-lock-comment-face fontified t) 1202 1213 (fontified t) 1213 1217 (face font-lock-keyword-face fontified t) 1217 1254 (fontified t) 1254 1258 (face font-lock-builtin-face fontified t) 1258 1309 (fontified t) 1309 1314 (face font-lock-builtin-face fontified t) 1314 1317 (fontified t) 1317 1321 (fontified t) 1321 1369 (fontified t) 1369 1375 (face font-lock-string-face fontified t) 1375 1399 (fontified t) 1399 1403 (face font-lock-keyword-face fontified t) 1403 1427 (fontified t) 1427 1447 (fontified t) 1447 1455 (fontified t) 1455 1485 (fontified t) 1485 1492 (fontified t) 1492 1499 (fontified t) 1499 1501 (fontified t) 1501 1511 (fontified t) 1511 1517 (face font-lock-builtin-face fontified t) 1517 1522 (fontified t) 1522 1527 (face font-lock-builtin-face fontified t) 1527 1530 (fontified t) 1530 1536 (face font-lock-string-face fontified t) 1536 1539 (fontified t) 1539 1547 (face font-lock-builtin-face fontified t) 1547 1550 (fontified t) 1550 1576 (face font-lock-string-face fontified t) 1576 1581 (fontified t) 1581 1597 (fontified t) 1597 1604 (face font-lock-builtin-face fontified t) 1604 1647 (fontified t) 1647 1666 (fontified t) 1666 1697 (fontified t) 1697 1702 (face font-lock-builtin-face fontified t) 1702 1716 (fontified t) 1716 1780 (fontified t) 1780 1786 (face font-lock-builtin-face fontified t) 1786 1791 (fontified t) 1791 1796 (face font-lock-builtin-face fontified t) 1796 1799 (fontified t) 1799 1805 (face font-lock-string-face fontified t) 1805 1808 (fontified t) 1808 1816 (face font-lock-builtin-face fontified t) 1816 1819 (fontified t) 1819 1830 (face font-lock-string-face fontified t) 1830 1851 (fontified t) 1851 1852 (face font-lock-builtin-face fontified t) 1852 1858 (face font-lock-builtin-face fontified t) 1858 1865 (fontified t) 1865 1928 (fontified t) 1928 1931 (face font-lock-keyword-face fontified t) 1931 1953 (fontified t) 1953 1960 (face font-lock-builtin-face fontified t) 1960 2018 (fontified t) 2018 2026 (face font-lock-string-face fontified t) 2026 2064 (fontified t) 2064 2068 (face font-lock-keyword-face fontified t) 2068 2116 (fontified t) 2116 2120 (face font-lock-builtin-face fontified t) 2120 2122 (fontified t) 2122 2160 (fontified t) 2160 2166 (face font-lock-keyword-face fontified t) 2166 2171 (fontified t) 2171 2195 (fontified t) 2195 2200 (face font-lock-builtin-face fontified t) 2200 2222 (fontified t) 2222 2236 (fontified t) 2236 2237 (fontified t) 2237 2269 (fontified t) 2269 2306 (fontified t) 2306 2312 (face font-lock-keyword-face fontified t) 2312 2317 (fontified t) 2317 2340 (fontified t) 2340 2345 (face font-lock-builtin-face fontified t) 2345 2366 (fontified t) 2366 2384 (fontified t) 2384 2385 (fontified t) 2385 2449 (fontified t) 2449 2455 (face font-lock-builtin-face fontified t) 2455 2460 (fontified t) 2460 2465 (face font-lock-builtin-face fontified t) 2465 2468 (fontified t) 2468 2474 (face font-lock-string-face fontified t) 2474 2477 (fontified t) 2477 2485 (face font-lock-builtin-face fontified t) 2485 2488 (fontified t) 2488 2508 (face font-lock-string-face fontified t) 2508 2529 (fontified t) 2529 2536 (face font-lock-builtin-face fontified t) 2536 2543 (fontified t) 2543 2586 (fontified t)) . 55243) (undo-tree-id192 . -2586)) nil (26798 61394 184719 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 55243)) nil (26798 61394 184718 0) 0 nil])
([nil nil ((57676 . 57679) (#(" " 0 1 (fontified nil)) . 57676) (undo-tree-id191 . -1) (57675 . 57676)) nil (26798 61394 184717 0) 0 nil])
([nil nil ((57288 . 57295) (#(" " 0 1 (fontified nil)) . 57287) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (57288 . 57289)) nil (26798 61394 184716 0) 0 nil])
([nil nil ((57326 . 57331) (#(" " 0 1 (fontified nil)) . 57325) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (57326 . 57327)) nil (26798 61394 184714 0) 0 nil])
([nil nil ((57426 . 57433) (#(" " 0 1 (fontified nil)) . 57425) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (57426 . 57427)) nil (26798 61394 184712 0) 0 nil])
([nil nil ((57464 . 57469) (#(" " 0 1 (fontified nil)) . 57463) (undo-tree-id184 . -1) (57464 . 57465)) nil (26798 61394 184710 0) 0 nil])
([nil nil ((57852 . 57853)) nil (26798 61394 184707 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -57852) (undo-tree-id183 . -1) 57853) nil (26798 61394 184704 0) 0 nil])
([nil nil ((31753 . 31758) (t 26798 61394 0 0)) nil (26799 6927 154563 0) 0 nil])
([nil nil ((31758 . 31764)) nil (26799 6927 154563 0) 0 nil])
([nil nil ((31764 . 31765)) nil (26799 6927 154563 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -31759) (undo-tree-id222 . -1) (#("r" 0 1 (fontified t)) . -31760) (undo-tree-id223 . -1) (#("i" 0 1 (fontified t)) . -31761) (undo-tree-id224 . -1) (#("n" 0 1 (fontified t)) . -31762) (undo-tree-id225 . -1) (#("t" 0 1 (fontified t)) . -31763) (undo-tree-id226 . -1) (#(" " 0 1 (fontified t)) . -31764) (undo-tree-id227 . -1) 31765) nil (26799 6927 154562 0) 0 nil])
([nil nil ((31759 . 31765)) nil (26799 6927 154558 0) 0 nil])
([nil nil ((31765 . 31766)) nil (26799 6927 154558 0) 0 nil])
([nil nil ((31766 . 31767)) nil (26799 6927 154558 0) 0 nil])
([nil nil ((31767 . 31768)) nil (26799 6927 154557 0) 0 nil])
([nil nil ((31768 . 31770)) nil (26799 6927 154557 0) 0 nil])
([nil nil ((31770 . 31775)) nil (26799 6927 154556 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-string-face fontified t)) . -31772) (undo-tree-id219 . -1) (#("e" 0 1 (face font-lock-string-face fontified t)) . -31773) (undo-tree-id220 . -1) (#("r" 0 1 (face font-lock-string-face fontified t)) . -31774) (undo-tree-id221 . -1) 31775) nil (26799 6927 154555 0) 0 nil])
([nil nil ((31772 . 31777)) nil (26799 6927 154553 0) 0 nil])
([nil nil ((31777 . 31778)) nil (26799 6927 154553 0) 0 nil])
([nil nil ((31778 . 31781)) nil (26799 6927 154552 0) 0 nil])
([nil nil ((31781 . 31782)) nil (26799 6927 154552 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-string-face fontified t)) . -31780) (undo-tree-id217 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -31781) (undo-tree-id218 . -1) 31782) nil (26799 6927 154551 0) 0 nil])
([nil nil ((31780 . 31783)) nil (26799 6927 154550 0) 0 nil])
([nil nil ((31783 . 31784)) nil (26799 6927 154549 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31790 . 31791) (nil fontified nil 31784 . 31791) (31784 . 31791)) nil (26799 6927 154549 0) 0 nil])
([nil nil ((31791 . 31792)) nil (26799 6927 154548 0) 0 nil])
([nil nil ((31792 . 31797)) nil (26799 6927 154548 0) 0 nil])
([nil nil ((31797 . 31803)) nil (26799 6927 154547 0) 0 nil])
([nil nil ((31803 . 31804)) nil (26799 6927 154546 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31885 . 31886) (nil fontified nil 31831 . 31886) (nil fontified nil 31804 . 31831) (31804 . 31886)) nil (26799 6927 154545 0) 0 nil])
([nil nil ((31886 . 31887)) nil (26799 6927 154545 0) 0 nil])
([nil nil ((31792 . 31797)) nil (26799 6927 154544 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31830 . 31831) (nil fontified nil 31830 . 31831) (nil fontified nil 31829 . 31830) (nil fontified nil 31823 . 31829) (nil fontified nil 31822 . 31823) (nil fontified nil 31807 . 31822) (nil fontified nil 31797 . 31807) (31797 . 31831)) nil (26799 6927 154543 0) 0 nil])
([nil nil ((#("Headers" 0 7 (face font-lock-string-face fontified t)) . -31808) (undo-tree-id207 . -7) (undo-tree-id208 . -4) (undo-tree-id209 . -4) (undo-tree-id210 . -4) (undo-tree-id211 . -4) (undo-tree-id212 . -4) (undo-tree-id213 . -7) (undo-tree-id214 . -7) (undo-tree-id215 . -7) (undo-tree-id216 . -7) 31815) nil (26799 6927 154542 0) 0 nil])
([nil nil ((31808 . 31815)) nil (26799 6927 154534 0) 0 nil])
([nil nil ((31815 . 31816)) nil (26799 6927 154534 0) 0 nil])
([nil nil ((31816 . 31821)) nil (26799 6927 154533 0) 0 nil])
([nil nil ((31821 . 31822)) nil (26799 6927 154533 0) 0 nil])
([nil nil ((#("headers" 0 6 (fontified t) 6 7 (fontified t rear-nonsticky t)) . -31830) (undo-tree-id193 . -7) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -7) (undo-tree-id200 . -7) (undo-tree-id201 . -7) (undo-tree-id202 . -7) (undo-tree-id203 . -7) (undo-tree-id204 . -7) (undo-tree-id205 . -7) (undo-tree-id206 . -7) 31837) nil (26799 6927 154531 0) 0 nil])
([nil nil ((31830 . 31834)) nil (26799 6927 154510 0) 0 nil])
([nil nil ((933 . 934) (t 26799 6927 0 0)) nil (26799 7199 363029 0) 0 nil])
([nil nil ((934 . 943)) nil (26799 7199 363028 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-builtin-face fontified t)) . -942) (undo-tree-id0 . -1) 943) nil (26799 7199 363027 0) 0 nil])
([nil nil ((942 . 946)) nil (26799 7199 363012 0) 0 nil])
([nil nil ((32244 . 32249) (t 26799 7199 0 0)) nil (26799 7368 187675 0) 0 nil])
([nil nil ((32249 . 32255)) nil (26799 7368 187674 0) 0 nil])
([nil nil ((32255 . 32256)) nil (26799 7368 187673 0) 0 nil])
([nil nil ((32256 . 32268)) nil (26799 7368 187670 0) 0 nil])
([nil nil ((#("
    (print (lumen.core.body:parse-urlencoded
				 (lumen.core.http:req-body-stream req) len*))" 0 95 (fontified t)) . 31848) (undo-tree-id1 . -95) (undo-tree-id2 . -95) (undo-tree-id3 . -95) (undo-tree-id4 . -95) (undo-tree-id5 . -95) (undo-tree-id6 . -95) (undo-tree-id7 . -95) (undo-tree-id8 . -95) (undo-tree-id9 . -95) (undo-tree-id10 . -95) (undo-tree-id11 . -95) (undo-tree-id12 . -95) (undo-tree-id13 . -95) (undo-tree-id14 . -95) (undo-tree-id15 . -95) (undo-tree-id16 . -95) (t 26799 7368 0 0)) nil (26799 7415 414850 0) 0 nil])
([nil nil ((56410 . 56414) (t 26799 7415 0 0)) nil (26799 9037 421011 0) 0 nil])
([nil nil ((56414 . 56415)) nil (26799 9037 421010 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -56414) (undo-tree-id76 . -1) 56415) nil (26799 9037 421010 0) 0 nil])
([nil nil ((56414 . 56419)) nil (26799 9037 421009 0) 0 nil])
([nil nil ((56419 . 56420)) nil (26799 9037 421008 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -56419) (undo-tree-id75 . -1) 56420) nil (26799 9037 421008 0) 0 nil])
([nil nil ((56419 . 56420)) nil (26799 9037 421006 0) 0 nil])
([nil nil ((56414 . 56415)) nil (26799 9037 421006 0) 0 nil])
([nil nil ((56421 . 56422)) nil (26799 9037 421005 0) 0 nil])
([nil nil ((56422 . 56423)) nil (26799 9037 421005 0) 0 nil])
([nil nil ((56423 . 56424)) nil (26799 9037 421004 0) 0 nil])
([nil nil ((56424 . 56425)) nil (26799 9037 421004 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -56424) (undo-tree-id74 . -1) 56425) nil (26799 9037 421003 0) 0 nil])
([nil nil ((56424 . 56430)) nil (26799 9037 421002 0) 0 nil])
([nil nil ((56430 . 56431)) nil (26799 9037 421002 0) 0 nil])
([nil nil ((56431 . 56432)) nil (26799 9037 421001 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -56430) (undo-tree-id72 . -1) (#(":" 0 1 (face font-lock-string-face fontified t)) . -56431) (undo-tree-id73 . -1) 56432) nil (26799 9037 421001 0) 0 nil])
([nil nil ((56430 . 56431)) nil (26799 9037 420999 0) 0 nil])
([nil nil ((56431 . 56432)) nil (26799 9037 420998 0) 0 nil])
([nil nil ((56432 . 56437)) nil (26799 9037 420998 0) 0 nil])
([nil nil ((56437 . 56438)) nil (26799 9037 420998 0) 0 nil])
([nil nil ((56438 . 56442)) nil (26799 9037 420997 0) 0 nil])
([nil nil ((56603 . 56611)) nil (26799 9037 420997 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56638 . 56639) (nil fontified nil 56634 . 56639) (nil fontified nil 56621 . 56634) (nil fontified nil 56611 . 56621) (56611 . 56639)) nil (26799 9037 420996 0) 0 nil])
([nil nil ((#("Token" 0 5 (face font-lock-string-face fontified t)) . -56622) (undo-tree-id71 . -5) 56627) nil (26799 9037 420995 0) 0 nil])
([nil nil ((56622 . 56629)) nil (26799 9037 420994 0) 0 nil])
([nil nil ((56635 . 56636)) nil (26799 9037 420994 0) 0 nil])
([nil nil ((56636 . 56637)) nil (26799 9037 420993 0) 0 nil])
([nil nil ((#("P" 0 1 (face font-lock-string-face fontified t)) . -56636) (undo-tree-id70 . -1) 56637) nil (26799 9037 420993 0) 0 nil])
([nil nil ((56636 . 56639)) nil (26799 9037 420991 0) 0 nil])
([nil nil ((56639 . 56640)) nil (26799 9037 420991 0) 0 nil])
([nil nil ((56640 . 56642)) nil (26799 9037 420990 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -56641) (undo-tree-id69 . -1) 56642) nil (26799 9037 420989 0) 0 nil])
([nil nil ((56641 . 56644)) nil (26799 9037 420988 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -56646) (undo-tree-id46 . -3) (undo-tree-id47 . -2) (undo-tree-id48 . -2) (undo-tree-id49 . -2) (undo-tree-id50 . -2) (undo-tree-id51 . -2) (undo-tree-id52 . -3) (undo-tree-id53 . -3) (undo-tree-id54 . -3) (undo-tree-id55 . -3) (undo-tree-id56 . -3) (undo-tree-id57 . -3) (undo-tree-id58 . -3) (undo-tree-id59 . -3) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -3) (undo-tree-id66 . -3) (undo-tree-id67 . -3) (undo-tree-id68 . -3) 56649) nil (26799 9037 420987 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56655 . 56656) (nil fontified nil 56646 . 56656) (56646 . 56656)) nil (26799 9037 420972 0) 0 nil])
([nil nil ((56410 . 56414)) nil (26799 9037 420971 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 56441 . 56442) (nil fontified nil 56437 . 56442) (nil fontified nil 56424 . 56437) (nil fontified nil 56414 . 56424) (56414 . 56442)) nil (26799 9037 420970 0) 0 nil])
([nil nil ((#("Token" 0 5 (face font-lock-string-face fontified t)) . -56425) (undo-tree-id31 . -5) (undo-tree-id32 . -2) (undo-tree-id33 . -2) (undo-tree-id34 . -2) (undo-tree-id35 . -2) (undo-tree-id36 . -2) (undo-tree-id37 . -2) (undo-tree-id38 . -2) (undo-tree-id39 . -2) (undo-tree-id40 . -2) (undo-tree-id41 . -2) (undo-tree-id42 . -5) (undo-tree-id43 . -5) (undo-tree-id44 . -5) (undo-tree-id45 . -5) 56430) nil (26799 9037 420969 0) 0 nil])
([nil nil ((56425 . 56428)) nil (26799 9037 420957 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -56436) (undo-tree-id17 . -3) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -3) (undo-tree-id24 . -3) (undo-tree-id25 . -3) (undo-tree-id26 . -3) (undo-tree-id27 . -3) (undo-tree-id28 . -3) (undo-tree-id29 . -3) (undo-tree-id30 . -3) 56439) nil (26799 9037 420955 0) 0 nil])
([nil nil ((56436 . 56439)) nil (26799 9037 420932 0) 0 nil])
([nil nil ((#("~" 0 1 (face font-lock-string-face fontified t)) . -56665) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) 56666 (t 26799 9037 0 0)) nil (26799 9132 310828 0) 0 nil])
([nil nil ((60027 . 60029) (t 26799 9132 0 0)) nil (26799 16582 479414 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60134 . 60135) (nil fontified nil 60029 . 60135) (60029 . 60135)) nil (26799 16582 479413 0) 0 nil])
([nil nil ((60527 . 60530)) nil (26799 16582 479412 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 60561 . 60562) (nil fontified nil 60530 . 60562) (60530 . 60562)) nil (26799 16582 479411 0) 0 nil])
([nil nil ((60838 . 60839)) nil (26799 16582 479407 0) 0 nil])
([nil nil ((946 . 947) (t 26799 16582 0 0)) nil (26799 48715 862284 0) 0 nil])
([nil nil ((947 . 948)) nil (26799 48715 862283 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 963 . 964) (nil fontified nil 953 . 964) (nil fontified nil 948 . 953) (948 . 964)) nil (26799 48715 862279 0) 0 nil])
([nil nil ((60881 . 60882) (t 26799 48715 0 0)) nil (26800 1416 759359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 63611 . 63612) (nil fontified nil 60882 . 63612) (60882 . 63612)) nil (26800 1416 759359 0) 0 nil])
([nil nil ((#("
(defun https-redirect (&key
                         (prefixes '(\"/\"))     ; prÃ©fixes Ã  forcer en https
                         (ssl-port 443)        ; port public https
                         (hsts nil)            ; ex: t  â†’ ajouter Strict-Transport-Security
                         (hsts-max-age 15552000) ; 180 jours
                         (hsts-include-subdomains t)
                         (hsts-preload nil))
  \"Redirige HTTP â†’ HTTPS (301) pour les chemins dont le prÃ©fixe matche.
Options:
- PREFIXES : liste de prÃ©fixes (strings) Ã  forcer en https (\\\"/\\\" pour tout).
- SSL-PORT : port https externe (443 par dÃ©faut).
- HSTS    : si T, ajoute Strict-Transport-Security (uniquement sur rÃ©ponses *dÃ©jÃ * HTTPS).\"
  (lambda (next)
    (lambda (req)
      (let* ((path (lumen.core.http:req-path req))
             (force-p (some (lambda (pfx) (%path-has-prefix-p path pfx)) prefixes))
             (secure? (%request-secure-p req)))
        (cond
          ;; Si dÃ©jÃ  HTTPS : on laisse passer, et on peut ajouter HSTS si demandÃ©.
          (secure?
           (let ((resp (funcall next req)))
             (when hsts
               (let* ((hdrs (lumen.core.http:resp-headers resp))
                      (val  (with-output-to-string (s)
                              (format s \"max-age=~D\" hsts-max-age)
                              (when hsts-include-subdomains (format s \"; includeSubDomains\"))
                              (when hsts-preload           (format s \"; preload\")))))
                 (setf (lumen.core.http:resp-headers resp)
                       (lumen.utils:ensure-header hdrs \"strict-transport-security\" val))))
             resp))
          ;; HTTP + ciblÃ© â†’ 301 vers https
          ((and force-p (not secure?))
           (let* ((loc (%https-location req :ssl-port ssl-port))
                  (headers (list (cons \"location\" loc)
                                 (cons \"cache-control\" \"no-store\"))))
             (make-instance 'lumen.core.http:response
                            :status 301 :headers headers :body \"\")))
          ;; HTTP mais non ciblÃ© â†’ passer au suivant
          (t
           (funcall next req)))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 22 (face font-lock-function-name-face fontified t) 22 24 (fontified t) 24 28 (face font-lock-type-face fontified t) 28 66 (fontified t) 66 69 (face font-lock-string-face fontified t) 69 76 (fontified t) 76 105 (face font-lock-comment-face fontified t) 105 152 (fontified t) 152 172 (face font-lock-comment-face fontified t) 172 219 (fontified t) 219 264 (face font-lock-comment-face fontified t) 264 313 (fontified t) 313 325 (face font-lock-comment-face fontified t) 325 425 (fontified t) 425 723 (face font-lock-doc-face fontified t) 723 727 (fontified t) 727 733 (face font-lock-keyword-face fontified t) 733 746 (fontified t) 746 752 (face font-lock-keyword-face fontified t) 752 766 (fontified t) 766 770 (face font-lock-keyword-face fontified t) 770 839 (fontified t) 839 843 (face font-lock-keyword-face fontified t) 843 845 (face font-lock-keyword-face fontified t) 845 894 (fontified t) 894 951 (fontified t) 951 955 (face font-lock-keyword-face fontified t) 955 966 (fontified t) 966 969 (face font-lock-comment-delimiter-face fontified t) 969 1039 (face font-lock-comment-face fontified t) 1039 1070 (fontified t) 1070 1073 (face font-lock-keyword-face fontified t) 1073 1116 (fontified t) 1116 1120 (face font-lock-keyword-face fontified t) 1120 1142 (fontified t) 1142 1146 (face font-lock-keyword-face fontified t) 1146 1220 (fontified t) 1220 1241 (face font-lock-keyword-face fontified t) 1241 1286 (fontified t) 1286 1298 (face font-lock-string-face fontified t) 1298 1344 (fontified t) 1344 1348 (face font-lock-keyword-face fontified t) 1348 1383 (fontified t) 1383 1404 (face font-lock-string-face fontified t) 1404 1438 (fontified t) 1438 1442 (face font-lock-keyword-face fontified t) 1442 1476 (fontified t) 1476 1487 (face font-lock-string-face fontified t) 1487 1501 (fontified t) 1501 1516 (fontified t) 1516 1552 (fontified t) 1552 1607 (fontified t) 1607 1634 (face font-lock-string-face fontified t) 1634 1673 (fontified t) 1673 1676 (face font-lock-comment-delimiter-face fontified t) 1676 1706 (face font-lock-comment-face fontified t) 1706 1757 (fontified t) 1757 1761 (face font-lock-keyword-face fontified t) 1761 1789 (fontified t) 1789 1798 (face font-lock-builtin-face fontified t) 1798 1849 (fontified t) 1849 1859 (face font-lock-string-face fontified t) 1859 1904 (fontified t) 1904 1919 (face font-lock-string-face fontified t) 1919 1920 (fontified t) 1920 1930 (face font-lock-string-face fontified t) 1930 2017 (fontified t) 2017 2024 (face font-lock-builtin-face fontified t) 2024 2029 (fontified t) 2029 2037 (face font-lock-builtin-face fontified t) 2037 2046 (fontified t) 2046 2051 (face font-lock-builtin-face fontified t) 2051 2052 (fontified t) 2052 2054 (face font-lock-string-face fontified t) 2054 2068 (fontified t) 2068 2071 (face font-lock-comment-delimiter-face fontified t) 2071 2111 (face font-lock-comment-face fontified t) 2111 2159 (fontified t)) . -63612) (undo-tree-id5 . -2159) 65771) nil (26800 1416 759358 0) 0 nil])
([nil nil ((#("
    (print \"XXXXXXXXX\")" 0 12 (fontified t) 12 23 (face font-lock-string-face fontified t) 23 24 (fontified t)) . 32167) (undo-tree-id4 . -24)) nil (26800 1416 759356 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3757) (undo-tree-id3 . -1) 3758) nil (26800 1416 759355 0) 0 nil])
([nil nil ((#("(let* ((headers (lumen.core.http:req-headers req))
         (ct      (cdr (assoc \"content-type\" headers :test #'string-equal)))
         (len     (cdr (assoc \"content-length\" headers :test #'string-equal)))
         (len*    (when len (parse-integer len :junk-allowed t))))
    (format t \"Headers: ~A~%\" headers)
    (format t \"Content Length: ~A~%\" len*)
    (when (and ct len* (> len* 0)
               (search \"application/x-www-form-urlencoded\" (string-downcase ct)))
      (lumen.core.http:ctx-set! req :form
				(lumen.core.body:parse-urlencoded
				 (lumen.core.http:req-body-stream req) len*))
      (lumen.core.http:ctx-set! req :body-consumed t))
    (funcall next req)))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 81 (fontified t) 81 95 (face font-lock-string-face fontified t) 95 104 (fontified t) 104 109 (face font-lock-builtin-face fontified t) 109 158 (fontified t) 158 174 (face font-lock-string-face fontified t) 174 183 (fontified t) 183 188 (face font-lock-builtin-face fontified t) 188 226 (fontified t) 226 230 (face font-lock-keyword-face fontified t) 230 254 (fontified t) 254 267 (face font-lock-builtin-face fontified t) 267 288 (fontified t) 288 303 (face font-lock-string-face fontified t) 303 327 (fontified t) 327 349 (face font-lock-string-face fontified t) 349 361 (fontified t) 361 365 (face font-lock-keyword-face fontified t) 365 413 (fontified t) 413 448 (face font-lock-string-face fontified t) 448 508 (fontified t) 508 513 (face font-lock-builtin-face fontified t) 513 583 (fontified t) 583 602 (fontified t) 602 638 (fontified t) 638 652 (face font-lock-builtin-face fontified t) 652 656 (fontified t) 656 657 (fontified t) 657 681 (fontified t)) . 31510) (undo-tree-id2 . -681)) nil (26800 1416 759353 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 32168 . 32169) (nil fontified nil 31510 . 32169) (31510 . 32169)) nil (26800 1416 759352 0) 0 nil])
([nil nil ((#("(let* ((h (lumen.core.http:req-headers req))
         (ct (cdr (assoc \"content-type\" h :test #'string-equal)))
         (len (cdr (assoc \"content-length\" h :test #'string-equal)))
         (len* (when len (parse-integer len :junk-allowed t))))
    (when (and ct len* (> len* 0)
               (search \"multipart/form-data\" (string-downcase ct)))
      (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
        (when res
          (lumen.core.http:ctx-set! req :fields (cdr (assoc :fields res)))
          (lumen.core.http:ctx-set! req :files  (cdr (assoc :files  res)))
	  (lumen.core.http:ctx-set! req :body-consumed t)))))
  (funcall next req))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 70 (fontified t) 70 84 (face font-lock-string-face fontified t) 84 87 (fontified t) 87 92 (face font-lock-builtin-face fontified t) 92 137 (fontified t) 137 153 (face font-lock-string-face fontified t) 153 156 (fontified t) 156 161 (face font-lock-builtin-face fontified t) 161 196 (fontified t) 196 200 (face font-lock-keyword-face fontified t) 200 224 (fontified t) 224 237 (face font-lock-builtin-face fontified t) 237 249 (fontified t) 249 253 (face font-lock-keyword-face fontified t) 253 301 (fontified t) 301 322 (face font-lock-string-face fontified t) 322 353 (fontified t) 353 356 (face font-lock-keyword-face fontified t) 356 454 (fontified t) 454 458 (face font-lock-keyword-face fontified t) 458 503 (fontified t) 503 510 (face font-lock-builtin-face fontified t) 510 523 (fontified t) 523 530 (face font-lock-builtin-face fontified t) 530 578 (fontified t) 578 584 (face font-lock-builtin-face fontified t) 584 598 (fontified t) 598 604 (face font-lock-builtin-face fontified t) 604 623 (fontified t) 623 646 (fontified t) 646 660 (face font-lock-builtin-face fontified t) 660 668 (fontified t) 668 689 (fontified t)) . 32279) (undo-tree-id0 . -689) (undo-tree-id1 . -283)) nil (26800 1416 759350 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33052 . 33053) (nil fontified nil 32279 . 33053) (32279 . 33053)) nil (26800 1416 759333 0) 0 nil])
([nil nil ((64236 . 64237) (t 26800 1416 0 0)) nil (26800 38057 103891 0) 0 nil])
([nil nil ((nil fontified nil 65827 . 65828) (nil fontified nil 65807 . 65827) (nil fontified nil 65799 . 65807) (nil fontified nil 65785 . 65799) (nil fontified nil 65753 . 65785) (nil fontified nil 65656 . 65753) (nil fontified nil 65653 . 65656) (nil fontified nil 65642 . 65653) (nil fontified nil 65635 . 65642) (nil fontified nil 65613 . 65635) (nil fontified nil 65599 . 65613) (nil fontified nil 65583 . 65599) (nil fontified nil 65575 . 65583) (nil fontified nil 65549 . 65575) (nil fontified nil 65530 . 65549) (nil fontified nil 65527 . 65530) (nil fontified nil 65522 . 65527) (nil fontified nil 65517 . 65522) (nil fontified nil 65511 . 65517) (nil fontified nil 65445 . 65511) (nil fontified nil 65434 . 65445) (nil fontified nil 65406 . 65434) (nil fontified nil 65402 . 65406) (nil fontified nil 65390 . 65402) (nil fontified nil 65377 . 65390) (nil fontified nil 65316 . 65377) (nil fontified nil 65311 . 65316) (nil fontified nil 65249 . 65311) (nil fontified nil 65233 . 65249) (nil fontified nil 65213 . 65233) (nil fontified nil 65209 . 65213) (nil fontified nil 65206 . 65209) (nil fontified nil 65198 . 65206) (nil fontified nil 65172 . 65198) (nil fontified nil 65168 . 65172) (nil fontified nil 65143 . 65168) (nil fontified nil 65131 . 65143) (nil fontified nil 65126 . 65131) (nil fontified nil 65125 . 65126) (nil fontified nil 65124 . 65125) (nil fontified nil 65123 . 65124) (nil fontified nil 65076 . 65123) (nil fontified nil 65072 . 65076) (nil fontified nil 65071 . 65072) (nil fontified nil 65070 . 65071) (nil fontified nil 65069 . 65070) (nil fontified nil 65060 . 65069) (nil fontified nil 65051 . 65060) (nil fontified nil 65044 . 65051) (nil fontified nil 65027 . 65044) (nil fontified nil 65010 . 65027) (nil fontified nil 65007 . 65010) (nil fontified nil 64999 . 65007) (nil fontified nil 64996 . 64999) (nil fontified nil 64987 . 64996) (nil fontified nil 64984 . 64987) (nil fontified nil 64979 . 64984) (nil fontified nil 64974 . 64979) (nil fontified nil 64968 . 64974) (nil fontified nil 64896 . 64968) (nil fontified nil 64885 . 64896) (nil fontified nil 64876 . 64885) (nil fontified nil 64862 . 64876) (nil fontified nil 64859 . 64862) (nil fontified nil 64835 . 64859) (nil fontified nil 64827 . 64835) (nil fontified nil 64785 . 64827) (nil fontified nil 64779 . 64785) (nil fontified nil 64764 . 64779) (nil fontified nil 64733 . 64764) (nil fontified nil 64634 . 64733) (nil fontified nil 64603 . 64634) (nil fontified nil 64567 . 64603) (nil fontified nil 64564 . 64567) (nil fontified nil 64552 . 64564) (nil fontified nil 64546 . 64552) (nil fontified nil 64403 . 64546) (nil fontified nil 64394 . 64403) (nil fontified nil 64358 . 64394) (nil fontified nil 64354 . 64358) (nil fontified nil 64339 . 64354) (nil fontified nil 64335 . 64339) (nil fontified nil 64308 . 64335) (nil fontified nil 64291 . 64308) (nil fontified nil 64290 . 64291) (nil fontified nil 64289 . 64290) (nil fontified nil 64288 . 64289) (nil fontified nil 64257 . 64288) (nil fontified nil 64241 . 64257) (nil fontified nil 64237 . 64241) (64237 . 65828)) nil (26800 38057 103888 0) 0 nil])
([nil nil ((1288 . 1292) (1242 . 1246) (#("   " 0 3 (fontified nil)) . 1242) (1286 . 1287)) nil (26800 38057 103881 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1322 . 1323) (nil fontified nil 1310 . 1323) (nil fontified nil 1309 . 1310) (nil fontified nil 1308 . 1309) (nil fontified nil 1307 . 1308) (nil fontified nil 1293 . 1307) (nil fontified nil 1292 . 1293) (1292 . 1323)) nil (26800 38057 103879 0) 0 nil])
([nil nil ((65865 . 65866)) nil (26800 38057 103875 0) 0 nil])
([nil nil ((#("define-middleware" 0 17 (face font-lock-keyword-face fontified t)) . -64328) (undo-tree-id21 . -17) 64345 (t 26800 38057 0 0)) nil (26800 38226 689683 0) 0 nil])
([nil nil ((64328 . 64329)) nil (26800 38226 689682 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -64328) (undo-tree-id20 . -1) 64329) nil (26800 38226 689682 0) 0 nil])
([nil nil ((64328 . 64333)) nil (26800 38226 689681 0) 0 nil])
([nil nil ((64375 . 64378)) nil (26800 38226 689680 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 64409 . 64410) (nil fontified nil 64404 . 64410) (nil fontified nil 64398 . 64404) (nil fontified nil 64385 . 64398) (nil fontified nil 64379 . 64385) (nil fontified nil 64378 . 64379) (64378 . 64410)) nil (26800 38226 689680 0) 0 nil])
([nil nil ((65130 . 65132)) nil (26800 38226 689679 0) 0 nil])
([nil nil ((#("define-middleware" 0 5 (face font-lock-keyword-face fontified t) 5 17 (face font-lock-keyword-face fontified t)) . -65188) (undo-tree-id18 . -17) (undo-tree-id19 . -6) 65205) nil (26800 38226 689678 0) 0 nil])
([nil nil ((65188 . 65189)) nil (26800 38226 689676 0) 0 nil])
([nil nil ((65189 . 65193)) nil (26800 38226 689676 0) 0 nil])
([nil nil ((#("req next " 0 9 (fontified t)) . -64351) (undo-tree-id7 . -9) (undo-tree-id8 . -8) (undo-tree-id9 . -8) (undo-tree-id10 . -8) (undo-tree-id11 . -8) (undo-tree-id12 . -9) (undo-tree-id13 . -9) (undo-tree-id14 . -9) (undo-tree-id15 . -9) (undo-tree-id16 . -9) (undo-tree-id17 . -9) 64360) nil (26800 38226 689675 0) 0 nil])
([nil nil ((#("req next " 0 9 (fontified t)) . -65200) (undo-tree-id0 . -9) (undo-tree-id1 . -9) (undo-tree-id2 . -9) (undo-tree-id3 . -9) (undo-tree-id4 . -9) (undo-tree-id5 . -9) (undo-tree-id6 . -9) 65209) nil (26800 38226 689668 0) 0 nil])
([nil nil ((65237 . 65240)) nil (26800 38226 689651 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 65271 . 65272) (nil fontified nil 65266 . 65272) (nil fontified nil 65260 . 65266) (nil fontified nil 65247 . 65260) (nil fontified nil 65241 . 65247) (nil fontified nil 65240 . 65241) (65240 . 65272)) nil (26800 38226 689651 0) 0 nil])
([nil nil ((65142 . 65143) (#("    " 0 4 (fontified t)) . 65142) (65123 . 65126) (65041 . 65044) (64995 . 64999) (64952 . 64956) (64923 . 64927) (64839 . 64842) (#("      " 0 6 (fontified t)) . 64839) (64798 . 64799) (#("    " 0 4 (fontified t)) . 64798) (64751 . 64755) (64715 . 64719) (64660 . 64664) (64617 . 64621) (#("       " 0 7 (fontified t)) . 64617) (64604 . 64606) (#("     " 0 5 (fontified t)) . 64604) (64573 . 64574) (#("    " 0 4 (fontified t)) . 64573) (64557 . 64561) (64533 . 64537) (64470 . 64474) (64404 . 64408) 64327) nil (26800 38226 689649 0) 0 nil])
([nil nil ((65923 . 65924)) nil (26800 38226 689646 0) 0 nil])
([nil nil ((65924 . 65925)) nil (26800 38226 689645 0) 0 nil])
([nil nil ((65910 . 65914) (65852 . 65856) (65746 . 65750) (65725 . 65728) (65659 . 65664) (#("                       " 0 23 (fontified t)) . 65659) (65613 . 65616) (65569 . 65573) (65531 . 65534) (#("      " 0 6 (fontified t)) . 65531) (65504 . 65505) (#("    " 0 4 (fontified t)) . 65504) (65447 . 65451) (65410 . 65414) (65303 . 65307) 65206) nil (26800 38226 689641 0) 0 nil])
([nil nil ((65936 . 65939) (t 26800 38226 0 0)) nil (26800 39792 431436 0) 0 nil])
([nil nil ((65939 . 65940)) nil (26800 39792 431435 0) 0 nil])
([nil nil ((65940 . 65946)) nil (26800 39792 431435 0) 0 nil])
([nil nil ((65946 . 65947)) nil (26800 39792 431435 0) 0 nil])
([nil nil ((65947 . 65950)) nil (26800 39792 431434 0) 0 nil])
([nil nil ((65950 . 65951)) nil (26800 39792 431434 0) 0 nil])
([nil nil ((65951 . 65955)) nil (26800 39792 431433 0) 0 nil])
([nil nil ((65955 . 65956)) nil (26800 39792 431432 0) 0 nil])
([nil nil ((65936 . 65937)) nil (26800 39792 431432 0) 0 nil])
([nil nil ((65956 . 65957)) nil (26800 39792 431431 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 68713 . 68714) (nil fontified nil 65957 . 68714) (65957 . 68714)) nil (26800 39792 431431 0) 0 nil])
([nil nil ((3713 . 3715)) nil (26800 39792 431430 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5899 . 5900) (nil fontified nil 3715 . 5900) (3715 . 5900)) nil (26800 39792 431430 0) 0 nil])
([nil nil ((3181 . 3182)) nil (26800 39792 431429 0) 0 nil])
([nil nil ((3182 . 3184)) nil (26800 39792 431428 0) 0 nil])
([nil nil ((3717 . 3719)) nil (26800 39792 431428 0) 0 nil])
([nil nil ((3719 . 3720)) nil (26800 39792 431427 0) 0 nil])
([nil nil ((1323 . 1324)) nil (26800 39792 431427 0) 0 nil])
([nil nil ((1324 . 1325)) nil (26800 39792 431426 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -1324) (undo-tree-id2 . -1) 1325) nil (26800 39792 431426 0) 0 nil])
([nil nil ((1324 . 1333)) nil (26800 39792 431423 0) 0 nil])
([nil nil ((1324 . 1339) (#("access-lo" 0 9 (fontified t)) . -1324) (undo-tree-id1 . -9) 1333) nil (26800 39792 431422 0) 0 nil])
([nil nil ((1331 . 1332)) nil (26800 39792 431420 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -1331) (undo-tree-id0 . -1) 1332) nil (26800 39792 431418 0) 0 nil])
([nil nil ((1324 . 1325)) nil (26800 39792 431402 0) 0 nil])
([nil nil ((66942 . 66949) (#(" " 0 1 (fontified nil)) . 66941) (undo-tree-id11 . -1) (66942 . 66943) (t 26800 39792 0 0)) nil (26800 40262 284102 0) 0 nil])
([nil nil ((68173 . 68174)) nil (26800 40262 284101 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 72388 . 72389) (nil fontified nil 68174 . 72389) (68174 . 72389)) nil (26800 40262 284100 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -72388) (undo-tree-id10 . -1) 72389) nil (26800 40262 284099 0) 0 nil])
([nil nil ((#("
(defun %open-log-file (path)
  (open path :direction :output :if-exists :append :if-does-not-exist :create
             :external-format :utf-8))

(defun %rfc3339-now ()
  (local-time:format-timestring
   nil (local-time:now)
   :format '(:year \"-\" (:month 2) \"-\" (:day 2) \"T\" (:hour 2) \":\" (:min 2) \":\" (:sec 2) \"Z\")))

(defun access-log-json (&key stream to-file)
  \"Retourne un middleware qui Ã©crit une ligne JSON par requÃªte.
Si TO-FILE est fourni, ouvre le fichier (append, UTF-8) ; sinon utilise STREAM (par dÃ©faut *standard-output*).\"
  (let* ((out (or (and to-file (%open-log-file to-file))
                  (or stream *standard-output*)))
         (lock (bordeaux-threads:make-lock \"access-log-json\")))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0  (get-internal-real-time))
                 (rid (or (lumen.core.http:ctx-get req :request-id) \"\"))
                 (ip  (or (let* ((xff (h \"x-forwarded-for\")))
                            (and xff (car (uiop:split-string xff :separator \",\"))))
                          (h \"x-real-ip\") \"\"))
                 (mth (or (lumen.core.http:req-method req) \"GET\"))
                 (host (or (h \"host\") \"\"))
                 (pth (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms  (/ (- (get-internal-real-time) t0)
                         (/ internal-time-units-per-second 1000.0)))
                 (body (lumen.core.http:resp-body resp))
                 (bytes (cond
                          ((stringp body) (length (trivial-utf-8:string-to-utf-8-bytes body)))
                          ((typep body '(simple-array (unsigned-byte 8) (*))) (length body))
                          (t nil))) ; streaming inconnu â†’ omis
                 (obj `((:ts . ,(%rfc3339-now))
                        (:request_id . ,rid)
                        (:ip . ,ip)
                        (:method . ,mth)
                        (:host . ,host)
                        (:path . ,pth)
                        (:status . ,(lumen.core.http:resp-status resp))
                        (:ms . ,(round ms))
                        ,@(when bytes `((:bytes . ,bytes))))))
            ;; Ã©criture thread-safe
            (bordeaux-threads:with-lock-held (lock)
              (handler-case
                  (progn
                    (write-string (cl-json:encode-json-to-string obj) out)
                    (terpri out)
                    (finish-output out))
                (error (_)
                  (declare (ignore _))
                  (format out \"~S~%\" obj)
                  (finish-output out))))
            resp))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 43 (fontified t) 43 53 (face font-lock-builtin-face fontified t) 53 54 (fontified t) 54 61 (face font-lock-builtin-face fontified t) 61 62 (fontified t) 62 72 (face font-lock-builtin-face fontified t) 72 73 (fontified t) 73 80 (face font-lock-builtin-face fontified t) 80 81 (fontified t) 81 99 (face font-lock-builtin-face fontified t) 99 100 (fontified t) 100 107 (face font-lock-builtin-face fontified t) 107 121 (fontified t) 121 137 (face font-lock-builtin-face fontified t) 137 138 (fontified t) 138 144 (face font-lock-builtin-face fontified t) 144 149 (fontified t) 149 154 (face font-lock-keyword-face fontified t) 154 155 (fontified t) 155 161 (face font-lock-function-name-face fontified t) 161 167 (face font-lock-function-name-face fontified t) 167 171 (fontified t) 171 230 (fontified t) 230 237 (face font-lock-builtin-face fontified t) 237 240 (fontified t) 240 241 (face font-lock-builtin-face fontified t) 241 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 249 (face font-lock-string-face fontified t) 249 251 (fontified t) 251 257 (face font-lock-builtin-face fontified t) 257 261 (fontified t) 261 264 (face font-lock-string-face fontified t) 264 266 (fontified t) 266 270 (face font-lock-builtin-face fontified t) 270 274 (fontified t) 274 277 (face font-lock-string-face fontified t) 277 279 (fontified t) 279 284 (face font-lock-builtin-face fontified t) 284 288 (fontified t) 288 291 (face font-lock-string-face fontified t) 291 293 (fontified t) 293 297 (face font-lock-builtin-face fontified t) 297 301 (fontified t) 301 304 (face font-lock-string-face fontified t) 304 306 (fontified t) 306 310 (face font-lock-builtin-face fontified t) 310 314 (fontified t) 314 317 (face font-lock-string-face fontified t) 317 321 (fontified t) 321 322 (fontified t) 322 323 (fontified t) 323 328 (face font-lock-keyword-face fontified t) 328 329 (fontified t) 329 337 (face font-lock-function-name-face fontified t) 337 344 (face font-lock-function-name-face fontified t) 344 346 (fontified t) 346 350 (face font-lock-type-face fontified t) 350 369 (fontified t) 369 542 (face font-lock-doc-face fontified t) 542 546 (fontified t) 546 550 (face font-lock-keyword-face fontified t) 550 693 (fontified t) 693 710 (face font-lock-string-face fontified t) 710 719 (fontified t) 719 725 (face font-lock-keyword-face fontified t) 725 740 (fontified t) 740 746 (face font-lock-keyword-face fontified t) 746 762 (fontified t) 762 768 (face font-lock-keyword-face fontified t) 768 850 (fontified t) 850 855 (face font-lock-builtin-face fontified t) 855 886 (fontified t) 886 890 (face font-lock-keyword-face fontified t) 890 978 (fontified t) 978 989 (face font-lock-builtin-face fontified t) 989 991 (fontified t) 991 993 (face font-lock-string-face fontified t) 993 1023 (fontified t) 1023 1027 (face font-lock-keyword-face fontified t) 1027 1037 (fontified t) 1037 1054 (face font-lock-string-face fontified t) 1054 1123 (fontified t) 1123 1133 (face font-lock-builtin-face fontified t) 1133 1134 (fontified t) 1134 1137 (face font-lock-string-face fontified t) 1137 1171 (fontified t) 1171 1182 (face font-lock-string-face fontified t) 1182 1184 (fontified t) 1184 1186 (face font-lock-string-face fontified t) 1186 1248 (fontified t) 1248 1253 (face font-lock-string-face fontified t) 1253 1286 (fontified t) 1286 1292 (face font-lock-string-face fontified t) 1292 1294 (fontified t) 1294 1296 (face font-lock-string-face fontified t) 1296 1356 (fontified t) 1356 1359 (face font-lock-string-face fontified t) 1359 1394 (fontified t) 1394 1405 (fontified t) 1405 1501 (fontified t) 1501 1531 (fontified t) 1531 1613 (fontified t) 1613 1617 (face font-lock-keyword-face fontified t) 1617 1837 (fontified t) 1837 1842 (fontified t) 1842 1869 (face font-lock-comment-face fontified t) 1869 1894 (fontified t) 1894 1897 (face font-lock-builtin-face fontified t) 1897 1942 (fontified t) 1942 1953 (face font-lock-builtin-face fontified t) 1953 1987 (fontified t) 1987 1990 (face font-lock-builtin-face fontified t) 1990 2023 (fontified t) 2023 2030 (face font-lock-builtin-face fontified t) 2030 2064 (fontified t) 2064 2069 (face font-lock-builtin-face fontified t) 2069 2104 (fontified t) 2104 2109 (face font-lock-builtin-face fontified t) 2109 2143 (fontified t) 2143 2150 (face font-lock-builtin-face fontified t) 2150 2215 (fontified t) 2215 2218 (face font-lock-builtin-face fontified t) 2218 2261 (fontified t) 2261 2265 (face font-lock-keyword-face fontified t) 2265 2275 (fontified t) 2275 2281 (face font-lock-builtin-face fontified t) 2281 2309 (fontified t) 2309 2312 (face font-lock-comment-delimiter-face fontified t) 2312 2333 (face font-lock-comment-face fontified t) 2333 2346 (fontified t) 2346 2377 (face font-lock-keyword-face fontified t) 2377 2400 (fontified t) 2400 2412 (face font-lock-keyword-face fontified t) 2412 2432 (fontified t) 2432 2437 (face font-lock-keyword-face fontified t) 2437 2604 (fontified t) 2604 2609 (face font-lock-warning-face fontified t) 2609 2633 (fontified t) 2633 2640 (face font-lock-keyword-face fontified t) 2640 2683 (fontified t) 2683 2689 (face font-lock-string-face fontified t) 2689 2757 (fontified t) 2757 2758 (fontified t rear-nonsticky t) 2758 2759 (fontified t)) . -72388) (undo-tree-id3 . -1) (undo-tree-id4 . -173) (undo-tree-id5 . -2759) (undo-tree-id6 . -322) (undo-tree-id7 . -1531) (undo-tree-id8 . -2355) (undo-tree-id9 . -2759) 75147) nil (26800 40262 284096 0) 0 nil])
([nil nil ((72388 . 72389)) nil (26800 40262 284076 0) 0 nil])
([nil nil ((3941 . 3943) (t 26800 40262 0 0)) nil (26800 40390 193153 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5523 . 5524) (nil fontified nil 3943 . 5524) (3943 . 5524)) nil (26800 40390 193152 0) 0 nil])
([nil nil ((#("

(defun logger (&key (stream *terminal-io*) (color t))
  \"Logger concis: [ts] ip METHOD host path -> status (ms)\"
  (lambda (next)
    (lambda (req)
      (labels ((h (name)
                 (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
        (let* ((t0   (get-internal-real-time))
               (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                           (and xff (car (uiop:split-string xff :separator \",\"))))
                         (h \"x-real-ip\") \"\"))
               (host (or (h \"host\") \"\"))
               (meth (or (lumen.core.http:req-method req) \"GET\"))
               (path (or (lumen.core.http:req-path req) \"/\"))
               (resp (funcall next req))
               (ms   (/ (- (get-internal-real-time) t0)
                        (/ internal-time-units-per-second 1000.0)))
               (st   (lumen.core.http:resp-status resp)))
          (if color
              (format stream \"[~A] ~A ~A ~A ~A -> ~C[~A m=~A~C[0m (~,0F ms)~%\"
                      (local-time:format-timestring nil (local-time:now)
                                                    :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                                              (:hour 2) \":\" (:min 2) \":\" (:sec 2)))
                      ip meth host path
                      #\\Esc (concatenate 'string (format nil \"~A\" st)
                                         (format nil \"~C[0;~am\" #\\Esc (%status-color st))) ; pour aligner la coloration
                      #\\Esc
                      ms)
            (format stream \"[~A] ~A ~A ~A ~A -> ~A (~,0F ms)~%\"
                    (local-time:format-timestring nil (local-time:now)
                                                  :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                                            (:hour 2) \":\" (:min 2) \":\" (:sec 2)))
                    ip meth host path st ms))
          (finish-output stream)
          resp)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 15 (face font-lock-function-name-face fontified t) 15 17 (fontified t) 17 21 (face font-lock-type-face fontified t) 21 58 (fontified t) 58 114 (face font-lock-doc-face fontified t) 114 118 (fontified t) 118 124 (face font-lock-keyword-face fontified t) 124 137 (fontified t) 137 143 (face font-lock-keyword-face fontified t) 143 157 (fontified t) 157 163 (face font-lock-keyword-face fontified t) 163 243 (fontified t) 243 248 (face font-lock-builtin-face fontified t) 248 277 (fontified t) 277 281 (face font-lock-keyword-face fontified t) 281 341 (fontified t) 341 345 (face font-lock-keyword-face fontified t) 345 355 (fontified t) 355 372 (face font-lock-string-face fontified t) 372 440 (fontified t) 440 450 (face font-lock-builtin-face fontified t) 450 451 (fontified t) 451 454 (face font-lock-string-face fontified t) 454 487 (fontified t) 487 498 (face font-lock-string-face fontified t) 498 500 (fontified t) 500 502 (face font-lock-string-face fontified t) 502 533 (fontified t) 533 539 (face font-lock-string-face fontified t) 539 541 (fontified t) 541 543 (face font-lock-string-face fontified t) 543 604 (fontified t) 604 609 (face font-lock-string-face fontified t) 609 668 (fontified t) 668 671 (face font-lock-string-face fontified t) 671 764 (fontified t) 764 771 (fontified t) 771 782 (fontified t) 782 839 (fontified t) 839 908 (fontified t) 908 910 (face font-lock-keyword-face fontified t) 910 946 (fontified t) 946 995 (face font-lock-string-face fontified t) 995 1121 (fontified t) 1121 1128 (face font-lock-builtin-face fontified t) 1128 1131 (fontified t) 1131 1136 (face font-lock-builtin-face fontified t) 1136 1137 (fontified t) 1137 1140 (face font-lock-string-face fontified t) 1140 1142 (fontified t) 1142 1148 (face font-lock-builtin-face fontified t) 1148 1152 (fontified t) 1152 1155 (face font-lock-string-face fontified t) 1155 1157 (fontified t) 1157 1161 (face font-lock-builtin-face fontified t) 1161 1165 (fontified t) 1165 1168 (face font-lock-string-face fontified t) 1168 1232 (fontified t) 1232 1237 (face font-lock-builtin-face fontified t) 1237 1241 (fontified t) 1241 1244 (face font-lock-string-face fontified t) 1244 1246 (fontified t) 1246 1250 (face font-lock-builtin-face fontified t) 1250 1254 (fontified t) 1254 1257 (face font-lock-string-face fontified t) 1257 1259 (fontified t) 1259 1263 (face font-lock-builtin-face fontified t) 1263 1297 (fontified t) 1297 1309 (fontified t) 1309 1370 (fontified t) 1370 1374 (face font-lock-string-face fontified t) 1374 1432 (fontified t) 1432 1442 (face font-lock-string-face fontified t) 1442 1470 (fontified t) 1470 1499 (face font-lock-comment-face fontified t) 1499 1501 (fontified t) 1501 1527 (fontified t) 1527 1580 (fontified t) 1580 1616 (face font-lock-string-face fontified t) 1616 1738 (fontified t) 1738 1745 (face font-lock-builtin-face fontified t) 1745 1748 (fontified t) 1748 1753 (face font-lock-builtin-face fontified t) 1753 1754 (fontified t) 1754 1757 (face font-lock-string-face fontified t) 1757 1759 (fontified t) 1759 1765 (face font-lock-builtin-face fontified t) 1765 1769 (fontified t) 1769 1772 (face font-lock-string-face fontified t) 1772 1774 (fontified t) 1774 1778 (face font-lock-builtin-face fontified t) 1778 1782 (fontified t) 1782 1785 (face font-lock-string-face fontified t) 1785 1847 (fontified t) 1847 1852 (face font-lock-builtin-face fontified t) 1852 1856 (fontified t) 1856 1859 (face font-lock-string-face fontified t) 1859 1861 (fontified t) 1861 1865 (face font-lock-builtin-face fontified t) 1865 1869 (fontified t) 1869 1872 (face font-lock-string-face fontified t) 1872 1874 (fontified t) 1874 1878 (face font-lock-builtin-face fontified t) 1878 1981 (fontified t) 1981 1982 (fontified t rear-nonsticky t) 1982 1983 (fontified t)) . -5524) (undo-tree-id13 . -1552) (undo-tree-id14 . -1983) 7507) nil (26800 40390 193152 0) 0 nil])
([nil nil ((5524 . 5525)) nil (26800 40390 193149 0) 0 nil])
([nil nil ((66212 . 66219)) nil (26800 40390 193149 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 66908 . 66909) (nil fontified nil 66219 . 66909) (66219 . 66909)) nil (26800 40390 193148 0) 0 nil])
([nil nil ((#("
      (let* ((lock (bordeaux-threads:make-lock \"rt-lock\"))
             (cv   (bordeaux-threads:make-condition-variable))
             (resp nil)
             (done nil))
	(bordeaux-threads:make-thread
	 (lambda ()
	   (let ((r (funcall next req)))
             (bordeaux-threads:with-lock-held (lock)
               (setf resp r
		     done t)
               (bordeaux-threads:condition-notify cv)))))
	(bordeaux-threads:with-lock-held (lock)
	  (unless (bordeaux-threads:condition-wait cv lock :timeout (/ ms 1000.0))
            ;; timeout â†’ 504
            (return-from request-timeout
              (lumen.core.http:respond-json
               '((:error . ((:type . \"timeout\") (:message . \"gateway timeout\"))))
               :status 504))))
	resp))))
" 0 1 (fontified t) 1 8 (fontified t) 8 12 (face font-lock-keyword-face fontified t) 12 48 (fontified t) 48 57 (face font-lock-string-face fontified t) 57 206 (fontified t) 206 212 (face font-lock-keyword-face fontified t) 212 216 (fontified t) 216 221 (fontified t) 221 224 (face font-lock-keyword-face fontified t) 224 264 (fontified t) 264 295 (face font-lock-keyword-face fontified t) 295 303 (fontified t) 303 346 (fontified t) 346 406 (fontified t) 406 437 (face font-lock-keyword-face fontified t) 437 449 (fontified t) 449 455 (face font-lock-keyword-face fontified t) 455 497 (fontified t) 497 505 (face font-lock-builtin-face fontified t) 505 533 (fontified t) 533 536 (face font-lock-comment-delimiter-face fontified t) 536 550 (face font-lock-comment-face fontified t) 550 563 (fontified t) 563 574 (face font-lock-keyword-face fontified t) 574 653 (fontified t) 653 659 (face font-lock-builtin-face fontified t) 659 664 (fontified t) 664 669 (face font-lock-builtin-face fontified t) 669 672 (fontified t) 672 681 (face font-lock-string-face fontified t) 681 684 (fontified t) 684 692 (face font-lock-builtin-face fontified t) 692 695 (fontified t) 695 712 (face font-lock-string-face fontified t) 712 732 (fontified t) 732 739 (face font-lock-builtin-face fontified t) 739 755 (fontified t) 755 758 (fontified t)) . -66909) (undo-tree-id12 . -758) 67667) nil (26800 40390 193147 0) 0 nil])
([nil nil ((66909 . 66910)) nil (26800 40390 193139 0) 0 nil])
([nil nil ((66910 . 66911)) nil (26800 40390 193138 0) 0 nil])
([nil nil ((66899 . 66900) (#("    " 0 4 (fontified nil)) . 66899) (66911 . 66912)) nil (26800 40390 193137 0) 0 nil])
([nil nil ((66903 . 66906) (66821 . 66824) (66775 . 66779) (66732 . 66736) (66703 . 66707) (66619 . 66622) (#("      " 0 6 (fontified t)) . 66619) (66578 . 66579) (#("    " 0 4 (fontified t)) . 66578) (66531 . 66535) (66502 . 66506) (66447 . 66451) (66404 . 66408) (#("       " 0 7 (fontified t)) . 66404) (66391 . 66393) (#("     " 0 5 (fontified t)) . 66391) (66360 . 66361) (#("    " 0 4 (fontified t)) . 66360) (66344 . 66348) (66281 . 66285) 66138) nil (26800 40390 193132 0) 0 nil])
([nil nil ((#("[" 0 1 (face font-lock-string-face fontified t)) . -5229) (undo-tree-id23 . -1) 5230 (t 26800 40390 0 0)) nil (26800 41888 704006 0) 0 nil])
([nil nil ((5229 . 5230)) nil (26800 41888 704005 0) 0 nil])
([nil nil ((#("[" 0 1 (face font-lock-string-face fontified t)) . -5239) (undo-tree-id22 . -1) 5240) nil (26800 41888 704004 0) 0 nil])
([nil nil ((5239 . 5240)) nil (26800 41888 704003 0) 0 nil])
([nil nil ((3941 . 3943)) nil (26800 41888 704002 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4388 . 4389) (nil fontified nil 3943 . 4389) (3943 . 4389)) nil (26800 41888 704001 0) 0 nil])
([nil nil ((4389 . 4391)) nil (26800 41888 704001 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6414 . 6415) (nil fontified nil 4391 . 6415) (4391 . 6415)) nil (26800 41888 704000 0) 0 nil])
([nil nil ((#("

(defun logger (&key (stream *terminal-io*) (color t))
  \"Logger concis: [ts] ip METHOD host path -> status (ms).\"
  (lambda (next)
    (lambda (req)
      (labels ((h (name)
                 (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
        (let* ((t0   (get-internal-real-time))
               (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                           (and xff (car (uiop:split-string xff :separator \",\"))))
                         (h \"x-real-ip\") \"\"))
               (host (or (h \"host\") \"\"))
               (meth (or (lumen.core.http:req-method req) \"GET\"))
               (path (or (lumen.core.http:req-path req) \"/\"))
               (resp (funcall next req))
               (ms   (/ (- (get-internal-real-time) t0)
                        (/ internal-time-units-per-second 1000.0)))
               (st   (lumen.core.http:resp-status resp))
               (ts   (local-time:format-timestring
                      nil (local-time:now)
                      :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                (:hour 2) \":\" (:min 2) \":\" (:sec 2)))))
          (if color
              ;; Placeholders: ts ip meth host path ESC color st ESC ms  â†’ 10 args
              (format stream \"[~A] ~A ~A ~A ~A -> ~C[0;~am~D~C[0m (~,0F ms)~%\"
                      ts ip meth host path
                      #\\Esc (%status-color st) st #\\Esc ms)
            (format stream \"[~A] ~A ~A ~A ~A -> ~D (~,0F ms)~%\"
                    ts ip meth host path st ms))
          (finish-output stream)
          resp)))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 15 (face font-lock-function-name-face fontified t) 15 17 (fontified t) 17 21 (face font-lock-type-face fontified t) 21 58 (fontified t) 58 115 (face font-lock-doc-face fontified t) 115 119 (fontified t) 119 125 (face font-lock-keyword-face fontified t) 125 138 (fontified t) 138 144 (face font-lock-keyword-face fontified t) 144 158 (fontified t) 158 164 (face font-lock-keyword-face fontified t) 164 244 (fontified t) 244 249 (face font-lock-builtin-face fontified t) 249 278 (fontified t) 278 282 (face font-lock-keyword-face fontified t) 282 342 (fontified t) 342 346 (face font-lock-keyword-face fontified t) 346 356 (fontified t) 356 373 (face font-lock-string-face fontified t) 373 441 (fontified t) 441 451 (face font-lock-builtin-face fontified t) 451 452 (fontified t) 452 455 (face font-lock-string-face fontified t) 455 488 (fontified t) 488 499 (face font-lock-string-face fontified t) 499 501 (fontified t) 501 503 (face font-lock-string-face fontified t) 503 534 (fontified t) 534 540 (face font-lock-string-face fontified t) 540 542 (fontified t) 542 544 (face font-lock-string-face fontified t) 544 605 (fontified t) 605 610 (face font-lock-string-face fontified t) 610 669 (fontified t) 669 672 (face font-lock-string-face fontified t) 672 1013 (fontified t) 1013 1020 (face font-lock-builtin-face fontified t) 1020 1023 (fontified t) 1023 1028 (face font-lock-builtin-face fontified t) 1028 1029 (fontified t) 1029 1032 (face font-lock-string-face fontified t) 1032 1034 (fontified t) 1034 1040 (face font-lock-builtin-face fontified t) 1040 1044 (fontified t) 1044 1047 (face font-lock-string-face fontified t) 1047 1049 (fontified t) 1049 1053 (face font-lock-builtin-face fontified t) 1053 1057 (fontified t) 1057 1060 (face font-lock-string-face fontified t) 1060 1094 (fontified t) 1094 1099 (face font-lock-builtin-face fontified t) 1099 1103 (fontified t) 1103 1106 (face font-lock-string-face fontified t) 1106 1108 (fontified t) 1108 1112 (face font-lock-builtin-face fontified t) 1112 1116 (fontified t) 1116 1119 (face font-lock-string-face fontified t) 1119 1121 (fontified t) 1121 1125 (face font-lock-builtin-face fontified t) 1125 1144 (fontified t) 1144 1146 (face font-lock-keyword-face fontified t) 1146 1167 (fontified t) 1167 1170 (face font-lock-comment-delimiter-face fontified t) 1170 1236 (face font-lock-comment-face fontified t) 1236 1265 (fontified t) 1265 1314 (face font-lock-string-face fontified t) 1314 1315 (fontified t) 1315 1445 (fontified t) 1445 1481 (face font-lock-string-face fontified t) 1481 1501 (fontified t) 1501 1502 (fontified t) 1502 1531 (fontified t) 1531 1564 (fontified t) 1564 1582 (fontified t) 1582 1583 (fontified t rear-nonsticky t)) . -6415) (undo-tree-id15 . -2) (undo-tree-id16 . -1583) (undo-tree-id17 . -1299) (undo-tree-id18 . -1299) (undo-tree-id19 . -1299) (undo-tree-id20 . -1583) (undo-tree-id21 . -1564) 7998) nil (26800 41888 703995 0) 0 nil])
([nil nil ((6415 . 6416) (t 26800 41888 0 0)) nil (26800 41896 747077 0) 0 nil])
([nil nil ((#("o" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -6415) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) 6416) nil (26800 41896 747073 0) 0 nil])
([nil nil ((16252 . 16254) (t 26800 41896 0 0)) nil (26804 50837 230013 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16723 . 16724) (nil fontified nil 16254 . 16724) (16254 . 16724)) nil (26804 50837 230012 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -16723) (undo-tree-id1 . -1) 16724) nil (26804 50837 230011 0) 0 nil])
([nil nil ((23485 . 23486)) nil (26804 50837 230009 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23511 . 23512) (nil fontified nil 23486 . 23512) (23486 . 23512)) nil (26804 50837 230009 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25683 . 25684) (nil fontified nil 25649 . 25684) (25649 . 25684)) nil (26804 50837 230008 0) 0 nil])
([nil nil ((#("((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn    (merge-pathnames try-index dir*))
                                   (bytes (read-file-bytes pn))
                                   (ut    (ignore-errors (file-write-date pn)))
                                   (hdrs  (list (cons \"content-type\" (guess-content-type pn))
                                                (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))))
                              (when ut
                                (setf hdrs (lumen.utils:ensure-header
                                            hdrs \"last-modified\"
                                            (lumen.utils:format-http-date ut))))
                              (make-instance 'lumen.core.http:response
                                             :status 200 :headers hdrs :body bytes)))" 0 92 (fontified t) 92 96 (face font-lock-keyword-face fontified t) 96 246 (fontified t) 246 259 (face font-lock-keyword-face fontified t) 259 283 (fontified t) 283 337 (fontified t) 337 351 (face font-lock-string-face fontified t) 351 431 (fontified t) 431 446 (face font-lock-string-face fontified t) 446 459 (fontified t) 459 479 (face font-lock-string-face fontified t) 479 531 (fontified t) 531 535 (face font-lock-keyword-face fontified t) 535 658 (fontified t) 658 673 (face font-lock-string-face fontified t) 673 687 (fontified t) 687 755 (fontified t) 755 862 (fontified t) 862 871 (fontified t) 871 878 (face font-lock-builtin-face fontified t) 878 883 (fontified t) 883 891 (face font-lock-builtin-face fontified t) 891 897 (fontified t) 897 902 (face font-lock-builtin-face fontified t) 902 911 (fontified t)) . -25712) (undo-tree-id0 . -911) 26623) nil (26804 50837 230007 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26753 . 26754) (nil fontified nil 25712 . 26754) (25712 . 26754)) nil (26804 50837 229993 0) 0 nil])
([nil nil ((26489 . 26498) (#(" " 0 1 (fontified nil)) . 26489) (26488 . 26489)) nil (26804 50837 230047 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 26533) (undo-tree-id11 . -1) (undo-tree-id12 . -1)) nil (26804 50866 359591 0) 0 nil] [nil nil ((#("(" 0 1 (fontified t)) . 26498)) ((26498 . 26499)) (26804 50837 229988 0) 0 nil])
([nil nil ((#("                          " 0 26 (fontified nil)) . -26571) (26533 . 26534)) nil (26804 50866 359589 0) 0 nil])
nil
([nil nil ((#("
" 0 1 (fontified t)) . 26586) (undo-tree-id9 . -1) (undo-tree-id10 . -1)) nil (26804 50866 359589 0) 0 nil])
([nil nil ((#("                          " 0 26 (fontified nil)) . -26624) (26586 . 26587)) nil (26804 50866 359587 0) 0 nil])
([nil nil ((26754 . 26755)) nil (26804 50866 359586 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26778 . 26779) (nil fontified nil 26755 . 26779) (26755 . 26779)) nil (26804 50866 359664 0) 0 nil])
([nil nil ((26882 . 26889) (#(" " 0 1 (fontified nil)) . 26882) (26881 . 26882)) nil (26804 51524 968765 0) 0 nil] [nil nil ((26887 . 26901) (#(" " 0 1 (fontified nil)) . 26886) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (26887 . 26888)) ((#("
" 0 1 (fontified nil)) . 26887) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (26886 . 26887) (#("							       " 0 14 (fontified t)) . 26887) (undo-tree-id15 . -14)) (26804 50866 359581 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 26929)) nil (26804 51524 968764 0) 0 nil])
nil
([nil nil ((#("                     " 0 21 (fontified nil)) . -26972) (26929 . 26930)) nil (26804 51524 968764 0) 0 nil])
([nil nil ((27249 . 27260) (#(" " 0 1 (fontified nil)) . 27248) (undo-tree-id47 . -1) (27249 . 27250)) nil (26804 51524 968763 0) 0 nil])
([nil nil ((27293 . 27305) (#(" " 0 1 (fontified nil)) . 27293) (27292 . 27293)) nil (26804 51524 968762 0) 0 nil])
([nil nil ((#("(ut   (ignore-errors (file-write-date dir*)))" 0 7 (fontified t) 7 20 (face font-lock-keyword-face fontified t) 20 45 (fontified t)) . -27038) (undo-tree-id46 . -45) 27083) nil (26804 51524 968761 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27064 . 27065) (nil fontified nil 27038 . 27065) (27038 . 27065)) nil (26804 51524 968760 0) 0 nil])
([nil nil ((#("ut" 0 2 (fontified t)) . -27343) (undo-tree-id45 . -2) 27345) nil (26804 51524 968759 0) 0 nil])
([nil nil ((27343 . 27345)) nil (26804 51524 968758 0) 0 nil])
([nil nil ((#("(lumen.utils:format-http-date ut)" 0 33 (fontified t)) . -27525) (undo-tree-id44 . -33) 27558) nil (26804 51524 968758 0) 0 nil])
([nil nil ((27525 . 27527)) nil (26804 51524 968755 0) 0 nil])
([nil nil ((#("
                                            " 0 1 (fontified t) 1 45 (fontified t)) . -27480) (undo-tree-id43 . -45) 27525) nil (26804 51524 968755 0) 0 nil])
([nil nil ((27480 . 27481)) nil (26804 51524 968753 0) 0 nil])
([nil nil ((28011 . 28023)) nil (26804 51524 968753 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28047 . 28048) (nil fontified nil 28023 . 28048) (28023 . 28048)) nil (26804 51524 968753 0) 0 nil])
([nil nil ((#("(t
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn    (merge-pathnames spa-fallback root*))
				       (lm   (%file-rfc1123 pn))
                                       (bytes (read-file-bytes pn))
                                       (ut    (ignore-errors (file-write-date pn)))
                                       (hdrs  (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                    (cons \"cache-control\" \"no-store\"))))
                                  (when ut
                                    (setf hdrs (lumen.utils:ensure-header
                                                hdrs \"last-modified\"
                                                (lumen.utils:format-http-date ut))))
                                  (make-instance 'lumen.core.http:response
                                                 :status 200 :headers hdrs :body bytes))
                                (lumen.core.http:respond-404 \"Directory index disabled\")))" 0 32 (fontified t) 32 34 (face font-lock-keyword-face fontified t) 34 163 (fontified t) 163 168 (fontified t) 168 201 (fontified t) 201 205 (face font-lock-keyword-face fontified t) 205 236 (fontified t) 236 242 (fontified t) 242 252 (fontified t) 252 263 (fontified t) 263 287 (fontified t) 287 288 (rear-nonsticky t fontified t) 288 289 (fontified t) 289 393 (fontified t) 393 404 (fontified t) 404 417 (face font-lock-keyword-face fontified t) 417 430 (fontified t) 430 441 (fontified t) 441 473 (fontified t) 473 499 (fontified t) 499 513 (face font-lock-string-face fontified t) 513 514 (fontified t) 514 540 (face font-lock-string-face fontified t) 540 542 (fontified t) 542 600 (fontified t) 600 615 (face font-lock-string-face fontified t) 615 616 (fontified t) 616 626 (face font-lock-string-face fontified t) 626 631 (fontified t) 631 666 (fontified t) 666 670 (face font-lock-keyword-face fontified t) 670 710 (fontified t) 710 748 (fontified t) 748 768 (fontified t) 768 801 (fontified t) 801 816 (face font-lock-string-face fontified t) 816 817 (fontified t) 817 876 (fontified t) 876 902 (fontified t) 902 933 (fontified t) 933 977 (fontified t) 977 1009 (fontified t) 1009 1011 (fontified t) 1011 1026 (fontified t) 1026 1033 (face font-lock-builtin-face fontified t) 1033 1038 (fontified t) 1038 1046 (face font-lock-builtin-face fontified t) 1046 1048 (fontified t) 1048 1052 (fontified t) 1052 1057 (face font-lock-builtin-face fontified t) 1057 1066 (fontified t) 1066 1127 (fontified t) 1127 1153 (face font-lock-string-face fontified t) 1153 1156 (fontified t)) . -27760) (undo-tree-id42 . -1156) 28916) nil (26804 51524 968752 0) 0 nil])
([nil nil ((27734 . 27740) (#("                           " 0 27 (fontified nil)) . 27733) (undo-tree-id40 . -27) (undo-tree-id41 . -27) (27760 . 27761)) nil (26804 51524 968750 0) 0 nil])
([nil nil ((27732 . 27739)) nil (26804 51524 968749 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28838 . 28839) (nil fontified nil 27739 . 28839) (27739 . 28839)) nil (26804 51524 968748 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -28837) (undo-tree-id38 . -1) (#(")" 0 1 (rear-nonsticky t fontified t)) . -28838) (undo-tree-id39 . -1) 28839) nil (26804 51524 968747 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -28847) (undo-tree-id37 . -1) 28848) nil (26804 51524 968745 0) 0 nil])
([nil nil ((28847 . 28848)) nil (26804 51524 968745 0) 0 nil])
([nil nil ((#("

			  " 0 1 (fontified t) 1 2 (fontified t) 2 7 (fontified t)) . -28837) (undo-tree-id36 . -7) 28844) nil (26804 51524 968744 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 28837)) nil (26804 51524 968743 0) 0 nil])
([nil nil ((#("((probe-file target)
                       (let* ((bytes (read-file-bytes target))
                              (ut    (ignore-errors (file-write-date target)))
                              (hdrs  (list (cons \"content-type\" (guess-content-type target))
                                           (cons \"cache-control\" (format nil \"public, max-age=~D\" file-cache-secs)))))
                         (when ut
                           (setf hdrs (lumen.utils:ensure-header
                                       hdrs \"last-modified\"
                                       (lumen.utils:format-http-date ut))))
                         (make-instance 'lumen.core.http:response
                                        :status 200 :headers hdrs :body bytes)))" 0 21 (fontified t) 21 29 (fontified t) 29 45 (fontified t) 45 49 (face font-lock-keyword-face fontified t) 49 84 (fontified t) 84 122 (fontified t) 122 135 (face font-lock-keyword-face fontified t) 135 212 (fontified t) 212 226 (face font-lock-string-face fontified t) 226 305 (fontified t) 305 320 (face font-lock-string-face fontified t) 320 333 (fontified t) 333 353 (face font-lock-string-face fontified t) 353 401 (fontified t) 401 405 (face font-lock-keyword-face fontified t) 405 518 (fontified t) 518 533 (face font-lock-string-face fontified t) 533 554 (fontified t) 554 610 (fontified t) 610 706 (fontified t) 706 716 (fontified t) 716 723 (face font-lock-builtin-face fontified t) 723 728 (fontified t) 728 736 (face font-lock-builtin-face fontified t) 736 742 (fontified t) 742 747 (face font-lock-builtin-face fontified t) 747 756 (fontified t)) . -28916) (undo-tree-id35 . -756) 29672) nil (26804 51524 968742 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 29792 . 29793) (nil fontified nil 28916 . 29793) (28916 . 29793)) nil (26804 51524 968739 0) 0 nil])
([nil nil ((29793 . 29802)) nil (26804 51524 968738 0) 0 nil])
([nil nil ((28840 . 28849)) nil (26804 51524 968738 0) 0 nil])
([nil nil ((#("(if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn    (merge-pathnames spa-fallback root*))
                                  (bytes (read-file-bytes pn))
                                  (ut    (ignore-errors (file-write-date pn)))
                                  (hdrs  (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                               (cons \"cache-control\" \"no-store\"))))
                             (when ut
                               (setf hdrs (lumen.utils:ensure-header
                                           hdrs \"last-modified\"
                                           (lumen.utils:format-http-date ut))))
                             (make-instance 'lumen.core.http:response
                                            :status 200 :headers hdrs :body bytes))
                           (funcall next req))" 0 1 (fontified t) 1 3 (face font-lock-keyword-face fontified t) 3 160 (fontified t) 160 164 (face font-lock-keyword-face fontified t) 164 316 (fontified t) 316 329 (face font-lock-keyword-face fontified t) 329 406 (fontified t) 406 420 (face font-lock-string-face fontified t) 420 421 (fontified t) 421 425 (face font-lock-string-face fontified t) 425 447 (face font-lock-string-face fontified t) 447 449 (fontified t) 449 502 (fontified t) 502 517 (face font-lock-string-face fontified t) 517 518 (fontified t) 518 524 (face font-lock-string-face fontified t) 524 528 (face font-lock-string-face fontified t) 528 533 (fontified t) 533 544 (fontified t) 544 555 (fontified t) 555 563 (fontified t) 563 567 (face font-lock-keyword-face fontified t) 567 571 (fontified t) 571 688 (fontified t) 688 703 (face font-lock-string-face fontified t) 703 714 (fontified t) 714 784 (fontified t) 784 898 (fontified t) 898 905 (face font-lock-builtin-face fontified t) 905 910 (fontified t) 910 918 (face font-lock-builtin-face fontified t) 918 924 (fontified t) 924 929 (face font-lock-builtin-face fontified t) 929 984 (fontified t)) . -29925) (undo-tree-id34 . -984) 30909) nil (26804 51524 968738 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 30821 . 30822) (nil fontified nil 29925 . 30822) (29925 . 30822)) nil (26804 51524 968737 0) 0 nil])
([nil nil ((31015 . 31016)) nil (26804 51524 968736 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -31015) (undo-tree-id33 . -1) 31016) nil (26804 51524 968735 0) 0 nil])
([nil nil ((38042 . 38043)) nil (26804 51524 968734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38228 . 38229) (nil fontified nil 38043 . 38229) (38043 . 38229)) nil (26804 51524 968734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38318 . 38319) (nil fontified nil 38312 . 38319) (38312 . 38319)) nil (26804 51524 968733 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 41621 . 41622) (nil fontified nil 38230 . 41622) (38230 . 41622)) nil (26804 51524 968733 0) 0 nil])
([nil nil ((41622 . 41623)) nil (26804 51524 968732 0) 0 nil])
([nil nil ((#("(defun etag (&key (weak t) (only-status '(200)) (add-cache-control nil))
  \"Ajoute/valide ETag et gÃ¨re 304 si If-None-Match matche.
   - WEAK : si T (dÃ©faut), gÃ©nÃ¨re un ETag faible (W/\\\"...\\\").
   - ONLY-STATUS : liste de statuts concernÃ©s (par dÃ©faut (200)).
   - ADD-CACHE-CONTROL : string optionnelle, ex: \\\"public, max-age=300\\\".\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels ((decorate (resp)
                   (let* ((etag (compute-etag (lumen.core.http:resp-body resp) :weak weak))
                          (hdrs (lumen.core.http:resp-headers resp)))
                     ;; ETag
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header hdrs \"etag\" etag))
                     ;; Cache-Control optionnel
                     (when add-cache-control
                       (setf (lumen.core.http:resp-headers resp)
                             (lumen.utils:ensure-header (lumen.core.http:resp-headers
							 resp)
                                                        \"cache-control\"
							add-cache-control)))
                     resp)))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((resp* (decorate resp))
                     (etag-val (cdr (assoc \"etag\" (lumen.core.http:resp-headers resp*)
                                           :test #'string=)))
                     (inm (cdr (assoc \"if-none-match\"
                                      (lumen.core.http:req-headers req)
                                      :test #'string-equal))))
                (if (and etag-val inm
                         (or (some (lambda (x) (string= x \"*\"))
                                   (%parse-if-none-match inm))
                             (some (lambda (x) (%weak-match-p x etag-val))
                                   (%parse-if-none-match inm))))
                    ;; 304 Not Modified : pas de corps
                    (make-instance 'lumen.core.http:response
                                   :status 304
                                   :headers (lumen.utils:ensure-header
                                             (copy-list (lumen.core.http:resp-headers resp*))
                                             \"etag\" etag-val)
                                   :body \"\")
                    resp*))
              ;; Pas concernÃ© â†’ renvoyer tel quel (mais on peut dÃ©corer si tu veux ETag partout)
              resp))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 11 (face font-lock-function-name-face fontified t) 11 13 (fontified t) 13 17 (face font-lock-type-face fontified t) 17 36 (fontified t) 36 72 (fontified t) 72 73 (fontified t) 73 75 (fontified t) 75 82 (face font-lock-doc-face fontified t) 82 88 (face font-lock-doc-face fontified t) 88 89 (face font-lock-doc-face fontified t rear-nonsticky t) 89 132 (face font-lock-doc-face fontified t) 132 334 (face font-lock-doc-face fontified t) 334 338 (fontified t) 338 344 (face font-lock-keyword-face fontified t) 344 357 (fontified t) 357 363 (face font-lock-keyword-face fontified t) 363 377 (fontified t) 377 381 (face font-lock-keyword-face fontified t) 381 476 (fontified t) 476 482 (face font-lock-keyword-face fontified t) 482 521 (fontified t) 521 525 (face font-lock-keyword-face fontified t) 525 580 (fontified t) 580 585 (face font-lock-builtin-face fontified t) 585 684 (fontified t) 684 687 (face font-lock-comment-delimiter-face fontified t) 687 692 (face font-lock-comment-face fontified t) 692 814 (fontified t) 814 820 (face font-lock-string-face fontified t) 820 849 (fontified t) 849 852 (face font-lock-comment-delimiter-face fontified t) 852 876 (face font-lock-comment-face fontified t) 876 898 (fontified t) 898 902 (face font-lock-keyword-face fontified t) 902 1142 (fontified t) 1142 1157 (face font-lock-string-face fontified t) 1157 1226 (fontified t) 1226 1228 (face font-lock-keyword-face fontified t) 1228 1324 (fontified t) 1324 1328 (face font-lock-keyword-face fontified t) 1328 1397 (fontified t) 1397 1403 (face font-lock-string-face fontified t) 1403 1484 (fontified t) 1484 1489 (face font-lock-builtin-face fontified t) 1489 1507 (fontified t) 1507 1518 (fontified t) 1518 1541 (fontified t) 1541 1543 (face font-lock-string-face fontified t) 1543 1556 (face font-lock-string-face fontified t) 1556 1557 (fontified t) 1557 1573 (fontified t) 1573 1629 (fontified t) 1629 1667 (fontified t) 1667 1672 (face font-lock-builtin-face fontified t) 1672 1709 (fontified t) 1709 1711 (face font-lock-keyword-face fontified t) 1711 1766 (fontified t) 1766 1772 (face font-lock-keyword-face fontified t) 1772 1788 (fontified t) 1788 1791 (face font-lock-string-face fontified t) 1791 1893 (fontified t) 1893 1899 (face font-lock-keyword-face fontified t) 1899 2017 (fontified t) 2017 2020 (face font-lock-comment-delimiter-face fontified t) 2020 2052 (face font-lock-comment-face fontified t) 2052 2148 (fontified t) 2148 2155 (face font-lock-builtin-face fontified t) 2155 2195 (fontified t) 2195 2203 (face font-lock-builtin-face fontified t) 2203 2370 (fontified t) 2370 2376 (face font-lock-string-face fontified t) 2376 2422 (fontified t) 2422 2427 (face font-lock-builtin-face fontified t) 2427 2428 (fontified t) 2428 2430 (face font-lock-string-face fontified t) 2430 2474 (fontified t) 2474 2477 (face font-lock-comment-delimiter-face fontified t) 2477 2557 (face font-lock-comment-face fontified t) 2557 2582 (fontified t)) . -41623) (undo-tree-id27 . -1215) (undo-tree-id28 . -2581) (undo-tree-id29 . -2581) (undo-tree-id30 . -2582) (undo-tree-id31 . -828) (undo-tree-id32 . -454) 44205) nil (26804 51524 968730 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -41621) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) 41622) nil (26804 51524 968724 0) 0 nil])
([nil nil ((733 . 736) (t 26804 51524 0 0)) nil (26804 51808 261100 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 779 . 780) (nil fontified nil 779 . 780) (nil fontified nil 772 . 779) (nil fontified nil 771 . 772) (nil fontified nil 750 . 771) (nil fontified nil 749 . 750) (nil fontified nil 737 . 749) (nil fontified nil 736 . 737) (736 . 780)) nil (26804 51808 261099 0) 0 nil])
([nil nil ((#(":lumen.core.ratelimit" 0 21 (face font-lock-builtin-face fontified t)) . -750) (undo-tree-id49 . -21) 771) nil (26804 51808 261098 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 771 . 772) (nil fontified nil 750 . 772) (750 . 772)) nil (26804 51808 261095 0) 0 nil])
([nil nil ((#(":allow?" 0 7 (face font-lock-builtin-face fontified t)) . -773) (undo-tree-id48 . -7) 780) nil (26804 51808 261093 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 785 . 786) (nil fontified nil 773 . 786) (773 . 786)) nil (26804 51808 261081 0) 0 nil])
([nil nil ((8888 . 8889) (t 26804 51808 0 0)) nil (26805 32724 210724 0) 0 nil])
([nil nil ((8889 . 8891)) nil (26805 32724 210723 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 8891) (undo-tree-id57 . -1)) nil (26805 32724 210723 0) 0 nil])
([nil nil ((8891 . 8892)) nil (26805 32724 210722 0) 0 nil])
([nil nil ((#("[" 0 1 (fontified t)) . -8890) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (#("
" 0 1 (fontified t)) . -8891) (undo-tree-id56 . -1) 8892) nil (26805 32724 210721 0) 0 nil])
([nil nil ((8890 . 8891)) nil (26805 32724 210719 0) 0 nil])
([nil nil ((8891 . 8892)) nil (26805 32724 210718 0) 0 nil])
([nil nil ((#("              " 0 14 (face font-lock-comment-face fontified nil)) . -11932) (11981 . 11982)) nil (26805 32724 210718 0) 0 nil])
([nil nil ((11968 . 11970)) nil (26805 32724 210717 0) 0 nil])
([nil nil ((11970 . 11972)) nil (26805 32724 210717 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18595 . 18596) (nil fontified nil 11972 . 18596) (11972 . 18596)) nil (26805 32724 210716 0) 0 nil])
([nil nil ((975 . 979)) nil (26805 32724 210715 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-builtin-face fontified t)) . -977) (undo-tree-id52 . -1) (#("s" 0 1 (face font-lock-builtin-face fontified t)) . -978) (undo-tree-id53 . -1) 979) nil (26805 32724 210715 0) 0 nil])
([nil nil ((977 . 985)) nil (26805 32724 210712 0) 0 nil])
([nil nil ((985 . 986)) nil (26805 32724 210712 0) 0 nil])
([nil nil ((#("e" 0 1 (face font-lock-builtin-face fontified t)) . -978) (undo-tree-id51 . -1) 979) nil (26805 32724 210711 0) 0 nil])
([nil nil ((978 . 979)) nil (26805 32724 210708 0) 0 nil])
([nil nil ((999 . 1003) (#(" " 0 1 (fontified nil)) . 998) (undo-tree-id50 . -1) (999 . 1000)) nil (26805 32724 210704 0) 0 nil])
([nil nil ((#("
(in-package :lumen.http) ; <-- adapte si ton mw vit ailleurs
" 0 1 (fontified t) 1 2 (fontified t) 2 12 (fontified t face font-lock-keyword-face) 12 13 (fontified t) 13 21 (fontified t face font-lock-builtin-face) 21 24 (face font-lock-builtin-face fontified t) 24 26 (fontified t) 26 62 (face font-lock-comment-face fontified t)) . 12233) (undo-tree-id95 . -62) (undo-tree-id96 . -21) (undo-tree-id97 . -1) (undo-tree-id98 . -21) (undo-tree-id99 . -21) (undo-tree-id100 . -21) (undo-tree-id101 . -21) (undo-tree-id102 . -21) (undo-tree-id103 . -22) (undo-tree-id104 . -22) (undo-tree-id105 . -22) (undo-tree-id106 . -22) (undo-tree-id107 . -23) (undo-tree-id108 . -23) (undo-tree-id109 . -23) (undo-tree-id110 . -23) (undo-tree-id111 . -23) (undo-tree-id112 . -23) (undo-tree-id113 . -23) (undo-tree-id114 . -23) (undo-tree-id115 . -62) (undo-tree-id116 . -62) (undo-tree-id117 . -62) (undo-tree-id118 . -62) (undo-tree-id119 . -62) (undo-tree-id120 . -62) (undo-tree-id121 . -62) (undo-tree-id122 . -62) (undo-tree-id123 . -62) (t 26805 32724 0 0)) nil (26805 32954 418806 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -12232) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) 12233) nil (26805 32954 418778 0) 0 nil])
([nil nil ((787 . 790) (t 26805 32954 0 0)) nil (26806 54397 206745 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 840 . 841) (nil fontified nil 840 . 841) (nil fontified nil 827 . 840) (nil fontified nil 826 . 827) (nil fontified nil 804 . 826) (nil fontified nil 803 . 804) (nil fontified nil 791 . 803) (nil fontified nil 790 . 791) (790 . 841)) nil (26806 54397 206744 0) 0 nil])
([nil nil ((#("http-range" 0 10 (face font-lock-builtin-face fontified t)) . -816) (undo-tree-id10 . -10) 826) nil (26806 54397 206742 0) 0 nil])
([nil nil ((816 . 821)) nil (26806 54397 206741 0) 0 nil])
([nil nil ((#(":respond-file" 0 13 (face font-lock-builtin-face fontified t)) . -822) (undo-tree-id9 . -13) 835) nil (26806 54397 206741 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 850 . 851) (nil fontified nil 836 . 851) (nil fontified nil 835 . 836) (nil fontified nil 834 . 835) (nil fontified nil 822 . 834) (822 . 851)) nil (26806 54397 206740 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.core.proxy :trust-proxy :parse-forwarded)" 0 1 (fontified t) 1 3 (fontified t) 3 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 47 (face font-lock-builtin-face fontified t) 47 48 (fontified t) 48 49 (face font-lock-builtin-face fontified t) 49 63 (face font-lock-builtin-face fontified t) 63 64 (face font-lock-builtin-face rear-nonsticky t fontified t) 64 65 (rear-nonsticky t fontified t)) . 787) (undo-tree-id7 . -65) (undo-tree-id8 . -64)) nil (26806 54397 206739 0) 0 nil])
([nil nil ((787 . 790)) nil (26806 54397 206738 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 840 . 841) (nil fontified nil 840 . 841) (nil fontified nil 827 . 840) (nil fontified nil 826 . 827) (nil fontified nil 804 . 826) (nil fontified nil 803 . 804) (nil fontified nil 791 . 803) (nil fontified nil 790 . 791) (790 . 841)) nil (26806 54397 206737 0) 0 nil])
([nil nil ((#("core." 0 5 (face font-lock-builtin-face fontified t)) . -811) (undo-tree-id6 . -5) 816) nil (26806 54397 206736 0) 0 nil])
([nil nil ((#("range" 0 5 (face font-lock-builtin-face fontified t)) . -816) (undo-tree-id5 . -5) 821) nil (26806 54397 206733 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -815) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 816) nil (26806 54397 206732 0) 0 nil])
([nil nil ((815 . 820)) nil (26806 54397 206730 0) 0 nil])
([nil nil ((#("x" 0 1 (face font-lock-builtin-face fontified t)) . -818) (undo-tree-id1 . -1) (#("y" 0 1 (face font-lock-builtin-face fontified t)) . -819) (undo-tree-id2 . -1) 820) nil (26806 54397 206730 0) 0 nil])
([nil nil ((818 . 821)) nil (26806 54397 206726 0) 0 nil])
([nil nil ((#(":respond-file" 0 13 (face font-lock-builtin-face fontified t)) . -822) (undo-tree-id0 . -13) 835) nil (26806 54397 206725 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 833 . 834) (nil fontified nil 822 . 834) (822 . 834)) nil (26806 54397 206709 0) 0 nil])
([nil nil ((1216 . 1217) (t 26806 54397 0 0)) nil (26806 54409 89847 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-comment-face fontified t)) . -1216) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) 1217) nil (26806 54409 89844 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.http.proxy :trust-proxy)" 0 1 (fontified t) 1 3 (fontified t) 3 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 46 (face font-lock-builtin-face fontified t) 46 47 (face font-lock-builtin-face rear-nonsticky t fontified t) 47 48 (rear-nonsticky t fontified t)) . 787) (undo-tree-id16 . -48) (undo-tree-id17 . -3) (undo-tree-id18 . -24) (undo-tree-id19 . -28) (undo-tree-id20 . -48) (undo-tree-id21 . -48) (undo-tree-id22 . -48) (undo-tree-id23 . -35) (undo-tree-id24 . -48) (t 26806 54409 0 0)) nil (26806 54865 472830 0) 0 nil])
([nil nil ((69081 . 69083) (t 26806 54865 0 0)) nil (26808 13508 722402 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 72979 . 72980) (nil fontified nil 69083 . 72980) (69083 . 72980)) nil (26808 13508 722401 0) 0 nil])
([nil nil ((66357 . 66358)) nil (26808 13508 722401 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . -66357) (undo-tree-id0 . -1) 66358) nil (26808 13508 722400 0) 0 nil])
([nil nil ((66357 . 66358)) nil (26808 13508 722386 0) 0 nil])
([nil nil ((66358 . 66360)) nil (26808 13508 722386 0) 0 nil])
([nil nil ((69085 . 69087)) nil (26808 13508 722385 0) 0 nil])
([nil nil ((69087 . 69088)) nil (26808 13508 722381 0) 0 nil])
([nil nil ((84948 . 84949) (t 26808 13508 0 0)) nil (26809 12807 825619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 85466 . 85467) (nil fontified nil 84949 . 85467) (84949 . 85467)) nil (26809 12807 825617 0) 0 nil])
([nil nil ((1409 . 1414)) nil (26809 12807 825616 0) 0 nil])
([nil nil ((1414 . 1415)) nil (26809 12807 825615 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1430 . 1431) (nil fontified nil 1415 . 1431) (1415 . 1431)) nil (26809 12807 825614 0) 0 nil])
([nil nil ((85489 . 85490)) nil (26809 12807 825607 0) 0 nil])
([nil nil ((385 . 388) (t 26809 12807 0 0)) nil (26809 12898 498003 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 436 . 437) (nil fontified nil 436 . 437) (nil fontified nil 419 . 436) (nil fontified nil 418 . 419) (nil fontified nil 402 . 418) (nil fontified nil 401 . 402) (nil fontified nil 389 . 401) (nil fontified nil 388 . 389) (388 . 437)) nil (26809 12898 498002 0) 0 nil])
([nil nil ((#(":lumen.core.body" 0 16 (face font-lock-builtin-face fontified t)) . -402) (undo-tree-id11 . -16) (undo-tree-id12 . -6) (undo-tree-id13 . -6) (undo-tree-id14 . -6) (undo-tree-id15 . -6) (undo-tree-id16 . -6) (undo-tree-id17 . -16) (undo-tree-id18 . -16) (undo-tree-id19 . -16) (undo-tree-id20 . -16) 418) nil (26809 12898 497999 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 422 . 423) (nil fontified nil 402 . 423) (402 . 423)) nil (26809 12898 497986 0) 0 nil])
([nil nil ((#(":parse-urlencoded" 0 17 (face font-lock-builtin-face fontified t)) . -424) (undo-tree-id1 . -17) (undo-tree-id2 . -6) (undo-tree-id3 . -6) (undo-tree-id4 . -6) (undo-tree-id5 . -6) (undo-tree-id6 . -6) (undo-tree-id7 . -17) (undo-tree-id8 . -17) (undo-tree-id9 . -17) (undo-tree-id10 . -17) 441) nil (26809 12898 497983 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 461 . 462) (nil fontified nil 445 . 462) (nil fontified nil 444 . 445) (nil fontified nil 443 . 444) (nil fontified nil 442 . 443) (nil fontified nil 436 . 442) (nil fontified nil 425 . 436) (nil fontified nil 424 . 425) (424 . 462)) nil (26809 12898 497952 0) 0 nil])
([nil nil ((462 . 463) (t 26809 12898 0 0)) nil (26809 13022 106944 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-builtin-face fontified t)) . -462) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) 463) nil (26809 13022 106939 0) 0 nil])
([nil nil ((1 . 84948) (#("(in-package :cl)

(defpackage :lumen.core.middleware
  (:use :cl :alexandria)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date)
  (:import-from :lumen.core.body :parse-urlencoded)
  (:import-from :lumen.data.repo.core :tenant-id-for-host :tenant-id-by-code)
  (:import-from :lumen.core.session :session-id :session-data :session-get :session-set! :session-del! :verify-signed-sid :sign-sid :store-get :store-put! :store-del! :rand-bytes :*session-ttl* :*session-cookie* :*secure-cookie*)
  (:import-from :lumen.core.jwt :*jwt-secret* :jwt-encode :jwt-decode)
  (:import-from :lumen.core.ratelimit :allow?)
  (:import-from :lumen.core.http-range :respond-file)
  (:export :define-middleware :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :*debug* :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :cors-auto :static-many
	   :form-parser :multipart-parser
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
   :csrf
	   :auth-jwt
   :https-redirect
	   :auth-required :roles-allowed :rate-limit
	   :request-timeout :max-body-size :access-log-json
	   :tenant-from-host))

(in-package :lumen.core.middleware)

(defparameter *debug* nil)  ;; active les prints si T

(defvar *app* (lambda (req)
                (declare (ignore req))
                (lumen.core.http:respond-404 \"No handler\"))
  \"La pile de middlewares active. Toujours mise Ã  jour via (set-app!).\")

(defvar *pipeline-signature* nil
  \"Liste symbolique des middlewares dans l'ordre actuel.\")

(defstruct mw-entry
  name   ;; string (affichage)
  fn)    ;; le factory: (next) -> (lambda (req) ...)

(defun %entry-name (x)
  (etypecase x
    (mw-entry (mw-entry-name x))
    (function \"<fn>\")))  ;; fallback lisible

(defun %entry-fn (x)
  (etypecase x
    (mw-entry (mw-entry-fn x))
    (function x)))

(defun named (name fn-factory)
  \"Wrappe un middleware factory avec un nom (string).\"
  (make-mw-entry :name (string name) :fn fn-factory))

(defmacro ->mw (name form)
  `(lumen.core.middleware:named ,name ,form))

(defun set-app! (&rest middlewares)
  \"Compose la pile. Chaque Ã©lÃ©ment peut Ãªtre:
   - un FUNCTION (factory classique),
   - ou (named \\\"Nom\\\" FUNCTION).\"
  (let* ((fns   (mapcar #'%entry-fn   middlewares))
         (names (mapcar #'%entry-name middlewares)))
    (setf *app* (apply #'my-compose fns)
          *pipeline-signature* names)))

(defun header-ref (headers name)
  (cdr (assoc (string-downcase name) headers :test #'string=)))

(defun my-compose (&rest middlewares)
  \"Construit (req -> resp) en enchaÃ®nant les middlewares dans lâ€™ordre donnÃ©.\"
  (let ((terminal (lambda (req)
                    (declare (ignore req))
                    (respond-404 \"No handler\"))))
    (dolist (mw (reverse middlewares) terminal)
      (setf terminal (funcall mw terminal)))))  ; <-- APPELLE le mw AVEC `next`

(defmacro define-middleware (name (req-sym next-sym) &body body)
  `(defun ,name (,next-sym)
     (lambda (,req-sym)
       ,@body)))

#|
(define-middleware logger (req next)
  (let* ((start (get-internal-real-time))
         (resp (funcall next req))
         (end  (get-internal-real-time))
         (ms   (floor (* 1000.0 (/ (- end start)
                                   internal-time-units-per-second)))))
    (when *debug*
      (format t \"~&[lumen] ~A ~A -> ~A (~A ms)~%\"
              (slot-value req 'lumen.core.http::method)
              (slot-value req 'lumen.core.http::path)
              (lumen.core.http:resp-status resp)
              ms))
    resp))
|#

(defun %status-color (status)
  (cond
    ((<= 200 status 299) \"32\")  ; vert
    ((<= 300 status 399) \"36\")  ; cyan
    ((<= 400 status 499) \"33\")  ; jaune
    (t                          \"31\"))) ; rouge

(defun %emacs-repl-p ()
  \"Vrai si on est dans un REPL Emacs (SLIME/SLY) ou INSIDE_EMACS.\"
  (or (member :swank *features*)
      (member :slynk *features*)
      (uiop:getenv \"INSIDE_EMACS\")))

(defun %supports-ansi-p (stream)
  (declare (ignore stream))
  (and (not (%emacs-repl-p))
       (not (member :win32 *features*))
       (let ((term (uiop:getenv \"TERM\")))
         (and term (not (string= term \"\")) (not (string-equal term \"dumb\"))))))

(defun logger (&key (stream *terminal-io*) (color :auto))
  \"Logger concis: [ts] ip METHOD host path -> status (ms).
COLOR âˆˆ (:auto T NIL) â€” par dÃ©faut :auto (dÃ©sactivÃ© sur consoles sans ANSI).\"
  (let ((color-enabled (if (eq color :auto) (%supports-ansi-p stream) (not (null color)))))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0   (get-internal-real-time))
                 ;; IP: XFF â†’ X-Real-IP â†’ ctx[:remote-addr] â†’ \"-\"
                 (ip   (or (let* ((xff (h \"x-forwarded-for\")))
                             (and xff (string-trim \" \" (car (uiop:split-string xff :separator \",\")))))
                           (h \"x-real-ip\")
                           (lumen.core.http:ctx-get req :remote-addr)
                           \"-\"))
                 (host (or (h \"host\") \"\"))
                 (meth (or (lumen.core.http:req-method req) \"GET\"))
                 (path (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms   (/ (- (get-internal-real-time) t0)
                          (/ internal-time-units-per-second 1000.0)))
                 (msi  (round ms))
                 (st   (lumen.core.http:resp-status resp))
                 (ts   (local-time:format-timestring
                        nil (local-time:now)
                        :format '(:year \"-\" (:month 2) \"-\" (:day 2) \" \"
                                  (:hour 2) \":\" (:min 2) \":\" (:sec 2)))))
            (if color-enabled
                ;; Placeholders: ts ip meth host path ESC color st ESC msi
                (format stream \"[~A] ~A ~A ~A ~A -> ~C[0;~am~D~C[0m (~D ms)~%\"
                        ts ip meth host path
                        #\\Esc (%status-color st) st #\\Esc msi)
              (format stream \"[~A] ~A ~A ~A ~A -> ~D (~D ms)~%\"
                      ts ip meth host path st msi))
            (finish-output stream)
            resp))))))

;; --- Query parser -----------------------------------------------------------
(defun %url-decode (s)
  \"Decode minimal: %HH et '+' -> espace.\"
  (when s
    (with-output-to-string (out)
      (loop for i from 0 below (length s) do
            (let ((c (char s i)))
              (cond
                ((char= c #\\+) (write-char #\\Space out))
                ((and (char= c #\\%)
                      (<= (+ i 2) (1- (length s))))
                 (let* ((h1 (digit-char-p (char s (1+ i)) 16))
                        (h2 (digit-char-p (char s (+ i 2)) 16)))
                   (if (and h1 h2)
                       (progn
                         (write-char (code-char (+ (* h1 16) h2)) out)
                         (incf i 2))
                       (write-char c out))))
                (t (write-char c out))))))))

(defun parse-query-string-to-alist (qs)
  \"Transforme \\\"a=1&b=2&b=3\\\" -> ((\\\"a\\\" . \\\"1\\\") (\\\"b\\\" . \\\"2\\\") (\\\"b\\\" . \\\"3\\\")).\"
  (if (or (null qs) (zerop (length qs)))
      nil
      (loop for pair in (uiop:split-string qs :separator \"&\")
            for p = (position #\\= pair)
            for k = (%url-decode (subseq pair 0 (or p (length pair))))
            for v = (%url-decode (if p (subseq pair (1+ p)) \"\"))
            collect (cons k v))))

(define-middleware query-parser (req next)
  ;; Si req-query est une string, on la remplace par une alist.
  (let* ((q (lumen.core.http:req-query req)))
    (when (stringp q)
      (setf (lumen.core.http:req-query req) (parse-query-string-to-alist q)))
    (funcall next req)))

(defun path-matches? (path paths prefixes)
  (or (and paths (member path paths :test #'string=))
      (and prefixes (some (lambda (pfx)
                            (and (<= (length pfx) (length path))
                                 (string= pfx path :end2 (length pfx))))
                          prefixes))))

(defun json-only (&key paths prefixes)
  \"Middleware factory. Force Content-Type JSON pour les routes listÃ©es.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (path (lumen.core.http:req-path req)))
        (when (path-matches? path paths prefixes)
          (setf (lumen.core.http:resp-headers resp)
                (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                               \"content-type\"
                               \"application/json; charset=utf-8\")))
        resp))))

#|
(defun cors (&key (origins '(\"*\")) (methods '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\"))
                  (headers '(\"Content-Type\" \"Authorization\"))
                  (expose '()) (credentials nil) (max-age 600))
  \"CORS middleware. RÃ©pond aux prÃ©flights (OPTIONS) et enrichit toutes les rÃ©ponses.\"
  (lambda (next)
    (lambda (req)
      (let* ((req-h (lumen.core.http:req-headers req))
             (origin (cdr (assoc \"origin\" req-h :test #'string-equal)))
             (req-method (cdr (assoc \"access-control-request-method\" req-h :test #'string-equal)))
             (preflight (and (stringp req-method)
                             (string= (slot-value req 'lumen.core.http::method) \"OPTIONS\")))
             (allow-origin (cond
                             ((or (null origin) (member \"*\" origins :test #'string=)) \"*\")
                             ((member origin origins :test #'string=) origin)
                             (t nil))))
        (labels ((decorate (resp)
                   (when allow-origin
                     (setf (lumen.core.http:resp-headers resp)
                           (-> (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header \"access-control-allow-origin\" allow-origin)
                               (lumen.utils:ensure-header \"vary\" \"Origin\"))))
                   (when credentials
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                          \"access-control-allow-credentials\" \"true\")))
                   (when expose
                     (setf (lumen.core.http:resp-headers resp)
                           (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                          \"access-control-expose-headers\"
                                          (format nil \"~{~A~^, ~}\" expose))))
                   resp))
          (if preflight
              (let ((resp (make-instance 'lumen.core.http:response
                                         :status 204 :headers nil :body \"\")))
                (when allow-origin
                  (setf (lumen.core.http:resp-headers resp)
                        (-> (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header \"access-control-allow-origin\" allow-origin)
                            (lumen.utils:ensure-header \"access-control-allow-methods\" (format nil \"~{~A~^, ~}\" methods))
                            (lumen.utils:ensure-header \"access-control-allow-headers\" (format nil \"~{~A~^, ~}\" headers))
                            (lumen.utils:ensure-header \"access-control-max-age\" (princ-to-string max-age)))))
                (when credentials
                  (setf (lumen.core.http:resp-headers resp)
                        (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                       \"access-control-allow-credentials\" \"true\")))
                resp)
(decorate (funcall next req))))))))
|#

;;;; ----------------------------------------------------------------------------
;;;; CORS dual-mode (dev permissif / prod strict) + factory via lumen.core.config
;;;; ----------------------------------------------------------------------------
(defun cors (&key (mode :dev)                       ; :dev | :prod
                  (origins '(\"*\"))                  ; whitelist en :prod, ou '(\"*\") en :dev
                  (methods '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\"))
                  (headers '(\"Content-Type\" \"Authorization\"))
                  (expose '()) (credentials nil) (max-age 600))
  \"CORS middleware dual-mode (dev permissif / prod strict).
- MODE       : :dev (permissif) | :prod (strict whitelist)
- ORIGINS    : liste d'origines autorisÃ©es (prod) ou '(\\\"*\\\") (dev)
- CREDENTIALS: si T, on nâ€™Ã©met jamais \\\"*\\\" ; on renvoie lâ€™Origin effectif si autorisÃ©
- MAX-AGE    : secondes de cache prÃ©flight\"
  (lambda (next)
    (lambda (req)
      (let* ((req-h (lumen.core.http:req-headers req))
             (origin (cdr (assoc \"origin\" req-h :test #'string-equal)))
             (acr-method (cdr (assoc \"access-control-request-method\" req-h :test #'string-equal)))
             (acr-headers-req (cdr (assoc \"access-control-request-headers\" req-h :test #'string-equal)))
             (is-options (string= (slot-value req 'lumen.core.http::method) \"OPTIONS\"))
             (preflight (and is-options (stringp acr-method)))
             (allow-origin
               (cond
                 ((eq mode :dev)
                  ;; En dev: permissif ; si credentials, renvoyer origin (si prÃ©sent) plutÃ´t que \"*\"
                  (or (and credentials origin) \"*\"))
                 ((eq mode :prod)
                  (cond
                    ((and origin (member origin origins :test #'string=)) origin)
                    ((member \"*\" origins :test #'string=) \"*\") ; si on veut forcer permissif en prod (dÃ©conseillÃ©)
                    (t nil)))
                 (t nil))))
        (labels
            ((%ensure (resp name value)
               (setf (lumen.core.http:resp-headers resp)
                     (lumen.utils:ensure-header (lumen.core.http:resp-headers resp) name value)))
             (decorate (resp)
               ;; Toujours Vary: Origin (CDN-safe)
               (%ensure resp \"vary\" \"Origin\")
               ;; Allow-Origin (+ credentials si applicable)
               (when allow-origin
                 (let ((effective
                         (if (and credentials (string= allow-origin \"*\") (stringp origin))
                             origin
                             allow-origin)))
                   (%ensure resp \"access-control-allow-origin\" effective)
                   (when (and credentials (not (string= effective \"*\")))
                     (%ensure resp \"access-control-allow-credentials\" \"true\"))))
               ;; Expose-Headers
               (when expose
                 (%ensure resp \"access-control-expose-headers\" (format nil \"~{~A~^, ~}\" expose)))
               resp))
          (if preflight
              (let ((resp (make-instance 'lumen.core.http:response
                                         :status 204 :headers nil :body \"\")))
                ;; Vary complet pour prÃ©flight
                (dolist (h '(\"Origin\" \"Access-Control-Request-Method\" \"Access-Control-Request-Headers\"))
                  (%ensure resp \"vary\" h))
                (when allow-origin
                  (let* ((effective
                           (if (and credentials (string= allow-origin \"*\") (stringp origin))
                               origin
                               allow-origin))
                         (allow-headers
                           ;; Ã©cho des headers demandÃ©s par le client + base configurÃ©e
                           (let ((base (format nil \"~{~A~^, ~}\" headers)))
                             (if (and acr-headers-req (plusp (length acr-headers-req)))
                                 (format nil \"~A, ~A\" base acr-headers-req)
                                 base))))
                    (%ensure resp \"access-control-allow-origin\" effective)
                    (%ensure resp \"access-control-allow-methods\" (format nil \"~{~A~^, ~}\" methods))
                    (%ensure resp \"access-control-allow-headers\" allow-headers)
                    (%ensure resp \"access-control-max-age\" (princ-to-string max-age))
                    (when (and credentials (not (string= effective \"*\")))
                      (%ensure resp \"access-control-allow-credentials\" \"true\"))))
                resp)
              (decorate (funcall next req))))))))

;;; --------------------------------------------------------------------------
;;; Factory branchÃ©e sur lumen.core.config
;;; --------------------------------------------------------------------------

(eval-when (:compile-toplevel :load-toplevel :execute)
  (unless (find-package :lumen.core.config)
    (error \"Le package :lumen.core.config doit Ãªtre chargÃ© avant cors-auto.\")))

(defun %prod-profile-p (profile)
  \"Renvoie T si le profil indique un environnement de prod/staging.\"
  (member profile '(:prod :production :staging) :test #'eq))

(defun cors-auto ()
  \"Construit un mw CORS depuis lumen.core.config.
ClÃ©s supportÃ©es (profilÃ©es par ENV grÃ¢ce Ã  lumen.core.config):
  - :cors/origins        â†’ liste (CSV ou multiple) dâ€™origines autorisÃ©es
  - :cors/credentials    â†’ bool
  - :cors/max-age        â†’ durÃ©e (ex: \\\"600s\\\", \\\"10m\\\")
  - :cors/headers        â†’ liste dâ€™en-tÃªtes acceptÃ©s au prÃ©flight
  - :cors/methods        â†’ liste de mÃ©thodes autorisÃ©es
  - :cors/expose         â†’ liste dâ€™en-tÃªtes exposÃ©s cÃ´tÃ© client\"
  (let* ((profile (lumen.core.config:cfg-profile))
         (mode    (if (%prod-profile-p profile) :prod :dev))
         (origins (or (lumen.core.config:cfg-get-list :cors/origins) (if (eq mode :prod) '() '(\"*\"))))
         (creds   (or (lumen.core.config:cfg-get-bool :cors/credentials :default nil) nil))
         (max-age (or (lumen.core.config:cfg-get-duration :cors/max-age :default \"600s\") 600))
         (hdrs    (or (lumen.core.config:cfg-get-list :cors/headers) '(\"Content-Type\" \"Authorization\")))
         (meths   (or (lumen.core.config:cfg-get-list :cors/methods)
                      '(\"GET\" \"POST\" \"PUT\" \"PATCH\" \"DELETE\" \"OPTIONS\")))
         (xpose   (or (lumen.core.config:cfg-get-list :cors/expose) '())))
    (cors :mode mode
          :origins origins
          :credentials creds
          :max-age max-age
          :headers hdrs
          :methods meths
          :expose xpose)))

(defun guess-content-type (pathname)
  (let* ((s (string-downcase (or (pathname-type pathname) \"\"))))
    (cond
      ((string= s \"html\") \"text/html; charset=utf-8\")
      ((string= s \"css\")  \"text/css; charset=utf-8\")
      ((string= s \"js\")   \"application/javascript; charset=utf-8\")
      ((member s '(\"png\" \"jpg\" \"jpeg\" \"gif\" \"webp\") :test #'string=) (format nil \"image/~A\" s))
      ((string= s \"svg\")  \"image/svg+xml\")
      ((string= s \"json\") \"application/json; charset=utf-8\")
      (t \"application/octet-stream\"))))

(defun read-file-bytes (pathname)
  (with-open-file (in pathname :element-type '(unsigned-byte 8))
    (let* ((size (file-length in))
           (buf  (make-array size :element-type '(unsigned-byte 8))))
      (read-sequence buf in)
      buf)))

(defun safe-join (root rel)
  \"ConcatÃ¨ne ROOT et REL en empÃªchant tout Ã©chappement (.., backslashes, drive, etc.).\"
  (print \"IN SAFE JOIN\")
  (let* ((rel* (or rel \"\"))
         ;; remplace backslashes et retire .. :
         (rel1 (substitute #\\/ #\\\\ rel*))
         (rel2 (with-output-to-string (s)
                 (dolist (part (remove-if #'(lambda (p) (or (string= p \"\")
                                                            (string= p \".\")))
                                          (uiop:split-string rel1 :separator \"/\")))
                   (unless (string= part \"..\")
                     (format s \"~A/\" part)))))
         ;; retire le slash final ajoutÃ© si rel ne devait pas en avoir
         (rel3 (if (and (> (length rel2) 0)
                        (char= (char rel2 (1- (length rel2))) #\\/)
                        (not (and (> (length rel1) 0)
                                  (char= (char rel1 (1- (length rel1))) #\\/))))
                  (subseq rel2 0 (1- (length rel2)))
                  rel2))
         (abs (merge-pathnames rel3 (uiop:ensure-directory-pathname (truename root)))))
    ;; sÃ©curitÃ© : lâ€™abs doit rester sous root
    (let* ((root* (namestring (uiop:ensure-directory-pathname (truename root))))
           (abs*  (namestring (truename abs))))
      (if (and (>= (length abs*) (length root*))
               (string= root* abs* :end2 (length root*)))
          abs
          (uiop:merge-pathnames* #P\"__forbidden__\" (truename root))))))

(defun directory-index-html (dir rel-url &key (hide-dotfiles t))
  \"GÃ©nÃ¨re un index HTML simple pour DIR.
REL-URL doit commencer par / et prÃ©ciser le chemin demandÃ© (avec / final pour les dossiers).\"
  (let* ((rel (or rel-url \"/\"))
         (rel* (if (char= (char rel (1- (length rel))) #\\/) rel (concatenate 'string rel \"/\")))
         (files (uiop:directory-files dir))
         (subs  (uiop:subdirectories dir)))
    (labels ((visible-p (pn)
               (let ((name (car (last (uiop:split-string (namestring pn) :separator \"/\")))))
                 (or (not hide-dotfiles)
                     (and name (not (and (> (length name) 0) (char= (char name 0) #\\.))))))))
      (with-output-to-string (s)
        (format s \"<!doctype html><meta charset='utf-8'><title>Index of ~A</title>\" rel*)
        (format s \"<style>body{font:14px system-ui,Segoe UI,Roboto,sans-serif;margin:24px}ul{list-style:none;padding-left:0}li{margin:2px 0}</style>\")
        (format s \"<h1>Index of ~A</h1><ul>\" rel*)
        (when (> (length rel*) 1)
          ;; lien vers le parent
          (let* ((trim (if (char= (char rel* (1- (length rel*))) #\\/)
                           (subseq rel* 0 (1- (length rel*)))
                           rel*))
                 (pidx (or (position #\\/ trim :from-end t) 0))
                 (up (if (= pidx 0) \"/\" (subseq trim 0 pidx))))
            (format s \"<li>â†©ï¸Ž <a href='~A'>..</a></li>\" up)))
        (dolist (sd (sort (remove-if-not #'visible-p subs) #'string< :key #'namestring))
          (let* ((nm (car (last (uiop:split-string (namestring sd) :separator \"/\")))))
            (format s \"<li>ðŸ“ <a href='~A/'>~A/</a></li>\" nm nm)))
        (dolist (f (sort (remove-if-not #'visible-p files) #'string< :key #'namestring))
          (let* ((nm (car (last (uiop:split-string (namestring f) :separator \"/\")))))
            (format s \"<li>ðŸ“„ <a href='~A'>~A</a></li>\" nm nm)))
        (format s \"</ul>\")))))

(defun method-get-or-head-p (req)
  (let ((m (slot-value req 'lumen.core.http::method)))
    (or (string= m \"GET\") (string= m \"HEAD\"))))

(defun %file-rfc1123 (pn)
  (let ((ut (ignore-errors (file-write-date pn))))
    (and ut (lumen.utils:format-http-date ut))))

(defun %weak-etag-from-file (pn)
  \"Weak ETag sans lecture du contenu: taille+mtime.\"
  (handler-case
      (let* ((size (with-open-file (in pn :direction :input :element-type '(unsigned-byte 8))
                     (file-length in)))
             (mt   (file-write-date pn)))
        (format nil \"W/\\\"~X-~X\\\"\" size mt))
    (error () nil)))

;;; ---------- Static middleware ------------------------------------------------
#|
(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
		 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR.

Options:
- AUTO-INDEX      : T â†’ gÃ©nÃ¨re un listing HTML si pas d'index.
- TRY-INDEX       : nom d'index Ã  servir (string) ou NIL pour dÃ©sactiver.
- REDIRECT-DIR    : T â†’ redirige /chemin â†’ /chemin/ (301) pour les dossiers.
- HIDE-DOTFILES   : T â†’ masque fichiers/dirs commenÃ§ant par '.' dans le listing.
- FILE-CACHE-SECS : Â« Cache-Control Â» pour fichiers (par dÃ©faut 3600).
- DIR-CACHE-SECS  : Â« Cache-Control Â» pour index/dir (par dÃ©faut 300).
- SPA-FALLBACK : string (ex. \\\"index.html\\\") servi quand *aucun fichier*
  ne correspond sous PREFIX, pour GET/HEAD uniquement (idÃ©al pour SPA).

NB: Le corps est envoyÃ© en octets (vecteur (unsigned-byte 8)).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (lumen.utils:str-prefix-p prefix* path)	      
              (let* ((rel    (subseq path plen)) ; peut Ãªtre \"\" ou \"foo/bar\"
                     (target (safe-join root* rel))
                     (dir-truename (ignore-errors (lumen.utils:probe-directory
						   target)))
		     (ut (file-write-date pathname)))
                (handler-case
                    (cond
                      ;; -------- Dossier ----------
                      (dir-truename
                       (let* ((has-slash (and (> (length path) 0)
                                              (char= (char path (1- (length path))) #\\/)))
                              (dir* (uiop:ensure-directory-pathname dir-truename)))
                         (cond
                           ;; /dir â†’ /dir/
                           ((and redirect-dir (not has-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                          (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                           :body \"\"))
                           ;; index.html si prÃ©sent
                           ((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn (merge-pathnames try-index dir*))
                                   (bytes (read-file-bytes pn)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" (guess-content-type pn))
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body bytes)))
                           ;; listing auto
                           (auto-index
                            (let* ((html (directory-index-html dir* (if (plusp (length path)) path \"/\")
                                                               :hide-dotfiles hide-dotfiles)))
                              (make-instance 'lumen.core.http:response
                                             :status 200
                                             :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                            (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                             :body html)))
                           (t
			    ;; pas d'index ni listing â†’ fallback SPA si demandÃ©, sinon 404
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn (merge-pathnames spa-fallback root*))
                                       (bytes (read-file-bytes pn)))
                                  (make-instance 'lumen.core.http:response
                                                 :status 200
                                                 :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                                (cons \"cache-control\" \"no-store\"))
                                                 :body bytes))
                                (lumen.core.http:respond-404 \"Directory index disabled\"))))))
                      ;; -------- Fichier ----------
                      ((probe-file target)
		       (let* ((bytes (read-file-bytes target)))
                         (make-instance 'lumen.core.http:response
                                        :status 200
                                        :headers (list (cons \"content-type\" (guess-content-type target))
						       (cons \"cache-control\" (format nil \"public, max-age=~D\" file-cache-secs)))
                                        :body bytes)))
                      ;; -------- Rien pour ce prefix â†’ passe au suivant ----------
                      (t
		       (if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn (merge-pathnames spa-fallback root*))
                                  (bytes (read-file-bytes pn)))
                             (make-instance 'lumen.core.http:response
                                            :status 200
                                            :headers (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                                           (cons \"cache-control\" \"no-store\"))
                                            :body bytes))
                           (funcall next req))))
                  (error ()
		    (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passe au suivant
(funcall next req)))))))
|#

(defun static (&key prefix dir
                 (auto-index t)
                 (try-index \"index.html\")
                 (redirect-dir t)
                 (hide-dotfiles t)
                 (file-cache-secs 3600)
                 (dir-cache-secs 300)
                 (spa-fallback nil))
  \"Servez des fichiers ET des dossiers sous PREFIX Ã  partir du dossier DIR (optimisÃ© streaming/Range).

Options:
- AUTO-INDEX      : T â†’ gÃ©nÃ¨re un listing HTML si pas d'index.
- TRY-INDEX       : nom d'index Ã  servir (string) ou NIL pour dÃ©sactiver.
- REDIRECT-DIR    : T â†’ redirige /chemin â†’ /chemin/ (301) pour les dossiers.
- HIDE-DOTFILES   : T â†’ masque fichiers/dirs commenÃ§ant par '.' dans le listing.
- FILE-CACHE-SECS : Â« Cache-Control Â» pour fichiers (par dÃ©faut 3600).
- DIR-CACHE-SECS  : Â« Cache-Control Â» pour index/dir (par dÃ©faut 300).
- SPA-FALLBACK    : string (ex. \\\"index.html\\\") servi quand *aucun fichier*
  ne correspond sous PREFIX, pour GET/HEAD uniquement (idÃ©al pour SPA).\"
  (let* ((prefix* (or prefix \"/\"))
         (root*   (truename dir))
         (plen    (length prefix*)))
    (lambda (next)
      (lambda (req)
        (let ((path (lumen.core.http:req-path req)))
          (if (and (>= (length path) plen)
                   (string= prefix* path :end2 plen)) ; Ã©vite dÃ©pendre dâ€™un util ici
              (let* ((rel    (subseq path plen))         ; \"\" ou \"foo/bar\"
                     (target (safe-join root* rel))
                     (dir-truename (ignore-errors (lumen.utils:probe-directory target))))
                (handler-case
                    (cond
                      ;; -------- Dossier ----------
                      (dir-truename
                       (let* ((has-slash (and (> (length path) 0)
                                              (char= (char path (1- (length path))) #\\/)))
                              (dir* (uiop:ensure-directory-pathname dir-truename)))
                         (cond
                           ;; /dir â†’ /dir/ (301)
                           ((and redirect-dir (not has-slash))
                            (make-instance 'lumen.core.http:response
                                           :status 301
                                           :headers (list (cons \"location\" (concatenate 'string path \"/\"))
                                                          (cons \"cache-control\" (format nil \"public, max-age=~D\" dir-cache-secs)))
                                           :body \"\"))
                           ;; index.html si prÃ©sent â†’ respond-file (streaming + Range)
                           ((and try-index (probe-file (merge-pathnames try-index dir*)))
                            (let* ((pn   (merge-pathnames try-index dir*))
                                   (ct   (guess-content-type pn))
                                   (lm   (%file-rfc1123 pn))
                                   (etag (%weak-etag-from-file pn))
                                   (resp (lumen.core.http-range:respond-file
                                          req pn
                                          :content-type ct
                                          :last-modified-rfc1123 lm
                                          :etag etag)))
                              (setf (lumen.core.http:resp-headers resp)
                                    (lumen.utils:ensure-header
				     (lumen.core.http:resp-headers resp)
                                     \"cache-control\"
                                     (format nil \"public, max-age=~D\" dir-cache-secs)))
                              resp))
                           ;; listing auto (gÃ©nÃ¨re HTML en mÃ©moire)
                           (auto-index
                            (let* ((html (directory-index-html
					  dir* (if (plusp (length path)) path \"/\")
                                          :hide-dotfiles hide-dotfiles))
                                   (lm   (%file-rfc1123 dir*))
                                   (hdrs (list (cons \"content-type\" \"text/html; charset=utf-8\")
                                               (cons \"cache-control\"
						     (format nil \"public, max-age=~D\"
							     dir-cache-secs)))))
                              (when lm
                                (setf hdrs (lumen.utils:ensure-header
                                            hdrs \"last-modified\" lm)))
                              (make-instance 'lumen.core.http:response
                                             :status 200 :headers hdrs :body html)))
                           ;; pas d'index ni listing â†’ SPA fallback si demandÃ©, sinon 404
			   (t
                            (if (and spa-fallback (method-get-or-head-p req)
                                     (probe-file (merge-pathnames spa-fallback root*)))
                                (let* ((pn   (merge-pathnames spa-fallback root*))
                                       (lm   (%file-rfc1123 pn))
                                       (resp (lumen.core.http-range:respond-file
                                              req pn
                                              :content-type \"text/html; charset=utf-8\"
                                              :last-modified-rfc1123 lm)))
                                  ;; SPA: pas de cache persistant
                                  (setf (lumen.core.http:resp-headers resp)
                                        (lumen.utils:ensure-header
                                         (lumen.core.http:resp-headers resp)
                                         \"cache-control\" \"no-store\"))
                                  resp)
                                (lumen.core.http:respond-404 \"Directory index disabled\"))))))
		      
                      ;; -------- Fichier ----------
                      ((probe-file target)
                       (let* ((ct   (guess-content-type target))
                              (lm   (%file-rfc1123 target))
                              (etag (%weak-etag-from-file target))
                              (resp (lumen.core.http-range:respond-file
                                     req target
                                     :content-type ct
                                     :last-modified-rfc1123 lm
                                     :etag etag)))
                         (setf (lumen.core.http:resp-headers resp)
                               (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                          \"cache-control\"
                                                          (format nil \"public, max-age=~D\" file-cache-secs)))
                         resp))
		      
                      ;; -------- Rien pour ce prefix ----------
                      (t
                       (if (and spa-fallback (method-get-or-head-p req)
                                (probe-file (merge-pathnames spa-fallback root*)))
                           (let* ((pn   (merge-pathnames spa-fallback root*))
                                  (lm   (%file-rfc1123 pn))
                                  (resp (lumen.core.http-range:respond-file
                                         req pn
                                         :content-type \"text/html; charset=utf-8\"
                                         :last-modified-rfc1123 lm)))
                             (setf (lumen.core.http:resp-headers resp)
                                   (lumen.utils:ensure-header
                                    (lumen.core.http:resp-headers resp)
                                    \"cache-control\" \"no-store\"))
                             resp)
                           (funcall next req))))
                  (error ()
                    (lumen.core.http:respond-404 \"File error\"))))
              ;; prefix ne matche pas â†’ passer au suivant
              (funcall next req)))))))
 
(defun static-many (&rest mounts)
  \"Monte plusieurs middlewares static en cascade.
MOUNTS: soit des PLISTs pour (static ...), soit des factories (next->handler).\"
  (let* ((factories
           (mapcar (lambda (m)
                     (etypecase m
                       (function m)                 ; dÃ©jÃ  une factory
                       (list     (apply #'static m)))) ; spec â†’ factory
                   mounts)))
    (lambda (next)
      (let ((acc next))
        (dolist (f (reverse factories) acc)
          (let ((wrapped (funcall f acc)))
            (unless (functionp wrapped)
              (error \"static-many: chaque element doit etre une FACTORY (next->handler). ~
                      Cet element a retourne ~S, pas une fonction. ~%~
                      Indice: ne passe pas un HANDLER (req->resp), mais une FACTORY.\"
                     wrapped))
            (setf acc wrapped)))))))

;;; ---------------- Cookies ----------------------------------------------------

(define-middleware cookies-parser (req next)
  \"Parse Cookie: â€¦ â†’ req-cookies (alist).\"
  (let* ((h (lumen.core.http:req-headers req))
         (raw (cdr (assoc \"cookie\" h :test #'string-equal))))
    (when raw
      (setf (lumen.core.http:req-cookies req)
            (lumen.core.http:parse-cookie-header raw))))
  (funcall next req))

(defun cookie (req name)
  \"Lit un cookie par nom (string), ou NIL.\"
  (cdr (assoc name (lumen.core.http:req-cookies req) :test #'string=)))

(defun set-cookie! (resp name value &rest opts)
  \"Ajoute un header Set-Cookie formatÃ© Ã  la rÃ©ponse.\"
  (lumen.core.http:add-set-cookie
   resp
   (apply #'lumen.core.http:format-set-cookie name value opts)))

;;; ---------------- Error wrapper ---------------------------------------------

(defparameter *error-handler*
  (lambda (e req)
    (declare (ignore req))
    ;; Rendu JSON par dÃ©faut ; en dev on imprime une backtrace
    (let* ((msg (princ-to-string e))
           (bt  (when *debug*
                  (with-output-to-string (s)
                    (ignore-errors (uiop:print-backtrace :stream s)))))
           (payload `((:error . ((:type . \"internal\")
                                  (:message . ,msg)
                                  ,@(when bt (list (cons :backtrace bt))))))))
      (lumen.core.http:respond-json payload :status 500))))

(define-middleware error-wrapper (req next)
  \"Capture toute condition et rend une 500 propre via *error-handler*.\"
  (handler-case
      (funcall next req)
    (error (e)
      (funcall *error-handler* e req))))

;;; ---------------- Request-ID -------------------------------------------------

(defun %rand-hex (nbytes)
  (let ((hex \"0123456789abcdef\"))
    (with-output-to-string (s)
      (dotimes (i (* 2 nbytes))
        (write-char (char hex (random 16)) s)))))

(defun make-request-id ()
  \"UUIDv4-ish (hex) simple, suffisant pour corrÃ©lation de logs.\"
  (let ((h (%rand-hex 16)))
    ;; 8-4-4-4-12 avec bits de version 4 (optionnel simplifiÃ©)
    (format nil \"~A-~A-4~A-~A~A-~A\"
            (subseq h 0 8) (subseq h 8 12) (subseq h 13 16)
            (subseq h 16 17) (subseq h 17 20) (subseq h 20 32))))

(define-middleware request-id (req next)
  \"Injecte un X-Request-ID dans la rÃ©ponse, disponible aussi via req-ctx.\"
  (let* ((rid (or (lumen.core.http:ctx-get req :request-id)
                  (make-request-id)))
         (resp (progn
                 (lumen.core.http:ctx-set! req :request-id rid)
                 (funcall next req))))
    (setf (lumen.core.http:resp-headers resp)
          (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                         \"x-request-id\" rid))
    resp))

;; Form parser
(define-middleware form-parser (req next)
  \"Parse application/x-www-form-urlencoded â†’ ctx[:form] (alist).\"
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((headers (lumen.core.http:req-headers req))
           (ct  (cdr (assoc \"content-type\" headers :test #'string-equal)))
           (len (cdr (assoc \"content-length\" headers :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0)
                 (search \"application/x-www-form-urlencoded\" (string-downcase ct)))
        (lumen.core.http:ctx-set! req :form
          (lumen.core.body:parse-urlencoded (lumen.core.http:req-body-stream req) len*))
        (lumen.core.http:ctx-set! req :body-consumed t))))
  (funcall next req))

(define-middleware multipart-parser (req next)
  \"Parse multipart/form-data â†’ ctx[:files], ctx[:fields].\"
  (unless (lumen.core.http:ctx-get req :body-consumed)
    (let* ((h (lumen.core.http:req-headers req))
           (ct (cdr (assoc \"content-type\" h :test #'string-equal)))
           (len (cdr (assoc \"content-length\" h :test #'string-equal)))
           (len* (when len (parse-integer len :junk-allowed t))))
      (when (and ct len* (> len* 0)
                 (search \"multipart/form-data\" (string-downcase ct)))
        (let ((res (lumen.core.body:parse-multipart (lumen.core.http:req-body-stream req) len* ct)))
          (when res
            (lumen.core.http:ctx-set! req :fields (cdr (assoc :fields res)))
            (lumen.core.http:ctx-set! req :files  (cdr (assoc :files  res)))
            (lumen.core.http:ctx-set! req :body-consumed t))))))
  (funcall next req))

;;; ---------------- ETag ----------------
;; FNV-1a 64-bit (simple, sans dÃ©pendance)
(defun %fnv1a-64 (bytes)
  (let* ((hash #xCBF29CE484222325)
         (prime #x100000001B3))
    (dotimes (i (length bytes))
      (setf hash (logxor hash (aref bytes i)))
      (setf hash (mod (* hash prime) (expt 2 64))))
    hash))

(defun %hex64 (u64)
  (format nil \"~16,'0X\" u64))

(defun %body->bytes (body)
  (etypecase body
    (string (trivial-utf-8:string-to-utf-8-bytes body))
    ((vector (unsigned-byte 8)) body)
    (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))

(defun compute-etag (body &key (weak t))
  \"Retourne une chaÃ®ne ETag, ex: W/\\\"AB12...-1234\\\"\"
  (let* ((bytes (%body->bytes body))
         (h (%hex64 (%fnv1a-64 bytes)))
         (sig (format nil \"~A-~D\" h (length bytes))))
    (if weak
        (format nil \"W/~S\" sig)   ; \"W/\" + quoted-string
        (format nil \"~S\" sig)))   ; strong: juste quoted-string

  )

(defun %parse-if-none-match (h)
  \"Retourne une liste de tags (strings) tels que reÃ§us, ex: (\\\"W/\\\\\\\"SIG\\\\\\\"\\\" \\\"\\\\\\\"SIG2\\\\\\\"\\\").\"
  (when (and h (plusp (length h)))
    (mapcar (lambda (s) (string-trim '(#\\Space #\\Tab) s))
            (uiop:split-string h :separator \",\"))))

(defun %strip-weak (tag)
  \"Retire le prÃ©fixe W/ si prÃ©sent.\"
  (let ((s (string-trim '(#\\Space #\\Tab) tag)))
    (if (and (>= (length s) 2)
             (char-equal (char s 0) #\\W)
             (char=      (char s 1) #\\/))
        (subseq s 2)
        s)))

(defun %weak-match-p (client-tag server-tag)
  \"RÃ¨gle de weak comparison (RFC 7232 Â§2.3.2).
   client-tag et server-tag incluent les guillemets.\"
  (string= (%strip-weak client-tag) (%strip-weak server-tag)))

;;; Middleware ETag rendu 'safe' :
;;; - Ne tente PAS de calculer un ETag si le corps est un writer (fonction).
;;; - Si un ETag est DÃ‰JÃ€ prÃ©sent (ex: respond-file), utilise-le pour 304.
(defun etag (&key (weak t) (only-status '(200)) (add-cache-control nil))
  \"Ajoute/valide ETag et gÃ¨re 304 si If-None-Match matche.
   - WEAK : si T (dÃ©faut), gÃ©nÃ¨re un ETag faible (W/\\\"...\\\").
   - ONLY-STATUS : liste de statuts concernÃ©s (par dÃ©faut (200)).
   - ADD-CACHE-CONTROL : string optionnelle, ex: \\\"public, max-age=300\\\".\"
  (lambda (next)
    (lambda (req)
      (let* ((resp   (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels
            ((ensure-etag! (resp)
               (let* ((hdrs (lumen.core.http:resp-headers resp))
                      (existing (cdr (assoc \"etag\" hdrs :test #'string=))))
                 (cond
                   ;; ETag dÃ©jÃ  posÃ© (ex: respond-file) â†’ on le laisse.
                   (existing
                    (when add-cache-control
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                       \"cache-control\" add-cache-control)))
                    existing)
                   ;; Corps fonction (writer) â†’ on ne peut pas calculer â†’ on n'ajoute pas
                   ((functionp (lumen.core.http:resp-body resp))
                    (when add-cache-control
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                       \"cache-control\" add-cache-control)))
                    nil)
                   ;; Corps string / octets â†’ on calcule
                   (t
                    (let* ((val (compute-etag (lumen.core.http:resp-body resp) :weak weak)))
                      (setf (lumen.core.http:resp-headers resp)
                            (lumen.utils:ensure-header hdrs \"etag\" val))
                      (when add-cache-control
                        (setf (lumen.core.http:resp-headers resp)
                              (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                                         \"cache-control\" add-cache-control)))
                      val))))))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((etag-val (ensure-etag! resp))
                     (inm (cdr (assoc \"if-none-match\"
                                      (lumen.core.http:req-headers req)
                                      :test #'string-equal))))
                (if (and etag-val inm
                         (or (some (lambda (x) (string= x \"*\"))
                                   (%parse-if-none-match inm))
                             (some (lambda (x) (%weak-match-p x etag-val))
                                   (%parse-if-none-match inm))))
                    ;; 304 Not Modified : pas de corps
                    (make-instance 'lumen.core.http:response
                                   :status 304
                                   :headers (lumen.utils:ensure-header
                                             (copy-list (lumen.core.http:resp-headers resp))
                                             \"etag\" etag-val)
                                   :body \"\")
                    resp))
              ;; Pas concernÃ© â†’ renvoyer tel quel
              resp))))))

;;; ---------------- Helpers Accept-Encoding ----------------
(defun %parse-accept-encoding (h)
  \"Retourne une alist '( (\\\"gzip\\\" . q) (\\\"deflate\\\" . q) ... ) triÃ©e par q desc.\"
  (labels ((parse-q (s)
             (handler-case
                 (let* ((v (read-from-string s nil nil)))
                   (if (numberp v) (coerce v 'float) 1.0))
               (error () 1.0))))
    (when (and h (plusp (length h)))
      (let* ((tokens (uiop:split-string h :separator \",\"))
             (pairs
               (mapcar (lambda (tok)
                         (let* ((t1 (string-trim '(#\\Space #\\Tab) tok))
                                (pos (position #\\; t1))
                                (enc (string-downcase
                                      (string-trim '(#\\Space #\\Tab)
                                                   (subseq t1 0 (or pos (length t1))))))
                                (q   (if pos
                                         (let* ((p2 (position #\\= t1 :start (1+ pos))))
                                           (if p2
                                               (parse-q (string-trim '(#\\Space #\\Tab)
                                                                     (subseq t1 (1+ p2))))
                                               1.0))
                                         1.0)))
                           (cons enc q)))
                       tokens)))
	;; filtre q=0, trie desc
        (sort (remove-if (lambda (c) (<= (cdr c) 0.0)) pairs)
              #'> :key #'cdr)))))

(defun %client-wants-gzip-p (headers)
  (let ((ae (cdr (assoc \"accept-encoding\" headers :test #'string-equal))))
    (member \"gzip\" (mapcar #'car (%parse-accept-encoding ae))
            :test #'string=)))

(defun %choose-encoding (headers &key (supported '(\"gzip\" \"deflate\")))
  \"Renvoie \\\"gzip\\\" ou \\\"deflate\\\" selon Accept-Encoding et q-values, ou NIL si rien.\"
  (let* ((ae (cdr (assoc \"accept-encoding\" headers :test #'string-equal)))
         (prefs (%parse-accept-encoding ae)))
    (some (lambda (p)
            (let ((enc (car p)))
              (when (member enc supported :test #'string=)
                enc)))
          prefs)))

(defun %content-type (headers)
  (cdr (assoc \"content-type\" headers :test #'string=)))

(defun %type-prefixed-p (ct prefixes)
  \"Vrai si le Content-Type CT commence par un des PREFIXES (strings).\"
  (and ct prefixes
       (let ((ct* (string-downcase ct)))
         (some (lambda (pfx) (lumen.utils:str-prefix-p (string-downcase pfx) ct*))
               prefixes))))

;;; ---------------- Compressors ----------------
(defun %bytes (body)
  (etypecase body
    (string (trivial-utf-8:string-to-utf-8-bytes body))
    ((vector (unsigned-byte 8)) body)
    (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))

(defun gzip-bytes (u8vec)
  \"Retourne un nouveau vecteur d'octets gzip du contenu U8VEC.\"
  (let ((out (flexi-streams:make-in-memory-output-stream
              :element-type '(unsigned-byte 8))))
    (salza2:with-compressor (c 'salza2:gzip-compressor :stream out)
      (dotimes (i (length u8vec))
        (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

(defun deflate-bytes (u8vec)
  \"Retourne un nouveau vecteur d'octets *deflate* (zlib wrapper, RFC1950) du contenu U8VEC.\"
  (let ((out (flexi-streams:make-in-memory-output-stream
              :element-type '(unsigned-byte 8))))
    ;; NB: 'deflate' cÃ´tÃ© HTTP signifie gÃ©nÃ©ralement zlib-wrapped (pas raw)
    (salza2:with-compressor (c 'salza2:zlib-compressor :stream out)
      (dotimes (i (length u8vec))
        (salza2:compress-octet c (aref u8vec i))))
    (flexi-streams:get-output-stream-sequence out)))

;;; ---------------- Middleware ----------------
;; ---------- DÃ©tection contenus dÃ©jÃ  compressÃ©s / peu compressibles ----------
(defun %starts-with (vec &rest bytes)
  (when (and (vectorp vec)
             (subtypep (array-element-type vec) '(unsigned-byte 8))
             (<= (length bytes) (length vec)))
    (loop for i from 0 below (length bytes)
          always (= (aref vec i) (nth i bytes)))))

(defun %looks-gzip-p   (bytes) (%starts-with bytes #x1F #x8B))                ; GZIP
(defun %looks-zlib-p   (bytes) (or (%starts-with bytes #x78 #x01)             ; ZLIB/deflate
                                   (%starts-with bytes #x78 #x9C)
                                   (%starts-with bytes #x78 #xDA)))
(defun %looks-png-p    (bytes) (%starts-with bytes #x89 #x50 #x4E #x47 #x0D #x0A #x1A #x0A))
(defun %looks-jpeg-p   (bytes) (%starts-with bytes #xFF #xD8 #xFF))
(defun %looks-gif-p    (bytes)
  (and (>= (length bytes) 6)
       (let ((s (map 'string #'code-char (subseq bytes 0 6))))
         (or (string= s \"GIF87a\") (string= s \"GIF89a\")))))
(defun %looks-webp-p   (bytes)
  (and (>= (length bytes) 12)
       (string= (map 'string #'code-char (subseq bytes 0 4))  \"RIFF\")
       (string= (map 'string #'code-char (subseq bytes 8 12)) \"WEBP\")))
(defun %looks-zip-p    (bytes) (%starts-with bytes #x50 #x4B #x03 #x04))
(defun %looks-pdf-p    (bytes)
  (and (>= (length bytes) 4)
       (string= (map 'string #'code-char (subseq bytes 0 4)) \"%PDF\")))

(defun %incompressible-magic-p (bytes)
  \"Renvoie T si BYTES semble dÃ©jÃ  compressÃ© (gzip/zlib) ou de type peu compressible (images, zip, pdf).\"
  (or (%looks-gzip-p bytes)
      (%looks-zlib-p bytes)
      (%looks-png-p  bytes)
      (%looks-jpeg-p bytes)
      (%looks-gif-p  bytes)
      (%looks-webp-p bytes)
      (%looks-zip-p  bytes)
      (%looks-pdf-p  bytes)))

(defun compression
    (&key (threshold 1024)
       (add-vary t)
       (skip-types '(\"image/\" \"video/\" \"audio/\"
                     \"application/zip\" \"application/pdf\"
                     \"application/x-gzip\" \"application/x-7z-compressed\"
                     \"application/x-rar-compressed\" \"application/x-tar\"))
       (only-types nil)
       (min-ratio 0.95)
       (skip-if nil))		     ; (lambda (req resp) ...) -> bool
  \"Compresse la rÃ©ponse (gzip/deflate) si pertinent.
Options:
  - THRESHOLD  : octets minimum du corps original
  - ADD-VARY   : ajoute Vary: Accept-Encoding
  - SKIP-TYPES : liste de prÃ©fixes MIME Ã  ignorer
  - ONLY-TYPES : liste de prÃ©fixes MIME autorisÃ©s (si non-NIL, restreint la compression)
  - MIN-RATIO  : ne garde pas la compression si (compressed/original) > MIN-RATIO
  - SKIP-IF    : prÃ©dicat (req resp) â†’ T pour dÃ©sactiver la compression\"
  (labels
      ((decorate-vary (hdrs)
         (if add-vary
             (let* ((existing (cdr (assoc \"vary\" hdrs :test #'string=)))
                    (new (if existing
                             (if (search \"accept-encoding\" (string-downcase existing))
                                 existing
                                 (format nil \"~A, Accept-Encoding\" existing))
                             \"Accept-Encoding\")))
               (lumen.utils:ensure-header hdrs \"vary\" new))
             hdrs)))
    (lambda (next)
      (lambda (req)
        (let* ((resp    (funcall next req))
               (status  (lumen.core.http:resp-status resp))
               (req-h   (lumen.core.http:req-headers req))
               (resp-h  (lumen.core.http:resp-headers resp))
               (ct      (%content-type resp-h)))

          (cond
            ;; Jamais compresser ces statuts / si dÃ©jÃ  encodÃ©
            ((or (member status '(204 304))
                 (assoc \"content-encoding\" resp-h :test #'string=))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter un Ã©ventuel prÃ©dicat dâ€™exclusion
            ((and skip-if (funcall skip-if req resp))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Respecter ONLY-TYPES (si fourni)
            ((and only-types (not (%type-prefixed-p ct only-types)))
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; Ne pas compresser si CT est dans SKIP-TYPES
            ((%type-prefixed-p ct skip-types)
             (setf (lumen.core.http:resp-headers resp)
                   (decorate-vary (lumen.core.http:resp-headers resp)))
             resp)

            ;; NÃ©gociation de contenu
            (t
             (let ((chosen (%choose-encoding req-h :supported '(\"gzip\" \"deflate\"))))
               (if (null chosen)
                   (progn
                     (setf (lumen.core.http:resp-headers resp)
                           (decorate-vary (lumen.core.http:resp-headers resp)))
                     resp)
                   (let* ((orig (lumen.core.http:resp-body resp))
                          (bytes (etypecase orig
                                   (string (trivial-utf-8:string-to-utf-8-bytes orig))
                                   ((vector (unsigned-byte 8)) orig)
                                   (null (trivial-utf-8:string-to-utf-8-bytes \"\"))))
                          (len (length bytes)))

                     (cond
                       ((< len threshold)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       ((%incompressible-magic-p bytes)
                        (setf (lumen.core.http:resp-headers resp)
                              (decorate-vary (lumen.core.http:resp-headers resp)))
                        resp)

                       (t
                        (let* ((encoded (ecase (intern (string-upcase chosen) :keyword)
                                          (:GZIP    (gzip-bytes bytes))
                                          (:DEFLATE (deflate-bytes bytes))))
                               (ratio (if (plusp len)
                                          (/ (float (length encoded)) (float len))
                                          1.0)))
                          (if (> ratio min-ratio)
                              ;; Gain insuffisant
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (decorate-vary (lumen.core.http:resp-headers resp)))
                                resp)
                              ;; Conserver compression
                              (progn
                                (setf (lumen.core.http:resp-headers resp)
                                      (-> (lumen.core.http:resp-headers resp)
                                          (lumen.utils:ensure-header \"content-encoding\" chosen)
                                          (decorate-vary)))
                                (setf (lumen.core.http:resp-body resp) encoded)
                                resp)))))))))))))))

;;; If-Modified-Since â†’ 304 ----------------------------------------
(defun last-modified-conditional (&key (only-status '(200)))
  \"Si la rÃ©ponse porte Last-Modified, compare If-Modified-Since et renvoie 304 si applicable.
   Respecte la rÃ¨gle de prioritÃ© : si If-None-Match est prÃ©sent, on laisse l'autre middleware (ETag) dÃ©cider.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp   (funcall next req))
             (status (lumen.core.http:resp-status resp)))
        (labels ((->304 (resp lm)
                   (make-instance 'lumen.core.http:response
                                  :status 304
                                  :headers (lumen.utils:ensure-header
                                            (copy-list (lumen.core.http:resp-headers resp))
                                            \"last-modified\" lm)
                                  :body \"\")))
          (if (and (member status only-status)
                   (method-get-or-head-p req))
              (let* ((req-h  (lumen.core.http:req-headers req))
                     (resp-h (lumen.core.http:resp-headers resp))
                     (ims    (cdr (assoc \"if-modified-since\" req-h :test #'string-equal)))
                     (inm    (cdr (assoc \"if-none-match\" req-h :test #'string-equal))) ; prioritÃ© ETag
                     (lm     (cdr (assoc \"last-modified\" resp-h :test #'string=))))
                (if (and lm ims (null inm))
                    (let* ((ims-ut (lumen.utils:parse-http-date ims))
                           (lm-ut  (lumen.utils:parse-http-date lm)))
                      (if (and ims-ut lm-ut (>= ims-ut lm-ut))
                          (->304 resp lm)
                          resp))
                    resp))
              resp))))))

;;; Session
(defun session (&key secret (ttl lumen.core.session:*session-ttl*)
                     (cookie-name lumen.core.session:*session-cookie*)
                     (http-only t) (secure lumen.core.session:*secure-cookie*)
                     (path \"/\"))
  \"Sessions mÃ©moire via cookie signÃ©. SECRET requis.\"
  (assert (and secret (plusp (length secret))) () \"session: :secret requis.\")
  (lambda (next)
    (lambda (req)
      ;; lecture cookie
      (let* ((raw (or (cookie req cookie-name) \"\"))
             (sid (and (> (length raw) 0)
                       (lumen.core.session:verify-signed-sid raw secret)))
             (data (and sid (lumen.core.session:store-get sid))))
        ;; si pas de session â†’ crÃ©er
        (unless sid
          (setf sid (lumen.core.session:make-session-id))
          (setf data '()))
        ;; mettre en ctx
        (lumen.core.http:ctx-set! req :session-id sid)
        (lumen.core.http:ctx-set! req :session    data)
        ;; suite
        (let* ((resp (funcall next req))
               (sid* (lumen.core.session:session-id req))
               (dat* (lumen.core.session:session-data req)))
          ;; persister si non-vide (ou toujours, Ã  toi de voir)
          (lumen.core.session:store-put! sid* dat* ttl)
          ;; cookie signÃ©
          (let* ((signed (lumen.core.session:sign-sid sid* secret)))
            (set-cookie! resp cookie-name signed
                         :path path :http-only http-only :secure secure
                         :max-age ttl))
          resp)))))

;;; CSRF
#|
- On gÃ©nÃ¨re un token alÃ©atoire, stockÃ© en session (:csrf) et envoyÃ© aussi au client (cookie csrf_token).
- Pour les mÃ©thodes mutables (POST, PUT, PATCH, DELETE), on vÃ©rifie que la requÃªte fournit le mÃªme token via header X-CSRF-Token ou champ de formulaire (ctx :form â†’ key \"csrf_token\").
- Si absent/incorrect â†’ 403.
|#
(defun %random-token ()
  (let* ((b (lumen.core.session:rand-bytes 32)))
    (cl-base64:usb8-array-to-base64-string b :uri t))) ; base64url

(defun csrf (&key (cookie-name \"csrf_token\")
                  (header-name \"x-csrf-token\")
                  (methods '(\"POST\" \"PUT\" \"PATCH\" \"DELETE\"))
                  (path \"/\")
                  (except-prefixes '())   ; ex: '(\"/login\" \"/api/webhook\")
                  (except-exact '())      ; ex: '(\"/login\" \"/signup\")
                  (skip-if nil))          ; (lambda (req) -> boolean)
  (labels ((path-exempt-p (req)
             (let ((p (lumen.core.http:req-path req)))
               (or
                ;; skip par prÃ©dicat custom
                (and skip-if (funcall skip-if req))
                ;; skip par match exact
                (member p except-exact :test #'string=)
                ;; skip par prÃ©fixe
                (some (lambda (pre)
                        (and (<= (length pre) (length p))
                             (string= pre p :end2 (length pre))))
                      except-prefixes)))))
    (lambda (next)
      (lambda (req)
        ;; (1) session requise (middleware :session doit Ãªtre avant)
        (let* ((method (lumen.core.http:req-method req))
               (mut?   (member method methods :test #'string=))
               ;; token en session (crÃ©Ã© si absent)
               (tok (or (lumen.core.session:session-get req :csrf)
                        (let ((tkn (%random-token)))
                          (lumen.core.session:session-set! req :csrf tkn) tkn))))
          (labels ((emit-cookie (resp)
                     (set-cookie! resp cookie-name tok :path path :http-only nil)))
            (cond
              ;; Cas exemptÃ© â†’ pas de vÃ©rif, mais on Ã©met/rafraÃ®chit le cookie
              ((or (not mut?) (path-exempt-p req))
               (let ((resp (funcall next req)))
                 (emit-cookie resp)
                 resp))

              ;; MÃ©thode mutable + pas exemptÃ© â†’ vÃ©rification stricte
              (t
               (let* ((hdr (lumen.core.http:req-headers req))
                      (hdr-raw (cdr (assoc header-name hdr :test #'string-equal)))
                      ;; tolÃ©rance: si on reÃ§oit littÃ©ralement \"csrf_token\", lire la valeur dans les cookies
                      (hdr-tok (if (and hdr-raw (string= hdr-raw cookie-name))
                                   (cdr (assoc cookie-name (lumen.core.http:req-cookies req) :test #'string=))
                                   hdr-raw))
                      (form (lumen.core.http:ctx-get req :form))
                      (field-tok (cdr (assoc \"csrf_token\" form :test #'string=)))
                      (ok (or (and hdr-tok (string= hdr-tok tok))
                              (and field-tok (string= field-tok tok)))))
                 (if ok
                     (let ((resp (funcall next req)))
                       (emit-cookie resp)
                       resp)
                     (let ((resp (lumen.core.http:respond-json
                                  '((:error . ((:type . \"csrf\")
                                               (:message . \"invalid or missing CSRF token\"))))
                                  :status 403)))
                       (emit-cookie resp) ; pour que le client rÃ©cupÃ¨re le bon token
                       resp)))))))))))

;;; JWT (HS256)
#|
Les scopes sont des permissions fines, embarquÃ©es dans le JWT.
Un rÃ´le, câ€™est â€œqui je suisâ€ (ex. admin, user).
Un scope, câ€™est â€œce que je peux faireâ€ (ex. read:users, write:payments).
|#
#|
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)   ; ex: '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any))  ; :any (OR) ou :all (AND)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx, applique garde optionnelle.
Options:
 - SECRET         : clÃ© HMAC (defaut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (let* ((hdrs (lumen.core.http:req-headers req))
               (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
               (tok  (and raw (>= (length raw) 7)
                          (string= (subseq raw 0 7) \"Bearer \")
                          (subseq raw 7))))
	  (format t \"Raw: ~A~%\" raw)
	  (format t \"Token: ~A~%\" tok)
          ;; dÃ©codage
          (when tok
            (multiple-value-bind (payload ok)
                (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
	      (format t \"Payload: ~A~%OK: ~A~%\" payload ok)
              (when ok (lumen.core.http:ctx-set! req :jwt payload))))
          ;; vÃ©rifs
          (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                 (role (and jwt (or (cdr (assoc :role jwt))
                                    (cdr (assoc \"role\" jwt)))))
                 (sc   (and jwt (or (cdr (assoc :scopes jwt))
                                    (cdr (assoc \"scopes\" jwt))))))
            (labels ((fail (status msg)
                       (lumen.core.http:respond-json
                        `((:error . ((:type . \"auth\") (:message . ,msg))))
                        :status status))
                     (has-scope? ()
                       (cond
                         ((null scopes-allow) t) ; pas dâ€™exigence
                         ((eq scopes-mode :all)
                          (every (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow))
                         (t ; :any
                          (some  (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow)))))
              (cond
                ((and required-p (null jwt)) (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
		 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scope?))) (fail 403 \"insufficient_scope\"))
                (t (funcall next req))))))))))
|#

(defun %bearer-token-from (headers)
  \"Extrait proprement le Bearer token (case-insensitive, espaces tolÃ©rÃ©s).\"
  (let* ((raw (cdr (assoc \"authorization\" headers :test #'string-equal))))
    (when raw
      (let* ((s (string-trim \" \" raw))
             (len (length s)))
        (labels ((starts-with-ci (needle hay)
                   (and (>= (length hay) (length needle))
                        (string-equal needle hay :end2 (length needle)))))
          (cond
            ((starts-with-ci \"Bearer \" s) (subseq s 7))
            ((starts-with-ci \"bearer \" s) (subseq s 7))
            (t nil)))))))

(defun %alist-get-ci (alist key)
  \"Assoc insensitive string|keyword sur alist mixte.\"
  (let ((sk (etypecase key
              (keyword (string-downcase (symbol-name key)))
              (string  (string-downcase key)))))
    (or (cdr (assoc key alist :test #'equal))
        (cdr (assoc sk  alist :test #'string=))
        (let ((kk (and (stringp key) (intern (string-upcase key) :keyword))))
          (and kk (cdr (assoc kk alist)))))))

(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)      ; '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any)      ; :any (OR) | :all (AND)
                      (leeway-sec 60))        ; tolÃ©rance horloge (exp/iat)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx et applique des gardes optionnelles.
Options:
 - SECRET         : clÃ© HMAC (dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)
 - LEEWAY-SEC     : tolÃ©rance de clock skew sur exp/iat.\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (%bearer-token-from hdrs)))
            ;; DÃ©codage (tolÃ©rance exp/iat simple via leeway)
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                    (lumen.core.jwt:jwt-decode tok :secret secret :verify t :leeway leeway-sec))
                (when ok
                  ;; Pose le JWT brut et quelques alias pratiques
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (%alist-get-ci payload :tenant)))
                    (when tenant
                      (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                   (role (and jwt (or (%alist-get-ci jwt :role)
                                      (%alist-get-ci jwt \"role\"))))
                   (sc   (or (and jwt (%alist-get-ci jwt :scopes)) '())))
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
                 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scopes? scopes-allow sc)))
                 (fail 403 \"insufficient_scope\"))
                (t
                 (funcall next req))))))))))

(defun auth-required ()
  (auth-jwt :required-p t))

(defun roles-allowed (roles)
  (auth-jwt :required-p t :roles-allow roles))

;;; HTTPS
(defun %bool (x) (and x t))

(defun %request-secure-p (req)
  \"Vrai si la requÃªte est dÃ©jÃ  HTTPS (socket TLS ou proxy qui lâ€™indique).\"
  (or (lumen.core.http:ctx-get req :secure)
      (let* ((h (lumen.core.http:req-headers req))
             (xfp (cdr (assoc \"x-forwarded-proto\" h :test #'string-equal)))
             (xfs (cdr (assoc \"x-forwarded-ssl\"   h :test #'string-equal))))
        (or (and xfp (string-equal xfp \"https\"))
            (and xfs (string-equal xfs \"on\"))))))

(defun %path-has-prefix-p (path prefix)
  (and (<= (length prefix) (length path))
       (string= prefix path :end2 (length prefix))))

(defun %build-query (req)
  \"Reconstruit la query string si possible.\"
  (let ((q (lumen.core.http:req-query req)))
    (cond
      ((null q) \"\")
      ((stringp q) (if (plusp (length q)) (concatenate 'string \"?\" q) \"\"))
      ((listp q)
       (let ((parts
               (mapcar (lambda (cell)
                         (let ((k (car cell)) (v (cdr cell)))
                           ;; k/v peuvent Ãªtre keywords ou strings
                           (format nil \"~A=~A\"
                                   (etypecase k
                                     (string k)
                                     (symbol (string-downcase (symbol-name k))))
                                   (etypecase v
                                     (string v)
                                     (symbol (string-downcase (symbol-name v)))
                                     (t (princ-to-string v))))))
                       q)))
         (if parts
             (concatenate 'string \"?\" (map 'string #'identity
                                           (with-output-to-string (s)
                                             (format s \"~{~A~^&~}\" parts))))
             \"\")))
      (t \"\"))))

(defun host-without-port (host)
  (let ((pos (position #\\: host)))
    (if pos (subseq host 0 pos) host)))

(defun %https-location (req &key ssl-port)
  \"Construit lâ€™URL de redirection https (conserve host, path, query).
   Ajoute :ssl-port si non standard (â‰ 443).\"
  (let* ((h    (lumen.core.http:req-headers req))
         (host (or (cdr (assoc \"x-forwarded-host\" h :test #'string-equal))
                   (cdr (assoc \"host\"             h :test #'string-equal))
                   \"localhost\"))
	 (host0 (host-without-port host))
         (path (lumen.core.http:req-path req))
         (qs   (%build-query req))
         (port-suffix (if (and ssl-port (not (= ssl-port 443)))
                          (format nil \":~D\" ssl-port) \"\"))
         (scheme \"https://\"))
    (format nil \"~A~A~A~A~A\" scheme host0 port-suffix path qs)))

(defun https-redirect (&key
                         (prefixes '(\"/\"))            ; prÃ©fixes Ã  forcer en HTTPS
                         (except-prefixes nil)         ; prÃ©fixes EXCLUS (pas de redirect/HSTS)
                         (ssl-port 443)                ; port public HTTPS
                         (hsts nil)                    ; t â‡’ ajoute Strict-Transport-Security (sur HTTPS)
                         (hsts-max-age 15552000)       ; 180 jours
                         (hsts-include-subdomains t)
                         (hsts-preload nil))
  \"Redirige HTTP â†’ HTTPS (301) pour les chemins dont le prÃ©fixe matche.
Options:
- PREFIXES         : liste de prÃ©fixes (strings) Ã  forcer en https (\\\"/\\\" pour tout).
- EXCEPT-PREFIXES  : liste de prÃ©fixes Ã  EXCLURE (pas de redirect, pas de HSTS).
- SSL-PORT         : port https externe (443 par dÃ©faut).
- HSTS             : si T, ajoute Strict-Transport-Security *sur les rÃ©ponses HTTPS*
                     (sauf si le chemin est exclu par EXCEPT-PREFIXES).\"
  (labels ((matches-any-p (path lst)
             (and lst (some (lambda (pfx) (%path-has-prefix-p path pfx)) lst))))
    (lambda (next)
      (lambda (req)
        (let* ((path     (lumen.core.http:req-path req))
               (in-scope (matches-any-p path prefixes))
               (excluded (matches-any-p path except-prefixes))
               (secure?  (%request-secure-p req)))
          (cond
            ;; DÃ©jÃ  en HTTPS : on passe au suivant, et on pose HSTS si demandÃ© (et non exclu)
            (secure?
             (let ((resp (funcall next req)))
               (when (and hsts (not excluded))
                 (let* ((hdrs (lumen.core.http:resp-headers resp))
                        (val  (with-output-to-string (s)
                                (format s \"max-age=~D\" hsts-max-age)
                                (when hsts-include-subdomains (format s \"; includeSubDomains\"))
                                (when hsts-preload           (format s \"; preload\")))))
                   (setf (lumen.core.http:resp-headers resp)
                         (lumen.utils:ensure-header hdrs \"strict-transport-security\" val))))
               resp))

            ;; HTTP + ciblÃ© + non exclu â†’ 301 vers HTTPS
            ((and in-scope (not excluded) (not secure?))
             (let* ((loc (%https-location req :ssl-port ssl-port))
                    (headers (list (cons \"location\" loc)
                                   (cons \"cache-control\" \"no-store\"))))
               (make-instance 'lumen.core.http:response
                              :status 301 :headers headers :body \"\")))

            ;; HTTP hors-scope ou exclu â†’ passer au suivant
            (t
             (funcall next req))))))))

;;Le rate limiting contrÃ´le combien de fois un client peut appeler une route
;; dans une pÃ©riode donnÃ©e. Câ€™est une protection anti-abus / DDoS / brute-force.
(defun rate-limit (&key (capacity 10) (refill-per-sec 1) (route-key \"default\"))
  (lambda (next)
    (lambda (req)
      (if (lumen.core.ratelimit:allow? req :capacity capacity
					   :refill-per-sec refill-per-sec
					   :route-key route-key)
          (funcall next req)
          (lumen.core.http:respond-json
           '((:error . ((:type . \"rate_limit\") (:message . \"Too Many Requests\"))))
           :status 429)))))

;;; Request Timeout (504 si le handler dÃ©passe N ms)
(defun request-timeout (&key (ms 5000))
  (lambda (next)
    (lambda (req)
      (let* ((lock (bordeaux-threads:make-lock \"rt-lock\"))
             (cv   (bordeaux-threads:make-condition-variable))
             (resp nil))
	(bordeaux-threads:make-thread
	 (lambda ()
	   (let ((r (funcall next req)))
             (bordeaux-threads:with-lock-held (lock)
               (setf resp r)
               (bordeaux-threads:condition-notify cv)))))
	(bordeaux-threads:with-lock-held (lock)
	  (unless (bordeaux-threads:condition-wait cv lock :timeout (/ ms 1000.0))
            ;; timeout â†’ 504
            (return-from request-timeout
              (lumen.core.http:respond-json
               '((:error . ((:type . \"timeout\") (:message . \"gateway timeout\"))))
               :status 504))))
	resp))))

;;; max-body-size (413 si Content-Length trop grand)
(defun max-body-size (&key (bytes (* 2 1024 1024))) ; 2 MiB
  (lambda (next)
    (lambda (req)
      (let* ((clen (cdr (assoc \"content-length\" (lumen.core.http:req-headers req)
                               :test #'string-equal)))
             (n (and clen (parse-integer clen :junk-allowed t))))
	(when (and n (> n bytes))
	  (return-from max-body-size
            (lumen.core.http:respond-json
             `((:error . ((:type . \"payload_too_large\")
			  (:message . ,(format nil \"max ~D bytes\" bytes)))))
             :status 413))))
      ;; pour les cas sans Content-Length, on laisse les parseurs respecter une limite via ctx si tu veux
      (lumen.core.http:ctx-set! req :max-body-size bytes)
      (funcall next req))))

;;; Access Log JSON
(defun %open-log-file (path)
  (open path :direction :output :if-exists :append :if-does-not-exist :create
             :external-format :utf-8))

(defun %rfc3339-now ()
  (local-time:format-timestring
   nil (local-time:now)
   :format '(:year \"-\" (:month 2) \"-\" (:day 2) \"T\" (:hour 2) \":\" (:min 2) \":\" (:sec 2) \"Z\")))

(defun %plist->alist (plist)
  (loop for (k v) on plist by #'cddr collect (cons k v)))

(defun %normalize-fields (fields req resp ms bytes)
  \"Retourne une alist Ã  partir de FIELDS (NIL | alist | plist | fn).\"
  (cond
    ((null fields) nil)
    ((and (listp fields)
          (every #'consp fields)) fields)                  ; dÃ©jÃ  alist
    ((and (listp fields) (evenp (length fields))) (%plist->alist fields)) ; plist
    ((functionp fields) (let ((res (funcall fields req resp ms bytes)))
                          (cond
                            ((null res) nil)
                            ((and (listp res) (every #'consp res)) res)
                            ((and (listp res) (evenp (length res))) (%plist->alist res))
                            (t nil))))
    (t nil)))

(defun %merge-alist (base extras &key (test #'equal))
  \"Merge en donnant prioritÃ© Ã  EXTRAS (override).\"
  (let ((res (copy-list base)))
    (dolist (kv extras)
      (let* ((k (car kv))
             (cell (assoc k res :test test)))
        (if cell
            (setf (cdr cell) (cdr kv))
            (push kv res))))
    (nreverse res)))

(defun access-log-json (&key stream to-file fields)
  \"Middleware: Ã©crit une ligne JSON par requÃªte.
:fields accepte NIL, alist, plist, ou (lambda (req resp ms bytes) -> alist/plist).\"
  (let* ((out (or (and to-file (%open-log-file to-file))
                  (or stream *standard-output*)))
         (lock (bordeaux-threads:make-lock \"access-log-json\")))
    (lambda (next)
      (lambda (req)
        (labels ((h (name)
                   (cdr (assoc name (lumen.core.http:req-headers req) :test #'string-equal))))
          (let* ((t0  (get-internal-real-time))
                 (rid (or (lumen.core.http:ctx-get req :request-id) \"\"))
                 (ip  (or (let* ((xff (h \"x-forwarded-for\")))
                            (and xff (car (uiop:split-string xff :separator \",\"))))
                          (h \"x-real-ip\") \"\"))
                 (mth (or (lumen.core.http:req-method req) \"GET\"))
                 (host (or (h \"host\") \"\"))
                 (pth (or (lumen.core.http:req-path req) \"/\"))
                 (resp (funcall next req))
                 (ms  (/ (- (get-internal-real-time) t0)
                         (/ internal-time-units-per-second 1000.0)))
                 (body (lumen.core.http:resp-body resp))
                 (bytes (cond
                          ((stringp body) (length (trivial-utf-8:string-to-utf-8-bytes body)))
                          ((typep body '(simple-array (unsigned-byte 8) (*))) (length body))
                          (t nil))) ; streaming inconnu â†’ omis
                 (base `((:ts . ,(%rfc3339-now))
                         (:request_id . ,rid)
                         (:ip . ,ip)
                         (:method . ,mth)
                         (:host . ,host)
                         (:path . ,pth)
                         (:status . ,(lumen.core.http:resp-status resp))
                         (:ms . ,(round ms))
                         ,@(when bytes `((:bytes . ,bytes)))))
                 (extra (%normalize-fields fields req resp ms bytes))
                 (obj   (%merge-alist base extra :test
                                      (lambda (a b)
                                        (string-equal (if (symbolp a) (symbol-name a) (format nil \"~A\" a))
                                                      (if (symbolp b) (symbol-name b) (format nil \"~A\" b)))))))
            (bordeaux-threads:with-lock-held (lock)
              (handler-case
                  (progn
                    (write-string (cl-json:encode-json-to-string obj) out)
                    (terpri out)
                    (finish-output out))
                (error (_)
                  (declare (ignore _))
                  (format out \"~S~%\" obj)
                  (finish-output out))))
            resp))))))

(define-middleware tenant-from-host (req next)
  (let* ((host (cdr (assoc \"host\" (lumen.core.http:req-headers req) :test #'string-equal)))
         ;; mappe host -> UUID (ou via SELECT sur tenants(code))
         (tid  (crd.backend.repo:tenant-id-for-host host)))  ;; retourne une string UUID
    (when tid
      (lumen.core.http:ctx-set! req :tenant-id tid)
      ;; optionnel: aussi le code si tu veux
      (lumen.core.http:ctx-set! req :tenant-code (crd.backend.repo:tenant-code-by-id tid))))
  (funcall next req))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 52 (face font-lock-type-face fontified t) 52 56 (fontified t) 56 60 (face font-lock-builtin-face fontified t) 60 61 (fontified t) 61 64 (face font-lock-builtin-face fontified t) 64 65 (fontified t) 65 76 (face font-lock-builtin-face fontified t) 76 81 (fontified t) 81 93 (face font-lock-builtin-face fontified t) 93 94 (fontified t) 94 110 (face font-lock-builtin-face fontified t) 110 111 (fontified t) 111 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 129 (face font-lock-builtin-face fontified t) 129 130 (fontified t) 130 140 (face font-lock-builtin-face fontified t) 140 141 (fontified t) 141 153 (face font-lock-builtin-face fontified t) 153 157 (fontified t) 157 170 (face font-lock-builtin-face fontified t) 170 171 (fontified t) 171 183 (face font-lock-builtin-face fontified t) 183 184 (fontified t) 184 196 (face font-lock-builtin-face fontified t) 196 197 (fontified t) 197 207 (face font-lock-builtin-face fontified t) 207 208 (fontified t) 208 216 (face font-lock-builtin-face fontified t) 216 217 (fontified t) 217 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 243 (face font-lock-builtin-face fontified t) 243 244 (fontified t) 244 256 (face font-lock-builtin-face fontified t) 256 257 (fontified t) 257 260 (face font-lock-builtin-face fontified t) 260 261 (fontified t) 261 265 (face font-lock-builtin-face fontified t) 265 266 (fontified t) 266 279 (face font-lock-builtin-face fontified t) 279 280 (fontified t) 280 294 (face font-lock-builtin-face fontified t) 294 295 (fontified t) 295 311 (face font-lock-builtin-face fontified t) 311 314 (fontified t) 314 331 (face font-lock-builtin-face fontified t) 331 336 (fontified t) 336 348 (face font-lock-builtin-face fontified t) 348 349 (fontified t) 349 365 (face font-lock-builtin-face fontified t) 365 366 (fontified t) 366 383 (face font-lock-builtin-face fontified t) 383 388 (fontified t) 388 400 (face font-lock-builtin-face fontified t) 400 401 (fontified t) 401 422 (face font-lock-builtin-face fontified t) 422 423 (fontified t) 423 442 (face font-lock-builtin-face fontified t) 442 443 (fontified t) 443 461 (face font-lock-builtin-face fontified t) 461 466 (fontified t) 466 478 (face font-lock-builtin-face fontified t) 478 479 (fontified t) 479 498 (face font-lock-builtin-face fontified t) 498 499 (fontified t) 499 510 (face font-lock-builtin-face fontified t) 510 511 (fontified t) 511 524 (face font-lock-builtin-face fontified t) 524 525 (fontified t) 525 537 (face font-lock-builtin-face fontified t) 537 538 (fontified t) 538 551 (face font-lock-builtin-face fontified t) 551 552 (fontified t) 552 565 (face font-lock-builtin-face fontified t) 565 566 (fontified t) 566 584 (face font-lock-builtin-face fontified t) 584 585 (fontified t) 585 594 (face font-lock-builtin-face fontified t) 594 595 (fontified t) 595 605 (face font-lock-builtin-face fontified t) 605 606 (fontified t) 606 617 (face font-lock-builtin-face fontified t) 617 618 (fontified t) 618 629 (face font-lock-builtin-face fontified t) 629 630 (fontified t) 630 641 (face font-lock-builtin-face fontified t) 641 642 (fontified t) 642 656 (face font-lock-builtin-face fontified t) 656 657 (fontified t) 657 674 (face font-lock-builtin-face fontified t) 674 675 (fontified t) 675 691 (face font-lock-builtin-face fontified t) 691 696 (fontified t) 696 708 (face font-lock-builtin-face fontified t) 708 709 (fontified t) 709 724 (face font-lock-builtin-face fontified t) 724 725 (fontified t) 725 738 (face font-lock-builtin-face fontified t) 738 739 (fontified t) 739 750 (face font-lock-builtin-face fontified t) 750 751 (fontified t) 751 762 (face font-lock-builtin-face fontified t) 762 767 (fontified t) 767 779 (face font-lock-builtin-face fontified t) 779 780 (fontified t) 780 801 (face font-lock-builtin-face fontified t) 801 802 (fontified t) 802 809 (face font-lock-builtin-face fontified t) 809 814 (fontified t) 814 826 (face font-lock-builtin-face fontified t) 826 827 (fontified t) 827 849 (face font-lock-builtin-face fontified t) 849 850 (fontified t) 850 863 (face font-lock-builtin-face fontified t) 863 868 (fontified t) 868 875 (face font-lock-builtin-face fontified t) 875 876 (fontified t) 876 894 (face font-lock-builtin-face fontified t) 894 895 (fontified t) 895 906 (face font-lock-builtin-face fontified t) 906 907 (fontified t) 907 913 (face font-lock-builtin-face fontified t) 913 914 (fontified t) 914 921 (face font-lock-builtin-face fontified t) 921 922 (fontified t) 922 932 (face font-lock-builtin-face fontified t) 932 933 (fontified t) 933 946 (face font-lock-builtin-face fontified t) 946 951 (fontified t) 951 979 (face font-lock-builtin-face fontified t) 979 980 (fontified t) 980 988 (face font-lock-builtin-face fontified t) 988 989 (fontified t) 989 998 (face font-lock-builtin-face fontified t) 998 999 (fontified t) 999 1020 (face font-lock-builtin-face fontified t) 1020 1025 (fontified t) 1025 1031 (face font-lock-builtin-face fontified t) 1031 1032 (fontified t) 1032 1037 (face font-lock-builtin-face fontified t) 1037 1038 (fontified t) 1038 1045 (face font-lock-builtin-face fontified t) 1045 1046 (fontified t) 1046 1051 (face font-lock-builtin-face fontified t) 1051 1052 (fontified t) 1052 1062 (face font-lock-builtin-face fontified t) 1062 1063 (fontified t) 1063 1075 (face font-lock-builtin-face fontified t) 1075 1080 (fontified t) 1080 1092 (face font-lock-builtin-face fontified t) 1092 1093 (fontified t) 1093 1110 (face font-lock-builtin-face fontified t) 1110 1115 (fontified t) 1115 1118 (face font-lock-comment-delimiter-face fontified t) 1118 1134 (face font-lock-comment-face fontified t) 1134 1137 (fontified t) 1137 1153 (face font-lock-builtin-face fontified t) 1153 1154 (fontified t) 1154 1168 (face font-lock-builtin-face fontified t) 1168 1172 (fontified t) 1172 1175 (face font-lock-comment-delimiter-face fontified t) 1175 1183 (face font-lock-comment-face fontified t) 1183 1186 (fontified t) 1186 1197 (face font-lock-builtin-face fontified t) 1197 1198 (fontified t) 1198 1210 (face font-lock-builtin-face fontified t) 1210 1211 (fontified t) 1211 1218 (face font-lock-builtin-face fontified t) 1218 1219 (fontified t) 1219 1234 (face font-lock-builtin-face fontified t) 1234 1238 (fontified t) 1238 1241 (face font-lock-comment-delimiter-face fontified t) 1241 1246 (face font-lock-comment-face fontified t) 1246 1249 (fontified t) 1249 1254 (face font-lock-builtin-face fontified t) 1254 1258 (fontified t) 1258 1261 (face font-lock-comment-delimiter-face fontified t) 1261 1273 (face font-lock-comment-face fontified t) 1273 1276 (fontified t) 1276 1288 (face font-lock-builtin-face fontified t) 1288 1292 (fontified t) 1292 1318 (face font-lock-builtin-face fontified t) 1318 1322 (fontified t) 1322 1325 (face font-lock-comment-delimiter-face fontified t) 1325 1333 (face font-lock-comment-face fontified t) 1333 1337 (fontified t) 1337 1345 (face font-lock-builtin-face fontified t) 1345 1349 (fontified t) 1349 1354 (face font-lock-builtin-face fontified t) 1354 1359 (fontified t) 1359 1368 (face font-lock-builtin-face fontified t) 1368 1372 (fontified t) 1372 1387 (face font-lock-builtin-face fontified t) 1387 1392 (fontified t) 1392 1406 (face font-lock-builtin-face fontified t) 1406 1407 (fontified t) 1407 1421 (face font-lock-builtin-face fontified t) 1421 1422 (fontified t) 1422 1433 (face font-lock-builtin-face fontified t) 1433 1438 (fontified t) 1438 1454 (face font-lock-builtin-face fontified t) 1454 1455 (fontified t) 1455 1469 (face font-lock-builtin-face fontified t) 1469 1470 (fontified t) 1470 1486 (face font-lock-builtin-face fontified t) 1486 1491 (fontified t) 1491 1500 (face font-lock-builtin-face fontified t) 1500 1508 (face font-lock-builtin-face fontified t) 1508 1511 (fontified t) 1511 85567 (fontified nil)) . 1) (t 26809 13022 0 0)) nil (26809 16043 292499 0) 0 nil])
([nil nil ((84948 . 84949) (t 26809 16046 0 0)) nil (26811 59703 876572 0) 0 nil])
([nil nil ((84949 . 84950)) nil (26811 59703 876572 0) 0 nil])
([nil nil ((#("#" 0 1 (fontified t)) . -84949) (undo-tree-id14 . -1) 84950) nil (26811 59703 876571 0) 0 nil])
([nil nil ((84949 . 84970)) nil (26811 59703 876570 0) 0 nil])
([nil nil ((84970 . 84991)) nil (26811 59703 876569 0) 0 nil])
([nil nil ((84991 . 85012)) nil (26811 59703 876569 0) 0 nil])
([nil nil ((85012 . 85023)) nil (26811 59703 876568 0) 0 nil])
([nil nil ((84952 . 85026) (#("-----------------------------------------------------------------------" 0 71 (face font-lock-comment-face fontified t)) . -84952) (undo-tree-id13 . -71) 85023) nil (26811 59703 876568 0) 0 nil])
([nil nil ((85026 . 85027)) nil (26811 59703 876566 0) 0 nil])
([nil nil ((85027 . 85030)) nil (26811 59703 876566 0) 0 nil])
([nil nil ((85030 . 85031)) nil (26811 59703 876565 0) 0 nil])
([nil nil ((85031 . 85034)) nil (26811 59703 876565 0) 0 nil])
([nil nil ((85034 . 85035)) nil (26811 59703 876564 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 85111 . 85112) (nil fontified nil 85038 . 85112) (nil fontified nil 85035 . 85038) (85035 . 85112)) nil (26811 59703 876563 0) 0 nil])
([nil nil ((85030 . 85031)) nil (26811 59703 876563 0) 0 nil])
([nil nil ((85031 . 85033)) nil (26811 59703 876562 0) 0 nil])
([nil nil ((85033 . 85034)) nil (26811 59703 876561 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 85221 . 85222) (nil fontified nil 85034 . 85222) (85034 . 85222)) nil (26811 59703 876560 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -85222) (undo-tree-id9 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -85223) (undo-tree-id10 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -85224) (undo-tree-id11 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -85225) (undo-tree-id12 . -1) 85226) nil (26811 59703 876559 0) 0 nil])
([nil nil ((85300 . 85301)) nil (26811 59703 876549 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 87499 . 87500) (nil fontified nil 85301 . 87500) (85301 . 87500)) nil (26811 59703 876548 0) 0 nil])
([nil nil ((85396 . 85397)) nil (26811 59703 876547 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -85396) (undo-tree-id8 . -1) 85397) nil (26811 59703 876546 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -85381) (undo-tree-id7 . -1) 85382) nil (26811 59703 876545 0) 0 nil])
([nil nil ((#("

(defun make-request-id ()
  \"UUIDv4-ish (hex) simple, suffisant pour corrÃ©lation de logs.\"
  (let ((h (%rand-hex 16)))
    (format nil \"~A-~A-4~A-~A~A-~A\"
            (subseq h 0 8) (subseq h 8 12) (subseq h 13 16)
            (subseq h 16 17) (subseq h 17 20) (subseq h 20 32))))" 0 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 24 (face font-lock-function-name-face fontified t) 24 30 (fontified t) 30 92 (face font-lock-doc-face fontified t) 92 96 (fontified t) 96 99 (face font-lock-keyword-face fontified t) 99 137 (fontified t) 137 156 (face font-lock-string-face fontified t) 156 282 (fontified t)) . 86161) (undo-tree-id5 . -282) (undo-tree-id6 . -216)) nil (26811 59703 876543 0) 0 nil])
([nil nil ((#("
;; Ton gÃ©nÃ©rateur dâ€™ID existant (repris tel quel)
(defun %rand-hex (nbytes)
  (let ((hex \"0123456789abcdef\"))
    (with-output-to-string (s)
      (dotimes (i (* 2 nbytes))
        (write-char (char hex (random 16)) s)))))" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 51 (face font-lock-comment-face fontified t) 51 52 (fontified t) 52 57 (face font-lock-keyword-face fontified t) 57 58 (fontified t) 58 67 (face font-lock-function-name-face fontified t) 67 80 (fontified t) 80 83 (face font-lock-keyword-face fontified t) 83 90 (fontified t) 90 108 (face font-lock-string-face fontified t) 108 116 (fontified t) 116 137 (face font-lock-keyword-face fontified t) 137 149 (fontified t) 149 156 (face font-lock-keyword-face fontified t) 156 174 (fontified t) 174 223 (fontified t)) . 85938) (undo-tree-id3 . -223) (undo-tree-id4 . -223)) nil (26811 59703 876540 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -85937) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 85938) nil (26811 59703 876537 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 85937)) nil (26811 59703 876516 0) 0 nil])
([nil nil ((86992 . 86993)) nil (26811 59703 876511 0) 0 nil])
([nil nil ((1121 . 1122) (t 26811 59703 0 0)) nil (26811 60412 544089 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1136 . 1137) (nil fontified nil 1122 . 1137) (1122 . 1137)) nil (26811 60412 544087 0) 0 nil])
([nil nil ((1137 . 1138)) nil (26811 60412 544081 0) 0 nil])
([nil nil ((#("
             (len (length s))" 0 30 (fontified t)) . 69345) (undo-tree-id0 . -30) (t 26811 60412 0 0)) nil (26812 51560 458347 0) 0 nil])
([nil nil ((36411 . 36416) (t 26812 51560 0 0)) nil (26812 63458 26364 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 36734 . 36735) (nil fontified nil 36716 . 36735) (nil fontified nil 36696 . 36716) (nil fontified nil 36625 . 36696) (nil fontified nil 36610 . 36625) (nil fontified nil 36416 . 36610) (36416 . 36735)) nil (26812 63458 26363 0) 0 nil])
([nil nil ((#("\"cache-control\"
                                                          (format nil \"public, max-age=~D\" file-cache-secs)" 0 15 (face font-lock-string-face fontified t) 15 86 (fontified t) 86 106 (face font-lock-string-face fontified t) 106 123 (fontified t)) . -36610) (undo-tree-id22 . -123) (undo-tree-id23 . -123) (undo-tree-id24 . -123) (undo-tree-id25 . -123) (undo-tree-id26 . -123) (undo-tree-id27 . -16) (undo-tree-id28 . -123) (undo-tree-id29 . -123) 36733) nil (26812 63458 26362 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 36633 . 36634) (nil fontified nil 36610 . 36634) (36610 . 36634)) nil (26812 63458 26354 0) 0 nil])
([nil nil ((36516 . 36520) (#(" " 0 1 (fontified nil)) . 36515) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (36516 . 36517)) nil (26812 63458 26352 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 36555) (undo-tree-id9 . -1) (undo-tree-id10 . -1)) nil (26812 63458 26341 0) 0 nil])
([nil nil ((#("                          " 0 26 (fontified nil)) . -36588) (undo-tree-id0 . -26) (undo-tree-id1 . -26) (undo-tree-id2 . -26) (undo-tree-id3 . -26) (undo-tree-id4 . -26) (undo-tree-id5 . -26) (undo-tree-id6 . -26) (undo-tree-id7 . -26) (undo-tree-id8 . -26) (36555 . 36556)) nil (26812 63458 26335 0) 0 nil])
([nil nil ((37859 . 37861) (t 26812 63458 0 0)) nil (26813 21032 355004 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 51419 . 51420) (nil fontified nil 37861 . 51420) (37861 . 51420)) nil (26813 21032 355003 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -51419) (undo-tree-id31 . -1) 51420) nil (26813 21032 355001 0) 0 nil])
([nil nil ((51419 . 51420)) nil (26813 21032 354997 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -51419) (undo-tree-id30 . -1) 51420) nil (26813 21032 354995 0) 0 nil])
([nil nil ((37860 . 37862)) nil (26813 21032 354969 0) 0 nil])
([nil nil ((29762 . 29764)) nil (26813 21032 354962 0) 0 nil])
([nil nil ((20822 . 20824) (t 26813 21032 0 0)) nil (26813 22679 258392 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23252 . 23253) (nil fontified nil 20824 . 23253) (20824 . 23253)) nil (26813 22679 258391 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -23252) (undo-tree-id35 . -1) 23253) nil (26813 22679 258389 0) 0 nil])
([nil nil ((20823 . 20825)) nil (26813 22679 258387 0) 0 nil])
([nil nil ((#("{" 0 1 (fontified t)) . -20824) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) 20825) nil (26813 22679 258385 0) 0 nil])
([nil nil ((20824 . 20825)) nil (26813 22679 258364 0) 0 nil])
([nil nil ((19340 . 19342)) nil (26813 22679 258357 0) 0 nil])
([nil nil ((#("(defun %alist-get-ci (alist key)
  \"Assoc insensitive string|keyword sur alist mixte.\"
  (let ((sk (etypecase key
              (keyword (string-downcase (symbol-name key)))
              (string  (string-downcase key)))))
    (or (cdr (assoc key alist :test #'equal))
        (cdr (assoc sk  alist :test #'string=))
        (let ((kk (and (stringp key) (intern (string-upcase key) :keyword))))
          (and kk (cdr (assoc kk alist)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 35 (fontified t) 35 86 (face font-lock-doc-face fontified t) 86 90 (fontified t) 90 93 (face font-lock-keyword-face fontified t) 93 100 (fontified t) 100 109 (face font-lock-keyword-face fontified t) 109 253 (fontified t) 253 258 (face font-lock-builtin-face fontified t) 258 299 (fontified t) 299 304 (face font-lock-builtin-face fontified t) 304 326 (fontified t) 326 329 (face font-lock-keyword-face fontified t) 329 382 (fontified t) 382 390 (face font-lock-builtin-face fontified t) 390 440 (fontified t)) . -85882) (undo-tree-id46 . -440) (undo-tree-id47 . -20) (undo-tree-id48 . -20) (undo-tree-id49 . -20) (undo-tree-id50 . -20) (undo-tree-id51 . -20) (undo-tree-id52 . -20) (undo-tree-id53 . -20) (undo-tree-id54 . -373) (undo-tree-id55 . -373) (undo-tree-id56 . -373) (undo-tree-id57 . -373) (undo-tree-id58 . -395) (undo-tree-id59 . -440) (undo-tree-id60 . -440) 86322 (t 26813 22679 0 0)) nil (26819 18376 269948 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86479 . 86480) (nil fontified nil 85882 . 86480) (85882 . 86480)) nil (26819 18376 269939 0) 0 nil])
([nil nil ((86480 . 86482)) nil (26819 18376 269939 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86814 . 86815) (nil fontified nil 86482 . 86815) (86482 . 86815)) nil (26819 18376 269938 0) 0 nil])
([nil nil ((86480 . 86482)) nil (26819 18376 269938 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86578 . 86579) (nil fontified nil 86482 . 86579) (86482 . 86579)) nil (26819 18376 269937 0) 0 nil])
([nil nil ((86915 . 86916)) nil (26819 18376 269937 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 92007 . 92008) (nil fontified nil 86916 . 92008) (86916 . 92008)) nil (26819 18376 269936 0) 0 nil])
([nil nil ((87665 . 87666)) nil (26819 18376 269935 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 87989 . 87990) (nil fontified nil 87666 . 87990) (87666 . 87990)) nil (26819 18376 269935 0) 0 nil])
([nil nil ((92333 . 92334)) nil (26819 18376 269934 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -92333) (undo-tree-id44 . -1) (undo-tree-id45 . -1) 92334) nil (26819 18376 269933 0) 0 nil])
([nil nil ((#("
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)      ; '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any)      ; :any (OR) | :all (AND)
                      (leeway-sec 60))        ; tolÃ©rance horloge (exp/iat)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx et applique des gardes optionnelles.
Options:
 - SECRET         : clÃ© HMAC (dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)
 - LEEWAY-SEC     : tolÃ©rance de clock skew sur exp/iat.\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (%bearer-token-from hdrs)))
            ;; DÃ©codage (tolÃ©rance exp/iat simple via leeway)
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                    (lumen.core.jwt:jwt-decode tok :secret secret :verify t :leeway leeway-sec))
                (when ok
                  ;; Pose le JWT brut et quelques alias pratiques
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (%alist-get-ci payload :tenant)))
                    (when tenant
                      (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                   (role (and jwt (or (%alist-get-ci jwt :role)
                                      (%alist-get-ci jwt \"role\"))))
                   (sc   (or (and jwt (%alist-get-ci jwt :scopes)) '())))
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
                 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scopes? scopes-allow sc)))
                 (fail 403 \"insufficient_scope\"))
                (t
                 (funcall next req))))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 18 (fontified t) 18 22 (face font-lock-type-face fontified t) 22 179 (fontified t) 179 216 (face font-lock-comment-face fontified t) 216 251 (fontified t) 251 255 (face font-lock-builtin-face fontified t) 255 256 (fontified t) 256 262 (fontified t) 262 287 (face font-lock-comment-face fontified t) 287 333 (fontified t) 333 363 (face font-lock-comment-face fontified t) 363 365 (fontified t) 365 784 (face font-lock-doc-face fontified t) 784 788 (fontified t) 788 791 (face font-lock-keyword-face fontified t) 791 802 (fontified t) 802 804 (face font-lock-keyword-face fontified t) 804 866 (fontified t) 866 872 (face font-lock-keyword-face fontified t) 872 887 (fontified t) 887 893 (face font-lock-keyword-face fontified t) 893 909 (fontified t) 909 915 (face font-lock-keyword-face fontified t) 915 1012 (fontified t) 1012 1018 (face font-lock-builtin-face fontified t) 1018 1023 (fontified t) 1023 1028 (face font-lock-builtin-face fontified t) 1028 1031 (fontified t) 1031 1037 (face font-lock-string-face fontified t) 1037 1040 (fontified t) 1040 1048 (face font-lock-builtin-face fontified t) 1048 1076 (fontified t) 1076 1083 (face font-lock-builtin-face fontified t) 1083 1149 (fontified t) 1149 1153 (face font-lock-keyword-face fontified t) 1153 1165 (fontified t) 1165 1189 (fontified t) 1189 1223 (fontified t) 1223 1227 (face font-lock-builtin-face fontified t) 1227 1255 (fontified t) 1255 1261 (face font-lock-keyword-face fontified t) 1261 1281 (fontified t) 1281 1286 (face font-lock-builtin-face fontified t) 1286 1354 (fontified t) 1354 1360 (face font-lock-keyword-face fontified t) 1360 1380 (fontified t) 1380 1385 (face font-lock-builtin-face fontified t) 1385 1421 (fontified t) 1421 1425 (face font-lock-keyword-face fontified t) 1425 1500 (fontified t) 1500 1501 (fontified t) 1501 1519 (fontified t) 1519 1531 (fontified t) 1531 1534 (face font-lock-comment-delimiter-face fontified t) 1534 1581 (face font-lock-comment-face fontified t) 1581 1594 (fontified t) 1594 1598 (face font-lock-keyword-face fontified t) 1598 1618 (fontified t) 1618 1637 (face font-lock-keyword-face fontified t) 1637 1670 (fontified t) 1670 1683 (face font-lock-keyword-face fontified t) 1683 1735 (fontified t) 1735 1742 (face font-lock-builtin-face fontified t) 1742 1750 (fontified t) 1750 1757 (face font-lock-builtin-face fontified t) 1757 1760 (fontified t) 1760 1767 (face font-lock-builtin-face fontified t) 1767 1787 (fontified t) 1787 1798 (fontified t) 1798 1802 (face font-lock-keyword-face fontified t) 1802 1806 (fontified t) 1806 1824 (fontified t) 1824 1827 (face font-lock-comment-delimiter-face fontified t) 1827 1872 (face font-lock-comment-face fontified t) 1872 1920 (fontified t) 1920 1924 (face font-lock-builtin-face fontified t) 1924 1953 (fontified t) 1953 1957 (face font-lock-keyword-face fontified t) 1957 1965 (fontified t) 1965 1990 (fontified t) 1990 1997 (face font-lock-builtin-face fontified t) 1997 2022 (fontified t) 2022 2026 (face font-lock-keyword-face fontified t) 2026 2086 (fontified t) 2086 2093 (face font-lock-builtin-face fontified t) 2093 2119 (fontified t) 2119 2122 (face font-lock-comment-delimiter-face fontified t) 2122 2137 (face font-lock-comment-face fontified t) 2137 2150 (fontified t) 2150 2154 (face font-lock-keyword-face fontified t) 2154 2191 (fontified t) 2191 2195 (face font-lock-builtin-face fontified t) 2195 2255 (fontified t) 2255 2260 (face font-lock-builtin-face fontified t) 2260 2319 (fontified t) 2319 2325 (face font-lock-string-face fontified t) 2325 2387 (fontified t) 2387 2394 (face font-lock-builtin-face fontified t) 2394 2419 (fontified t) 2419 2423 (face font-lock-keyword-face fontified t) 2423 2496 (fontified t) 2496 2522 (face font-lock-string-face fontified t) 2522 2615 (fontified t) 2615 2620 (face font-lock-builtin-face fontified t) 2620 2661 (fontified t) 2661 2672 (face font-lock-string-face fontified t) 2672 2689 (fontified t) 2689 2738 (fontified t) 2738 2765 (fontified t) 2765 2785 (face font-lock-string-face fontified t) 2785 2852 (fontified t)) . -92333) (undo-tree-id0 . -575) (undo-tree-id1 . -1154) (undo-tree-id2 . -1154) (undo-tree-id3 . -1154) (undo-tree-id4 . -1603) (undo-tree-id5 . -2852) (undo-tree-id6 . -2852) (undo-tree-id7 . -2136) (undo-tree-id8 . -1) (undo-tree-id9 . -2852) (undo-tree-id10 . -1) (undo-tree-id11 . -1519) (undo-tree-id12 . -133) (undo-tree-id13 . -133) (undo-tree-id14 . -133) (undo-tree-id15 . -133) (undo-tree-id16 . -133) (undo-tree-id17 . -133) (undo-tree-id18 . -459) (undo-tree-id19 . -459) (undo-tree-id20 . -459) (undo-tree-id21 . -459) (undo-tree-id22 . -459) (undo-tree-id23 . -783) (undo-tree-id24 . -783) (undo-tree-id25 . -783) (undo-tree-id26 . -783) (undo-tree-id27 . -783) (undo-tree-id28 . -783) (undo-tree-id29 . -783) (undo-tree-id30 . -783) (undo-tree-id31 . -783) (undo-tree-id32 . -287) (undo-tree-id33 . -459) (undo-tree-id34 . -1) (undo-tree-id35 . -287) (undo-tree-id36 . -45) (undo-tree-id37 . -45) (undo-tree-id38 . -1) (undo-tree-id39 . -1519) (undo-tree-id40 . -879) (undo-tree-id41 . -1647) (undo-tree-id42 . -2562) (undo-tree-id43 . -2852) 95185) nil (26819 18376 269930 0) 0 nil])
([nil nil ((92333 . 92334)) nil (26819 18376 269887 0) 0 nil])
([nil nil ((90659 . 90665) (t 26819 18376 0 0)) nil (26819 22002 4978 0) 0 nil])
([nil nil ((90665 . 90666)) nil (26819 22002 4977 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -90665) (undo-tree-id86 . -1) 90666) nil (26819 22002 4976 0) 0 nil])
([nil nil ((90665 . 90671)) nil (26819 22002 4975 0) 0 nil])
([nil nil ((90671 . 90672)) nil (26819 22002 4975 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -90671) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) 90672) nil (26819 22002 4974 0) 0 nil])
([nil nil ((90671 . 90672)) nil (26819 22002 4971 0) 0 nil])
([nil nil ((90672 . 90673)) nil (26819 22002 4970 0) 0 nil])
([nil nil ((90673 . 90674)) nil (26819 22002 4970 0) 0 nil])
([nil nil ((90674 . 90675)) nil (26819 22002 4969 0) 0 nil])
([nil nil ((90675 . 90681)) nil (26819 22002 4969 0) 0 nil])
([nil nil ((#("K" 0 1 (face font-lock-string-face fontified t)) . -90679) (undo-tree-id79 . -1) (#("K" 0 1 (face font-lock-string-face fontified t)) . -90680) (undo-tree-id80 . -1) 90681) nil (26819 22002 4968 0) 0 nil])
([nil nil ((90679 . 90684)) nil (26819 22002 4967 0) 0 nil])
([nil nil ((90684 . 90685)) nil (26819 22002 4966 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-string-face fontified t)) . -90683) (undo-tree-id77 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -90684) (undo-tree-id78 . -1) 90685) nil (26819 22002 4966 0) 0 nil])
([nil nil ((90683 . 90684)) nil (26819 22002 4964 0) 0 nil])
([nil nil ((90684 . 90685)) nil (26819 22002 4963 0) 0 nil])
([nil nil ((90685 . 90688)) nil (26819 22002 4963 0) 0 nil])
([nil nil ((#("Ã©" 0 1 (face font-lock-string-face fontified t)) . -90687) (undo-tree-id76 . -1) 90688) nil (26819 22002 4962 0) 0 nil])
([nil nil ((90687 . 90689)) nil (26819 22002 4959 0) 0 nil])
([nil nil ((90689 . 90690)) nil (26819 22002 4959 0) 0 nil])
([nil nil ((90690 . 90693)) nil (26819 22002 4958 0) 0 nil])
([nil nil ((90693 . 90694)) nil (26819 22002 4958 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -90693) (undo-tree-id74 . -1) (undo-tree-id75 . -1) 90694) nil (26819 22002 4957 0) 0 nil])
([nil nil ((90693 . 90695)) nil (26819 22002 4956 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -90693) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (#(")" 0 1 (fontified t)) . -90694) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) 90695) nil (26819 22002 4954 0) 0 nil])
([nil nil ((90693 . 90694)) nil (26819 22002 4946 0) 0 nil])
([nil nil ((90689 . 90690)) nil (26819 22002 4945 0) 0 nil])
([nil nil ((90690 . 90691)) nil (26819 22002 4944 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -90691) (undo-tree-id61 . -1) 90692) nil (26819 22002 4940 0) 0 nil])
([nil nil ((90869 . 90875) (#(" " 0 1 (fontified nil)) . 90868) (undo-tree-id93 . -1) (#(" " 0 1 (fontified nil)) . -90842) (90870 . 90871) (t 26819 22002 0 0)) nil (26819 47276 411762 0) 0 nil])
([nil nil ((90924 . 90927)) nil (26819 47276 411761 0) 0 nil])
([nil nil ((90927 . 90931)) nil (26819 47276 411760 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -90927) (undo-tree-id89 . -1) (#("r" 0 1 (fontified t)) . -90928) (undo-tree-id90 . -1) (#("i" 0 1 (fontified t)) . -90929) (undo-tree-id91 . -1) (#("n" 0 1 (fontified t)) . -90930) (undo-tree-id92 . -1) 90931) nil (26819 47276 411759 0) 0 nil])
([nil nil ((90927 . 90933)) nil (26819 47276 411756 0) 0 nil])
([nil nil ((90933 . 90934)) nil (26819 47276 411756 0) 0 nil])
([nil nil ((90934 . 90937)) nil (26819 47276 411756 0) 0 nil])
([nil nil ((90937 . 90940)) nil (26819 47276 411755 0) 0 nil])
([nil nil ((90940 . 90942)) nil (26819 47276 411755 0) 0 nil])
([nil nil ((90942 . 90946)) nil (26819 47276 411754 0) 0 nil])
([nil nil ((90946 . 90947)) nil (26819 47276 411754 0) 0 nil])
([nil nil ((90947 . 90952)) nil (26819 47276 411754 0) 0 nil])
([nil nil ((90947 . 90954) (#("paylo" 0 5 (fontified t)) . -90947) (undo-tree-id88 . -5) 90952) nil (26819 47276 411753 0) 0 nil])
([nil nil ((90954 . 90955)) nil (26819 47276 411751 0) 0 nil])
([nil nil ((91957 . 91965)) nil (26819 47276 411750 0) 0 nil])
([nil nil ((91965 . 91971)) nil (26819 47276 411750 0) 0 nil])
([nil nil ((91971 . 91972)) nil (26819 47276 411749 0) 0 nil])
([nil nil ((91972 . 91979)) nil (26819 47276 411749 0) 0 nil])
([nil nil ((91979 . 91987)) nil (26819 47276 411749 0) 0 nil])
([nil nil ((91987 . 91988)) nil (26819 47276 411748 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -91987) (undo-tree-id87 . -1) 91988) nil (26819 47276 411747 0) 0 nil])
([nil nil ((91987 . 91993)) nil (26819 47276 411738 0) 0 nil])
([nil nil ((91993 . 91994)) nil (26819 47276 411737 0) 0 nil])
([nil nil ((91994 . 91996)) nil (26819 47276 411736 0) 0 nil])
([nil nil ((91996 . 91998)) nil (26819 47276 411736 0) 0 nil])
([nil nil ((91998 . 92006)) nil (26819 47276 411736 0) 0 nil])
([nil nil ((92006 . 92012)) nil (26819 47276 411735 0) 0 nil])
([nil nil ((92012 . 92013)) nil (26819 47276 411735 0) 0 nil])
([nil nil ((92013 . 92018)) nil (26819 47276 411734 0) 0 nil])
([nil nil ((92018 . 92026)) nil (26819 47276 411734 0) 0 nil])
([nil nil ((92026 . 92032)) nil (26819 47276 411733 0) 0 nil])
([nil nil ((92032 . 92033)) nil (26819 47276 411732 0) 0 nil])
([nil nil ((92033 . 92036)) nil (26819 47276 411727 0) 0 nil])
([nil nil ((#("(defun auth-required ()
  (auth-jwt :required-p t))

(defun roles-allowed (roles)
  (auth-jwt :required-p t :roles-allow roles))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 36 (fontified t) 36 47 (face font-lock-builtin-face fontified t) 47 49 (fontified t) 49 52 (fontified t) 52 54 (fontified t) 54 59 (face font-lock-keyword-face fontified t) 59 60 (fontified t) 60 73 (face font-lock-function-name-face fontified t) 73 94 (fontified t) 94 105 (face font-lock-builtin-face fontified t) 105 108 (fontified t) 108 120 (face font-lock-builtin-face fontified t) 120 128 (fontified t)) . -92486) (undo-tree-id94 . -128) 92614 (t 26819 47276 0 0)) nil (26819 54738 374583 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 93596 . 93597) (nil fontified nil 92486 . 93597) (92486 . 93597)) nil (26819 54738 374568 0) 0 nil])
([nil nil ((86915 . 86916) (t 26819 54738 0 0)) nil (26819 54784 304605 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 92275 . 92276) (nil fontified nil 86916 . 92276) (86916 . 92276)) nil (26819 54784 304605 0) 0 nil])
([nil nil ((92276 . 92277)) nil (26819 54784 304604 0) 0 nil])
([nil nil ((92277 . 92279)) nil (26819 54784 304603 0) 0 nil])
([nil nil ((97849 . 97851)) nil (26819 54784 304599 0) 0 nil])
([nil nil ((6173 . 6175) (t 26819 54784 0 0)) nil (26821 5291 64867 0) 0 nil])
([nil nil ((6360 . 6361)) nil (26821 5291 64866 0) 0 nil])
([nil nil ((#("Ã©" 0 1 (face font-lock-string-face fontified t)) . -6360) (undo-tree-id95 . -1) 6361) nil (26821 5291 64865 0) 0 nil])
([nil nil ((6360 . 6361)) nil (26821 5291 64851 0) 0 nil])
([nil nil ((111866 . 111868) (t 26821 5291 0 0)) nil (26821 14732 286177 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 115173 . 115174) (nil fontified nil 111868 . 115174) (111868 . 115174)) nil (26821 14732 286177 0) 0 nil])
([nil nil ((#("uuid:make-v4-string" 0 19 (fontified t)) . -113821) (undo-tree-id99 . -19) 113840) nil (26821 14732 286176 0) 0 nil])
([nil nil ((113821 . 113836)) nil (26821 14732 286170 0) 0 nil])
([nil nil ((113821 . 113848) (#("lumen.utils:gen" 0 15 (fontified t)) . -113821) (undo-tree-id98 . -15) 113836) nil (26821 14732 286166 0) 0 nil])
([nil nil ((#("(ua   (cdr (assoc \"user-agent\" hdrs :test #'string=)))
             (ip   (or (cdr (assoc \"x-forwarded-for\" hdrs :test #'string=))
                       (ignore-errors (lumen.core.http:req-remote-addr req))))" 0 18 (fontified t) 18 30 (face font-lock-string-face fontified t) 30 36 (fontified t) 36 41 (face font-lock-builtin-face fontified t) 41 90 (fontified t) 90 107 (face font-lock-string-face fontified t) 107 113 (fontified t) 113 118 (face font-lock-builtin-face fontified t) 118 155 (fontified t) 155 168 (face font-lock-keyword-face fontified t) 168 209 (fontified t)) . -113937) (undo-tree-id97 . -209) 114146) nil (26821 14732 286163 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 113989 . 113990) (nil fontified nil 113937 . 113990) (113937 . 113990)) nil (26821 14732 286161 0) 0 nil])
([nil nil ((115027 . 115029)) nil (26821 14732 286161 0) 0 nil])
([nil nil ((116005 . 116007)) nil (26821 14732 286160 0) 0 nil])
([nil nil ((#(";; ---- Middleware request-context -------------------------------------------" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 78 (face font-lock-comment-face fontified t)) . 111788)) nil (26821 14732 286159 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -111787) (undo-tree-id96 . -1) 111788) nil (26821 14732 286158 0) 0 nil])
([nil nil ((113284 . 113285)) nil (26821 14732 286137 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 113362 . 113363) (nil fontified nil 113288 . 113363) (nil fontified nil 113285 . 113288) (113285 . 113363)) nil (26821 14732 286135 0) 0 nil])
([nil nil ((116007 . 116008)) nil (26821 14732 286130 0) 0 nil])
([nil nil ((6360 . 6361) (t 26821 14732 0 0)) nil (26821 15856 565848 0) 0 nil])
([nil nil ((87463 . 87465) (#("   " 0 3 (fontified nil)) . -87436) (87465 . 87466) (t 26821 15856 0 0)) nil (26822 27826 498088 0) 0 nil])
([nil nil ((87465 . 87471)) nil (26822 27826 498087 0) 0 nil])
([nil nil ((87471 . 87472)) nil (26822 27826 498086 0) 0 nil])
([nil nil ((87472 . 87473)) nil (26822 27826 498084 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -87472) (undo-tree-id26 . -1) 87473) nil (26822 27826 498083 0) 0 nil])
([nil nil ((87472 . 87474)) nil (26822 27826 498080 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -87472) (undo-tree-id24 . -1) (#("'" 0 1 (fontified t)) . -87473) (undo-tree-id25 . -1) 87474) nil (26822 27826 498079 0) 0 nil])
([nil nil ((87472 . 87480)) nil (26822 27826 498072 0) 0 nil])
([nil nil ((87480 . 87481)) nil (26822 27826 498071 0) 0 nil])
([nil nil ((87481 . 87483)) nil (26822 27826 498070 0) 0 nil])
([nil nil ((87483 . 87484)) nil (26822 27826 498070 0) 0 nil])
([nil nil ((87484 . 87488)) nil (26822 27826 498069 0) 0 nil])
([nil nil ((87488 . 87489)) nil (26822 27826 498068 0) 0 nil])
([nil nil ((87489 . 87491)) nil (26822 27826 498067 0) 0 nil])
([nil nil ((87491 . 87494)) nil (26822 27826 498065 0) 0 nil])
([nil nil ((91582 . 91583) (91527 . 91528) (91478 . 91479) (91389 . 91390) (91322 . 91323) (91274 . 91275) (" " . -90150) (#("   " 0 3 (fontified t)) . -87362) (#("   " 0 3 (fontified t)) . -87318) (#("   " 0 3 (fontified t)) . -87268) (#("   " 0 3 (fontified t)) . -87219) (#("   " 0 3 (fontified t)) . -87176) (#("   " 0 3 (fontified t)) . -87141) (#("   " 0 3 (fontified t)) . -87103) (#("   " 0 3 (fontified t)) . -87065) (#("   " 0 3 (fontified t)) . -87028) (#("   " 0 3 (fontified t)) . -86992) 86920) nil (26822 27826 498062 0) 0 nil])
([nil nil ((90196 . 90204) (#(" " 0 1 (fontified nil)) . 90195) (undo-tree-id23 . -1) (90196 . 90197)) nil (26822 27826 498057 0) 0 nil])
([nil nil ((90234 . 90237)) nil (26822 27826 498054 0) 0 nil])
([nil nil ((90237 . 90243)) nil (26822 27826 498053 0) 0 nil])
([nil nil ((90243 . 90244)) nil (26822 27826 498052 0) 0 nil])
([nil nil ((90244 . 90246)) nil (26822 27826 498051 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -90238) (undo-tree-id15 . -1) (#("r" 0 1 (fontified t)) . -90239) (undo-tree-id16 . -1) (#("i" 0 1 (fontified t)) . -90240) (undo-tree-id17 . -1) (#("n" 0 1 (fontified t)) . -90241) (undo-tree-id18 . -1) (#("t" 0 1 (fontified t)) . -90242) (undo-tree-id19 . -1) (#(" " 0 1 (fontified t)) . -90243) (undo-tree-id20 . -1) (#("p" 0 1 (fontified t)) . -90244) (undo-tree-id21 . -1) (#("a" 0 1 (fontified t)) . -90245) (undo-tree-id22 . -1) 90246) nil (26822 27826 498048 0) 0 nil])
([nil nil ((90238 . 90243)) nil (26822 27826 498035 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -90242) (undo-tree-id14 . -1) 90243) nil (26822 27826 498034 0) 0 nil])
([nil nil ((90242 . 90244)) nil (26822 27826 498031 0) 0 nil])
([nil nil ((90244 . 90245)) nil (26822 27826 498030 0) 0 nil])
([nil nil ((90245 . 90246)) nil (26822 27826 498029 0) 0 nil])
([nil nil ((90246 . 90247)) nil (26822 27826 498029 0) 0 nil])
([nil nil ((90247 . 90256)) nil (26822 27826 498027 0) 0 nil])
([nil nil ((90256 . 90257)) nil (26822 27826 498026 0) 0 nil])
([nil nil ((90257 . 90261)) nil (26822 27826 498025 0) 0 nil])
([nil nil ((#("M" 0 1 (face font-lock-string-face fontified t)) . -90260) (undo-tree-id13 . -1) 90261) nil (26822 27826 498024 0) 0 nil])
([nil nil ((90260 . 90262)) nil (26822 27826 498021 0) 0 nil])
([nil nil ((90262 . 90263)) nil (26822 27826 498020 0) 0 nil])
([nil nil ((90263 . 90267)) nil (26822 27826 498019 0) 0 nil])
([nil nil ((90267 . 90270)) nil (26822 27826 498018 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 90299 . 90300) (nil fontified nil 90295 . 90300) (nil fontified nil 90280 . 90295) (nil fontified nil 90270 . 90280) (90270 . 90300)) nil (26822 27826 498016 0) 0 nil])
([nil nil ((#("TOKEN" 0 5 (face font-lock-string-face fontified t)) . -90283) (undo-tree-id12 . -5) 90288) nil (26822 27826 498014 0) 0 nil])
([nil nil ((90283 . 90290)) nil (26822 27826 498012 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -90298) (undo-tree-id11 . -3) 90301) nil (26822 27826 498010 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 90304 . 90305) (nil fontified nil 90298 . 90305) (90298 . 90305)) nil (26822 27826 498007 0) 0 nil])
([nil nil ((90306 . 90309)) nil (26822 27826 498006 0) 0 nil])
([nil nil ((nil fontified nil 90344 . 90345) (nil fontified nil 90343 . 90344) (nil fontified nil 90337 . 90343) (nil fontified nil 90336 . 90337) (nil fontified nil 90319 . 90336) (nil fontified nil 90309 . 90319) (90309 . 90345)) nil (26822 27826 498004 0) 0 nil])
([nil nil ((#("PAYLOAD" 0 7 (face font-lock-string-face fontified t)) . -90322) (undo-tree-id10 . -7) 90329) nil (26822 27826 498002 0) 0 nil])
([nil nil ((90322 . 90324)) nil (26822 27826 497999 0) 0 nil])
([nil nil ((#("payload" 0 6 (fontified t) 6 7 (fontified t rear-nonsticky t)) . -90332) (undo-tree-id9 . -7) 90339) nil (26822 27826 497998 0) 0 nil])
([nil nil ((90332 . 90334)) nil (26822 27826 497995 0) 0 nil])
([nil nil ((91731 . 91739)) nil (26822 27826 497994 0) 0 nil])
([nil nil ((nil fontified nil 91836 . 91837) (nil fontified nil 91833 . 91836) (nil fontified nil 91821 . 91833) (nil fontified nil 91811 . 91821) (nil fontified nil 91809 . 91811) (nil fontified nil 91808 . 91809) (nil fontified nil 91807 . 91808) (nil fontified nil 91806 . 91807) (nil fontified nil 91800 . 91806) (nil fontified nil 91799 . 91800) (nil fontified nil 91782 . 91799) (nil fontified nil 91772 . 91782) (nil fontified nil 91770 . 91772) (nil fontified nil 91764 . 91770) (nil fontified nil 91749 . 91764) (nil fontified nil 91739 . 91749) (91739 . 91837)) nil (26822 27826 497992 0) 0 nil])
([nil nil ((#("TOKEN" 0 5 (face font-lock-string-face fontified t)) . -91752) (undo-tree-id8 . -5) 91757) nil (26822 27826 497987 0) 0 nil])
([nil nil ((91752 . 91755)) nil (26822 27826 497985 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -91763) (undo-tree-id7 . -3) 91766) nil (26822 27826 497984 0) 0 nil])
([nil nil ((91763 . 91766)) nil (26822 27826 497981 0) 0 nil])
([nil nil ((#("PAYLOAD" 0 7 (face font-lock-string-face fontified t)) . -91783) (undo-tree-id6 . -7) 91790) nil (26822 27826 497980 0) 0 nil])
([nil nil ((91783 . 91784)) nil (26822 27826 497975 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-string-face fontified t)) . -91783) (undo-tree-id5 . -1) 91784) nil (26822 27826 497974 0) 0 nil])
([nil nil ((91783 . 91785)) nil (26822 27826 497970 0) 0 nil])
([nil nil ((91785 . 91786)) nil (26822 27826 497969 0) 0 nil])
([nil nil ((91786 . 91791)) nil (26822 27826 497968 0) 0 nil])
([nil nil ((#("payload" 0 6 (fontified t) 6 7 (fontified t rear-nonsticky t)) . -91799) (undo-tree-id4 . -7) 91806) nil (26822 27826 497967 0) 0 nil])
([nil nil ((91799 . 91804)) nil (26822 27826 497964 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -91803) (undo-tree-id3 . -1) 91804) nil (26822 27826 497962 0) 0 nil])
([nil nil ((91803 . 91804)) nil (26822 27826 497958 0) 0 nil])
([nil nil ((91799 . 91807) (#("is-ad" 0 5 (fontified t)) . -91799) (undo-tree-id2 . -5) 91804) nil (26822 27826 497955 0) 0 nil])
([nil nil ((#("
		(format t \"~&OK: ~A~%\" ok)" 0 1 (fontified t) 1 3 (fontified t) 3 13 (fontified t) 13 25 (face font-lock-string-face fontified t) 25 28 (fontified t) 28 29 (fontified t rear-nonsticky t)) . 91808) (undo-tree-id0 . -29) (undo-tree-id1 . -29)) nil (26822 27826 497945 0) 0 nil])
([nil nil ((86694 . 86699) (t 26822 27826 0 0)) nil (26822 28062 428841 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 86728 . 86729) (nil fontified nil 86724 . 86729) (nil fontified nil 86709 . 86724) (nil fontified nil 86702 . 86709) (nil fontified nil 86699 . 86702) (86699 . 86729)) nil (26822 28062 428840 0) 0 nil])
([nil nil ((#("TOKEN" 0 5 (face font-lock-string-face fontified t)) . -86712) (undo-tree-id41 . -5) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -5) (undo-tree-id48 . -5) (undo-tree-id49 . -5) (undo-tree-id50 . -5) 86717) nil (26822 28062 428837 0) 0 nil])
([nil nil ((86712 . 86714)) nil (26822 28062 428827 0) 0 nil])
([nil nil ((#("tok" 0 3 (fontified t)) . -86722) (undo-tree-id27 . -3) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -3) (undo-tree-id34 . -3) (undo-tree-id35 . -3) (undo-tree-id36 . -3) (undo-tree-id37 . -3) (undo-tree-id38 . -3) (undo-tree-id39 . -3) (undo-tree-id40 . -3) 86725) nil (26822 28062 428824 0) 0 nil])
([nil nil ((86722 . 86724)) nil (26822 28062 428795 0) 0 nil])
([nil nil ((87114 . 87115) (t 26822 28062 0 0)) nil (26822 28185 171919 0) 0 nil])
([nil nil ((87115 . 87116)) nil (26822 28185 171918 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -87115) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) 87116) nil (26822 28185 171916 0) 0 nil])
([nil nil ((87115 . 87120)) nil (26822 28185 171913 0) 0 nil])
([nil nil ((#("q" 0 1 (fontified t)) . -87114) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (#("u" 0 1 (fontified t)) . -87115) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (#("e" 0 1 (fontified t)) . -87116) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (#("r" 0 1 (fontified t)) . -87117) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (#("y" 0 1 (fontified t)) . -87118) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (#("-" 0 1 (fontified t)) . -87119) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) 87120) nil (26822 28185 171908 0) 0 nil])
([nil nil ((#("params" 0 6 (fontified t)) . -86681) (undo-tree-id51 . -6) (undo-tree-id52 . -3) (undo-tree-id53 . -3) (undo-tree-id54 . -3) (undo-tree-id55 . -3) (undo-tree-id56 . -3) (undo-tree-id57 . -6) (undo-tree-id58 . -6) (undo-tree-id59 . -6) (undo-tree-id60 . -6) (undo-tree-id61 . -6) (undo-tree-id62 . -6) (undo-tree-id63 . -6) (undo-tree-id64 . -6) 86687) nil (26822 28185 171841 0) 0 nil])
([nil nil ((86681 . 86686)) nil (26822 28185 171809 0) 0 nil])
([nil nil ((91844 . 91851) (#("	" 0 1 (fontified nil)) . -91805) (91805 . 91806) (#("	" 0 1 (fontified nil)) . 91805) (91799 . 91805) (91838 . 91839) (t 26822 28185 0 0)) nil (26822 30879 257895 0) 0 nil])
([nil nil ((91851 . 91852)) nil (26822 30879 257894 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -91851) (undo-tree-id136 . -1) 91852) nil (26822 30879 257893 0) 0 nil])
([nil nil ((nil fontified nil 91888 . 91889) (nil fontified nil 91880 . 91888) (nil fontified nil 91879 . 91880) (nil fontified nil 91861 . 91879) (nil fontified nil 91851 . 91861) (91851 . 91889)) nil (26822 30879 257891 0) 0 nil])
([nil nil ((#("ADMIN" 0 5 (face font-lock-string-face fontified t)) . -91867) (undo-tree-id135 . -5) 91872) nil (26822 30879 257889 0) 0 nil])
([nil nil ((91867 . 91875)) nil (26822 30879 257887 0) 0 nil])
([nil nil ((91875 . 91876)) nil (26822 30879 257887 0) 0 nil])
([nil nil ((91876 . 91877)) nil (26822 30879 257886 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-string-face fontified t)) . 91877)) nil (26822 30879 257886 0) 0 nil])
([nil nil ((#("is-admin" 0 8 (fontified t)) . -91884) (undo-tree-id134 . -8) 91892) nil (26822 30879 257884 0) 0 nil])
([nil nil ((91884 . 91889)) nil (26822 30879 257874 0) 0 nil])
([nil nil ((91889 . 91893)) nil (26822 30879 257873 0) 0 nil])
([nil nil ((91892 . 91893)) nil (26822 30879 257869 0) 0 nil])
([nil nil ((#("
						 " 0 1 (fontified t) 1 8 (fontified t)) . -90225) (undo-tree-id138 . -8) 90233 (t 26822 30879 0 0)) nil (26822 35524 462092 0) 0 nil])
([nil nil ((90236 . 90244) (#(" " 0 1 (fontified nil)) . 90235) (undo-tree-id137 . -1) (90236 . 90237)) nil (26822 35524 462089 0) 0 nil])
([nil nil ((90262 . 90263)) nil (26822 35524 462080 0) 0 nil])
([nil nil ((90263 . 90269)) nil (26822 35524 462080 0) 0 nil])
([nil nil ((90269 . 90270)) nil (26822 35524 462079 0) 0 nil])
([nil nil ((90270 . 90271)) nil (26822 35524 462074 0) 0 nil])
([nil nil ((90276 . 90278) (t 26822 35524 0 0)) nil (26822 35920 303659 0) 0 nil])
([nil nil ((90311 . 90313)) nil (26822 35920 303658 0) 0 nil])
([nil nil ((90352 . 90354)) nil (26822 35920 303656 0) 0 nil])
([nil nil ((91784 . 91786)) nil (26822 35920 303656 0) 0 nil])
([nil nil ((91822 . 91824)) nil (26822 35920 303654 0) 0 nil])
([nil nil ((91870 . 91872)) nil (26822 35920 303650 0) 0 nil])
([nil nil ((#("
    (format t \"~&QP: ~A~%\" qp)" 0 1 (fontified t) 1 5 (fontified t) 5 8 (fontified t) 8 15 (fontified t) 15 27 (face font-lock-string-face fontified t) 27 30 (fontified t) 30 31 (fontified t rear-nonsticky t)) . 86693) (undo-tree-id139 . -31) (undo-tree-id140 . -28) (undo-tree-id141 . -14) (undo-tree-id142 . -14) (undo-tree-id143 . -14) (undo-tree-id144 . -14) (undo-tree-id145 . -14) (undo-tree-id146 . -14) (undo-tree-id147 . -14) (undo-tree-id148 . -31) (undo-tree-id149 . -31) (undo-tree-id150 . -31) (undo-tree-id151 . -31) (t 26822 35920 0 0)) nil (26822 36283 781368 0) 0 nil])
([nil nil ((18570 . 18571) (t 26822 36283 0 0)) nil (26822 39036 637653 0) 0 nil])
([nil nil ((18571 . 18572)) nil (26822 39036 637652 0) 0 nil])
([nil nil ((#("|" 0 1 (fontified t)) . -18571) (undo-tree-id156 . -1) 18572) nil (26822 39036 637651 0) 0 nil])
([nil nil ((18571 . 18573)) nil (26822 39036 637650 0) 0 nil])
([nil nil ((19100 . 19102)) nil (26822 39036 637649 0) 0 nil])
([nil nil ((#("\\" 0 1 (face font-lock-comment-face fontified t)) . -19100) (undo-tree-id154 . -1) (#("#" 0 1 (face font-lock-comment-face fontified t)) . -19101) (undo-tree-id155 . -1) 19102) nil (26822 39036 637648 0) 0 nil])
([nil nil ((19100 . 19102)) nil (26822 39036 637645 0) 0 nil])
([nil nil ((19102 . 19103)) nil (26822 39036 637644 0) 0 nil])
([nil nil ((333 . 336)) nil (26822 39036 637643 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 437 . 438) (nil fontified nil 437 . 438) (nil fontified nil 420 . 437) (nil fontified nil 417 . 420) (nil fontified nil 401 . 417) (nil fontified nil 400 . 401) (nil fontified nil 386 . 400) (nil fontified nil 385 . 386) (nil fontified nil 372 . 385) (nil fontified nil 371 . 372) (nil fontified nil 367 . 371) (nil fontified nil 366 . 367) (nil fontified nil 363 . 366) (nil fontified nil 362 . 363) (nil fontified nil 350 . 362) (nil fontified nil 349 . 350) (nil fontified nil 337 . 349) (nil fontified nil 336 . 337) (336 . 438)) nil (26822 39036 637642 0) 0 nil])
([nil nil ((#(":lumen.utils" 0 12 (face font-lock-builtin-face fontified t)) . -350) (undo-tree-id153 . -12) 362) nil (26822 39036 637639 0) 0 nil])
([nil nil ((350 . 351)) nil (26822 39036 637637 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 365 . 366) (nil fontified nil 351 . 366) (351 . 366)) nil (26822 39036 637636 0) 0 nil])
([nil nil ((#(":-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date" 0 3 (face font-lock-builtin-face fontified t) 3 4 (fontified t) 4 8 (face font-lock-builtin-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-builtin-face fontified t) 22 23 (fontified t) 23 37 (face font-lock-builtin-face fontified t) 37 38 (fontified t) 38 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 57 (fontified t) 57 74 (face font-lock-builtin-face fontified t)) . -367) (undo-tree-id152 . -74) 441) nil (26822 39036 637634 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 385 . 386) (nil fontified nil 367 . 386) (367 . 386)) nil (26822 39036 637622 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 43178 . 43179) (nil fontified nil 43164 . 43179) (43164 . 43179)) nil (26822 39036 637621 0) 0 nil])
([nil nil ((43179 . 43180)) nil (26822 39036 637620 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 44301 . 44302) (nil fontified nil 44287 . 44302) (44287 . 44302)) nil (26822 39036 637620 0) 0 nil])
([nil nil ((44302 . 44303)) nil (26822 39036 637619 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 48070 . 48071) (nil fontified nil 48056 . 48071) (48056 . 48071)) nil (26822 39036 637618 0) 0 nil])
([nil nil ((48071 . 48072)) nil (26822 39036 637617 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 51554 . 51555) (nil fontified nil 51540 . 51555) (51540 . 51555)) nil (26822 39036 637615 0) 0 nil])
([nil nil ((51555 . 51556)) nil (26822 39036 637610 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -1481) (undo-tree-id157 . -1) 1482 (t 26822 39036 0 0)) nil (26822 40105 161146 0) 0 nil])
([nil nil ((1481 . 1482)) nil (26822 40105 161133 0) 0 nil])
([nil nil ((#("(defun path-matches? (path paths prefixes)
  (or (and paths (member path paths :test #'string=))
      (and prefixes (some (lambda (pfx)
                            (and (<= (length pfx) (length path))
                                 (string= pfx path :end2 (length pfx))))
                          prefixes))))

(defun json-only (&key paths prefixes)
  \"Middleware factory. Force Content-Type JSON pour les routes listÃ©es.\"
  (lambda (next)
    (lambda (req)
      (let* ((resp (funcall next req))
             (path (lumen.core.http:req-path req)))
        (when (path-matches? path paths prefixes)
          (setf (lumen.core.http:resp-headers resp)
                (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                               \"content-type\"
                               \"application/json; charset=utf-8\")))
        resp))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 79 (fontified t) 79 84 (face font-lock-builtin-face fontified t) 84 124 (fontified t) 124 130 (face font-lock-keyword-face fontified t) 130 253 (fontified t) 253 258 (face font-lock-builtin-face fontified t) 258 315 (fontified t) 315 316 (fontified t) 316 321 (face font-lock-keyword-face fontified t) 321 322 (fontified t) 322 331 (face font-lock-function-name-face fontified t) 331 333 (fontified t) 333 337 (face font-lock-type-face fontified t) 337 356 (fontified t) 356 426 (face font-lock-doc-face fontified t) 426 430 (fontified t) 430 436 (face font-lock-keyword-face fontified t) 436 449 (fontified t) 449 455 (face font-lock-keyword-face fontified t) 455 469 (fontified t) 469 473 (face font-lock-keyword-face fontified t) 473 562 (fontified t) 562 566 (face font-lock-keyword-face fontified t) 566 765 (fontified t) 765 779 (face font-lock-string-face fontified t) 779 811 (fontified t) 811 828 (face font-lock-string-face fontified t) 828 844 (face font-lock-string-face fontified t) 844 864 (fontified t)) . -8113) (undo-tree-id1 . -864) (undo-tree-id2 . -864) (undo-tree-id3 . -864) 8977 (t 26822 40105 0 0)) nil (26822 45479 180243 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10744 . 10745) (nil fontified nil 8113 . 10745) (8113 . 10745)) nil (26822 45479 180240 0) 0 nil])
([nil nil ((979 . 980)) nil (26822 45479 180238 0) 0 nil])
([nil nil ((#("b" 0 1 (face font-lock-builtin-face fontified t)) . -979) (undo-tree-id0 . -1) 980) nil (26822 45479 180236 0) 0 nil])
([nil nil ((60793 . 60799) (#(" " 0 1 (fontified nil)) . 60792) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (60793 . 60794) (t 26822 45479 0 0)) nil (26822 60851 373866 0) 0 nil])
([nil nil ((60847 . 60851)) nil (26822 60851 373845 0) 0 nil])
([nil nil ((60851 . 60857)) nil (26822 60851 373845 0) 0 nil])
([nil nil ((60857 . 60858)) nil (26822 60851 373844 0) 0 nil])
([nil nil ((60858 . 60866)) nil (26822 60851 373843 0) 0 nil])
([nil nil ((60866 . 60870)) nil (26822 60851 373842 0) 0 nil])
([nil nil ((60870 . 60876)) nil (26822 60851 373842 0) 0 nil])
([nil nil ((60876 . 60877)) nil (26822 60851 373841 0) 0 nil])
([nil nil ((60877 . 60881)) nil (26822 60851 373837 0) 0 nil])
([nil nil ((60851 . 60853) (t 26822 60851 0 0)) nil (26822 63465 557388 0) 0 nil])
([nil nil ((60872 . 60874)) nil (26822 63465 557384 0) 0 nil])
([nil nil ((115879 . 115886) (t 26822 63465 0 0)) nil (26949 35765 979949 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 115914 . 115915) (nil fontified nil 115914 . 115915) (nil fontified nil 115893 . 115914) (nil fontified nil 115886 . 115893) (115886 . 115915)) nil (26949 35765 979948 0) 0 nil])
([nil nil ((#("TENANT FROM HOST" 0 16 (face font-lock-string-face fontified t)) . -115897) (undo-tree-id0 . -16) (undo-tree-id1 . -16) (undo-tree-id2 . -16) 115913) nil (26949 35765 979946 0) 0 nil])
([nil nil ((115897 . 115912)) nil (26949 35765 979928 0) 0 nil])
([nil nil ((116816 . 116818) (t 26949 35765 0 0)) nil (26949 35967 694806 0) 0 nil])
([nil nil ((116818 . 116819)) nil (26949 35967 694805 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -116818) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 116819) nil (26949 35967 694803 0) 0 nil])
([nil nil ((116818 . 116824)) nil (26949 35967 694786 0) 0 nil])
([nil nil ((116824 . 116825)) nil (26949 35967 694785 0) 0 nil])
([nil nil ((116825 . 116829)) nil (26949 35967 694780 0) 0 nil])
([nil nil ((116818 . 116820) (t 26949 35967 0 0)) nil (26949 36197 240766 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -116818) (undo-tree-id8 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -116819) (undo-tree-id9 . -1) 116820) nil (26949 36197 240764 0) 0 nil])
([nil nil ((116829 . 116831)) nil (26949 36197 240755 0) 0 nil])
([nil nil ((116831 . 116837)) nil (26949 36197 240754 0) 0 nil])
([nil nil ((116837 . 116838)) nil (26949 36197 240753 0) 0 nil])
([nil nil ((116838 . 116843)) nil (26949 36197 240749 0) 0 nil])
([nil nil ((#("
	(print jwt)
	(print \"OK\")" 0 1 (fontified t) 1 2 (fontified t) 2 14 (fontified t) 14 22 (fontified t) 22 26 (face font-lock-string-face fontified t) 26 27 (fontified t)) . 116816) (undo-tree-id10 . -27) (undo-tree-id11 . -13) (undo-tree-id12 . -13) (undo-tree-id13 . -27) (undo-tree-id14 . -13) (undo-tree-id15 . -27) (t 26949 36197 0 0)) nil (26949 36306 72313 0) 0 nil])
([nil nil ((#("
#|
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)        ; '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any)        ; :any (OR) | :all (AND)
                      (leeway-sec 60)
                      ;; NOUVEAU :
                      (allow-query-token-p t)   ; autoriser ?access=... (utile pour SSE)
                      (qs-keys '(\"access\" \"token\")))
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx et applique des gardes optionnelles.
Sources de token supportÃ©es (par ordre de prioritÃ©) :
  1) Authorization: Bearer <jwt>
  2) Query-string: ?access=... (ou :qs-keys)
  3) Cookie: access_token
 - SECRET         : clÃ© HMAC (dÃ©faut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)
 - LEEWAY-SEC     : tolÃ©rance de clock skew sur exp/iat.\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (labels
            ((fail (status msg)
               (lumen.core.http:respond-json
                `((:error . ((:type . \"auth\") (:message . ,msg))))
                :status status))
             (normalize-scopes (v)
               ;; tolÃ¨re list/vector/string/json/csv
               (handler-case
                   (let* ((lst (cond
                                 ((null v) '())
                                 ((listp v) v)
                                 ((vectorp v) (loop for x across v collect x))
                                 ((stringp v)
                                  (let* ((s (string-trim \" \" v)))
                                    (cond
                                      ((and (> (length s) 1)
                                            (char= (char s 0) #\\[)
                                            (char= (char s (1- (length s))) #\\]))
                                       ;; JSON-ish trÃ¨s tolÃ©rant
                                       (let* ((inner (subseq s 1 (1- (length s))))
                                              (parts (cl-ppcre:split \"\\\\s*,\\\\s*\" inner)))
                                         (mapcar (lambda (x)
                                                   (let ((y (string-trim \" \\\"\" x))) y))
                                                 parts)))
                                      ((search \",\" s)
                                       (cl-ppcre:split \"\\\\s*,\\\\s*\" s))
                                      (t (list s)))))
                                 (t (list (princ-to-string v))))))
                     (remove-duplicates
                      (remove-if (lambda (s) (or (null s) (string= s \"\")))
                                 (mapcar (lambda (s)
                                           (substitute #\\: #\\. (string s))) ; courriers.read â†’ courriers:read
                                         lst))
                      :test #'string=))
                 (error () '())))
             (has-scopes? (needed have)
               (cond
                 ((null needed) t)
                 ((eq scopes-mode :all)
                  (every (lambda (x) (member x have :test #'string=)) needed))
                 (t
                  (some  (lambda (x) (member x have :test #'string=)) needed)))))
          (let* ((hdrs (lumen.core.http:req-headers req))
                 (tok  (or (%bearer-token-from hdrs)
                           (and allow-query-token-p (%query-token-from req :keys qs-keys))
                           (%cookie req \"access_token\"))))
	    (format t \"~&TOKEN: ~A~%\" tok)
            ;; DÃ©codage
            (when tok
              (multiple-value-bind (payload ok)
                  (ignore-errors
                   (lumen.core.jwt:jwt-decode
		    tok :secret secret :verify t :leeway leeway-sec))
		(print ok)
		(print payload)
                (when ok
                  ;; Pose le JWT et alias utiles
                  (lumen.core.http:ctx-set! req :jwt payload)
                  (let* ((tenant (or (%alist-get-ci payload :tenant)
                                     (%alist-get-ci payload \"tenant\")))
                         (tenant-id (or (%alist-get-ci payload :tenant-id)
                                        (%alist-get-ci payload \"tenant_id\")
                                        tenant)))
                    (when tenant-id
                      (lumen.core.http:ctx-set! req :tenant-id tenant-id))
                    (when tenant
                      (lumen.core.http:ctx-set! req :tenant tenant))))))
            ;; VÃ©rifs dâ€™accÃ¨s
            (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                   (role (and jwt (or (%alist-get-ci jwt :role)
                                      (%alist-get-ci jwt \"role\"))))
                   (sc   (normalize-scopes (and jwt (%alist-get-ci jwt :scopes)))))
	      (print \"XVEV\")
	      (print jwt)
	      (print role)
	      (print sc)
              (cond
                ((and required-p (null jwt))
                 (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
                 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scopes? scopes-allow sc)))
                 (fail 403 \"insufficient_scope\"))
                (t
                 (funcall next req))))))))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 737 (face font-lock-comment-face fontified t) 737 754 (face font-lock-comment-face fontified t) 754 2254 (face font-lock-comment-face fontified t) 2254 2318 (face font-lock-comment-face fontified t) 2318 3818 (face font-lock-comment-face fontified t) 3818 3830 (face font-lock-comment-face fontified t) 3830 5330 (face font-lock-comment-face fontified t) 5330 5355 (face font-lock-comment-face fontified t) 5355 5573 (face font-lock-comment-face fontified t) 5573 5575 (face font-lock-comment-delimiter-face fontified t)) . -94483) (undo-tree-id5 . -5575) (undo-tree-id6 . -4522) 100058 (t 26949 36306 0 0)) nil (26961 9456 789066 0) 0 nil])
([nil nil ((#(";;; JWT (HS256)
#|
Les scopes sont des permissions fines, embarquÃ©es dans le JWT.
Un rÃ´le, câ€™est â€œqui je suisâ€ (ex. admin, user).
Un scope, câ€™est â€œce que je peux faireâ€ (ex. read:users, write:payments).
|#
#|
(defun auth-jwt (&key (secret nil secret-supplied-p)
                      (required-p nil)
                      (roles-allow nil)
                      (scopes-allow nil)   ; ex: '(\"payments:write\" \"profile:read\")
                      (scopes-mode :any))  ; :any (OR) ou :all (AND)
  \"Middleware Bearer JWT â†’ pose :jwt dans req-ctx, applique garde optionnelle.
Options:
 - SECRET         : clÃ© HMAC (defaut lumen.core.jwt:*jwt-secret*)
 - REQUIRED-P     : 401 si token manquant/invalide
 - ROLES-ALLOW    : liste de rÃ´les autorisÃ©s (403 sinon)
 - SCOPES-ALLOW   : liste de scopes requis
 - SCOPES-MODE    : :any (OR, dÃ©faut) | :all (AND)\"
  (let ((secret (if secret-supplied-p secret lumen.core.jwt:*jwt-secret*)))
    (lambda (next)
      (lambda (req)
        (let* ((hdrs (lumen.core.http:req-headers req))
               (raw  (cdr (assoc \"authorization\" hdrs :test #'string-equal)))
               (tok  (and raw (>= (length raw) 7)
                          (string= (subseq raw 0 7) \"Bearer \")
                          (subseq raw 7))))
	  (format t \"Raw: ~A~%\" raw)
	  (format t \"Token: ~A~%\" tok)
          ;; dÃ©codage
          (when tok
            (multiple-value-bind (payload ok)
                (lumen.core.jwt:jwt-decode tok :secret secret :verify t)
	      (format t \"Payload: ~A~%OK: ~A~%\" payload ok)
              (when ok (lumen.core.http:ctx-set! req :jwt payload))))
          ;; vÃ©rifs
          (let* ((jwt  (lumen.core.http:ctx-get req :jwt))
                 (role (and jwt (or (cdr (assoc :role jwt))
                                    (cdr (assoc \"role\" jwt)))))
                 (sc   (and jwt (or (cdr (assoc :scopes jwt))
                                    (cdr (assoc \"scopes\" jwt))))))
            (labels ((fail (status msg)
                       (lumen.core.http:respond-json
                        `((:error . ((:type . \"auth\") (:message . ,msg))))
                        :status status))
                     (has-scope? ()
                       (cond
                         ((null scopes-allow) t) ; pas dâ€™exigence
                         ((eq scopes-mode :all)
                          (every (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow))
                         (t ; :any
                          (some  (lambda (x)
				   (member x sc :test #'string=))
				 scopes-allow)))))
              (cond
                ((and required-p (null jwt)) (fail 401 \"missing or invalid token\"))
                ((and roles-allow jwt
                      (not (member role roles-allow :test #'string=)))
		 (fail 403 \"forbidden\"))
                ((and jwt (not (has-scope?))) (fail 403 \"insufficient_scope\"))
                (t (funcall next req))))))))))
|#
" 0 4 (face font-lock-comment-delimiter-face fontified t) 4 16 (face font-lock-comment-face fontified t) 16 18 (face font-lock-comment-delimiter-face fontified t) 18 26 (face font-lock-comment-face fontified t) 26 203 (face font-lock-comment-face fontified t) 203 205 (face font-lock-comment-delimiter-face fontified t) 205 206 (fontified t) 206 208 (face font-lock-comment-delimiter-face fontified t) 208 1526 (face font-lock-comment-face fontified t) 1526 1533 (face font-lock-comment-face fontified t) 1533 1860 (face font-lock-comment-face fontified t) 1860 2933 (face font-lock-comment-face fontified t) 2933 2935 (face font-lock-comment-delimiter-face fontified t) 2935 2936 (fontified t)) . -84310) (undo-tree-id3 . -2936) (undo-tree-id4 . -1806) 87246) nil (26961 9456 789063 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -84309) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 84310) nil (26961 9456 789057 0) 0 nil])
([nil nil ((#("#|
(define-middleware request-context (req next)
  \"Renseigne ctx avec :ip, :ua, (Ã©ventuel :tenant-id dÃ©jÃ  posÃ© en amont)
   et garantit :request-id (+ header X-Request-ID). Idempotent.\"
  (let* ((rid (or (lumen.core.http:ctx-get req :request-id)
                  (%header req \"x-request-id\")
                  (make-request-id)))
         (ip  (%peer-ip req))
         (ua  (%user-agent req)))
    (lumen.core.http:ctx-set! req :request-id rid)
    (lumen.core.http:ctx-set! req :ip         ip)
    (lumen.core.http:ctx-set! req :ua         ua)
    ;; (optionnel) si tenant-from-host ne lâ€™a pas fait, on peut tenter un fallback ici
    ;; mais on considÃ¨re tenant-from-host dÃ©jÃ  en place.
    (let ((resp (funcall next req)))
      ;; Propage X-Request-ID cÃ´tÃ© rÃ©ponse si absent
      (setf (lumen.core.http:resp-headers resp)
            (lumen.utils:ensure-header (lumen.core.http:resp-headers resp)
                                       \"x-request-id\" rid))
      resp)))
|#
" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 24 (face font-lock-comment-face fontified t) 24 49 (face font-lock-comment-face fontified t) 49 149 (face font-lock-comment-face fontified t) 149 187 (face font-lock-comment-face fontified t) 187 978 (face font-lock-comment-face fontified t) 978 980 (face font-lock-comment-delimiter-face fontified t) 980 981 (fontified t)) . -108754) (undo-tree-id0 . -981) 109735) nil (26961 9456 789051 0) 0 nil])
([nil nil ((7832 . 7834) (t 26961 9456 0 0)) nil (26984 7636 449181 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9049 . 9050) (nil fontified nil 7834 . 9050) (7834 . 9050)) nil (26984 7636 449177 0) 0 nil])
([nil nil ((#("
(defun parse-query-string-to-alist (qs)
  \"Transforme \\\"a=1&b=2&b=3\\\" -> ((\\\"a\\\" . \\\"1\\\") (\\\"b\\\" . \\\"2\\\") (\\\"b\\\" . \\\"3\\\")).\"
  (if (or (null qs) (zerop (length qs)))
      nil
      (loop for pair in (uiop:split-string qs :separator \"&\")
            for p = (position #\\= pair)
            for k = (%url-decode (subseq pair 0 (or p (length pair))))
            for v = (%url-decode (if p (subseq pair (1+ p)) \"\"))
            collect (cons k v))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 35 (face font-lock-function-name-face fontified t) 35 43 (fontified t) 43 125 (face font-lock-doc-face fontified t) 125 129 (fontified t) 129 131 (face font-lock-keyword-face fontified t) 131 184 (fontified t) 184 188 (face font-lock-keyword-face fontified t) 188 223 (fontified t) 223 233 (face font-lock-builtin-face fontified t) 233 234 (fontified t) 234 237 (face font-lock-string-face fontified t) 237 384 (fontified t) 384 386 (face font-lock-keyword-face fontified t) 386 410 (fontified t) 410 412 (face font-lock-string-face fontified t) 412 415 (fontified t) 415 448 (fontified t)) . 7384) (undo-tree-id0 . -448) (undo-tree-id1 . -448) (undo-tree-id2 . -1) (undo-tree-id3 . -448) (undo-tree-id4 . -448) (t 26984 7636 0 0)) nil (26984 8168 25029 0) 0 nil])
([nil current ((#("
" 0 1 (fontified t)) . 7384)) nil (26984 8168 25000 0) 0 nil])
nil
