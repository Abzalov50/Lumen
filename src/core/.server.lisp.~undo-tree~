(undo-tree-save-format-version . 1)
"ddb6571103d82ef1d5aa2b7367b4e30523625ad4"
[nil nil nil nil (26790 8105 844431 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 2277 . 2278) (nil fontified nil 1 . 2278) (1 . 2278) (t . -1)) nil (26790 8105 844430 0) 0 nil])
([nil nil ((17 . 19)) nil (26790 8105 844429 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1392 . 1393) (nil fontified nil 19 . 1393) (19 . 1393)) nil (26790 8105 844429 0) 0 nil])
([nil nil ((1339 . 1341) (1393 . 1394)) nil (26790 8105 844428 0) 0 nil])
([nil nil ((50 . 52) (#(" " 0 1 (fontified nil)) . 49) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (50 . 51)) nil (26790 8105 844428 0) 0 nil])
([nil nil ((237 . 238)) nil (26790 8105 844426 0) 0 nil])
([nil nil ((218 . 220) (166 . 168) (75 . 77) 19) nil (26790 8105 844426 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -277) (undo-tree-id39 . -1) (undo-tree-id40 . -1) 278) nil (26790 8105 844425 0) 0 nil])
([nil nil ((413 . 418) (#(" " 0 1 (fontified nil)) . 412) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (413 . 414)) nil (26790 8105 844424 0) 0 nil])
([nil nil ((399 . 401) (#(" " 0 1 (fontified nil)) . 398) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (399 . 400)) nil (26790 8105 844422 0) 0 nil])
([nil nil ((442 . 446) (#(" " 0 1 (fontified nil)) . 441) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (#("			  " 0 1 (fontified nil) 1 5 (fontified nil)) . -419) (419 . 420) (#("	" 0 1 (fontified nil)) . 419) (415 . 419) (443 . 444)) nil (26790 8105 844421 0) 0 nil])
([nil nil ((374 . 375)) nil (26790 8105 844419 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -508) (undo-tree-id31 . -1) (undo-tree-id32 . -1) 509) nil (26790 8105 844418 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -559) (undo-tree-id29 . -1) (undo-tree-id30 . -1) 560) nil (26790 8105 844417 0) 0 nil])
([nil nil ((1223 . 1227) (1184 . 1188) (1136 . 1140) (1084 . 1090) (1060 . 1064) (1011 . 1015) (787 . 791) (758 . 760) (692 . 694) (666 . 668) (634 . 636) (597 . 599) 561) nil (26790 8105 844416 0) 0 nil])
([nil nil ((786 . 791)) nil (26790 8105 844414 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1256)) nil (26790 8105 844414 0) 0 nil])
([nil nil ((832 . 837) (#(" " 0 1 (fontified nil)) . 831) (undo-tree-id28 . -1) (832 . 833)) nil (26790 8105 844413 0) 0 nil])
([nil nil ((844 . 849) (#(" " 0 1 (fontified nil)) . 843) (undo-tree-id27 . -1) (844 . 845)) nil (26790 8105 844412 0) 0 nil])
([nil nil ((862 . 869) (#(" " 0 1 (fontified nil)) . 861) (undo-tree-id26 . -1) (862 . 863)) nil (26790 8105 844411 0) 0 nil])
([nil nil ((880 . 887) (#(" " 0 1 (fontified nil)) . 879) (undo-tree-id25 . -1) (880 . 881)) nil (26790 8105 844409 0) 0 nil])
([nil nil ((903 . 910) (#(" " 0 1 (fontified nil)) . 902) (undo-tree-id24 . -1) (903 . 904)) nil (26790 8105 844408 0) 0 nil])
([nil nil ((929 . 936) (#(" " 0 1 (fontified nil)) . 928) (undo-tree-id23 . -1) (929 . 930)) nil (26790 8105 844405 0) 0 nil])
([nil nil ((956 . 963) (#(" " 0 1 (fontified nil)) . 955) (undo-tree-id22 . -1) (956 . 957)) nil (26790 8105 844404 0) 0 nil])
([nil nil ((984 . 991) (#(" " 0 1 (fontified nil)) . 983) (undo-tree-id21 . -1) (984 . 985)) nil (26790 8105 844403 0) 0 nil])
([nil nil ((1009 . 1016) (#(" " 0 1 (fontified nil)) . 1008) (undo-tree-id20 . -1) (1009 . 1010)) nil (26790 8105 844402 0) 0 nil])
([nil nil ((1034 . 1041) (#(" " 0 1 (fontified nil)) . 1033) (undo-tree-id19 . -1) (1034 . 1035)) nil (26790 8105 844401 0) 0 nil])
([nil nil ((1071 . 1078) (#(" " 0 1 (fontified nil)) . 1070) (undo-tree-id18 . -1) (1071 . 1072)) nil (26790 8105 844400 0) 0 nil])
([nil nil ((1088 . 1093)) nil (26790 8105 844398 0) 0 nil])
([nil nil ((1142 . 1147)) nil (26790 8105 844398 0) 0 nil])
([nil nil ((1223 . 1228)) nil (26790 8105 844398 0) 0 nil])
([nil nil ((1276 . 1281)) nil (26790 8105 844397 0) 0 nil])
([nil nil ((1505 . 1506) (#("  " 0 2 (fontified t)) . 1505) (1443 . 1449) (1428 . 1432) (1385 . 1387) 1351) nil (26790 8105 844397 0) 0 nil])
([nil nil ((1797 . 1798) (1749 . 1750) (1695 . 1696) (1657 . 1658) (1618 . 1619) (1591 . 1593) 1562) nil (26790 8105 844396 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1835)) nil (26790 8105 844395 0) 0 nil])
([nil nil ((3017 . 3021) (2982 . 2986) (2874 . 2877) (2802 . 2810) (2773 . 2781) (2760 . 2766) (2655 . 2658) (2585 . 2593) (2546 . 2552) (2513 . 2516) (2467 . 2475) (2449 . 2453) (2422 . 2430) (2394 . 2402) (2350 . 2358) (2325 . 2333) (2297 . 2305) (2247 . 2255) (2193 . 2195) (2154 . 2156) (2124 . 2126) (2050 . 2052) (1984 . 1991) (1896 . 1903) (1878 . 1880) 1837) nil (26790 8105 844394 0) 0 nil])
([nil nil ((2049 . 2052)) nil (26790 8105 844391 0) 0 nil])
([nil nil ((2126 . 2129)) nil (26790 8105 844391 0) 0 nil])
([nil nil ((2159 . 2162)) nil (26790 8105 844390 0) 0 nil])
([nil nil ((2014 . 2021) (#(" " 0 1 (fontified nil)) . 2013) (undo-tree-id17 . -1) (2014 . 2015)) nil (26790 8105 844390 0) 0 nil])
([nil nil ((2035 . 2042) (#(" " 0 1 (fontified nil)) . 2034) (undo-tree-id16 . -1) (2035 . 2036)) nil (26790 8105 844389 0) 0 nil])
([nil nil ((2568 . 2575)) nil (26790 8105 844388 0) 0 nil])
([nil nil ((2711 . 2716) (#(" " 0 1 (fontified nil)) . 2710) (undo-tree-id15 . -1) (2711 . 2712)) nil (26790 8105 844387 0) 0 nil])
([nil nil ((2757 . 2763) (#(" " 0 1 (fontified nil)) . 2756) (undo-tree-id14 . -1) (2757 . 2758)) nil (26790 8105 844386 0) 0 nil])
([nil nil ((2774 . 2780) (#(" " 0 1 (fontified nil)) . 2773) (undo-tree-id13 . -1) (2774 . 2775)) nil (26790 8105 844385 0) 0 nil])
([nil nil ((2792 . 2798) (#(" " 0 1 (fontified nil)) . 2791) (undo-tree-id12 . -1) (2792 . 2793)) nil (26790 8105 844384 0) 0 nil])
([nil nil ((2953 . 2958) (#(" " 0 1 (fontified nil)) . 2952) (undo-tree-id11 . -1) (2953 . 2954)) nil (26790 8105 844383 0) 0 nil])
([nil nil ((2999 . 3005) (#(" " 0 1 (fontified nil)) . 2998) (undo-tree-id10 . -1) (2999 . 3000)) nil (26790 8105 844382 0) 0 nil])
([nil nil ((3016 . 3022) (#(" " 0 1 (fontified nil)) . 3015) (undo-tree-id9 . -1) (3016 . 3017)) nil (26790 8105 844381 0) 0 nil])
([nil nil ((3034 . 3040) (#(" " 0 1 (fontified nil)) . 3033) (undo-tree-id8 . -1) (3034 . 3035)) nil (26790 8105 844380 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -3125) (undo-tree-id7 . -1) 3126) nil (26790 8105 844379 0) 0 nil])
([nil nil ((3272 . 3278) (3237 . 3243) (3162 . 3166) (3154 . 3156) 3126) nil (26790 8105 844376 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3364)) nil (26790 8105 844375 0) 0 nil])
([nil nil ((3340 . 3348) (#(" " 0 1 (fontified nil)) . 3340) (3339 . 3340)) nil (26790 8105 844374 0) 0 nil])
([nil nil ((3864 . 3866) (3820 . 3822) (3694 . 3696) (3613 . 3615) (3467 . 3469) (3446 . 3448) (3414 . 3416) 3374) nil (26790 8105 844374 0) 0 nil])
([nil nil ((3485 . 3486) (#(" " 0 1 (fontified nil)) . 3484) (undo-tree-id6 . -1) (3485 . 3486)) nil (26790 8105 844372 0) 0 nil])
([nil nil ((3498 . 3503) (#(" " 0 1 (fontified nil)) . 3498) (3497 . 3498)) nil (26790 8105 844370 0) 0 nil])
([nil nil ((3517 . 3524) (#(" " 0 1 (fontified nil)) . 3516) (undo-tree-id5 . -1) (3517 . 3518)) nil (26790 8105 844370 0) 0 nil])
([nil nil ((3547 . 3554) (#(" " 0 1 (fontified nil)) . 3546) (undo-tree-id4 . -1) (3547 . 3548)) nil (26790 8105 844369 0) 0 nil])
([nil nil ((3595 . 3603) (#(" " 0 1 (fontified nil)) . 3594) (undo-tree-id3 . -1) (3595 . 3596)) nil (26790 8105 844368 0) 0 nil])
([nil nil ((3640 . 3643)) nil (26790 8105 844367 0) 0 nil])
([nil nil ((3776 . 3783) (#(" " 0 1 (fontified nil)) . 3775) (undo-tree-id2 . -1) (3776 . 3777)) nil (26790 8105 844366 0) 0 nil])
([nil nil ((3765 . 3769) (#(" " 0 1 (fontified nil)) . 3764) (undo-tree-id1 . -1) (3765 . 3766)) nil (26790 8105 844365 0) 0 nil])
([nil nil ((3817 . 3821) (#(" " 0 1 (fontified nil)) . 3816) (undo-tree-id0 . -1) (#("		  " 0 4 (fontified nil)) . -3786) (3786 . 3787) (#("	" 0 1 (fontified nil)) . 3786) (3783 . 3786) (3818 . 3819)) nil (26790 8105 844363 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3913)) nil (26790 8105 844352 0) 0 nil])
([nil nil ((4141 . 4143) (4109 . 4113) (4069 . 4073) (4045 . 4047) (4013 . 4017) (3954 . 3958) (3930 . 3932) 3915) nil (26790 8105 844351 0) 0 nil])
([nil nil ((4145 . 4146)) nil (26790 8105 844346 0) 0 nil])
([nil nil ((#("
	      (method path http-ver)" 0 30 (fontified t)) . 1983) (undo-tree-id0 . -30) (undo-tree-id1 . -30) (undo-tree-id2 . -30) (undo-tree-id3 . -30) (undo-tree-id4 . -30) (undo-tree-id5 . -30) (t 26790 8105 0 0)) nil (26790 9024 207768 0) 0 nil])
([nil nil ((#("
	 
	 (declare (ignore http-ver))" 0 7 (fontified t) 7 14 (face font-lock-keyword-face fontified t) 14 33 (fontified t)) . 2110) (undo-tree-id6 . -33) (undo-tree-id7 . -15) (undo-tree-id8 . -15) (undo-tree-id9 . -15) (undo-tree-id10 . -15) (undo-tree-id11 . -15) (undo-tree-id12 . -15) (undo-tree-id13 . -15) (undo-tree-id14 . -15) (undo-tree-id15 . -15) (undo-tree-id16 . -15) (undo-tree-id17 . -33) (undo-tree-id18 . -33) (undo-tree-id19 . -33) (undo-tree-id20 . -33) (undo-tree-id21 . -33) (t 26790 9024 0 0)) nil (26790 9100 555329 0) 0 nil])
([nil nil ((#("
    (declare (ignore socket))" 0 6 (fontified t) 6 13 (face font-lock-keyword-face fontified t) 13 30 (fontified t)) . 3029) (undo-tree-id22 . -30) (undo-tree-id23 . -28) (undo-tree-id24 . -28) (undo-tree-id25 . -28) (undo-tree-id26 . -28) (undo-tree-id27 . -28) (undo-tree-id28 . -28) (undo-tree-id29 . -28) (undo-tree-id30 . -28) (undo-tree-id31 . -28) (undo-tree-id32 . -28) (undo-tree-id33 . -30) (undo-tree-id34 . -30) (undo-tree-id35 . -30) (undo-tree-id36 . -30) (undo-tree-id37 . -30) (undo-tree-id38 . -30) (undo-tree-id39 . -30) (undo-tree-id40 . -30) (undo-tree-id41 . -30) (undo-tree-id42 . -30) (undo-tree-id43 . -30) (undo-tree-id44 . -30) (undo-tree-id45 . -30) (undo-tree-id46 . -30) (undo-tree-id47 . -30) (t 26790 9100 0 0)) nil (26790 9136 740278 0) 0 nil])
([nil nil ((#("sequence" 0 8 (fontified t)) . -1293) (undo-tree-id52 . -8) 1301 (t 26790 9136 0 0)) nil (26790 31867 498253 0) 0 nil])
([nil nil ((1293 . 1299)) nil (26790 31867 498252 0) 0 nil])
([nil nil ((#("-bytes" 0 6 (fontified t)) . 1304)) nil (26790 31867 498252 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3498 . 3499) (nil fontified nil 1828 . 3499) (1828 . 3499)) nil (26790 31867 498251 0) 0 nil])
([nil nil ((3499 . 3500)) nil (26790 31867 498250 0) 0 nil])
([nil nil ((#("
(defun handle-connection (socket client)
  (unwind-protect
       (let* ((stream (flexi-streams:make-flexi-stream client :external-format :utf-8))
	      (headers nil)
	      (body-stream stream))
	 
	 (multiple-value-setq (method path http-ver) (read-request-line stream))
	 
	 (setf headers (read-headers stream))
	 (let* ((req (make-instance 'lumen.core.http:request
				    :method (string-upcase (or method \"GET\"))
				    :path (or path \"/\")
				    :headers headers
				    :query nil :cookies nil :params nil
				    :body-stream stream
				    :context (list))))
	   (handler-case
	       (let ((resp (funcall *handler* req)))
		 (write-response stream resp))
	     
	     (lumen.core.error:http-error (e)
	       (multiple-value-bind (st hs body) (funcall *error-handler* e)
		 (write-response stream
				 (make-instance 'lumen.core.http:response
						:status st
						:headers hs
						:body body))))
	     (t (e)
	       (declare (ignore e))
	       (multiple-value-bind (st hs body) (funcall *error-handler* nil)
		 (write-response stream
				 (make-instance 'lumen.core.http:response
						:status st
						:headers hs
						:body body)))))))
    (ignore-errors (close client))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 25 (face font-lock-function-name-face fontified t) 25 45 (fontified t) 45 59 (face font-lock-keyword-face fontified t) 59 60 (fontified t) 60 68 (fontified t) 68 72 (face font-lock-keyword-face fontified t) 72 122 (fontified t) 122 138 (face font-lock-builtin-face fontified t) 138 139 (fontified t) 139 145 (face font-lock-builtin-face fontified t) 145 148 (fontified t) 148 201 (fontified t) 201 274 (fontified t) 274 275 (fontified t) 275 320 (fontified t) 320 324 (face font-lock-keyword-face fontified t) 324 379 (fontified t) 379 386 (face font-lock-builtin-face fontified t) 386 413 (fontified t) 413 418 (face font-lock-string-face fontified t) 418 429 (fontified t) 429 434 (face font-lock-builtin-face fontified t) 434 444 (fontified t) 444 447 (face font-lock-string-face fontified t) 447 457 (fontified t) 457 465 (face font-lock-builtin-face fontified t) 465 482 (fontified t) 482 488 (face font-lock-builtin-face fontified t) 488 493 (fontified t) 493 501 (face font-lock-builtin-face fontified t) 501 506 (fontified t) 506 513 (face font-lock-builtin-face fontified t) 513 526 (fontified t) 526 538 (face font-lock-builtin-face fontified t) 538 554 (fontified t) 554 562 (face font-lock-builtin-face fontified t) 562 578 (fontified t) 578 590 (face font-lock-keyword-face fontified t) 590 600 (fontified t) 600 603 (face font-lock-keyword-face fontified t) 603 725 (fontified t) 725 744 (face font-lock-keyword-face fontified t) 744 864 (fontified t) 864 871 (face font-lock-builtin-face fontified t) 871 881 (fontified t) 881 889 (face font-lock-builtin-face fontified t) 889 899 (fontified t) 899 904 (face font-lock-builtin-face fontified t) 904 936 (fontified t) 936 943 (face font-lock-keyword-face fontified t) 943 965 (fontified t) 965 984 (face font-lock-keyword-face fontified t) 984 985 (fontified t) 985 1028 (fontified t) 1028 1106 (fontified t) 1106 1113 (face font-lock-builtin-face fontified t) 1113 1117 (fontified t) 1117 1123 (fontified t) 1123 1131 (face font-lock-builtin-face fontified t) 1131 1141 (fontified t) 1141 1146 (face font-lock-builtin-face fontified t) 1146 1159 (fontified t) 1159 1164 (fontified t) 1164 1177 (face font-lock-keyword-face fontified t) 1177 1193 (fontified t) 1193 1196 (fontified t)) . -3500) (undo-tree-id48 . -591) (undo-tree-id49 . -1159) (undo-tree-id50 . -1196) (undo-tree-id51 . -148) 4696) nil (26790 31867 498249 0) 0 nil])
([nil nil ((1827 . 1828)) nil (26790 31867 498232 0) 0 nil])
([nil nil ((2187 . 2189) (t 26790 31867 0 0)) nil (26790 31883 634949 0) 0 nil])
([nil nil ((1552 . 1554) (t 26790 31883 0 0)) nil (26790 32370 449669 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1972 . 1973) (nil fontified nil 1554 . 1973) (1554 . 1973)) nil (26790 32370 449669 0) 0 nil])
([nil nil ((#("flexi-streams:make-flexi-stream" 0 31 (fontified t)) . -2386) (undo-tree-id65 . -31) (undo-tree-id66 . -17) (undo-tree-id67 . -18) (undo-tree-id68 . -14) 2417) nil (26790 32370 449668 0) 0 nil])
([nil nil ((2386 . 2393)) nil (26790 32370 449665 0) 0 nil])
([nil nil ((2386 . 2402) (#("make-ht" 0 7 (fontified t)) . -2386) (undo-tree-id64 . -7) 2393) nil (26790 32370 449664 0) 0 nil])
([nil nil ((2402 . 2403)) nil (26790 32370 449663 0) 0 nil])
([nil nil ((2403 . 2407)) nil (26790 32370 449662 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -2405) (undo-tree-id62 . -1) (#("n" 0 1 (fontified t)) . -2406) (undo-tree-id63 . -1) 2407) nil (26790 32370 449661 0) 0 nil])
([nil nil ((2405 . 2409)) nil (26790 32370 449660 0) 0 nil])
([nil nil ((#(" raw :external-format :utf-8)))" 0 5 (fontified t) 5 21 (face font-lock-builtin-face fontified t) 21 22 (fontified t) 22 28 (face font-lock-builtin-face fontified t) 28 31 (fontified t)) . 2409) (undo-tree-id61 . -31)) nil (26790 32370 449659 0) 0 nil])
([nil nil ((2409 . 2411)) nil (26790 32370 449658 0) 0 nil])
([nil nil ((#("(raw    (usocket:socket-stream client))
         " 0 40 (fontified t) 40 49 (fontified t)) . -2328) (undo-tree-id53 . -49) (undo-tree-id54 . -40) (undo-tree-id55 . -40) (undo-tree-id56 . -40) (undo-tree-id57 . -40) (undo-tree-id58 . -40) (undo-tree-id59 . -49) (undo-tree-id60 . -49) 2377) nil (26790 32370 449656 0) 0 nil])
([nil nil ((2362 . 2363)) nil (26790 32370 449635 0) 0 nil])
([nil nil ((1973 . 1975) (t 26790 32370 0 0)) nil (26790 32690 617678 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2221 . 2222) (nil fontified nil 1975 . 2222) (1975 . 2222)) nil (26790 32690 617678 0) 0 nil])
([nil nil ((#("(defun make-http-stream (client)
  \"Return a FLEXI stream over a *binary* socket stream.\"
  (let* ((raw  (usocket:socket-make-stream client
                 :input t :output t
                 :element-type '(unsigned-byte 8)  ; <-- BINARY
                 :buffering :full))
         (xfmt (flexi-streams:make-external-format :utf-8 :eol-style :crlf)))
    (flexi-streams:make-flexi-stream raw :external-format xfmt)))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 23 (face font-lock-function-name-face fontified t) 23 35 (fontified t) 35 89 (face font-lock-doc-face fontified t) 89 93 (fontified t) 93 97 (face font-lock-keyword-face fontified t) 97 157 (fontified t) 157 163 (face font-lock-builtin-face fontified t) 163 166 (fontified t) 166 173 (face font-lock-builtin-face fontified t) 173 193 (fontified t) 193 206 (face font-lock-builtin-face fontified t) 206 227 (fontified t) 227 240 (face font-lock-comment-face fontified t) 240 257 (fontified t) 257 267 (face font-lock-builtin-face fontified t) 267 268 (fontified t) 268 273 (face font-lock-builtin-face fontified t) 273 327 (fontified t) 327 333 (face font-lock-builtin-face fontified t) 333 334 (fontified t) 334 344 (face font-lock-builtin-face fontified t) 344 345 (fontified t) 345 350 (face font-lock-builtin-face fontified t) 350 354 (fontified t) 354 395 (fontified t) 395 411 (face font-lock-builtin-face fontified t) 411 418 (fontified t) 418 419 (rear-nonsticky t fontified t) 419 420 (fontified t)) . 1554) (undo-tree-id96 . -420) (undo-tree-id97 . -419) (undo-tree-id98 . -420) (undo-tree-id99 . -420)) nil (26790 32690 617677 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1553) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) 1554) nil (26790 32690 617674 0) 0 nil])
([nil nil ((3914 . 3916)) nil (26790 32690 617670 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4149 . 4150) (nil fontified nil 3916 . 4150) (3916 . 4150)) nil (26790 32690 617669 0) 0 nil])
([nil nil ((#("
(defun accept-loop (socket)
  (loop
    (multiple-value-bind (client addr port) (usocket:socket-accept socket)
      (declare (ignore addr port))
      (bt:make-thread (lambda () (handle-connection socket client))
	" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 19 (face font-lock-function-name-face fontified t) 19 25 (fontified t) 25 29 (fontified t) 29 32 (fontified t) 32 36 (face font-lock-keyword-face fontified t) 36 42 (fontified t) 42 61 (face font-lock-keyword-face fontified t) 61 119 (fontified t) 119 126 (face font-lock-keyword-face fontified t) 126 170 (fontified t) 170 176 (face font-lock-keyword-face fontified t) 176 214 (fontified t) 214 215 (fontified t) 215 216 (fontified t)) . 3667) (undo-tree-id83 . -216) (undo-tree-id84 . -1) (undo-tree-id85 . -215) (undo-tree-id86 . -216) (undo-tree-id87 . -216) (undo-tree-id88 . -216) (undo-tree-id89 . -216)) nil (26790 32690 617739 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -3695) (undo-tree-id108 . -1) (#(")" 0 1 (fontified t)) . -3696) (undo-tree-id109 . -1) (#(")" 0 1 (fontified t)) . -3697) (undo-tree-id110 . -1) 3698 (t 26790 32691 0 0)) nil (26790 32757 368485 0) 0 nil] [nil nil ((#("
" 0 1 (fontified t)) . -3666) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) 3667) ((3666 . 3667)) (26790 32690 617657 0) 0 nil])
([nil nil ((3695 . 3696)) nil (26790 32757 368482 0) 0 nil])
nil
([nil nil ((#("=" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -3695) (undo-tree-id107 . -1) 3696) nil (26790 32757 368481 0) 0 nil])
([nil nil ((3695 . 3697)) nil (26790 32757 368479 0) 0 nil])
([nil nil ((#("
	      :name \"lumen-client\")))" 0 1 (fontified t) 1 8 (fontified t) 8 13 (face font-lock-builtin-face fontified t) 13 14 (fontified t) 14 28 (face font-lock-string-face fontified t) 28 31 (fontified t)) . 3666) (undo-tree-id100 . -31) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -31) (undo-tree-id104 . -31) (undo-tree-id105 . -31) (undo-tree-id106 . -31)) nil (26790 32757 368476 0) 0 nil])
([nil nil ((4252 . 4265) (t 26790 32757 0 0)) nil (26790 33453 765742 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4296 . 4297) (nil fontified nil 4265 . 4297) (4265 . 4297)) nil (26790 33453 765742 0) 0 nil])
([nil nil ((1552 . 1554)) nil (26790 33453 765741 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2157 . 2158) (nil fontified nil 1554 . 2158) (1554 . 2158)) nil (26790 33453 765741 0) 0 nil])
([nil nil ((2407 . 2409)) nil (26790 33453 765740 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2733 . 2734) (nil fontified nil 2409 . 2734) (2409 . 2734)) nil (26790 33453 765739 0) 0 nil])
([nil nil ((2971 . 2972)) nil (26790 33453 765736 0) 0 nil])
([nil nil ((#("q" 0 1 (fontified t)) . -2971) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) 2972 (t 26790 33453 0 0)) nil (26790 33727 837624 0) 0 nil])
([nil nil ((3009 . 3011) (t 26790 33727 0 0)) nil (26790 33968 908255 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4586 . 4587) (nil fontified nil 3011 . 4587) (3011 . 4587)) nil (26790 33968 908254 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -4586) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) 4587) nil (26790 33968 908253 0) 0 nil])
([nil nil ((3009 . 3011)) nil (26790 33968 908242 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3350 . 3351) (nil fontified nil 3011 . 3351) (3011 . 3351)) nil (26790 33968 908239 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -3350) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) 3351 (t 26790 33968 0 0)) nil (26790 33970 91858 0) 0 nil])
([nil nil ((4969 . 4972) (t 26790 33970 0 0)) nil (26790 34276 137160 0) 0 nil])
([nil nil ((4972 . 4978)) nil (26790 34276 137159 0) 0 nil])
([nil nil ((4978 . 4979)) nil (26790 34276 137159 0) 0 nil])
([nil nil ((4979 . 4985)) nil (26790 34276 137158 0) 0 nil])
([nil nil ((4985 . 4986)) nil (26790 34276 137157 0) 0 nil])
([nil nil ((4986 . 4993)) nil (26790 34276 137153 0) 0 nil])
([nil nil ((4985 . 4986) (t 26790 34276 0 0)) nil (26790 34290 39530 0) 0 nil])
([nil nil ((4988 . 4989) (4986 . 4987)) nil (26790 34290 39530 0) 0 nil])
([nil nil ((4989 . 4995)) nil (26790 34290 39529 0) 0 nil])
([nil nil ((4995 . 4996)) nil (26790 34290 39528 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4995) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) 4996) nil (26790 34290 39527 0) 0 nil])
([nil nil ((4995 . 4996)) nil (26790 34290 39511 0) 0 nil])
([nil nil ((#("(print socket)
  (print client)" 0 15 (fontified t) 15 31 (fontified t)) . 4972) (undo-tree-id140 . -24) (undo-tree-id141 . -31) (undo-tree-id142 . -13) (undo-tree-id143 . -23) (undo-tree-id144 . -23) (undo-tree-id145 . -23) (undo-tree-id146 . -23) (undo-tree-id147 . -23) (undo-tree-id148 . -23) (undo-tree-id149 . -15) (undo-tree-id150 . -24) (undo-tree-id151 . -24) (undo-tree-id152 . -31) (undo-tree-id153 . -31) (undo-tree-id154 . -31) (undo-tree-id155 . -31) (undo-tree-id156 . -31) (undo-tree-id157 . -31) (undo-tree-id158 . -17) (undo-tree-id159 . -17) (undo-tree-id160 . -17) (undo-tree-id161 . -17) (undo-tree-id162 . -17) (undo-tree-id163 . -15) (undo-tree-id164 . -31) (undo-tree-id165 . -31) (undo-tree-id166 . -31) 5003 (t 26790 34290 0 0)) nil (26790 34304 215865 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4969) (undo-tree-id139 . -1)) nil (26790 34304 215848 0) 0 nil])
([nil nil ((4999 . 5002)) nil (26790 34304 215840 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5032 . 5033) (nil fontified nil 5017 . 5033) (nil fontified nil 5002 . 5017) (5002 . 5033)) nil (26790 34304 215836 0) 0 nil])
([nil nil ((5315 . 5320) (t 26790 34304 0 0)) nil (26790 34390 888372 0) 0 nil])
([nil nil ((5320 . 5324)) nil (26790 34390 888371 0) 0 nil])
([nil nil ((#("n" 0 1 (fontified t)) . -5323) (undo-tree-id207 . -1) 5324) nil (26790 34390 888371 0) 0 nil])
([nil nil ((5323 . 5326)) nil (26790 34390 888370 0) 0 nil])
([nil nil ((5326 . 5327)) nil (26790 34390 888369 0) 0 nil])
([nil nil ((5327 . 5335)) nil (26790 34390 888369 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -5331) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) (undo-tree-id172 . -1) (undo-tree-id173 . -1) (undo-tree-id174 . -1) (undo-tree-id175 . -1) (undo-tree-id176 . -1) (undo-tree-id177 . -1) (undo-tree-id178 . -1) (undo-tree-id179 . -1) (undo-tree-id180 . -1) (undo-tree-id181 . -1) (undo-tree-id182 . -1) (#("r" 0 1 (fontified t)) . -5332) (undo-tree-id183 . -1) (undo-tree-id184 . -1) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (#("s" 0 1 (fontified t)) . -5333) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (#(")" 0 1 (fontified t)) . -5334) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) 5335) nil (26790 34390 888366 0) 0 nil])
([nil nil ((5331 . 5335)) nil (26790 34390 888331 0) 0 nil])
([nil nil ((#("
  (print socket)
  (print client)" 0 1 (fontified t) 1 3 (fontified t) 3 18 (fontified t) 18 33 (fontified t) 33 34 (rear-nonsticky t fontified t)) . 4999) (undo-tree-id208 . -34) (t 26790 34390 0 0)) nil (26791 1059 197304 0) 0 nil])
([nil nil ((596 . 599)) nil (26791 1059 197347 0) 0 nil])
([nil nil ((599 . 605)) nil (26791 1195 703245 0) 0 nil] [nil nil ((nil rear-nonsticky nil 613 . 614) (nil fontified nil 599 . 614) (599 . 614)) ((#("*error-handler*" 0 14 (fontified nil) 14 15 (rear-nonsticky nil fontified nil)) . 599) (undo-tree-id209 . -15) (nil rear-nonsticky t 613 . 614)) (26791 1059 197290 0) 0 nil])
([nil nil ((605 . 606)) nil (26791 1195 703245 0) 0 nil])
nil
([nil nil ((606 . 607)) nil (26791 1195 703244 0) 0 nil])
([nil nil ((607 . 609)) nil (26791 1195 703244 0) 0 nil])
([nil nil ((609 . 610)) nil (26791 1195 703244 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 623 . 624) (nil fontified nil 610 . 624) (610 . 624)) nil (26791 1195 703243 0) 0 nil])
([nil nil ((624 . 626)) nil (26791 1195 703243 0) 0 nil])
([nil nil ((610 . 615) (#("write" 0 5 (face font-lock-string-face fontified t)) . 610)) nil (26791 1195 703242 0) 0 nil])
([nil nil ((615 . 624) (#("-response" 0 8 (face font-lock-string-face fontified t) 8 9 (face font-lock-string-face rear-nonsticky t fontified t)) . 615)) nil (26791 1195 703242 0) 0 nil])
([nil nil ((5796 . 5800)) nil (26791 1195 703241 0) 0 nil])
([nil nil ((5800 . 5802)) nil (26791 1195 703241 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -5801) (undo-tree-id210 . -1) 5802) nil (26791 1195 703240 0) 0 nil])
([nil nil ((5801 . 5806)) nil (26791 1195 703232 0) 0 nil])
([nil nil ((5806 . 5807)) nil (26791 1195 703232 0) 0 nil])
([nil nil ((5807 . 5817)) nil (26791 1195 703232 0) 0 nil])
([nil nil ((5817 . 5826)) nil (26791 1195 703231 0) 0 nil])
([nil nil ((#("(print *handler*)" 0 17 (fontified t)) . 5800)) nil (26791 1195 703231 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 5796) (#("	" 0 1 (fontified t)) . 5796) (#("	" 0 1 (fontified t)) . 5796) (#("
" 0 1 (fontified t)) . 5796)) nil (26791 1195 703230 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 5796)) nil (26791 1195 703229 0) 0 nil])
([nil nil ((5822 . 5828)) nil (26791 1195 703229 0) 0 nil])
([nil nil ((5828 . 5834)) nil (26791 1195 703228 0) 0 nil])
([nil nil ((5828 . 5834)) nil (26791 1195 703228 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5850 . 5851) (nil fontified nil 5834 . 5851) (5834 . 5851)) nil (26791 1195 703227 0) 0 nil])
([nil nil ((5904 . 5910)) nil (26791 1195 703227 0) 0 nil])
([nil nil ((5910 . 5911)) nil (26791 1195 703227 0) 0 nil])
([nil nil ((5851 . 5857)) nil (26791 1195 703226 0) 0 nil])
([nil nil ((5857 . 5863)) nil (26791 1195 703226 0) 0 nil])
([nil nil ((5863 . 5864)) nil (26791 1195 703225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5886 . 5887) (nil fontified nil 5864 . 5887) (5864 . 5887)) nil (26791 1195 703225 0) 0 nil])
([nil nil ((5887 . 5888)) nil (26791 1195 703224 0) 0 nil])
([nil nil ((5851 . 5857)) nil (26791 1195 703224 0) 0 nil])
([nil nil ((5857 . 5863)) nil (26791 1195 703224 0) 0 nil])
([nil nil ((5863 . 5864)) nil (26791 1195 703223 0) 0 nil])
([nil nil ((5864 . 5869)) nil (26791 1195 703223 0) 0 nil])
([nil nil ((5906 . 5912)) nil (26791 1195 703222 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5923 . 5924) (nil fontified nil 5923 . 5924) (nil fontified nil 5919 . 5923) (nil fontified nil 5912 . 5919) (5912 . 5924)) nil (26791 1195 703222 0) 0 nil])
([nil nil ((5922 . 5923)) nil (26791 1195 703220 0) 0 nil])
([nil nil ((5923 . 5924)) nil (26791 1195 703216 0) 0 nil])
([nil nil ((816 . 821) (t 26791 1195 0 0)) nil (26791 1261 404978 0) 0 nil])
([nil nil ((821 . 827)) nil (26791 1261 404978 0) 0 nil])
([nil nil ((827 . 828)) nil (26791 1261 404977 0) 0 nil])
([nil nil ((828 . 836)) nil (26791 1261 404977 0) 0 nil])
([nil nil ((836 . 841)) nil (26791 1261 404977 0) 0 nil])
([nil nil ((841 . 845)) nil (26791 1261 404976 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -844) (undo-tree-id212 . -1) 845) nil (26791 1261 404975 0) 0 nil])
([nil nil ((844 . 847)) nil (26791 1261 404974 0) 0 nil])
([nil nil ((847 . 848)) nil (26791 1261 404973 0) 0 nil])
([nil nil ((848 . 853)) nil (26791 1261 404973 0) 0 nil])
([nil nil ((#("Ã " 0 1 (fontified t)) . -852) (undo-tree-id211 . -1) 853) nil (26791 1261 404972 0) 0 nil])
([nil nil ((852 . 853)) nil (26791 1261 404963 0) 0 nil])
([nil nil ((853 . 858)) nil (26791 1261 404963 0) 0 nil])
([nil nil ((858 . 864)) nil (26791 1261 404963 0) 0 nil])
([nil nil ((864 . 865)) nil (26791 1261 404962 0) 0 nil])
([nil nil ((865 . 867)) nil (26791 1261 404961 0) 0 nil])
([nil nil ((867 . 872)) nil (26791 1261 404958 0) 0 nil])
([nil nil ((6090 . 6094) (t 26791 1261 0 0)) nil (26791 5747 185855 0) 0 nil])
([nil nil ((6094 . 6100)) nil (26791 5747 185854 0) 0 nil])
([nil nil ((6100 . 6101)) nil (26791 5747 185854 0) 0 nil])
([nil nil ((6101 . 6106) (#(" " 0 1 (fontified nil)) . 6100) (undo-tree-id222 . -1) (6101 . 6102)) nil (26791 5747 185853 0) 0 nil])
([nil nil ((6106 . 6112)) nil (26791 5747 185852 0) 0 nil])
([nil nil ((6112 . 6113)) nil (26791 5747 185852 0) 0 nil])
([nil nil ((6113 . 6121)) nil (26791 5747 185852 0) 0 nil])
([nil nil ((6121 . 6122)) nil (26791 5747 185851 0) 0 nil])
([nil nil ((6122 . 6123)) nil (26791 5747 185851 0) 0 nil])
([nil nil ((#("O" 0 1 (face font-lock-string-face fontified t)) . -6116) (undo-tree-id215 . -1) (#("O" 0 1 (face font-lock-string-face fontified t)) . -6117) (undo-tree-id216 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -6118) (undo-tree-id217 . -1) (#("U" 0 1 (face font-lock-string-face fontified t)) . -6119) (undo-tree-id218 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -6120) (undo-tree-id219 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -6121) (undo-tree-id220 . -1) (#("1" 0 1 (face font-lock-string-face fontified t)) . -6122) (undo-tree-id221 . -1) 6123) nil (26791 5747 185850 0) 0 nil])
([nil nil ((6116 . 6120)) nil (26791 5747 185845 0) 0 nil])
([nil nil ((6120 . 6121)) nil (26791 5747 185844 0) 0 nil])
([nil nil ((6121 . 6124)) nil (26791 5747 185844 0) 0 nil])
([nil nil ((6381 . 6382)) nil (26791 5747 185844 0) 0 nil])
([nil nil ((6404 . 6408)) nil (26791 5747 185843 0) 0 nil])
([nil nil ((6408 . 6414)) nil (26791 5747 185843 0) 0 nil])
([nil nil ((6414 . 6415)) nil (26791 5747 185842 0) 0 nil])
([nil nil ((6415 . 6420) (#(" " 0 1 (fontified nil)) . 6414) (undo-tree-id214 . -1) (6415 . 6416)) nil (26791 5747 185842 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6437 . 6438) (nil fontified nil 6437 . 6438) (nil fontified nil 6427 . 6437) (nil fontified nil 6420 . 6427) (6420 . 6438)) nil (26791 5747 185839 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -6435) (undo-tree-id213 . -1) 6436) nil (26791 5747 185838 0) 0 nil])
([nil nil ((6435 . 6436)) nil (26791 5747 185828 0) 0 nil])
([nil nil ((6700 . 6701)) nil (26791 5747 185823 0) 0 nil])
([nil nil ((6820 . 6822) (t 26791 5747 0 0)) nil (26791 6938 602161 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8585 . 8586) (nil fontified nil 6822 . 8586) (6822 . 8586)) nil (26791 6938 602160 0) 0 nil])
([nil nil ((#("
(defun handle-connection (socket client)  
  (declare (ignore socket))
  (let* ((stream (make-http-stream client)))
    (unwind-protect
         (let (method path http-ver headers)
           (multiple-value-setq (method path http-ver) (read-request-line stream))
           ;;(declare (ignore http-ver))
           (setf headers (read-headers stream))
	   (print headers)
           (let ((req (make-instance 'lumen.core.http:request
                                     :method (string-upcase (or method \"GET\"))
                                     :path (or path \"/\")
                                     :headers headers
                                     :query nil :cookies nil :params nil
                                     :body-stream stream
                                     :context (list))))
             (handler-case	       
                 (progn
		   (print *handler*)
		   (print \"OK\")
		   (print (funcall *handler* req))
		   (print \"OK 1\")
		   (write-response stream (funcall *handler* req))
		   )
               (lumen.core.error:http-error (e)
		 (progn
		   (print \"ERREUR 1\")
                 (multiple-value-bind (st hs body) (funcall *error-handler* e)
                   (write-response stream (make-instance 'lumen.core.http:response
                                                         :status st :headers hs :body body)))))
               (t (_)
		 (progn
		   (print \"ERREUR 2\")
                 (multiple-value-bind (st hs body) (funcall *error-handler* nil)
                   (write-response stream (make-instance 'lumen.core.http:response
                                                         :status st :headers hs :body body))))))))
      ;; fermer proprement
      (ignore-errors (close stream))
      (ignore-errors (usocket:socket-close client)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 25 (face font-lock-function-name-face fontified t) 25 41 (fontified t) 41 43 (fontified t) 43 44 (fontified t) 44 47 (fontified t) 47 54 (face font-lock-keyword-face fontified t) 54 71 (fontified t) 71 72 (fontified t) 72 75 (fontified t) 75 79 (face font-lock-keyword-face fontified t) 79 81 (fontified t) 81 90 (fontified t) 90 116 (fontified t) 116 117 (fontified t) 117 122 (fontified t) 122 136 (face font-lock-keyword-face fontified t) 136 147 (fontified t) 147 150 (face font-lock-keyword-face fontified t) 150 242 (fontified t) 242 265 (fontified t) 265 276 (fontified t) 276 278 (face font-lock-comment-delimiter-face fontified t) 278 279 (face font-lock-comment-face fontified t) 279 286 (face font-lock-comment-face fontified t) 286 306 (face font-lock-comment-face fontified t) 306 354 (fontified t) 354 374 (fontified t) 374 386 (fontified t) 386 389 (face font-lock-keyword-face fontified t) 389 434 (fontified t) 434 436 (fontified t) 436 473 (fontified t) 473 480 (face font-lock-builtin-face fontified t) 480 507 (fontified t) 507 512 (face font-lock-string-face fontified t) 512 552 (fontified t) 552 557 (face font-lock-builtin-face fontified t) 557 567 (fontified t) 567 570 (face font-lock-string-face fontified t) 570 609 (fontified t) 609 617 (face font-lock-builtin-face fontified t) 617 663 (fontified t) 663 669 (face font-lock-builtin-face fontified t) 669 674 (fontified t) 674 682 (face font-lock-builtin-face fontified t) 682 687 (fontified t) 687 694 (face font-lock-builtin-face fontified t) 694 736 (fontified t) 736 748 (face font-lock-builtin-face fontified t) 748 793 (fontified t) 793 801 (face font-lock-builtin-face fontified t) 801 812 (fontified t) 812 826 (fontified t) 826 838 (face font-lock-keyword-face fontified t) 838 846 (fontified t) 846 847 (fontified t) 847 865 (fontified t) 865 870 (face font-lock-keyword-face fontified t) 870 871 (fontified t) 871 876 (fontified t) 876 892 (fontified t) 892 893 (fontified t rear-nonsticky t) 893 894 (fontified t) 894 906 (fontified t) 906 910 (face font-lock-string-face fontified t) 910 911 (fontified t) 911 912 (fontified t) 912 924 (fontified t) 924 946 (fontified t) 946 947 (fontified t rear-nonsticky t) 947 949 (fontified t) 949 954 (fontified t) 954 961 (fontified t) 961 967 (face font-lock-string-face fontified t) 967 968 (fontified t rear-nonsticky t) 968 969 (fontified t) 969 974 (fontified t) 974 1022 (fontified t) 1022 1029 (fontified t) 1029 1077 (fontified t) 1077 1081 (fontified t) 1081 1086 (face font-lock-keyword-face fontified t) 1086 1087 (fontified t) 1087 1099 (fontified t) 1099 1109 (face font-lock-string-face fontified t) 1109 1110 (fontified t) 1110 1111 (fontified t) 1111 1129 (fontified t) 1129 1148 (face font-lock-keyword-face fontified t) 1148 1157 (fontified t) 1157 1158 (fontified t) 1158 1190 (fontified t) 1190 1273 (fontified t) 1273 1321 (fontified t) 1321 1330 (fontified t) 1330 1337 (face font-lock-builtin-face fontified t) 1337 1339 (fontified t) 1339 1341 (fontified t) 1341 1349 (face font-lock-builtin-face fontified t) 1349 1353 (fontified t) 1353 1358 (face font-lock-builtin-face fontified t) 1358 1369 (fontified t) 1369 1391 (fontified t) 1391 1395 (fontified t) 1395 1400 (face font-lock-keyword-face fontified t) 1400 1401 (fontified t) 1401 1406 (fontified t) 1406 1413 (fontified t) 1413 1423 (face font-lock-string-face fontified t) 1423 1424 (rear-nonsticky t fontified t) 1424 1425 (fontified t) 1425 1441 (fontified t) 1441 1443 (fontified t) 1443 1462 (face font-lock-keyword-face fontified t) 1462 1506 (fontified t) 1506 1589 (fontified t) 1589 1634 (fontified t) 1634 1646 (fontified t) 1646 1653 (face font-lock-builtin-face fontified t) 1653 1657 (fontified t) 1657 1663 (face font-lock-builtin-face fontified t) 1663 1665 (face font-lock-builtin-face fontified t) 1665 1669 (fontified t) 1669 1674 (face font-lock-builtin-face fontified t) 1674 1688 (fontified t) 1688 1694 (fontified t) 1694 1697 (face font-lock-comment-delimiter-face fontified t) 1697 1715 (face font-lock-comment-face fontified t) 1715 1716 (fontified t) 1716 1717 (fontified t) 1717 1722 (fontified t) 1722 1735 (face font-lock-keyword-face fontified t) 1735 1752 (fontified t) 1752 1759 (fontified t) 1759 1767 (face font-lock-keyword-face fontified t) 1767 1772 (face font-lock-keyword-face fontified t) 1772 1787 (fontified t) 1787 1805 (fontified t) 1805 1806 (fontified t rear-nonsticky t)) . 5014) (undo-tree-id223 . -1806) (undo-tree-id224 . -44) (undo-tree-id225 . -968) (undo-tree-id226 . -968)) nil (26791 6938 602159 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 5014)) nil (26791 6938 602144 0) 0 nil])
([nil nil ((1427 . 1429) (t 26791 6938 0 0)) nil (26791 8637 198852 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2360 . 2361) (nil fontified nil 1429 . 2361) (1429 . 2361)) nil (26791 8637 198851 0) 0 nil])
([nil nil ((#("
(defun write-response (stream resp)
  (print \"IN WRITE-RESPONSE\")
  (let* ((status (resp-status resp))
	 (headers (resp-headers resp))
	 (body (resp-body resp))
	 (body-bytes (trivial-utf-8:string-to-utf-8-bytes (or body \"\")))
	 (len (length body-bytes)))
    (print headers)
    (print body)
    (print status)
    
    (format stream \"HTTP/1.1 ~A ~A\\r\\n\"
	    status
	    (case status
	      (200 \"OK\")
	      (201 \"Created\")
	      (204 \"No Content\")
	      (400 \"Bad Request\")
	      (401 \"Unauthorized\")
	      (403 \"Forbidden\")
	      (404 \"Not Found\")
	      (500 \"Internal Server Error\")
	      (t \"OK\")))
    
    (format stream \"Content-Length: ~D\\r\\n\" len)
    
    (dolist (h headers)
      (format stream \"~A: ~A\\r\\n\" (car h) (cdr h)))
    
    (format stream \"Connection: close\\r\\n\\r\\n\")
    
    (write-string body stream)
    (finish-output stream)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 37 (fontified t) 37 46 (fontified t) 46 50 (face font-lock-string-face fontified t) 50 63 (face font-lock-string-face fontified t) 63 64 (face font-lock-string-face rear-nonsticky t fontified t) 64 65 (face font-lock-string-face fontified t) 65 66 (fontified t) 66 67 (fontified t) 67 70 (fontified t) 70 74 (face font-lock-keyword-face fontified t) 74 222 (fontified t) 222 223 (face font-lock-string-face fontified t) 223 224 (face font-lock-string-face fontified t) 224 228 (fontified t) 228 257 (fontified t) 257 277 (fontified t) 277 294 (fontified t) 294 313 (fontified t) 313 337 (fontified t) 337 338 (face font-lock-string-face fontified t) 338 356 (face font-lock-string-face fontified t) 356 357 (face font-lock-string-face fontified t) 357 376 (fontified t) 376 380 (face font-lock-keyword-face fontified t) 380 400 (fontified t) 400 401 (face font-lock-string-face fontified t) 401 403 (face font-lock-string-face fontified t) 403 404 (face font-lock-string-face fontified t) 404 418 (fontified t) 418 419 (face font-lock-string-face fontified t) 419 426 (face font-lock-string-face fontified t) 426 427 (face font-lock-string-face fontified t) 427 441 (fontified t) 441 442 (face font-lock-string-face fontified t) 442 452 (face font-lock-string-face fontified t) 452 453 (face font-lock-string-face fontified t) 453 467 (fontified t) 467 468 (face font-lock-string-face fontified t) 468 479 (face font-lock-string-face fontified t) 479 480 (face font-lock-string-face fontified t) 480 494 (fontified t) 494 495 (face font-lock-string-face fontified t) 495 507 (face font-lock-string-face fontified t) 507 508 (face font-lock-string-face fontified t) 508 522 (fontified t) 522 523 (face font-lock-string-face fontified t) 523 532 (face font-lock-string-face fontified t) 532 533 (face font-lock-string-face fontified t) 533 547 (fontified t) 547 548 (face font-lock-string-face fontified t) 548 557 (face font-lock-string-face fontified t) 557 558 (face font-lock-string-face fontified t) 558 572 (fontified t) 572 573 (face font-lock-string-face fontified t) 573 594 (face font-lock-string-face fontified t) 594 595 (face font-lock-string-face fontified t) 595 607 (fontified t) 607 608 (face font-lock-string-face fontified t) 608 610 (face font-lock-string-face fontified t) 610 611 (face font-lock-string-face fontified t) 611 639 (fontified t) 639 640 (face font-lock-string-face fontified t) 640 662 (face font-lock-string-face fontified t) 662 663 (face font-lock-string-face fontified t) 663 679 (fontified t) 679 685 (face font-lock-keyword-face fontified t) 685 719 (fontified t) 719 720 (face font-lock-string-face fontified t) 720 730 (face font-lock-string-face fontified t) 730 731 (face font-lock-string-face fontified t) 731 774 (fontified t) 774 775 (face font-lock-string-face fontified t) 775 800 (face font-lock-string-face fontified t) 800 801 (face font-lock-string-face fontified t) 801 808 (fontified t) 808 839 (fontified t) 839 867 (fontified t)) . 560) (undo-tree-id227 . -867) (undo-tree-id228 . -1)) nil (26791 8637 198850 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 560)) nil (26791 8637 198840 0) 0 nil])
([nil nil ((6750 . 6751)) nil (26791 8637 198839 0) 0 nil])
([nil nil ((6751 . 6757)) nil (26791 8637 198839 0) 0 nil])
([nil nil ((6804 . 6806)) nil (26791 8637 198838 0) 0 nil])
([nil nil ((6851 . 6858)) nil (26791 8637 198834 0) 0 nil])
([nil nil ((1493 . 1495) (t 26791 8637 0 0)) nil (26791 9250 542160 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2737 . 2738) (nil fontified nil 1495 . 2738) (1495 . 2738)) nil (26791 9250 542160 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -2737) (undo-tree-id248 . -1) 2738) nil (26791 9250 542159 0) 0 nil])
([nil nil ((#("
(defun write-response (stream resp &optional (method \"GET\"))
  (let* ((status  (resp-status resp))
         (headers (resp-headers resp))
         (body    (or (resp-body resp) \"\"))
         (bytes   (trivial-utf-8:string-to-utf-8-bytes body))
         (len     (length bytes)))
    (format stream \"HTTP/1.1 ~A ~A\\r\\n\" status
            (case status
              (200 \"OK\") (201 \"Created\") (204 \"No Content\")
              (400 \"Bad Request\") (401 \"Unauthorized\") (403 \"Forbidden\")
              (404 \"Not Found\") (500 \"Internal Server Error\") (t \"OK\")))
    (format stream \"Content-Length: ~D\\r\\n\" len)
    (format stream \"Connection: close\\r\\n\")
    (format stream \"Date: ~A\\r\\n\" (local-time:format-timestring nil (local-time:now)))
    (dolist (h headers) (format stream \"~A: ~A\\r\\n\" (car h) (cdr h)))
    (format stream \"\\r\\n\")
    (unless (string= method \"HEAD\")
      (write-string body stream))
    (finish-output stream)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 36 (fontified t) 36 45 (face font-lock-type-face fontified t) 45 54 (fontified t) 54 59 (face font-lock-string-face fontified t) 59 65 (fontified t) 65 69 (face font-lock-keyword-face fontified t) 69 178 (fontified t) 178 180 (face font-lock-string-face fontified t) 180 299 (fontified t) 299 319 (face font-lock-string-face fontified t) 319 340 (fontified t) 340 344 (face font-lock-keyword-face fontified t) 344 371 (fontified t) 371 375 (face font-lock-string-face fontified t) 375 382 (fontified t) 382 391 (face font-lock-string-face fontified t) 391 398 (fontified t) 398 410 (face font-lock-string-face fontified t) 410 431 (fontified t) 431 444 (face font-lock-string-face fontified t) 444 451 (fontified t) 451 465 (face font-lock-string-face fontified t) 465 472 (fontified t) 472 483 (face font-lock-string-face fontified t) 483 504 (fontified t) 504 515 (face font-lock-string-face fontified t) 515 522 (fontified t) 522 545 (face font-lock-string-face fontified t) 545 550 (fontified t) 550 554 (face font-lock-string-face fontified t) 554 577 (fontified t) 577 601 (face font-lock-string-face fontified t) 601 626 (fontified t) 626 649 (face font-lock-string-face fontified t) 649 670 (fontified t) 670 684 (face font-lock-string-face fontified t) 684 743 (fontified t) 743 749 (face font-lock-keyword-face fontified t) 749 777 (fontified t) 777 789 (face font-lock-string-face fontified t) 789 827 (fontified t) 827 833 (face font-lock-string-face fontified t) 833 840 (fontified t) 840 846 (face font-lock-keyword-face fontified t) 846 863 (fontified t) 863 869 (face font-lock-string-face fontified t) 869 905 (fontified t) 905 932 (fontified t) 932 933 (fontified t rear-nonsticky t)) . 560) (undo-tree-id243 . -933) (undo-tree-id244 . -1) (undo-tree-id245 . -8) (undo-tree-id246 . -22) (undo-tree-id247 . -933)) nil (26791 9250 542157 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 560)) nil (26791 9250 542153 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -7114) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -1) (undo-tree-id232 . -1) (undo-tree-id233 . -1) (undo-tree-id234 . -1) (undo-tree-id235 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -7115) (undo-tree-id236 . -1) (undo-tree-id237 . -1) (undo-tree-id238 . -1) (undo-tree-id239 . -1) (undo-tree-id240 . -1) (undo-tree-id241 . -1) (undo-tree-id242 . -1) 7116) nil (26791 9250 542150 0) 0 nil])
([nil nil ((939 . 944) (t 26791 9250 0 0)) nil (26791 9529 903728 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 987 . 988) (nil fontified nil 983 . 988) (nil fontified nil 959 . 983) (nil fontified nil 944 . 959) (944 . 988)) nil (26791 9529 903727 0) 0 nil])
([nil nil ((#("stream" 0 6 (fontified t)) . -952) (undo-tree-id279 . -6) 958) nil (26791 9529 903726 0) 0 nil])
([nil nil ((952 . 953)) nil (26791 9529 903725 0) 0 nil])
([nil nil ((955 . 957)) nil (26791 9529 903725 0) 0 nil])
([nil nil ((#("Content-Length" 0 14 (face font-lock-string-face fontified t)) . -957) (undo-tree-id278 . -14) 971) nil (26791 9529 903724 0) 0 nil])
([nil nil ((957 . 963)) nil (26791 9529 903723 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-string-face fontified t)) . -957) (undo-tree-id272 . -1) (#("t" 0 1 (face font-lock-string-face fontified t)) . -958) (undo-tree-id273 . -1) (#("a" 0 1 (face font-lock-string-face fontified t)) . -959) (undo-tree-id274 . -1) (#("u" 0 1 (face font-lock-string-face fontified t)) . -960) (undo-tree-id275 . -1) (#("t" 0 1 (face font-lock-string-face fontified t)) . -961) (undo-tree-id276 . -1) (#("s" 0 1 (face font-lock-string-face fontified t)) . -962) (undo-tree-id277 . -1) 963) nil (26791 9529 903723 0) 0 nil])
([nil nil ((957 . 963)) nil (26791 9529 903719 0) 0 nil])
([nil nil ((#("D" 0 1 (face font-lock-string-face fontified t)) . -966) (undo-tree-id271 . -1) 967) nil (26791 9529 903718 0) 0 nil])
([nil nil ((966 . 967)) nil (26791 9529 903717 0) 0 nil])
([nil nil ((#("len" 0 3 (fontified t)) . -973) (undo-tree-id270 . -3) 976) nil (26791 9529 903717 0) 0 nil])
([nil nil ((973 . 979)) nil (26791 9529 903716 0) 0 nil])
([nil nil ((980 . 985)) nil (26791 9529 903715 0) 0 nil])
([nil nil ((nil fontified nil 1020 . 1021) (nil fontified nil 1013 . 1020) (nil fontified nil 995 . 1013) (nil fontified nil 985 . 995) (985 . 1021)) nil (26791 9529 903715 0) 0 nil])
([nil nil ((#("Status" 0 6 (face font-lock-string-face fontified t)) . -998) (undo-tree-id269 . -6) 1004) nil (26791 9529 903714 0) 0 nil])
([nil nil ((998 . 1002)) nil (26791 9529 903713 0) 0 nil])
([nil nil ((#("status" 0 6 (fontified t)) . -1012) (undo-tree-id268 . -6) 1018) nil (26791 9529 903712 0) 0 nil])
([nil nil ((1012 . 1016)) nil (26791 9529 903711 0) 0 nil])
([nil nil ((1017 . 1022)) nil (26791 9529 903711 0) 0 nil])
([nil nil ((nil fontified nil 1053 . 1054) (nil fontified nil 1048 . 1053) (nil fontified nil 1032 . 1048) (nil fontified nil 1022 . 1032) (1022 . 1054)) nil (26791 9529 903710 0) 0 nil])
([nil nil ((#("Body" 0 4 (face font-lock-string-face fontified t)) . -1035) (undo-tree-id267 . -4) 1039) nil (26791 9529 903709 0) 0 nil])
([nil nil ((1035 . 1039)) nil (26791 9529 903708 0) 0 nil])
([nil nil ((#("h" 0 1 (face font-lock-string-face fontified t)) . -1035) (undo-tree-id263 . -1) (#("e" 0 1 (face font-lock-string-face fontified t)) . -1036) (undo-tree-id264 . -1) (#("a" 0 1 (face font-lock-string-face fontified t)) . -1037) (undo-tree-id265 . -1) (#("r" 0 1 (face font-lock-string-face fontified t)) . -1038) (undo-tree-id266 . -1) 1039) nil (26791 9529 903707 0) 0 nil])
([nil nil ((1035 . 1042)) nil (26791 9529 903704 0) 0 nil])
([nil nil ((#("body" 0 4 (fontified t)) . -1052) (undo-tree-id254 . -4) (undo-tree-id255 . -4) (undo-tree-id256 . -4) (undo-tree-id257 . -4) (undo-tree-id258 . -4) (undo-tree-id259 . -4) (undo-tree-id260 . -4) (undo-tree-id261 . -4) (undo-tree-id262 . -4) 1056) nil (26791 9529 903703 0) 0 nil])
([nil nil ((1052 . 1053)) nil (26791 9529 903698 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -1052) (undo-tree-id249 . -1) (undo-tree-id250 . -1) (undo-tree-id251 . -1) (undo-tree-id252 . -1) (undo-tree-id253 . -1) 1053) nil (26791 9529 903697 0) 0 nil])
([nil nil ((1052 . 1056)) nil (26791 9529 903684 0) 0 nil])
([nil nil ((1056 . 1059)) nil (26791 9529 903680 0) 0 nil])
([nil nil ((1924 . 1926) (t 26791 9529 0 0)) nil (26791 10220 500833 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3560 . 3561) (nil fontified nil 1926 . 3561) (1926 . 3561)) nil (26791 10220 500832 0) 0 nil])
([nil nil ((#("(format t \"~&Status: ~A\\r\\n\" status)
    (format t \"~&Body: ~A\\r\\n\" body)
    (format t \"~&Headers: ~A\\r\\n\" headers)" 0 10 (fontified t) 10 28 (face font-lock-string-face fontified t) 28 35 (fontified t) 35 36 (rear-nonsticky t fontified t) 36 37 (fontified t) 37 41 (fontified t) 41 51 (fontified t) 51 67 (face font-lock-string-face fontified t) 67 72 (fontified t) 72 73 (fontified t rear-nonsticky t) 73 74 (fontified t) 74 78 (fontified t) 78 88 (fontified t) 88 107 (face font-lock-string-face fontified t) 107 115 (fontified t) 115 116 (fontified t rear-nonsticky t)) . 944) (undo-tree-id287 . -115) (undo-tree-id288 . -115) (undo-tree-id289 . -116) 1060) nil (26791 10220 500831 0) 0 nil])
([nil nil ((2449 . 2453) (#("    " 0 4 (fontified nil)) . 2448) (undo-tree-id286 . -4) (2447 . 2453)) nil (26791 10220 500829 0) 0 nil])
([nil nil ((nil fontified nil 2568 . 2569) (nil fontified nil 2560 . 2568) (nil fontified nil 2541 . 2560) (nil fontified nil 2531 . 2541) (nil fontified nil 2527 . 2531) (nil fontified nil 2526 . 2527) (nil fontified nil 2525 . 2526) (nil fontified nil 2520 . 2525) (nil fontified nil 2504 . 2520) (nil fontified nil 2494 . 2504) (nil fontified nil 2490 . 2494) (nil fontified nil 2489 . 2490) (nil fontified nil 2488 . 2489) (nil fontified nil 2481 . 2488) (nil fontified nil 2463 . 2481) (nil fontified nil 2453 . 2463) (2453 . 2569)) nil (26791 10220 500827 0) 0 nil])
([nil nil ((#("\\r\\n" 0 4 (face font-lock-string-face fontified t)) . -2476) (undo-tree-id285 . -4) 2480) nil (26791 10220 500826 0) 0 nil])
([nil nil ((2476 . 2478)) nil (26791 10220 500825 0) 0 nil])
([nil nil ((#("\\r\\n" 0 4 (face font-lock-string-face fontified t)) . -2513) (undo-tree-id284 . -4) 2517) nil (26791 10220 500824 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2514 . 2515) (nil fontified nil 2513 . 2515) (2513 . 2515)) nil (26791 10220 500823 0) 0 nil])
([nil nil ((#("\\r\\n" 0 4 (face font-lock-string-face fontified t)) . -2551) (undo-tree-id283 . -4) 2555) nil (26791 10220 500822 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2552 . 2553) (nil fontified nil 2551 . 2553) (2551 . 2553)) nil (26791 10220 500820 0) 0 nil])
([nil nil ((#("
(defun write-response (stream resp &optional (method \"GET\"))
  (let* ((status  (resp-status resp))
         (headers (resp-headers resp))
         (body    (or (resp-body resp) \"\"))
         ;; On calcule la longueur en octets UTF-8,
         ;; et on Ã©crira ces octets tels quels.
         (bytes   (trivial-utf-8:string-to-utf-8-bytes body))
         (len     (length bytes)))
    
    ;; 1) Status line + headers (texte)
    (format stream \"HTTP/1.1 ~A ~A\\r\\n\" status
            (case status
              (200 \"OK\") (201 \"Created\") (204 \"No Content\")
              (400 \"Bad Request\") (401 \"Unauthorized\") (403 \"Forbidden\")
              (404 \"Not Found\") (500 \"Internal Server Error\") (t \"OK\")))
    (format stream \"Content-Length: ~D\\r\\n\" len)
    (format stream \"Connection: close\\r\\n\")
    (dolist (h headers)
      (format stream \"~A: ~A\\r\\n\" (car h) (cdr h)))
    (format stream \"\\r\\n\") ; fin des en-tÃªtes

    ;; 2) Body (octets) â Ã©crire sur le flux BINAIRE sous-jacent
    (let ((raw (flexi-streams:flexi-stream-stream stream)))
      (unless (string= method \"HEAD\")
        (write-sequence bytes raw))
      ;; 3) Flush sur le flux binaire (puis aussi sur le flexi par sÃ»retÃ©)
      (finish-output raw))
    (finish-output stream)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 36 (fontified t) 36 45 (face font-lock-type-face fontified t) 45 54 (fontified t) 54 59 (face font-lock-string-face fontified t) 59 65 (fontified t) 65 69 (face font-lock-keyword-face fontified t) 69 178 (fontified t) 178 180 (face font-lock-string-face fontified t) 180 192 (fontified t) 192 195 (face font-lock-comment-delimiter-face fontified t) 195 235 (face font-lock-comment-face fontified t) 235 244 (fontified t) 244 247 (face font-lock-comment-delimiter-face fontified t) 247 283 (face font-lock-comment-face fontified t) 283 345 (fontified t) 345 380 (fontified t) 380 384 (fontified t) 384 385 (fontified t) 385 389 (fontified t) 389 392 (fontified t face font-lock-comment-delimiter-face) 392 425 (fontified t face font-lock-comment-face) 425 444 (fontified t) 444 464 (fontified t face font-lock-string-face) 464 485 (fontified t) 485 489 (fontified t face font-lock-keyword-face) 489 516 (fontified t) 516 520 (fontified t face font-lock-string-face) 520 527 (fontified t) 527 536 (fontified t face font-lock-string-face) 536 543 (fontified t) 543 555 (fontified t face font-lock-string-face) 555 576 (fontified t) 576 589 (fontified t face font-lock-string-face) 589 596 (fontified t) 596 610 (fontified t face font-lock-string-face) 610 617 (fontified t) 617 628 (fontified t face font-lock-string-face) 628 649 (fontified t) 649 660 (fontified t face font-lock-string-face) 660 667 (fontified t) 667 690 (fontified t face font-lock-string-face) 690 695 (fontified t) 695 699 (fontified t face font-lock-string-face) 699 722 (fontified t) 722 746 (fontified t face font-lock-string-face) 746 771 (fontified t) 771 794 (fontified t face font-lock-string-face) 794 801 (fontified t) 801 807 (fontified t face font-lock-keyword-face) 807 841 (fontified t) 841 853 (fontified t face font-lock-string-face) 853 891 (fontified t) 891 897 (fontified t face font-lock-string-face) 897 899 (fontified t) 899 918 (fontified t face font-lock-comment-face) 918 923 (fontified t) 923 926 (fontified t face font-lock-comment-delimiter-face) 926 984 (fontified t face font-lock-comment-face) 984 989 (fontified t) 989 992 (fontified t face font-lock-keyword-face) 992 1051 (fontified t) 1051 1057 (fontified t face font-lock-keyword-face) 1057 1074 (fontified t) 1074 1080 (fontified t face font-lock-string-face) 1080 1124 (fontified t) 1124 1127 (fontified t face font-lock-comment-delimiter-face) 1127 1193 (fontified t face font-lock-comment-face) 1193 1220 (fontified t) 1220 1248 (fontified t)) . 560) (undo-tree-id280 . -1248) (undo-tree-id281 . -384) (undo-tree-id282 . -384)) nil (26791 10220 500819 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 560)) nil (26791 10220 500808 0) 0 nil])
([nil nil ((6013 . 6018)) nil (26791 10220 500807 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6133 . 6134) (nil fontified nil 6018 . 6134) (6018 . 6134)) nil (26791 10220 500803 0) 0 nil])
([nil nil ((#("
(defun make-http-stream (client)
  (let* ((raw  (usocket:socket-stream client))      ; <-- flux usocket
         (xfmt (flexi-streams:make-external-format :utf-8 :eol-style :crlf)))
    (flexi-streams:make-flexi-stream raw :external-format xfmt)))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 24 (face font-lock-function-name-face fontified t) 24 37 (fontified t) 37 41 (face font-lock-keyword-face fontified t) 41 86 (fontified t) 86 105 (face font-lock-comment-face fontified t) 105 128 (fontified t) 128 156 (fontified t) 156 162 (face font-lock-builtin-face fontified t) 162 163 (fontified t) 163 173 (face font-lock-builtin-face fontified t) 173 174 (fontified t) 174 179 (face font-lock-builtin-face fontified t) 179 183 (fontified t) 183 224 (fontified t) 224 240 (face font-lock-builtin-face fontified t) 240 247 (fontified t) 247 248 (fontified t rear-nonsticky t) 248 249 (fontified t)) . 3130) (undo-tree-id307 . -249) (t 26791 10220 0 0)) nil (26791 18157 482989 0) 0 nil])
([nil nil ((785 . 787)) nil (26791 18157 482988 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1361 . 1362) (nil fontified nil 787 . 1362) (787 . 1362)) nil (26791 18157 482987 0) 0 nil])
([nil nil ((#("
(defun status-reason (status)
  (case status
    (200 \"OK\") (201 \"Created\") (204 \"No Content\")
    (400 \"Bad Request\") (401 \"Unauthorized\") (403 \"Forbidden\")
    (404 \"Not Found\") (500 \"Internal Server Error\")
    (t \"OK\")))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 21 (face font-lock-function-name-face fontified t) 21 34 (fontified t) 34 38 (face font-lock-keyword-face fontified t) 38 55 (fontified t) 55 59 (face font-lock-string-face fontified t) 59 66 (fontified t) 66 75 (face font-lock-string-face fontified t) 75 82 (fontified t) 82 94 (face font-lock-string-face fontified t) 94 105 (fontified t) 105 118 (face font-lock-string-face fontified t) 118 125 (fontified t) 125 139 (face font-lock-string-face fontified t) 139 146 (fontified t) 146 157 (face font-lock-string-face fontified t) 157 168 (fontified t) 168 179 (face font-lock-string-face fontified t) 179 186 (fontified t) 186 209 (face font-lock-string-face fontified t) 209 211 (fontified t) 211 218 (fontified t) 218 222 (face font-lock-string-face fontified t) 222 225 (fontified t)) . 560) (undo-tree-id306 . -225)) nil (26791 18157 482987 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 560)) nil (26791 18157 482986 0) 0 nil])
([nil nil ((1136 . 1138)) nil (26791 18157 482985 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2176 . 2177) (nil fontified nil 1138 . 2177) (1138 . 2177)) nil (26791 18157 482985 0) 0 nil])
([nil nil ((#("
(defun write-response (stream resp &optional (method \"GET\"))
  ;; Ne RIEN Ã©crire sur `stream` (Flexi) : tout part sur `raw`
  (let* ((status  (resp-status resp))
         (headers (resp-headers resp))
         (body    (or (resp-body resp) \"\"))
         (body-bytes (trivial-utf-8:string-to-utf-8-bytes body))
         (len     (length body-bytes))
         (raw     (flexi-streams:flexi-stream-stream stream)))

    (format t \"~&Status: ~A~%\" status)
    (format t \"~&Body: ~A~%\" body)
    (format t \"~&Headers: ~A~%\" headers)

    ;; Construire la tÃªte HTTP en chaÃ®ne, puis -> octets
    (let* ((head-str
             (with-output-to-string (s)
               (format s \"HTTP/1.1 ~A ~A\\r\\n\" status (status-reason status))
               (format s \"Content-Length: ~D\\r\\n\" len)
               (format s \"Connection: close\\r\\n\")
               ;; Date optionnelle (mais bonne pratique)
               (format s \"Date: ~A\\r\\n\"
                       (local-time:format-timestring nil (local-time:now)))
               (dolist (h headers)
                 (format s \"~A: ~A\\r\\n\" (car h) (cdr h)))
               (format s \"\\r\\n\"))) ; fin des en-tÃªtes
           (head-bytes (trivial-utf-8:string-to-utf-8-bytes head-str)))

      ;; 1) Ãcrire headers (octets)
      (write-sequence head-bytes raw)
      ;; 2) Ãcrire body (octets) sauf HEAD
      (unless (string= method \"HEAD\")
        (write-sequence body-bytes raw))
      ;; 3) Flush binaire (puis Flexi par sÃ»retÃ©)
      (finish-output raw)
      (finish-output stream))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 36 (fontified t) 36 45 (face font-lock-type-face fontified t) 45 54 (fontified t) 54 59 (face font-lock-string-face fontified t) 59 64 (fontified t) 64 67 (face font-lock-comment-delimiter-face fontified t) 67 125 (face font-lock-comment-face fontified t) 125 128 (fontified t) 128 132 (face font-lock-keyword-face fontified t) 132 241 (fontified t) 241 243 (face font-lock-string-face fontified t) 243 350 (fontified t) 350 413 (fontified t) 413 414 (fontified t) 414 418 (fontified t) 418 428 (fontified t) 428 444 (face font-lock-string-face fontified t) 444 451 (fontified t) 451 452 (fontified t rear-nonsticky t) 452 453 (fontified t) 453 457 (fontified t) 457 467 (fontified t) 467 478 (face font-lock-string-face fontified t) 478 479 (face font-lock-string-face fontified t) 479 480 (face font-lock-string-face fontified t rear-nonsticky t) 480 481 (face font-lock-string-face fontified t) 481 486 (fontified t) 486 487 (fontified t rear-nonsticky t) 487 488 (fontified t) 488 492 (fontified t) 492 502 (fontified t) 502 516 (face font-lock-string-face fontified t) 516 517 (face font-lock-string-face fontified t) 517 518 (face font-lock-string-face fontified t rear-nonsticky t) 518 519 (face font-lock-string-face fontified t) 519 527 (fontified t) 527 528 (fontified t rear-nonsticky t) 528 529 (fontified t) 529 534 (fontified t) 534 537 (face font-lock-comment-delimiter-face fontified t) 537 587 (face font-lock-comment-face fontified t) 587 592 (fontified t) 592 596 (face font-lock-keyword-face fontified t) 596 622 (fontified t) 622 643 (face font-lock-keyword-face fontified t) 643 673 (fontified t) 673 693 (face font-lock-string-face fontified t) 693 750 (fontified t) 750 774 (face font-lock-string-face fontified t) 774 805 (fontified t) 805 828 (face font-lock-string-face fontified t) 828 845 (fontified t) 845 848 (face font-lock-comment-delimiter-face fontified t) 848 887 (face font-lock-comment-face fontified t) 887 912 (fontified t) 912 924 (face font-lock-string-face fontified t) 924 926 (face font-lock-string-face fontified t) 926 927 (fontified t) 927 1019 (fontified t) 1019 1025 (face font-lock-keyword-face fontified t) 1025 1065 (fontified t) 1065 1077 (face font-lock-string-face fontified t) 1077 1121 (fontified t) 1121 1127 (face font-lock-string-face fontified t) 1127 1131 (fontified t) 1131 1150 (face font-lock-comment-face fontified t) 1150 1229 (fontified t) 1229 1232 (face font-lock-comment-delimiter-face fontified t) 1232 1259 (face font-lock-comment-face fontified t) 1259 1274 (fontified t) 1274 1275 (fontified t) 1275 1297 (fontified t) 1297 1303 (fontified t) 1303 1306 (face font-lock-comment-delimiter-face fontified t) 1306 1340 (face font-lock-comment-face fontified t) 1340 1347 (fontified t) 1347 1353 (face font-lock-keyword-face fontified t) 1353 1361 (fontified t) 1361 1370 (fontified t) 1370 1376 (face font-lock-string-face fontified t) 1376 1378 (fontified t) 1378 1391 (fontified t) 1391 1419 (fontified t) 1419 1425 (fontified t) 1425 1428 (face font-lock-comment-delimiter-face fontified t) 1428 1469 (face font-lock-comment-face fontified t) 1469 1500 (fontified t) 1500 1525 (fontified t) 1525 1526 (fontified t rear-nonsticky t)) . 2178) (undo-tree-id305 . -1526)) nil (26791 18157 482984 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2177) (undo-tree-id303 . -1) (undo-tree-id304 . -1) 2178) nil (26791 18157 482983 0) 0 nil])
([nil nil ((5514 . 5516)) nil (26791 18157 482982 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7644 . 7645) (nil fontified nil 5516 . 7645) (5516 . 7645)) nil (26791 18157 482981 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -7643) (undo-tree-id301 . -1) (#("
" 0 1 (rear-nonsticky t fontified t)) . -7644) (undo-tree-id302 . -1) 7645) nil (26791 18157 482980 0) 0 nil])
([nil nil ((6450 . 6455)) nil (26791 18157 482977 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6679 . 6680) (nil fontified nil 6614 . 6680) (nil fontified nil 6577 . 6614) (nil fontified nil 6537 . 6577) (nil fontified nil 6495 . 6537) (nil fontified nil 6492 . 6495) (nil fontified nil 6462 . 6492) (nil fontified nil 6461 . 6462) (nil fontified nil 6456 . 6461) (nil fontified nil 6455 . 6456) (6455 . 6680)) nil (26791 18157 482976 0) 0 nil])
([nil nil ((#("
                                (funcall *handler* req)" 0 1 (fontified t) 1 56 (fontified t)) . -6680) (undo-tree-id300 . -56) 6736) nil (26791 18157 482975 0) 0 nil])
([nil nil ((#("  " 0 2 (fontified t)) . -7692) (#("  " 0 2 (fontified t)) . -7658) (#("  " 0 2 (fontified t)) . -7601) (6578 . 6584) (#("                              " 0 30 (fontified t)) . 6578) (6513 . 6519) (#("                              " 0 30 (fontified t)) . 6513) (6462 . 6468) (#("                              " 0 30 (fontified t)) . 6462) 5516) nil (26791 18157 482973 0) 0 nil])
([nil nil ((6738 . 6746) (#(" " 0 1 (fontified nil)) . 6737) (undo-tree-id299 . -1) (6738 . 6739)) nil (26791 18157 482971 0) 0 nil])
([nil nil ((7038 . 7046) (#(" " 0 1 (fontified nil)) . 7037) (undo-tree-id298 . -1) (7038 . 7039)) nil (26791 18157 482969 0) 0 nil])
([nil nil ((#("
(defun handle-connection (socket client)
  (declare (ignore socket))
  (let* ((stream (make-http-stream client)))
    (format t \"~&[dbg] raw element-type: ~S~%\"
        (stream-element-type (flexi-streams:flexi-stream-stream stream)))
    (unwind-protect
         (let (method path http-ver headers)
           (multiple-value-setq (method path http-ver) (read-request-line stream))
           (setf headers (read-headers stream))
           (let* ((req (make-instance 'lumen.core.http:request
                                      :method (string-upcase (or method \"GET\"))
                                      :path (or path \"/\")
                                      :headers headers
                                      :query nil :cookies nil :params nil
                                      :body-stream stream
                                      :context (list)))
                  (resp (handler-case
                            (progn
                              ;; Log pour Ãªtre sÃ»r dâappeler TON handler :
                              (format t \"~&[lumen] calling *handler* => ~S~%\" *handler*)
                              (funcall *handler* req))
                          (lumen.core.error:http-error (e)
                            (multiple-value-bind (st hs body) (funcall *error-handler* e)
                              (make-instance 'lumen.core.http:response
                                             :status st :headers hs :body body)))
                          (t (_)
                            (multiple-value-bind (st hs body) (funcall *error-handler* nil)
                              (make-instance 'lumen.core.http:response
                                             :status st :headers hs :body body))))))
             (write-response stream resp method)))
      (ignore-errors (close stream))
      (ignore-errors (usocket:socket-close client))
      )))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 25 (face font-lock-function-name-face fontified t) 25 38 (fontified t) 38 42 (fontified t) 42 45 (fontified t) 45 52 (face font-lock-keyword-face fontified t) 52 70 (fontified t) 70 73 (fontified t) 73 77 (face font-lock-keyword-face fontified t) 77 115 (fontified t) 115 119 (fontified t) 119 129 (fontified t) 129 161 (face font-lock-string-face fontified t) 161 234 (fontified t) 234 235 (fontified t rear-nonsticky t) 235 236 (fontified t) 236 241 (fontified t) 241 255 (face font-lock-keyword-face fontified t) 255 266 (fontified t) 266 269 (face font-lock-keyword-face fontified t) 269 307 (fontified t) 307 363 (fontified t) 363 384 (fontified t) 384 444 (fontified t) 444 448 (face font-lock-keyword-face fontified t) 448 526 (fontified t) 526 533 (fontified t) 533 540 (face font-lock-builtin-face fontified t) 540 567 (fontified t) 567 572 (face font-lock-string-face fontified t) 572 575 (fontified t) 575 613 (fontified t) 613 618 (face font-lock-builtin-face fontified t) 618 628 (fontified t) 628 631 (face font-lock-string-face fontified t) 631 671 (fontified t) 671 679 (face font-lock-builtin-face fontified t) 679 716 (fontified t) 716 726 (fontified t) 726 732 (face font-lock-builtin-face fontified t) 732 737 (fontified t) 737 745 (face font-lock-builtin-face fontified t) 745 750 (fontified t) 750 757 (face font-lock-builtin-face fontified t) 757 762 (fontified t) 762 800 (fontified t) 800 812 (face font-lock-builtin-face fontified t) 812 820 (fontified t) 820 858 (fontified t) 858 866 (face font-lock-builtin-face fontified t) 866 901 (fontified t) 901 913 (face font-lock-keyword-face fontified t) 913 931 (fontified t) 931 943 (fontified t) 943 948 (face font-lock-keyword-face fontified t) 948 949 (fontified t) 949 979 (fontified t) 979 982 (face font-lock-comment-delimiter-face fontified t) 982 1024 (face font-lock-comment-face fontified t) 1024 1064 (fontified t) 1064 1101 (face font-lock-string-face fontified t) 1101 1200 (fontified t) 1200 1227 (fontified t) 1227 1256 (fontified t) 1256 1275 (face font-lock-keyword-face fontified t) 1275 1386 (fontified t) 1386 1388 (fontified t) 1388 1433 (fontified t) 1433 1440 (face font-lock-builtin-face fontified t) 1440 1444 (fontified t) 1444 1452 (face font-lock-builtin-face fontified t) 1452 1456 (fontified t) 1456 1461 (face font-lock-builtin-face fontified t) 1461 1499 (fontified t) 1499 1500 (fontified t) 1500 1503 (fontified t) 1503 1532 (fontified t) 1532 1551 (face font-lock-keyword-face fontified t) 1551 1622 (fontified t) 1622 1663 (fontified t) 1663 1666 (fontified t) 1666 1711 (fontified t) 1711 1718 (face font-lock-builtin-face fontified t) 1718 1722 (fontified t) 1722 1730 (face font-lock-builtin-face fontified t) 1730 1734 (fontified t) 1734 1736 (face font-lock-builtin-face fontified t) 1736 1739 (face font-lock-builtin-face fontified t) 1739 1751 (fontified t) 1751 1802 (fontified t) 1802 1809 (fontified t) 1809 1822 (face font-lock-keyword-face fontified t) 1822 1839 (fontified t) 1839 1845 (fontified t) 1845 1846 (fontified t) 1846 1859 (face font-lock-keyword-face fontified t) 1859 1891 (fontified t) 1891 1899 (fontified t) 1899 1900 (fontified t rear-nonsticky t) 1900 1901 (fontified t)) . -7756) (undo-tree-id290 . -104) (undo-tree-id291 . -114) (undo-tree-id292 . -1503) (undo-tree-id293 . -1901) (undo-tree-id294 . -119) (undo-tree-id295 . -942) (undo-tree-id296 . -1637) (undo-tree-id297 . -1901) 9657) nil (26791 18157 482966 0) 0 nil])
([nil nil ((7755 . 7757) (t 26791 18157 0 0)) nil (26791 25324 129245 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9786 . 9787) (nil fontified nil 7757 . 9787) (7757 . 9787)) nil (26791 25324 129244 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face rear-nonsticky t fontified t)) . -9786) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 9787) nil (26791 25324 129240 0) 0 nil])
([nil nil ((2177 . 2179) (t 26791 25324 0 0)) nil (26791 25919 288336 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3542 . 3543) (nil fontified nil 2179 . 3543) (2179 . 3543)) nil (26791 25919 288335 0) 0 nil])
([nil nil ((11152 . 11154)) nil (26791 25919 288334 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12962 . 12963) (nil fontified nil 11154 . 12963) (11154 . 12963)) nil (26791 25919 288328 0) 0 nil])
([nil nil ((2827 . 2828) (t 26791 25919 0 0)) nil (26791 25961 587391 0) 0 nil])
([nil nil ((3544 . 3546) (t 26791 25961 0 0)) nil (26791 26852 706528 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4988 . 4989) (nil fontified nil 3546 . 4989) (3546 . 4989)) nil (26791 26852 706527 0) 0 nil])
([nil nil ((#("
(defun %status-reason (status)
  (case status
    (200 \"OK\") (201 \"Created\") (204 \"No Content\")
    (400 \"Bad Request\") (401 \"Unauthorized\") (403 \"Forbidden\")
    (404 \"Not Found\") (500 \"Internal Server Error\")
    (t \"OK\")))

(defun %send-raw-500 (raw)
  \"Toujours Ã©crire une rÃ©ponse 500 minimaliste en octets (secours).\"
  (let* ((head \"HTTP/1.1 500 Internal Server Error\\r\\nContent-Length: 0\\r\\nConnection: close\\r\\n\\r\\n\")
         (bytes (trivial-utf-8:string-to-utf-8-bytes head)))
    (ignore-errors (write-sequence bytes raw))
    (ignore-errors (finish-output raw))))

(defun write-response (flexi-stream resp &optional (method \"GET\"))
  ;; IMPORTANT : Ã©crire UNIQUEMENT sur le flux binaire sous-jacent
  (let* ((raw   (flexi-streams:flexi-stream-stream flexi-stream))
         (body  (or (resp-body resp) \"\"))
         (bytes (trivial-utf-8:string-to-utf-8-bytes body))
         (len   (length bytes))
         (head-str
           (with-output-to-string (s)
             (format s \"HTTP/1.1 ~A ~A\\r\\n\" (resp-status resp) (%status-reason (resp-status resp)))
             (format s \"Content-Length: ~D\\r\\n\" len)
             (format s \"Connection: close\\r\\n\")
             ;; headers
             (dolist (h (resp-headers resp))
               (format s \"~A: ~A\\r\\n\" (car h) (cdr h)))
             (format s \"\\r\\n\")))        ; fin des headers
         (head-bytes (trivial-utf-8:string-to-utf-8-bytes head-str)))
    ;; Ã©criture en deux blocs : headers, puis body (sauf HEAD)
    (write-sequence head-bytes raw)
    (unless (string= method \"HEAD\")
      (write-sequence bytes raw))
    (finish-output raw)))

(defun write-response (flexi resp &optional (method \"GET\"))
  \"Ãcrit status-line + headers + body en OCTETS sur le flux binaire sous-jacent.
   Ne rien Ã©crire sur FLEXI ici pour Ã©viter tout conflit de buffers.\"
  (let* ((raw        (flexi-streams:flexi-stream-stream flexi)) ; FD-STREAM binaire
         (status     (lumen.core.http:resp-status resp))
         (headers    (lumen.core.http:resp-headers resp))
         (body       (or (lumen.core.http:resp-body resp) \"\"))
         (body-bytes (trivial-utf-8:string-to-utf-8-bytes body))
         (head-str   (with-output-to-string (s)
                       (format s \"HTTP/1.1 ~A ~A\\r\\n\" status (%status-reason status))
                       (format s \"Content-Length: ~D\\r\\n\" (length body-bytes))
                       (format s \"Connection: close\\r\\n\")
                       (dolist (h headers)
                         (format s \"~A: ~A\\r\\n\" (car h) (cdr h)))
                       (format s \"\\r\\n\")))
         (head-bytes (trivial-utf-8:string-to-utf-8-bytes head-str)))
    ;; 1) headers
    (write-sequence head-bytes raw)
    ;; 2) body (sauf HEAD)
    (unless (string= method \"HEAD\")
      (write-sequence body-bytes raw))
    ;; 3) flush binaire (et log)
    (finish-output raw)
    (format t \"~&[lumen] wrote ~D + ~D bytes~%\" (length head-bytes) (if (string= method \"HEAD\") 0 (length body-bytes)))))" 0 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 35 (fontified t) 35 39 (face font-lock-keyword-face fontified t) 39 56 (fontified t) 56 60 (face font-lock-string-face fontified t) 60 67 (fontified t) 67 76 (face font-lock-string-face fontified t) 76 83 (fontified t) 83 95 (face font-lock-string-face fontified t) 95 106 (fontified t) 106 119 (face font-lock-string-face fontified t) 119 126 (fontified t) 126 140 (face font-lock-string-face fontified t) 140 147 (fontified t) 147 158 (face font-lock-string-face fontified t) 158 169 (fontified t) 169 180 (face font-lock-string-face fontified t) 180 187 (fontified t) 187 210 (face font-lock-string-face fontified t) 210 219 (fontified t) 219 223 (face font-lock-string-face fontified t) 223 229 (fontified t) 229 234 (face font-lock-keyword-face fontified t) 234 235 (fontified t) 235 248 (face font-lock-function-name-face fontified t) 248 257 (fontified t) 257 323 (face font-lock-doc-face fontified t) 323 327 (fontified t) 327 331 (face font-lock-keyword-face fontified t) 331 339 (fontified t) 339 425 (face font-lock-string-face fontified t) 425 493 (fontified t) 493 506 (face font-lock-keyword-face fontified t) 506 540 (fontified t) 540 553 (face font-lock-keyword-face fontified t) 553 578 (fontified t) 578 579 (fontified t) 579 584 (face font-lock-keyword-face fontified t) 584 585 (fontified t) 585 599 (face font-lock-function-name-face fontified t) 599 619 (fontified t) 619 628 (face font-lock-type-face fontified t) 628 637 (fontified t) 637 642 (face font-lock-string-face fontified t) 642 647 (fontified t) 647 650 (face font-lock-comment-delimiter-face fontified t) 650 712 (face font-lock-comment-face fontified t) 712 715 (fontified t) 715 719 (face font-lock-keyword-face fontified t) 719 815 (fontified t) 815 817 (face font-lock-string-face fontified t) 817 941 (fontified t) 941 943 (fontified t) 943 964 (face font-lock-keyword-face fontified t) 964 969 (fontified t) 969 992 (fontified t) 992 1012 (face font-lock-string-face fontified t) 1012 1092 (fontified t) 1092 1116 (face font-lock-string-face fontified t) 1116 1145 (fontified t) 1145 1168 (face font-lock-string-face fontified t) 1168 1183 (fontified t) 1183 1186 (face font-lock-comment-delimiter-face fontified t) 1186 1194 (face font-lock-comment-face fontified t) 1194 1208 (fontified t) 1208 1214 (face font-lock-keyword-face fontified t) 1214 1264 (fontified t) 1264 1276 (face font-lock-string-face fontified t) 1276 1318 (fontified t) 1318 1324 (face font-lock-string-face fontified t) 1324 1335 (fontified t) 1335 1353 (face font-lock-comment-face fontified t) 1353 1427 (fontified t) 1427 1430 (face font-lock-comment-delimiter-face fontified t) 1430 1486 (face font-lock-comment-face fontified t) 1486 1527 (fontified t) 1527 1533 (face font-lock-keyword-face fontified t) 1533 1550 (fontified t) 1550 1556 (face font-lock-string-face fontified t) 1556 1592 (fontified t) 1592 1618 (fontified t) 1618 1619 (fontified t) 1619 1620 (fontified t) 1620 1625 (face font-lock-keyword-face fontified t) 1625 1626 (fontified t) 1626 1640 (face font-lock-function-name-face fontified t) 1640 1653 (fontified t) 1653 1662 (face font-lock-type-face fontified t) 1662 1671 (fontified t) 1671 1676 (face font-lock-string-face fontified t) 1676 1681 (fontified t) 1681 1829 (face font-lock-doc-face fontified t) 1829 1833 (fontified t) 1833 1837 (face font-lock-keyword-face fontified t) 1837 1894 (fontified t) 1894 1914 (face font-lock-comment-face fontified t) 1914 2087 (fontified t) 2087 2089 (face font-lock-string-face fontified t) 2089 2179 (fontified t) 2179 2200 (face font-lock-keyword-face fontified t) 2200 2205 (fontified t) 2205 2238 (fontified t) 2238 2258 (face font-lock-string-face fontified t) 2258 2291 (fontified t) 2291 2324 (fontified t) 2324 2348 (face font-lock-string-face fontified t) 2348 2403 (fontified t) 2403 2426 (face font-lock-string-face fontified t) 2426 2452 (fontified t) 2452 2458 (face font-lock-keyword-face fontified t) 2458 2506 (fontified t) 2506 2518 (face font-lock-string-face fontified t) 2518 2570 (fontified t) 2570 2576 (face font-lock-string-face fontified t) 2576 2654 (fontified t) 2654 2657 (face font-lock-comment-delimiter-face fontified t) 2657 2668 (face font-lock-comment-face fontified t) 2668 2708 (fontified t) 2708 2711 (face font-lock-comment-delimiter-face fontified t) 2711 2731 (face font-lock-comment-face fontified t) 2731 2736 (fontified t) 2736 2742 (face font-lock-keyword-face fontified t) 2742 2759 (fontified t) 2759 2765 (face font-lock-string-face fontified t) 2765 2810 (fontified t) 2810 2813 (face font-lock-comment-delimiter-face fontified t) 2813 2839 (face font-lock-comment-face fontified t) 2839 2863 (fontified t) 2863 2877 (fontified t) 2877 2910 (face font-lock-string-face fontified t) 2910 2932 (fontified t) 2932 2934 (face font-lock-keyword-face fontified t) 2934 2951 (fontified t) 2951 2957 (face font-lock-string-face fontified t) 2957 2983 (fontified t) 2983 2984 (fontified t rear-nonsticky t)) . 560) (undo-tree-id20 . -2984) (undo-tree-id21 . -1618)) nil (26791 26852 706526 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 560)) nil (26791 26852 706525 0) 0 nil])
([nil nil ((#("(defun handle-connection (socket client)
  (declare (ignore socket))
  (let ((flexi (make-http-stream client))) ; Flexi au-dessus dâun FD binaire
    (unwind-protect
         (handler-case
             (let (method path http-ver headers)
               ;; LECTURE
               (multiple-value-setq (method path http-ver) (read-request-line flexi))
               (setf headers (read-headers flexi))
               ;; REQ objet
               (let* ((req (make-instance 'lumen.core.http:request
                                          :method (string-upcase (or method \"GET\"))
                                          :path   (or path \"/\")
                                          :headers headers
                                          :query nil :cookies nil :params nil
                                          :body-stream flexi :context (list)))
                      ;; HANDLER
                      (resp (handler-case
				(progn
				  ;; Log pour Ãªtre sÃ»r dâappeler TON handler :
				  (format t \"~&[lumen] calling *handler* => ~S~%\" *handler*)
				  (funcall *handler* req))
                              (lumen.core.error:http-error (e)
                                (multiple-value-bind (st hs body)
				    (funcall *error-handler* e)
                                  (make-instance 'lumen.core.http:response
                                                 :status st :headers hs :body body)))
                              (t (_)
                                (multiple-value-bind (st hs body)
				    (funcall *error-handler* nil)
                                  (make-instance 'lumen.core.http:response
                                                 :status st :headers hs :body body))))))
                 ;; ÃCRITURE
                 (write-response flexi resp (slot-value req 'lumen.core.http::method))))
           ;; CATCH GLOBAL : quoi quâil arrive, envoyer un 500 raw minimal
           (error (e)
             (format *error-output* \"~&[lumen] FATAL in handle-connection: ~A~%\" e)
             (%send-raw-500 (flexi-streams:flexi-stream-stream flexi)))))
    ;; FERMETURE : dâabord Flexi (flush), puis la socket
    (ignore-errors (close flexi))
    (ignore-errors (usocket:socket-close client))))

(defun handle-connection (socket client)
  (declare (ignore socket))
  (let ((flexi (make-http-stream client))) ; Flexi au-dessus dâun FD binaire
    (unwind-protect
         (progn
           (format t \"~&[lumen] accepted ~S~%\" client)
           ;; --- Lecture de la request-line
           (multiple-value-bind (method path http-ver) (read-request-line flexi)
             (declare (ignore http-ver))
             (format t \"[lumen] request ~A ~A~%\" method path)
             ;; --- Lecture des headers
             (let* ((headers (read-headers flexi)))
               (format t \"[lumen] headers: ~S~%\" headers)
               ;; --- Construction de lâobjet request
               (let* ((req (make-instance 'lumen.core.http:request
                                          :method (string-upcase (or method \"GET\"))
                                          :path   (or path \"/\")
                                          :headers headers
                                          :query nil :cookies nil :params nil
                                          :body-stream flexi
                                          :context (list)))
                      resp)
                 ;; --- Appel direct du handler (pas de handler-case)
                 (format t \"[lumen] calling *handler* => ~S~%\" *handler*)
                 (setf resp (funcall *handler* req))
                 (format t \"[lumen] handler returned ~S~%\" resp)
                 ;; --- Ãcriture de la rÃ©ponse
                 (write-response flexi resp (or method \"GET\"))
                 (format t \"[lumen] response sent (status=~A)~%\"
                         (lumen.core.http:resp-status resp))))))
      ;; --- Fermeture/flush : ordre pensÃ© pour Ã©viter les RST sous Windows
      (ignore-errors (finish-output flexi))
      (ignore-errors (usocket:socket-shutdown client :direction :output))
      (ignore-errors (close flexi))                  ; Flexi au-dessus du FD binaire
      (ignore-errors (usocket:socket-close client))))) ; ferme la socket (FD)

(defun handle-connection (socket client)
  (declare (ignore socket))
  (let ((flexi (make-http-stream client))) ; Flexi AU-DESSUS dâun FD binaire
    (unwind-protect
         (progn
           (format t \"~&[lumen] accepted ~S~%\" client)
           (multiple-value-bind (method path http-ver) (read-request-line flexi)
             (declare (ignore http-ver))
             (format t \"[lumen] request ~A ~A~%\" method path)
             (let* ((headers (read-headers flexi)))
               (format t \"[lumen] headers: ~S~%\" headers)
               (let* ((req (make-instance 'lumen.core.http:request
                                          :method (string-upcase (or method \"GET\"))
                                          :path   (or path \"/\")
                                          :headers headers
                                          :query nil :cookies nil :params nil
                                          :body-stream flexi
                                          :context (list)))
                      (resp (progn
                              (format t \"[lumen] calling *handler* => ~S~%\" *handler*)
                              (funcall *handler* req))))
                 (format t \"[lumen] handler returned ~S~%\" resp)
                 ;; Ãcriture 100% RAW
                 (write-response flexi resp (or method \"GET\"))
                 (format t \"[lumen] response sent (status=~A)~%\"
                         (lumen.core.http:resp-status resp))))))
      ;; === FERMETURE PROPRE (Ã©vite les RST) ===
      ;; 1) flush Flexi (au cas oÃ¹, mÃªme si on Ã©crit sur RAW)
      (ignore-errors (finish-output flexi))
      ;; 2) NE PAS fermer deux fois : un seul close du Flexi suffit
      (ignore-errors (close flexi))
      ;; 3) NE PAS appeler (usocket:socket-close client) ici
      )))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 24 (face font-lock-function-name-face fontified t) 24 44 (fontified t) 44 51 (face font-lock-keyword-face fontified t) 51 72 (fontified t) 72 75 (face font-lock-keyword-face fontified t) 75 112 (fontified t) 112 146 (face font-lock-comment-face fontified t) 146 151 (fontified t) 151 165 (face font-lock-keyword-face fontified t) 165 176 (fontified t) 176 188 (face font-lock-keyword-face fontified t) 188 203 (fontified t) 203 206 (face font-lock-keyword-face fontified t) 206 253 (fontified t) 253 256 (face font-lock-comment-delimiter-face fontified t) 256 264 (face font-lock-comment-face fontified t) 264 416 (fontified t) 416 419 (face font-lock-comment-delimiter-face fontified t) 419 429 (face font-lock-comment-face fontified t) 429 445 (fontified t) 445 449 (face font-lock-keyword-face fontified t) 449 486 (fontified t) 486 496 (fontified t) 496 538 (fontified t) 538 545 (face font-lock-builtin-face fontified t) 545 557 (fontified t) 557 572 (fontified t) 572 577 (face font-lock-string-face fontified t) 577 580 (fontified t) 580 622 (fontified t) 622 627 (face font-lock-builtin-face fontified t) 627 639 (fontified t) 639 642 (face font-lock-string-face fontified t) 642 686 (fontified t) 686 694 (face font-lock-builtin-face fontified t) 694 745 (fontified t) 745 751 (face font-lock-builtin-face fontified t) 751 756 (fontified t) 756 764 (face font-lock-builtin-face fontified t) 764 769 (fontified t) 769 776 (face font-lock-builtin-face fontified t) 776 823 (fontified t) 823 835 (face font-lock-builtin-face fontified t) 835 842 (fontified t) 842 850 (face font-lock-builtin-face fontified t) 850 882 (fontified t) 882 885 (face font-lock-comment-delimiter-face fontified t) 885 893 (face font-lock-comment-face fontified t) 893 922 (fontified t) 922 934 (face font-lock-keyword-face fontified t) 934 940 (fontified t) 940 945 (face font-lock-keyword-face fontified t) 945 952 (fontified t) 952 955 (face font-lock-comment-delimiter-face fontified t) 955 997 (face font-lock-comment-face fontified t) 997 1013 (fontified t) 1013 1050 (face font-lock-string-face fontified t) 1050 1189 (fontified t) 1189 1199 (face font-lock-keyword-face fontified t) 1199 1208 (face font-lock-keyword-face fontified t) 1208 1222 (fontified t) 1222 1264 (fontified t) 1264 1333 (fontified t) 1333 1382 (fontified t) 1382 1389 (face font-lock-builtin-face fontified t) 1389 1393 (fontified t) 1393 1401 (face font-lock-builtin-face fontified t) 1401 1405 (fontified t) 1405 1410 (face font-lock-builtin-face fontified t) 1410 1489 (fontified t) 1489 1508 (face font-lock-keyword-face fontified t) 1508 1684 (fontified t) 1684 1691 (face font-lock-builtin-face fontified t) 1691 1695 (fontified t) 1695 1703 (face font-lock-builtin-face fontified t) 1703 1707 (fontified t) 1707 1712 (face font-lock-builtin-face fontified t) 1712 1741 (fontified t) 1741 1744 (face font-lock-comment-delimiter-face fontified t) 1744 1753 (face font-lock-comment-face fontified t) 1753 1853 (fontified t) 1853 1856 (face font-lock-comment-delimiter-face fontified t) 1856 1917 (face font-lock-comment-face fontified t) 1917 1929 (fontified t) 1929 1934 (face font-lock-warning-face fontified t) 1934 1975 (fontified t) 1975 1996 (face font-lock-string-face fontified t) 1996 2019 (face font-lock-string-face fontified t) 2019 2023 (fontified t) 2023 2080 (fontified t) 2080 2097 (fontified t) 2097 2101 (fontified t) 2101 2104 (face font-lock-comment-delimiter-face fontified t) 2104 2154 (face font-lock-comment-face fontified t) 2154 2159 (fontified t) 2159 2172 (face font-lock-keyword-face fontified t) 2172 2188 (fontified t) 2188 2193 (fontified t) 2193 2206 (face font-lock-keyword-face fontified t) 2206 2240 (fontified t) 2240 2241 (fontified t) 2241 2242 (fontified t) 2242 2247 (face font-lock-keyword-face fontified t) 2247 2248 (fontified t) 2248 2265 (face font-lock-function-name-face fontified t) 2265 2285 (fontified t) 2285 2292 (face font-lock-keyword-face fontified t) 2292 2313 (fontified t) 2313 2316 (face font-lock-keyword-face fontified t) 2316 2353 (fontified t) 2353 2387 (face font-lock-comment-face fontified t) 2387 2392 (fontified t) 2392 2406 (face font-lock-keyword-face fontified t) 2406 2417 (fontified t) 2417 2422 (face font-lock-keyword-face fontified t) 2422 2444 (fontified t) 2444 2469 (face font-lock-string-face fontified t) 2469 2489 (fontified t) 2489 2492 (face font-lock-comment-delimiter-face fontified t) 2492 2523 (face font-lock-comment-face fontified t) 2523 2535 (fontified t) 2535 2554 (face font-lock-keyword-face fontified t) 2554 2618 (fontified t) 2618 2625 (face font-lock-keyword-face fontified t) 2625 2668 (fontified t) 2668 2693 (face font-lock-string-face fontified t) 2693 2720 (fontified t) 2720 2722 (face font-lock-comment-delimiter-face fontified t) 2722 2723 (face font-lock-comment-delimiter-face fontified t) 2723 2747 (face font-lock-comment-face fontified t) 2747 2761 (fontified t) 2761 2765 (face font-lock-keyword-face fontified t) 2765 2824 (fontified t) 2824 2847 (face font-lock-string-face fontified t) 2847 2872 (fontified t) 2872 2875 (face font-lock-comment-delimiter-face fontified t) 2875 2911 (face font-lock-comment-face fontified t) 2911 2927 (fontified t) 2927 2931 (face font-lock-keyword-face fontified t) 2931 3020 (fontified t) 3020 3027 (face font-lock-builtin-face fontified t) 3027 3054 (fontified t) 3054 3059 (face font-lock-string-face fontified t) 3059 3104 (fontified t) 3104 3109 (face font-lock-builtin-face fontified t) 3109 3121 (fontified t) 3121 3124 (face font-lock-string-face fontified t) 3124 3168 (fontified t) 3168 3176 (face font-lock-builtin-face fontified t) 3176 3227 (fontified t) 3227 3233 (face font-lock-builtin-face fontified t) 3233 3238 (fontified t) 3238 3246 (face font-lock-builtin-face fontified t) 3246 3251 (fontified t) 3251 3258 (face font-lock-builtin-face fontified t) 3258 3305 (fontified t) 3305 3317 (face font-lock-builtin-face fontified t) 3317 3366 (fontified t) 3366 3374 (face font-lock-builtin-face fontified t) 3374 3429 (fontified t) 3429 3432 (face font-lock-comment-delimiter-face fontified t) 3432 3482 (face font-lock-comment-face fontified t) 3482 3509 (fontified t) 3509 3523 (face font-lock-string-face fontified t) 3523 3544 (face font-lock-string-face fontified t) 3544 3556 (fontified t) 3556 3597 (fontified t) 3597 3609 (fontified t) 3609 3636 (fontified t) 3636 3667 (face font-lock-string-face fontified t) 3667 3691 (fontified t) 3691 3694 (face font-lock-comment-delimiter-face fontified t) 3694 3721 (face font-lock-comment-face fontified t) 3721 3741 (fontified t) 3741 3776 (fontified t) 3776 3781 (face font-lock-string-face fontified t) 3781 3784 (fontified t) 3784 3811 (fontified t) 3811 3848 (face font-lock-string-face fontified t) 3848 3920 (fontified t) 3920 3923 (face font-lock-comment-delimiter-face fontified t) 3923 3990 (face font-lock-comment-face fontified t) 3990 3997 (fontified t) 3997 4010 (face font-lock-keyword-face fontified t) 4010 4041 (fontified t) 4041 4054 (face font-lock-keyword-face fontified t) 4054 4087 (fontified t) 4087 4097 (face font-lock-builtin-face fontified t) 4097 4098 (fontified t) 4098 4105 (face font-lock-builtin-face fontified t) 4105 4115 (fontified t) 4115 4128 (face font-lock-keyword-face fontified t) 4128 4161 (fontified t) 4161 4193 (face font-lock-comment-face fontified t) 4193 4200 (fontified t) 4200 4213 (face font-lock-keyword-face fontified t) 4213 4247 (fontified t) 4247 4248 (fontified t) 4248 4271 (face font-lock-comment-face fontified t) 4271 4272 (fontified t) 4272 4273 (fontified t) 4273 4278 (face font-lock-keyword-face fontified t) 4278 4279 (fontified t) 4279 4296 (face font-lock-function-name-face fontified t) 4296 4316 (fontified t) 4316 4323 (face font-lock-keyword-face fontified t) 4323 4344 (fontified t) 4344 4347 (face font-lock-keyword-face fontified t) 4347 4384 (fontified t) 4384 4418 (face font-lock-comment-face fontified t) 4418 4423 (fontified t) 4423 4437 (face font-lock-keyword-face fontified t) 4437 4448 (fontified t) 4448 4453 (face font-lock-keyword-face fontified t) 4453 4475 (fontified t) 4475 4500 (face font-lock-string-face fontified t) 4500 4521 (fontified t) 4521 4540 (face font-lock-keyword-face fontified t) 4540 4604 (fontified t) 4604 4611 (face font-lock-keyword-face fontified t) 4611 4654 (fontified t) 4654 4679 (face font-lock-string-face fontified t) 4679 4707 (fontified t) 4707 4711 (face font-lock-keyword-face fontified t) 4711 4770 (fontified t) 4770 4793 (face font-lock-string-face fontified t) 4793 4819 (fontified t) 4819 4823 (face font-lock-keyword-face fontified t) 4823 4912 (fontified t) 4912 4919 (face font-lock-builtin-face fontified t) 4919 4946 (fontified t) 4946 4951 (face font-lock-string-face fontified t) 4951 4996 (fontified t) 4996 5001 (face font-lock-builtin-face fontified t) 5001 5013 (fontified t) 5013 5016 (face font-lock-string-face fontified t) 5016 5056 (fontified t) 5056 5060 (fontified t) 5060 5068 (face font-lock-builtin-face fontified t) 5068 5077 (fontified t) 5077 5109 (fontified t) 5109 5119 (fontified t) 5119 5125 (face font-lock-builtin-face fontified t) 5125 5130 (fontified t) 5130 5138 (face font-lock-builtin-face fontified t) 5138 5143 (fontified t) 5143 5150 (face font-lock-builtin-face fontified t) 5150 5155 (fontified t) 5155 5197 (fontified t) 5197 5209 (face font-lock-builtin-face fontified t) 5209 5258 (fontified t) 5258 5266 (face font-lock-builtin-face fontified t) 5266 5305 (fontified t) 5305 5310 (face font-lock-keyword-face fontified t) 5310 5351 (fontified t) 5351 5386 (face font-lock-string-face fontified t) 5386 5482 (fontified t) 5482 5513 (face font-lock-string-face fontified t) 5513 5537 (fontified t) 5537 5540 (face font-lock-comment-delimiter-face fontified t) 5540 5558 (face font-lock-comment-face fontified t) 5558 5613 (fontified t) 5613 5618 (face font-lock-string-face fontified t) 5618 5648 (fontified t) 5648 5685 (face font-lock-string-face fontified t) 5685 5757 (fontified t) 5757 5760 (face font-lock-comment-delimiter-face fontified t) 5760 5772 (face font-lock-comment-face fontified t) 5772 5801 (face font-lock-comment-face fontified t) 5801 5807 (fontified t) 5807 5810 (face font-lock-comment-delimiter-face fontified t) 5810 5863 (face font-lock-comment-face fontified t) 5863 5870 (fontified t) 5870 5883 (face font-lock-keyword-face fontified t) 5883 5913 (fontified t) 5913 5916 (face font-lock-comment-delimiter-face fontified t) 5916 5975 (face font-lock-comment-face fontified t) 5975 5982 (fontified t) 5982 5995 (face font-lock-keyword-face fontified t) 5995 6017 (fontified t) 6017 6020 (face font-lock-comment-delimiter-face fontified t) 6020 6072 (face font-lock-comment-face fontified t) 6072 6080 (fontified t) 6080 6081 (fontified t rear-nonsticky t) 6081 6082 (fontified t)) . -5343) (undo-tree-id3 . -2239) (undo-tree-id4 . -2241) (undo-tree-id5 . -2239) (undo-tree-id6 . -4270) (undo-tree-id7 . -4272) (undo-tree-id8 . -6082) (undo-tree-id9 . -4803) (undo-tree-id10 . -6082) (undo-tree-id11 . -4272) (undo-tree-id12 . -5155) (undo-tree-id13 . -4803) (undo-tree-id14 . -5907) (undo-tree-id15 . -6011) (undo-tree-id16 . -6011) (undo-tree-id17 . -6011) (undo-tree-id18 . -6011) (undo-tree-id19 . -6082) 11425) nil (26791 26852 706523 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6911 . 6912) (nil fontified nil 5343 . 6912) (5343 . 6912)) nil (26791 26852 706492 0) 0 nil])
([nil nil ((3148 . 3150) (t 26791 26852 0 0)) nil (26791 27782 597062 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3438 . 3439) (nil fontified nil 3150 . 3439) (3150 . 3439)) nil (26791 27782 597061 0) 0 nil])
([nil nil ((2004 . 2006)) nil (26791 27782 597060 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2994 . 2995) (nil fontified nil 2006 . 2995) (2006 . 2995)) nil (26791 27782 597059 0) 0 nil])
([nil nil ((8195 . 8199) (#("    " 0 4 (fontified nil)) . 8194) (undo-tree-id22 . -4) (8193 . 8199)) nil (26791 27782 597147 0) 0 nil])
([nil nil ((#("(defun write-response (flexi resp &optional (method \"GET\"))
  \"Ãcrit la rÃ©ponse HTTP *uniquement* sur le flux FLEXI.\"
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (lumen.core.http:resp-headers resp))
         (body    (or (lumen.core.http:resp-body resp) \"\"))
         ;; Longueur en OCTETS (exigence HTTP), mais on ECRIT en chaÃ®nes.
         (len     (length (trivial-utf-8:string-to-utf-8-bytes body))))
    ;; Status line + headers
    (format flexi \"HTTP/1.1 ~A ~A\\r\\n\" status (status-reason status))
    (format flexi \"Content-Length: ~D\\r\\n\" len)
    (format flexi \"Connection: close\\r\\n\")
    ;; (optionnel) Date:
    ;; (format flexi \"Date: ~A\\r\\n\" (local-time:format-timestring nil (local-time:now)))
    (dolist (h headers)
      (format flexi \"~A: ~A\\r\\n\" (car h) (cdr h)))
    (write-string \"\\r\\n\" flexi) ; fin des headers

    ;; Corps (pas pour HEAD)
    (unless (string= method \"HEAD\")
      (write-string body flexi))

    ;; Flush *du mÃªme flux*
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 21 (face font-lock-function-name-face fontified t) 21 34 (fontified t) 34 43 (face font-lock-type-face fontified t) 43 52 (fontified t) 52 57 (face font-lock-string-face fontified t) 57 62 (fontified t) 62 117 (face font-lock-doc-face fontified t) 117 121 (fontified t) 121 125 (face font-lock-keyword-face fontified t) 125 282 (fontified t) 282 284 (face font-lock-string-face fontified t) 284 296 (fontified t) 296 299 (face font-lock-comment-delimiter-face fontified t) 299 361 (face font-lock-comment-face fontified t) 361 437 (fontified t) 437 440 (face font-lock-comment-delimiter-face fontified t) 440 462 (face font-lock-comment-face fontified t) 462 480 (fontified t) 480 500 (face font-lock-string-face fontified t) 500 550 (fontified t) 550 574 (face font-lock-string-face fontified t) 574 598 (fontified t) 598 621 (face font-lock-string-face fontified t) 621 627 (fontified t) 627 630 (face font-lock-comment-delimiter-face fontified t) 630 648 (face font-lock-comment-face fontified t) 648 652 (fontified t) 652 655 (face font-lock-comment-delimiter-face fontified t) 655 737 (face font-lock-comment-face fontified t) 737 742 (fontified t) 742 748 (face font-lock-keyword-face fontified t) 748 781 (fontified t) 781 793 (face font-lock-string-face fontified t) 793 830 (fontified t) 830 836 (face font-lock-string-face fontified t) 836 844 (fontified t) 844 862 (face font-lock-comment-face fontified t) 862 867 (fontified t) 867 870 (face font-lock-comment-delimiter-face fontified t) 870 892 (face font-lock-comment-face fontified t) 892 897 (fontified t) 897 903 (face font-lock-keyword-face fontified t) 903 920 (fontified t) 920 926 (face font-lock-string-face fontified t) 926 966 (fontified t) 966 969 (face font-lock-comment-delimiter-face fontified t) 969 988 (face font-lock-comment-face fontified t) 988 989 (face font-lock-comment-face rear-nonsticky t fontified t) 989 990 (face font-lock-comment-face fontified t)) . 2006) (undo-tree-id26 . -990) (undo-tree-id27 . -960) (undo-tree-id28 . -960) (undo-tree-id29 . -960) (undo-tree-id30 . -990) (undo-tree-id31 . -990) (undo-tree-id32 . -990) (undo-tree-id33 . -990) (undo-tree-id34 . -990)) nil (26791 27827 91816 0) 0 nil] [nil nil ((nil rear-nonsticky nil 9385 . 9386) (nil fontified nil 8199 . 9386) (8199 . 9386)) ((#("(defun handle-connection (socket client)
  (declare (ignore socket))
  (let ((flexi (make-http-stream client))) ; lecture/Ã©criture sur *le mÃªme flux*
    (unwind-protect
         (progn
           (multiple-value-bind (method path http-ver) (read-request-line flexi)
             (declare (ignore http-ver))
             (let* ((headers (read-headers flexi))
                    (req (make-instance 'lumen.core.http:request
                                        :method (string-upcase (or method \"GET\"))
                                        :path   (or path \"/\")
                                        :headers headers
                                        :query nil :cookies nil :params nil
                                        :body-stream flexi :context (list)))
                    (resp (funcall *handler* req)))
               (write-response flexi resp (or method \"GET\"))
               (format t \"~&[lumen] response sent (status=~A)~%\"
                       (lumen.core.http:resp-status resp)))))
      ;; â ï¸ FERMETURE : *un seul* close du flux. PAS de socket-close, PAS de shutdown.
      (ignore-errors (finish-output flexi))
      (ignore-errors (close flexi)))))" 0 1 (fontified nil) 1 6 (face font-lock-keyword-face fontified nil) 6 7 (fontified nil) 7 24 (face font-lock-function-name-face fontified nil) 24 44 (fontified nil) 44 51 (face font-lock-keyword-face fontified nil) 51 72 (fontified nil) 72 75 (face font-lock-keyword-face fontified nil) 75 112 (fontified nil) 112 150 (face font-lock-comment-face fontified nil) 150 155 (fontified nil) 155 169 (face font-lock-keyword-face fontified nil) 169 180 (fontified nil) 180 185 (face font-lock-keyword-face fontified nil) 185 198 (fontified nil) 198 217 (face font-lock-keyword-face fontified nil) 217 281 (fontified nil) 281 288 (face font-lock-keyword-face fontified nil) 288 322 (fontified nil) 322 326 (face font-lock-keyword-face fontified nil) 326 464 (fontified nil) 464 471 (face font-lock-builtin-face fontified nil) 471 498 (fontified nil) 498 503 (face font-lock-string-face fontified nil) 503 546 (fontified nil) 546 551 (face font-lock-builtin-face fontified nil) 551 563 (fontified nil) 563 566 (face font-lock-string-face fontified nil) 566 608 (fontified nil) 608 616 (face font-lock-builtin-face fontified nil) 616 665 (fontified nil) 665 671 (face font-lock-builtin-face fontified nil) 671 676 (fontified nil) 676 684 (face font-lock-builtin-face fontified nil) 684 689 (fontified nil) 689 696 (face font-lock-builtin-face fontified nil) 696 741 (fontified nil) 741 753 (face font-lock-builtin-face fontified nil) 753 760 (fontified nil) 760 768 (face font-lock-builtin-face fontified nil) 768 883 (fontified nil) 883 888 (face font-lock-string-face fontified nil) 888 916 (fontified nil) 916 955 (face font-lock-string-face fontified nil) 955 1024 (fontified nil) 1024 1027 (face font-lock-comment-delimiter-face fontified nil) 1027 1105 (face font-lock-comment-face fontified nil) 1105 1112 (fontified nil) 1112 1125 (face font-lock-keyword-face fontified nil) 1125 1149 (fontified nil) 1149 1156 (fontified nil) 1156 1169 (face font-lock-keyword-face fontified nil) 1169 1186 (fontified nil) 1186 1187 (rear-nonsticky nil fontified nil)) . 8199) (undo-tree-id23 . -1187) (undo-tree-id24 . -69) (undo-tree-id25 . -1149) (nil fontified t 9324 . 9348) (nil fontified t 9311 . 9324) (nil fontified t 9304 . 9311) (nil fontified t 9226 . 9304) (nil fontified t 9223 . 9226) (nil fontified t 9154 . 9223) (nil fontified t 9115 . 9154) (nil fontified t 9087 . 9115) (nil fontified t 9082 . 9087) (nil fontified t 8967 . 9082) (nil fontified t 8959 . 8967) (nil fontified t 8952 . 8959) (nil fontified t 8940 . 8952) (nil fontified t 8895 . 8940) (nil fontified t 8888 . 8895) (nil fontified t 8883 . 8888) (nil fontified t 8875 . 8883) (nil fontified t 8870 . 8875) (nil fontified t 8864 . 8870) (nil fontified t 8815 . 8864) (nil fontified t 8807 . 8815) (nil fontified t 8765 . 8807) (nil fontified t 8762 . 8765) (nil fontified t 8750 . 8762) (nil fontified t 8745 . 8750) (nil fontified t 8702 . 8745) (nil fontified t 8697 . 8702) (nil fontified t 8670 . 8697) (nil fontified t 8663 . 8670) (nil fontified t 8525 . 8663) (nil fontified t 8521 . 8525) (nil fontified t 8487 . 8521) (nil fontified t 8480 . 8487) (nil fontified t 8416 . 8480) (nil fontified t 8397 . 8416) (nil fontified t 8384 . 8397) (nil fontified t 8379 . 8384) (nil fontified t 8368 . 8379) (nil fontified t 8354 . 8368) (nil fontified t 8349 . 8354) (nil fontified t 8311 . 8349) (nil fontified t 8274 . 8311) (nil fontified t 8271 . 8274) (nil fontified t 8250 . 8271) (nil fontified t 8243 . 8250) (nil fontified t 8223 . 8243) (nil fontified t 8206 . 8223) (nil fontified t 8205 . 8206) (nil fontified t 8200 . 8205) (nil fontified t 8199 . 8200) (nil rear-nonsticky t 9385 . 9386)) (26791 27782 597043 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3022 . 3023) (nil fontified nil 2006 . 3023) (2006 . 3023)) nil (26791 27827 91800 0) 0 nil])
nil
([nil nil ((3023 . 3024)) nil (26791 27827 91799 0) 0 nil])
([nil nil ((8222 . 8223)) nil (26791 27827 91798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9410 . 9411) (nil fontified nil 8223 . 9411) (8223 . 9411)) nil (26791 27827 91793 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -9410) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) 9411 (t 26791 27827 0 0)) nil (26791 28285 422299 0) 0 nil])
([nil nil ((#("
(defun status-reason (status)
  (case status
    (200 \"OK\") (201 \"Created\") (204 \"No Content\")
    (400 \"Bad Request\") (401 \"Unauthorized\") (403 \"Forbidden\")
    (404 \"Not Found\") (500 \"Internal Server Error\")
    (t \"OK\")))

(defun write-response (flexi resp &optional (method \"GET\"))
  \"Ãcrit la rÃ©ponse en OCTETS sur le flux binaire sous-jacent (RAW).\"
  (let* ((raw        (flexi-streams:flexi-stream-stream flexi)) ; FD-STREAM binaire
         (status     (lumen.core.http:resp-status resp))
         (headers    (lumen.core.http:resp-headers resp))
         (body       (or (lumen.core.http:resp-body resp) \"\"))
         (body-bytes (trivial-utf-8:string-to-utf-8-bytes body))
         (head-str   (with-output-to-string (s)
                       (format s \"HTTP/1.1 ~A ~A\\r\\n\" status (status-reason status))
                       (format s \"Content-Length: ~D\\r\\n\" (length body-bytes))
                       (format s \"Connection: close\\r\\n\")
                       (dolist (h headers)
                         (format s \"~A: ~A\\r\\n\" (car h) (cdr h)))
                       (format s \"\\r\\n\")))
         (head-bytes (trivial-utf-8:string-to-utf-8-bytes head-str)))
    (write-sequence head-bytes raw)
    (unless (string= method \"HEAD\")
      (write-sequence body-bytes raw))
    (finish-output raw)
    (format t \"~&[lumen] wrote ~D + ~D bytes~%\" (length head-bytes)
            (if (string= method \"HEAD\") 0 (length body-bytes)))))

(defun write-response (flexi resp &optional (method \"GET\"))
  \"Ãcrit la rÃ©ponse HTTP *uniquement* sur le flux FLEXI.\"
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (lumen.core.http:resp-headers resp))
         (body    (or (lumen.core.http:resp-body resp) \"\"))
         ;; Longueur en OCTETS (exigence HTTP), mais on ECRIT en chaÃ®nes.
         (len     (length (trivial-utf-8:string-to-utf-8-bytes body))))
    ;; Status line + headers
    (format flexi \"HTTP/1.1 ~A ~A\\r\\n\" status (status-reason status))
    (format flexi \"Content-Length: ~D\\r\\n\" len)
    (format flexi \"Connection: close\\r\\n\")
    ;; (optionnel) Date:
    ;; (format flexi \"Date: ~A\\r\\n\" (local-time:format-timestring nil (local-time:now)))
    (dolist (h headers)
      (format flexi \"~A: ~A\\r\\n\" (car h) (cdr h)))
    (write-string \"\\r\\n\" flexi) ; fin des headers

    ;; Corps (pas pour HEAD)
    (unless (string= method \"HEAD\")
      (write-string body flexi))

    ;; Flush *du mÃªme flux*
    (finish-output flexi)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (fontified t face font-lock-keyword-face) 7 8 (fontified t) 8 21 (fontified t face font-lock-function-name-face) 21 34 (fontified t) 34 38 (fontified t face font-lock-keyword-face) 38 55 (fontified t) 55 59 (fontified t face font-lock-string-face) 59 66 (fontified t) 66 75 (fontified t face font-lock-string-face) 75 82 (fontified t) 82 94 (fontified t face font-lock-string-face) 94 105 (fontified t) 105 118 (fontified t face font-lock-string-face) 118 125 (fontified t) 125 139 (fontified t face font-lock-string-face) 139 146 (fontified t) 146 157 (fontified t face font-lock-string-face) 157 168 (fontified t) 168 179 (fontified t face font-lock-string-face) 179 186 (fontified t) 186 209 (fontified t face font-lock-string-face) 209 211 (fontified t) 211 218 (fontified t) 218 222 (face font-lock-string-face fontified t) 222 226 (fontified t) 226 227 (fontified t) 227 228 (fontified t) 228 233 (face font-lock-keyword-face fontified t) 233 234 (fontified t) 234 248 (face font-lock-function-name-face fontified t) 248 261 (fontified t) 261 270 (face font-lock-type-face fontified t) 270 279 (fontified t) 279 284 (face font-lock-string-face fontified t) 284 289 (fontified t) 289 356 (face font-lock-doc-face fontified t) 356 360 (fontified t) 360 364 (face font-lock-keyword-face fontified t) 364 421 (fontified t) 421 441 (face font-lock-comment-face fontified t) 441 614 (fontified t) 614 616 (face font-lock-string-face fontified t) 616 706 (fontified t) 706 727 (face font-lock-keyword-face fontified t) 727 765 (fontified t) 765 785 (face font-lock-string-face fontified t) 785 850 (fontified t) 850 874 (face font-lock-string-face fontified t) 874 929 (fontified t) 929 952 (face font-lock-string-face fontified t) 952 978 (fontified t) 978 984 (face font-lock-keyword-face fontified t) 984 1032 (fontified t) 1032 1044 (face font-lock-string-face fontified t) 1044 1096 (fontified t) 1096 1102 (face font-lock-string-face fontified t) 1102 1217 (fontified t) 1217 1223 (face font-lock-keyword-face fontified t) 1223 1240 (fontified t) 1240 1246 (face font-lock-string-face fontified t) 1246 1311 (fontified t) 1311 1325 (fontified t) 1325 1358 (face font-lock-string-face fontified t) 1358 1379 (fontified t) 1379 1392 (fontified t) 1392 1394 (face font-lock-keyword-face fontified t) 1394 1411 (fontified t) 1411 1417 (face font-lock-string-face fontified t) 1417 1443 (fontified t) 1443 1444 (fontified t rear-nonsticky t) 1444 1445 (fontified t) 1445 1446 (fontified t) 1446 1447 (fontified t) 1447 1452 (face font-lock-keyword-face fontified t) 1452 1453 (fontified t) 1453 1467 (face font-lock-function-name-face fontified t) 1467 1480 (fontified t) 1480 1489 (face font-lock-type-face fontified t) 1489 1498 (fontified t) 1498 1503 (face font-lock-string-face fontified t) 1503 1508 (fontified t) 1508 1563 (face font-lock-doc-face fontified t) 1563 1567 (fontified t) 1567 1571 (face font-lock-keyword-face fontified t) 1571 1728 (fontified t) 1728 1730 (face font-lock-string-face fontified t) 1730 1742 (fontified t) 1742 1745 (face font-lock-comment-delimiter-face fontified t) 1745 1807 (face font-lock-comment-face fontified t) 1807 1883 (fontified t) 1883 1886 (face font-lock-comment-delimiter-face fontified t) 1886 1908 (face font-lock-comment-face fontified t) 1908 1926 (fontified t) 1926 1946 (face font-lock-string-face fontified t) 1946 1996 (fontified t) 1996 2020 (face font-lock-string-face fontified t) 2020 2044 (fontified t) 2044 2067 (face font-lock-string-face fontified t) 2067 2073 (fontified t) 2073 2076 (face font-lock-comment-delimiter-face fontified t) 2076 2094 (face font-lock-comment-face fontified t) 2094 2098 (fontified t) 2098 2101 (face font-lock-comment-delimiter-face fontified t) 2101 2183 (face font-lock-comment-face fontified t) 2183 2188 (fontified t) 2188 2194 (face font-lock-keyword-face fontified t) 2194 2227 (fontified t) 2227 2239 (face font-lock-string-face fontified t) 2239 2276 (fontified t) 2276 2282 (face font-lock-string-face fontified t) 2282 2290 (fontified t) 2290 2308 (face font-lock-comment-face fontified t) 2308 2313 (fontified t) 2313 2316 (face font-lock-comment-delimiter-face fontified t) 2316 2338 (face font-lock-comment-face fontified t) 2338 2343 (fontified t) 2343 2349 (face font-lock-keyword-face fontified t) 2349 2366 (fontified t) 2366 2372 (face font-lock-string-face fontified t) 2372 2412 (fontified t) 2412 2415 (face font-lock-comment-delimiter-face fontified t) 2415 2436 (face font-lock-comment-face fontified t) 2436 2462 (fontified t) 2462 2463 (rear-nonsticky t fontified t)) . 560) (undo-tree-id38 . -2463) (undo-tree-id39 . -1) (undo-tree-id40 . -1444) (undo-tree-id41 . -1446) (undo-tree-id42 . -2435) (undo-tree-id43 . -2435) (undo-tree-id44 . -2435) (undo-tree-id45 . -2435) (undo-tree-id46 . -2435) (undo-tree-id47 . -2435) (undo-tree-id48 . -2463) (undo-tree-id49 . -2463) (undo-tree-id50 . -2463) (undo-tree-id51 . -2463) (undo-tree-id52 . -2463) (undo-tree-id53 . -2463) (undo-tree-id54 . -2463) (undo-tree-id55 . -2463) (undo-tree-id56 . -2463) (undo-tree-id57 . -2463) (undo-tree-id58 . -2435) (undo-tree-id59 . -2435) (undo-tree-id60 . -1310) (undo-tree-id61 . -1310) (undo-tree-id62 . -1310) (undo-tree-id63 . -1310) (undo-tree-id64 . -1310) (undo-tree-id65 . -1275) (undo-tree-id66 . -1275) (undo-tree-id67 . -1239) (undo-tree-id68 . -1239) (undo-tree-id69 . -226)) nil (26791 28285 422295 0) 0 nil])
([nil nil ((560 . 561)) nil (26791 28285 422267 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1870 . 1871) (nil fontified nil 561 . 1871) (561 . 1871)) nil (26791 28285 422266 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -1870) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) 1871) nil (26791 28285 422263 0) 0 nil])
([nil nil ((1870 . 1872) (t 26791 28285 0 0)) nil (26792 23122 306499 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3900 . 3901) (nil fontified nil 1872 . 3901) (1872 . 3901)) nil (26792 23122 306498 0) 0 nil])
([nil nil ((#("(defparameter *use-chunked* nil) ; passe Ã  T si tu veux tester le chunked" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 14 (fontified t) 14 27 (face font-lock-variable-name-face fontified t) 27 33 (fontified t) 33 73 (face font-lock-comment-face fontified t)) . 1872)) nil (26792 23122 306496 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1870) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (#("
" 0 1 (fontified t)) . -1871) (undo-tree-id76 . -1) (undo-tree-id77 . -1) 1872) nil (26792 23122 306495 0) 0 nil])
([nil nil ((374 . 375)) nil (26792 23122 306487 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 447 . 448) (nil fontified nil 408 . 448) (nil fontified nil 402 . 408) (nil fontified nil 389 . 402) (nil fontified nil 388 . 389) (nil fontified nil 376 . 388) (nil fontified nil 375 . 376) (375 . 448)) nil (26792 23122 306485 0) 0 nil])
([nil nil ((3900 . 3901)) nil (26792 23122 306482 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -3900) (undo-tree-id73 . -1) 3901) nil (26792 23122 306476 0) 0 nil])
([nil nil ((#("nil" 0 3 (fontified t)) . -403) (undo-tree-id78 . -3) (undo-tree-id79 . -2) (undo-tree-id80 . -2) (undo-tree-id81 . -2) (undo-tree-id82 . -2) (undo-tree-id83 . -2) (undo-tree-id84 . -3) (undo-tree-id85 . -3) (undo-tree-id86 . -3) (undo-tree-id87 . -3) 406 (t 26792 23122 0 0)) nil (26792 23529 640900 0) 0 nil])
([nil nil ((403 . 404)) nil (26792 23529 640872 0) 0 nil])
([nil nil ((703 . 705) (t 26792 23529 0 0)) nil (26793 29226 347186 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 856 . 857) (nil fontified nil 705 . 857) (705 . 857)) nil (26793 29226 347185 0) 0 nil])
([nil nil ((632 . 633)) nil (26793 29226 347185 0) 0 nil])
([nil nil ((633 . 635)) nil (26793 29226 347184 0) 0 nil])
([nil nil ((#("  " 0 2 (face font-lock-comment-face fontified nil)) . -678) (706 . 707)) nil (26793 29226 347183 0) 0 nil])
([nil nil ((705 . 707)) nil (26793 29226 347182 0) 0 nil])
([nil nil ((#("

(defun write-response (flexi resp &optional (method \"GET\"))
  \"Ãcrit la rÃ©ponse HTTP correctement terminÃ©e par CRLF (sans \\\\r\\\\n littÃ©ral).\"
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (lumen.core.http:resp-headers resp))
         (body    (or (lumen.core.http:resp-body resp) \"\"))
         ;; HTTP exige une longueur en OCTETS, mÃªme si on Ã©crit en caractÃ¨res :
         (len     (length (trivial-utf-8:string-to-utf-8-bytes body))))
    ;; Status-line
    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)
    ;; Headers
    (format flexi \"Content-Length: ~D\" len)                           (crlf flexi)
    (format flexi \"Connection: close\")                                (crlf flexi)
    (dolist (h headers)
      (format flexi \"~A: ~A\" (car h) (cdr h))                         (crlf flexi))
    ;; Fin des headers (ligne vide)
    (crlf flexi)
    ;; Corps
    (unless (string= method \"HEAD\")
      (write-string body flexi))
    (finish-output flexi)))" 0 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 23 (face font-lock-function-name-face fontified t) 23 36 (fontified t) 36 45 (face font-lock-type-face fontified t) 45 54 (fontified t) 54 59 (face font-lock-string-face fontified t) 59 64 (fontified t) 64 142 (face font-lock-doc-face fontified t) 142 146 (fontified t) 146 150 (face font-lock-keyword-face fontified t) 150 307 (fontified t) 307 309 (face font-lock-string-face fontified t) 309 321 (fontified t) 321 324 (face font-lock-comment-delimiter-face fontified t) 324 392 (face font-lock-comment-face fontified t) 392 468 (fontified t) 468 471 (face font-lock-comment-delimiter-face fontified t) 471 483 (face font-lock-comment-face fontified t) 483 501 (fontified t) 501 517 (face font-lock-string-face fontified t) 517 566 (fontified t) 566 569 (face font-lock-comment-delimiter-face fontified t) 569 572 (face font-lock-comment-face fontified t) 572 577 (face font-lock-comment-face fontified t) 577 595 (fontified t) 595 615 (face font-lock-string-face fontified t) 615 678 (fontified t) 678 697 (face font-lock-string-face fontified t) 697 748 (fontified t) 748 754 (face font-lock-keyword-face fontified t) 754 787 (fontified t) 787 795 (face font-lock-string-face fontified t) 795 855 (fontified t) 855 858 (face font-lock-comment-delimiter-face fontified t) 858 887 (face font-lock-comment-face fontified t) 887 908 (fontified t) 908 911 (face font-lock-comment-delimiter-face fontified t) 911 917 (face font-lock-comment-face fontified t) 917 922 (fontified t) 922 928 (face font-lock-keyword-face fontified t) 928 945 (fontified t) 945 951 (face font-lock-string-face fontified t) 951 1013 (fontified t)) . 1087) (undo-tree-id0 . -1013) (undo-tree-id1 . -1013) (undo-tree-id2 . -1013) (undo-tree-id3 . -1013)) nil (26793 29226 347179 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -403) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) 404 (t 26793 29226 0 0)) nil (26793 31368 521455 0) 0 nil])
([nil nil ((403 . 405)) nil (26793 31368 521448 0) 0 nil])
([nil nil ((#("u" 0 1 (fontified t)) . -404) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 405) nil (26793 31368 521446 0) 0 nil])
([nil nil ((404 . 406)) nil (26793 31368 521429 0) 0 nil])
([nil nil ((#("    " 0 4 (fontified nil)) . -9433) (undo-tree-id17 . -4) (undo-tree-id18 . -4) (undo-tree-id19 . -4) (undo-tree-id20 . -4) (undo-tree-id21 . -4) (undo-tree-id22 . -4) (undo-tree-id23 . -4) (9437 . 9438) (t 26793 31368 0 0)) nil (26793 31741 405898 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12707 . 12708) (nil fontified nil 9434 . 12708) (9434 . 12708)) nil (26793 31741 405892 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -12707) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 12708) nil (26793 31741 405882 0) 0 nil])
([nil nil ((#("nil" 0 3 (fontified t)) . -403) (undo-tree-id24 . -3) (undo-tree-id25 . -3) (undo-tree-id26 . -3) (undo-tree-id27 . -3) (undo-tree-id28 . -3) (undo-tree-id29 . -3) 406 (t 26793 31741 0 0)) nil (26793 31877 992319 0) 0 nil])
([nil nil ((403 . 404)) nil (26793 31877 992302 0) 0 nil])
([nil nil ((3043 . 3045) (t 26793 31878 0 0)) nil (26793 31915 826852 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4008 . 4009) (nil fontified nil 3045 . 4009) (3045 . 4009)) nil (26793 31915 826848 0) 0 nil])
([nil nil ((9208 . 9209) (t 26793 31915 0 0)) nil (26793 31952 330250 0) 0 nil])
([nil nil ((9209 . 9211)) nil (26793 31952 330249 0) 0 nil])
([nil nil ((13675 . 13677)) nil (26793 31952 330248 0) 0 nil])
([nil nil ((13677 . 13678)) nil (26793 31952 330243 0) 0 nil])
([nil nil ((#("

#|
(defun crlf (s)
  (write-char #\\Return s)
(write-char #\\Linefeed s))
|#
" 0 1 (fontified t) 1 2 (fontified t) 2 4 (face font-lock-comment-delimiter-face fontified t) 4 5 (face font-lock-comment-face fontified t) 5 6 (face font-lock-comment-face fontified t) 6 11 (face font-lock-comment-face fontified t) 11 12 (face font-lock-comment-face fontified t) 12 16 (face font-lock-comment-face fontified t) 16 47 (face font-lock-comment-face fontified t) 47 74 (face font-lock-comment-face fontified t) 74 76 (face font-lock-comment-delimiter-face fontified t) 76 77 (fontified t)) . 631) (undo-tree-id41 . -77) (t 26793 31952 0 0)) nil (26793 38724 349675 0) 0 nil])
([nil nil ((631 . 632)) nil (26793 38724 349674 0) 0 nil])
([nil nil ((#("
#|
(defun handle-connection (socket client)
  (declare (ignore socket))
  (let ((flexi (make-http-stream client))) ; lecture/Ã©criture sur *le mÃªme flux*
    (unwind-protect
         (progn
           (multiple-value-bind (method path http-ver) (read-request-line flexi)
             (declare (ignore http-ver))
             (let* ((headers (read-headers flexi))
                    (req (make-instance 'lumen.core.http:request
                                        :method (string-upcase (or method \"GET\"))
                                        :path   (or path \"/\")
                                        :headers headers
                                        :query nil :cookies nil :params nil
                                        :body-stream flexi :context (list)))
                    (resp (funcall *handler* req)))
               (write-response flexi resp (or method \"GET\"))
               (format t \"~&[lumen] response sent (status=~A)~%\"
                       (lumen.core.http:resp-status resp)))))
      ;; â ï¸ FERMETURE : *un seul* close du flux. PAS de socket-close, PAS de shutdown.
      (ignore-errors (finish-output flexi))
      (ignore-errors (close flexi)))))

(defun handle-connection (socket client)
  (declare (ignore socket))
  (let ((flexi (make-http-stream client)))
    (unwind-protect
         (handler-case
             (progn
               ;; 1) lecture
               (multiple-value-bind (method path http-ver) (read-request-line flexi)
                 (declare (ignore http-ver))
                 (let* ((headers (read-headers flexi))
                        (req (make-instance 'lumen.core.http:request
                                            :method (string-upcase (or method \"GET\"))
                                            :path   (or path \"/\")
                                            :headers headers
                                            :query nil :cookies nil :params nil
                                            :body-stream flexi :context (list)))
                        ;; 2) pipeline / handler
                        (resp (handler-case
                                (funcall *handler* req)
                              (lumen.core.error:http-error (e)
                                (multiple-value-bind (st hs body) (funcall *error-handler* e)
                                  (make-instance 'lumen.core.http:response
                                                 :status st :headers hs :body body)))
                              (error (e)
                                (format *error-output* \"~&[lumen] handler error: ~A~%\" e)
                                (multiple-value-bind (st hs body) (funcall *error-handler* nil)
                                  (make-instance 'lumen.core.http:response
                                                 :status st :headers hs :body body))))))

                   ;; 3) Ã©criture rÃ©ponse (Content-Length, CRLF corrects)
                   (write-response flexi resp (or method \"GET\")))))

           ;; RequÃªte mal formÃ©e
           ((or reader-error simple-parse-error) (e)
            (format *error-output* \"~&[lumen] bad request: ~A~%\" e)
            (write-response flexi
                            (respond-json '(:error (:type \"bad_request\"
                                              :message \"Malformed request\")))
                            \"GET\"))

           ;; I/O cassÃ©e : on tente un 500 bestâeffort
           (stream-error (e)
            (format *error-output* \"~&[lumen] stream error: ~A~%\" e)
            (ignore-errors
              (write-response flexi
                              (respond-json '(:error (:type \"internal\"
                                               :message \"Stream error\"))
                                            :status 500)
                              \"GET\")))

           ;; Dernier recours : 500 via *error-handler*
           (error (e)
            (format *error-output* \"~&[lumen] FATAL: ~A~%\" e)
            (ignore-errors
              (multiple-value-bind (st hs body) (funcall *error-handler* nil)
                (write-response flexi
                                (make-instance 'lumen.core.http:response
                                               :status st :headers hs :body body)
                                \"GET\")))))
      ;; 4) fermeture propre (un seul flux)
      (ignore-errors (finish-output flexi))
      (ignore-errors (close flexi)))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 4 (face font-lock-comment-face fontified t) 4 5 (face font-lock-comment-face fontified t) 5 10 (face font-lock-comment-face fontified t) 10 11 (face font-lock-comment-face fontified t) 11 28 (face font-lock-comment-face fontified t) 28 48 (face font-lock-comment-face fontified t) 48 55 (face font-lock-comment-face fontified t) 55 76 (face font-lock-comment-face fontified t) 76 79 (face font-lock-comment-face fontified t) 79 116 (face font-lock-comment-face fontified t) 116 154 (face font-lock-comment-face fontified t) 154 159 (face font-lock-comment-face fontified t) 159 173 (face font-lock-comment-face fontified t) 173 184 (face font-lock-comment-face fontified t) 184 189 (face font-lock-comment-face fontified t) 189 202 (face font-lock-comment-face fontified t) 202 221 (face font-lock-comment-face fontified t) 221 271 (face font-lock-comment-face fontified t) 271 285 (face font-lock-comment-face fontified t) 285 292 (face font-lock-comment-face fontified t) 292 326 (face font-lock-comment-face fontified t) 326 330 (face font-lock-comment-face fontified t) 330 468 (face font-lock-comment-face fontified t) 468 475 (face font-lock-comment-face fontified t) 475 502 (face font-lock-comment-face fontified t) 502 507 (face font-lock-comment-face fontified t) 507 550 (face font-lock-comment-face fontified t) 550 552 (face font-lock-comment-face fontified t) 552 555 (face font-lock-comment-face fontified t) 555 567 (face font-lock-comment-face fontified t) 567 570 (face font-lock-comment-face fontified t) 570 572 (face font-lock-comment-face fontified t) 572 612 (face font-lock-comment-face fontified t) 612 620 (face font-lock-comment-face fontified t) 620 669 (face font-lock-comment-face fontified t) 669 675 (face font-lock-comment-face fontified t) 675 680 (face font-lock-comment-face fontified t) 680 688 (face font-lock-comment-face fontified t) 688 693 (face font-lock-comment-face fontified t) 693 700 (face font-lock-comment-face fontified t) 700 745 (face font-lock-comment-face fontified t) 745 757 (face font-lock-comment-face fontified t) 757 764 (face font-lock-comment-face fontified t) 764 772 (face font-lock-comment-face fontified t) 772 886 (face font-lock-comment-face fontified t) 886 887 (face font-lock-comment-face fontified t) 887 892 (face font-lock-comment-face fontified t) 892 895 (face font-lock-comment-face fontified t) 895 920 (face font-lock-comment-face fontified t) 920 959 (face font-lock-comment-face fontified t) 959 1028 (face font-lock-comment-face fontified t) 1028 1031 (face font-lock-comment-face fontified t) 1031 1109 (face font-lock-comment-face fontified t) 1109 1116 (face font-lock-comment-face fontified t) 1116 1129 (face font-lock-comment-face fontified t) 1129 1160 (face font-lock-comment-face fontified t) 1160 1173 (face font-lock-comment-face fontified t) 1173 1192 (face font-lock-comment-face fontified t) 1192 1193 (face font-lock-comment-face fontified t) 1193 1194 (face font-lock-comment-face fontified t) 1194 1199 (face font-lock-comment-face fontified t) 1199 1200 (face font-lock-comment-face fontified t) 1200 1217 (face font-lock-comment-face fontified t) 1217 1237 (face font-lock-comment-face fontified t) 1237 1244 (face font-lock-comment-face fontified t) 1244 1265 (face font-lock-comment-face fontified t) 1265 1268 (face font-lock-comment-face fontified t) 1268 1310 (face font-lock-comment-face fontified t) 1310 1324 (face font-lock-comment-face fontified t) 1324 1335 (face font-lock-comment-face fontified t) 1335 1347 (face font-lock-comment-face fontified t) 1347 1362 (face font-lock-comment-face fontified t) 1362 1367 (face font-lock-comment-face fontified t) 1367 1383 (face font-lock-comment-face fontified t) 1383 1386 (face font-lock-comment-face fontified t) 1386 1397 (face font-lock-comment-face fontified t) 1397 1413 (face font-lock-comment-face fontified t) 1413 1432 (face font-lock-comment-face fontified t) 1432 1500 (face font-lock-comment-face fontified t) 1500 1504 (face font-lock-comment-face fontified t) 1504 1507 (face font-lock-comment-face fontified t) 1507 1527 (face font-lock-comment-face fontified t) 1527 1545 (face font-lock-comment-face fontified t) 1545 1549 (face font-lock-comment-face fontified t) 1549 1695 (face font-lock-comment-face fontified t) 1695 1702 (face font-lock-comment-face fontified t) 1702 1729 (face font-lock-comment-face fontified t) 1729 1734 (face font-lock-comment-face fontified t) 1734 1771 (face font-lock-comment-face fontified t) 1771 1781 (face font-lock-comment-face fontified t) 1781 1786 (face font-lock-comment-face fontified t) 1786 1798 (face font-lock-comment-face fontified t) 1798 1801 (face font-lock-comment-face fontified t) 1801 1803 (face font-lock-comment-face fontified t) 1803 1847 (face font-lock-comment-face fontified t) 1847 1855 (face font-lock-comment-face fontified t) 1855 1908 (face font-lock-comment-face fontified t) 1908 1914 (face font-lock-comment-face fontified t) 1914 1919 (face font-lock-comment-face fontified t) 1919 1927 (face font-lock-comment-face fontified t) 1927 1932 (face font-lock-comment-face fontified t) 1932 1939 (face font-lock-comment-face fontified t) 1939 1988 (face font-lock-comment-face fontified t) 1988 2000 (face font-lock-comment-face fontified t) 2000 2007 (face font-lock-comment-face fontified t) 2007 2015 (face font-lock-comment-face fontified t) 2015 2049 (face font-lock-comment-face fontified t) 2049 2052 (face font-lock-comment-face fontified t) 2052 2072 (face font-lock-comment-face fontified t) 2072 2074 (face font-lock-comment-face fontified t) 2074 2105 (face font-lock-comment-face fontified t) 2105 2117 (face font-lock-comment-face fontified t) 2117 2270 (face font-lock-comment-face fontified t) 2270 2289 (face font-lock-comment-face fontified t) 2289 2395 (face font-lock-comment-face fontified t) 2395 2406 (face font-lock-comment-face fontified t) 2406 2455 (face font-lock-comment-face fontified t) 2455 2462 (face font-lock-comment-face fontified t) 2462 2466 (face font-lock-comment-face fontified t) 2466 2474 (face font-lock-comment-face fontified t) 2474 2478 (face font-lock-comment-face fontified t) 2478 2483 (face font-lock-comment-face fontified t) 2483 2523 (face font-lock-comment-face fontified t) 2523 2528 (face font-lock-comment-face fontified t) 2528 2588 (face font-lock-comment-face fontified t) 2588 2619 (face font-lock-comment-face fontified t) 2619 2656 (face font-lock-comment-face fontified t) 2656 2675 (face font-lock-comment-face fontified t) 2675 2693 (face font-lock-comment-face fontified t) 2693 2719 (face font-lock-comment-face fontified t) 2719 2843 (face font-lock-comment-face fontified t) 2843 2850 (face font-lock-comment-face fontified t) 2850 2854 (face font-lock-comment-face fontified t) 2854 2862 (face font-lock-comment-face fontified t) 2862 2866 (face font-lock-comment-face fontified t) 2866 2871 (face font-lock-comment-face fontified t) 2871 2903 (face font-lock-comment-face fontified t) 2903 2906 (face font-lock-comment-face fontified t) 2906 2958 (face font-lock-comment-face fontified t) 2958 3015 (face font-lock-comment-face fontified t) 3015 3020 (face font-lock-comment-face fontified t) 3020 3038 (face font-lock-comment-face fontified t) 3038 3041 (face font-lock-comment-face fontified t) 3041 3060 (face font-lock-comment-face fontified t) 3060 3148 (face font-lock-comment-face fontified t) 3148 3177 (face font-lock-comment-face fontified t) 3177 3259 (face font-lock-comment-face fontified t) 3259 3265 (face font-lock-comment-face fontified t) 3265 3267 (face font-lock-comment-face fontified t) 3267 3272 (face font-lock-comment-face fontified t) 3272 3273 (face font-lock-comment-face fontified t) 3273 3286 (face font-lock-comment-face fontified t) 3286 3303 (face font-lock-comment-face fontified t) 3303 3333 (face font-lock-comment-face fontified t) 3333 3341 (face font-lock-comment-face fontified t) 3341 3342 (face font-lock-comment-face fontified t) 3342 3361 (face font-lock-comment-face fontified t) 3361 3365 (face font-lock-comment-face fontified t) 3365 3393 (face font-lock-comment-face fontified t) 3393 3398 (face font-lock-comment-face fontified t) 3398 3413 (face font-lock-comment-face fontified t) 3413 3416 (face font-lock-comment-face fontified t) 3416 3457 (face font-lock-comment-face fontified t) 3457 3521 (face font-lock-comment-face fontified t) 3521 3551 (face font-lock-comment-face fontified t) 3551 3568 (face font-lock-comment-face fontified t) 3568 3574 (face font-lock-comment-face fontified t) 3574 3581 (face font-lock-comment-face fontified t) 3581 3582 (face font-lock-comment-face fontified t) 3582 3664 (face font-lock-comment-face fontified t) 3664 3670 (face font-lock-comment-face fontified t) 3670 3672 (face font-lock-comment-face fontified t) 3672 3677 (face font-lock-comment-face fontified t) 3677 3678 (face font-lock-comment-face fontified t) 3678 3688 (face font-lock-comment-face fontified t) 3688 3736 (face font-lock-comment-face fontified t) 3736 3744 (face font-lock-comment-face fontified t) 3744 3745 (face font-lock-comment-face fontified t) 3745 3759 (face font-lock-comment-face fontified t) 3759 3806 (face font-lock-comment-face fontified t) 3806 3813 (face font-lock-comment-face fontified t) 3813 3849 (face font-lock-comment-face fontified t) 3849 3854 (face font-lock-comment-face fontified t) 3854 3870 (face font-lock-comment-face fontified t) 3870 3873 (face font-lock-comment-face fontified t) 3873 3915 (face font-lock-comment-face fontified t) 3915 3927 (face font-lock-comment-face fontified t) 3927 3932 (face font-lock-comment-face fontified t) 3932 3972 (face font-lock-comment-face fontified t) 3972 3995 (face font-lock-comment-face fontified t) 3995 4012 (face font-lock-comment-face fontified t) 4012 4025 (face font-lock-comment-face fontified t) 4025 4041 (face font-lock-comment-face fontified t) 4041 4060 (face font-lock-comment-face fontified t) 4060 4262 (face font-lock-comment-face fontified t) 4262 4269 (face font-lock-comment-face fontified t) 4269 4273 (face font-lock-comment-face fontified t) 4273 4281 (face font-lock-comment-face fontified t) 4281 4285 (face font-lock-comment-face fontified t) 4285 4290 (face font-lock-comment-face fontified t) 4290 4329 (face font-lock-comment-face fontified t) 4329 4334 (face font-lock-comment-face fontified t) 4334 4346 (face font-lock-comment-face fontified t) 4346 4349 (face font-lock-comment-face fontified t) 4349 4384 (face font-lock-comment-face fontified t) 4384 4391 (face font-lock-comment-face fontified t) 4391 4404 (face font-lock-comment-face fontified t) 4404 4428 (face font-lock-comment-face fontified t) 4428 4435 (face font-lock-comment-face fontified t) 4435 4448 (face font-lock-comment-face fontified t) 4448 4466 (face font-lock-comment-face fontified t) 4466 4467 (face font-lock-comment-face fontified t) 4467 4469 (face font-lock-comment-delimiter-face fontified t)) . 9132) (undo-tree-id40 . -4469)) nil (26793 38724 349673 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -9131) (undo-tree-id38 . -1) (undo-tree-id39 . -1) 9132) nil (26793 38724 349671 0) 0 nil])
([nil nil ((#("(defun write-response (flexi resp &optional (method \"GET\"))
  \"Ecrit la rÃ©ponse HTTP sur FLEXI. Si *use-chunked* est T, utilise Transfer-Encoding: chunked.\"
  (let* ((status   (lumen.core.http:resp-status resp))
         (headers  (copy-list (lumen.core.http:resp-headers resp))) ; on peut y ajouter des champs
         (body     (or (lumen.core.http:resp-body resp) \"\"))
         (body-bytes (trivial-utf-8:string-to-utf-8-bytes body))
         (len      (length body-bytes)))

    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)
    (format flexi \"Connection: close\") (crlf flexi)

    (if *use-chunked*
        (progn
          ;; Mode CHUNKED: pas de Content-Length
          (format flexi \"Transfer-Encoding: chunked\") (crlf flexi))
        (progn
          ;; Mode classique: Content-Length (octets)
          (format flexi \"Content-Length: ~D\" len) (crlf flexi)))

    ;; Ecrire les headers fournis
    (let ((have-ct (some (lambda (h) (string-equal (car h) \"content-type\")) headers)))
      (dolist (h headers)
        (format flexi \"~A: ~A\" (car h) (cdr h)) (crlf flexi))
      (unless have-ct
        (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))

    ;; Fin des en-tÃªtes
    (crlf flexi)

    ;; Corps
    (unless (string= method \"HEAD\")
      (if *use-chunked*
          ;; Un seul chunk (len>0) puis chunk final \"0\"
          (progn
            (format flexi \"~X\" len) (crlf flexi)  ; taille en hexa
            (write-string body flexi)             ; chunk data
            (crlf flexi)                          ; fin chunk
            (write-string \"0\" flexi)              ; fin des chunks
            (crlf flexi) (crlf flexi))
          ;; Non chunked : on Ã©crit simplement le body
          (write-string body flexi)))

    (finish-output flexi)

    ;; Logs debug utiles
    (format t \"~&[lumen] write-response: status=~A len=~D chunked=~A~%\"
            status len *use-chunked*)))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 21 (face font-lock-function-name-face fontified t) 21 34 (fontified t) 34 35 (face font-lock-type-face fontified t) 35 43 (face font-lock-type-face fontified t) 43 52 (fontified t) 52 57 (face font-lock-string-face fontified t) 57 60 (fontified t) 60 62 (fontified t) 62 78 (face font-lock-doc-face fontified t) 78 106 (face font-lock-doc-face fontified t) 106 156 (face font-lock-doc-face fontified t) 156 157 (fontified t) 157 160 (fontified t) 160 164 (face font-lock-keyword-face fontified t) 164 230 (fontified t) 230 260 (fontified t) 260 280 (fontified t) 280 311 (face font-lock-comment-face fontified t) 311 367 (fontified t) 367 369 (face font-lock-string-face fontified t) 369 497 (fontified t) 497 513 (face font-lock-string-face fontified t) 513 576 (fontified t) 576 595 (face font-lock-string-face fontified t) 595 616 (fontified t) 616 618 (face font-lock-keyword-face fontified t) 618 642 (fontified t) 642 647 (face font-lock-keyword-face fontified t) 647 658 (fontified t) 658 661 (face font-lock-comment-delimiter-face fontified t) 661 697 (face font-lock-comment-face fontified t) 697 721 (fontified t) 721 749 (face font-lock-string-face fontified t) 749 774 (fontified t) 774 779 (face font-lock-keyword-face fontified t) 779 790 (fontified t) 790 793 (face font-lock-comment-delimiter-face fontified t) 793 833 (face font-lock-comment-face fontified t) 833 857 (fontified t) 857 858 (face font-lock-string-face fontified t) 858 877 (face font-lock-string-face fontified t) 877 898 (fontified t) 898 903 (fontified t) 903 906 (face font-lock-comment-delimiter-face fontified t) 906 933 (face font-lock-comment-face fontified t) 933 938 (fontified t) 938 941 (face font-lock-keyword-face fontified t) 941 959 (fontified t) 959 965 (face font-lock-keyword-face fontified t) 965 992 (fontified t) 992 1006 (face font-lock-string-face fontified t) 1006 1027 (fontified t) 1027 1033 (face font-lock-keyword-face fontified t) 1033 1068 (fontified t) 1068 1076 (face font-lock-string-face fontified t) 1076 1115 (fontified t) 1115 1120 (face font-lock-keyword-face fontified t) 1120 1121 (face font-lock-keyword-face fontified t) 1121 1130 (fontified t) 1130 1152 (fontified t) 1152 1193 (face font-lock-string-face fontified t) 1193 1215 (fontified t) 1215 1218 (face font-lock-comment-delimiter-face fontified t) 1218 1235 (face font-lock-comment-face fontified t) 1235 1257 (fontified t) 1257 1260 (face font-lock-comment-delimiter-face fontified t) 1260 1266 (face font-lock-comment-face fontified t) 1266 1271 (fontified t) 1271 1277 (face font-lock-keyword-face fontified t) 1277 1294 (fontified t) 1294 1300 (face font-lock-string-face fontified t) 1300 1309 (fontified t) 1309 1311 (face font-lock-keyword-face fontified t) 1311 1336 (fontified t) 1336 1339 (face font-lock-comment-delimiter-face fontified t) 1339 1382 (face font-lock-comment-face fontified t) 1382 1393 (fontified t) 1393 1398 (face font-lock-keyword-face fontified t) 1398 1425 (fontified t) 1425 1429 (face font-lock-string-face fontified t) 1429 1449 (fontified t) 1449 1466 (face font-lock-comment-face fontified t) 1466 1499 (fontified t) 1499 1516 (fontified t) 1516 1529 (face font-lock-comment-face fontified t) 1529 1579 (fontified t) 1579 1591 (face font-lock-comment-face fontified t) 1591 1617 (fontified t) 1617 1620 (face font-lock-string-face fontified t) 1620 1641 (fontified t) 1641 1657 (face font-lock-comment-face fontified t) 1657 1658 (face font-lock-comment-face fontified t) 1658 1707 (fontified t) 1707 1710 (face font-lock-comment-delimiter-face fontified t) 1710 1752 (face font-lock-comment-face fontified t) 1752 1822 (fontified t) 1822 1825 (face font-lock-comment-delimiter-face fontified t) 1825 1843 (face font-lock-comment-face fontified t) 1843 1857 (fontified t) 1857 1914 (face font-lock-string-face fontified t) 1914 1915 (fontified t) 1915 1955 (fontified t)) . -1013) (undo-tree-id36 . -1955) (undo-tree-id37 . -1210) 2968) nil (26793 38724 349668 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1012) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) 1013) nil (26793 38724 349665 0) 0 nil])
([nil nil ((#("

(defun make-http-stream (client)
  (let* ((raw   (usocket:socket-stream client))     ; flux usocket
         (bin   (ensure-binary-stream raw))         ; â garanti binaire sur SBCL
         (xfmt  (flexi-streams:make-external-format :utf-8 :eol-style :crlf)))
    (flexi-streams:make-flexi-stream bin :external-format xfmt)))
" 0 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 25 (face font-lock-function-name-face fontified t) 25 38 (fontified t) 38 42 (face font-lock-keyword-face fontified t) 42 87 (fontified t) 87 102 (face font-lock-comment-face fontified t) 102 154 (fontified t) 154 183 (face font-lock-comment-face fontified t) 183 235 (fontified t) 235 241 (face font-lock-builtin-face fontified t) 241 242 (fontified t) 242 252 (face font-lock-builtin-face fontified t) 252 253 (fontified t) 253 258 (face font-lock-builtin-face fontified t) 258 303 (fontified t) 303 319 (face font-lock-builtin-face fontified t) 319 328 (fontified t)) . 2794) (undo-tree-id32 . -328)) nil (26793 38724 349661 0) 0 nil])
([nil nil ((2794 . 2795)) nil (26793 38724 349659 0) 0 nil])
([nil nil ((#("

(defun read-headers (stream)
  (loop with headers = '()
	for line = (read-line stream nil nil)
	while (and line (> (length line) 0))
	for (k v) = (uiop:split-string line :separator \": \")
	do (push (cons (string-downcase k) v) headers)
	finally (return (nreverse headers))))" 0 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 21 (face font-lock-function-name-face fontified t) 21 25 (fontified t) 25 31 (fontified t) 31 34 (fontified t) 34 38 (face font-lock-keyword-face fontified t) 38 64 (fontified t) 64 66 (fontified t) 66 97 (fontified t) 97 172 (fontified t) 172 182 (face font-lock-builtin-face fontified t) 182 183 (fontified t) 183 187 (face font-lock-string-face fontified t) 187 247 (fontified t) 247 253 (face font-lock-keyword-face fontified t) 253 275 (fontified t)) . 3085) (undo-tree-id31 . -275)) nil (26793 38724 349658 0) 0 nil])
([nil nil ((5308 . 5315)) nil (26793 38724 349654 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6146 . 6147) (nil fontified nil 5315 . 6147) (5315 . 6147)) nil (26793 38724 349653 0) 0 nil])
([nil nil ((#("
             (let* ((headers (read-headers flexi))
                    (req (make-instance 'lumen.core.http:request
                                        :method (string-upcase (or method \"GET\"))
                                        :path   (or path \"/\")
                                        :headers headers
                                        :query nil :cookies nil :params nil
                                        :body-stream flexi :context (list)))
                    (resp (funcall *handler* req)))
               (write-response flexi resp (or method \"GET\"))
               (format t \"~&[lumen] response sent (status=~A)~%\"
                       (lumen.core.http:resp-status resp))))" 0 1 (fontified t) 1 15 (fontified t) 15 19 (face font-lock-keyword-face fontified t) 19 157 (fontified t) 157 164 (face font-lock-builtin-face fontified t) 164 191 (fontified t) 191 196 (face font-lock-string-face fontified t) 196 239 (fontified t) 239 244 (face font-lock-builtin-face fontified t) 244 254 (fontified t) 254 256 (fontified t) 256 259 (face font-lock-string-face fontified t) 259 261 (fontified t) 261 301 (fontified t) 301 309 (face font-lock-builtin-face fontified t) 309 317 (fontified t) 317 318 (fontified t) 318 358 (fontified t) 358 364 (face font-lock-builtin-face fontified t) 364 369 (fontified t) 369 377 (face font-lock-builtin-face fontified t) 377 382 (fontified t) 382 389 (face font-lock-builtin-face fontified t) 389 434 (fontified t) 434 446 (face font-lock-builtin-face fontified t) 446 453 (fontified t) 453 461 (face font-lock-builtin-face fontified t) 461 576 (fontified t) 576 581 (face font-lock-string-face fontified t) 581 599 (fontified t) 599 609 (fontified t) 609 648 (face font-lock-string-face fontified t) 648 649 (fontified t) 649 709 (fontified t)) . -6147) (undo-tree-id30 . -709) 6856) nil (26794 919 536659 0) 0 nil])
([nil nil ((#("path" 0 4 (fontified t)) . -5227) (undo-tree-id3 . -4) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -4) (undo-tree-id11 . -4) (undo-tree-id12 . -4) (undo-tree-id13 . -4) 5231 (t 26793 38724 0 0)) nil (26794 937 435432 0) 0 nil] [nil nil ((#("method" 0 6 (fontified t)) . -5220) (undo-tree-id0 . -6) (undo-tree-id1 . -4) 5226 (t 26793 38724 0 0)) ((5220 . 5226)) (26794 917 951440 0) 0 nil])
([nil nil ((5227 . 5230)) nil (26794 937 435415 0) 0 nil])
([nil nil ((5220 . 5223)) ((#("uri" 0 3 (fontified t)) . 5220) (undo-tree-id2 . -3)) (26794 917 951386 0) 0 nil])
([nil nil ((5941 . 5950) (#("            " 0 12 (fontified t)) . 5941) (5883 . 5891) (#("    " 0 4 (fontified t)) . 5883) (5829 . 5837) (#("    " 0 4 (fontified t)) . 5829) (5791 . 5797) (#("         " 0 9 (fontified t)) . 5791) (5749 . 5754) (#("                             " 0 29 (fontified t)) . 5749) (5719 . 5724) (#("                             " 0 29 (fontified t)) . 5719) (5672 . 5673) (#("      " 0 6 (fontified nil)) . 5672) (5650 . 5655) (#("                             " 0 29 (fontified t)) . 5650) (5628 . 5633) (#("                             " 0 29 (fontified t)) . 5628) (5605 . 5610) (#("                             " 0 29 (fontified t)) . 5605) (5558 . 5563) (#("                             " 0 29 (fontified t)) . 5558) (5507 . 5513) (#("         " 0 9 (fontified t)) . 5507) (5470 . 5476) (#("         " 0 9 (fontified t)) . 5470) (5418 . 5424) (#("         " 0 9 (fontified t)) . 5418) (5357 . 5363) (#("         " 0 9 (fontified t)) . 5357) 5005) nil (26794 937 435410 0) 0 nil])
nil
([nil nil ((5315 . 5316) (t 26794 937 0 0)) nil (26794 1122 972256 0) 0 nil])
([nil nil ((#("d" 0 1 (fontified t)) . -5315) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) 5316) nil (26794 1122 972253 0) 0 nil])
([nil nil ((#(":direction" 0 10 (face font-lock-builtin-face fontified t)) . -6247) (undo-tree-id2 . -10) 6257 (t 26794 1122 0 0)) nil (26795 15182 394208 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -6246) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 6247) nil (26795 15182 394203 0) 0 nil])
([nil nil ((580 . 581) (t 26795 15182 0 0)) nil (26796 41708 480891 0) 0 nil])
([nil nil ((581 . 582)) nil (26796 41708 480890 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1294 . 1295) (nil fontified nil 582 . 1295) (582 . 1295)) nil (26796 41708 480890 0) 0 nil])
([nil nil ((1786 . 1787)) nil (26796 41708 480889 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1804 . 1805) (nil fontified nil 1787 . 1805) (1787 . 1805)) nil (26796 41708 893712 0) 0 nil])
([nil nil ((2261 . 2266)) nil (26796 44358 927195 0) 0 nil] [nil nil ((nil rear-nonsticky nil 2502 . 2503) (nil fontified nil 2266 . 2503) (2266 . 2503)) ((#("(format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
    (when keep-alive-p
      (format flexi \"Keep-Alive: timeout=~D, max=~D\"
              (truncate *keep-alive-timeout*) *keep-alive-max*) (crlf flexi))" 0 14 (fontified nil) 14 30 (face font-lock-string-face fontified nil) 30 32 (fontified nil) 32 34 (face font-lock-keyword-face fontified nil) 34 48 (fontified nil) 48 60 (face font-lock-string-face fontified nil) 60 61 (fontified nil) 61 68 (face font-lock-string-face fontified nil) 68 89 (fontified nil) 89 93 (face font-lock-keyword-face fontified nil) 93 127 (fontified nil) 127 159 (face font-lock-string-face fontified nil) 159 160 (fontified nil) 160 224 (fontified nil) 224 236 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified nil) 236 237 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" rear-nonsticky nil fontified nil)) . 2266) (undo-tree-id2 . -237) (undo-tree-id3 . -160) (undo-tree-id4 . -160) (nil fontified t 2425 . 2426) (nil fontified t 2393 . 2425) (nil fontified t 2359 . 2393) (nil fontified t 2355 . 2359) (nil fontified t 2334 . 2355) (nil fontified t 2327 . 2334) (nil fontified t 2326 . 2327) (nil fontified t 2314 . 2326) (nil fontified t 2300 . 2314) (nil fontified t 2298 . 2300) (nil fontified t 2296 . 2298) (nil fontified t 2280 . 2296) (nil fontified t 2266 . 2280) (nil rear-nonsticky t 2502 . 2503)) (26796 41708 480953 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2502 . 2503) (nil fontified nil 2266 . 2503) (2266 . 2503)) nil (26796 44358 927195 0) 0 nil])
([nil nil ((2503 . 2508)) ((#("
    " 0 5 (fontified t)) . 2503) (undo-tree-id0 . -5) (undo-tree-id1 . -1)) (26796 41708 480883 0) 0 nil])
([nil nil ((#("
    (format flexi \"Connection: close\")      (crlf flexi)" 0 1 (fontified t) 1 5 (fontified t) 5 19 (fontified t) 19 38 (face font-lock-string-face fontified t) 38 57 (fontified t)) . -2503) (undo-tree-id7 . -57) 2560) nil (26796 44358 927194 0) 0 nil])
nil
([nil nil ((#("
" 0 1 (fontified t)) . 2425)) nil (26796 44358 927192 0) 0 nil])
([nil nil ((2425 . 2426)) nil (26796 44358 927192 0) 0 nil])
([nil nil ((2491 . 2496) (2489 . 2490)) nil (26796 44358 927191 0) 0 nil])
([nil nil ((6040 . 6042)) nil (26796 44358 927191 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6073 . 6074) (nil fontified nil 6042 . 6074) (6042 . 6074)) nil (26796 44358 927190 0) 0 nil])
([nil nil ((#(" ; Flexi au-dessus dâun FD binaire" 0 1 (fontified t) 1 34 (face font-lock-comment-face fontified t)) . 6075)) nil (26796 44358 927190 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6073 . 6074) (nil fontified nil 6041 . 6074) (nil fontified nil 6040 . 6041) (6040 . 6074)) nil (26796 44358 927189 0) 0 nil])
([nil nil ((6129 . 6132)) nil (26796 44358 927188 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6358 . 6359) (nil fontified nil 6132 . 6359) (6132 . 6359)) nil (26796 44358 927188 0) 0 nil])
([nil nil ((6455 . 6462)) nil (26796 44358 927187 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6502 . 6503) (nil fontified nil 6462 . 6503) (6462 . 6503)) nil (26796 44358 927186 0) 0 nil])
([nil nil ((#("
             (declare (ignore http-ver))" 0 1 (fontified t) 1 15 (fontified t) 15 22 (face font-lock-keyword-face fontified t) 22 41 (fontified t)) . 6503) (undo-tree-id6 . -41)) nil (26796 44358 927185 0) 0 nil])
([nil nil ((7023 . 7030)) nil (26796 44358 927184 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7628 . 7629) (nil fontified nil 7030 . 7629) (7030 . 7629)) nil (26796 44358 927183 0) 0 nil])
([nil nil ((7610 . 7620) (#(" " 0 1 (fontified nil)) . 7610) (7609 . 7610)) nil (26796 44358 927182 0) 0 nil])
([nil nil ((7639 . 7646)) nil (26796 44358 927182 0) 0 nil])
([nil nil ((7701 . 7710)) nil (26796 44358 927181 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7807 . 7808) (nil fontified nil 7710 . 7808) (7710 . 7808)) nil (26796 44358 927180 0) 0 nil])
([nil nil ((#("(write-response flexi resp (or method \"GET\"))
	       " 0 38 (fontified t) 38 43 (face font-lock-string-face fontified t) 43 46 (fontified t) 46 54 (fontified t)) . -7656) (undo-tree-id5 . -54) 7710) nil (26796 44358 927177 0) 0 nil])
([nil nil ((8404 . 8405) (t 26796 44358 0 0)) nil (26796 44408 132654 0) 0 nil])
([nil nil ((6005 . 6006) (t 26796 44408 0 0)) nil (26796 44505 432981 0) 0 nil])
([nil nil ((8371 . 8375) ("      " . 8371) (8312 . 8316) ("      " . 8312) (8262 . 8266) ("      " . 8262) (8213 . 8217) ("      " . 8213) (8196 . 8200) ("      " . 8196) (8144 . 8148) ("      " . 8144) (8083 . 8087) ("      " . 8083) (8046 . 8050) ("      " . 8046) (8004 . 8008) ("      " . 8004) (7937 . 7941) ("      " . 7937) (7886 . 7890) ("      " . 7886) (7845 . 7847) ("       " . 7845) (7791 . 7793) ("       " . 7791) (7755 . 7758) ("               " . 7755) (7701 . 7703) ("       " . 7701) (undo-tree-id16 . -7) (7696 . 7698) (7668 . 7670) (7607 . 7609) (7538 . 7540) (7465 . 7467) (7386 . 7388) (7322 . 7324) (7235 . 7237) (7147 . 7149) (7062 . 7064) (7023 . 7025) (6978 . 6980) (6946 . 6948) (6875 . 6877) (6851 . 6853) (6826 . 6828) (6777 . 6779) (6725 . 6727) (6686 . 6688) (6632 . 6634) (6569 . 6571) (6518 . 6520) (6468 . 6470) (6391 . 6393) (6371 . 6373) (6077 . 6078) 5930) nil (26796 44505 432978 0) 0 nil])
([nil nil ((7885 . 7886)) nil (26796 44505 432972 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -8408) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) 8409) nil (26796 44505 432971 0) 0 nil])
([nil nil ((#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -8398) (8398 . 8399) (#("	" 0 1 (fontified nil)) . 8398) (8392 . 8398) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -8337) (8337 . 8338) (#("	" 0 1 (fontified nil)) . 8337) (8331 . 8337) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -8285) (8285 . 8286) (#("	" 0 1 (fontified nil)) . 8285) (8279 . 8285) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -8234) (8234 . 8235) (#("	" 0 1 (fontified nil)) . 8234) (8228 . 8234) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -8215) (8215 . 8216) (#("	" 0 1 (fontified nil)) . 8215) (8209 . 8215) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -8161) (8161 . 8162) (#("	" 0 1 (fontified nil)) . 8161) (8155 . 8161) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -8098) (8098 . 8099) (#("	" 0 1 (fontified nil)) . 8098) (8092 . 8098) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -8059) (8059 . 8060) (#("	" 0 1 (fontified nil)) . 8059) (8053 . 8059) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -8015) (8015 . 8016) (#("	" 0 1 (fontified nil)) . 8015) (8009 . 8015) (#("	   " 0 1 (face font-lock-comment-face fontified nil) 1 4 (fontified nil)) . -7946) (7946 . 7947) (#("	" 0 1 (fontified nil)) . 7946) (7940 . 7946) (#("	   " 0 1 (fontified nil) 1 4 (fontified nil)) . -7893) (7893 . 7894) (#("	" 0 1 (fontified nil)) . 7893) (7887 . 7893) 5930) nil (26796 44505 432949 0) 0 nil])
([nil nil ((#("
(defun header (headers name)
  (cdr (assoc (string-downcase name) headers :test #'string=)))" 0 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 75 (fontified t) 75 80 (face font-lock-builtin-face fontified t) 80 93 (fontified t)) . 808) (undo-tree-id17 . -93) (undo-tree-id18 . -9) (undo-tree-id19 . -9) (undo-tree-id20 . -9) (undo-tree-id21 . -9) (undo-tree-id22 . -9) (undo-tree-id23 . -8) (undo-tree-id24 . -14) (undo-tree-id25 . -14) (undo-tree-id26 . -8) (undo-tree-id27 . -14) (undo-tree-id28 . -14) (undo-tree-id29 . -14) (undo-tree-id30 . -14) (undo-tree-id31 . -14) (undo-tree-id32 . -14) (undo-tree-id33 . -14) (undo-tree-id34 . -14) (undo-tree-id35 . -14) (undo-tree-id36 . -14) (undo-tree-id37 . -14) (undo-tree-id38 . -14) (undo-tree-id39 . -22) (undo-tree-id40 . -22) (undo-tree-id41 . -22) (undo-tree-id42 . -22) (undo-tree-id43 . -22) (undo-tree-id44 . -22) (undo-tree-id45 . -22) (undo-tree-id46 . -22) (undo-tree-id47 . -73) (undo-tree-id48 . -73) (undo-tree-id49 . -73) (undo-tree-id50 . -73) (undo-tree-id51 . -8) (undo-tree-id52 . -14) (undo-tree-id53 . -8) (undo-tree-id54 . -8) (undo-tree-id55 . -8) (undo-tree-id56 . -17) (undo-tree-id57 . -17) (undo-tree-id58 . -17) (undo-tree-id59 . -17) (undo-tree-id60 . -14) (undo-tree-id61 . -8) (undo-tree-id62 . -16) (undo-tree-id63 . -16) (undo-tree-id64 . -16) (undo-tree-id65 . -16) (undo-tree-id66 . -16) (undo-tree-id67 . -16) (undo-tree-id68 . -16) (undo-tree-id69 . -16) (undo-tree-id70 . -16) (undo-tree-id71 . -16) (undo-tree-id72 . -16) (undo-tree-id73 . -16) (undo-tree-id74 . -16) (undo-tree-id75 . -16) (undo-tree-id76 . -16) (undo-tree-id77 . -16) (undo-tree-id78 . -16) (undo-tree-id79 . -16) (undo-tree-id80 . -93) (undo-tree-id81 . -93) (undo-tree-id82 . -93) (undo-tree-id83 . -8) (undo-tree-id84 . -93) (t 26796 44505 0 0)) nil (26796 44689 88589 0) 0 nil])
([nil nil ((#("(or " 0 4 (fontified t)) . -6709) (undo-tree-id0 . -4) 6713 (t 26796 44689 0 0)) nil (26797 30790 907830 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . 6715) (#("\"" 0 1 (face font-lock-string-face fontified t)) . 6715) (#("T" 0 1 (fontified t)) . 6715) (#("E" 0 1 (fontified t)) . 6715) (#("G" 0 1 (fontified t)) . 6715) (#("\"" 0 1 (face font-lock-string-face fontified t)) . 6715) (#(" " 0 1 (fontified t)) . 6715)) nil (26797 30790 907815 0) 0 nil])
([nil nil ((750 . 752) (t 26797 30790 0 0)) nil (26797 43105 499059 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 757 . 758) (nil fontified nil 752 . 758) (752 . 758)) nil (26797 43105 499058 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -752) (undo-tree-id2 . -1) (#("b" 0 1 (fontified t)) . -753) (undo-tree-id3 . -1) (#("a" 0 1 (fontified t)) . -754) (undo-tree-id4 . -1) (#("y" 0 1 (fontified t)) . -755) (undo-tree-id5 . -1) (#("a" 0 1 (fontified t)) . -756) (undo-tree-id6 . -1) (#("o" 0 1 (rear-nonsticky t fontified t)) . -757) (undo-tree-id7 . -1) 758) nil (26797 43105 499057 0) 0 nil])
([nil nil ((752 . 754)) nil (26797 43105 499049 0) 0 nil])
([nil nil ((754 . 755)) nil (26797 43105 499049 0) 0 nil])
([nil nil ((755 . 761)) nil (26797 43105 499048 0) 0 nil])
([nil nil ((761 . 762)) nil (26797 43105 499048 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1252 . 1253) (nil fontified nil 762 . 1253) (762 . 1253)) nil (26797 43105 499047 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1253)) nil (26797 43105 499046 0) 0 nil])
([nil nil ((1704 . 1706)) nil (26797 43105 499046 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2196 . 2197) (nil fontified nil 1706 . 2197) (1706 . 2197)) nil (26797 43105 499046 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -2196) (undo-tree-id1 . -1) 2197) nil (26797 43105 499045 0) 0 nil])
([nil nil ((4911 . 4913)) nil (26797 43105 499035 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5430 . 5431) (nil fontified nil 4913 . 5431) (4913 . 5431)) nil (26797 43105 499034 0) 0 nil])
([nil nil ((4621 . 4622)) nil (26797 43105 499034 0) 0 nil])
([nil nil ((4622 . 4624)) nil (26797 43105 499033 0) 0 nil])
([nil nil ((4915 . 4917)) nil (26797 43105 499033 0) 0 nil])
([nil nil ((4917 . 4918)) nil (26797 43105 499032 0) 0 nil])
([nil nil ((10082 . 10084)) nil (26797 43105 499032 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10363 . 10364) (nil fontified nil 10084 . 10364) (10084 . 10364)) nil (26797 43105 499031 0) 0 nil])
([nil nil ((9847 . 9848)) nil (26797 43105 499031 0) 0 nil])
([nil nil ((9848 . 9850)) nil (26797 43105 499030 0) 0 nil])
([nil nil ((10086 . 10088)) nil (26797 43105 499030 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7404 . 7405) (nil fontified nil 7396 . 7405) (7396 . 7405)) nil (26797 43105 499029 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7483 . 7484) (nil fontified nil 7475 . 7484) (7475 . 7484)) nil (26797 43105 499029 0) 0 nil])
([nil nil ((10427 . 10428)) nil (26797 43105 499028 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10490 . 10491) (nil fontified nil 10428 . 10491) (10428 . 10491)) nil (26797 43105 499028 0) 0 nil])
([nil nil ((11037 . 11039)) nil (26797 43105 499027 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12377 . 12378) (nil fontified nil 11039 . 12378) (11039 . 12378)) nil (26797 43105 499027 0) 0 nil])
([nil nil ((11187 . 11189) (#(" " 0 1 (fontified t)) . 11187) (#("   " 0 3 (fontified t)) . -11136) (#("   " 0 3 (fontified t)) . -11094) 11039) nil (26797 43105 499026 0) 0 nil])
([nil nil ((10388 . 10389)) nil (26797 43105 499025 0) 0 nil])
([nil nil ((10389 . 10391)) nil (26797 43105 499024 0) 0 nil])
([nil nil ((11041 . 11043)) nil (26797 43105 499024 0) 0 nil])
([nil nil ((11043 . 11044)) nil (26797 43105 499023 0) 0 nil])
([nil nil ((12612 . 12613)) nil (26797 43105 499023 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13059 . 13060) (nil fontified nil 12613 . 13060) (12613 . 13060)) nil (26797 43105 499022 0) 0 nil])
([nil nil ((12380 . 12381)) nil (26797 43105 499021 0) 0 nil])
([nil nil ((12381 . 12383)) nil (26797 43105 499021 0) 0 nil])
([nil nil ((12615 . 12617)) nil (26797 43105 499021 0) 0 nil])
([nil nil ((12617 . 12618)) nil (26797 43105 499020 0) 0 nil])
([nil nil ((13066 . 13067) 12618) nil (26797 43105 499016 0) 0 nil])
([nil nil ((#("
(defparameter *ssl-protocol* :tlsv1.2-or-newer) ; options: :tlsv1.3, etc.
(defparameter *ssl-alpn-protocols* '(\"http/1.1\")) ; HTTP/2 viendra plus tard" 0 2 (fontified t) 2 14 (face font-lock-keyword-face fontified t) 14 15 (fontified t) 15 29 (face font-lock-variable-name-face fontified t) 29 30 (fontified t) 30 47 (face font-lock-builtin-face fontified t) 47 49 (fontified t) 49 75 (face font-lock-comment-face fontified t) 75 76 (fontified t) 76 88 (face font-lock-keyword-face fontified t) 88 89 (fontified t) 89 109 (face font-lock-variable-name-face fontified t) 109 112 (fontified t) 112 122 (face font-lock-string-face fontified t) 122 125 (fontified t) 125 151 (face font-lock-comment-face fontified t)) . 1101) (undo-tree-id48 . -151) (undo-tree-id49 . -151) (undo-tree-id50 . -151) (undo-tree-id51 . -151) (undo-tree-id52 . -151) (t 26797 43105 0 0)) nil (26797 48905 183949 0) 0 nil])
([nil nil ((1553 . 1555)) nil (26797 48905 183945 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1749 . 1750) (nil fontified nil 1555 . 1750) (1555 . 1750)) nil (26797 48905 183945 0) 0 nil])
([nil nil ((#("
(defun init-ssl-context ()
  (unless (and *ssl-cert-file* *ssl-key-file*)
    (error \"SSL enabled but no certificate/key provided. Set *ssl-cert-file* and *ssl-key-file*.\"))
  (setf *ssl-context*
        (cl+ssl:make-context
          :protocol *ssl-protocol*
          :verify :none
          :certificate-file *ssl-cert-file*
          :key-file *ssl-key-file*
          ;; selon la version de cl+ssl, :alpn-protocols peut Ãªtre disponible
          :alpn-protocols *ssl-alpn-protocols*)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 24 (face font-lock-function-name-face fontified t) 24 31 (fontified t) 31 37 (face font-lock-keyword-face fontified t) 37 80 (fontified t) 80 85 (face font-lock-warning-face fontified t) 85 86 (fontified t) 86 172 (face font-lock-string-face fontified t) 172 236 (fontified t) 236 245 (face font-lock-builtin-face fontified t) 245 271 (fontified t) 271 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 284 (face font-lock-builtin-face fontified t) 284 295 (fontified t) 295 312 (face font-lock-builtin-face fontified t) 312 339 (fontified t) 339 348 (face font-lock-builtin-face fontified t) 348 374 (fontified t) 374 377 (face font-lock-comment-delimiter-face fontified t) 377 442 (face font-lock-comment-face fontified t) 442 452 (fontified t) 452 467 (face font-lock-builtin-face fontified t) 467 491 (fontified t)) . 1751) (undo-tree-id34 . -491) (undo-tree-id35 . -225) (undo-tree-id36 . -1) (undo-tree-id37 . -8) (undo-tree-id38 . -206) (undo-tree-id39 . -213) (undo-tree-id40 . -225) (undo-tree-id41 . -225) (undo-tree-id42 . -225) (undo-tree-id43 . -213) (undo-tree-id44 . -491) (undo-tree-id45 . -491) (undo-tree-id46 . -491) (undo-tree-id47 . -491)) nil (26797 48905 183943 0) 0 nil])
([nil nil ((1751 . 1752)) nil (26797 48905 183935 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2516 . 2517) (nil fontified nil 1752 . 2517) (1752 . 2517)) nil (26797 48905 183934 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1750) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) 1751) nil (26797 48905 183929 0) 0 nil])
([nil nil ((1940 . 1951) (t 26797 48905 0 0)) nil (26797 48997 468387 0) 0 nil])
([nil nil ((1951 . 1952)) nil (26797 48997 468387 0) 0 nil])
([nil nil ((1997 . 1998)) nil (26797 48997 468386 0) 0 nil])
([nil nil ((2013 . 2014)) nil (26797 48997 468386 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2023 . 2024) (nil fontified nil 2014 . 2024) (2014 . 2024)) nil (26797 48997 468385 0) 0 nil])
([nil nil ((2024 . 2025)) nil (26797 48997 468383 0) 0 nil])
([nil nil ((2070 . 2071)) nil (26797 48997 468379 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 998) (t 26797 48997 0 0)) nil (26797 50337 638464 0) 0 nil])
([nil nil ((1100 . 1101)) nil (26797 50337 638464 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1163 . 1164) (nil fontified nil 1101 . 1164) (1101 . 1164)) nil (26797 50337 638463 0) 0 nil])
([nil nil ((2605 . 2607)) nil (26797 50337 638463 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3418 . 3419) (nil fontified nil 2607 . 3419) (2607 . 3419)) nil (26797 50337 638462 0) 0 nil])
([nil nil ((#("(cert (%ensure-existing-pathname *ssl-cert-file*))
        (pkey (%ensure-existing-pathname *ssl-key-file*)))" 0 109 (fontified t)) . -2789) (undo-tree-id56 . -109) 2898) nil (26797 50337 638461 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2925 . 2926) (nil fontified nil 2880 . 2926) (nil fontified nil 2879 . 2880) (nil fontified nil 2878 . 2879) (nil fontified nil 2869 . 2878) (nil fontified nil 2854 . 2869) (nil fontified nil 2789 . 2854) (2789 . 2926)) nil (26797 50337 638460 0) 0 nil])
([nil nil ((#("
(defun init-ssl-context ()
  (unless (and *ssl-cert-file* *ssl-key-file*)
    (error \"SSL enabled but no certificate/key provided. Set *ssl-cert-file* and *ssl-key-file*.\"))
  (let ((cert (namestring ( %ensure-existing-pathname *ssl-cert-file*)))
        (pkey (namestring ( %ensure-existing-pathname *ssl-key-file*))))
    (setf *ssl-context*
          (cl+ssl:make-context
           ;; dÃ©sactiver SSLv2/3, laisser TLS modernes
           :disabled-protocols (list cl+ssl:+ssl-op-no-sslv2+ cl+ssl:+ssl-op-no-sslv3+)
           ;; si ta lib supporte :min-proto-version, tu peux mettre TLS 1.2 mini :
           ;; :min-proto-version cl+ssl:+tls1-2-version+
           :verify-mode cl+ssl:+ssl-verify-none+
           :certificate-chain-file cert
           :private-key-file       pkey))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 24 (face font-lock-function-name-face fontified t) 24 31 (fontified t) 31 37 (face font-lock-keyword-face fontified t) 37 80 (fontified t) 80 85 (face font-lock-warning-face fontified t) 85 86 (fontified t) 86 172 (face font-lock-string-face fontified t) 172 175 (fontified t) 175 178 (fontified t) 178 181 (face font-lock-keyword-face fontified t) 181 248 (fontified t) 248 263 (fontified t) 263 272 (fontified t) 272 273 (fontified t rear-nonsticky t) 273 274 (fontified t) 274 321 (fontified t) 321 387 (fontified t) 387 390 (face font-lock-comment-delimiter-face fontified t) 390 431 (face font-lock-comment-face fontified t) 431 442 (fontified t) 442 461 (face font-lock-builtin-face fontified t) 461 530 (fontified t) 530 533 (face font-lock-comment-delimiter-face fontified t) 533 602 (face font-lock-comment-face fontified t) 602 613 (fontified t) 613 616 (face font-lock-comment-delimiter-face fontified t) 616 659 (face font-lock-comment-face fontified t) 659 670 (fontified t) 670 682 (face font-lock-builtin-face fontified t) 682 719 (fontified t) 719 742 (face font-lock-builtin-face fontified t) 742 748 (fontified t) 748 749 (fontified t) 749 759 (fontified t) 759 776 (face font-lock-builtin-face fontified t) 776 790 (fontified t) 790 791 (fontified t rear-nonsticky t)) . 1814) (undo-tree-id55 . -791)) nil (26797 50337 638459 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1814)) nil (26797 50337 638457 0) 0 nil])
([nil nil ((#("(cl+ssl:make-ssl-server-stream raw :context *ssl-context*)" 0 35 (fontified t) 35 38 (face font-lock-builtin-face fontified t) 38 43 (face font-lock-builtin-face fontified t) 43 58 (fontified t)) . -5668) (undo-tree-id53 . -30) (undo-tree-id54 . -58) 5726) nil (26797 50337 638456 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5980 . 5981) (nil fontified nil 5668 . 5981) (5668 . 5981)) nil (26797 50337 638445 0) 0 nil])
([nil nil ((11874 . 11875)) nil (26797 50337 638444 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11886 . 11887) (nil fontified nil 11875 . 11887) (11875 . 11887)) nil (26797 50337 638444 0) 0 nil])
([nil nil ((12697 . 12701)) nil (26797 50337 638443 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12731 . 12732) (nil fontified nil 12701 . 12732) (12701 . 12732)) nil (26797 50337 638442 0) 0 nil])
([nil nil ((12618 . 12623)) nil (26797 50337 638442 0) 0 nil])
([nil nil ((12658 . 12659)) nil (26797 50337 638441 0) 0 nil])
([nil nil ((12623 . 12624)) nil (26797 50337 638441 0) 0 nil])
([nil nil ((12696 . 12700)) nil (26797 50337 638440 0) 0 nil])
([nil nil ((12731 . 12732)) nil (26797 50337 638440 0) 0 nil])
([nil nil ((12660 . 12663)) nil (26797 50337 638439 0) 0 nil])
([nil nil ((12624 . 12627)) nil (26797 50337 638435 0) 0 nil])
([nil nil ((9164 . 9173) (t 26797 50337 0 0)) nil (26797 52679 746618 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9282 . 9283) (nil fontified nil 9173 . 9283) (9173 . 9283)) nil (26797 52679 746614 0) 0 nil])
([nil nil ((9218 . 9226) (#("               " 0 15 (fontified t)) . 9218) 8071 (t 26797 52679 0 0)) nil (26797 52760 866867 0) 0 nil])
([nil nil ((9226 . 9228)) nil (26797 52760 866866 0) 0 nil])
([nil nil ((9228 . 9229)) nil (26797 52760 866866 0) 0 nil])
([nil nil ((9279 . 9280)) nil (26797 52760 866865 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -9279) (undo-tree-id57 . -1) 9280) nil (26797 52760 866863 0) 0 nil])
([nil nil ((9279 . 9280)) nil (26797 52760 866851 0) 0 nil])
([nil nil ((#("(or " 0 4 (fontified t)) . -9994) (undo-tree-id59 . -4) 9998 (t 26797 52760 0 0)) nil (26798 61394 336011 0) 0 nil])
([nil nil ((#(" \"GET\")" 0 1 (fontified t) 1 6 (face font-lock-string-face fontified t) 6 7 (fontified t)) . -10000) (undo-tree-id58 . -7) 10007) nil (26798 61394 336007 0) 0 nil])
([nil nil ((164 . 165) (t 26798 61394 0 0)) nil (26799 5092 138323 0) 0 nil])
([nil nil ((165 . 166)) nil (26799 5092 138322 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 176 . 177) (nil fontified nil 166 . 177) (166 . 177)) nil (26799 5092 138322 0) 0 nil])
([nil nil ((3099 . 3101)) nil (26799 5092 138321 0) 0 nil])
([nil nil ((3101 . 3103)) nil (26799 5092 138321 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 3103)) nil (26799 5092 138320 0) 0 nil])
([nil nil ((4279 . 4281)) nil (26799 5092 138320 0) 0 nil])
([nil nil ((4281 . 4282)) nil (26799 5092 138320 0) 0 nil])
([nil nil ((3100 . 3101)) nil (26799 5092 138319 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6799 . 6800) (nil fontified nil 3101 . 6800) (3101 . 6800)) nil (26799 5092 138319 0) 0 nil])
([nil nil ((6800 . 6801)) nil (26799 5092 138318 0) 0 nil])
([nil nil ((#("%" 0 1 (fontified t)) . -4728) (undo-tree-id218 . -1) (undo-tree-id219 . -1) (undo-tree-id220 . -1) 4729) nil (26799 5092 138317 0) 0 nil])
([nil nil ((4728 . 4740)) nil (26799 5092 138315 0) 0 nil])
([nil nil ((74 . 77)) nil (26799 5092 138314 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 177 . 178) (nil fontified nil 177 . 178) (nil fontified nil 176 . 177) (nil fontified nil 166 . 176) (nil fontified nil 165 . 166) (nil fontified nil 164 . 165) (nil fontified nil 154 . 164) (nil fontified nil 153 . 154) (nil fontified nil 140 . 153) (nil fontified nil 139 . 140) (nil fontified nil 127 . 139) (nil fontified nil 126 . 127) (nil fontified nil 117 . 126) (nil fontified nil 116 . 117) (nil fontified nil 108 . 116) (nil fontified nil 107 . 108) (nil fontified nil 91 . 107) (nil fontified nil 90 . 91) (nil fontified nil 78 . 90) (nil fontified nil 77 . 78) (77 . 178)) nil (26799 5092 138313 0) 0 nil])
([nil nil ((#("http" 0 4 (face font-lock-builtin-face fontified t)) . -103) (undo-tree-id204 . -4) (undo-tree-id205 . -2) (undo-tree-id206 . -2) (undo-tree-id207 . -2) (undo-tree-id208 . -2) (undo-tree-id209 . -2) (undo-tree-id210 . -4) (undo-tree-id211 . -4) (undo-tree-id212 . -4) (undo-tree-id213 . -4) (undo-tree-id214 . -4) (undo-tree-id215 . -4) (undo-tree-id216 . -4) (undo-tree-id217 . -4) 107) nil (26799 5092 138311 0) 0 nil])
([nil nil ((#("c" 0 1 (face font-lock-builtin-face fontified t)) . -98) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (#("o" 0 1 (face font-lock-builtin-face fontified t)) . -99) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (#("r" 0 1 (face font-lock-builtin-face fontified t)) . -100) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) (undo-tree-id150 . -1) (undo-tree-id151 . -1) (undo-tree-id152 . -1) (undo-tree-id153 . -1) (undo-tree-id154 . -1) (undo-tree-id155 . -1) (undo-tree-id156 . -1) (undo-tree-id157 . -1) (undo-tree-id158 . -1) (undo-tree-id159 . -1) (undo-tree-id160 . -1) (undo-tree-id161 . -1) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (undo-tree-id164 . -1) (undo-tree-id165 . -1) (#("e" 0 1 (face font-lock-builtin-face fontified t)) . -101) (undo-tree-id166 . -1) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) (undo-tree-id172 . -1) (undo-tree-id173 . -1) (undo-tree-id174 . -1) (undo-tree-id175 . -1) (undo-tree-id176 . -1) (undo-tree-id177 . -1) (undo-tree-id178 . -1) (undo-tree-id179 . -1) (undo-tree-id180 . -1) (undo-tree-id181 . -1) (undo-tree-id182 . -1) (undo-tree-id183 . -1) (undo-tree-id184 . -1) (#("." 0 1 (face font-lock-builtin-face fontified t)) . -102) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) 103) nil (26799 5092 138301 0) 0 nil])
([nil nil ((98 . 103)) nil (26799 5092 138250 0) 0 nil])
([nil nil ((#("request :response :resp-status :resp-headers :resp-body :respond-sse" 0 7 (face font-lock-builtin-face fontified t) 7 8 (fontified t) 8 17 (face font-lock-builtin-face fontified t) 17 18 (fontified t) 18 30 (face font-lock-builtin-face fontified t) 30 31 (fontified t) 31 44 (face font-lock-builtin-face fontified t) 44 45 (fontified t) 45 55 (face font-lock-builtin-face fontified t) 55 56 (fontified t) 56 57 (face font-lock-builtin-face fontified t) 57 67 (face font-lock-builtin-face fontified t) 67 68 (face font-lock-builtin-face fontified t rear-nonsticky t)) . -105) (undo-tree-id102 . -68) (undo-tree-id103 . -68) (undo-tree-id104 . -68) (undo-tree-id105 . -68) (undo-tree-id106 . -68) (undo-tree-id107 . -68) (undo-tree-id108 . -68) 173) nil (26799 5092 138249 0) 0 nil])
([nil nil ((105 . 114)) nil (26799 5092 138244 0) 0 nil])
([nil nil ((104 . 118) (#(":ensure-he" 0 10 (face font-lock-builtin-face fontified t)) . -104) (undo-tree-id60 . -1) (undo-tree-id61 . -10) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -2) (undo-tree-id79 . -2) (undo-tree-id80 . -3) (undo-tree-id81 . -3) (undo-tree-id82 . -4) (undo-tree-id83 . -4) (undo-tree-id84 . -5) (undo-tree-id85 . -5) (undo-tree-id86 . -6) (undo-tree-id87 . -6) (undo-tree-id88 . -7) (undo-tree-id89 . -7) (undo-tree-id90 . -7) (undo-tree-id91 . -7) (undo-tree-id92 . -7) (undo-tree-id93 . -7) (undo-tree-id94 . -7) (undo-tree-id95 . -7) (undo-tree-id96 . -8) (undo-tree-id97 . -8) (undo-tree-id98 . -9) (undo-tree-id99 . -9) (undo-tree-id100 . -10) (undo-tree-id101 . -10) 114) nil (26799 5092 138240 0) 0 nil])
([nil nil ((3735 . 3737) (t 26799 5092 0 0)) nil (26799 5961 130603 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4334 . 4335) (nil fontified nil 3737 . 4335) (3737 . 4335)) nil (26799 5961 130602 0) 0 nil])
([nil nil ((#("
(defun %write-chunk (flexi data)
  (let* ((octets (etypecase data
                   (string (trivial-utf-8:string-to-utf-8-bytes data))
                   ((simple-array (unsigned-byte 8) (*)) data)))
         (n (length octets)))
    (format flexi \"~X\" n) (crlf flexi)
    (flexi-streams:write-sequence octets flexi)
    (crlf flexi)
    (finish-output flexi)))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 37 (fontified t) 37 41 (face font-lock-keyword-face fontified t) 41 52 (fontified t) 52 61 (face font-lock-keyword-face fontified t) 61 251 (fontified t) 251 255 (face font-lock-string-face fontified t) 255 337 (fontified t) 337 365 (fontified t)) . 3371) (undo-tree-id280 . -365)) nil (26799 5961 130601 0) 0 nil])
([nil nil ((#("streams" 0 7 (fontified t)) . -6784) (undo-tree-id275 . -7) (undo-tree-id276 . -7) (undo-tree-id277 . -7) (undo-tree-id278 . -7) (undo-tree-id279 . -7) 6791) nil (26799 5961 130599 0) 0 nil])
([nil nil ((#("f" 0 1 (fontified t)) . -6778) (undo-tree-id221 . -1) (undo-tree-id222 . -1) (undo-tree-id223 . -1) (undo-tree-id224 . -1) (undo-tree-id225 . -1) (undo-tree-id226 . -1) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (#("l" 0 1 (fontified t)) . -6779) (undo-tree-id230 . -1) (undo-tree-id231 . -1) (undo-tree-id232 . -1) (undo-tree-id233 . -1) (undo-tree-id234 . -1) (undo-tree-id235 . -1) (undo-tree-id236 . -1) (undo-tree-id237 . -1) (undo-tree-id238 . -1) (#("e" 0 1 (fontified t)) . -6780) (undo-tree-id239 . -1) (undo-tree-id240 . -1) (undo-tree-id241 . -1) (undo-tree-id242 . -1) (undo-tree-id243 . -1) (undo-tree-id244 . -1) (undo-tree-id245 . -1) (undo-tree-id246 . -1) (undo-tree-id247 . -1) (#("x" 0 1 (fontified t)) . -6781) (undo-tree-id248 . -1) (undo-tree-id249 . -1) (undo-tree-id250 . -1) (undo-tree-id251 . -1) (undo-tree-id252 . -1) (undo-tree-id253 . -1) (undo-tree-id254 . -1) (undo-tree-id255 . -1) (undo-tree-id256 . -1) (#("i" 0 1 (fontified t)) . -6782) (undo-tree-id257 . -1) (undo-tree-id258 . -1) (undo-tree-id259 . -1) (undo-tree-id260 . -1) (undo-tree-id261 . -1) (undo-tree-id262 . -1) (undo-tree-id263 . -1) (undo-tree-id264 . -1) (undo-tree-id265 . -1) (#("-" 0 1 (fontified t)) . -6783) (undo-tree-id266 . -1) (undo-tree-id267 . -1) (undo-tree-id268 . -1) (undo-tree-id269 . -1) (undo-tree-id270 . -1) (undo-tree-id271 . -1) (undo-tree-id272 . -1) (undo-tree-id273 . -1) (undo-tree-id274 . -1) 6784) nil (26799 5961 130594 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . 6778)) nil (26799 5961 130553 0) 0 nil])
([nil nil ((#("%ensure-header" 0 14 (fontified t)) . -6939) (6953 . 6978) (#("%ensure-header" 0 14 (fontified t)) . -6610) (6624 . 6649) (#("%ensure-header" 0 14 (fontified t)) . -5949) (t 26799 5961 0 0) (5963 . 5988) (t 26799 5961 0 0)) nil (26799 6025 716523 0) 0 nil])
([nil nil ((4862 . 4863) (t 26799 6025 0 0)) nil (26799 14313 459859 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -4862) (undo-tree-id0 . -1) 4863) nil (26799 14313 459857 0) 0 nil])
([nil nil ((4862 . 4870)) nil (26799 14313 459838 0) 0 nil])
([nil nil ((4870 . 4876)) nil (26799 14313 459837 0) 0 nil])
([nil nil ((4876 . 4877)) nil (26799 14313 459837 0) 0 nil])
([nil nil ((4877 . 4880)) nil (26799 14313 459836 0) 0 nil])
([nil nil ((4880 . 4881)) nil (26799 14313 459836 0) 0 nil])
([nil nil ((4881 . 4885)) nil (26799 14313 459835 0) 0 nil])
([nil nil ((4885 . 4886)) nil (26799 14313 459834 0) 0 nil])
([nil nil ((4886 . 4893)) nil (26799 14313 459833 0) 0 nil])
([nil nil ((4893 . 4894)) nil (26799 14313 459831 0) 0 nil])
([nil nil ((4894 . 4899)) nil (26799 14313 459825 0) 0 nil])
([nil nil ((3356 . 3358) (t 26799 14313 0 0)) nil (26799 18245 804351 0) 0 nil])
([nil nil ((3370 . 3375)) nil (26799 18245 804347 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -3356) (undo-tree-id1 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -3357) (undo-tree-id2 . -1) (#("(" 0 1 (face font-lock-comment-face fontified t)) . -3358) (undo-tree-id3 . -1) 3359 (t 26799 18245 0 0)) nil (26799 19789 910613 0) 0 nil])
([nil nil ((3356 . 3357)) nil (26799 19789 910600 0) 0 nil])
([nil nil ((#("
       (print \"OK pour RESPOND SSE\")" 0 1 (fontified t) 1 2 (fontified t) 2 9 (fontified t) 9 15 (fontified t) 15 36 (face font-lock-string-face fontified t) 36 37 (fontified t)) . 4867) (undo-tree-id4 . -37) (undo-tree-id5 . -37) (undo-tree-id6 . -37) (t 26799 19789 0 0)) nil (26799 20457 770969 0) 0 nil])
([nil nil ((3246 . 3248) (t 26799 20020 0 0)) nil (26799 20534 834680 0) 0 nil] [nil nil ((#("    " 0 4 (fontified nil)) . 3352) (3352 . 3356) (3352 . 3353) (t 26799 20020 0 0)) ((#("
" 0 1 (fontified nil)) . 3352) (undo-tree-id7 . -1) (#("    " 0 4 (fontified nil)) . 3352) (3352 . 3356)) (26799 20457 770180 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -3246) (undo-tree-id24 . -1) (#("
" 0 1 (fontified t)) . -3247) (undo-tree-id25 . -1) 3248) nil (26799 20534 834680 0) 0 nil])
nil
([nil nil ((3145 . 3146)) nil (26799 20534 834677 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3231 . 3232) (nil fontified nil 3146 . 3232) (3146 . 3232)) nil (26799 20534 834677 0) 0 nil])
([nil nil ((3232 . 3233)) nil (26799 20534 834676 0) 0 nil])
([nil nil ((3463 . 3465)) nil (26799 20534 834676 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4138 . 4139) (nil fontified nil 3465 . 4139) (3465 . 4139)) nil (26799 20534 834675 0) 0 nil])
([nil nil ((#("

(defun %write-chunk (flexi data)
  (etypecase data
    (string
     (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes data))
            (n (length bytes)))
       (format flexi \"~X\" n) (crlf flexi)
       ;; On Ã©crit la chaÃ®ne : le flexi stream la convertit en UTF-8
       (write-string data flexi)
       (crlf flexi)
       (finish-output flexi)))
    ((simple-array (unsigned-byte 8) (*))
     (let ((n (length data)))
       (format flexi \"~X\" n) (crlf flexi)
       (write-sequence data flexi)  ;; <â CL:WRITE-SEQUENCE, pas flexi-streams
       (crlf flexi)
       (finish-output flexi)))))
" 0 1 (fontified t) 1 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 21 (face font-lock-function-name-face fontified t) 21 38 (fontified t) 38 47 (face font-lock-keyword-face fontified t) 47 71 (fontified t) 71 75 (face font-lock-keyword-face fontified t) 75 181 (fontified t) 181 185 (face font-lock-string-face fontified t) 185 209 (fontified t) 209 212 (face font-lock-comment-delimiter-face fontified t) 212 271 (face font-lock-comment-face fontified t) 271 403 (fontified t) 403 406 (face font-lock-keyword-face fontified t) 406 448 (fontified t) 448 452 (face font-lock-string-face fontified t) 452 505 (fontified t) 505 508 (face font-lock-comment-delimiter-face fontified t) 508 548 (face font-lock-comment-face fontified t) 548 601 (fontified t)) . -4139) (undo-tree-id23 . -601) 4740) nil (26799 20534 834674 0) 0 nil])
([nil nil ((4248 . 4250)) nil (26799 20534 834673 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4398 . 4399) (nil fontified nil 4250 . 4399) (4250 . 4399)) nil (26799 20534 834673 0) 0 nil])
([nil nil ((#("

(defun %finish-chunked (flexi)
  (write-string \"0\" flexi) (crlf flexi) (crlf flexi)
  (finish-output flexi))
" 0 1 (rear-nonsticky t fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 24 (face font-lock-function-name-face fontified t) 24 49 (fontified t) 49 52 (face font-lock-string-face fontified t) 52 86 (fontified t) 86 111 (fontified t)) . 4138) (undo-tree-id17 . -111) (undo-tree-id18 . -86) (undo-tree-id19 . -86) (undo-tree-id20 . -86) (undo-tree-id21 . -1) (undo-tree-id22 . -111)) nil (26799 20534 834672 0) 0 nil])
([nil nil ((4138 . 4139)) nil (26799 20534 834668 0) 0 nil])
([nil nil ((#("((functionp body)
       ;; pas de Content-Length ; forcer chunked si absent
       (setf headers (%remove-header headers \"Content-Length\"))
       (setf headers (lumen.utils:ensure-header headers \"Transfer-Encoding\" \"chunked\"))
       ;; Ã©crire les headers applicatifs
       (let ((have-ct nil))
         (dolist (h headers)
           (when (string-equal (car h) \"content-type\") (setf have-ct t)))
         (%write-headers flexi headers)
         (unless have-ct
           (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
       (crlf flexi)
       (unless (string= method \"HEAD\")
         ;; Appel du writer : il reÃ§oit un send-chunk (string|octets)
         (handler-case
             (funcall body (lambda (chunk) (when chunk (%write-chunk flexi chunk))))
           (error () ;; client parti : ignorer proprement
             nil))
         (ignore-errors (%finish-chunked flexi))))" 0 17 (fontified t) 17 18 (fontified t) 18 19 (fontified t) 19 24 (fontified t) 24 25 (fontified t) 25 26 (face font-lock-comment-delimiter-face fontified t) 26 28 (face font-lock-comment-delimiter-face fontified t) 28 77 (face font-lock-comment-face fontified t) 77 113 (fontified t) 113 122 (fontified t) 122 138 (face font-lock-string-face fontified t) 138 197 (fontified t) 197 216 (face font-lock-string-face fontified t) 216 217 (fontified t) 217 226 (face font-lock-string-face fontified t) 226 236 (fontified t) 236 239 (face font-lock-comment-delimiter-face fontified t) 239 270 (face font-lock-comment-face fontified t) 270 278 (fontified t) 278 281 (face font-lock-keyword-face fontified t) 281 308 (fontified t) 308 314 (face font-lock-keyword-face fontified t) 314 339 (fontified t) 339 343 (face font-lock-keyword-face fontified t) 343 366 (fontified t) 366 380 (face font-lock-string-face fontified t) 380 451 (fontified t) 451 457 (face font-lock-keyword-face fontified t) 457 491 (fontified t) 491 532 (face font-lock-string-face fontified t) 532 577 (fontified t) 577 583 (face font-lock-keyword-face fontified t) 583 586 (fontified t) 586 600 (fontified t) 600 606 (face font-lock-string-face fontified t) 606 608 (fontified t) 608 617 (fontified t) 617 620 (face font-lock-comment-delimiter-face fontified t) 620 626 (face font-lock-comment-face fontified t) 626 627 (face font-lock-comment-face fontified t) 627 678 (face font-lock-comment-face fontified t) 678 688 (fontified t) 688 700 (face font-lock-keyword-face fontified t) 700 729 (fontified t) 729 735 (face font-lock-keyword-face fontified t) 735 736 (fontified t) 736 745 (fontified t) 745 749 (face font-lock-keyword-face fontified t) 749 786 (fontified t) 786 798 (fontified t) 798 803 (face font-lock-warning-face fontified t) 803 807 (fontified t) 807 810 (face font-lock-comment-delimiter-face fontified t) 810 844 (face font-lock-comment-face fontified t) 844 873 (fontified t) 873 886 (face font-lock-keyword-face fontified t) 886 913 (fontified t)) . -5054) (undo-tree-id8 . -862) (undo-tree-id9 . -17) (undo-tree-id10 . -17) (undo-tree-id11 . -17) (undo-tree-id12 . -913) (undo-tree-id13 . -17) (undo-tree-id14 . -863) (undo-tree-id15 . -913) (undo-tree-id16 . -913) 5967) nil (26799 20534 834666 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5799 . 5800) (nil fontified nil 5054 . 5800) (5054 . 5800)) nil (26799 20534 834646 0) 0 nil])
([nil nil ((#("(defun %wr-crlf (flexi)
  (write-sequence #(13 10) flexi))  ; \\r\\n en binaire, garanti" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 15 (face font-lock-function-name-face fontified t) 15 24 (fontified t) 24 60 (fontified t) 60 85 (face font-lock-comment-face fontified t) 85 86 (face font-lock-comment-face rear-nonsticky t fontified t)) . 3146) (undo-tree-id45 . -86) (t 26799 20534 0 0)) nil (26799 20908 760136 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3241 . 3242) (nil fontified nil 3146 . 3242) (3146 . 3242)) nil (26799 20908 760135 0) 0 nil])
([nil nil ((4148 . 4150)) nil (26799 20908 760134 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4759 . 4760) (nil fontified nil 4150 . 4760) (4150 . 4760)) nil (26799 20908 760133 0) 0 nil])
([nil nil ((#("(defun %write-chunk (flexi data)
  (etypecase data
    (string
     (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes data))
            (n (length bytes)))
       (format flexi \"~X\" n) (%wr-crlf flexi)     ;; <â CRLF binaire
       (write-string data flexi)
       (%wr-crlf flexi)                           ;; <â CRLF binaire
       (finish-output flexi)))
    ((simple-array (unsigned-byte 8) (*))
     (let ((n (length data)))
       (format flexi \"~X\" n) (%wr-crlf flexi)     ;; <â CRLF binaire
       (write-sequence data flexi)                ;; CL:WRITE-SEQUENCE
       (%wr-crlf flexi)                           ;; <â CRLF binaire
       (finish-output flexi)))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 19 (face font-lock-function-name-face fontified t) 19 36 (fontified t) 36 45 (face font-lock-keyword-face fontified t) 45 69 (fontified t) 69 73 (face font-lock-keyword-face fontified t) 73 179 (fontified t) 179 183 (face font-lock-string-face fontified t) 183 208 (fontified t) 208 211 (face font-lock-comment-delimiter-face fontified t) 211 227 (face font-lock-comment-face fontified t) 227 310 (fontified t) 310 313 (face font-lock-comment-delimiter-face fontified t) 313 329 (face font-lock-comment-face fontified t) 329 408 (fontified t) 408 411 (face font-lock-keyword-face fontified t) 411 453 (fontified t) 453 457 (face font-lock-string-face fontified t) 457 482 (fontified t) 482 485 (face font-lock-comment-delimiter-face fontified t) 485 501 (face font-lock-comment-face fontified t) 501 551 (fontified t) 551 554 (face font-lock-comment-delimiter-face fontified t) 554 572 (face font-lock-comment-face fontified t) 572 622 (fontified t) 622 625 (face font-lock-comment-delimiter-face fontified t) 625 641 (face font-lock-comment-face fontified t) 641 674 (fontified t)) . 3475) (undo-tree-id37 . -674) (undo-tree-id38 . -673) (undo-tree-id39 . -673) (undo-tree-id40 . -673) (undo-tree-id41 . -402) (undo-tree-id42 . -674) (undo-tree-id43 . -673) (undo-tree-id44 . -674)) nil (26799 20908 760132 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -3474) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) 3475) nil (26799 20908 760125 0) 0 nil])
([nil nil ((504 . 505) (t 26799 20908 0 0)) nil (26799 21284 671248 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 595 . 596) (nil fontified nil 505 . 596) (505 . 596)) nil (26799 21284 671246 0) 0 nil])
([nil nil ((#("((functionp body)
  (setf headers (%remove-header headers \"Content-Length\"))
  (setf headers (lumen.utils:ensure-header headers \"Transfer-Encoding\" \"chunked\"))

  (let ((have-ct nil))
    (dolist (h headers)
      (when (string-equal (car h) \"content-type\") (setf have-ct t)))
    (%write-headers flexi headers)
    (unless have-ct
      (format flexi \"Content-Type: text/plain; charset=utf-8\")
      (crlf flexi)))              ;; fin de la DERNIÃRE ligne dâen-tÃªte

  (%wr-crlf flexi)                ;; <â **UNE SEULE** ligne vide binaire \\r\\n

  (unless (string= method \"HEAD\")
    (handler-case
        (funcall body (lambda (chunk) (when chunk (%write-chunk flexi chunk))))
      (error () nil))
    (ignore-errors (%finish-chunked flexi))))" 0 58 (fontified t) 58 74 (face font-lock-string-face fontified t) 74 100 (fontified t) 100 128 (fontified t) 128 147 (face font-lock-string-face fontified t) 147 148 (fontified t) 148 157 (face font-lock-string-face fontified t) 157 160 (fontified t) 160 164 (fontified t) 164 167 (face font-lock-keyword-face fontified t) 167 189 (fontified t) 189 195 (face font-lock-keyword-face fontified t) 195 215 (fontified t) 215 219 (face font-lock-keyword-face fontified t) 219 242 (fontified t) 242 256 (face font-lock-string-face fontified t) 256 317 (fontified t) 317 323 (face font-lock-keyword-face fontified t) 323 352 (fontified t) 352 393 (face font-lock-string-face fontified t) 393 429 (fontified t) 429 432 (face font-lock-comment-delimiter-face fontified t) 432 467 (face font-lock-comment-face fontified t) 467 502 (fontified t) 502 505 (face font-lock-comment-delimiter-face fontified t) 505 546 (face font-lock-comment-face fontified t) 546 550 (fontified t) 550 551 (face font-lock-keyword-face fontified t) 551 556 (face font-lock-keyword-face fontified t) 556 573 (fontified t) 573 579 (face font-lock-string-face fontified t) 579 581 (fontified t) 581 583 (fontified t) 583 585 (fontified t) 585 586 (fontified t) 586 598 (face font-lock-keyword-face fontified t) 598 599 (fontified t) 599 622 (fontified t) 622 628 (face font-lock-keyword-face fontified t) 628 638 (fontified t) 638 642 (face font-lock-keyword-face fontified t) 642 686 (fontified t) 686 691 (face font-lock-warning-face fontified t) 691 706 (fontified t) 706 719 (face font-lock-keyword-face fontified t) 719 745 (fontified t) 745 746 (fontified t rear-nonsticky t)) . -5093) (undo-tree-id46 . -746) 5839) nil (26799 21284 671245 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6836 . 6837) (nil fontified nil 5093 . 6837) (5093 . 6837)) nil (26799 21284 671232 0) 0 nil])
([nil nil ((14249 . 14250) (t 26799 21284 0 0)) nil (26800 2707 812898 0) 0 nil])
([nil nil ((#("b" 0 1 (face font-lock-builtin-face fontified t)) . -14249) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) 14250) nil (26800 2707 812894 0) 0 nil])
([nil nil ((5035 . 5042) (t 26800 2707 0 0)) nil (26800 13382 354870 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5458 . 5459) (nil fontified nil 5042 . 5459) (5042 . 5459)) nil (26800 13382 354866 0) 0 nil])
([nil nil ((#("
#|
(defun stop ()
  (when *server-socket*
    (ignore-errors (usocket:socket-close *server-socket*))
    (setf *server-socket* nil))
  (when *accept-thread*
    (bt:destroy-thread *accept-thread*)
    (setf *accept-thread* nil))
  t)
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 235 (face font-lock-comment-face fontified t) 235 237 (face font-lock-comment-delimiter-face fontified t)) . 18798) (undo-tree-id4 . -237) (t 26800 13382 0 0)) nil (26804 7751 547165 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 18798)) nil (26804 7751 547164 0) 0 nil])
([nil nil ((#("
#|
(defun start (&key (port 8080) handler (ssl nil) (ssl-port 8443)
                   cert-file key-file)
  (when *server-socket* (stop))
  (setf *port* port)
  (setf *handler*
	(or handler
	    (lambda (req)
	      (declare (ignore req))
	      (make-instance 'lumen.core.http:response
			     :status 500 :headers nil :body \"\"))))
  
  (setf *server-socket* (usocket:socket-listen \"0.0.0.0\" port :reuse-address t
					       :element-type '(unsigned-byte 8)))
  (setf *accept-thread* (bt:make-thread
			 (lambda ()
			   (accept-loop *server-socket*))
			 :name (format nil \"lumen-accept-~A\" port)))
  (format t \"Lumen listening on ~A~%\" port)
  t)
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 61 (face font-lock-comment-face fontified t) 61 69 (face font-lock-comment-face fontified t) 69 653 (face font-lock-comment-face fontified t) 653 655 (face font-lock-comment-delimiter-face fontified t) 655 656 (fontified t)) . 16740) (undo-tree-id3 . -656)) nil (26804 7751 547163 0) 0 nil])
([nil nil ((#("
#|
(defun accept-loop (socket)
  (loop
    (let ((client (usocket:socket-accept socket :element-type '(unsigned-byte 8))))
      (bt:make-thread (lambda () (handle-connection socket client))
                      :name \"lumen-client\"))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 239 (face font-lock-comment-face fontified t) 239 241 (face font-lock-comment-delimiter-face fontified t)) . 16217) (undo-tree-id2 . -241)) nil (26804 7751 547162 0) 0 nil])
([nil nil ((#("
#|
(defun write-response (flexi resp &optional (method \"GET\") (keep-alive-p nil))
  ;; RÃ©ponse HTTP *classique* (Content-Length exact en octets). ZÃ©ro chunked.
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (lumen.core.http:resp-headers resp))
         (body    (or (lumen.core.http:resp-body resp) \"\"))
         (len     (length (trivial-utf-8:string-to-utf-8-bytes body))))
    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)
    (format flexi \"Content-Length: ~D\" len) (crlf flexi)
    (format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
    (when keep-alive-p
      (format flexi \"Keep-Alive: timeout=~D, max=~D\"
              (truncate *keep-alive-timeout*) *keep-alive-max*)
      (crlf flexi))
    (let ((have-ct nil))
      (dolist (h headers)
        (when (string-equal (car h) \"content-type\") (setf have-ct t))
        (format flexi \"~A: ~A\" (car h) (cdr h)) (crlf flexi))
      (unless have-ct
        (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
    (crlf flexi)
    (unless (string= method \"HEAD\") (write-string body flexi))
    (finish-output flexi)))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 550 (face font-lock-comment-face fontified t) 550 626 (face font-lock-comment-face fontified t) 626 1179 (face font-lock-comment-face fontified t) 1179 1181 (face font-lock-comment-delimiter-face fontified t) 1181 1182 (fontified t)) . 8614) (undo-tree-id1 . -1182)) nil (26804 7751 547160 0) 0 nil])
([nil nil ((#("
#|
(defun make-http-stream (client)
  \"Retourne un flux FLEXI *caractÃ¨re* au-dessus du flux usocket.\"
  (let* ((raw  (usocket:socket-stream client))
         (xfmt (flexi-streams:make-external-format :utf-8 :eol-style :crlf)))
    (flexi-streams:make-flexi-stream raw :external-format xfmt)))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 127 (face font-lock-comment-face fontified t) 127 150 (face font-lock-comment-face fontified t) 150 294 (face font-lock-comment-face fontified t) 294 296 (face font-lock-comment-delimiter-face fontified t) 296 297 (fontified t)) . 9431) (undo-tree-id0 . -297)) nil (26804 7751 547156 0) 0 nil])
([nil nil ((12324 . 12329) (t 26804 7751 0 0)) nil (26804 34135 902260 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12376 . 12377) (nil fontified nil 12329 . 12377) (12329 . 12377)) nil (26804 34135 902259 0) 0 nil])
([nil nil ((14246 . 14253)) nil (26804 34135 902258 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14302 . 14303) (nil fontified nil 14253 . 14303) (14253 . 14303)) nil (26804 34135 902258 0) 0 nil])
([nil nil ((275 . 278)) nil (26804 34135 902257 0) 0 nil])
([nil nil ((278 . 284)) nil (26804 34135 902256 0) 0 nil])
([nil nil ((279 . 286) (#(":impo" 0 5 (face font-lock-builtin-face fontified t)) . -279) (undo-tree-id11 . -5) 284) nil (26804 34135 902255 0) 0 nil])
([nil nil ((286 . 288)) nil (26804 34135 902254 0) 0 nil])
([nil nil ((279 . 291) (#(":import-f" 0 9 (face font-lock-builtin-face fontified t)) . -279) (undo-tree-id10 . -9) 288) nil (26804 34135 902253 0) 0 nil])
([nil nil ((291 . 292)) nil (26804 34135 902251 0) 0 nil])
([nil nil ((292 . 293)) nil (26804 34135 902251 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 331 . 332) (nil fontified nil 293 . 332) (293 . 332)) nil (26804 34135 902250 0) 0 nil])
([nil nil ((312 . 313)) nil (26804 34135 902249 0) 0 nil])
([nil nil ((333 . 334)) nil (26804 34135 902249 0) 0 nil])
([nil nil ((334 . 341)) nil (26804 34135 902248 0) 0 nil])
([nil nil ((334 . 355) (#("unregis" 0 7 (fontified t)) . -334) (undo-tree-id9 . -7) 341) nil (26804 34135 902247 0) 0 nil])
([nil nil ((334 . 335)) nil (26804 34135 902246 0) 0 nil])
([nil nil ((356 . 357)) nil (26804 34135 902246 0) 0 nil])
([nil nil ((13353 . 13362)) nil (26804 34135 902245 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13741 . 13742) (nil fontified nil 13362 . 13742) (13362 . 13742)) nil (26804 34135 902244 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -13741) (undo-tree-id8 . -1) 13742) nil (26804 34135 902243 0) 0 nil])
([nil nil ((13741 . 13750)) nil (26804 34135 902242 0) 0 nil])
([nil nil ((13750 . 13751)) nil (26804 34135 902241 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -13750) (undo-tree-id7 . -1) 13751) nil (26804 34135 902240 0) 0 nil])
([nil nil ((13750 . 13752)) nil (26804 34135 902238 0) 0 nil])
([nil nil ((13752 . 13753)) nil (26804 34135 902238 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13812 . 13813) (nil fontified nil 13753 . 13813) (13753 . 13813)) nil (26804 34135 902237 0) 0 nil])
([nil nil ((13813 . 13814)) nil (26804 34135 902236 0) 0 nil])
([nil nil ((14552 . 14556)) nil (26804 34135 902235 0) 0 nil])
([nil nil ((14556 . 14557)) nil (26804 34135 902234 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14588 . 14589) (nil fontified nil 14557 . 14589) (14557 . 14589)) nil (26804 34135 902230 0) 0 nil])
([nil nil ((14589 . 14590)) nil (26804 34135 902229 0) 0 nil])
([nil nil ((14590 . 14597)) nil (26804 34135 902228 0) 0 nil])
([nil nil ((14552 . 14558) (#(" " 0 1 (fontified nil)) . 14551) (undo-tree-id6 . -1) (14552 . 14553)) nil (26804 34135 902227 0) 0 nil])
([nil nil ((#("
						     " 0 1 (fontified t) 1 12 (fontified t)) . -14622) (undo-tree-id5 . -12) 14634) nil (26804 34135 902222 0) 0 nil])
([nil nil ((356 . 359)) nil (26804 34135 902209 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 369 . 370) (nil fontified nil 359 . 370) (359 . 370)) nil (26804 34135 902204 0) 0 nil])
([nil nil ((4424 . 4426) (t 26804 34135 0 0)) nil (26804 50240 228734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11485 . 11486) (nil fontified nil 4426 . 11486) (4426 . 11486)) nil (26804 50240 228732 0) 0 nil])
([nil nil ((#("

(defun write-response (flexi resp &optional (method \"GET\") (keep-alive-p nil))
  ;; RÃ©ponse HTTP classique + mode streaming (chunked) si body = fonction.
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (copy-list (lumen.core.http:resp-headers resp)))
         (body    (lumen.core.http:resp-body resp)))
    ;; Ligne de statut
    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)
    ;; Connection
    (format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
    (when keep-alive-p
      (format flexi \"Keep-Alive: timeout=~D, max=~D\"
              (truncate *keep-alive-timeout*) *keep-alive-max*)
      (crlf flexi))
    (cond
      ;; ===== Upgrade WebSocket =====
      ((and (= status 101) (functionp body))
       ;; Ne pas Ã©crire nos 'Connection:' automatiques ici.
       ;; On s'appuie STRICTEMENT sur les headers fournis (Upgrade/Connection/Accept).
       (dolist (h headers) (format flexi \"~A: ~A\" (car h) (cdr h)) (crlf flexi))
       (crlf flexi) (finish-output flexi)
       ;; On passe le flux au handler WS
       (funcall body flexi))
      ;; ========= STREAMING (SSE, etc.) =========
      ((functionp body)
  ;; pas de Content-Length
  (setf headers (%remove-header headers \"Content-Length\"))

  (if *sse-use-chunked*
      ;; ---- Plan A : chunked (Ã  rÃ©activer plus tard) ----
      (progn
        (setf headers (lumen.utils:ensure-header headers \"Transfer-Encoding\" \"chunked\"))
        ;; Ã©crire headers applicatifs
        (let ((have-ct nil))
          (dolist (h headers) (when (string-equal (car h) \"content-type\") (setf have-ct t)))
          (%write-headers flexi headers)
          (unless have-ct
            (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
        ;; fin des en-tÃªtes â EXACTEMENT UNE LIGNE VIDE
        (crlf flexi)
        (unless (string= method \"HEAD\")
          (handler-case
              (funcall body (lambda (chunk) (when chunk (%write-chunk flexi chunk))))
            (error () nil))
          (ignore-errors (%finish-chunked flexi))))

      ;; ---- Plan B : RAW (dÃ©bloquant, recommandÃ© pour valider SSE) ----
      (progn
        ;; pas de Transfer-Encoding, pas de Content-Length
        (let ((have-ct nil))
          (dolist (h headers) (when (string-equal (car h) \"content-type\") (setf have-ct t)))
          (%write-headers flexi headers)
          (unless have-ct
            (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
        ;; fin des en-tÃªtes â EXACTEMENT UNE LIGNE VIDE
        (crlf flexi)
        (unless (string= method \"HEAD\")
          ;; le writer envoie des strings directement
          (handler-case
              (funcall body (lambda (s) (when s (write-string s flexi) (finish-output flexi))))
            (error () nil))
          ;; pas de \"0\\r\\n\\r\\n\" ici : la connexion reste ouverte tant que SSE vit
          ))))
      ;; ========= Corps texte =========
      ((stringp body)
       (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes body))
              (len   (length bytes)))
         (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
         (let ((have-ct nil))
           (dolist (h headers)
             (when (string-equal (car h) \"content-type\") (setf have-ct t)))
           (%write-headers flexi headers)
           (unless have-ct
             (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
         (crlf flexi)
         (unless (string= method \"HEAD\")
           (write-string body flexi)
           (finish-output flexi))))
      ;; ========= Corps octets =========
      ((typep body '(simple-array (unsigned-byte 8) (*)))
       (let* ((len (length body)))
         (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
         (%write-headers flexi headers)
         (crlf flexi)
         (unless (string= method \"HEAD\")
           (write-sequence body flexi)
           (finish-output flexi))))
      ;; ========= Fallback (vide) =========
      (t
       (setf headers (lumen.utils:ensure-header headers \"Content-Length\" \"0\"))
       (%write-headers flexi headers)
       (crlf flexi)
       ;; rien Ã  Ã©crire
       (finish-output flexi)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 23 (face font-lock-function-name-face fontified t) 23 36 (fontified t) 36 45 (face font-lock-type-face fontified t) 45 54 (fontified t) 54 59 (face font-lock-string-face fontified t) 59 83 (fontified t) 83 86 (face font-lock-comment-delimiter-face fontified t) 86 156 (face font-lock-comment-face fontified t) 156 159 (fontified t) 159 163 (face font-lock-keyword-face fontified t) 163 183 (fontified t) 183 210 (fontified t) 210 334 (fontified t) 334 337 (face font-lock-comment-delimiter-face fontified t) 337 353 (face font-lock-comment-face fontified t) 353 371 (fontified t) 371 387 (face font-lock-string-face fontified t) 387 436 (fontified t) 436 439 (face font-lock-comment-delimiter-face fontified t) 439 450 (face font-lock-comment-face fontified t) 450 468 (fontified t) 468 484 (face font-lock-string-face fontified t) 484 486 (fontified t) 486 488 (face font-lock-keyword-face fontified t) 488 502 (fontified t) 502 507 (face font-lock-string-face fontified t) 507 514 (face font-lock-string-face fontified t) 514 515 (fontified t) 515 522 (face font-lock-string-face fontified t) 522 538 (fontified t) 538 543 (fontified t) 543 547 (face font-lock-keyword-face fontified t) 547 581 (fontified t) 581 613 (face font-lock-string-face fontified t) 613 703 (fontified t) 703 707 (face font-lock-keyword-face fontified t) 707 714 (fontified t) 714 717 (face font-lock-comment-delimiter-face fontified t) 717 747 (face font-lock-comment-face fontified t) 747 799 (fontified t) 799 802 (face font-lock-comment-delimiter-face fontified t) 802 852 (face font-lock-comment-face fontified t) 852 859 (fontified t) 859 862 (face font-lock-comment-delimiter-face fontified t) 862 939 (face font-lock-comment-face fontified t) 939 947 (fontified t) 947 953 (face font-lock-keyword-face fontified t) 953 980 (fontified t) 980 988 (face font-lock-string-face fontified t) 988 1069 (fontified t) 1069 1072 (face font-lock-comment-delimiter-face fontified t) 1072 1103 (face font-lock-comment-face fontified t) 1103 1138 (fontified t) 1138 1141 (face font-lock-comment-delimiter-face fontified t) 1141 1183 (face font-lock-comment-face fontified t) 1183 1209 (fontified t) 1209 1212 (face font-lock-comment-delimiter-face fontified t) 1212 1234 (face font-lock-comment-face fontified t) 1234 1274 (fontified t) 1274 1290 (face font-lock-string-face fontified t) 1290 1297 (fontified t) 1297 1299 (face font-lock-keyword-face fontified t) 1299 1324 (fontified t) 1324 1327 (face font-lock-comment-delimiter-face fontified t) 1327 1378 (face font-lock-comment-face fontified t) 1378 1385 (fontified t) 1385 1390 (face font-lock-keyword-face fontified t) 1390 1448 (fontified t) 1448 1467 (face font-lock-string-face fontified t) 1467 1468 (fontified t) 1468 1477 (face font-lock-string-face fontified t) 1477 1488 (fontified t) 1488 1491 (face font-lock-comment-delimiter-face fontified t) 1491 1501 (face font-lock-comment-face fontified t) 1501 1518 (face font-lock-comment-face fontified t) 1518 1527 (fontified t) 1527 1530 (face font-lock-keyword-face fontified t) 1530 1558 (fontified t) 1558 1564 (face font-lock-keyword-face fontified t) 1564 1578 (fontified t) 1578 1582 (face font-lock-keyword-face fontified t) 1582 1605 (fontified t) 1605 1619 (face font-lock-string-face fontified t) 1619 1692 (fontified t) 1692 1698 (face font-lock-keyword-face fontified t) 1698 1710 (fontified t) 1710 1733 (fontified t) 1733 1774 (face font-lock-string-face fontified t) 1774 1791 (fontified t) 1791 1799 (fontified t) 1799 1802 (face font-lock-comment-delimiter-face fontified t) 1802 1847 (face font-lock-comment-face fontified t) 1847 1877 (fontified t) 1877 1883 (face font-lock-keyword-face fontified t) 1883 1900 (fontified t) 1900 1906 (face font-lock-string-face fontified t) 1906 1919 (fontified t) 1919 1931 (face font-lock-keyword-face fontified t) 1931 1961 (fontified t) 1961 1967 (face font-lock-keyword-face fontified t) 1967 1977 (fontified t) 1977 1981 (face font-lock-keyword-face fontified t) 1981 2031 (fontified t) 2031 2036 (face font-lock-warning-face fontified t) 2036 2038 (fontified t) 2038 2046 (fontified t) 2046 2057 (fontified t) 2057 2070 (face font-lock-keyword-face fontified t) 2070 2105 (fontified t) 2105 2108 (face font-lock-comment-delimiter-face fontified t) 2108 2173 (face font-lock-comment-face fontified t) 2173 2180 (fontified t) 2180 2185 (face font-lock-keyword-face fontified t) 2185 2194 (fontified t) 2194 2197 (face font-lock-comment-delimiter-face fontified t) 2197 2245 (face font-lock-comment-face fontified t) 2245 2254 (fontified t) 2254 2257 (face font-lock-keyword-face fontified t) 2257 2285 (fontified t) 2285 2291 (face font-lock-keyword-face fontified t) 2291 2305 (fontified t) 2305 2309 (face font-lock-keyword-face fontified t) 2309 2332 (fontified t) 2332 2346 (face font-lock-string-face fontified t) 2346 2419 (fontified t) 2419 2425 (face font-lock-keyword-face fontified t) 2425 2460 (fontified t) 2460 2501 (face font-lock-string-face fontified t) 2501 2526 (fontified t) 2526 2529 (face font-lock-comment-delimiter-face fontified t) 2529 2574 (face font-lock-comment-face fontified t) 2574 2604 (fontified t) 2604 2610 (face font-lock-keyword-face fontified t) 2610 2627 (fontified t) 2627 2633 (face font-lock-string-face fontified t) 2633 2645 (fontified t) 2645 2648 (face font-lock-comment-delimiter-face fontified t) 2648 2689 (face font-lock-comment-face fontified t) 2689 2700 (fontified t) 2700 2712 (face font-lock-keyword-face fontified t) 2712 2742 (fontified t) 2742 2748 (face font-lock-keyword-face fontified t) 2748 2754 (fontified t) 2754 2758 (face font-lock-keyword-face fontified t) 2758 2822 (fontified t) 2822 2827 (face font-lock-warning-face fontified t) 2827 2847 (fontified t) 2847 2850 (face font-lock-comment-delimiter-face fontified t) 2850 2919 (face font-lock-comment-face fontified t) 2919 2940 (fontified t) 2940 2943 (face font-lock-comment-delimiter-face fontified t) 2943 2975 (face font-lock-comment-face fontified t) 2975 3005 (fontified t) 3005 3009 (face font-lock-keyword-face fontified t) 3009 3018 (fontified t) 3018 3062 (fontified t) 3062 3158 (fontified t) 3158 3174 (face font-lock-string-face fontified t) 3174 3209 (fontified t) 3209 3212 (face font-lock-keyword-face fontified t) 3212 3241 (fontified t) 3241 3247 (face font-lock-keyword-face fontified t) 3247 3274 (fontified t) 3274 3278 (face font-lock-keyword-face fontified t) 3278 3291 (fontified t) 3291 3301 (fontified t) 3301 3315 (face font-lock-string-face fontified t) 3315 3336 (fontified t) 3336 3390 (fontified t) 3390 3396 (face font-lock-keyword-face fontified t) 3396 3432 (fontified t) 3432 3473 (face font-lock-string-face fontified t) 3473 3522 (fontified t) 3522 3528 (face font-lock-keyword-face fontified t) 3528 3545 (fontified t) 3545 3546 (face font-lock-string-face fontified t) 3546 3551 (face font-lock-string-face fontified t) 3551 3553 (fontified t) 3553 3632 (fontified t) 3632 3635 (face font-lock-comment-delimiter-face fontified t) 3635 3668 (face font-lock-comment-face fontified t) 3668 3734 (fontified t) 3734 3738 (face font-lock-keyword-face fontified t) 3738 3819 (fontified t) 3819 3835 (face font-lock-string-face fontified t) 3835 3932 (fontified t) 3932 3938 (face font-lock-keyword-face fontified t) 3938 3955 (fontified t) 3955 3961 (face font-lock-string-face fontified t) 3961 4044 (fontified t) 4044 4047 (face font-lock-comment-delimiter-face fontified t) 4047 4083 (face font-lock-comment-face fontified t) 4083 4148 (fontified t) 4148 4164 (face font-lock-string-face fontified t) 4164 4165 (fontified t) 4165 4168 (face font-lock-string-face fontified t) 4168 4236 (fontified t) 4236 4239 (face font-lock-comment-delimiter-face fontified t) 4239 4253 (face font-lock-comment-face fontified t) 4253 4286 (fontified t)) . -11486) (undo-tree-id12 . -4286) (undo-tree-id13 . -2975) 15772) nil (26804 50240 228729 0) 0 nil])
([nil nil ((10154 . 10155) (t 26804 50240 0 0)) nil (26804 50330 641959 0) 0 nil])
([nil nil ((11486 . 11487)) nil (26804 50330 641958 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -11486) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) 11487) nil (26804 50330 641954 0) 0 nil])
([nil nil ((16458 . 16466) (#("               " 0 6 (fontified t) 6 15 (fontified t)) . 16458) (16382 . 16390) (#("               " 0 15 (fontified t)) . 16382) (16306 . 16314) (#("               " 0 15 (fontified t)) . 16306) (16294 . 16300) (#("             " 0 13 (fontified t)) . 16294) (16237 . 16241) (#("                  " 0 18 (fontified t)) . 16237) (16177 . 16181) (#("           " 0 11 (fontified t)) . 16177) (16159 . 16162) (#("         " 0 9 (fontified t)) . 16159) (undo-tree-id4 . -9) 14998 (t 26804 50330 0 0)) nil (26812 55916 827551 0) 0 nil])
([nil nil ((16341 . 16350) (#(" " 0 1 (fontified nil)) . 16340) (undo-tree-id3 . -1) (16341 . 16342)) nil (26812 55916 827548 0) 0 nil])
([nil nil ((16426 . 16435) (#(" " 0 1 (fontified nil)) . 16425) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (16426 . 16427)) nil (26812 55916 827543 0) 0 nil])
([nil nil ((16495 . 16504) (t 26812 55916 0 0)) nil (26812 57334 416627 0) 0 nil])
([nil nil ((16504 . 16509)) nil (26812 57334 416626 0) 0 nil])
([nil nil ((16509 . 16510)) nil (26812 57334 416626 0) 0 nil])
([nil nil ((16510 . 16513)) nil (26812 57334 416625 0) 0 nil])
([nil nil ((16513 . 16514)) nil (26812 57334 416625 0) 0 nil])
([nil nil ((16514 . 16518)) nil (26812 57334 416624 0) 0 nil])
([nil nil ((16518 . 16523)) nil (26812 57334 416624 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16609 . 16610) (nil fontified nil 16609 . 16610) (nil fontified nil 16608 . 16609) (nil fontified nil 16597 . 16608) (nil fontified nil 16596 . 16597) (nil fontified nil 16595 . 16596) (nil fontified nil 16584 . 16595) (nil fontified nil 16583 . 16584) (nil fontified nil 16582 . 16583) (nil fontified nil 16571 . 16582) (nil fontified nil 16549 . 16571) (nil fontified nil 16548 . 16549) (nil fontified nil 16535 . 16548) (nil fontified nil 16523 . 16535) (16523 . 16610)) nil (26812 57334 416623 0) 0 nil])
([nil nil ((16607 . 16611) (16552 . 16554) (#("      " 0 6 (fontified nil)) . 16552) (16610 . 16611)) nil (26812 57334 416621 0) 0 nil])
([nil nil ((16611 . 16614)) nil (26812 57334 416620 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -16611) (undo-tree-id8 . -1) (#("-" 0 1 (fontified t)) . -16612) (undo-tree-id9 . -1) (#("'" 0 1 (fontified t)) . -16613) (undo-tree-id10 . -1) 16614) nil (26812 57334 416620 0) 0 nil])
([nil nil ((16611 . 16616)) nil (26812 57334 416615 0) 0 nil])
([nil nil ((16580 . 16585) (#(" " 0 1 (fontified nil)) . 16579) (undo-tree-id7 . -1) (16580 . 16581)) nil (26812 57334 416614 0) 0 nil])
([nil nil ((#("(when peer " 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 11 (fontified t)) . -16633) (undo-tree-id6 . -11) 16644) nil (26812 57334 416612 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -16682) (undo-tree-id5 . -1) 16683) nil (26812 57334 416608 0) 0 nil])
([nil nil ((#("src" 0 3 (fontified t)) . -16573) (undo-tree-id24 . -3) 16576 (t 26812 57334 0 0)) nil (26812 57392 443537 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16576 . 16577) (nil fontified nil 16573 . 16577) (16573 . 16577)) nil (26812 57392 443536 0) 0 nil])
([nil nil ((#("src" 0 3 (fontified t)) . -16560) (undo-tree-id23 . -3) 16563) nil (26812 57392 443535 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16563 . 16564) (nil fontified nil 16560 . 16564) (16560 . 16564)) nil (26812 57392 443534 0) 0 nil])
([nil nil ((#("src" 0 3 (fontified t)) . -16593) (undo-tree-id21 . -3) (undo-tree-id22 . -3) 16596) nil (26812 57392 443533 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16596 . 16597) (nil fontified nil 16593 . 16597) (16593 . 16597)) nil (26812 57392 443531 0) 0 nil])
([nil nil ((#("src" 0 3 (fontified t)) . -16607) (undo-tree-id11 . -3) (undo-tree-id12 . -2) (undo-tree-id13 . -2) (undo-tree-id14 . -2) (undo-tree-id15 . -2) (undo-tree-id16 . -2) (undo-tree-id17 . -3) (undo-tree-id18 . -3) (undo-tree-id19 . -3) (undo-tree-id20 . -3) 16610) nil (26812 57392 443530 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16610 . 16611) (nil fontified nil 16607 . 16611) (16607 . 16611)) nil (26812 57392 443512 0) 0 nil])
([nil nil ((17524 . 17528) (t 26812 57392 0 0)) nil (26812 60095 611426 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17616 . 17617) (nil fontified nil 17577 . 17617) (nil fontified nil 17538 . 17577) (nil fontified nil 17528 . 17538) (17528 . 17617)) nil (26812 60095 611425 0) 0 nil])
([nil nil ((#("
		 (format t \"~&[lumen] response sent (status=~A)~%\"
			 (lumen.core.http:resp-status resp))" 0 1 (fontified t) 1 4 (fontified t) 4 14 (fontified t) 14 53 (face font-lock-string-face fontified t) 53 92 (fontified t) 92 93 (rear-nonsticky t fontified t)) . 17524) (undo-tree-id0 . -93) (undo-tree-id1 . -4) (undo-tree-id2 . -37) (undo-tree-id3 . -93) (undo-tree-id4 . -25) (undo-tree-id5 . -93)) nil (26812 60095 611422 0) 0 nil])
([nil nil ((17603 . 17607) (t 26812 60095 0 0)) nil (26812 60230 516775 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17670 . 17671) (nil fontified nil 17639 . 17671) (nil fontified nil 17617 . 17639) (nil fontified nil 17607 . 17617) (17607 . 17671)) nil (26812 60230 516771 0) 0 nil])
([nil nil ((11486 . 11488) (t 26812 60230 0 0)) nil (26812 62346 392890 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17733 . 17734) (nil fontified nil 11488 . 17734) (11488 . 17734)) nil (26812 62346 392889 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -17733) (undo-tree-id19 . -1) 17734) nil (26812 62346 392889 0) 0 nil])
([nil nil ((11487 . 11489)) nil (26812 62346 392887 0) 0 nil])
([nil nil ((11489 . 11490)) nil (26812 62346 392887 0) 0 nil])
([nil nil ((4425 . 4426)) nil (26812 62346 392886 0) 0 nil])
([nil nil ((4426 . 4429)) nil (26812 62346 392885 0) 0 nil])
([nil nil ((#("~" 0 1 (fontified t)) . -4426) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (#("#" 0 1 (fontified t)) . -4427) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (#("|" 0 1 (face font-lock-comment-face fontified t)) . -4428) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) 4429) nil (26812 62346 392883 0) 0 nil])
([nil nil ((4426 . 4428)) nil (26812 62346 392859 0) 0 nil])
([nil nil ((16548 . 16549) (t 26812 62346 0 0)) nil (26812 62411 436320 0) 0 nil])
([nil nil ((17740 . 17741)) nil (26812 62411 436319 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -17740) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) 17741) nil (26812 62411 436315 0) 0 nil])
([nil nil ((11492 . 11494) (t 26812 62411 0 0)) nil (26812 62746 859554 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15605 . 15606) (nil fontified nil 11494 . 15606) (11494 . 15606)) nil (26812 62746 859553 0) 0 nil])
([nil nil ((#("

(defun write-response (flexi resp &optional (method \"GET\") (keep-alive-p nil))
  ;; RÃ©ponse HTTP + modes streaming (SSE / writer / chunked) SANS conflits TE/CL.
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (copy-list (lumen.core.http:resp-headers resp)))
         (body    (lumen.core.http:resp-body resp)))

    ;; --- Ligne de statut ---
    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)

    ;; --- Connection/Keep-Alive : pas pour upgrade WS (101) ---
    (unless (and (= status 101) (functionp body))
      (format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
      (when keep-alive-p
        (format flexi \"Keep-Alive: timeout=~D, max=~D\"
                (truncate *keep-alive-timeout*) *keep-alive-max*)
        (crlf flexi)))

    (labels
        ((%has-hdr (name)
           (find (string-downcase name) headers :key #'car :test #'string-equal))
         (%rm-hdr (name)
           (setf headers (%remove-header headers name)))
         (%ensure-ct (default)
           (unless (%has-hdr \"content-type\")
             (setf headers (lumen.utils:ensure-header headers \"Content-Type\" default))))
         (%emit-headers ()
           (dolist (h headers) (format flexi \"~A: ~A\" (car h) (cdr h)) (crlf flexi))
           (crlf flexi)))

      (cond
        ;; ===== Upgrade WebSocket =====
        ((and (= status 101) (functionp body))
         ;; on s'appuie STRICTEMENT sur les headers fournis (Upgrade/Connection/Sec-*)
         (%emit-headers)
         (finish-output flexi)
         (funcall body flexi))

        ;; ===== STREAMING (SSE / writer / chunked) =====
        ((functionp body)
         (let* ((ct-cell (%has-hdr \"content-type\"))
                (ctype   (and ct-cell (cdr ct-cell)))
                (is-sse  (and ctype (search \"text/event-stream\" (string-downcase ctype))))
                (cl-cell (%has-hdr \"content-length\")))
           (cond
             ;; ---- SSE RAW : ni CL ni TE ----
             (is-sse
              (%rm-hdr \"Content-Length\")
              (%rm-hdr \"Transfer-Encoding\")
              (%ensure-ct \"text/event-stream; charset=utf-8\")
              (%emit-headers)
              (unless (string= method \"HEAD\")
                (handler-case
                    (funcall body (lambda (s)
                                    (when s
                                      (etypecase s
                                        (string (write-string s flexi))
                                        ((simple-array (unsigned-byte 8) (*))
                                         (write-sequence s flexi)))
                                      (finish-output flexi))))
                  (error () nil))))
             ;; ---- Writer NON-SSE avec CL dÃ©jÃ  posÃ© (ex. Range/206) ----
             (cl-cell
              (%rm-hdr \"Transfer-Encoding\")
              (%emit-headers)
              (unless (string= method \"HEAD\")
                (handler-case
                    (funcall body (lambda (chunk)
                                    (when chunk
                                      (etypecase chunk
                                        (string (write-string chunk flexi))
                                        ((simple-array (unsigned-byte 8) (*))
                                         (write-sequence chunk flexi))))
                                    (finish-output flexi)))
                  (error () nil))))
             ;; ---- Fallback streaming sans CL : chunked si demandÃ©, sinon RAW ----
             (t
              (if *sse-use-chunked*
                  (progn
                    (%rm-hdr \"Content-Length\")
                    (setf headers (lumen.utils:ensure-header headers \"Transfer-Encoding\" \"chunked\"))
                    (%ensure-ct \"text/plain; charset=utf-8\")
                    (%emit-headers)
                    (unless (string= method \"HEAD\")
                      (handler-case
                          (funcall body (lambda (chunk) (when chunk (%write-chunk flexi chunk))))
                        (error () nil))
                      (ignore-errors (%finish-chunked flexi))))
                  ;; RAW sans CL ni TE (compat legacy; prÃ©fÃ©rer chunked hors SSE)
                  (progn
                    (%rm-hdr \"Content-Length\")
                    (%rm-hdr \"Transfer-Encoding\")
                    (%ensure-ct \"text/plain; charset=utf-8\")
                    (%emit-headers)
                    (unless (string= method \"HEAD\")
                      (handler-case
                          (funcall body (lambda (s)
                                          (when s
                                            (etypecase s
                                              (string (write-string s flexi))
                                              ((simple-array (unsigned-byte 8) (*))
                                               (write-sequence s flexi)))
                                            (finish-output flexi))))
                        (error () nil)))))))))

        ;; ===== Corps texte (non-streaming) =====
        ((stringp body)
         (%rm-hdr \"Transfer-Encoding\")
         (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes body))
                (len   (length bytes)))
           (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
           (%ensure-ct \"text/plain; charset=utf-8\")
           (%emit-headers)
           (unless (string= method \"HEAD\")
             (write-string body flexi)
             (finish-output flexi))))

        ;; ===== Corps octets (non-streaming) =====
        ((typep body '(simple-array (unsigned-byte 8) (*)))
         (%rm-hdr \"Transfer-Encoding\")
         (let* ((len (length body)))
           (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
           (%emit-headers)
           (unless (string= method \"HEAD\")
             (write-sequence body flexi)
             (finish-output flexi))))

        ;; ===== Fallback vide =====
        (t
         (%rm-hdr \"Transfer-Encoding\")
         (setf headers (lumen.utils:ensure-header headers \"Content-Length\" \"0\"))
         (%emit-headers)
         (finish-output flexi))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 23 (face font-lock-function-name-face fontified t) 23 36 (fontified t) 36 45 (face font-lock-type-face fontified t) 45 54 (fontified t) 54 59 (face font-lock-string-face fontified t) 59 83 (fontified t) 83 86 (face font-lock-comment-delimiter-face fontified t) 86 163 (face font-lock-comment-face fontified t) 163 166 (fontified t) 166 170 (face font-lock-keyword-face fontified t) 170 342 (fontified t) 342 345 (face font-lock-comment-delimiter-face fontified t) 345 369 (face font-lock-comment-face fontified t) 369 387 (fontified t) 387 403 (face font-lock-string-face fontified t) 403 453 (fontified t) 453 456 (face font-lock-comment-delimiter-face fontified t) 456 514 (face font-lock-comment-face fontified t) 514 519 (fontified t) 519 525 (face font-lock-keyword-face fontified t) 525 570 (fontified t) 570 584 (fontified t) 584 600 (face font-lock-string-face fontified t) 600 602 (fontified t) 602 604 (face font-lock-keyword-face fontified t) 604 618 (fontified t) 618 630 (face font-lock-string-face fontified t) 630 631 (fontified t) 631 638 (face font-lock-string-face fontified t) 638 654 (fontified t) 654 661 (fontified t) 661 665 (face font-lock-keyword-face fontified t) 665 701 (fontified t) 701 733 (face font-lock-string-face fontified t) 733 829 (fontified t) 829 835 (face font-lock-keyword-face fontified t) 835 910 (fontified t) 910 914 (face font-lock-builtin-face fontified t) 914 921 (fontified t) 921 926 (face font-lock-builtin-face fontified t) 926 1069 (fontified t) 1069 1075 (face font-lock-keyword-face fontified t) 1075 1086 (fontified t) 1086 1100 (face font-lock-string-face fontified t) 1100 1164 (fontified t) 1164 1178 (face font-lock-string-face fontified t) 1178 1230 (fontified t) 1230 1236 (face font-lock-keyword-face fontified t) 1236 1263 (fontified t) 1263 1271 (face font-lock-string-face fontified t) 1271 1337 (fontified t) 1337 1341 (face font-lock-keyword-face fontified t) 1341 1350 (fontified t) 1350 1353 (face font-lock-comment-delimiter-face fontified t) 1353 1383 (face font-lock-comment-face fontified t) 1383 1439 (fontified t) 1439 1442 (face font-lock-comment-delimiter-face fontified t) 1442 1498 (face font-lock-comment-face fontified t) 1498 1500 (face font-lock-comment-face fontified t) 1500 1502 (face font-lock-comment-face fontified t) 1502 1517 (face font-lock-comment-face fontified t) 1517 1613 (fontified t) 1613 1616 (face font-lock-comment-delimiter-face fontified t) 1616 1663 (face font-lock-comment-face fontified t) 1663 1699 (fontified t) 1699 1703 (face font-lock-keyword-face fontified t) 1703 1724 (fontified t) 1724 1738 (face font-lock-string-face fontified t) 1738 1839 (fontified t) 1839 1858 (face font-lock-string-face fontified t) 1858 1921 (fontified t) 1921 1937 (face font-lock-string-face fontified t) 1937 1953 (fontified t) 1953 1957 (face font-lock-keyword-face fontified t) 1957 1971 (fontified t) 1971 1974 (face font-lock-comment-delimiter-face fontified t) 1974 2006 (face font-lock-comment-face fontified t) 2006 2050 (fontified t) 2050 2066 (face font-lock-string-face fontified t) 2066 2091 (fontified t) 2091 2110 (face font-lock-string-face fontified t) 2110 2138 (fontified t) 2138 2154 (face font-lock-string-face fontified t) 2154 2172 (face font-lock-string-face fontified t) 2172 2174 (fontified t) 2174 2219 (fontified t) 2219 2225 (face font-lock-keyword-face fontified t) 2225 2242 (fontified t) 2242 2248 (face font-lock-string-face fontified t) 2248 2267 (fontified t) 2267 2279 (face font-lock-keyword-face fontified t) 2279 2315 (fontified t) 2315 2321 (face font-lock-keyword-face fontified t) 2321 2363 (fontified t) 2363 2367 (face font-lock-keyword-face fontified t) 2367 2409 (fontified t) 2409 2418 (face font-lock-keyword-face fontified t) 2418 2721 (fontified t) 2721 2726 (face font-lock-warning-face fontified t) 2726 2751 (fontified t) 2751 2754 (face font-lock-comment-delimiter-face fontified t) 2754 2813 (face font-lock-comment-face fontified t) 2813 2858 (fontified t) 2858 2877 (face font-lock-string-face fontified t) 2877 2924 (fontified t) 2924 2930 (face font-lock-keyword-face fontified t) 2930 2947 (fontified t) 2947 2953 (face font-lock-string-face fontified t) 2953 2972 (fontified t) 2972 2984 (face font-lock-keyword-face fontified t) 2984 3017 (fontified t) 3017 3020 (fontified t) 3020 3026 (face font-lock-keyword-face fontified t) 3026 3035 (fontified t) 3035 3072 (fontified t) 3072 3076 (face font-lock-keyword-face fontified t) 3076 3122 (fontified t) 3122 3131 (face font-lock-keyword-face fontified t) 3131 3444 (fontified t) 3444 3449 (face font-lock-warning-face fontified t) 3449 3474 (fontified t) 3474 3477 (face font-lock-comment-delimiter-face fontified t) 3477 3546 (face font-lock-comment-face fontified t) 3546 3577 (fontified t) 3577 3579 (face font-lock-keyword-face fontified t) 3579 3617 (fontified t) 3617 3622 (face font-lock-keyword-face fontified t) 3622 3652 (fontified t) 3652 3668 (face font-lock-string-face fontified t) 3668 3674 (fontified t) 3674 3739 (fontified t) 3739 3758 (face font-lock-string-face fontified t) 3758 3759 (fontified t) 3759 3768 (face font-lock-string-face fontified t) 3768 3771 (fontified t) 3771 3803 (fontified t) 3803 3830 (face font-lock-string-face fontified t) 3830 3889 (fontified t) 3889 3895 (face font-lock-keyword-face fontified t) 3895 3912 (fontified t) 3912 3918 (face font-lock-string-face fontified t) 3918 3943 (fontified t) 3943 3955 (face font-lock-keyword-face fontified t) 3955 3997 (fontified t) 3997 4003 (face font-lock-keyword-face fontified t) 4003 4013 (fontified t) 4013 4017 (face font-lock-keyword-face fontified t) 4017 4079 (fontified t) 4079 4084 (face font-lock-warning-face fontified t) 4084 4117 (fontified t) 4117 4130 (face font-lock-keyword-face fontified t) 4130 4176 (fontified t) 4176 4179 (face font-lock-comment-delimiter-face fontified t) 4179 4240 (face font-lock-comment-face fontified t) 4240 4259 (fontified t) 4259 4264 (face font-lock-keyword-face fontified t) 4264 4294 (fontified t) 4294 4310 (face font-lock-string-face fontified t) 4310 4341 (fontified t) 4341 4360 (face font-lock-string-face fontified t) 4360 4394 (fontified t) 4394 4421 (face font-lock-string-face fontified t) 4421 4480 (fontified t) 4480 4486 (face font-lock-keyword-face fontified t) 4486 4503 (fontified t) 4503 4509 (face font-lock-string-face fontified t) 4509 4534 (fontified t) 4534 4535 (face font-lock-keyword-face fontified t) 4535 4546 (face font-lock-keyword-face fontified t) 4546 4547 (fontified t) 4547 4588 (fontified t) 4588 4594 (face font-lock-keyword-face fontified t) 4594 4642 (fontified t) 4642 4646 (face font-lock-keyword-face fontified t) 4646 4694 (fontified t) 4694 4703 (face font-lock-keyword-face fontified t) 4703 5011 (fontified t) 5011 5036 (fontified t) 5036 5041 (face font-lock-warning-face fontified t) 5041 5058 (fontified t) 5058 5067 (fontified t) 5067 5070 (face font-lock-comment-delimiter-face fontified t) 5070 5110 (face font-lock-comment-face fontified t) 5110 5152 (fontified t) 5152 5171 (face font-lock-string-face fontified t) 5171 5183 (fontified t) 5183 5187 (face font-lock-keyword-face fontified t) 5187 5272 (fontified t) 5272 5280 (fontified t) 5280 5340 (fontified t) 5340 5356 (face font-lock-string-face fontified t) 5356 5404 (fontified t) 5404 5431 (face font-lock-string-face fontified t) 5431 5472 (fontified t) 5472 5478 (face font-lock-keyword-face fontified t) 5478 5495 (fontified t) 5495 5501 (face font-lock-string-face fontified t) 5501 5589 (fontified t) 5589 5592 (face font-lock-comment-delimiter-face fontified t) 5592 5633 (face font-lock-comment-face fontified t) 5633 5711 (fontified t) 5711 5730 (face font-lock-string-face fontified t) 5730 5742 (fontified t) 5742 5746 (face font-lock-keyword-face fontified t) 5746 5829 (fontified t) 5829 5845 (face font-lock-string-face fontified t) 5845 5909 (fontified t) 5909 5915 (face font-lock-keyword-face fontified t) 5915 5932 (fontified t) 5932 5938 (face font-lock-string-face fontified t) 5938 6028 (fontified t) 6028 6031 (face font-lock-comment-delimiter-face fontified t) 6031 6047 (face font-lock-comment-face fontified t) 6047 6057 (face font-lock-comment-face fontified t) 6057 6086 (fontified t) 6086 6105 (face font-lock-string-face fontified t) 6105 6165 (fontified t) 6165 6181 (face font-lock-string-face fontified t) 6181 6182 (fontified t) 6182 6185 (face font-lock-string-face fontified t) 6185 6213 (fontified t) 6213 6248 (fontified t) 6248 6249 (fontified t)) . -15606) (undo-tree-id29 . -518) (undo-tree-id30 . -828) (undo-tree-id31 . -1328) (undo-tree-id32 . -1671) (undo-tree-id33 . -1671) (undo-tree-id34 . -1026) (undo-tree-id35 . -6248) (undo-tree-id36 . -6248) (undo-tree-id37 . -5357) (undo-tree-id38 . -4942) (undo-tree-id39 . -654) (undo-tree-id40 . -6249) (undo-tree-id41 . -5357) (undo-tree-id42 . -6248) (undo-tree-id43 . -2) (undo-tree-id44 . -2) (undo-tree-id45 . -3035) (undo-tree-id46 . -2) (undo-tree-id47 . -4547) (undo-tree-id48 . -2) (undo-tree-id49 . -6057) (undo-tree-id50 . -6238) (undo-tree-id51 . -6238) (undo-tree-id52 . -6238) (undo-tree-id53 . -6238) (undo-tree-id54 . -6249) 21855) nil (26812 62746 859551 0) 0 nil])
([nil nil ((15605 . 15606)) nil (26812 62746 859528 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15605) (undo-tree-id27 . -1) (undo-tree-id28 . -1) 15606) nil (26812 62746 859525 0) 0 nil])
([nil nil ((15605 . 15607) (t 26812 62746 0 0)) nil (26813 18591 782200 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21819 . 21820) (nil fontified nil 15607 . 21820) (15607 . 21820)) nil (26813 18591 782199 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -21819) (undo-tree-id65 . -1) 21820) nil (26813 18591 782198 0) 0 nil])
([nil nil ((21819 . 21820)) nil (26813 18591 782197 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -21819) (undo-tree-id64 . -1) 21820) nil (26813 18591 782196 0) 0 nil])
([nil nil ((#("
(defun write-response (flexi resp &optional (method \"GET\") (keep-alive-p nil))
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (copy-list (lumen.core.http:resp-headers resp)))
         (body    (lumen.core.http:resp-body resp)))

    ;; Statut
    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)

    ;; Connection/Keep-Alive (hors upgrade WS)
    (unless (and (= status 101) (functionp body))
      (format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
      (when keep-alive-p
        (format flexi \"Keep-Alive: timeout=~D, max=~D\"
                (truncate *keep-alive-timeout*) *keep-alive-max*)
        (crlf flexi)))

    (labels ((%has (name) (find (string-downcase name) headers :key #'car :test #'string-equal))
             (%rm  (name) (setf headers (%remove-header headers name)))
             (%ct! (default)
               (unless (%has \"content-type\")
                 (setf headers (lumen.utils:ensure-header headers \"Content-Type\" default))))
             (%emit ()
               (dolist (h headers) (format flexi \"~A: ~A\" (car h) (cdr h)) (crlf flexi))
               (crlf flexi)))

      (cond
        ;; ===== Upgrade WebSocket =====
        ((and (= status 101) (functionp body))
         (%emit)
         (finish-output flexi)
         (funcall body flexi))

        ;; ===== STREAMING =====
        ((functionp body)
         (let* ((ct (%has \"content-type\"))
                (ctype (and ct (string-downcase (cdr ct))))
                (is-sse (and ctype (search \"text/event-stream\" ctype))))
           (cond
             ;; --- SSE RAW (ni CL ni TE)
             (is-sse
              (%rm \"Content-Length\") (%rm \"Transfer-Encoding\")
              (%ct! \"text/event-stream; charset=utf-8\")
              (%emit)
              (unless (string= method \"HEAD\")
                (handler-case
                    (funcall body (lambda (s)
                                    (when s
                                      (etypecase s
                                        (string (write-string s flexi))
                                        ((simple-array (unsigned-byte 8) (*))
                                         (write-sequence s flexi)))
                                      (finish-output flexi))))
                  (error () nil))))
             ;; --- Tout writer non-SSE â CHUNKED forcÃ©
             (t
              (%rm \"Content-Length\")
              (setf headers (lumen.utils:ensure-header headers \"Transfer-Encoding\" \"chunked\"))
              (%ct! \"text/plain; charset=utf-8\")
              (%emit)
              (unless (string= method \"HEAD\")
                (handler-case
                    (funcall body (lambda (chunk)
                                    (when chunk
                                      (%write-chunk flexi chunk))))
                  (error () nil))
                (ignore-errors (%finish-chunked flexi)))))))

        ;; ===== Corps texte (non-streaming) =====
        ((stringp body)
         (%rm \"Transfer-Encoding\")
         (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes body))
                (len   (length bytes)))
           (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
           (%ct! \"text/plain; charset=utf-8\")
           (%emit)
           (unless (string= method \"HEAD\")
             (write-string body flexi)
             (finish-output flexi))))

        ;; ===== Corps octets (non-streaming) =====
        ((typep body '(simple-array (unsigned-byte 8) (*)))
          (%rm \"Transfer-Encoding\")
          (let ((len (length body)))
            (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
            (%emit)
            (unless (string= method \"HEAD\")
              (write-sequence body flexi)
              (finish-output flexi))))

        ;; ===== Vide =====
        (t
         (%rm \"Transfer-Encoding\")
         (setf headers (lumen.utils:ensure-header headers \"Content-Length\" \"0\"))
         (%emit)
         (finish-output flexi))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 35 (fontified t) 35 44 (face font-lock-type-face fontified t) 44 53 (fontified t) 53 58 (face font-lock-string-face fontified t) 58 83 (fontified t) 83 87 (face font-lock-keyword-face fontified t) 87 259 (fontified t) 259 262 (face font-lock-comment-delimiter-face fontified t) 262 269 (face font-lock-comment-face fontified t) 269 287 (fontified t) 287 303 (face font-lock-string-face fontified t) 303 353 (fontified t) 353 356 (face font-lock-comment-delimiter-face fontified t) 356 396 (face font-lock-comment-face fontified t) 396 401 (fontified t) 401 407 (face font-lock-keyword-face fontified t) 407 466 (fontified t) 466 482 (face font-lock-string-face fontified t) 482 484 (fontified t) 484 486 (face font-lock-keyword-face fontified t) 486 500 (fontified t) 500 512 (face font-lock-string-face fontified t) 512 513 (fontified t) 513 520 (face font-lock-string-face fontified t) 520 543 (fontified t) 543 547 (face font-lock-keyword-face fontified t) 547 583 (fontified t) 583 615 (face font-lock-string-face fontified t) 615 711 (fontified t) 711 717 (face font-lock-keyword-face fontified t) 717 769 (fontified t) 769 773 (face font-lock-builtin-face fontified t) 773 780 (fontified t) 780 785 (face font-lock-builtin-face fontified t) 785 920 (fontified t) 920 926 (face font-lock-keyword-face fontified t) 926 933 (fontified t) 933 947 (face font-lock-string-face fontified t) 947 1015 (fontified t) 1015 1029 (face font-lock-string-face fontified t) 1029 1081 (fontified t) 1081 1087 (face font-lock-keyword-face fontified t) 1087 1114 (fontified t) 1114 1122 (face font-lock-string-face fontified t) 1122 1192 (fontified t) 1192 1196 (face font-lock-keyword-face fontified t) 1196 1205 (fontified t) 1205 1208 (face font-lock-comment-delimiter-face fontified t) 1208 1238 (face font-lock-comment-face fontified t) 1238 1373 (fontified t) 1373 1376 (face font-lock-comment-delimiter-face fontified t) 1376 1398 (face font-lock-comment-face fontified t) 1398 1434 (fontified t) 1434 1438 (face font-lock-keyword-face fontified t) 1438 1450 (fontified t) 1450 1464 (face font-lock-string-face fontified t) 1464 1501 (fontified t) 1501 1527 (fontified t) 1527 1570 (fontified t) 1570 1589 (face font-lock-string-face fontified t) 1589 1612 (fontified t) 1612 1616 (face font-lock-keyword-face fontified t) 1616 1630 (fontified t) 1630 1633 (face font-lock-comment-delimiter-face fontified t) 1633 1659 (face font-lock-comment-face fontified t) 1659 1699 (fontified t) 1699 1715 (face font-lock-string-face fontified t) 1715 1722 (fontified t) 1722 1741 (face font-lock-string-face fontified t) 1741 1763 (fontified t) 1763 1797 (face font-lock-string-face fontified t) 1797 1836 (fontified t) 1836 1842 (face font-lock-keyword-face fontified t) 1842 1859 (fontified t) 1859 1865 (face font-lock-string-face fontified t) 1865 1884 (fontified t) 1884 1896 (face font-lock-keyword-face fontified t) 1896 1932 (fontified t) 1932 1938 (face font-lock-keyword-face fontified t) 1938 1980 (fontified t) 1980 1984 (face font-lock-keyword-face fontified t) 1984 2026 (fontified t) 2026 2035 (face font-lock-keyword-face fontified t) 2035 2338 (fontified t) 2338 2343 (face font-lock-warning-face fontified t) 2343 2368 (fontified t) 2368 2371 (face font-lock-comment-delimiter-face fontified t) 2371 2411 (face font-lock-comment-face fontified t) 2411 2446 (fontified t) 2446 2462 (face font-lock-string-face fontified t) 2462 2527 (fontified t) 2527 2546 (face font-lock-string-face fontified t) 2546 2547 (fontified t) 2547 2556 (face font-lock-string-face fontified t) 2556 2579 (fontified t) 2579 2606 (face font-lock-string-face fontified t) 2606 2645 (fontified t) 2645 2651 (face font-lock-keyword-face fontified t) 2651 2668 (fontified t) 2668 2674 (face font-lock-string-face fontified t) 2674 2693 (fontified t) 2693 2705 (face font-lock-keyword-face fontified t) 2705 2741 (fontified t) 2741 2747 (face font-lock-keyword-face fontified t) 2747 2793 (fontified t) 2793 2797 (face font-lock-keyword-face fontified t) 2797 2891 (fontified t) 2891 2896 (face font-lock-warning-face fontified t) 2896 2923 (fontified t) 2923 2936 (face font-lock-keyword-face fontified t) 2936 2976 (fontified t) 2976 2979 (face font-lock-comment-delimiter-face fontified t) 2979 3019 (face font-lock-comment-face fontified t) 3019 3057 (fontified t) 3057 3076 (face font-lock-string-face fontified t) 3076 3088 (fontified t) 3088 3092 (face font-lock-keyword-face fontified t) 3092 3245 (fontified t) 3245 3261 (face font-lock-string-face fontified t) 3261 3303 (fontified t) 3303 3330 (face font-lock-string-face fontified t) 3330 3363 (fontified t) 3363 3369 (face font-lock-keyword-face fontified t) 3369 3386 (fontified t) 3386 3392 (face font-lock-string-face fontified t) 3392 3433 (fontified t) 3433 3480 (fontified t) 3480 3483 (face font-lock-comment-delimiter-face fontified t) 3483 3524 (face font-lock-comment-face fontified t) 3524 3599 (fontified t) 3599 3618 (face font-lock-string-face fontified t) 3618 3631 (fontified t) 3631 3634 (face font-lock-keyword-face fontified t) 3634 3718 (fontified t) 3718 3734 (face font-lock-string-face fontified t) 3734 3792 (fontified t) 3792 3798 (face font-lock-keyword-face fontified t) 3798 3815 (fontified t) 3815 3821 (face font-lock-string-face fontified t) 3821 3913 (fontified t) 3913 3916 (face font-lock-comment-delimiter-face fontified t) 3916 3933 (face font-lock-comment-face fontified t) 3933 3958 (fontified t) 3958 3977 (face font-lock-string-face fontified t) 3977 4037 (fontified t) 4037 4053 (face font-lock-string-face fontified t) 4053 4054 (fontified t) 4054 4057 (face font-lock-string-face fontified t) 4057 4077 (fontified t) 4077 4112 (fontified t)) . 11493) (undo-tree-id62 . -4112) (undo-tree-id63 . -3471)) nil (26813 18591 782194 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 11493)) nil (26813 18591 782192 0) 0 nil])
([nil nil ((16146 . 16147)) nil (26813 18591 782191 0) 0 nil])
([nil nil ((17707 . 17708)) nil (26813 18591 782190 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -17707) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) 17708) nil (26813 18591 782185 0) 0 nil])
([nil nil ((17210 . 17215) (t 26813 18591 0 0)) nil (26813 18684 910544 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17276 . 17277) (nil fontified nil 17215 . 17277) (17215 . 17277)) nil (26813 18684 910543 0) 0 nil])
([nil nil ((16681 . 16686)) nil (26813 18684 910541 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16747 . 16748) (nil fontified nil 16686 . 16748) (16686 . 16748)) nil (26813 18684 910536 0) 0 nil])
([nil nil ((16681 . 16686) (t 26813 18684 0 0)) nil (26813 19146 622455 0) 0 nil])
([nil nil ((16686 . 16692)) nil (26813 19146 622454 0) 0 nil])
([nil nil ((16692 . 16693)) nil (26813 19146 622454 0) 0 nil])
([nil nil ((16693 . 16696)) nil (26813 19146 622453 0) 0 nil])
([nil nil ((16696 . 16697)) nil (26813 19146 622453 0) 0 nil])
([nil nil ((16697 . 16703)) nil (26813 19146 622452 0) 0 nil])
([nil nil ((16703 . 16704)) nil (26813 19146 622452 0) 0 nil])
([nil nil ((16704 . 16709)) nil (26813 19146 622452 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -16708) (undo-tree-id68 . -1) 16709) nil (26813 19146 622451 0) 0 nil])
([nil nil ((16708 . 16710)) nil (26813 19146 622450 0) 0 nil])
([nil nil ((16708 . 16709)) nil (26813 19146 622449 0) 0 nil])
([nil nil ((16709 . 16710)) nil (26813 19146 622449 0) 0 nil])
([nil nil ((16209 . 16212)) nil (26813 19146 622449 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16237 . 16238) (nil fontified nil 16237 . 16238) (nil fontified nil 16219 . 16237) (nil fontified nil 16212 . 16219) (16212 . 16238)) nil (26813 19146 622448 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . -16235) (undo-tree-id67 . -1) 16236) nil (26813 19146 622447 0) 0 nil])
([nil nil ((16235 . 16236)) nil (26813 19146 622445 0) 0 nil])
([nil nil ((17074 . 17077)) nil (26813 19146 622444 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17102 . 17103) (nil fontified nil 17102 . 17103) (nil fontified nil 17084 . 17102) (nil fontified nil 17077 . 17084) (17077 . 17103)) nil (26813 19146 622444 0) 0 nil])
([nil nil ((#("STRINP" 0 6 (face font-lock-string-face fontified t)) . -17088) (undo-tree-id66 . -6) 17094) nil (26813 19146 622443 0) 0 nil])
([nil nil ((17088 . 17094)) nil (26813 19146 622431 0) 0 nil])
([nil nil ((#("1" 0 1 (face font-lock-string-face fontified t)) . 17100)) nil (26813 19146 622431 0) 0 nil])
([nil nil ((17100 . 17101)) nil (26813 19146 622430 0) 0 nil])
([nil nil ((17366 . 17371)) nil (26813 19146 622430 0) 0 nil])
([nil nil ((nil fontified nil 17396 . 17397) (nil fontified nil 17378 . 17396) (nil fontified nil 17371 . 17378) (17371 . 17397)) nil (26813 19146 622429 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . 17394)) nil (26813 19146 622427 0) 0 nil])
([nil nil ((17394 . 17395)) nil (26813 19146 622423 0) 0 nil])
([nil nil ((11572 . 11575) (t 26813 19146 0 0)) nil (26813 19237 780047 0) 0 nil])
([nil nil ((11575 . 11581)) nil (26813 19237 780046 0) 0 nil])
([nil nil ((11581 . 11582)) nil (26813 19237 780045 0) 0 nil])
([nil nil ((11582 . 11585)) nil (26813 19237 780044 0) 0 nil])
([nil nil ((11585 . 11586)) nil (26813 19237 780044 0) 0 nil])
([nil nil ((11586 . 11591)) nil (26813 19237 780043 0) 0 nil])
([nil nil ((11591 . 11592)) nil (26813 19237 780041 0) 0 nil])
([nil nil ((11592 . 11602)) nil (26813 19237 780027 0) 0 nil])
([nil nil ((11600 . 11601) (t 26813 19237 0 0)) nil (26813 19405 287392 0) 0 nil])
([nil nil ((11601 . 11602)) nil (26813 19405 287391 0) 0 nil])
([nil nil ((12642 . 12648)) nil (26813 19405 287390 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12676 . 12677) (nil fontified nil 12676 . 12677) (nil fontified nil 12655 . 12676) (nil fontified nil 12648 . 12655) (12648 . 12677)) nil (26813 19405 287385 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -12674) (undo-tree-id78 . -1) 12675) nil (26813 19405 287383 0) 0 nil])
([nil nil ((12674 . 12675)) nil (26813 19405 287381 0) 0 nil])
([nil nil ((12777 . 12780)) nil (26813 19405 287380 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12808 . 12809) (nil fontified nil 12808 . 12809) (nil fontified nil 12787 . 12808) (nil fontified nil 12780 . 12787) (12780 . 12809)) nil (26813 19405 287379 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . 12806)) nil (26813 19405 287378 0) 0 nil])
([nil nil ((12806 . 12807)) nil (26813 19405 287377 0) 0 nil])
([nil nil ((12999 . 13002)) nil (26813 19405 287376 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13030 . 13031) (nil fontified nil 13030 . 13031) (nil fontified nil 13009 . 13030) (nil fontified nil 13002 . 13009) (13002 . 13031)) nil (26813 19405 287375 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13028) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) 13029) nil (26813 19405 287372 0) 0 nil])
([nil nil ((13028 . 13029)) nil (26813 19405 287362 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-string-face fontified t)) . -13028) (undo-tree-id70 . -1) 13029) nil (26813 19405 287361 0) 0 nil])
([nil nil ((13028 . 13029)) nil (26813 19405 287356 0) 0 nil])
([nil nil ((17812 . 17815)) nil (26813 19405 287355 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17843 . 17844) (nil fontified nil 17843 . 17844) (nil fontified nil 17822 . 17843) (nil fontified nil 17815 . 17822) (17815 . 17844)) nil (26813 19405 287354 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -17841) (undo-tree-id69 . -1) 17842) nil (26813 19405 287350 0) 0 nil])
([nil nil ((17841 . 17843)) nil (26813 19405 287322 0) 0 nil])
([nil nil ((18043 . 18046) (t 26813 19405 0 0)) nil (26813 19424 163961 0) 0 nil])
([nil nil ((nil fontified nil 18107 . 18108) (nil fontified nil 18085 . 18107) (nil fontified nil 18056 . 18085) (nil fontified nil 18046 . 18056) (18046 . 18108)) nil (26813 19424 163957 0) 0 nil])
([nil nil ((13594 . 13602) (t 26813 19424 0 0)) nil (26813 19618 675841 0) 0 nil])
([nil nil ((nil fontified nil 13663 . 13664) (nil fontified nil 13641 . 13663) (nil fontified nil 13612 . 13641) (nil fontified nil 13602 . 13612) (13602 . 13664)) nil (26813 19618 675840 0) 0 nil])
([nil nil ((14904 . 14910)) nil (26813 19618 675838 0) 0 nil])
([nil nil ((nil fontified nil 14971 . 14972) (nil fontified nil 14949 . 14971) (nil fontified nil 14920 . 14949) (nil fontified nil 14910 . 14920) (14910 . 14972)) nil (26813 19618 675838 0) 0 nil])
([nil nil ((15750 . 15756)) nil (26813 19618 675836 0) 0 nil])
([nil nil ((nil fontified nil 15817 . 15818) (nil fontified nil 15795 . 15817) (nil fontified nil 15766 . 15795) (nil fontified nil 15756 . 15766) (15756 . 15818)) nil (26813 19618 675835 0) 0 nil])
([nil nil ((13320 . 13327)) nil (26813 19618 675834 0) 0 nil])
([nil nil ((nil fontified nil 13355 . 13356) (nil fontified nil 13334 . 13355) (nil fontified nil 13327 . 13334) (13327 . 13356)) nil (26813 19618 675833 0) 0 nil])
([nil nil ((#("WRITE RESPONSE 3" 0 16 (face font-lock-string-face fontified t)) . -13338) (undo-tree-id129 . -16) (undo-tree-id130 . -16) (undo-tree-id131 . -16) 13354) nil (26813 19618 675832 0) 0 nil])
([nil nil ((13338 . 13346)) nil (26813 19618 675828 0) 0 nil])
([nil nil ((13346 . 13347)) nil (26813 19618 675827 0) 0 nil])
([nil nil ((13347 . 13352)) nil (26813 19618 675826 0) 0 nil])
([nil nil ((13352 . 13353)) nil (26813 19618 675826 0) 0 nil])
([nil nil ((13353 . 13356)) nil (26813 19618 675825 0) 0 nil])
([nil nil ((#("(print \"IN FONCTION BODY: SSE\")" 0 7 (fontified t) 7 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . 13327) (undo-tree-id118 . -11) (undo-tree-id119 . -11) (undo-tree-id120 . -11) (undo-tree-id121 . -11) (undo-tree-id122 . -31) (undo-tree-id123 . -31) (undo-tree-id124 . -31) (undo-tree-id125 . -31) (undo-tree-id126 . -31) (undo-tree-id127 . -31) (undo-tree-id128 . -31)) nil (26813 19618 675824 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 13320) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1)) nil (26813 19618 675809 0) 0 nil])
([nil nil ((13347 . 13355)) nil (26813 19618 675783 0) 0 nil])
([nil nil ((nil fontified nil 13385 . 13386) (nil fontified nil 13362 . 13385) (nil fontified nil 13355 . 13362) (13355 . 13386)) nil (26813 19618 675783 0) 0 nil])
([nil nil ((14395 . 14403)) nil (26813 19618 675781 0) 0 nil])
([nil nil ((nil fontified nil 14433 . 14434) (nil fontified nil 14410 . 14433) (nil fontified nil 14403 . 14410) (14403 . 14434)) nil (26813 19618 675781 0) 0 nil])
([nil nil ((#("SSE" 0 3 (face font-lock-string-face fontified t)) . -14429) (undo-tree-id89 . -3) (undo-tree-id90 . -2) (undo-tree-id91 . -2) (undo-tree-id92 . -2) (undo-tree-id93 . -2) (undo-tree-id94 . -2) (undo-tree-id95 . -3) (undo-tree-id96 . -3) (undo-tree-id97 . -3) (undo-tree-id98 . -3) 14432) nil (26813 19618 675779 0) 0 nil])
([nil nil ((14429 . 14436)) nil (26813 19618 675770 0) 0 nil])
([nil nil ((15551 . 15557)) nil (26813 19618 675769 0) 0 nil])
([nil nil ((nil fontified nil 15587 . 15588) (nil fontified nil 15564 . 15587) (nil fontified nil 15557 . 15564) (15557 . 15588)) nil (26813 19618 675768 0) 0 nil])
([nil nil ((#("SSE" 0 3 (face font-lock-string-face fontified t)) . -15583) (undo-tree-id79 . -3) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -3) (undo-tree-id86 . -3) (undo-tree-id87 . -3) (undo-tree-id88 . -3) 15586) nil (26813 19618 675765 0) 0 nil])
([nil nil ((15583 . 15586)) nil (26813 19618 675740 0) 0 nil])
([nil nil ((15234 . 15241) (t 26813 19618 0 0)) nil (26813 19762 263881 0) 0 nil])
([nil nil ((15241 . 15247)) nil (26813 19762 263880 0) 0 nil])
([nil nil ((15247 . 15248)) nil (26813 19762 263879 0) 0 nil])
([nil nil ((15248 . 15255)) nil (26813 19762 263878 0) 0 nil])
([nil nil ((15354 . 15361)) nil (26813 19762 263878 0) 0 nil])
([nil nil ((15361 . 15367)) nil (26813 19762 263877 0) 0 nil])
([nil nil ((15367 . 15368)) nil (26813 19762 263876 0) 0 nil])
([nil nil ((15368 . 15375)) nil (26813 19762 263876 0) 0 nil])
([nil nil ((15442 . 15449)) nil (26813 19762 263875 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15462 . 15463) (nil fontified nil 15462 . 15463) (nil fontified nil 15456 . 15462) (nil fontified nil 15449 . 15456) (15449 . 15463)) nil (26813 19762 263873 0) 0 nil])
([nil nil ((#("YYYY" 0 4 (face font-lock-string-face fontified t)) . -15457) (undo-tree-id132 . -4) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -4) (undo-tree-id144 . -4) (undo-tree-id145 . -4) (undo-tree-id146 . -4) 15461) nil (26813 19762 263869 0) 0 nil])
([nil nil ((15457 . 15461)) nil (26813 19762 263828 0) 0 nil])
([nil nil ((#("
	      (print \"IN FONCTION BODY: CHUNKED\")" 0 1 (fontified t) 1 8 (fontified t) 8 15 (fontified t) 15 42 (face font-lock-string-face fontified t) 42 43 (fontified t rear-nonsticky t)) . 14395) (undo-tree-id159 . -43) (undo-tree-id160 . -8) (undo-tree-id161 . -34) (undo-tree-id162 . -43) (undo-tree-id163 . -43) (undo-tree-id164 . -43) (undo-tree-id165 . -43) (t 26813 19762 0 0)) nil (26813 23716 587682 0) 0 nil])
([nil nil ((#("
			   (print \"XXXX\")" 0 1 (fontified t) 1 14 (fontified t) 14 20 (face font-lock-string-face fontified t) 20 21 (fontified t)) . 15191) (undo-tree-id153 . -21) (undo-tree-id154 . -21) (undo-tree-id155 . -21) (undo-tree-id156 . -21) (undo-tree-id157 . -21) (undo-tree-id158 . -21)) nil (26813 23716 587761 0) 0 nil])
([nil nil ((#("
			   (print \"ZZZZ\")" 0 1 (fontified t) 1 7 (fontified t) 7 14 (fontified t) 14 20 (face font-lock-string-face fontified t) 20 21 (fontified t rear-nonsticky t)) . 15378) (undo-tree-id184 . -21)) nil (26813 23797 165455 0) 0 nil] [nil nil ((#("
			   (print \"YYYY\")" 0 1 (fontified t) 1 14 (fontified t) 14 20 (face font-lock-string-face fontified t) 20 21 (fontified t)) . 15290) (undo-tree-id147 . -21) (undo-tree-id148 . -7) (undo-tree-id149 . -21) (undo-tree-id150 . -21) (undo-tree-id151 . -21) (undo-tree-id152 . -21)) ((15290 . 15311)) (26813 23716 587661 0) 0 nil])
([nil nil ((#("
			   (print \"YYYY\")" 0 1 (fontified t) 1 14 (fontified t) 14 20 (face font-lock-string-face fontified t) 20 21 (fontified t)) . 15290) (undo-tree-id183 . -21)) nil (26813 23797 165454 0) 0 nil])
nil
([nil nil ((#("
		   (print \"IN FONCTION BODY: RAW\")" 0 1 (face font-lock-comment-face fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 36 (face font-lock-string-face fontified t) 36 37 (fontified t rear-nonsticky t)) . 15508) (undo-tree-id182 . -37)) nil (26813 23797 165452 0) 0 nil])
([nil nil ((#("
	   (print \"IN STRINP BODY 1\")" 0 1 (fontified t) 1 12 (fontified t) 12 30 (face font-lock-string-face fontified t) 30 31 (fontified t)) . 17092) (undo-tree-id181 . -31)) nil (26813 23797 165451 0) 0 nil])
([nil nil ((15801 . 15803)) nil (26813 23797 165449 0) 0 nil])
([nil nil ((#("
	 (print \"IN STRINP BODY 0\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 28 (face font-lock-string-face fontified t) 28 29 (fontified t rear-nonsticky t)) . 16593) (undo-tree-id180 . -29)) nil (26813 23797 165449 0) 0 nil])
([nil nil ((17070 . 17072)) nil (26813 23797 165447 0) 0 nil])
([nil nil ((13647 . 13649)) nil (26813 23797 165446 0) 0 nil])
([nil nil ((#("
	      (print \"IN FONCTION BODY: SSE\")" 0 1 (fontified t) 1 8 (fontified t) 8 15 (fontified t) 15 38 (face font-lock-string-face fontified t) 38 39 (fontified t rear-nonsticky t)) . 13347) (undo-tree-id179 . -39)) nil (26813 23797 165446 0) 0 nil])
([nil nil ((#("
	 (print \"IN WRITE RESPONSE 3\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 31 (face font-lock-string-face fontified t) 31 32 (rear-nonsticky t fontified t)) . 12999) (undo-tree-id178 . -32)) nil (26813 23797 165444 0) 0 nil])
([nil nil ((#("
	 (print \"IN WRITE RESPONSE 2\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 31 (face font-lock-string-face fontified t) 31 32 (rear-nonsticky t fontified t)) . 12777) (undo-tree-id177 . -32)) nil (26813 23797 165443 0) 0 nil])
([nil nil ((#("
      (print \"IN WRITE RESPONSE 1\")" 0 1 (fontified t) 1 7 (fontified t) 7 14 (fontified t) 14 35 (face font-lock-string-face fontified t) 35 36 (rear-nonsticky t fontified t)) . 12641) (undo-tree-id176 . -36)) nil (26813 23797 165441 0) 0 nil])
([nil nil ((#("
  (print \"IN WRITE RESPONSE 0\")" 0 1 (fontified t) 1 10 (fontified t) 10 31 (face font-lock-string-face fontified t) 31 32 (fontified t)) . 11572) (undo-tree-id175 . -32)) nil (26813 23797 165440 0) 0 nil])
([nil nil ((#("
	 (print \"IN WRITE RESPONSE 15\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 29 (face font-lock-string-face fontified t) 29 32 (face font-lock-string-face fontified t) 32 33 (fontified t rear-nonsticky t)) . 17838) (undo-tree-id174 . -33)) nil (26813 23797 165435 0) 0 nil])
([nil nil ((18039 . 18040)) nil (26813 23797 165433 0) 0 nil])
([nil nil ((18040 . 18041)) nil (26813 23797 165433 0) 0 nil])
([nil nil ((#("
	   (print \"IN OCTETS BODY 1\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . 17523) (undo-tree-id173 . -31)) nil (26813 23797 165432 0) 0 nil])
([nil nil ((#("
	 (print \"IN OCTETS BODY 0\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 28 (face font-lock-string-face fontified t) 28 29 (fontified t rear-nonsticky t)) . 17231) (undo-tree-id170 . -29) (undo-tree-id171 . -29) (undo-tree-id172 . -29)) nil (26813 23797 165430 0) 0 nil])
([nil nil ((17499 . 17501)) nil (26813 23797 165426 0) 0 nil])
([nil nil ((#("," 0 1 (fontified t)) . -17499) (undo-tree-id166 . -1) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (#("," 0 1 (fontified t)) . -17500) (undo-tree-id169 . -1) 17501) nil (26813 23797 165423 0) 0 nil])
([nil nil ((17499 . 17501)) nil (26813 23797 165402 0) 0 nil])
([nil nil ((14786 . 14788) (t 26813 23797 0 0)) nil (26821 18044 555550 0) 0 nil])
([nil nil ((24250 . 24252)) nil (26821 18044 555548 0) 0 nil])
([nil nil ((#("
			 " 0 5 (fontified t)) . -24369) (undo-tree-id0 . -5) 24374) nil (26821 18044 555546 0) 0 nil])
([nil nil ((24369 . 24370)) nil (26821 18044 555528 0) 0 nil])
([nil nil ((24320 . 24322)) nil (26821 18044 555523 0) 0 nil])
([nil nil ((24407 . 24411) (t 26821 18044 0 0)) nil (26821 22214 815467 0) 0 nil])
([nil nil ((22293 . 22302) (t 26821 22214 0 0)) nil (26946 41579 606412 0) 0 nil])
([nil nil ((nil fontified nil 22331 . 22332) (nil fontified nil 22328 . 22331) (nil fontified nil 22312 . 22328) (nil fontified nil 22302 . 22312) (22302 . 22332)) nil (26946 41579 606411 0) 0 nil])
([nil nil ((#("QP" 0 2 (face font-lock-string-face fontified t)) . -22319) (undo-tree-id13 . -2) 22321) nil (26946 41579 606410 0) 0 nil])
([nil nil ((22319 . 22322)) nil (26946 41579 606409 0) 0 nil])
([nil nil ((#("qp" 0 2 (fontified t)) . -22330) (undo-tree-id11 . -2) (undo-tree-id12 . -1) 22332) nil (26946 41579 606408 0) 0 nil])
([nil nil ((22330 . 22333)) nil (26946 41579 606404 0) 0 nil])
([nil nil ((#("uri" 0 3 (face font-lock-string-face fontified t)) . -22319) (undo-tree-id0 . -3) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -3) (undo-tree-id8 . -3) (undo-tree-id9 . -3) (undo-tree-id10 . -3) 22322) nil (26946 41579 606403 0) 0 nil])
([nil nil ((22319 . 22322)) nil (26946 41579 606378 0) 0 nil])
([nil nil ((1 . 27777) (#("(in-package :cl)

(defpackage :lumen.core.server
  (:use :cl :alexandria)
  (:import-from :lumen.utils :ensure-header)
  (:import-from :lumen.core.http :request :response :resp-status :resp-headers :resp-body :respond-sse)
  (:import-from :lumen.core.error :*error-handler*)
  (:import-from :lumen.core.shutdown :register-connection :unregister-connection
		:draining-p)
  (:export :start :stop))

(in-package :lumen.core.server)

(defparameter *server-socket* nil)
(defparameter *accept-thread* nil)
(defparameter *port* 8080)
(defparameter *use-chunked* t) ; passe Ã  T si tu veux tester le chunked
(defparameter *sse-use-chunked* nil) ; â mets T plus tard si tu veux rebasculer sur chunked

(defparameter *handler*
  (lambda (req)
    (declare (ignore req))
    (make-instance 'response :status 500 :headers nil :body \"\")))

(defparameter *keep-alive* t)
(defparameter *keep-alive-timeout* 5.0)  ; secondes dâinactivitÃ© max
(defparameter *keep-alive-max* 100)      ; requÃªtes max par connexion

;; Server
(defparameter *server-socket* nil)       ; HTTP
(defparameter *accept-thread* nil)

(defparameter *server-socket-tls* nil)   ; HTTPS
(defparameter *accept-thread-tls* nil)

(defparameter *ssl-enabled* nil)
(defparameter *ssl-port* 8443)
(defparameter *ssl-context* nil)
(defparameter *ssl-cert-file* nil)
(defparameter *ssl-key-file* nil)
(defparameter *ssl-key-password* nil)  ; si la clÃ© est chiffrÃ©e

(defun http11-p (ver) (and ver (search \"HTTP/1.1\" ver)))

(defun want-keep-alive-p (http-ver headers)
  \"Politique standard : HTTP/1.1 â keep-alive par dÃ©faut ; HTTP/1.0 â close par dÃ©faut.
   Connection: close/keep-alive force la dÃ©cision.\"
  (let* ((conn (header headers \"connection\")))
    (cond
      ((and conn (string-equal conn \"close\")) nil)
      ((and conn (string-equal conn \"keep-alive\")) t)
      ((http11-p http-ver) t)
      (t nil))))

(defun %ensure-existing-pathname (x)
  (etypecase x
    (pathname (or (probe-file x) (error \"SSL: file not found: ~A\" x)))
    (string   (or (probe-file x) (error \"SSL: file not found: ~A\" x)))))

(defun init-ssl-context ()
  (unless (and *ssl-cert-file* *ssl-key-file*)
    (error \"SSL enabled but no certificate/key provided. Set *ssl-cert-file* and *ssl-key-file*.\"))
  (let ((cert (namestring ( %ensure-existing-pathname *ssl-cert-file*)))
        (pkey (namestring ( %ensure-existing-pathname *ssl-key-file*))))
    (setf *ssl-context*
          (cl+ssl:make-context
            ;; dÃ©sactive SSLv2/v3 ; garde TLS modernes
            :disabled-protocols (list cl+ssl:+ssl-op-no-sslv2+ cl+ssl:+ssl-op-no-sslv3+)
            ;; tu peux aussi ajouter :min-proto-version si dispo, p.ex.:
            ;; :min-proto-version cl+ssl:+tls1-2-version+
            :verify-mode cl+ssl:+ssl-verify-none+
            :certificate-chain-file cert
            :private-key-file       pkey
            :private-key-password   *ssl-key-password*))))

(defun ->crlf (s) (concatenate 'string s \"\\r\\n\"))

(defun crlf (s)
  \"Ãcrit une fin de ligne correcte quand le flux est ouvert avec :eol-style :crlf.\"
  (write-char #\\Newline s))  ; pas de #\\Return ici !

(defun status-reason (status)
  (case status
    (200 \"OK\") (201 \"Created\") (204 \"No Content\")
    (400 \"Bad Request\") (401 \"Unauthorized\") (403 \"Forbidden\")
    (404 \"Not Found\") (500 \"Internal Server Error\")
    (t \"OK\")))

(defun %wr-crlf (flexi)
  (write-char #\\Return flexi)  ; \\r
  (write-char #\\Newline flexi)) ; \\n

(defun %remove-header (headers name)
  (remove-if (lambda (h) (string-equal (car h) name)) headers))

(defun %write-headers (flexi headers)
  (dolist (h headers)
    (format flexi \"~A: ~A\" (car h) (cdr h))
    (crlf flexi)
    ))

(defun %write-chunk (flexi data)
  (etypecase data
    (string
     (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes data))
            (n (length bytes)))
       (format flexi \"~X\" n) (%wr-crlf flexi) ; fin de la ligne âtailleâ
       (write-string data flexi)
       (%wr-crlf flexi)                       ; fin du chunk
       (finish-output flexi)))
    ((simple-array (unsigned-byte 8) (*))
     (let ((n (length data)))
       (format flexi \"~X\" n) (%wr-crlf flexi)
       (write-sequence data flexi)            ; CL:WRITE-SEQUENCE OK sur octets
       (%wr-crlf flexi)
       (finish-output flexi)))))

(defun %finish-chunked (flexi)
  (write-string \"0\" flexi)
  (%wr-crlf flexi)  ; \\r\\n
  (%wr-crlf flexi)  ; \\r\\n (ligne vide)
  (finish-output flexi))

#|
(defun write-response (flexi resp &optional (method \"GET\") (keep-alive-p nil))
  ;; RÃ©ponse HTTP classique + modes streaming (SSE / writer non-chunked / chunked).
  (let* ((status  (lumen.core.http:resp-status resp))
         (headers (copy-list (lumen.core.http:resp-headers resp)))
         (body    (lumen.core.http:resp-body resp)))

    ;; Ligne de statut
    (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)

    ;; Connection/Keep-Alive : ne pas Ã©crire pour un upgrade WebSocket (101)
    (unless (and (= status 101) (functionp body))
      (format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
      (when keep-alive-p
        (format flexi \"Keep-Alive: timeout=~D, max=~D\"
                (truncate *keep-alive-timeout*) *keep-alive-max*)
        (crlf flexi)))

    (cond
      ;; ===== Upgrade WebSocket =====
      ((and (= status 101) (functionp body))
       ;; On s'appuie STRICTEMENT sur les headers fournis (Upgrade/Connection/Sec-*)
       (dolist (h headers) (format flexi \"~A: ~A\" (car h) (cdr h)) (crlf flexi))
       (crlf flexi) (finish-output flexi)
       (funcall body flexi))  ; passe le flux au handler WS

      ;; ========= STREAMING (SSE, fichiers avec writer, etc.) =========
      ((functionp body)
       (let* ((cl-cell (find \"content-length\" headers :key #'car :test #'string-equal))
              (ct-cell (find \"content-type\"   headers :key #'car :test #'string-equal))
              (ctype   (and ct-cell (cdr ct-cell)))
              (is-sse  (and ctype (search \"text/event-stream\" (string-downcase ctype)))))

         (cond
           ;; ---- SSE : pas de Content-Length / pas de chunked (RAW) ----
           (is-sse
            ;; On retire explicitement tout Content-Length
            (setf headers (%remove-header headers \"Content-Length\"))
            ;; Ãcrit les headers applicatifs (Content-Type SSE si absent)
            (let ((have-ct (not (null ct-cell))))
              (%write-headers flexi headers)
              (unless have-ct
                (format flexi \"Content-Type: text/event-stream; charset=utf-8\") (crlf flexi)))
            ;; ligne vide -> corps
            (crlf flexi)
            (unless (string= method \"HEAD\")
              (handler-case
                  (funcall body (lambda (s)
                                  (when s
                                    (etypecase s
                                      (string (write-string s flexi))
                                      ((simple-array (unsigned-byte 8) (*))
                                       (write-sequence s flexi)))
                                    (finish-output flexi))))
                (error () nil)))
            ;; pas de fin chunked : la connexion vit tant que SSE vit
            )

           ;; ---- Writer NON-SSE avec Content-Length dÃ©jÃ  posÃ© (ex. Range/206) ----
           (cl-cell
            ;; On respecte Content-Length posÃ© par lâappelant (pas de chunked)
            (%write-headers flexi headers)
            (crlf flexi)
            (unless (string= method \"HEAD\")
              (handler-case
                  (funcall body (lambda (chunk)
                                  (when chunk
                                    (etypecase chunk
                                      (string (write-string chunk flexi))
                                      ((simple-array (unsigned-byte 8) (*))
                                       (write-sequence chunk flexi))))
                                  (finish-output flexi)))
                (error () nil))))

           ;; ---- Fallback streaming sans Content-Length (non-SSE) ----
           (t
            ;; Choix: chunked si *sse-use-chunked* est T, sinon RAW (hÃ©rite de ton ancien comportement)
            (if *sse-use-chunked*
                (progn
                  (setf headers (lumen.utils:ensure-header headers \"Transfer-Encoding\" \"chunked\"))
                  ;; Ã©crire headers (assurer un Content-Type minimal si absent)
                  (let ((have-ct nil))
                    (dolist (h headers)
                      (when (string-equal (car h) \"content-type\") (setf have-ct t)))
                    (%write-headers flexi headers)
                    (unless have-ct
                      (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
                  (crlf flexi)
                  (unless (string= method \"HEAD\")
                    (handler-case
                        (funcall body (lambda (chunk) (when chunk (%write-chunk flexi chunk))))
                      (error () nil))
                    (ignore-errors (%finish-chunked flexi))))
                ;; RAW sans Content-Length (dÃ©conseillÃ© hors SSE, conservÃ© pour compat)
                (progn
                  (let ((have-ct nil))
                    (dolist (h headers)
                      (when (string-equal (car h) \"content-type\") (setf have-ct t)))
                    (%write-headers flexi headers)
                    (unless have-ct
                      (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
                  (crlf flexi)
                  (unless (string= method \"HEAD\")
                    (handler-case
                        (funcall body (lambda (s)
                                        (when s
                                          (etypecase s
                                            (string (write-string s flexi))
                                            ((simple-array (unsigned-byte 8) (*))
                                             (write-sequence s flexi)))
                                          (finish-output flexi))))
                      (error () nil)))))))))

      ;; ========= Corps texte =========
      ((stringp body)
       (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes body))
              (len   (length bytes)))
         (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
         (let ((have-ct nil))
           (dolist (h headers)
             (when (string-equal (car h) \"content-type\") (setf have-ct t)))
           (%write-headers flexi headers)
           (unless have-ct
             (format flexi \"Content-Type: text/plain; charset=utf-8\") (crlf flexi)))
         (crlf flexi)
         (unless (string= method \"HEAD\")
           (write-string body flexi)
           (finish-output flexi))))

      ;; ========= Corps octets =========
      ((typep body '(simple-array (unsigned-byte 8) (*)))
       (let* ((len (length body)))
         (setf headers (lumen.utils:ensure-header headers \"Content-Length\" (write-to-string len)))
         (%write-headers flexi headers)
         (crlf flexi)
         (unless (string= method \"HEAD\")
           (write-sequence body flexi)
           (finish-output flexi))))

      ;; ========= Fallback (vide) =========
      (t
       (setf headers (lumen.utils:ensure-header headers \"Content-Length\" \"0\"))
       (%write-headers flexi headers)
       (crlf flexi)
       (finish-output flexi)))))
|#

(defun write-response (flexi resp &optional (method \"GET\") (keep-alive-p nil))
  (labels
      ((%rm (headers name) (remove-if (lambda (h) (string-equal (car h) name)) headers))
       (%has (headers name) (find name headers :key #'car :test #'string-equal))
       (%ensure (headers name val) (lumen.utils:ensure-header headers name val))
       (%emit-headers (hdrs)
         (dolist (h hdrs)
           (format flexi \"~A: ~A\" (car h) (cdr h))
           (crlf flexi))))
    (let* ((status  (lumen.core.http:resp-status resp))
           (headers (copy-list (lumen.core.http:resp-headers resp)))
           (body    (lumen.core.http:resp-body resp)))

      ;; Ligne de statut
      (format flexi \"HTTP/1.1 ~A ~A\" status (status-reason status)) (crlf flexi)

      ;; Connection (sauf WS 101)
      (unless (and (= status 101) (functionp body))
        (format flexi \"Connection: ~A\" (if keep-alive-p \"keep-alive\" \"close\")) (crlf flexi)
        (when keep-alive-p
          (format flexi \"Keep-Alive: timeout=~D, max=~D\"
                  (truncate *keep-alive-timeout*) *keep-alive-max*)
          (crlf flexi)))
      (cond
        ;; ===== WebSocket Upgrade =====
        ((and (= status 101) (functionp body))
         (%emit-headers headers)
         (crlf flexi) (finish-output flexi)
         (funcall body flexi))

        ;; ===== BODY = writer (SSE / streaming) =====
        ((functionp body)
         (let* ((ct-cell (%has headers \"content-type\"))
                (ctype   (and ct-cell (cdr ct-cell)))
                (is-sse  (and ctype (search \"text/event-stream\" (string-downcase ctype)))))
           (cond
             ;; --- SSE : RAW, ni Content-Length ni Transfer-Encoding	     
             (is-sse
              (setf headers (%rm headers \"content-length\"))
              (setf headers (%rm headers \"transfer-encoding\"))
              (unless ct-cell
                (setf headers (%ensure headers \"Content-Type\" \"text/event-stream; charset=utf-8\")))
	      ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
              (%emit-headers headers)
              (crlf flexi)
              (unless (string= method \"HEAD\")
                (handler-case
                    (funcall body (lambda (chunk)
                                    (when chunk
                                      (etypecase chunk
                                        (string (write-string chunk flexi))
                                        ((simple-array (unsigned-byte 8) (*))
                                         (write-sequence chunk flexi)))
                                      (finish-output flexi))))
                  (error () nil))))

             ;; --- Non-SSE : forcer un seul mode
             (t
              (let ((use-chunked t))      ; â tu peux rendre Ã§a configurable
                (cond
                  (use-chunked
                   ;; chunked : pas de Content-Length
                   (setf headers (%rm headers \"content-length\"))
                   (setf headers (%ensure (%rm headers \"transfer-encoding\") \"Transfer-Encoding\" \"chunked\"))
                   ;; CT minimal si absent
                   (unless (%has headers \"content-type\")
                     (setf headers (%ensure headers \"Content-Type\" \"application/octet-stream\")))
		   ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
                   (%emit-headers headers) (crlf flexi)
                   (unless (string= method \"HEAD\")
                     (handler-case
                         (progn
                           (funcall body (lambda (chunk) (when chunk (%write-chunk flexi chunk))))
                           (ignore-errors (%finish-chunked flexi)))
                       (error () (ignore-errors (%finish-chunked flexi))))))
                  (t
                   ;; RAW (non recommandÃ© hors SSE)
                   (setf headers (%rm headers \"content-length\"))
                   (setf headers (%rm headers \"transfer-encoding\"))
                   (unless (%has headers \"content-type\")
                     (setf headers (%ensure headers \"Content-Type\" \"application/octet-stream\")))
		   ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
                   (%emit-headers headers) (crlf flexi)
                   (unless (string= method \"HEAD\")
                     (handler-case
                         (funcall body (lambda (chunk)
                                         (when chunk
                                           (etypecase chunk
                                             (string (write-string chunk flexi))
                                             ((simple-array (unsigned-byte 8) (*))
                                              (write-sequence chunk flexi)))
                                           (finish-output flexi))))
                       (error () nil))))))))))

        ;; ===== BODY = string =====
        ((stringp body)
         ;; Pas de TE chunked pour un corps Ã  longueur connue
         (setf headers (%rm headers \"transfer-encoding\"))
         (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes body))
                (len   (length bytes)))
           (setf headers (%ensure (%rm headers \"content-length\") \"Content-Length\" (write-to-string len)))
           (unless (%has headers \"content-type\")
             (setf headers (%ensure headers \"Content-Type\" \"text/plain; charset=utf-8\")))
	   ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
           (%emit-headers headers) (crlf flexi)
           (unless (string= method \"HEAD\")
             (write-string body flexi)
             (finish-output flexi))))

        ;; ===== BODY = octets =====
        ((typep body '(simple-array (unsigned-byte 8) (*)))
         ;; Pas de TE chunked pour un corps Ã  longueur connue
         (setf headers (%rm headers \"transfer-encoding\"))
         (let* ((len (length body)))
           (setf headers (%ensure (%rm headers \"content-length\") \"Content-Length\" (write-to-string len)))
	   ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
           (%emit-headers headers) (crlf flexi)
           (unless (string= method \"HEAD\")
             (write-sequence body flexi)
             (finish-output flexi))))

        ;; ===== BODY = vide =====
        (t
         ;; Corps vide : Content-Length: 0, pas de TE
         (setf headers (%rm headers \"transfer-encoding\"))
         (setf headers (%ensure (%rm headers \"content-length\") \"Content-Length\" \"0\"))
	 ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
         (%emit-headers headers) (crlf flexi)
         (finish-output flexi))))))

(defun read-request-line (stream)
  (let ((line (read-line stream nil nil)))
    (when line
      (let* ((parts (uiop:split-string line :separator \" \")))
	(values (nth 0 parts) (nth 1 parts) (nth 2 parts))))))

(defun ensure-binary-stream (raw)
  \"Retourne un stream BINAIRE (octets). Sur SBCL, reconstruit le FD-stream si 'raw' est caractÃ¨re.\"
  #+sbcl
  (if (subtypep (stream-element-type raw) 'character)
      (let* ((fd (sb-sys:fd-stream-fd raw))
             ;; IMPORTANT : ne pas fermer 2x le fd â :auto-close NIL
             (bin (sb-sys:make-fd-stream fd :input t :output t
                                         :element-type '(unsigned-byte 8)
                                         :buffering :full
                                         :auto-close nil)))
        bin)
      raw)
  #-sbcl
  raw)

(defun make-http-stream (client &key ssl)
  \"Retourne un flux FLEXI (caractÃ¨re) au-dessus du flux usocket ou SSL.\"
  (let* ((raw (usocket:socket-stream client))
         (base (if ssl
                   ;; On pose TLS (binaire) puis on garde Flexi au-dessus (CRLF/UTF-8)
                   (cl+ssl:with-global-context (*ssl-context*)
                     (cl+ssl:make-ssl-server-stream
                       raw
                       ;; on laisse Flexi gÃ©rer l'encoding/CRLF,
                       ;; donc pas d' :external-format ici
                       :cipher-list cl+ssl:*default-cipher-list*))
                   raw))
         (xfmt (flexi-streams:make-external-format :utf-8 :eol-style :crlf)))
    (flexi-streams:make-flexi-stream base :external-format xfmt)))

(defun header (headers name)
  \"Retourne la premiÃ¨re valeur du header NAME (ou NIL).\"
  (cdr (assoc (string-downcase name) headers :test #'string=)))

(defun header* (headers name)
  \"Retourne la liste de toutes les valeurs du header NAME.\"
  (loop for (k . v) in headers
        when (string= k (string-downcase name))
        collect v))

(defun read-headers (stream)
  \"Lit les en-tÃªtes HTTP depuis STREAM et retourne une alist (\\\"nom\\\" . \\\"valeur\\\").
   - Noms en minuscules, insensibles Ã  la casse HTTP.
   - Doublons conservÃ©s (push d'une nouvelle paire pour chaque occurrence).
   - Lignes de continuation (obs-fold) concatÃ©nÃ©es Ã  la derniÃ¨re valeur.\"
  (labels ((blank-line-p (s) (and s (= (length s) 0)))
           (trim (s) (string-trim '(#\\Space #\\Tab #\\Return #\\Newline) s)))
    (loop
      with headers = '()
      with last-cell = nil
      for line = (read-line stream nil nil)
      do
        (cond
          ;; EOF sans ligne vide: on retourne ce qu'on a
          ((null line)
           (return (nreverse headers)))

          ;; Ligne vide: fin des en-tÃªtes
          ((blank-line-p line)
           (return (nreverse headers)))

          ;; Ligne de continuation (obs-fold): commence par espace ou tab
          ((and (> (length line) 0)
                (member (char line 0) '(#\\Space #\\Tab)))
           (when last-cell
             (setf (cdr last-cell)
                   (concatenate 'string (cdr last-cell) \" \" (trim line)))))

          ;; Nouvelle ligne d'en-tÃªte
          (t
           (let* ((pos (position #\\: line))
                  (raw-name (if pos (subseq line 0 pos) line))
                  (raw-val  (if pos (subseq line (1+ pos)) \"\")))
             (let* ((name (string-downcase (trim raw-name)))
                    (val  (trim raw-val))
                    (cell (cons name val)))
               (push cell headers)
               (setf last-cell (car headers)))))))))

(defun handle-connection (socket client &key ssl)
  (declare (ignore socket))
  (let* ((flexi (make-http-stream client :ssl ssl)) ; Flexi au-dessus dâun FD binaire
	 (req-count 0)
         (alive t))
    (lumen.core.shutdown:register-connection client)
    (unwind-protect
	 (loop while alive do
           ;; attente dâactivitÃ© avec timeout (Ã©vite de bloquer des threads inactifs)
           (unless (usocket:wait-for-input client :timeout *keep-alive-timeout*)
             (setf alive nil) (return))
           (progn
             (multiple-value-bind (method uri http-ver) (read-request-line flexi)
	       (unless method (setf alive nil) (return))
	       (format t \"~&*** URI: ~A~%\" uri)
	       (let* ((qpos (and uri (position #\\? uri)))
		      (path-only (if qpos (subseq uri 0 qpos) (or uri \"/\")))
		      (query-str (and qpos (subseq uri (1+ qpos))))
		      (headers (read-headers flexi))
		      (req (make-instance 'lumen.core.http:request
					  :method (string-upcase method)
					  :path   path-only
					  :headers headers
					  :query  query-str ;; â string brute, sera parsÃ©e par middleware
					  :cookies nil :params nil
					  :body-stream flexi :context (list)))
		      (peer
			(ignore-errors
			 (let* ((sym1 (find-symbol \"GET-PEER-ADDRESS\" :usocket))
				(sym2 (find-symbol \"SOCKET-PEER-ADDRESS\" :usocket)))
			   (cond
			     ((and sym1 (fboundp sym1))
			      (funcall (symbol-function sym1) client))
			     ((and sym2 (fboundp sym2))
			      (funcall (symbol-function sym2) client))
			     (t nil)))))
		      (peer (if peer
				(format nil \"~A.~A.~A.~A\"
					(aref peer 0) (aref peer 1)
					(aref peer 2) (aref peer 3))
				\"-\"))
		      (_ (lumen.core.http:ctx-set! req :remote-addr peer))
		      ;; Marque secure si on est sur le socket TLS
		      (_ (lumen.core.http:ctx-set! req :secure (and ssl t)))
		      (resp (funcall *handler* req))
		      ;; Keep-Alive dÃ©sirÃ© par le client + autorisÃ© par le serveur ?
                      (want-ka (and *keep-alive* (want-keep-alive-p http-ver headers)))
                      ;; Keep-Alive permis uniquement si le corps a Ã©tÃ© entiÃ¨rement lu
                      (len-h (header headers \"content-length\"))
                      (len* (and len-h (parse-integer len-h :junk-allowed t)))
                      (consumed (or (null len*) (= len* 0)
                                    (lumen.core.http:ctx-get req :body-consumed)))
                      (ka-ok (and want-ka consumed
				  (not (lumen.core.shutdown:draining-p))
				  (< (incf req-count) *keep-alive-max*)))
		      )
		 (write-response flexi resp method ka-ok)
		 (unless ka-ok (setf alive nil))
		 ;;(format t \"~&[router] path=~S~%\" (lumen.core.http:req-path req))
		 ;;(format t \"~&[lumen] response sent (status=~A)~%\" (lumen.core.http:resp-status resp))
		 ))))
      (lumen.core.shutdown:unregister-connection client)
      ;; --- FERMETURE PROPRE (Windows-friendly) ---
      ;; 1) s'assurer quâaucun caractÃ¨re nâest en attente cÃ´tÃ© Flexi
      (ignore-errors (finish-output flexi))
      ;; 2) envoi de FIN cÃ´tÃ© Ã©criture
      (ignore-errors (usocket:socket-shutdown client :output))
      ;; 3) petite respiration (laisse le FIN partir)
      (sleep 0.02)
      ;; 4) fermer la socket (FD) â une seule fois
      (ignore-errors (usocket:socket-close client))
      ;; 5) fermer le Flexi (qui nâa plus de FD sous-jacent)
      (ignore-errors (close flexi)))))

(defun accept-loop (socket &key ssl)
  (loop
    (let ((client (usocket:socket-accept socket :element-type '(unsigned-byte 8))))
      (bt:make-thread (lambda () (handle-connection socket client :ssl ssl))
                      :name (if ssl \"lumen-client-tls\" \"lumen-client\")))))

(defun start (&key (port 8080) handler
                (ssl nil) (ssl-port 8443)
                cert-file key-file key-password)
  (when *server-socket* (stop))		; nettoie si dÃ©jÃ  lancÃ©

  (setf *port* port
        *handler* (or handler
                      (lambda (req)
                        (declare (ignore req))
                        (make-instance 'lumen.core.http:response :status 500 :headers nil :body \"\"))))

  ;; HTTP
  (setf *server-socket*
        (usocket:socket-listen \"0.0.0.0\" port :reuse-address t :element-type '(unsigned-byte 8)))
  (setf *accept-thread*
        (bt:make-thread (lambda () (accept-loop *server-socket* :ssl nil))
                        :name (format nil \"lumen-accept-~A\" port)))
  (format t \"~&Lumen HTTP listening on ~A~%\" port)

  ;; HTTPS (optionnel)
  (setf *ssl-enabled* ssl)
  (when ssl
    (setf *ssl-port*          ssl-port
          *ssl-cert-file*     cert-file
          *ssl-key-file*      key-file
	  *ssl-key-password*  key-password)
    (init-ssl-context)
    (setf *server-socket-tls*
          (usocket:socket-listen \"0.0.0.0\" ssl-port :reuse-address t :element-type '(unsigned-byte 8)))
    (setf *accept-thread-tls*
          (bt:make-thread (lambda () (accept-loop *server-socket-tls* :ssl t))
                          :name (format nil \"lumen-accept-tls-~A\" ssl-port)))
    (format t \"~&Lumen HTTPS listening on ~A~%\" ssl-port))
  t)

(defun stop ()
  (labels ((stop-one (sock thr)
             (when sock (ignore-errors (usocket:socket-close sock)))
             (when thr  (ignore-errors (bt:destroy-thread thr)))))
    (stop-one *server-socket* *accept-thread*)
    (stop-one *server-socket-tls* *accept-thread-tls*)
    (setf *server-socket* nil
          *accept-thread* nil
          *server-socket-tls* nil
          *accept-thread-tls* nil
          *ssl-context* nil))
  t)
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 48 (face font-lock-type-face fontified t) 48 52 (fontified t) 52 56 (face font-lock-builtin-face fontified t) 56 57 (fontified t) 57 60 (face font-lock-builtin-face fontified t) 60 61 (fontified t) 61 72 (face font-lock-builtin-face fontified t) 72 77 (fontified t) 77 89 (face font-lock-builtin-face fontified t) 89 90 (fontified t) 90 102 (face font-lock-builtin-face fontified t) 102 103 (fontified t) 103 117 (face font-lock-builtin-face fontified t) 117 122 (fontified t) 122 134 (face font-lock-builtin-face fontified t) 134 135 (fontified t) 135 151 (face font-lock-builtin-face fontified t) 151 152 (fontified t) 152 160 (face font-lock-builtin-face fontified t) 160 161 (fontified t) 161 170 (face font-lock-builtin-face fontified t) 170 171 (fontified t) 171 183 (face font-lock-builtin-face fontified t) 183 184 (fontified t) 184 197 (face font-lock-builtin-face fontified t) 197 198 (fontified t) 198 208 (face font-lock-builtin-face fontified t) 208 209 (fontified t) 209 221 (face font-lock-builtin-face fontified t) 221 226 (fontified t) 226 238 (face font-lock-builtin-face fontified t) 238 239 (fontified t) 239 256 (face font-lock-builtin-face fontified t) 256 257 (fontified t) 257 273 (face font-lock-builtin-face fontified t) 273 278 (fontified t) 278 290 (face font-lock-builtin-face fontified t) 290 291 (fontified t) 291 311 (face font-lock-builtin-face fontified t) 311 312 (fontified t) 312 332 (face font-lock-builtin-face fontified t) 332 333 (fontified t) 333 355 (face font-lock-builtin-face fontified t) 355 358 (fontified t) 358 369 (face font-lock-builtin-face fontified t) 369 374 (fontified t) 374 381 (face font-lock-builtin-face fontified t) 381 382 (fontified t) 382 388 (face font-lock-builtin-face fontified t) 388 389 (fontified t) 389 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 409 (face font-lock-keyword-face fontified t) 409 410 (fontified t) 410 428 (face font-lock-builtin-face fontified t) 428 432 (fontified t) 432 444 (face font-lock-keyword-face fontified t) 444 445 (fontified t) 445 460 (face font-lock-variable-name-face fontified t) 460 467 (fontified t) 467 479 (face font-lock-keyword-face fontified t) 479 480 (fontified t) 480 495 (face font-lock-variable-name-face fontified t) 495 502 (fontified t) 502 514 (face font-lock-keyword-face fontified t) 514 515 (fontified t) 515 521 (face font-lock-variable-name-face fontified t) 521 529 (fontified t) 529 541 (face font-lock-keyword-face fontified t) 541 542 (fontified t) 542 555 (face font-lock-variable-name-face fontified t) 555 559 (fontified t) 559 600 (face font-lock-comment-face fontified t) 600 601 (fontified t) 601 613 (face font-lock-keyword-face fontified t) 613 614 (fontified t) 614 631 (face font-lock-variable-name-face fontified t) 631 637 (fontified t) 637 692 (face font-lock-comment-face fontified t) 692 694 (fontified t) 694 706 (face font-lock-keyword-face fontified t) 706 707 (fontified t) 707 716 (face font-lock-variable-name-face fontified t) 716 720 (fontified t) 720 726 (face font-lock-keyword-face fontified t) 726 738 (fontified t) 738 745 (face font-lock-keyword-face fontified t) 745 789 (fontified t) 789 796 (face font-lock-builtin-face fontified t) 796 801 (fontified t) 801 809 (face font-lock-builtin-face fontified t) 809 814 (fontified t) 814 819 (face font-lock-builtin-face fontified t) 819 820 (fontified t) 820 822 (face font-lock-string-face fontified t) 822 828 (fontified t) 828 840 (face font-lock-keyword-face fontified t) 840 841 (fontified t) 841 853 (face font-lock-variable-name-face fontified t) 853 858 (fontified t) 858 870 (face font-lock-keyword-face fontified t) 870 871 (fontified t) 871 891 (face font-lock-variable-name-face fontified t) 891 898 (fontified t) 898 926 (face font-lock-comment-face fontified t) 926 927 (fontified t) 927 939 (face font-lock-keyword-face fontified t) 939 940 (fontified t) 940 956 (face font-lock-variable-name-face fontified t) 956 967 (fontified t) 967 996 (face font-lock-comment-face fontified t) 996 997 (fontified t) 997 1000 (face font-lock-comment-delimiter-face fontified t) 1000 1007 (face font-lock-comment-face fontified t) 1007 1008 (fontified t) 1008 1020 (face font-lock-keyword-face fontified t) 1020 1021 (fontified t) 1021 1036 (face font-lock-variable-name-face fontified t) 1036 1048 (fontified t) 1048 1055 (face font-lock-comment-face fontified t) 1055 1056 (fontified t) 1056 1068 (face font-lock-keyword-face fontified t) 1068 1069 (fontified t) 1069 1084 (face font-lock-variable-name-face fontified t) 1084 1092 (fontified t) 1092 1104 (face font-lock-keyword-face fontified t) 1104 1105 (fontified t) 1105 1124 (face font-lock-variable-name-face fontified t) 1124 1132 (fontified t) 1132 1140 (face font-lock-comment-face fontified t) 1140 1141 (fontified t) 1141 1153 (face font-lock-keyword-face fontified t) 1153 1154 (fontified t) 1154 1173 (face font-lock-variable-name-face fontified t) 1173 1181 (fontified t) 1181 1193 (face font-lock-keyword-face fontified t) 1193 1194 (fontified t) 1194 1207 (face font-lock-variable-name-face fontified t) 1207 1214 (fontified t) 1214 1226 (face font-lock-keyword-face fontified t) 1226 1227 (fontified t) 1227 1237 (face font-lock-variable-name-face fontified t) 1237 1245 (fontified t) 1245 1257 (face font-lock-keyword-face fontified t) 1257 1258 (fontified t) 1258 1271 (face font-lock-variable-name-face fontified t) 1271 1278 (fontified t) 1278 1290 (face font-lock-keyword-face fontified t) 1290 1291 (fontified t) 1291 1306 (face font-lock-variable-name-face fontified t) 1306 1313 (fontified t) 1313 1325 (face font-lock-keyword-face fontified t) 1325 1326 (fontified t) 1326 1340 (face font-lock-variable-name-face fontified t) 1340 1347 (fontified t) 1347 1359 (face font-lock-keyword-face fontified t) 1359 1360 (fontified t) 1360 1378 (face font-lock-variable-name-face fontified t) 1378 1385 (fontified t) 1385 1410 (face font-lock-comment-face fontified t) 1410 1412 (fontified t) 1412 1417 (face font-lock-keyword-face fontified t) 1417 1418 (fontified t) 1418 1426 (face font-lock-function-name-face fontified t) 1426 1450 (fontified t) 1450 1460 (face font-lock-string-face fontified t) 1460 1470 (fontified t) 1470 1475 (face font-lock-keyword-face fontified t) 1475 1476 (fontified t) 1476 1493 (face font-lock-function-name-face fontified t) 1493 1500 (fontified t) 1500 1513 (fontified t) 1513 27190 (fontified nil)) . 1) (t 26946 41579 0 0)) nil (26974 13642 183034 0) 0 nil])
([nil nil ((25755 . 25759) (t 26993 53276 0 0)) nil (26994 16091 637063 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25836 . 25837) (nil fontified nil 25759 . 25837) (25759 . 25837)) nil (26994 16091 637062 0) 0 nil])
([nil nil ((25765 . 25767)) nil (26994 16091 637061 0) 0 nil])
([nil nil ((#("q" 0 1 (fontified t)) . -25766) (undo-tree-id5 . -1) 25767) nil (26994 16091 637060 0) 0 nil])
([nil nil ((25766 . 25768)) nil (26994 16091 637059 0) 0 nil])
([nil nil ((25768 . 25769)) nil (26994 16091 637059 0) 0 nil])
([nil nil ((#("dev-mode-p" 0 10 (fontified t)) . -25788) (undo-tree-id4 . -10) 25798) nil (26994 16091 637058 0) 0 nil])
([nil nil ((25788 . 25798)) nil (26994 16091 637057 0) 0 nil])
([nil nil ((25798 . 25799)) nil (26994 16091 637056 0) 0 nil])
([nil nil ((25799 . 25804)) nil (26994 16091 637056 0) 0 nil])
([nil nil ((25805 . 25806)) nil (26994 16091 637055 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -25804) (undo-tree-id2 . -1) (#("*" 0 1 (fontified t)) . -25805) (undo-tree-id3 . -1) 25806) nil (26994 16091 637054 0) 0 nil])
([nil nil ((25805 . 25810) (#("  " 0 2 (fontified t)) . 25805) 25759) nil (26994 16091 637052 0) 0 nil])
([nil nil ((373 . 375) (#("		" 0 1 (fontified nil) 1 2 (fontified nil)) . -360) (360 . 361) (#("	" 0 1 (fontified nil)) . 360) (357 . 360) (371 . 372)) nil (26994 16091 637051 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 423 . 424) (nil fontified nil 423 . 424) (nil fontified nil 407 . 423) (nil fontified nil 406 . 407) (nil fontified nil 389 . 406) (nil fontified nil 388 . 389) (nil fontified nil 376 . 388) (nil fontified nil 375 . 376) (375 . 424)) nil (26994 16091 637050 0) 0 nil])
([nil nil ((#(":lumen.core.error" 0 17 (face font-lock-builtin-face fontified t)) . -389) (undo-tree-id1 . -17) 406) nil (26994 16091 637048 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 406 . 407) (nil fontified nil 389 . 407) (389 . 407)) nil (26994 16091 637045 0) 0 nil])
([nil nil ((#(":*error-handler*" 0 16 (face font-lock-builtin-face fontified t)) . -408) (undo-tree-id0 . -16) 424) nil (26994 16091 637044 0) 0 nil])
([nil nil ((nil fontified nil 417 . 418) (nil fontified nil 409 . 417) (nil fontified nil 408 . 409) (408 . 418)) nil (26994 16091 637025 0) 0 nil])
([nil nil ((445 . 447) (t 26994 16091 0 0)) nil (26994 16884 223027 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 484 . 485) (nil fontified nil 462 . 485) (nil fontified nil 447 . 462) (447 . 485)) nil (26994 16884 223026 0) 0 nil])
([nil nil ((275 . 278)) nil (26994 16884 223025 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 326 . 327) (nil fontified nil 326 . 327) (nil fontified nil 310 . 326) (nil fontified nil 309 . 310) (nil fontified nil 292 . 309) (nil fontified nil 291 . 292) (nil fontified nil 279 . 291) (nil fontified nil 278 . 279) (278 . 327)) nil (26994 16884 223025 0) 0 nil])
([nil nil ((#(":lumen.core.error" 0 17 (face font-lock-builtin-face fontified t)) . -292) (undo-tree-id2 . -17) (undo-tree-id3 . -11) (undo-tree-id4 . -11) (undo-tree-id5 . -11) (undo-tree-id6 . -11) (undo-tree-id7 . -11) (undo-tree-id8 . -11) (undo-tree-id9 . -17) (undo-tree-id10 . -17) (undo-tree-id11 . -17) (undo-tree-id12 . -17) (undo-tree-id13 . -17) (undo-tree-id14 . -17) (undo-tree-id15 . -17) (undo-tree-id16 . -17) 309) nil (26994 16884 223023 0) 0 nil])
([nil nil ((292 . 293)) nil (26994 16884 223013 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 328 . 329) (nil fontified nil 307 . 329) (nil fontified nil 293 . 307) (293 . 329)) nil (26994 16884 223012 0) 0 nil])
([nil nil ((#(" :*error" 0 1 (fontified t) 1 8 (face font-lock-builtin-face fontified t)) . 329) (undo-tree-id1 . -8)) nil (26994 16884 223011 0) 0 nil])
([nil nil ((#("-handler" 0 8 (face font-lock-builtin-face fontified t)) . 329) (undo-tree-id0 . -8)) nil (26994 16884 223009 0) 0 nil])
([nil nil ((#("*" 0 1 (face font-lock-builtin-face fontified t)) . 329)) nil (26994 16884 222994 0) 0 nil])
([nil nil ((312 . 313)) nil (26994 16884 222990 0) 0 nil])
([nil nil ((#("(when (eq (lumen.core.config:*profile*) :dev)
	    (lumen.dev.inspector:mount-inspector!))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 40 (fontified t) 40 44 (face font-lock-builtin-face fontified t) 44 66 (fontified t) 66 90 (fontified t)) . 25903) (undo-tree-id17 . -90) 25993 (t 26994 16884 0 0)) nil (26994 17152 100250 0) 0 nil])
([nil nil ((#("(:import-from :lumen.dev.inspector :mount-inspector!)" 0 1 (fontified t) 1 13 (face font-lock-builtin-face fontified t) 13 14 (fontified t) 14 15 (face font-lock-builtin-face fontified t) 15 29 (face font-lock-builtin-face fontified t) 29 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 51 (face font-lock-builtin-face fontified t) 51 52 (face font-lock-builtin-face rear-nonsticky t fontified t) 52 53 (rear-nonsticky t fontified t)) . 278) (undo-tree-id18 . -14) (undo-tree-id19 . -15) (undo-tree-id20 . -1) (t 26994 17152 0 0)) nil (26994 17294 225954 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 275)) nil (26994 17294 225940 0) 0 nil])
([nil nil ((#("

(lumen.dev.inspector:mount-inspector!)" 0 1 (fontified t) 1 2 (fontified t) 2 17 (fontified t) 17 39 (fontified t) 39 40 (fontified t rear-nonsticky t)) . 447) (undo-tree-id21 . -40) (undo-tree-id22 . -2) (undo-tree-id23 . -8) (undo-tree-id24 . -8) (undo-tree-id25 . -3) (undo-tree-id26 . -2) (undo-tree-id27 . -2) (undo-tree-id28 . -40) (undo-tree-id29 . -40) (undo-tree-id30 . -40) (undo-tree-id31 . -40) (t 26994 17294 0 0)) nil (26994 17365 30322 0) 0 nil])
([nil nil ((#("((stringp body)
         ;; Pas de TE chunked pour un corps Ã  longueur connue
         (setf headers (%rm headers \"transfer-encoding\"))
         (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes body))
                (len   (length bytes)))
           (setf headers (%ensure (%rm headers \"content-length\") \"Content-Length\" (write-to-string len)))
           (unless (%has headers \"content-type\")
             (setf headers (%ensure headers \"Content-Type\" \"text/plain; charset=utf-8\")))
	   ;;(format t \"~&[send] ~A ~A headers=~S~%\" method status headers)
           (%emit-headers headers) (crlf flexi)
           (unless (string= method \"HEAD\")
             (write-string body flexi)
             (finish-output flexi))))" 0 9 (fontified t) 9 25 (fontified t) 25 28 (face font-lock-comment-delimiter-face fontified t) 28 78 (face font-lock-comment-face fontified t) 78 114 (fontified t) 114 133 (face font-lock-string-face fontified t) 133 146 (fontified t) 146 150 (face font-lock-keyword-face fontified t) 150 290 (fontified t) 290 306 (face font-lock-string-face fontified t) 306 308 (fontified t) 308 324 (face font-lock-string-face fontified t) 324 361 (fontified t) 361 367 (face font-lock-keyword-face fontified t) 367 382 (fontified t) 382 396 (face font-lock-string-face fontified t) 396 442 (fontified t) 442 456 (face font-lock-string-face fontified t) 456 457 (fontified t) 457 484 (face font-lock-string-face fontified t) 484 492 (fontified t) 492 494 (face font-lock-comment-delimiter-face fontified t) 494 557 (face font-lock-comment-face fontified t) 557 617 (fontified t) 617 623 (face font-lock-keyword-face fontified t) 623 640 (fontified t) 640 646 (face font-lock-string-face fontified t) 646 724 (fontified t)) . -9688) (undo-tree-id18 . -724) (undo-tree-id19 . -687) (undo-tree-id20 . -724) (undo-tree-id21 . -724) 10412 (t 26994 17365 0 0)) nil (26996 42120 377170 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10554 . 10555) (nil fontified nil 9688 . 10555) (9688 . 10555)) nil (26996 42120 377167 0) 0 nil])
([nil nil ((#("(defun %write-chunk (flexi data)
  (etypecase data
    (string
     (let* ((bytes (trivial-utf-8:string-to-utf-8-bytes data))
            (n (length bytes)))
       (format flexi \"~X\" n) (%wr-crlf flexi) ; fin de la ligne âtailleâ
       (write-string data flexi)
       (%wr-crlf flexi)                       ; fin du chunk
       (finish-output flexi)))
    ((simple-array (unsigned-byte 8) (*))
     (let ((n (length data)))
       (format flexi \"~X\" n) (%wr-crlf flexi)
       (write-sequence data flexi)            ; CL:WRITE-SEQUENCE OK sur octets
       (%wr-crlf flexi)
       (finish-output flexi)))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 19 (face font-lock-function-name-face fontified t) 19 36 (fontified t) 36 45 (face font-lock-keyword-face fontified t) 45 69 (fontified t) 69 73 (face font-lock-keyword-face fontified t) 73 179 (fontified t) 179 183 (face font-lock-string-face fontified t) 183 204 (fontified t) 204 231 (face font-lock-comment-face fontified t) 231 310 (fontified t) 310 325 (face font-lock-comment-face fontified t) 325 404 (fontified t) 404 407 (face font-lock-keyword-face fontified t) 407 449 (fontified t) 449 453 (face font-lock-string-face fontified t) 453 520 (fontified t) 520 548 (face font-lock-comment-face fontified t) 548 554 (face font-lock-comment-face fontified t) 554 610 (fontified t)) . -4008) (undo-tree-id0 . -610) (undo-tree-id1 . -17) (undo-tree-id2 . -17) (undo-tree-id3 . -17) (undo-tree-id4 . -17) (undo-tree-id5 . -18) (undo-tree-id6 . -18) (undo-tree-id7 . -18) (undo-tree-id8 . -18) (undo-tree-id9 . -18) (undo-tree-id10 . -18) (undo-tree-id11 . -18) (undo-tree-id12 . -18) (undo-tree-id13 . -610) (undo-tree-id14 . -610) (undo-tree-id15 . -578) (undo-tree-id16 . -610) (undo-tree-id17 . -610) 4618) nil (26996 42120 377165 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4601 . 4602) (nil fontified nil 4008 . 4602) (4008 . 4602)) nil (26996 42120 377139 0) 0 nil])
([nil nil ((4602 . 4604) (t 26996 42120 0 0)) nil (26996 42137 688491 0) 0 nil])
([nil current ((#("x" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -4602) (undo-tree-id22 . -1) (#("b" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -4603) (undo-tree-id23 . -1) 4604) nil (26996 42137 688488 0) 0 nil])
nil
