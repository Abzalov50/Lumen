(undo-tree-save-format-version . 1)
"5d73db5f07ffbb4d0eabdfc82919c6fd990fc011"
[nil nil nil nil (26790 8105 766715 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 230 . 231) (nil fontified nil 1 . 231) (1 . 231) (t . -1)) nil (26790 8105 766715 0) 0 nil])
([nil nil ((17 . 18)) nil (26790 8105 766714 0) 0 nil])
([nil nil ((46 . 48) (#(" " 0 1 (fontified nil)) . 45) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (46 . 47)) nil (26790 8105 766713 0) 0 nil])
([nil nil ((59 . 61) (#(" " 0 1 (fontified nil)) . 58) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (59 . 60)) nil (26790 8105 766711 0) 0 nil])
([nil nil ((98 . 99)) nil (26790 8105 766709 0) 0 nil])
([nil nil ((129 . 130)) nil (26790 8105 766708 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -128) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (#("
" 0 1 (fontified t)) . -129) (undo-tree-id4 . -1) 130) nil (26790 8105 766707 0) 0 nil])
([nil nil ((177 . 179) (154 . 156) 129) nil (26790 8105 766705 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -181) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 182) nil (26790 8105 766704 0) 0 nil])
([nil nil ((223 . 225) 183) nil (26790 8105 766692 0) 0 nil])
([nil nil ((241 . 242)) nil (26790 8105 766688 0) 0 nil])
([nil nil ((1 . 4893) (#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:export :connect :with-transaction))

(in-package :lumen.data.db)

(defun connect (&rest _)
  (declare (ignore _))
  t)

(defmacro with-transaction (&body body)
  `(progn ,@body))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 68 (face font-lock-builtin-face fontified t) 68 69 (fontified t) 69 77 (face font-lock-builtin-face fontified t) 77 78 (fontified t) 78 95 (face font-lock-builtin-face fontified t) 95 100 (fontified t) 100 110 (face font-lock-keyword-face fontified t) 110 111 (fontified t) 111 125 (face font-lock-builtin-face fontified t) 125 129 (fontified t) 129 134 (face font-lock-keyword-face fontified t) 134 135 (fontified t) 135 142 (face font-lock-function-name-face fontified t) 142 144 (fontified t) 144 149 (face font-lock-type-face fontified t) 149 156 (fontified t) 156 163 (face font-lock-keyword-face fontified t) 163 183 (fontified t) 183 191 (face font-lock-keyword-face fontified t) 191 192 (fontified t) 192 208 (face font-lock-function-name-face fontified t) 208 210 (fontified t) 210 215 (face font-lock-type-face fontified t) 215 226 (fontified t) 226 231 (face font-lock-keyword-face fontified t) 231 241 (fontified t)) . 1) (t 26790 8105 0 0)) nil (26802 3641 146559 0) 0 nil])
([nil nil ((#("(defun query-a (sql &rest params)
  \"Retourne une liste d'ALIST (clés keyword).\"
  (with-db
    (multiple-value-bind (rows _)
        (apply #'postmodern:query sql (append params (list *default-format*)))
      (declare (ignore _))
      (mapcar #'%plist->alist rows)))) ;; *default-format* = :plists → keys en keywords :contentReference[oaicite:4]{index=4}

(defun query-1a (sql &rest params)
  (first (apply #'query-a sql params)))

(defun exec (sql &rest params)
  \"Exécute (INSERT/UPDATE/DELETE). Retourne le nombre de lignes affectées (2e valeur).\"
  (with-db (apply #'postmodern:execute sql params))) ;; :contentReference[oaicite:5]{index=5}" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (face font-lock-function-name-face fontified t) 14 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 36 (fontified t) 36 80 (face font-lock-doc-face fontified t) 80 84 (fontified t) 84 91 (face font-lock-keyword-face fontified t) 91 97 (fontified t) 97 116 (face font-lock-keyword-face fontified t) 116 212 (fontified t) 212 219 (face font-lock-keyword-face fontified t) 219 271 (fontified t) 271 274 (face font-lock-comment-delimiter-face fontified t) 274 317 (face font-lock-comment-face fontified t) 317 358 (face font-lock-comment-face fontified t) 358 360 (fontified t) 360 365 (face font-lock-keyword-face fontified t) 365 366 (fontified t) 366 374 (face font-lock-function-name-face fontified t) 374 380 (fontified t) 380 385 (face font-lock-type-face fontified t) 385 436 (fontified t) 436 441 (face font-lock-keyword-face fontified t) 441 442 (fontified t) 442 446 (face font-lock-function-name-face fontified t) 446 452 (fontified t) 452 457 (face font-lock-type-face fontified t) 457 468 (fontified t) 468 553 (face font-lock-doc-face fontified t) 553 557 (fontified t) 557 564 (face font-lock-keyword-face fontified t) 564 607 (fontified t) 607 610 (face font-lock-comment-delimiter-face fontified t) 610 647 (face font-lock-comment-face fontified t)) . 4245) (undo-tree-id0 . -647) (undo-tree-id1 . -647) (undo-tree-id2 . -647) (undo-tree-id3 . -647) (undo-tree-id4 . -647) (undo-tree-id5 . -647) (t 26802 3641 0 0)) nil (26802 4011 22478 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5018 . 5019) (nil fontified nil 4245 . 5019) (4245 . 5019)) nil (26802 4011 22458 0) 0 nil])
([nil nil ((#("(defun query-a (sql &rest params)
  \"Liste d'alists (clés keywords) pour une requête dynamique.\"
  (with-db
    (let ((fn (postmodern:prepare sql *default-format*))) ; *default-format* = :plists
      (let ((rows (apply fn params)))
        (mapcar #'%plist->alist rows)))))                  ; plists -> alists

(defun query-1a (sql &rest params)
  (first (apply #'query-a sql params)))

(defun exec (sql &rest params)
  \"INSERT/UPDATE/DELETE → nombre de lignes affectées.\"
  (with-db
    (let ((fn (postmodern:prepare sql :none)))            ; :none = ignorer les valeurs
      ;; avec :none, le **compteur** est renvoyé en 2e MV (comme `query`) ;
      ;; `execute` (la macro) le renvoie en 1er MV, mais ici on passe par `prepare`.
      (nth-value 1 (apply fn params)))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (face font-lock-function-name-face fontified t) 14 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 36 (fontified t) 36 96 (face font-lock-doc-face fontified t) 96 100 (fontified t) 100 107 (face font-lock-keyword-face fontified t) 107 113 (fontified t) 113 116 (face font-lock-keyword-face fontified t) 116 166 (fontified t) 166 195 (face font-lock-comment-face fontified t) 195 202 (fontified t) 202 205 (face font-lock-keyword-face fontified t) 205 292 (fontified t) 292 311 (face font-lock-comment-face fontified t) 311 313 (fontified t) 313 318 (face font-lock-keyword-face fontified t) 318 319 (fontified t) 319 327 (face font-lock-function-name-face fontified t) 327 333 (fontified t) 333 338 (face font-lock-type-face fontified t) 338 389 (fontified t) 389 394 (face font-lock-keyword-face fontified t) 394 395 (fontified t) 395 399 (face font-lock-function-name-face fontified t) 399 405 (fontified t) 405 410 (face font-lock-type-face fontified t) 410 421 (fontified t) 421 473 (face font-lock-doc-face fontified t) 473 477 (fontified t) 477 484 (face font-lock-keyword-face fontified t) 484 490 (fontified t) 490 493 (face font-lock-keyword-face fontified t) 493 523 (fontified t) 523 528 (face font-lock-builtin-face fontified t) 528 543 (fontified t) 543 573 (face font-lock-comment-face fontified t) 573 579 (fontified t) 579 582 (face font-lock-comment-delimiter-face fontified t) 582 649 (face font-lock-comment-face fontified t) 649 655 (fontified t) 655 658 (face font-lock-comment-delimiter-face fontified t) 658 734 (face font-lock-comment-face fontified t) 734 773 (fontified t) 773 774 (rear-nonsticky t fontified t) 774 775 (fontified t)) . 4245) (undo-tree-id6 . -141) (undo-tree-id7 . -775) (undo-tree-id8 . -141) (undo-tree-id9 . -142) (undo-tree-id10 . -257) (undo-tree-id11 . -141) (undo-tree-id12 . -141) (undo-tree-id13 . -142) (undo-tree-id14 . -142) (undo-tree-id15 . -142) (undo-tree-id16 . -142) (undo-tree-id17 . -142) (undo-tree-id18 . -142) (undo-tree-id19 . -142) (undo-tree-id20 . -142) (undo-tree-id21 . -775) (undo-tree-id22 . -775) (undo-tree-id23 . -775) (undo-tree-id24 . -775) (undo-tree-id25 . -775) (t 26802 4011 0 0)) nil (26802 4524 940098 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4903 . 4904) (nil fontified nil 4245 . 4904) (4245 . 4904)) nil (26802 4524 940073 0) 0 nil])
([nil nil ((4904 . 4905)) nil (26802 4524 940069 0) 0 nil])
([nil nil ((#("(defpackage :lumen.data.db
  (:use :cl :alexandria)
  (:import-from :cl-ppcre :register-groups-bind)
  (:import-from :lumen.core.config :cfg-get :cfg-get-int :cfg-get-bool :cfg-get-list)
  (:import-from :lumen.utils :alist-get)
  (:nicknames :lumen.db)
  (:export
   :start! :stop!
   :with-db :tx
   :query-a :query-1a :exec
   :connect-spec
   :*default-format*))

(in-package :lumen.data.db)

;; ---------- État ----------
(defparameter *connect-spec* nil)     ;; ex: '(\"db\" \"user\" \"pass\" \"host\" :port 5432 :pooled-p t :use-ssl :require)
(defparameter *default-format* :plists) ;; :plists => colonnes en keywords; on convertit ensuite en alist
(defparameter *app-name* \"lumen\")

(defun connect-spec () *connect-spec*)

;; ---------- Utils ----------
(defun %percent-decode (s)
  \"Décodage %xx minimal (UTF-8 safe tant que s est ASCII).\"
  (with-output-to-string (o)
    (loop for i from 0 below (length s)
          for c = (char s i)
          do (cond
               ((and (char= c #\\%)
                     (<= (+ i 2) (1- (length s))))
                (let* ((h1 (char s (1+ i)))
                       (h2 (char s (+ i 2)))
                       (b (parse-integer (string h1 h2) :radix 16 :junk-allowed t)))
                  (when b (write-char (code-char b) o))
                  (incf i 2)))
               (t (write-char c o))))))

(defun %parse-pg-url (url)
  \"postgres://user:pass@host:port/db?sslmode=require&application_name=...\"
  (register-groups-bind (user pass host port db qs)
      (\"^postgres(?:ql)?://([^:@/]+)(?::([^@/]*))?@([^/:?#]+)(?::([0-9]+))?/([^?]+)(?:\\\\?(.*))?$\" url)
    (let* ((user (%percent-decode user))
           (pass (%percent-decode (or pass \"\")))
           (host host)
           (port (if port (parse-integer port) 5432))
           (db   (%percent-decode db))
           (pairs (when qs (mapcar (lambda (kv)
                                     (let* ((p (uiop:split-string kv :separator \"=\"))
                                            (k (string-downcase (first p)))
                                            (v (and (second p) (%percent-decode (second p)))))
                                       (cons k v)))
                                   (uiop:split-string qs :separator \"&\"))))
           (sslmode (cdr (assoc \"sslmode\" pairs :test #'string=)))
           (appname (or (cdr (assoc \"application_name\" pairs :test #'string=)) *app-name*))
           (ssl (ecase (intern (string-upcase (or sslmode \"disable\")) :keyword)
                  (:DISABLE :no) (:ALLOW :try) (:PREFER :try) (:REQUIRE :require)
                  (:VERIFY-CA :yes) (:VERIFY-FULL :full))))
      (list db user pass host :port port :pooled-p t :use-ssl ssl :application-name appname))))

(defun %plist->alist (pl)
  (loop for (k v) on pl by #'cddr collect (cons k v)))

(defun %ensure-spec (&key url host db user pass (port 5432) ssl app-name)
  (cond
    (url (%parse-pg-url url))
    ((and host db user)
     (let ((ssl (or ssl :no)))
       (list db user (or pass \"\") host :port port :pooled-p t :use-ssl ssl
             :application-name (or app-name *app-name*))))
    (t (error \"DB config incomplète. Fournis :url ou (host db user ...).\"))))

;; ---------- API ----------
(defun start! (&key url host db user pass (port nil) (pool-size nil) (ssl nil) (app-name \"lumen\"))
  \"Initialise le pool Postgres (Postmodern) avec une connexion de test.\"
  (setf postmodern:*max-pool-size* pool-size) ;; NIL = pas de limite. :contentReference[oaicite:1]{index=1}
  (setf *connect-spec* (%ensure-spec :url url :host host :db db :user user :pass pass
                                     :port (or port 5432) :ssl ssl :app-name app-name))
  ;; Smoke test: SELECT 1
  (postmodern:with-connection *connect-spec*
    (postmodern:query \"select 1\"))
  t)

(defun stop! ()
  \"Vide le pool.\"
  (postmodern:clear-connection-pool) ;; :contentReference[oaicite:2]{index=2}
  (setf *connect-spec* nil)
  t)

(defmacro with-db (&body body)
  \"Lie postmodern:*database* via le pool (sûr en threads).\"
  `(postmodern:with-connection *connect-spec*
     ,@body))

(defmacro tx (&body body)
  \"Transaction (commit/rollback auto).\"
  `(postmodern:with-transaction () ,@body)) ;; :contentReference[oaicite:3]{index=3}

(defun query-a (sql &rest params)
  \"SELECT → liste d'alists (clés keyword).\"
  (with-db
    ;; prepare est une macro → format LITTÉRAL ici
    (let ((fn (postmodern:prepare sql :plists)))
      (let ((rows (apply fn params)))
        (mapcar #'%plist->alist rows)))))

(defun query-1a (sql &rest params)
  (first (apply #'query-a sql params)))

(defun exec (sql &rest params)
  \"INSERT/UPDATE/DELETE → nombre de lignes affectées (comme `execute`).\"
  (with-db
    ;; `execute` est une macro → on construit la forme et on l'évalue.
    ;; Les `params` restent des *valeurs* séparées (placeholders $1,$2,...)
    (eval (list* 'postmodern:execute sql params))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 26 (face font-lock-type-face fontified t) 26 30 (fontified t) 30 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 38 (face font-lock-builtin-face fontified t) 38 39 (fontified t) 39 50 (face font-lock-builtin-face fontified t) 50 55 (fontified t) 55 67 (face font-lock-builtin-face fontified t) 67 68 (fontified t) 68 77 (face font-lock-builtin-face fontified t) 77 78 (fontified t) 78 99 (face font-lock-builtin-face fontified t) 99 104 (fontified t) 104 116 (face font-lock-builtin-face fontified t) 116 117 (fontified t) 117 135 (face font-lock-builtin-face fontified t) 135 136 (fontified t) 136 144 (face font-lock-builtin-face fontified t) 144 145 (fontified t) 145 157 (face font-lock-builtin-face fontified t) 157 158 (fontified t) 158 171 (face font-lock-builtin-face fontified t) 171 172 (fontified t) 172 185 (face font-lock-builtin-face fontified t) 185 190 (fontified t) 190 202 (face font-lock-builtin-face fontified t) 202 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 241 (face font-lock-builtin-face fontified t) 241 242 (fontified t) 242 251 (face font-lock-builtin-face fontified t) 251 256 (fontified t) 256 263 (face font-lock-builtin-face fontified t) 263 267 (fontified t) 267 274 (face font-lock-builtin-face fontified t) 274 275 (fontified t) 275 281 (face font-lock-builtin-face fontified t) 281 285 (fontified t) 285 293 (face font-lock-builtin-face fontified t) 293 294 (fontified t) 294 297 (face font-lock-builtin-face fontified t) 297 301 (fontified t) 301 309 (face font-lock-builtin-face fontified t) 309 310 (fontified t) 310 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 325 (face font-lock-builtin-face fontified t) 325 329 (fontified t) 329 342 (face font-lock-builtin-face fontified t) 342 346 (fontified t) 346 363 (face font-lock-builtin-face fontified t) 363 368 (fontified t) 368 378 (face font-lock-keyword-face fontified t) 378 379 (fontified t) 379 393 (face font-lock-builtin-face fontified t) 393 396 (fontified t) 396 399 (face font-lock-comment-delimiter-face fontified t) 399 426 (face font-lock-comment-face fontified t) 426 427 (fontified t) 427 439 (face font-lock-keyword-face fontified t) 439 440 (fontified t) 440 454 (face font-lock-variable-name-face fontified t) 454 464 (fontified t) 464 467 (face font-lock-comment-delimiter-face fontified t) 467 541 (face font-lock-comment-face fontified t) 541 542 (fontified t) 542 554 (face font-lock-keyword-face fontified t) 554 555 (fontified t) 555 571 (face font-lock-variable-name-face fontified t) 571 572 (fontified t) 572 579 (face font-lock-builtin-face fontified t) 579 581 (fontified t) 581 584 (face font-lock-comment-delimiter-face fontified t) 584 647 (face font-lock-comment-face fontified t) 647 648 (fontified t) 648 660 (face font-lock-keyword-face fontified t) 660 661 (fontified t) 661 671 (face font-lock-variable-name-face fontified t) 671 672 (fontified t) 672 679 (face font-lock-string-face fontified t) 679 683 (fontified t) 683 688 (face font-lock-keyword-face fontified t) 688 689 (fontified t) 689 701 (face font-lock-function-name-face fontified t) 701 722 (fontified t) 722 725 (face font-lock-comment-delimiter-face fontified t) 725 753 (face font-lock-comment-face fontified t) 753 754 (fontified t) 754 759 (face font-lock-keyword-face fontified t) 759 760 (fontified t) 760 775 (face font-lock-function-name-face fontified t) 775 782 (fontified t) 782 839 (face font-lock-doc-face fontified t) 839 843 (fontified t) 843 864 (face font-lock-keyword-face fontified t) 864 874 (fontified t) 874 878 (face font-lock-keyword-face fontified t) 878 952 (fontified t) 952 956 (face font-lock-keyword-face fontified t) 956 1060 (fontified t) 1060 1064 (face font-lock-keyword-face fontified t) 1064 1188 (fontified t) 1188 1194 (face font-lock-builtin-face fontified t) 1194 1198 (fontified t) 1198 1211 (face font-lock-builtin-face fontified t) 1211 1236 (fontified t) 1236 1240 (face font-lock-keyword-face fontified t) 1240 1345 (fontified t) 1345 1346 (fontified t) 1346 1351 (face font-lock-keyword-face fontified t) 1351 1352 (fontified t) 1352 1365 (face font-lock-function-name-face fontified t) 1365 1374 (fontified t) 1374 1446 (face font-lock-doc-face fontified t) 1446 1482 (fontified t) 1482 1499 (fontified t) 1499 1506 (fontified t) 1506 1528 (face font-lock-string-face fontified t) 1528 1529 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1529 1541 (face font-lock-string-face fontified t) 1541 1542 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1542 1552 (face font-lock-string-face fontified t) 1552 1553 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1553 1577 (face font-lock-string-face fontified t) 1577 1578 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1578 1596 (face font-lock-string-face fontified t) 1596 1607 (fontified t) 1607 1611 (face font-lock-keyword-face fontified t) 1611 1686 (fontified t) 1686 1688 (face font-lock-string-face fontified t) 1688 1733 (fontified t) 1733 1735 (face font-lock-keyword-face fontified t) 1735 1827 (fontified t) 1827 1831 (face font-lock-keyword-face fontified t) 1831 1844 (fontified t) 1844 1850 (face font-lock-keyword-face fontified t) 1850 1894 (fontified t) 1894 1898 (face font-lock-keyword-face fontified t) 1898 1925 (fontified t) 1925 1935 (face font-lock-builtin-face fontified t) 1935 1936 (fontified t) 1936 1939 (face font-lock-string-face fontified t) 1939 2222 (fontified t) 2222 2232 (face font-lock-builtin-face fontified t) 2232 2233 (fontified t) 2233 2236 (face font-lock-string-face fontified t) 2236 2273 (fontified t) 2273 2282 (face font-lock-string-face fontified t) 2282 2289 (fontified t) 2289 2294 (face font-lock-builtin-face fontified t) 2294 2344 (fontified t) 2344 2362 (face font-lock-string-face fontified t) 2362 2369 (fontified t) 2369 2374 (face font-lock-builtin-face fontified t) 2374 2417 (fontified t) 2417 2422 (face font-lock-keyword-face fontified t) 2422 2458 (fontified t) 2458 2467 (face font-lock-string-face fontified t) 2467 2470 (fontified t) 2470 2478 (face font-lock-builtin-face fontified t) 2478 2499 (fontified t) 2499 2507 (face font-lock-builtin-face fontified t) 2507 2508 (fontified t) 2508 2511 (face font-lock-builtin-face fontified t) 2511 2514 (fontified t) 2514 2520 (face font-lock-builtin-face fontified t) 2520 2521 (fontified t) 2521 2525 (face font-lock-builtin-face fontified t) 2525 2528 (fontified t) 2528 2535 (face font-lock-builtin-face fontified t) 2535 2536 (fontified t) 2536 2540 (face font-lock-builtin-face fontified t) 2540 2543 (fontified t) 2543 2551 (face font-lock-builtin-face fontified t) 2551 2552 (fontified t) 2552 2560 (face font-lock-builtin-face fontified t) 2560 2581 (fontified t) 2581 2591 (face font-lock-builtin-face fontified t) 2591 2592 (fontified t) 2592 2596 (face font-lock-builtin-face fontified t) 2596 2599 (fontified t) 2599 2611 (face font-lock-builtin-face fontified t) 2611 2612 (fontified t) 2612 2617 (face font-lock-builtin-face fontified t) 2617 2652 (fontified t) 2652 2657 (face font-lock-builtin-face fontified t) 2657 2663 (fontified t) 2663 2672 (face font-lock-builtin-face fontified t) 2672 2675 (fontified t) 2675 2683 (face font-lock-builtin-face fontified t) 2683 2688 (fontified t) 2688 2705 (face font-lock-builtin-face fontified t) 2705 2720 (fontified t) 2720 2725 (face font-lock-keyword-face fontified t) 2725 2726 (fontified t) 2726 2739 (face font-lock-function-name-face fontified t) 2739 2748 (fontified t) 2748 2752 (face font-lock-keyword-face fontified t) 2752 2801 (fontified t) 2801 2802 (fontified t) 2802 2807 (face font-lock-keyword-face fontified t) 2807 2808 (fontified t) 2808 2820 (face font-lock-function-name-face fontified t) 2820 2822 (fontified t) 2822 2826 (face font-lock-type-face fontified t) 2826 2878 (fontified t) 2878 2882 (face font-lock-keyword-face fontified t) 2882 2943 (fontified t) 2943 2946 (face font-lock-keyword-face fontified t) 2946 2961 (fontified t) 2961 2964 (face font-lock-builtin-face fontified t) 2964 2998 (fontified t) 2998 2999 (face font-lock-string-face fontified t) 2999 3000 (face font-lock-string-face fontified t) 3000 3007 (fontified t) 3007 3012 (face font-lock-builtin-face fontified t) 3012 3018 (fontified t) 3018 3027 (face font-lock-builtin-face fontified t) 3027 3030 (fontified t) 3030 3038 (face font-lock-builtin-face fontified t) 3038 3043 (fontified t) 3043 3056 (fontified t) 3056 3073 (face font-lock-builtin-face fontified t) 3073 3110 (fontified t) 3110 3115 (face font-lock-warning-face fontified t) 3115 3116 (fontified t) 3116 3175 (face font-lock-string-face fontified t) 3175 3181 (fontified t) 3181 3184 (face font-lock-comment-delimiter-face fontified t) 3184 3210 (face font-lock-comment-face fontified t) 3210 3211 (fontified t) 3211 3216 (face font-lock-keyword-face fontified t) 3216 3217 (fontified t) 3217 3223 (face font-lock-function-name-face fontified t) 3223 3225 (fontified t) 3225 3229 (face font-lock-type-face fontified t) 3229 3299 (fontified t) 3299 3306 (face font-lock-string-face fontified t) 3306 3311 (fontified t) 3311 3381 (face font-lock-doc-face fontified t) 3381 3428 (fontified t) 3428 3431 (face font-lock-comment-delimiter-face fontified t) 3431 3490 (face font-lock-comment-face fontified t) 3490 3527 (fontified t) 3527 3531 (face font-lock-builtin-face fontified t) 3531 3536 (fontified t) 3536 3541 (face font-lock-builtin-face fontified t) 3541 3547 (fontified t) 3547 3550 (face font-lock-builtin-face fontified t) 3550 3554 (fontified t) 3554 3559 (face font-lock-builtin-face fontified t) 3559 3565 (fontified t) 3565 3570 (face font-lock-builtin-face fontified t) 3570 3613 (fontified t) 3613 3618 (face font-lock-builtin-face fontified t) 3618 3634 (fontified t) 3634 3638 (face font-lock-builtin-face fontified t) 3638 3643 (fontified t) 3643 3652 (face font-lock-builtin-face fontified t) 3652 3666 (fontified t) 3666 3669 (face font-lock-comment-delimiter-face fontified t) 3669 3690 (face font-lock-comment-face fontified t) 3690 3693 (fontified t) 3693 3719 (face font-lock-keyword-face fontified t) 3719 3757 (fontified t) 3757 3767 (face font-lock-string-face fontified t) 3767 3777 (fontified t) 3777 3782 (face font-lock-keyword-face fontified t) 3782 3783 (fontified t) 3783 3788 (face font-lock-function-name-face fontified t) 3788 3794 (fontified t) 3794 3809 (face font-lock-doc-face fontified t) 3809 3847 (fontified t) 3847 3850 (face font-lock-comment-delimiter-face fontified t) 3850 3888 (face font-lock-comment-face fontified t) 3888 3923 (fontified t) 3923 3931 (face font-lock-keyword-face fontified t) 3931 3932 (fontified t) 3932 3939 (face font-lock-function-name-face fontified t) 3939 3941 (fontified t) 3941 3946 (face font-lock-type-face fontified t) 3946 3955 (fontified t) 3955 4012 (face font-lock-doc-face fontified t) 4012 4017 (fontified t) 4017 4043 (face font-lock-keyword-face fontified t) 4043 4075 (fontified t) 4075 4083 (face font-lock-keyword-face fontified t) 4083 4084 (fontified t) 4084 4086 (face font-lock-function-name-face fontified t) 4086 4088 (fontified t) 4088 4093 (face font-lock-type-face fontified t) 4093 4102 (fontified t) 4102 4139 (face font-lock-doc-face fontified t) 4139 4144 (fontified t) 4144 4171 (face font-lock-keyword-face fontified t) 4171 4184 (fontified t) 4184 4187 (face font-lock-comment-delimiter-face fontified t) 4187 4225 (face font-lock-comment-face fontified t) 4225 4227 (fontified t) 4227 4232 (face font-lock-keyword-face fontified t) 4232 4233 (fontified t) 4233 4240 (face font-lock-function-name-face fontified t) 4240 4246 (fontified t) 4246 4251 (face font-lock-type-face fontified t) 4251 4262 (fontified t) 4262 4303 (face font-lock-doc-face fontified t) 4303 4307 (fontified t) 4307 4314 (face font-lock-keyword-face fontified t) 4314 4319 (fontified t) 4319 4322 (face font-lock-comment-delimiter-face fontified t) 4322 4366 (face font-lock-comment-face fontified t) 4366 4371 (fontified t) 4371 4374 (face font-lock-keyword-face fontified t) 4374 4404 (fontified t) 4404 4411 (face font-lock-builtin-face fontified t) 4411 4422 (fontified t) 4422 4425 (face font-lock-keyword-face fontified t) 4425 4497 (fontified t) 4497 4502 (face font-lock-keyword-face fontified t) 4502 4503 (fontified t) 4503 4511 (face font-lock-function-name-face fontified t) 4511 4517 (fontified t) 4517 4522 (face font-lock-type-face fontified t) 4522 4543 (fontified t) 4543 4571 (fontified t) 4571 4573 (fontified t) 4573 4578 (face font-lock-keyword-face fontified t) 4578 4579 (fontified t) 4579 4583 (face font-lock-function-name-face fontified t) 4583 4589 (fontified t) 4589 4594 (face font-lock-type-face fontified t) 4594 4605 (fontified t) 4605 4675 (face font-lock-doc-face fontified t) 4675 4679 (fontified t) 4679 4686 (face font-lock-keyword-face fontified t) 4686 4691 (fontified t) 4691 4694 (face font-lock-comment-delimiter-face fontified t) 4694 4758 (face font-lock-comment-face fontified t) 4758 4762 (fontified t) 4762 4765 (face font-lock-comment-delimiter-face fontified t) 4765 4834 (face font-lock-comment-face fontified t) 4834 4886 (fontified t)) . -19) (undo-tree-id7 . -4886) (undo-tree-id8 . -4225) 4905 (t 26802 4524 0 0)) nil (26802 47621 849678 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1731 . 1732) (nil fontified nil 19 . 1732) (19 . 1732)) nil (26802 47807 705323 0) 0 nil] [nil nil ((nil rear-nonsticky nil 1582 . 1583) (nil fontified nil 19 . 1583) (19 . 1583)) ((#("(defpackage :lumen.data.db
(error \"DB start! failed\"))))
#-postmodern
(setf *started* t))


(defun stop! ()
\"Close toplevel connection. Idempotent.\"
#+postmodern (ignore-errors (postmodern:disconnect-toplevel))
(setf *started* nil)
t)


;; ----------------------------------------------------------------------------
;; Transactions
;; ----------------------------------------------------------------------------
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) (retries 0)) &body body)
\"Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts.\"
(declare (ignore isolation read-only retries))
#+postmodern
`(postmodern:with-transaction () ,@body)
#-postmodern
`(progn ,@body))


;; ----------------------------------------------------------------------------
;; Internal helpers
;; ----------------------------------------------------------------------------
(defun %rows->alists (rows)
\"Best-effort conversion to alists. If ROWS already look like alists, return as-is.\"
(if (and rows (consp (first rows)) (keywordp (caar rows)))
rows
;; Fallback – leave as-is (caller may adapt). Improve with column metadata if needed.
rows))


(defun %now-ms ()
(round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))


;; ----------------------------------------------------------------------------
;; Query wrappers
;; ----------------------------------------------------------------------------" 0 1 (fontified nil) 1 11 (face font-lock-keyword-face fontified nil) 11 12 (fontified nil) 12 26 (face font-lock-type-face fontified nil) 26 28 (fontified nil) 28 33 (face font-lock-warning-face fontified nil) 33 34 (fontified nil) 34 52 (face font-lock-string-face fontified nil) 52 92 (fontified nil) 92 93 (fontified nil) 93 98 (face font-lock-keyword-face fontified nil) 98 99 (fontified nil) 99 104 (face font-lock-function-name-face fontified nil) 104 108 (fontified nil) 108 148 (face font-lock-doc-face fontified nil) 148 149 (fontified nil) 149 210 (face slime-reader-conditional-face fontified nil) 210 232 (fontified nil) 232 234 (fontified nil) 234 235 (fontified nil) 235 236 (fontified nil) 236 237 (fontified nil) 237 240 (face font-lock-comment-delimiter-face fontified nil) 240 317 (face font-lock-comment-face fontified nil) 317 320 (face font-lock-comment-delimiter-face fontified nil) 320 333 (face font-lock-comment-face fontified nil) 333 336 (face font-lock-comment-delimiter-face fontified nil) 336 413 (face font-lock-comment-face fontified nil) 413 414 (fontified nil) 414 422 (face font-lock-keyword-face fontified nil) 422 423 (fontified nil) 423 430 (face font-lock-function-name-face fontified nil) 430 433 (fontified nil) 433 437 (face font-lock-type-face fontified nil) 437 449 (fontified nil) 449 464 (face font-lock-builtin-face fontified nil) 464 495 (fontified nil) 495 500 (face font-lock-type-face fontified nil) 500 507 (fontified nil) 507 702 (face font-lock-doc-face fontified nil) 702 704 (fontified nil) 704 711 (face font-lock-keyword-face fontified nil) 711 750 (fontified nil) 750 803 (face slime-reader-conditional-face fontified nil) 803 817 (fontified nil) 817 819 (fontified nil) 819 824 (face font-lock-keyword-face fontified nil) 824 833 (fontified nil) 833 834 (fontified nil) 834 835 (fontified nil) 835 836 (fontified nil) 836 839 (face font-lock-comment-delimiter-face fontified nil) 839 916 (face font-lock-comment-face fontified nil) 916 919 (face font-lock-comment-delimiter-face fontified nil) 919 936 (face font-lock-comment-face fontified nil) 936 939 (face font-lock-comment-delimiter-face fontified nil) 939 1016 (face font-lock-comment-face fontified nil) 1016 1017 (fontified nil) 1017 1022 (face font-lock-keyword-face fontified nil) 1022 1023 (fontified nil) 1023 1036 (face font-lock-function-name-face fontified nil) 1036 1044 (fontified nil) 1044 1127 (face font-lock-doc-face fontified nil) 1127 1129 (fontified nil) 1129 1131 (face font-lock-keyword-face fontified nil) 1131 1192 (fontified nil) 1192 1195 (face font-lock-comment-delimiter-face fontified nil) 1195 1278 (face font-lock-comment-face fontified nil) 1278 1288 (fontified nil) 1288 1293 (face font-lock-keyword-face fontified nil) 1293 1294 (fontified nil) 1294 1301 (face font-lock-function-name-face fontified nil) 1301 1385 (fontified nil) 1385 1386 (fontified nil) 1386 1387 (fontified nil) 1387 1390 (face font-lock-comment-delimiter-face fontified nil) 1390 1467 (face font-lock-comment-face fontified nil) 1467 1470 (face font-lock-comment-delimiter-face fontified nil) 1470 1485 (face font-lock-comment-face fontified nil) 1485 1488 (face font-lock-comment-delimiter-face fontified nil) 1488 1500 (face font-lock-comment-face fontified nil) 1500 1563 (face font-lock-comment-face fontified nil) 1563 1564 (face font-lock-comment-face fontified nil rear-nonsticky nil)) . 19) (undo-tree-id9 . -1386) (undo-tree-id10 . -804) (undo-tree-id11 . -1386) (undo-tree-id12 . -834) (undo-tree-id13 . -235) (undo-tree-id14 . -235) (undo-tree-id15 . -360) (undo-tree-id16 . -360) (undo-tree-id17 . -149) (undo-tree-id18 . -151) (undo-tree-id19 . -92) (undo-tree-id20 . -232) (undo-tree-id21 . -750) (undo-tree-id22 . -752) (undo-tree-id23 . -750) (undo-tree-id24 . -752) (undo-tree-id25 . -413) (undo-tree-id26 . -817) (undo-tree-id27 . -1386) (undo-tree-id28 . -1386) (nil fontified t 1489 . 1504) (nil fontified t 1486 . 1489) (nil fontified t 1409 . 1486) (nil fontified t 1406 . 1409) (nil fontified t 1405 . 1406) (nil fontified t 1404 . 1405) (nil fontified t 1320 . 1404) (nil fontified t 1313 . 1320) (nil fontified t 1312 . 1313) (nil fontified t 1307 . 1312) (nil fontified t 1297 . 1307) (nil fontified t 1214 . 1297) (nil fontified t 1211 . 1214) (nil fontified t 1150 . 1211) (nil fontified t 1148 . 1150) (nil fontified t 1146 . 1148) (nil fontified t 1063 . 1146) (nil fontified t 1055 . 1063) (nil fontified t 1042 . 1055) (nil fontified t 1041 . 1042) (nil fontified t 1036 . 1041) (nil fontified t 1035 . 1036) (nil fontified t 958 . 1035) (nil fontified t 955 . 958) (nil fontified t 938 . 955) (nil fontified t 935 . 938) (nil fontified t 858 . 935) (nil fontified t 855 . 858) (nil fontified t 854 . 855) (nil fontified t 853 . 854) (nil fontified t 852 . 853) (nil fontified t 843 . 852) (nil fontified t 838 . 843) (nil fontified t 836 . 838) (nil fontified t 822 . 836) (nil fontified t 769 . 822) (nil fontified t 730 . 769) (nil fontified t 723 . 730) (nil fontified t 721 . 723) (nil fontified t 526 . 721) (nil fontified t 519 . 526) (nil fontified t 514 . 519) (nil fontified t 483 . 514) (nil fontified t 468 . 483) (nil fontified t 456 . 468) (nil fontified t 452 . 456) (nil fontified t 449 . 452) (nil fontified t 442 . 449) (nil fontified t 441 . 442) (nil fontified t 433 . 441) (nil fontified t 432 . 433) (nil fontified t 355 . 432) (nil fontified t 352 . 355) (nil fontified t 339 . 352) (nil fontified t 336 . 339) (nil fontified t 259 . 336) (nil fontified t 256 . 259) (nil fontified t 255 . 256) (nil fontified t 254 . 255) (nil fontified t 253 . 254) (nil fontified t 251 . 253) (nil fontified t 229 . 251) (nil fontified t 168 . 229) (nil fontified t 167 . 168) (nil fontified t 127 . 167) (nil fontified t 123 . 127) (nil fontified t 118 . 123) (nil fontified t 117 . 118) (nil fontified t 112 . 117) (nil fontified t 111 . 112) (nil fontified t 71 . 111) (nil fontified t 53 . 71) (nil fontified t 52 . 53) (nil fontified t 47 . 52) (nil fontified t 45 . 47) (nil fontified t 31 . 45) (nil fontified t 30 . 31) (nil fontified t 20 . 30) (nil fontified t 19 . 20) (nil rear-nonsticky t 1582 . 1583)) (26802 47621 320709 0) 0 nil])
([nil nil ((1536 . 1538) (1521 . 1523) (1490 . 1491) (1468 . 1469) (1446 . 1447) (1433 . 1439) (1410 . 1413) (1331 . 1334) (1295 . 1298) (1287 . 1288) (1269 . 1273) (1202 . 1204) (1167 . 1169) (1128 . 1130) (1082 . 1084) (1049 . 1051) (1020 . 1022) (982 . 984) (967 . 969) (934 . 936) (799 . 801) 757) nil (26802 47807 705322 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1404) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 1405) ((1404 . 1405)) (26802 47620 738293 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -579) (undo-tree-id38 . -1) (undo-tree-id39 . -1) 580) nil (26802 47807 705319 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -852) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 853) ((852 . 853)) (26802 47620 200269 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -354) (undo-tree-id36 . -1) (undo-tree-id37 . -1) 355) nil (26802 47807 705318 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -253) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 254) ((253 . 254)) (26802 47620 200201 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1555) (undo-tree-id34 . -1) (undo-tree-id35 . -1) 1556) nil (26802 47807 705316 0) 0 nil])
nil
([nil nil ((#("(defun stop! ()
\"Close toplevel connection. Idempotent.\"
#+postmodern (ignore-errors (postmodern:disconnect-toplevel))
(setf *started* nil)" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 12 (face font-lock-function-name-face fontified t) 12 16 (fontified t) 16 56 (face font-lock-doc-face fontified t) 56 57 (fontified t) 57 118 (face slime-reader-conditional-face fontified t) 118 139 (fontified t)) . -1557) (undo-tree-id33 . -139) 1696) nil (26802 47807 705314 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1698 . 1699) (nil fontified nil 1557 . 1699) (1557 . 1699)) nil (26802 47807 705313 0) 0 nil])
([nil nil ((1697 . 1699) (1699 . 1700)) nil (26802 47807 705313 0) 0 nil])
([nil nil ((1680 . 1682) (1616 . 1618) (1573 . 1575) 1557) nil (26802 47807 705312 0) 0 nil])
([nil nil ((1707 . 1709)) nil (26802 47807 705312 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2855 . 2856) (nil fontified nil 1709 . 2856) (1709 . 2856)) nil (26802 47807 705311 0) 0 nil])
([nil nil ((#("

;; ----------------------------------------------------------------------------" 0 1 (fontified t) 1 2 (fontified t) 2 5 (face font-lock-comment-delimiter-face fontified t) 5 80 (face font-lock-comment-face fontified t) 80 81 (face font-lock-comment-face fontified t rear-nonsticky t)) . -2856) (undo-tree-id32 . -81) 2937) nil (26802 47807 705310 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2306) (undo-tree-id30 . -1) (undo-tree-id31 . -1) 2307) nil (26802 47807 705309 0) 0 nil])
([nil nil ((2299 . 2301) (2284 . 2286) (2241 . 2243) (2226 . 2228) (2177 . 2179) (1979 . 1981) 1885) nil (26802 47807 705307 0) 0 nil])
([nil nil ((2777 . 2783) (2685 . 2691) (2674 . 2680) (2613 . 2615) (2527 . 2529) 2499) nil (26802 47807 705306 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2789) (undo-tree-id29 . -1) 2790) nil (26802 47807 705304 0) 0 nil])
([nil nil ((2891 . 2892) (2809 . 2811) (2888 . 2889)) nil (26802 47807 705295 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3068 . 3069) (nil fontified nil 2892 . 3069) (2892 . 3069)) nil (26802 47807 705294 0) 0 nil])
([nil nil ((3069 . 3070)) nil (26802 47807 705294 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3694 . 3695) (nil fontified nil 3070 . 3695) (3070 . 3695)) nil (26802 47807 705293 0) 0 nil])
([nil nil ((3695 . 3696)) nil (26802 47807 705293 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4021 . 4022) (nil fontified nil 3696 . 4022) (3696 . 4022)) nil (26802 47807 705292 0) 0 nil])
([nil nil ((4022 . 4023)) nil (26802 47807 705291 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4763 . 4764) (nil fontified nil 4023 . 4764) (4023 . 4764)) nil (26802 47807 705288 0) 0 nil])
([nil nil ((277 . 279) (218 . 220) (162 . 164) (106 . 108) (59 . 61) (46 . 48) 19 (t 26802 47807 0 0)) nil (26802 48424 517843 0) 0 nil])
([nil nil ((338 . 339)) nil (26802 48424 517842 0) 0 nil])
([nil nil ((58 . 61)) nil (26802 48424 517842 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 95 . 96) (nil fontified nil 95 . 96) (nil fontified nil 87 . 95) (nil fontified nil 86 . 87) (nil fontified nil 75 . 86) (nil fontified nil 74 . 75) (nil fontified nil 62 . 74) (nil fontified nil 61 . 62) (61 . 96)) nil (26802 48424 517841 0) 0 nil])
([nil nil ((#("prepare" 0 7 (face font-lock-builtin-face fontified t)) . -88) (undo-tree-id40 . -7) 95) nil (26802 48424 517840 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 106 . 107) (nil fontified nil 88 . 107) (88 . 107)) nil (26802 48424 517830 0) 0 nil])
([nil nil ((107 . 108)) nil (26802 48424 517829 0) 0 nil])
([nil nil ((87 . 88)) nil (26802 48424 517829 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 103 . 104) (nil fontified nil 88 . 104) (88 . 104)) nil (26802 48424 517828 0) 0 nil])
([nil nil ((104 . 105)) nil (26802 48424 517827 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 141 . 142) (nil fontified nil 126 . 142) (126 . 142)) nil (26802 48424 517826 0) 0 nil])
([nil nil ((126 . 127)) nil (26802 48424 517822 0) 0 nil])
([nil nil ((246 . 247) (t 26802 48424 0 0)) nil (26802 51659 125808 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 301 . 302) (nil fontified nil 279 . 302) (nil fontified nil 268 . 279) (nil fontified nil 267 . 268) (nil fontified nil 247 . 267) (247 . 302)) nil (26802 51659 125807 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 267)) nil (26802 51659 125806 0) 0 nil])
([nil nil ((#("        " 0 8 (fontified nil)) . -271) (267 . 268)) nil (26802 51659 125806 0) 0 nil])
([nil nil ((87 . 90) (#(" " 0 1 (fontified nil)) . 86) (undo-tree-id45 . -1) (87 . 88)) nil (26802 51659 125805 0) 0 nil])
([nil nil ((183 . 186) (#(" " 0 1 (fontified nil)) . 182) (undo-tree-id44 . -1) (183 . 184)) nil (26802 51659 125804 0) 0 nil])
([nil nil ((234 . 237) (#(" " 0 1 (fontified nil)) . 233) (undo-tree-id43 . -1) (234 . 235)) nil (26802 51659 125802 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -276) (undo-tree-id42 . -3) 279) nil (26802 51659 125801 0) 0 nil])
([nil nil ((416 . 419)) nil (26802 51659 125799 0) 0 nil])
([nil nil ((58 . 61)) nil (26802 51659 125799 0) 0 nil])
([nil nil ((#(":start! :stop! :with-tx :query-a :query-1a :exec" 0 7 (face font-lock-builtin-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-builtin-face fontified t) 14 15 (fontified t) 15 23 (face font-lock-builtin-face fontified t) 23 24 (fontified t) 24 32 (face font-lock-builtin-face fontified t) 32 33 (fontified t) 33 42 (face font-lock-builtin-face fontified t) 42 43 (fontified t) 43 48 (face font-lock-builtin-face fontified t)) . -434) (undo-tree-id41 . -48) 482) nil (26802 51659 125798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 563 . 564) (nil fontified nil 434 . 564) (434 . 564)) nil (26802 51659 125789 0) 0 nil])
([nil nil ((818 . 819)) nil (26802 51659 125858 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 894 . 895) (nil fontified nil 819 . 895) (819 . 895)) nil (26802 54107 576152 0) 0 nil] [nil nil ((nil rear-nonsticky nil 948 . 949) (nil fontified nil 819 . 949) (819 . 949)) ((#(":start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection
           :*connection-mode*" 0 7 (face font-lock-builtin-face fontified nil) 7 8 (fontified nil) 8 14 (face font-lock-builtin-face fontified nil) 14 15 (fontified nil) 15 23 (face font-lock-builtin-face fontified nil) 23 35 (fontified nil) 35 43 (face font-lock-builtin-face fontified nil) 43 44 (fontified nil) 44 53 (face font-lock-builtin-face fontified nil) 53 54 (fontified nil) 54 59 (face font-lock-builtin-face fontified nil) 59 71 (fontified nil) 71 81 (face font-lock-builtin-face fontified nil) 81 82 (fontified nil) 82 100 (face font-lock-builtin-face fontified nil) 100 101 (fontified nil) 101 112 (fontified nil) 112 129 (face font-lock-builtin-face fontified nil) 129 130 (face font-lock-builtin-face rear-nonsticky nil fontified nil)) . 819) (undo-tree-id46 . -130) (undo-tree-id47 . -101) (nil fontified t 919 . 920) (nil fontified t 901 . 919) (nil fontified t 900 . 901) (nil fontified t 890 . 900) (nil fontified t 878 . 890) (nil fontified t 873 . 878) (nil fontified t 872 . 873) (nil fontified t 863 . 872) (nil fontified t 862 . 863) (nil fontified t 854 . 862) (nil fontified t 842 . 854) (nil fontified t 834 . 842) (nil fontified t 833 . 834) (nil fontified t 827 . 833) (nil fontified t 826 . 827) (nil fontified t 819 . 826) (nil rear-nonsticky t 948 . 949)) (26802 51659 125784 0) 0 nil])
([nil nil ((2816 . 2817)) nil (26802 54107 576152 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 3074 . 3075) (nil fontified nil 2817 . 3075) (2817 . 3075)) nil (26802 54107 576151 0) 0 nil])
([nil nil ((3467 . 3469)) nil (26802 54107 576150 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3572 . 3573) (nil fontified nil 3469 . 3573) (3469 . 3573)) nil (26802 54107 576150 0) 0 nil])
([nil nil ((#("(defun start! (&key (config (db-config)))
  \"Initialize Postmodern connection (toplevel) using CONFIG.
CONFIG is the plist returned by lumen.data.config:db-config. Idempotent.\"
  (setf *current-config* config)
  #+postmodern
  (let* ((db (getf config :database))
	 (user (getf config :user))
	 (pass (getf config :password))
	 (host (or (getf config :host) \"localhost\"))
	 (port (or (getf config :port) 5432))
	 (sslmode (getf config :sslmode))
	 (use-ssl (member sslmode '(:require :verify-ca :verify-full))) )
    (handler-case
	(progn
	  (postmodern:disconnect-toplevel)
	  (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl)
	  (setf *started* t))
      (t (c)
	(declare (ignore c))
	(setf *started* nil)
	(error \"DB start! failed\"))))
  #-postmodern
  (setf *started* t))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 13 (face font-lock-function-name-face fontified t) 13 15 (fontified t) 15 19 (face font-lock-type-face fontified t) 19 42 (fontified t) 42 44 (fontified t) 44 103 (face font-lock-doc-face fontified t) 103 176 (face font-lock-doc-face fontified t) 176 177 (fontified t) 177 212 (fontified t) 212 227 (face slime-reader-conditional-face fontified t) 227 265 (face slime-reader-conditional-face fontified t) 265 294 (face slime-reader-conditional-face fontified t) 294 327 (face slime-reader-conditional-face fontified t) 327 357 (face slime-reader-conditional-face fontified t) 357 368 (face slime-reader-conditional-face fontified t) 368 373 (face slime-reader-conditional-face fontified t) 373 412 (face slime-reader-conditional-face fontified t) 412 447 (face slime-reader-conditional-face fontified t) 447 516 (face slime-reader-conditional-face fontified t) 516 531 (face slime-reader-conditional-face fontified t) 531 541 (face slime-reader-conditional-face fontified t) 541 577 (face slime-reader-conditional-face fontified t) 577 648 (face slime-reader-conditional-face fontified t) 648 656 (face slime-reader-conditional-face fontified t) 656 682 (face slime-reader-conditional-face fontified t) 682 690 (face slime-reader-conditional-face fontified t) 690 712 (face slime-reader-conditional-face fontified t) 712 734 (face slime-reader-conditional-face fontified t) 734 741 (face slime-reader-conditional-face fontified t) 741 743 (face slime-reader-conditional-face fontified t) 743 759 (face slime-reader-conditional-face fontified t) 759 763 (face slime-reader-conditional-face fontified t) 763 764 (fontified t) 764 766 (fontified t) 766 779 (fontified t) 779 781 (fontified t) 781 790 (fontified t) 790 791 (fontified t) 791 800 (fontified t)) . -1073) (undo-tree-id90 . -800) 1873) nil (26802 54107 576149 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2414 . 2415) (nil fontified nil 1073 . 2415) (1073 . 2415)) nil (26802 54107 576147 0) 0 nil])
([nil nil ((#("(defun stop! ()
  \"Close toplevel connection. Idempotent.\"
  #+postmodern (ignore-errors (postmodern:disconnect-toplevel))
  (setf *started* nil)
  t)" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 12 (face font-lock-function-name-face fontified t) 12 16 (fontified t) 16 18 (fontified t) 18 58 (face font-lock-doc-face fontified t) 58 61 (fontified t) 61 64 (face slime-reader-conditional-face fontified t) 64 92 (face slime-reader-conditional-face fontified t) 92 122 (face slime-reader-conditional-face fontified t) 122 123 (fontified t) 123 125 (fontified t) 125 145 (fontified t) 145 146 (fontified t) 146 148 (fontified t) 148 149 (fontified t) 149 150 (fontified t rear-nonsticky t)) . -2417) (undo-tree-id89 . -150) 2567) nil (26802 54107 576146 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2592 . 2593) (nil fontified nil 2417 . 2593) (2417 . 2593)) nil (26802 54107 576145 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only retries))
  #+postmodern
  `(postmodern:with-transaction () ,@body)
  #-postmodern
  `(progn ,@body))" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 49 (fontified t) 49 64 (face slime-reader-conditional-face fontified t) 64 104 (face slime-reader-conditional-face fontified t) 104 107 (fontified t) 107 122 (fontified t) 122 124 (fontified t) 124 129 (face font-lock-keyword-face fontified t) 129 138 (fontified t)) . -3065) (undo-tree-id88 . -138) 3203) nil (26802 54107 576144 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3221 . 3222) (nil fontified nil 3065 . 3222) (3065 . 3222)) nil (26802 54107 576143 0) 0 nil])
([nil nil ((3065 . 3066)) nil (26802 54107 576142 0) 0 nil])
([nil nil ((2593 . 2595)) nil (26802 54107 576142 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4138 . 4139) (nil fontified nil 2595 . 4139) (2595 . 4139)) nil (26802 54107 576141 0) 0 nil])
([nil nil ((4139 . 4141)) nil (26802 54107 576141 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4203 . 4204) (nil fontified nil 4141 . 4204) (4141 . 4204)) nil (26802 54107 576140 0) 0 nil])
([nil nil ((#(";; ----------------------------------------------------------------------------
;; Transactions
;; ----------------------------------------------------------------------------" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 55 (face font-lock-comment-face fontified t) 55 80 (face font-lock-comment-face fontified t) 80 83 (face font-lock-comment-delimiter-face fontified t) 83 96 (face font-lock-comment-face fontified t) 96 99 (face font-lock-comment-delimiter-face fontified t) 99 103 (face font-lock-comment-face fontified t) 103 117 (face font-lock-comment-face fontified t) 117 118 (face font-lock-comment-face fontified t) 118 175 (face font-lock-comment-face fontified t)) . 4206) (undo-tree-id87 . -175) 4381) nil (26802 54107 576139 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -4205) (undo-tree-id85 . -1) (undo-tree-id86 . -1) 4206) nil (26802 54107 576138 0) 0 nil])
([nil nil ((2594 . 2595)) nil (26802 54107 576136 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2769 . 2770) (nil fontified nil 2713 . 2770) (nil fontified nil 2712 . 2713) (nil fontified nil 2698 . 2712) (nil fontified nil 2694 . 2698) (nil fontified nil 2691 . 2694) (nil fontified nil 2678 . 2691) (nil fontified nil 2675 . 2678) (nil fontified nil 2650 . 2675) (nil fontified nil 2598 . 2650) (nil fontified nil 2595 . 2598) (2595 . 2770)) nil (26802 54107 576135 0) 0 nil])
([nil nil ((2678 . 2689)) nil (26802 54107 576134 0) 0 nil])
([nil nil ((2689 . 2690)) nil (26802 54107 576133 0) 0 nil])
([nil nil ((2690 . 2691)) nil (26802 54107 576133 0) 0 nil])
([nil nil ((2691 . 2692)) nil (26802 54107 576132 0) 0 nil])
([nil nil ((#("(defun query-a (sql &rest params)
  \"Execute a SELECT-like statement, return (values rows-alist count).\"
  (let ((t0 (get-internal-real-time)))
    (handler-case
        (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
               (rows (apply fn params))
               (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                         internal-time-units-per-second))))
          (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
          (values rows (length rows)))
      (condition (c)
        (lumen.data.errors:translate-db-error c)))))

(defun query-1a (sql &rest params)
  \"Like query-a but expect 0/1 row; return alist or NIL. Uses :alist format.\"
  (handler-case
      (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
             (row (apply fn params)))
        row)
    (condition (c)
      (lumen.data.errors:translate-db-error c))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (face font-lock-function-name-face fontified t) 14 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 36 (fontified t) 36 104 (face font-lock-doc-face fontified t) 104 108 (fontified t) 108 111 (face font-lock-keyword-face fontified t) 111 149 (fontified t) 149 161 (face font-lock-keyword-face fontified t) 161 171 (fontified t) 171 175 (face font-lock-keyword-face fontified t) 175 225 (fontified t) 225 232 (face font-lock-builtin-face fontified t) 232 233 (fontified t) 233 240 (face font-lock-builtin-face fontified t) 240 271 (fontified t) 271 283 (fontified t) 283 315 (fontified t) 315 355 (fontified t) 355 380 (fontified t) 380 383 (fontified t) 383 431 (fontified t) 431 537 (fontified t) 537 551 (fontified t) 551 624 (fontified t) 624 625 (fontified t rear-nonsticky t) 625 626 (fontified t) 626 627 (fontified t) 627 632 (face font-lock-keyword-face fontified t) 632 633 (fontified t) 633 641 (face font-lock-function-name-face fontified t) 641 647 (fontified t) 647 652 (face font-lock-type-face fontified t) 652 663 (fontified t) 663 738 (face font-lock-doc-face fontified t) 738 742 (fontified t) 742 754 (face font-lock-keyword-face fontified t) 754 762 (fontified t) 762 766 (face font-lock-keyword-face fontified t) 766 815 (fontified t) 815 822 (face font-lock-builtin-face fontified t) 822 823 (fontified t) 823 829 (face font-lock-builtin-face fontified t) 829 848 (fontified t) 848 870 (fontified t) 870 929 (fontified t) 929 951 (fontified t)) . -5966) (undo-tree-id83 . -105) (undo-tree-id84 . -951) 6917) nil (26802 54107 576131 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6693 . 6694) (nil fontified nil 5966 . 6694) (5966 . 6694)) nil (26802 54107 576130 0) 0 nil])
([nil nil ((#("Returns (values affected returning?).
If the SQL has a RETURNING clause, fetch the single returned row as an alist" 0 114 (face font-lock-doc-face fontified t)) . -6760) (undo-tree-id82 . -114) 6874) nil (26802 54107 576129 0) 0 nil])
([nil nil ((#("." 0 1 (face font-lock-doc-face fontified t)) . 6760)) nil (26802 54107 576128 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-doc-face fontified t)) . -6759) (undo-tree-id80 . -1) (undo-tree-id81 . -1) 6760) nil (26802 54107 576127 0) 0 nil])
([nil nil ((6759 . 6760)) nil (26802 54107 576125 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6879 . 6880) (nil fontified nil 6760 . 6880) (6760 . 6880)) nil (26802 54107 576125 0) 0 nil])
([nil nil ((#("(handler-case
      (let* ((lower (string-downcase sql))
             (has-returning (search \"returning\" lower)))
        (if has-returning
            (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
                   (row (apply fn params)))
              (values (if row 1 0) row))
            (let* ((fn       (lumen.data.prepare:get-prepared-plan sql :format :raw))
                   (affected (or (apply fn params) 0)))
              (values affected nil))))
    (condition (c)
      (lumen.data.errors:translate-db-error c)))" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 21 (fontified t) 21 25 (face font-lock-keyword-face fontified t) 25 93 (fontified t) 93 102 (face font-lock-string-face fontified t) 102 104 (face font-lock-string-face fontified t) 104 114 (fontified t) 114 123 (fontified t) 123 125 (face font-lock-keyword-face fontified t) 125 153 (fontified t) 153 157 (face font-lock-keyword-face fontified t) 157 183 (fontified t) 183 185 (fontified t) 185 206 (fontified t) 206 213 (face font-lock-builtin-face fontified t) 213 214 (fontified t) 214 220 (face font-lock-builtin-face fontified t) 220 223 (fontified t) 223 266 (fontified t) 266 267 (fontified t) 267 290 (fontified t) 290 292 (face font-lock-keyword-face fontified t) 292 321 (fontified t) 321 325 (face font-lock-keyword-face fontified t) 325 364 (fontified t) 364 379 (fontified t) 379 386 (face font-lock-builtin-face fontified t) 386 387 (fontified t) 387 391 (face font-lock-builtin-face fontified t) 391 394 (fontified t) 394 556 (fontified t)) . -6884) (undo-tree-id78 . -56) (undo-tree-id79 . -556) 7440) nil (26802 54107 576124 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7420 . 7421) (nil fontified nil 6884 . 7421) (6884 . 7421)) nil (26802 54107 576122 0) 0 nil])
([nil nil ((7422 . 7423)) nil (26802 54107 576121 0) 0 nil])
([nil nil ((4848 . 4850)) nil (26802 54107 576121 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6621 . 6622) (nil fontified nil 4850 . 6622) (4850 . 6622)) nil (26802 54107 576120 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -6621) (undo-tree-id77 . -1) 6622) nil (26802 54107 576119 0) 0 nil])
([nil nil ((#("Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts." 0 54 (face font-lock-doc-face fontified t) 54 65 (face font-lock-doc-face fontified t) 65 96 (face font-lock-doc-face fontified t) 96 125 (face font-lock-doc-face fontified t) 125 193 (face font-lock-doc-face fontified t)) . 4493) (undo-tree-id76 . -193) 4686) nil (26802 54107 576118 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4979 . 4980) (nil fontified nil 4912 . 4980) (nil fontified nil 4883 . 4912) (nil fontified nil 4852 . 4883) (nil fontified nil 4841 . 4852) (nil fontified nil 4787 . 4841) (4787 . 4980)) nil (26802 54107 576116 0) 0 nil])
([nil nil ((4980 . 4982)) nil (26802 54107 576115 0) 0 nil])
([nil nil ((#("
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) (retries 0)) &body body)
  \"\"
  (declare (ignore isolation read-only retries))
  #+postmodern
  `(ensure-connection (postmodern:with-transaction () ,@body))
  #-postmodern
  `(progn ,@body))" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 21 (fontified t) 21 25 (face font-lock-type-face fontified t) 25 37 (fontified t) 37 52 (face font-lock-builtin-face fontified t) 52 83 (fontified t) 83 88 (face font-lock-type-face fontified t) 88 95 (fontified t) 95 97 (fontified t) 97 98 (face font-lock-doc-face fontified t) 98 99 (face font-lock-doc-face fontified t) 99 100 (fontified t) 100 103 (fontified t) 103 110 (face font-lock-keyword-face fontified t) 110 149 (fontified t) 149 151 (fontified t) 151 226 (face slime-reader-conditional-face fontified t) 226 242 (fontified t) 242 246 (fontified t) 246 251 (face font-lock-keyword-face fontified t) 251 259 (fontified t) 259 260 (fontified t rear-nonsticky t)) . 4395) (undo-tree-id75 . -260)) nil (26802 54107 576114 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -4394) (undo-tree-id73 . -1) (undo-tree-id74 . -1) 4395) nil (26802 54107 576113 0) 0 nil])
([nil nil ((359 . 360)) nil (26802 54107 576111 0) 0 nil])
([nil nil ((360 . 361)) nil (26802 54107 576111 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 372 . 373) (nil fontified nil 361 . 373) (361 . 373)) nil (26802 54107 576110 0) 0 nil])
([nil nil ((373 . 374)) nil (26802 54107 576109 0) 0 nil])
([nil nil ((374 . 379)) nil (26802 54107 576109 0) 0 nil])
([nil nil ((#("u" 0 1 (fontified t)) . -378) (undo-tree-id72 . -1) 379) nil (26802 54107 576108 0) 0 nil])
([nil nil ((378 . 381)) nil (26802 54107 576107 0) 0 nil])
([nil nil ((374 . 383) (#("retryab" 0 7 (fontified t)) . -374) (undo-tree-id71 . -7) 381) nil (26802 54107 576107 0) 0 nil])
([nil nil ((383 . 384)) nil (26802 54107 576105 0) 0 nil])
([nil nil ((374 . 394) (#("retryable-" 0 10 (fontified t)) . -374) (undo-tree-id70 . -10) 384) nil (26802 54107 576104 0) 0 nil])
([nil nil ((374 . 375)) nil (26802 54107 576103 0) 0 nil])
([nil nil ((#("(let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        ;; pool natif via :pooled-p t
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app
                                          :pooled-p t)
          ,@body))" 0 169 (face slime-reader-conditional-face fontified t) 169 189 (face slime-reader-conditional-face fontified t) 189 200 (face slime-reader-conditional-face fontified t) 200 302 (face slime-reader-conditional-face fontified t) 302 304 (face slime-reader-conditional-face fontified t) 304 379 (face slime-reader-conditional-face fontified t) 379 382 (face slime-reader-conditional-face fontified t) 382 409 (face slime-reader-conditional-face fontified t) 409 588 (face slime-reader-conditional-face fontified t) 588 668 (face slime-reader-conditional-face fontified t) 668 676 (face slime-reader-conditional-face fontified t)) . -3653) (undo-tree-id69 . -676) 4329) nil (26802 54107 576102 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5031 . 5032) (nil fontified nil 3653 . 5032) (3653 . 5032)) nil (26802 54107 576098 0) 0 nil])
([nil nil ((#(")" 0 1 (face slime-reader-conditional-face fontified t)) . -5033) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) 5034) nil (26802 54107 576096 0) 0 nil])
([nil nil ((5033 . 5034)) nil (26802 54107 576082 0) 0 nil])
([nil nil ((5068 . 5069)) nil (26802 54107 576081 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -5068) (undo-tree-id48 . -1) (undo-tree-id49 . -1) 5069) nil (26802 54107 576077 0) 0 nil])
([nil nil ((1 . 9685) (#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection
           :*connection-mode*))

(in-package :lumen.data.db)

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
;; :toplevel | :scoped | :pooled-native
(defvar *connection-mode* :toplevel)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (db-config)))
  \"Initialise selon :connection-mode.
:toplevel → connect-toplevel
:scoped   → rien (ouverture par bloc)
:pooled-native → rien ici (piscine Postmodern via :pooled-p dans with-conn).
Tu peux régler postmodern:*max-pool-size* en amont.\"
  (setf *current-config* config
        *connection-mode* (or (getf config :connection-mode) :toplevel))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    (:scoped (setf *started* t))
    (:pooled-native (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections & Transactions
;; ----------------------------------------------------------------------------
(defmacro with-conn (&body body)
  \"Ouvre une connexion selon *connection-mode* avec les bons paramètres Postmodern.\"
  #+postmodern
  `(ecase *connection-mode*
     (:toplevel
      (progn ,@body))
     (:scoped
      (let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
          ,@body)))
     (:pooled-native
      (let ((deadline (+ (get-internal-real-time)
                    (* cl:internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
       (start (get-internal-real-time)))
   (labels ((acquire-slot ()
              (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                  (if (< (get-internal-real-time) deadline)
                      (acquire-slot)
                      (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
     (acquire-slot)
     (let* ((wait-ms (* 1000.0 (/ (- (get-internal-real-time) start)
                                  cl:internal-time-units-per-second))))
       ;; enregistre métrique (nb slots utilisés = *pool-size* - count du sema)
       (let ((in-use (- *pool-size* (bt:semaphore-count *pool-sema*))))
         (lumen.data.metrics:record-pool-stats in-use wait-ms)))
     (unwind-protect
          (let* ((cfg *current-config*)
                 (db   (getf cfg :database))
                 (user (getf cfg :user))
                 (pass (getf cfg :password))
                 (host (or (getf cfg :host) \"localhost\"))
                 (port (or (getf cfg :port) 5432))
                 (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
            (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl)
              ,@body))
       (bt:signal-semaphore *pool-sema*))))))
  #-postmodern
  `(progn ,@body))

(defmacro ensure-connection (&body body)
  `(with-conn ,@body))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) (retries 0) (sleep-ms 50))
                   &body body)
  \"Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts.

Transaction avec **retries** automatiques sur erreurs retryables (deadlock/serialization/timeout).
Arguments :
  :isolation  — décoratif pour l’instant (hook possible si tu veux paramétrer).
  :read-only  — décoratif / futur.
  :retries    — nombre de tentatives additionnelles (0 = pas de retry).
  :sleep-ms   — temps d’attente entre tentatives (backoff linéaire simple).
Exemple : (with-tx (:retries 3 :sleep-ms 100) ...)\"
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\")))
    `(let ((,g-attempt 0)
           (,g-retries ,retries)
           (,g-sleep ,sleep-ms))
       (loop
         (handler-case
             (return
               (ensure-connection
                 #+postmodern
                 (postmodern:with-transaction () ,@body)
                 #-postmodern
                 (progn ,@body)))
           (condition (c)
             ;; Convertit en condition Lumen sans la signaler, puis évalue la rejouabilité
             (let ((mapped (lumen.data.errors:map-db-error c)))
               (if (and (< ,g-attempt ,g-retries)
                        (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (incf ,g-attempt)
                     ;; Backoff simple (optionnel)
                     (when (plusp ,g-sleep)
                       (sleep (/ (max 0 ,g-sleep) 1000.0)))
                     ;; et on boucle pour retenter
                     (continue))
                   ;; Pas rejouable (ou plus de retries) → signaler l’erreur Lumen
                   (error mapped)))))))))

;; ----------------------------------------------------------------------------
;; Internal helpers
;; ----------------------------------------------------------------------------
;; Postmodern attend :use-ssl = :no | :try | :require | :yes | :full
(defun %sslmode->use-ssl (sslmode)
  (case sslmode
    ((:disable nil) :no)
    ((:allow :prefer) :try)
    (:require :require)
    (:verify-ca :yes)
    (:verify-full :full)
    (t :no)))

(defun %rows->alists (rows)
  \"Best-effort conversion to alists. If ROWS already look like alists, return as-is.\"
  (if (and rows (consp (first rows)) (keywordp (caar rows)))
      rows
      ;; Fallback – leave as-is (caller may adapt). Improve with column metadata if needed.
      rows))

(defun %now-ms ()
  (round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))

(defun %elapsed-ms (t0)
  (* 1000.0 (/ (- (get-internal-real-time) t0) internal-time-units-per-second)))

;; ----------------------------------------------------------------------------
;; Query wrappers
;; ----------------------------------------------------------------------------
(defun query-a (sql &rest params)
  \"SELECT 0..N → (values rows-alist count), format :alists.\"
  (ensure-connection
    (let ((t0 (get-internal-real-time)))
      (handler-case
          (let* ((fn   (get-prepared-plan sql :format :alists))
                 (rows (apply fn params)))
            (record-query-latency sql (%elapsed-ms t0) (length rows))
            (values rows (length rows)))
        (condition (c) (translate-db-error c))))))

(defun query-1a (sql &rest params)
  \"SELECT 0/1 → alist | NIL, format :alist.\"
  (ensure-connection
    (handler-case
        (let* ((fn  (get-prepared-plan sql :format :alist))
               (row (apply fn params)))
          row)
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE.
DML → (values affected returning?).
- sans RETURNING → :raw → entier affecté
- avec RETURNING  → :alist → première ligne\"
  (ensure-connection
    (handler-case
        (let* ((lower (string-downcase sql))
               (has-returning (search \"returning\" lower)))
          (if has-returning
              (let* ((fn  (get-prepared-plan sql :format :alist))
                     (row (apply fn params)))
                (values (if row 1 0) row))
              (let* ((fn       (get-prepared-plan sql :format :raw))
                     (affected (or (apply fn params) 0)))
                (values affected nil))))
      (condition (c) (translate-db-error c)))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 461 (fontified t) 461 468 (face font-lock-builtin-face fontified t) 468 469 (fontified t) 469 476 (face font-lock-builtin-face fontified t) 476 477 (fontified t) 477 483 (face font-lock-builtin-face fontified t) 483 484 (fontified t) 484 492 (face font-lock-builtin-face fontified t) 492 504 (fontified t) 504 512 (face font-lock-builtin-face fontified t) 512 513 (fontified t) 513 522 (face font-lock-builtin-face fontified t) 522 523 (fontified t) 523 528 (face font-lock-builtin-face fontified t) 528 540 (fontified t) 540 550 (face font-lock-builtin-face fontified t) 550 551 (fontified t) 551 569 (face font-lock-builtin-face fontified t) 569 581 (fontified t) 581 599 (face font-lock-builtin-face fontified t) 599 604 (fontified t) 604 614 (face font-lock-keyword-face fontified t) 614 615 (fontified t) 615 629 (face font-lock-builtin-face fontified t) 629 632 (fontified t) 632 635 (face font-lock-comment-delimiter-face fontified t) 635 712 (face font-lock-comment-face fontified t) 712 715 (face font-lock-comment-delimiter-face fontified t) 715 721 (face font-lock-comment-face fontified t) 721 724 (face font-lock-comment-delimiter-face fontified t) 724 801 (face font-lock-comment-face fontified t) 801 802 (fontified t) 802 808 (face font-lock-keyword-face fontified t) 808 809 (fontified t) 809 818 (face font-lock-variable-name-face fontified t) 818 825 (fontified t) 825 831 (face font-lock-keyword-face fontified t) 831 832 (fontified t) 832 848 (face font-lock-variable-name-face fontified t) 848 854 (fontified t) 854 857 (face font-lock-comment-delimiter-face fontified t) 857 894 (face font-lock-comment-face fontified t) 894 895 (fontified t) 895 901 (face font-lock-keyword-face fontified t) 901 902 (fontified t) 902 919 (face font-lock-variable-name-face fontified t) 919 920 (fontified t) 920 929 (face font-lock-builtin-face fontified t) 929 932 (fontified t) 932 935 (face font-lock-comment-delimiter-face fontified t) 935 1012 (face font-lock-comment-face fontified t) 1012 1015 (face font-lock-comment-delimiter-face fontified t) 1015 1028 (face font-lock-comment-face fontified t) 1028 1031 (face font-lock-comment-delimiter-face fontified t) 1031 1108 (face font-lock-comment-face fontified t) 1108 1109 (fontified t) 1109 1114 (face font-lock-keyword-face fontified t) 1114 1115 (fontified t) 1115 1121 (face font-lock-function-name-face fontified t) 1121 1123 (fontified t) 1123 1127 (face font-lock-type-face fontified t) 1127 1152 (fontified t) 1152 1384 (face font-lock-doc-face fontified t) 1384 1460 (fontified t) 1460 1476 (face font-lock-builtin-face fontified t) 1476 1478 (fontified t) 1478 1487 (face font-lock-builtin-face fontified t) 1487 1493 (fontified t) 1493 1498 (face font-lock-keyword-face fontified t) 1498 1500 (fontified t) 1500 1517 (fontified t) 1517 9676 (fontified nil)) . 1) (t 26802 54107 0 0)) nil (26803 28615 29937 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8445 . 8446) (nil fontified nil 8428 . 8446) (8428 . 8446)) nil (26803 28615 29936 0) 0 nil])
([nil nil ((8446 . 8447)) nil (26803 28615 29934 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8560 . 8561) (nil fontified nil 8543 . 8561) (8543 . 8561)) nil (26803 28615 29934 0) 0 nil])
([nil nil ((8561 . 8562)) nil (26803 28615 29933 0) 0 nil])
([nil nil ((#("prepare" 0 6 (fontified t) 6 7 (rear-nonsticky t fontified t)) . -8554) (undo-tree-id30 . -7) (undo-tree-id31 . -3) (undo-tree-id32 . -3) (undo-tree-id33 . -3) (undo-tree-id34 . -3) (undo-tree-id35 . -3) (undo-tree-id36 . -3) (undo-tree-id37 . -7) (undo-tree-id38 . -7) (undo-tree-id39 . -7) (undo-tree-id40 . -7) 8561) nil (26803 28615 29932 0) 0 nil])
([nil nil ((8554 . 8557)) nil (26803 28615 29926 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -8556) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) 8557) nil (26803 28615 29925 0) 0 nil])
([nil nil ((8556 . 8558)) nil (26803 28615 29995 0) 0 nil])
([nil nil ((8558 . 8561)) nil (26803 28654 291365 0) 0 nil] [nil nil ((8543 . 8579) (#("lumen.data.metr" 0 15 (fontified t)) . -8543) (undo-tree-id0 . -15) (undo-tree-id1 . -11) (undo-tree-id2 . -11) (undo-tree-id3 . -11) (undo-tree-id4 . -11) (undo-tree-id5 . -11) (undo-tree-id6 . -11) (undo-tree-id7 . -11) (undo-tree-id8 . -11) (undo-tree-id9 . -11) (undo-tree-id10 . -11) (undo-tree-id11 . -11) (undo-tree-id12 . -11) (undo-tree-id13 . -11) (undo-tree-id14 . -11) (undo-tree-id15 . -11) (undo-tree-id16 . -11) (undo-tree-id17 . -12) (undo-tree-id18 . -12) (undo-tree-id19 . -13) (undo-tree-id20 . -13) (undo-tree-id21 . -13) (undo-tree-id22 . -13) (undo-tree-id23 . -14) (undo-tree-id24 . -14) (undo-tree-id25 . -15) (undo-tree-id26 . -15) 8558) ((8543 . 8558) (#("lumen.data.metrics:record-pool-stats" 0 36 (fontified t)) . 8543) (undo-tree-id41 . -36)) (26803 28615 29919 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8869 . 8870) (nil fontified nil 8852 . 8870) (8852 . 8870)) nil (26803 28654 291365 0) 0 nil])
nil
([nil nil ((8870 . 8871)) nil (26803 28654 291364 0) 0 nil])
([nil nil ((8710 . 8712)) nil (26803 28654 291364 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9938 . 9939) (nil fontified nil 8712 . 9939) (8712 . 9939)) nil (26803 28654 291363 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -9938) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) 9939) nil (26803 28654 585332 0) 0 nil])
([nil nil ((#("get-prepared-plan" 0 17 (fontified t)) . -9301) (undo-tree-id60 . -17) 9318) nil (26803 30583 682064 0) 0 nil] [nil nil ((nil rear-nonsticky nil 10527 . 10528) (nil fontified nil 9301 . 10528) (9301 . 10528)) ((#("(defun query-a (sql &rest params)
  \"Execute a SELECT-like statement, return (values rows-alist count).
Options en fin de params (keywords) :
  :timeout-ms <int>  — timeout Postgres via SET LOCAL statement_timeout (ms).\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (format *error-output*
                      \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                      elapsed-ms sql (if (endp args) nil args)))
            (values rows (length rows))))
      (condition (c)
        (translate-db-error c)))))
" 0 1 (fontified nil) 1 6 (face font-lock-keyword-face fontified nil) 6 7 (fontified nil) 7 14 (face font-lock-function-name-face fontified nil) 14 20 (fontified nil) 20 25 (face font-lock-type-face fontified nil) 25 36 (fontified nil) 36 220 (face font-lock-doc-face fontified nil) 220 224 (fontified nil) 224 228 (face font-lock-keyword-face fontified nil) 228 285 (fontified nil) 285 287 (face font-lock-keyword-face fontified nil) 287 341 (fontified nil) 341 343 (face font-lock-keyword-face fontified nil) 343 408 (fontified nil) 408 419 (face font-lock-builtin-face fontified nil) 419 507 (fontified nil) 507 519 (face font-lock-keyword-face fontified nil) 519 529 (fontified nil) 529 551 (face font-lock-keyword-face fontified nil) 551 576 (fontified nil) 576 580 (face font-lock-keyword-face fontified nil) 580 611 (fontified nil) 611 618 (face font-lock-builtin-face fontified nil) 618 619 (fontified nil) 619 626 (face font-lock-builtin-face fontified nil) 626 900 (fontified nil) 900 904 (face font-lock-keyword-face fontified nil) 904 1018 (fontified nil) 1018 1063 (face font-lock-string-face fontified nil) 1063 1102 (fontified nil) 1102 1104 (face font-lock-keyword-face fontified nil) 1104 1192 (fontified nil) 1192 1226 (fontified nil) 1226 1227 (rear-nonsticky nil fontified nil)) . 9301) (undo-tree-id46 . -269) (undo-tree-id47 . -1227) (undo-tree-id48 . -1227) (undo-tree-id49 . -1227) (nil fontified t 10405 . 10493) (nil fontified t 10403 . 10405) (nil fontified t 10364 . 10403) (nil fontified t 10319 . 10364) (nil fontified t 10205 . 10319) (nil fontified t 10201 . 10205) (nil fontified t 9927 . 10201) (nil fontified t 9920 . 9927) (nil fontified t 9919 . 9920) (nil fontified t 9912 . 9919) (nil fontified t 9881 . 9912) (nil fontified t 9877 . 9881) (nil fontified t 9852 . 9877) (nil fontified t 9830 . 9852) (nil fontified t 9820 . 9830) (nil fontified t 9808 . 9820) (nil fontified t 9720 . 9808) (nil fontified t 9709 . 9720) (nil fontified t 9644 . 9709) (nil fontified t 9642 . 9644) (nil fontified t 9588 . 9642) (nil fontified t 9586 . 9588) (nil fontified t 9529 . 9586) (nil fontified t 9525 . 9529) (nil fontified t 9521 . 9525) (nil fontified t 9337 . 9521) (nil fontified t 9326 . 9337) (nil fontified t 9321 . 9326) (nil fontified t 9315 . 9321) (nil fontified t 9308 . 9315) (nil fontified t 9307 . 9308) (nil fontified t 9302 . 9307) (nil fontified t 9301 . 9302) (nil rear-nonsticky t 10527 . 10528)) (26803 28654 291399 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9336 . 9337) (nil fontified nil 9320 . 9337) (nil fontified nil 9319 . 9320) (nil fontified nil 9318 . 9319) (nil fontified nil 9301 . 9318) (9301 . 9337)) nil (26803 30583 682063 0) 0 nil])
([nil nil ((10528 . 10529)) ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . 10528) (undo-tree-id45 . -1)) (26803 28654 291347 0) 0 nil])
([nil nil ((#("record-query-latency" 0 20 (fontified t)) . -9567) (undo-tree-id59 . -20) 9587) nil (26803 30583 682062 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 9605 . 9606) (nil fontified nil 9586 . 9606) (nil fontified nil 9585 . 9586) (nil fontified nil 9567 . 9585) (9567 . 9606)) nil (26803 30583 682061 0) 0 nil])
([nil nil ((#("
(defun query-a (sql &rest params)
  \"SELECT 0..N → (values rows-alist count), format :alists.\"
  (ensure-connection
    (let ((t0 (get-internal-real-time)))
      (handler-case
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn params)))
            (lumen.data.metrics:record-query-latency sql (%elapsed-ms t0) (length rows))
            (values rows (length rows)))
        (condition (c) (translate-db-error c))))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 15 (face font-lock-function-name-face fontified t) 15 21 (fontified t) 21 26 (face font-lock-type-face fontified t) 26 37 (fontified t) 37 95 (face font-lock-doc-face fontified t) 95 122 (fontified t) 122 125 (face font-lock-keyword-face fontified t) 125 165 (fontified t) 165 177 (face font-lock-keyword-face fontified t) 177 178 (fontified t) 178 189 (fontified t) 189 193 (face font-lock-keyword-face fontified t) 193 202 (fontified t) 202 219 (fontified t) 219 220 (rear-nonsticky t fontified t) 220 221 (fontified t) 221 243 (fontified t) 243 250 (face font-lock-builtin-face fontified t) 250 251 (fontified t) 251 258 (face font-lock-builtin-face fontified t) 258 261 (fontified t) 261 304 (fontified t) 304 317 (fontified t) 317 335 (fontified t) 335 336 (fontified t) 336 393 (fontified t) 393 434 (fontified t) 434 484 (fontified t)) . 8226) (undo-tree-id57 . -484) (undo-tree-id58 . -317)) nil (26803 30583 682060 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 8226)) nil (26803 30583 682059 0) 0 nil])
([nil nil ((#("
(defun query-1a (sql &rest params)
  \"SELECT 0/1 → alist | NIL, format :alist.\"
  (ensure-connection
    (handler-case
        (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
               (row (apply fn params)))
          row)
      (condition (c) (translate-db-error c)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 22 (fontified t) 22 27 (face font-lock-type-face fontified t) 27 38 (fontified t) 38 80 (face font-lock-doc-face fontified t) 80 107 (fontified t) 107 119 (face font-lock-keyword-face fontified t) 119 120 (fontified t) 120 129 (fontified t) 129 133 (face font-lock-keyword-face fontified t) 133 141 (fontified t) 141 158 (fontified t) 158 159 (fontified t rear-nonsticky t) 159 160 (fontified t) 160 182 (fontified t) 182 189 (face font-lock-builtin-face fontified t) 189 190 (fontified t) 190 196 (face font-lock-builtin-face fontified t) 196 199 (fontified t) 199 235 (fontified t) 235 239 (fontified t) 239 301 (fontified t)) . 9492) (undo-tree-id56 . -301)) nil (26803 30583 682058 0) 0 nil])
([nil nil ((9492 . 9493)) nil (26803 30583 682057 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10593 . 10594) (nil fontified nil 9493 . 10594) (9493 . 10594)) nil (26803 30583 682057 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -10593) (undo-tree-id55 . -1) 10594) nil (26803 30583 682056 0) 0 nil])
([nil nil ((11322 . 11324)) nil (26803 30583 682055 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12963 . 12964) (nil fontified nil 11324 . 12964) (11324 . 12964)) nil (26803 30583 682055 0) 0 nil])
([nil nil ((#("(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE.
DML → (values affected returning?).
- sans RETURNING → :raw → entier affecté
- avec RETURNING  → :alist → première ligne\"
  (ensure-connection
    (handler-case
        (let* ((lower (string-downcase sql))
               (has-returning (search \"returning\" lower)))
          (if has-returning
              (let* ((fn  (get-prepared-plan sql :format :alist))
                     (row (apply fn params)))
                (values (if row 1 0) row))
              (let* ((fn       (get-prepared-plan sql :format :raw))
                     (affected (or (apply fn params) 0)))
                (values affected nil))))
      (condition (c) (translate-db-error c)))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 11 (face font-lock-function-name-face fontified t) 11 17 (fontified t) 17 22 (face font-lock-type-face fontified t) 22 33 (fontified t) 33 185 (face font-lock-doc-face fontified t) 185 212 (fontified t) 212 224 (face font-lock-keyword-face fontified t) 224 234 (fontified t) 234 238 (face font-lock-keyword-face fontified t) 238 308 (fontified t) 308 319 (face font-lock-string-face fontified t) 319 340 (fontified t) 340 342 (face font-lock-keyword-face fontified t) 342 372 (fontified t) 372 376 (face font-lock-keyword-face fontified t) 376 406 (fontified t) 406 413 (face font-lock-builtin-face fontified t) 413 414 (fontified t) 414 420 (face font-lock-builtin-face fontified t) 420 494 (fontified t) 494 496 (face font-lock-keyword-face fontified t) 496 527 (fontified t) 527 531 (face font-lock-keyword-face fontified t) 531 566 (fontified t) 566 573 (face font-lock-builtin-face fontified t) 573 574 (fontified t) 574 578 (face font-lock-builtin-face fontified t) 578 599 (fontified t) 599 639 (fontified t) 639 672 (fontified t) 672 680 (fontified t) 680 728 (fontified t)) . -10595) (undo-tree-id54 . -728) 11323) nil (26803 30583 682054 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 10595)) nil (26803 30583 682053 0) 0 nil])
([nil nil ((454 . 455)) nil (26803 30583 682052 0) 0 nil])
([nil nil ((nil fontified nil 472 . 473) (nil fontified nil 455 . 472) (455 . 473)) nil (26803 30583 682052 0) 0 nil])
([nil nil ((#("(format *error-output*
                      \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                      elapsed-ms sql (if (endp args) nil args))" 0 45 (fontified t) 45 90 (face font-lock-string-face fontified t) 90 129 (fontified t) 129 131 (face font-lock-keyword-face fontified t) 131 154 (fontified t)) . -9257) (undo-tree-id53 . -154) 9411) nil (26803 30583 682051 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9346 . 9347) (nil fontified nil 9257 . 9347) (9257 . 9347)) nil (26803 30583 682050 0) 0 nil])
([nil nil ((9295 . 9303) (#("    " 0 4 (fontified t)) . 9295) 8246) nil (26803 30583 682050 0) 0 nil])
([nil nil ((#("(format *error-output*
                      \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                      elapsed-ms sql (if (endp args) nil args))" 0 45 (fontified t) 45 90 (face font-lock-string-face fontified t) 90 129 (fontified t) 129 131 (face font-lock-keyword-face fontified t) 131 154 (fontified t)) . -10323) (undo-tree-id51 . -91) (undo-tree-id52 . -154) 10477) nil (26803 30583 682049 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10411 . 10412) (nil fontified nil 10323 . 10412) (10323 . 10412)) nil (26803 30583 682046 0) 0 nil])
([nil nil ((10361 . 10369) (#("    " 0 4 (fontified t)) . 10361) 9452) nil (26803 30583 682045 0) 0 nil])
([nil nil ((#("(format *error-output*
                        \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                        elapsed-ms sql (if (endp args) nil args))" 0 22 (fontified t) 22 23 (fontified t) 23 38 (fontified t) 38 47 (fontified t) 47 92 (face font-lock-string-face fontified t) 92 93 (fontified t) 93 113 (fontified t) 113 133 (fontified t) 133 135 (face font-lock-keyword-face fontified t) 135 144 (fontified t) 144 158 (fontified t)) . -11880) (undo-tree-id50 . -158) 12038) nil (26803 30583 682044 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11968 . 11969) (nil fontified nil 11880 . 11969) (11880 . 11969)) nil (26803 30583 682035 0) 0 nil])
([nil nil ((11918 . 11921) (#("    " 0 4 (fontified t)) . 11918) 10493) nil (26803 30583 682032 0) 0 nil])
([nil nil ((7129 . 7130) (t 26803 30583 0 0)) nil (26803 38323 455220 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7637 . 7638) (nil fontified nil 7627 . 7638) (nil fontified nil 7622 . 7627) (nil fontified nil 7612 . 7622) (nil fontified nil 7575 . 7612) (nil fontified nil 7541 . 7575) (nil fontified nil 7487 . 7541) (nil fontified nil 7431 . 7487) (nil fontified nil 7428 . 7431) (nil fontified nil 7413 . 7428) (nil fontified nil 7386 . 7413) (nil fontified nil 7355 . 7386) (nil fontified nil 7353 . 7355) (nil fontified nil 7347 . 7353) (nil fontified nil 7324 . 7347) (nil fontified nil 7183 . 7324) (nil fontified nil 7174 . 7183) (nil fontified nil 7169 . 7174) (nil fontified nil 7162 . 7169) (nil fontified nil 7140 . 7162) (nil fontified nil 7139 . 7140) (nil fontified nil 7131 . 7139) (nil fontified nil 7130 . 7131) (7130 . 7638)) nil (26803 38323 455218 0) 0 nil])
([nil nil ((619 . 620)) nil (26803 38323 455216 0) 0 nil])
([nil nil ((620 . 621)) nil (26803 38323 455215 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 642 . 643) (nil fontified nil 621 . 643) (621 . 643)) nil (26803 38323 455211 0) 0 nil])
([nil nil ((974 . 976) (t 26803 38323 0 0)) nil (26803 38584 687119 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1197 . 1198) (nil fontified nil 976 . 1198) (976 . 1198)) nil (26803 38584 687115 0) 0 nil])
([nil nil ((642 . 643) (t 26803 38584 0 0)) nil (26803 38614 166247 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -642) (undo-tree-id2 . -1) 643) nil (26803 38614 166246 0) 0 nil])
([nil nil ((643 . 644)) nil (26803 38614 166244 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 673 . 674) (nil fontified nil 644 . 674) (644 . 674)) nil (26803 38614 166244 0) 0 nil])
([nil nil ((644 . 645)) nil (26803 38614 166243 0) 0 nil])
([nil nil ((644 . 648) (#(" " 0 1 (fontified nil)) . 643) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (644 . 645)) nil (26803 38614 166242 0) 0 nil])
([nil nil ((679 . 680)) nil (26803 38614 166226 0) 0 nil])
([nil nil ((680 . 681)) nil (26803 38614 166225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 695 . 696) (nil fontified nil 681 . 696) (681 . 696)) nil (26803 38614 166221 0) 0 nil])
([nil nil ((2264 . 2271) (t 26803 38614 0 0)) nil (26803 39185 937470 0) 0 nil])
([nil nil ((2271 . 2277)) nil (26803 39185 937469 0) 0 nil])
([nil nil ((2277 . 2278)) nil (26803 39185 937468 0) 0 nil])
([nil nil ((2278 . 2281)) nil (26803 39185 937468 0) 0 nil])
([nil nil ((2281 . 2282)) nil (26803 39185 937466 0) 0 nil])
([nil nil ((2282 . 2290)) nil (26803 39185 937463 0) 0 nil])
([nil nil ((1705 . 1708) (t 26803 39185 0 0)) nil (26803 39277 425307 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1726 . 1727) (nil fontified nil 1726 . 1727) (nil fontified nil 1715 . 1726) (nil fontified nil 1708 . 1715) (1708 . 1727)) nil (26803 39277 425307 0) 0 nil])
([nil nil ((2310 . 2311)) nil (26803 39277 425306 0) 0 nil])
([nil nil ((2311 . 2312)) nil (26803 39277 425305 0) 0 nil])
([nil nil ((2247 . 2255)) nil (26803 39277 425305 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2273 . 2274) (nil fontified nil 2273 . 2274) (nil fontified nil 2262 . 2273) (nil fontified nil 2255 . 2262) (2255 . 2274)) nil (26803 39277 425304 0) 0 nil])
([nil nil ((2272 . 2273)) nil (26803 39277 425303 0) 0 nil])
([nil nil ((2273 . 2274)) nil (26803 39277 425303 0) 0 nil])
([nil nil ((2276 . 2284)) nil (26803 39277 425302 0) 0 nil])
([nil nil ((2284 . 2290)) nil (26803 39277 425302 0) 0 nil])
([nil nil ((2290 . 2291)) nil (26803 39277 425301 0) 0 nil])
([nil nil ((2291 . 2294)) nil (26803 39277 425301 0) 0 nil])
([nil nil ((2294 . 2302)) nil (26803 39277 425300 0) 0 nil])
([nil nil ((2302 . 2308)) nil (26803 39277 425300 0) 0 nil])
([nil nil ((2308 . 2309)) nil (26803 39277 425299 0) 0 nil])
([nil nil ((2309 . 2314)) nil (26803 39277 425295 0) 0 nil])
([nil nil ((1905 . 1906) (t 26803 39277 0 0)) nil (26803 39379 208379 0) 0 nil])
([nil nil ((1906 . 1907)) nil (26803 39379 208378 0) 0 nil])
([nil nil ((1907 . 1913)) nil (26803 39379 208377 0) 0 nil])
([nil nil ((1913 . 1914)) nil (26803 39379 208377 0) 0 nil])
([nil nil ((1914 . 1925)) nil (26803 39379 208376 0) 0 nil])
([nil nil ((1904 . 1905)) nil (26803 39379 208375 0) 0 nil])
([nil nil ((1926 . 1932)) nil (26803 39379 208371 0) 0 nil])
([nil nil ((1832 . 1835) (t 26803 39379 0 0)) nil (26803 39417 937687 0) 0 nil])
([nil nil ((1835 . 1840)) nil (26803 39417 937686 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -1839) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 1840) nil (26803 39417 937686 0) 0 nil])
([nil nil ((1839 . 1841)) nil (26803 39417 937683 0) 0 nil])
([nil nil ((1841 . 1842)) nil (26803 39417 937683 0) 0 nil])
([nil nil ((1842 . 1846)) nil (26803 39417 937682 0) 0 nil])
([nil nil ((1842 . 1858) (#("*cur" 0 4 (fontified t)) . -1842) (undo-tree-id3 . -4) (undo-tree-id4 . -2) (undo-tree-id5 . -2) (undo-tree-id6 . -3) (undo-tree-id7 . -3) (undo-tree-id8 . -4) (undo-tree-id9 . -4) (undo-tree-id10 . -4) (undo-tree-id11 . -4) (undo-tree-id12 . -4) (undo-tree-id13 . -4) 1846) nil (26803 39417 937680 0) 0 nil])
([nil nil ((1858 . 1859)) nil (26803 39417 937656 0) 0 nil])
([nil nil ((1859 . 1862) (t 26803 39417 0 0)) nil (26803 39488 354035 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1885 . 1886) (nil fontified nil 1869 . 1886) (nil fontified nil 1862 . 1869) (1862 . 1886)) nil (26803 39488 354034 0) 0 nil])
([nil nil ((#("*current-config*" 0 16 (fontified t)) . -1869) (undo-tree-id17 . -16) (undo-tree-id18 . -8) (undo-tree-id19 . -8) (undo-tree-id20 . -8) (undo-tree-id21 . -8) (undo-tree-id22 . -8) (undo-tree-id23 . -16) (undo-tree-id24 . -16) (undo-tree-id25 . -16) (undo-tree-id26 . -16) 1885) nil (26803 39488 354032 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1885 . 1886) (nil fontified nil 1869 . 1886) (1869 . 1886)) nil (26803 39488 354014 0) 0 nil])
([nil nil ((1935 . 1937) (t 26803 39488 0 0)) nil (26803 39762 311032 0) 0 nil])
([nil nil ((2848 . 2850)) nil (26803 39762 311031 0) 0 nil])
([nil nil ((2868 . 2870)) nil (26803 39762 311027 0) 0 nil])
([nil nil ((2842 . 2843) (t 26803 39762 0 0)) nil (26803 39816 140790 0) 0 nil])
([nil nil ((2890 . 2891) (t 26803 39816 0 0)) nil (26803 39823 436726 0) 0 nil])
([nil nil ((2842 . 2848)) nil (26803 39823 436722 0) 0 nil])
([nil nil ((#("(x (print \"BSBBSBS\"))
	    " 0 10 (fontified t) 10 19 (face font-lock-string-face fontified t) 19 27 (fontified t)) . -1962) (undo-tree-id31 . -27) 1989 (t 26803 39823 0 0)) nil (26803 39881 874252 0) 0 nil])
([nil nil ((#("
       (print \"IN START! 0\")" 0 1 (fontified t) 1 8 (fontified t) 8 15 (fontified t) 15 16 (face font-lock-string-face fontified t) 16 27 (face font-lock-string-face fontified t) 27 28 (face font-lock-string-face fontified t) 28 29 (fontified t rear-nonsticky t)) . 2304) (undo-tree-id30 . -29)) nil (26803 39881 874251 0) 0 nil])
([nil nil ((#("
	     (print \"IN START! 1\")" 0 1 (fontified t) 1 14 (fontified t) 14 15 (face font-lock-string-face fontified t) 15 26 (face font-lock-string-face fontified t) 26 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 2381) (undo-tree-id29 . -28)) nil (26803 39881 874249 0) 0 nil])
([nil nil ((#("
  (print *current-config*)
  (print *connection-mode*)" 0 1 (fontified t) 1 10 (fontified t) 10 28 (fontified t) 28 30 (fontified t) 30 37 (fontified t) 37 53 (fontified t) 53 54 (rear-nonsticky t fontified t) 54 55 (rear-nonsticky t fontified t)) . 1832) (undo-tree-id28 . -55)) nil (26803 39881 874247 0) 0 nil])
([nil nil ((#("
  (print \"IN START!\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 21 (face font-lock-string-face fontified t) 21 22 (rear-nonsticky t fontified t)) . 1705) (undo-tree-id27 . -22)) nil (26803 39881 874243 0) 0 nil])
([nil nil ((6746 . 6750) (t 26803 39881 0 0)) nil (26803 41445 696713 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -1858) (undo-tree-id77 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -1859) (undo-tree-id78 . -1) 1860 (t 26803 41445 0 0)) nil (26803 42151 196747 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -2692) (undo-tree-id75 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -2693) (undo-tree-id76 . -1) 2694) nil (26803 42151 196745 0) 0 nil])
([nil nil ((#(";" 0 1 (face slime-reader-conditional-face fontified t)) . -2710) (undo-tree-id73 . -1) (#(";" 0 1 (face slime-reader-conditional-face fontified t)) . -2711) (undo-tree-id74 . -1) 2712) nil (26803 42151 196743 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -2685) (undo-tree-id72 . -1) 2686) nil (26803 42151 196742 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 2679) (#("
" 0 1 (fontified t)) . 2679)) nil (26803 42151 196740 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 2679)) nil (26803 42151 196739 0) 0 nil])
([nil nil ((2683 . 2685) (2679 . 2680)) nil (26803 42151 196739 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 2679)) nil (26803 42151 196738 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -2727) (undo-tree-id71 . -1) 2728) nil (26803 42151 196738 0) 0 nil])
([nil nil ((#("     " 0 5 (fontified t)) . -2679) (undo-tree-id70 . -5) 2684) nil (26803 42151 196736 0) 0 nil])
([nil nil ((728 . 729)) nil (26803 42151 196735 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1361 . 1362) (nil fontified nil 729 . 1362) (729 . 1362)) nil (26803 42151 196735 0) 0 nil])
([nil nil ((1362 . 1363)) nil (26803 42151 196734 0) 0 nil])
([nil nil ((6061 . 6063)) nil (26803 42151 196734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9598 . 9599) (nil fontified nil 6063 . 9599) (6063 . 9599)) nil (26803 42151 196733 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -9598) (undo-tree-id69 . -1) 9599) nil (26803 42151 196732 0) 0 nil])
([nil nil ((9598 . 9599)) nil (26803 42151 196731 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9598) (undo-tree-id68 . -1) 9599) nil (26803 42151 196730 0) 0 nil])
([nil nil ((#("(defmacro with-conn (&body body)
  \"Ouvre une connexion selon *connection-mode* avec les bons paramètres Postmodern.\"
  #+postmodern
  `(ecase *connection-mode*
     (:toplevel
      (progn ,@body))
     (:scoped
      (let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
          ,@body)))
     (:pooled-native
      (let ((deadline (+ (get-internal-real-time)
                    (* cl:internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
       (start (get-internal-real-time)))
   (labels ((acquire-slot ()
              (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                  (if (< (get-internal-real-time) deadline)
                      (acquire-slot)
                      (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
     (acquire-slot)
     (let* ((wait-ms (* 1000.0 (/ (- (get-internal-real-time) start)
                                  cl:internal-time-units-per-second))))
       ;; enregistre métrique (nb slots utilisés = *pool-size* - count du sema)
       (let ((in-use (- *pool-size* (bt:semaphore-count *pool-sema*))))
         (lumen.data.metrics:record-pool-stats in-use wait-ms)))
     (unwind-protect
          (let* ((cfg *current-config*)
                 (db   (getf cfg :database))
                 (user (getf cfg :user))
                 (pass (getf cfg :password))
                 (host (or (getf cfg :host) \"localhost\"))
                 (port (or (getf cfg :port) 5432))
                 (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
            (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl)
              ,@body))
       (bt:signal-semaphore *pool-sema*))))))
  #-postmodern
  `(progn ,@body))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 13 (face font-lock-function-name-face fontified t) 13 19 (face font-lock-function-name-face fontified t) 19 21 (fontified t) 21 26 (face font-lock-type-face fontified t) 26 33 (fontified t) 33 35 (fontified t) 35 36 (face font-lock-doc-face fontified t) 36 39 (face font-lock-doc-face fontified t) 39 44 (face font-lock-doc-face fontified t) 44 48 (face font-lock-doc-face fontified t) 48 116 (face font-lock-doc-face fontified t) 116 117 (face font-lock-doc-face fontified t) 117 118 (fontified t) 118 120 (fontified t) 120 125 (fontified t) 125 137 (fontified t) 137 142 (face font-lock-keyword-face fontified t) 142 167 (fontified t) 167 170 (face font-lock-builtin-face fontified t) 170 176 (face font-lock-builtin-face fontified t) 176 180 (fontified t) 180 184 (fontified t) 184 189 (face font-lock-keyword-face fontified t) 189 199 (fontified t) 199 205 (fontified t) 205 212 (face font-lock-builtin-face fontified t) 212 220 (fontified t) 220 224 (face font-lock-keyword-face fontified t) 224 278 (fontified t) 278 287 (face font-lock-builtin-face fontified t) 287 319 (fontified t) 319 324 (face font-lock-builtin-face fontified t) 324 356 (fontified t) 356 365 (face font-lock-builtin-face fontified t) 365 401 (fontified t) 401 406 (face font-lock-builtin-face fontified t) 406 408 (fontified t) 408 409 (face font-lock-string-face fontified t) 409 418 (face font-lock-string-face fontified t) 418 419 (face font-lock-string-face fontified t) 419 455 (fontified t) 455 460 (face font-lock-builtin-face fontified t) 460 490 (fontified t) 490 502 (fontified t) 502 519 (face font-lock-builtin-face fontified t) 519 521 (fontified t) 521 522 (face font-lock-string-face fontified t) 522 523 (face font-lock-string-face fontified t) 523 539 (fontified t) 539 541 (fontified t) 541 565 (fontified t) 565 577 (fontified t) 577 585 (face font-lock-builtin-face fontified t) 585 590 (fontified t) 590 597 (fontified t) 597 599 (fontified t) 599 625 (face font-lock-keyword-face fontified t) 625 692 (fontified t) 692 697 (face font-lock-builtin-face fontified t) 697 703 (fontified t) 703 711 (face font-lock-builtin-face fontified t) 711 762 (fontified t) 762 779 (face font-lock-builtin-face fontified t) 779 811 (fontified t) 811 825 (face font-lock-builtin-face fontified t) 825 833 (fontified t) 833 836 (face font-lock-keyword-face fontified t) 836 989 (fontified t) 989 996 (fontified t) 996 997 (fontified t) 997 1000 (fontified t) 1000 1001 (fontified t) 1001 1011 (fontified t) 1011 1015 (fontified t) 1015 1019 (face font-lock-keyword-face fontified t) 1019 1021 (face font-lock-keyword-face fontified t) 1021 1040 (fontified t) 1040 1044 (fontified t) 1044 1077 (fontified t) 1077 1092 (fontified t) 1092 1100 (face font-lock-builtin-face fontified t) 1100 1128 (fontified t) 1128 1147 (fontified t) 1147 1149 (face font-lock-keyword-face fontified t) 1149 1248 (fontified t) 1248 1253 (face font-lock-warning-face fontified t) 1253 1254 (fontified t) 1254 1255 (face font-lock-string-face fontified t) 1255 1283 (face font-lock-string-face fontified t) 1283 1284 (face font-lock-string-face fontified t) 1284 1331 (fontified t) 1331 1335 (face font-lock-keyword-face fontified t) 1335 1473 (fontified t) 1473 1476 (face font-lock-comment-delimiter-face fontified t) 1476 1533 (face font-lock-comment-face fontified t) 1533 1546 (face font-lock-comment-face fontified t) 1546 1554 (fontified t) 1554 1557 (face font-lock-keyword-face fontified t) 1557 1689 (fontified t) 1689 1703 (face font-lock-keyword-face fontified t) 1703 1715 (fontified t) 1715 1719 (face font-lock-keyword-face fontified t) 1719 1777 (fontified t) 1777 1786 (face font-lock-builtin-face fontified t) 1786 1822 (fontified t) 1822 1827 (face font-lock-builtin-face fontified t) 1827 1863 (fontified t) 1863 1872 (face font-lock-builtin-face fontified t) 1872 1912 (fontified t) 1912 1917 (face font-lock-builtin-face fontified t) 1917 1919 (fontified t) 1919 1920 (face font-lock-string-face fontified t) 1920 1929 (face font-lock-string-face fontified t) 1929 1930 (face font-lock-string-face fontified t) 1930 1970 (fontified t) 1970 1975 (face font-lock-builtin-face fontified t) 1975 2039 (fontified t) 2039 2047 (face font-lock-builtin-face fontified t) 2047 2065 (fontified t) 2065 2090 (face font-lock-keyword-face fontified t) 2090 2091 (face font-lock-keyword-face fontified t) 2091 2116 (fontified t) 2116 2121 (face font-lock-builtin-face fontified t) 2121 2127 (fontified t) 2127 2135 (face font-lock-builtin-face fontified t) 2135 2145 (fontified t) 2145 2213 (fontified t) 2213 2214 (fontified t) 2214 2216 (fontified t) 2216 2229 (face slime-reader-conditional-face fontified t) 2229 2233 (face slime-reader-conditional-face fontified t) 2233 2238 (face slime-reader-conditional-face fontified t) 2238 2246 (face slime-reader-conditional-face fontified t) 2246 2247 (fontified t)) . 3814) (undo-tree-id33 . -2247) (undo-tree-id34 . -290) (undo-tree-id35 . -1668) (undo-tree-id36 . -1668) (undo-tree-id37 . -1325) (undo-tree-id38 . -1223) (undo-tree-id39 . -2196) (undo-tree-id40 . -2247) (undo-tree-id41 . -2247) (undo-tree-id42 . -2247) (undo-tree-id43 . -1162) (undo-tree-id44 . -1162) (undo-tree-id45 . -1162) (undo-tree-id46 . -1162) (undo-tree-id47 . -1162) (undo-tree-id48 . -1162) (undo-tree-id49 . -1162) (undo-tree-id50 . -1162) (undo-tree-id51 . -1162) (undo-tree-id52 . -1162) (undo-tree-id53 . -1162) (undo-tree-id54 . -1162) (undo-tree-id55 . -1162) (undo-tree-id56 . -1074) (undo-tree-id57 . -1074) (undo-tree-id58 . -1039) (undo-tree-id59 . -1039) (undo-tree-id60 . -32) (undo-tree-id61 . -32) (undo-tree-id62 . -32) (undo-tree-id63 . -32) (undo-tree-id64 . -31) (undo-tree-id65 . -31) (undo-tree-id66 . -30) (undo-tree-id67 . -30)) nil (26803 42151 196727 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3814) (undo-tree-id32 . -1) (#("
" 0 1 (fontified t)) . 3814)) nil (26803 42151 196701 0) 0 nil])
([nil nil ((#("
       (print db)
       (print port)" 0 1 (fontified t) 1 4 (fontified t) 4 19 (fontified t) 19 38 (fontified t)) . 2860) (undo-tree-id79 . -38) (t 26803 42151 0 0)) nil (26803 42711 326168 0) 0 nil])
([nil nil ((9866 . 9868) (t 26803 42711 0 0)) nil (26803 43158 797594 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10541 . 10542) (nil fontified nil 9868 . 10542) (9868 . 10542)) nil (26803 43158 797593 0) 0 nil])
([nil nil ((9357 . 9358)) nil (26803 43158 797592 0) 0 nil])
([nil nil ((9358 . 9360)) nil (26803 43158 797592 0) 0 nil])
([nil nil ((9870 . 9872)) nil (26803 43158 797591 0) 0 nil])
([nil nil ((9872 . 9873)) nil (26803 43158 797587 0) 0 nil])
([nil nil ((15481 . 15483) (t 26803 43158 0 0)) nil (26804 17239 535587 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17290 . 17291) (nil fontified nil 15483 . 17291) (15483 . 17291)) nil (26804 17239 965783 0) 0 nil])
([nil nil ((#("
(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
Options :
  :timeout-ms <int>
Si le SQL a une clause RETURNING, renvoie la 1ère ligne en alist.\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                (let* ((fn       (get-prepared-plan sql :format :raw))
                       (n (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
		 sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      (condition (c)
        (translate-db-error c)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 34 (fontified t) 34 199 (face font-lock-doc-face fontified t) 199 203 (fontified t) 203 207 (face font-lock-keyword-face fontified t) 207 264 (fontified t) 264 266 (face font-lock-keyword-face fontified t) 266 320 (fontified t) 320 322 (face font-lock-keyword-face fontified t) 322 387 (fontified t) 387 398 (face font-lock-builtin-face fontified t) 398 486 (fontified t) 486 498 (face font-lock-keyword-face fontified t) 498 508 (fontified t) 508 530 (face font-lock-keyword-face fontified t) 530 555 (fontified t) 555 559 (face font-lock-keyword-face fontified t) 559 631 (fontified t) 631 642 (face font-lock-string-face fontified t) 642 695 (fontified t) 695 697 (face font-lock-keyword-face fontified t) 697 729 (fontified t) 729 733 (face font-lock-keyword-face fontified t) 733 763 (fontified t) 763 770 (face font-lock-builtin-face fontified t) 770 771 (fontified t) 771 777 (face font-lock-builtin-face fontified t) 777 860 (fontified t) 860 862 (face font-lock-keyword-face fontified t) 862 923 (fontified t) 923 927 (face font-lock-keyword-face fontified t) 927 962 (fontified t) 962 969 (face font-lock-builtin-face fontified t) 969 970 (fontified t) 970 974 (face font-lock-builtin-face fontified t) 974 1087 (fontified t) 1087 1090 (face font-lock-keyword-face fontified t) 1090 1245 (fontified t) 1245 1298 (fontified t) 1298 1313 (fontified t) 1313 1317 (face font-lock-keyword-face fontified t) 1317 1444 (fontified t) 1444 1451 (face font-lock-builtin-face fontified t) 1451 1457 (fontified t) 1457 1466 (face font-lock-builtin-face fontified t) 1466 1500 (fontified t) 1500 1512 (fontified t) 1512 1515 (fontified t) 1515 1536 (fontified t) 1536 1570 (fontified t) 1570 1571 (fontified t)) . 13911) (undo-tree-id113 . -1571) (undo-tree-id114 . -814) (undo-tree-id115 . -814)) nil (26804 17666 979222 0) 0 nil] [nil nil ((#("
(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
Options :
  :timeout-ms <int>
Si le SQL a une clause RETURNING, renvoie la 1ère ligne en alist.\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                (let* ((fn       (get-prepared-plan sql :format :raw))
                       (n (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
		 sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      (condition (c)
        (translate-db-error c)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 34 (fontified t) 34 199 (face font-lock-doc-face fontified t) 199 203 (fontified t) 203 207 (face font-lock-keyword-face fontified t) 207 264 (fontified t) 264 266 (face font-lock-keyword-face fontified t) 266 320 (fontified t) 320 322 (face font-lock-keyword-face fontified t) 322 387 (fontified t) 387 398 (face font-lock-builtin-face fontified t) 398 486 (fontified t) 486 498 (face font-lock-keyword-face fontified t) 498 508 (fontified t) 508 530 (face font-lock-keyword-face fontified t) 530 555 (fontified t) 555 559 (face font-lock-keyword-face fontified t) 559 631 (fontified t) 631 642 (face font-lock-string-face fontified t) 642 695 (fontified t) 695 697 (face font-lock-keyword-face fontified t) 697 729 (fontified t) 729 733 (face font-lock-keyword-face fontified t) 733 763 (fontified t) 763 770 (face font-lock-builtin-face fontified t) 770 771 (fontified t) 771 777 (face font-lock-builtin-face fontified t) 777 860 (fontified t) 860 862 (face font-lock-keyword-face fontified t) 862 923 (fontified t) 923 927 (face font-lock-keyword-face fontified t) 927 962 (fontified t) 962 969 (face font-lock-builtin-face fontified t) 969 970 (fontified t) 970 974 (face font-lock-builtin-face fontified t) 974 1087 (fontified t) 1087 1090 (face font-lock-keyword-face fontified t) 1090 1245 (fontified t) 1245 1298 (fontified t) 1298 1313 (fontified t) 1313 1317 (face font-lock-keyword-face fontified t) 1317 1444 (fontified t) 1444 1451 (face font-lock-builtin-face fontified t) 1451 1457 (fontified t) 1457 1466 (face font-lock-builtin-face fontified t) 1466 1512 (fontified t) 1512 1515 (fontified t) 1515 1536 (fontified t) 1536 1570 (fontified t)) . 13911) (undo-tree-id85 . -1570) (undo-tree-id86 . -814) (undo-tree-id87 . -814) (undo-tree-id88 . -814) (undo-tree-id89 . -814) (undo-tree-id90 . -814) (undo-tree-id91 . -814) (undo-tree-id92 . -814) (undo-tree-id93 . -814) (undo-tree-id94 . -814) (undo-tree-id95 . -1570) (undo-tree-id96 . -1570) (undo-tree-id97 . -1570) (undo-tree-id98 . -1570) (undo-tree-id99 . -1570) (undo-tree-id100 . -1) (undo-tree-id101 . -1536) (undo-tree-id102 . -1) (undo-tree-id103 . -1570) (undo-tree-id104 . -1570) (undo-tree-id105 . -1570) (undo-tree-id106 . -1570) (undo-tree-id107 . -31) (undo-tree-id108 . -31) (undo-tree-id109 . -31) (undo-tree-id110 . -31) (undo-tree-id111 . -31) (undo-tree-id112 . -31)) ((13911 . 15481)) (26804 17239 535639 0) 0 nil])
([nil nil ((12993 . 12996) (t 26804 17666 0 0)) nil (26804 36364 865778 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13911) (undo-tree-id80 . 1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1)) ((13911 . 13912)) (26804 17239 535564 0) 0 nil])
([nil nil ((12996 . 13002)) nil (26804 36364 865777 0) 0 nil])
nil
([nil nil ((13002 . 13003)) nil (26804 36364 865777 0) 0 nil])
([nil nil ((13003 . 13006)) nil (26804 36364 865776 0) 0 nil])
([nil nil ((13006 . 13007)) nil (26804 36364 865776 0) 0 nil])
([nil nil ((13007 . 13012)) nil (26804 36364 865775 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -13011) (undo-tree-id118 . -1) 13012) nil (26804 36364 865774 0) 0 nil])
([nil nil ((13011 . 13012)) nil (26804 36364 865772 0) 0 nil])
([nil nil ((13012 . 13013)) nil (26804 36364 865772 0) 0 nil])
([nil nil ((13013 . 13016)) nil (26804 36364 865771 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -13015) (undo-tree-id116 . -1) (undo-tree-id117 . -1) 13016) nil (26804 36364 865769 0) 0 nil])
([nil nil ((13015 . 13017)) nil (26804 36364 865756 0) 0 nil])
([nil nil ((13298 . 13303) (t 26804 36364 0 0)) nil (26804 36385 457598 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13323 . 13324) (nil fontified nil 13323 . 13324) (nil fontified nil 13310 . 13323) (nil fontified nil 13303 . 13310) (13303 . 13324)) nil (26804 36385 457597 0) 0 nil])
([nil nil ((13322 . 13323)) nil (26804 36385 457596 0) 0 nil])
([nil nil ((13323 . 13326)) nil (26804 36385 457592 0) 0 nil])
([nil nil ((13646 . 13652) (t 26804 36385 0 0)) nil (26804 36525 572167 0) 0 nil])
([nil nil ((nil fontified nil 13676 . 13677) (nil fontified nil 13659 . 13676) (nil fontified nil 13652 . 13659) (13652 . 13677)) nil (26804 36525 572166 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13674) (undo-tree-id119 . -1) 13675) nil (26804 36525 572165 0) 0 nil])
([nil nil ((13674 . 13675)) nil (26804 36525 572153 0) 0 nil])
([nil nil ((13740 . 13746) (t 26804 36525 0 0)) nil (26804 36539 263103 0) 0 nil])
([nil nil ((nil fontified nil 13770 . 13771) (nil fontified nil 13753 . 13770) (nil fontified nil 13746 . 13753) (13746 . 13771)) nil (26804 36539 263102 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13768) (undo-tree-id121 . -1) 13769) nil (26804 36539 263101 0) 0 nil])
([nil nil ((13768 . 13769)) nil (26804 36539 263099 0) 0 nil])
([nil nil ((13952 . 13958)) nil (26804 36539 263098 0) 0 nil])
([nil nil ((nil fontified nil 13982 . 13983) (nil fontified nil 13965 . 13982) (nil fontified nil 13958 . 13965) (13958 . 13983)) nil (26804 36539 263098 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13980) (undo-tree-id120 . -1) 13981) nil (26804 36539 263096 0) 0 nil])
([nil nil ((13980 . 13981)) nil (26804 36539 263082 0) 0 nil])
([nil nil ((13453 . 13457) (t 26804 36539 0 0)) nil (26804 36581 602232 0) 0 nil])
([nil nil ((13457 . 13458)) nil (26804 36581 602231 0) 0 nil])
([nil nil ((13458 . 13459)) nil (26804 36581 602231 0) 0 nil])
([nil nil ((13459 . 13460)) nil (26804 36581 602230 0) 0 nil])
([nil nil ((13460 . 13466)) nil (26804 36581 602230 0) 0 nil])
([nil nil ((13466 . 13467)) nil (26804 36581 602229 0) 0 nil])
([nil nil ((13467 . 13472)) nil (26804 36581 602229 0) 0 nil])
([nil nil ((13511 . 13515)) nil (26804 36581 602228 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13529 . 13530) (nil fontified nil 13528 . 13530) (nil fontified nil 13525 . 13528) (nil fontified nil 13515 . 13525) (13515 . 13530)) nil (26804 36581 602227 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . 13526)) nil (26804 36581 602225 0) 0 nil])
([nil nil ((13526 . 13527)) nil (26804 36581 602221 0) 0 nil])
([nil nil ((#("
	    (print \"IN QUERY 1A 002\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . -13778) (undo-tree-id146 . -31) 13809 (t 26804 36581 0 0)) nil (26804 40144 624794 0) 0 nil])
([nil nil ((#("
	    (print \"IN QUERY 1A 001\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . 13684) (undo-tree-id145 . -31)) nil (26804 40144 624792 0) 0 nil])
([nil nil ((#("
	    (print \"IN QUERY 1A 003\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . 13928) (undo-tree-id144 . -31)) nil (26804 40144 624790 0) 0 nil])
([nil nil ((#("
		 (x (print \"1\"))" 0 1 (fontified t) 1 4 (fontified t) 4 14 (fontified t) 14 17 (face font-lock-string-face fontified t) 17 18 (fontified t) 18 19 (rear-nonsticky t fontified t)) . 13511) (undo-tree-id140 . -19) (undo-tree-id141 . -4) (undo-tree-id142 . -19) (undo-tree-id143 . -19)) nil (26804 40144 624788 0) 0 nil])
([nil nil ((#("
		 (x (print \"0\"))" 0 1 (fontified t) 1 14 (fontified t) 14 17 (face font-lock-string-face fontified t) 17 19 (fontified t)) . 13453) (undo-tree-id134 . -19) (undo-tree-id135 . -4) (undo-tree-id136 . -19) (undo-tree-id137 . -19) (undo-tree-id138 . -19) (undo-tree-id139 . -19)) nil (26804 40144 624782 0) 0 nil])
([nil nil ((#("
    (print \"IN QUERY 1A 000\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 29 (face font-lock-string-face fontified t) 29 30 (rear-nonsticky t fontified t)) . 13298) (undo-tree-id128 . -30) (undo-tree-id129 . -5) (undo-tree-id130 . -30) (undo-tree-id131 . -30) (undo-tree-id132 . -30) (undo-tree-id133 . -30)) nil (26804 40144 624773 0) 0 nil])
([nil nil ((#("
  (print \"IN QUERY 1A\")" 0 1 (fontified t) 1 10 (fontified t) 10 23 (face font-lock-string-face fontified t) 23 24 (fontified t)) . 12993) (undo-tree-id122 . -24) (undo-tree-id123 . -3) (undo-tree-id124 . -24) (undo-tree-id125 . -24) (undo-tree-id126 . -24) (undo-tree-id127 . -24)) nil (26804 40144 624762 0) 0 nil])
([nil nil ((3584 . 3586) (t 26804 40144 0 0)) nil (26805 50677 424803 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5085 . 5086) (nil fontified nil 3586 . 5086) (3586 . 5086)) nil (26805 50677 424802 0) 0 nil])
([nil nil ((#("Initialise *current-config* et, pour :toplevel uniquement, la connexion globale." 0 80 (face font-lock-doc-face fontified t)) . -3649) (undo-tree-id161 . -80) 3729) nil (26805 50677 424802 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3878 . 3879) (nil fontified nil 3828 . 3879) (nil fontified nil 3649 . 3828) (3649 . 3879)) nil (26805 50677 424801 0) 0 nil])
([nil nil ((#("
(defun start! (&key (config (db-config)))
  \"Initialise selon :connection-mode.
:toplevel → connect-toplevel
:scoped   → rien (ouverture par bloc)
:pooled-native → rien ici (piscine Postmodern via :pooled-p dans with-conn).
Tu peux régler postmodern:*max-pool-size* en amont.\"
  (setf *current-config* config
        *connection-mode* (or (getf config :connection-mode) :toplevel))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    (:scoped (setf *started* t))
    (:pooled-native (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (fontified t) 16 20 (face font-lock-type-face fontified t) 20 45 (fontified t) 45 225 (face font-lock-doc-face fontified t) 225 277 (face font-lock-doc-face fontified t) 277 278 (fontified t) 278 310 (fontified t) 310 350 (fontified t) 350 353 (fontified t) 353 369 (face font-lock-builtin-face fontified t) 369 371 (fontified t) 371 380 (face font-lock-builtin-face fontified t) 380 382 (fontified t) 382 383 (fontified t) 383 386 (fontified t) 386 391 (face font-lock-keyword-face fontified t) 391 415 (fontified t) 415 424 (face font-lock-builtin-face fontified t) 424 425 (fontified t) 425 430 (fontified t) 430 443 (fontified t) 443 449 (fontified t) 449 453 (face font-lock-keyword-face fontified t) 453 455 (fontified t) 455 474 (fontified t) 474 483 (face font-lock-builtin-face fontified t) 483 486 (fontified t) 486 517 (fontified t) 517 522 (face font-lock-builtin-face fontified t) 522 556 (fontified t) 556 565 (face font-lock-builtin-face fontified t) 565 603 (fontified t) 603 608 (face font-lock-builtin-face fontified t) 608 610 (fontified t) 610 611 (face font-lock-string-face fontified t) 611 620 (face font-lock-string-face fontified t) 620 621 (face font-lock-string-face fontified t) 621 659 (fontified t) 659 664 (face font-lock-builtin-face fontified t) 664 708 (fontified t) 708 725 (face font-lock-builtin-face fontified t) 725 727 (fontified t) 727 728 (face font-lock-string-face fontified t) 728 729 (face font-lock-string-face fontified t) 729 732 (fontified t) 732 771 (fontified t) 771 785 (fontified t) 785 793 (face font-lock-builtin-face fontified t) 793 797 (fontified t) 797 798 (fontified t) 798 806 (fontified t) 806 818 (face font-lock-keyword-face fontified t) 818 819 (fontified t) 819 831 (fontified t) 831 836 (face font-lock-keyword-face fontified t) 836 837 (fontified t) 837 985 (fontified t) 985 990 (face font-lock-builtin-face fontified t) 990 996 (fontified t) 996 1004 (face font-lock-builtin-face fontified t) 1004 1055 (fontified t) 1055 1072 (face font-lock-builtin-face fontified t) 1072 1167 (fontified t) 1167 1179 (fontified t) 1179 1184 (face font-lock-warning-face fontified t) 1184 1185 (fontified t) 1185 1186 (face font-lock-string-face fontified t) 1186 1206 (face font-lock-string-face fontified t) 1206 1207 (face font-lock-string-face fontified t) 1207 1213 (fontified t) 1213 1214 (fontified t) 1214 1219 (fontified t) 1219 1232 (face slime-reader-conditional-face fontified t) 1232 1237 (face slime-reader-conditional-face fontified t) 1237 1255 (face slime-reader-conditional-face fontified t) 1255 1256 (fontified t) 1256 1257 (fontified t) 1257 1262 (fontified t) 1262 1269 (face font-lock-builtin-face fontified t) 1269 1289 (fontified t) 1289 1290 (fontified t) 1290 1295 (fontified t) 1295 1309 (face font-lock-builtin-face fontified t) 1309 1324 (fontified t) 1324 1331 (fontified t) 1331 1345 (fontified t) 1345 1346 (fontified t) 1346 1351 (face font-lock-keyword-face fontified t) 1351 1352 (fontified t) 1352 1357 (face font-lock-function-name-face fontified t) 1357 1364 (fontified t) 1364 1368 (face font-lock-keyword-face fontified t) 1368 1384 (fontified t) 1384 1388 (face font-lock-keyword-face fontified t) 1388 1411 (fontified t) 1411 1420 (face font-lock-builtin-face fontified t) 1420 1428 (fontified t) 1428 1442 (fontified t) 1442 1455 (face font-lock-keyword-face fontified t) 1455 1489 (fontified t) 1489 1517 (fontified t) 1517 1522 (fontified t)) . 2063) (undo-tree-id158 . -1522) (undo-tree-id159 . -1110) (undo-tree-id160 . -1110)) nil (26805 50677 424800 0) 0 nil])
([nil nil ((3905 . 3906)) nil (26805 50677 424798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8135 . 8136) (nil fontified nil 3906 . 8136) (3906 . 8136)) nil (26805 50677 424797 0) 0 nil])
([nil nil ((8136 . 8138)) nil (26805 50677 424796 0) 0 nil])
([nil nil ((8138 . 8140)) nil (26805 50677 424796 0) 0 nil])
([nil nil ((11677 . 11679)) nil (26805 50677 424796 0) 0 nil])
([nil nil ((11679 . 11680)) nil (26805 50677 424795 0) 0 nil])
([nil nil ((#("or (getf config :connection-mode)" 0 16 (fontified t) 16 32 (face font-lock-builtin-face fontified t) 32 33 (fontified t)) . -2418) (undo-tree-id157 . -33) 2451) nil (26805 50677 424795 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2443 . 2444) (nil fontified nil 2443 . 2444) (nil fontified nil 2435 . 2443) (nil fontified nil 2434 . 2435) (nil fontified nil 2418 . 2434) (2418 . 2444)) nil (26805 50677 424793 0) 0 nil])
([nil nil ((#(" " 0 1 (rear-nonsticky t fontified t)) . -2443) (undo-tree-id156 . -1) 2444) nil (26805 50677 424792 0) 0 nil])
([nil nil ((2443 . 2444)) nil (26805 50677 424791 0) 0 nil])
([nil nil ((2444 . 2452)) nil (26805 50677 424791 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -2451) (undo-tree-id155 . -1) 2452) nil (26805 50677 424790 0) 0 nil])
([nil nil ((2451 . 2456)) nil (26805 50677 424789 0) 0 nil])
([nil nil ((#("X" 0 1 (face font-lock-string-face fontified t)) . -2450) (undo-tree-id149 . -1) (#("C" 0 1 (face font-lock-string-face fontified t)) . -2451) (undo-tree-id150 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -2452) (undo-tree-id151 . -1) (#("I" 0 1 (face font-lock-string-face fontified t)) . -2453) (undo-tree-id152 . -1) (#("O" 0 1 (face font-lock-string-face fontified t)) . -2454) (undo-tree-id153 . -1) (#("N" 0 1 (face font-lock-string-face fontified t)) . -2455) (undo-tree-id154 . -1) 2456) nil (26805 50677 424788 0) 0 nil])
([nil nil ((2450 . 2461)) nil (26805 50677 424783 0) 0 nil])
([nil nil ((2461 . 2462)) nil (26805 50677 424783 0) 0 nil])
([nil nil ((#("v" 0 1 (fontified t)) . -2461) (undo-tree-id148 . -1) 2462) nil (26805 50677 424782 0) 0 nil])
([nil nil ((2461 . 2462)) nil (26805 50677 424780 0) 0 nil])
([nil nil ((2462 . 2467)) nil (26805 50677 424780 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-builtin-face fontified t)) . -2466) (undo-tree-id147 . -1) 2467) nil (26805 50677 424779 0) 0 nil])
([nil nil ((2466 . 2470)) nil (26805 50677 424870 0) 0 nil])
([nil nil ((2462 . 2473) (#(" " 0 1 (fontified nil)) . 2462) (undo-tree-id171 . -1) (2461 . 2462)) nil (26805 52061 374373 0) 0 nil] [nil nil ((2471 . 2482) (#(" " 0 1 (fontified nil)) . 2471) (2470 . 2471)) ((#("
" 0 1 (fontified t)) . 2470) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (2471 . 2472) (#("						     " 0 11 (fontified t)) . 2471) (undo-tree-id164 . -11)) (26805 50677 424764 0) 0 nil])
([nil nil ((2445 . 2448)) nil (26805 52061 374372 0) 0 nil])
nil
([nil nil ((1150 . 1152)) nil (26805 52061 374372 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1227 . 1228) (nil fontified nil 1152 . 1228) (1152 . 1228)) nil (26805 52061 374371 0) 0 nil])
([nil nil ((1440 . 1442)) nil (26805 52061 374371 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1925 . 1926) (nil fontified nil 1442 . 1926) (1442 . 1926)) nil (26805 52061 374370 0) 0 nil])
([nil nil ((#(" &key config" 0 1 (fontified t) 1 5 (face font-lock-type-face fontified t) 5 12 (fontified t)) . -4531) (undo-tree-id170 . -12) 4543) nil (26805 52061 374369 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4573 . 4574) (nil fontified nil 4535 . 4574) (nil fontified nil 4531 . 4535) (4531 . 4574)) nil (26805 52061 374368 0) 0 nil])
([nil nil ((4536 . 4540)) nil (26805 52061 374368 0) 0 nil])
([nil nil ((4540 . 4541)) nil (26805 52061 374367 0) 0 nil])
([nil nil ((#("&key" 0 4 (fontified t)) . -4531) (undo-tree-id169 . -4) 4535) nil (26805 52061 374366 0) 0 nil])
([nil nil ((#("config" 0 6 (fontified t)) . -4538) (undo-tree-id168 . -6) 4544) nil (26805 52061 374365 0) 0 nil])
([nil nil ((4538 . 4541)) nil (26805 52061 374364 0) 0 nil])
([nil nil ((#("(cfg (%resolve-config config))
         " 0 40 (fontified t)) . -4723) (undo-tree-id167 . -40) 4763) nil (26805 52061 374364 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-string-face fontified t)) . -3011) (undo-tree-id166 . -1) 3012) nil (26805 52061 374362 0) 0 nil])
([nil nil ((3011 . 3012)) nil (26805 52061 374360 0) 0 nil])
([nil nil ((#("(or (getf cfg :connection-mode) :toplevel)" 0 6 (fontified t) 6 14 (fontified t) 14 30 (face font-lock-builtin-face fontified t) 30 32 (fontified t) 32 41 (face font-lock-builtin-face fontified t) 41 42 (fontified t)) . -4729) (undo-tree-id165 . -42) 4771) nil (26805 52061 374359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4806 . 4807) (nil fontified nil 4806 . 4807) (nil fontified nil 4797 . 4806) (nil fontified nil 4796 . 4797) (nil fontified nil 4788 . 4796) (nil fontified nil 4777 . 4788) (nil fontified nil 4776 . 4777) (nil fontified nil 4756 . 4776) (nil fontified nil 4747 . 4756) (nil fontified nil 4746 . 4747) (nil fontified nil 4730 . 4746) (nil fontified nil 4729 . 4730) (4729 . 4807)) nil (26805 52061 374349 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4776)) nil (26805 52061 374347 0) 0 nil])
([nil nil ((#("	     " 0 6 (fontified nil)) . -4784) (4784 . 4785) (#("	" 0 1 (fontified nil)) . 4784) (4782 . 4784) (4776 . 4777)) nil (26805 52061 374342 0) 0 nil])
([nil nil ((18135 . 18137) (t 26805 52061 0 0)) nil (26806 8834 336366 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -18135) (undo-tree-id172 . -1) (#("*" 0 1 (fontified t)) . -18136) (undo-tree-id173 . -1) 18137) nil (26806 8834 336360 0) 0 nil])
([nil nil ((#("&body body" 0 5 (face font-lock-type-face fontified t) 5 10 (fontified t)) . -12328) (undo-tree-id3 . -10) 12338 (t 26806 8834 0 0)) nil (26807 3434 899422 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12354 . 12355) (nil fontified nil 12349 . 12355) (nil fontified nil 12344 . 12349) (nil fontified nil 12338 . 12344) (nil fontified nil 12329 . 12338) (nil fontified nil 12328 . 12329) (12328 . 12355)) nil (26807 3434 899420 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -12327) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 12328) nil (26807 3434 899419 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12354) (undo-tree-id0 . -1) 12355) nil (26807 3434 899416 0) 0 nil])
([nil nil ((12369 . 12374)) nil (26807 3434 899402 0) 0 nil])
([nil nil ((12374 . 12375)) nil (26807 3434 899398 0) 0 nil])
([nil nil ((4713 . 4716) (t 26807 3434 0 0)) nil (26807 19464 835363 0) 0 nil])
([nil nil ((4716 . 4722)) nil (26807 19464 835363 0) 0 nil])
([nil nil ((4722 . 4723)) nil (26807 19464 835362 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -4717) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (#("r" 0 1 (fontified t)) . -4718) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (#("i" 0 1 (fontified t)) . -4719) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) (undo-tree-id150 . -1) (undo-tree-id151 . -1) (undo-tree-id152 . -1) (undo-tree-id153 . -1) (undo-tree-id154 . -1) (undo-tree-id155 . -1) (undo-tree-id156 . -1) (undo-tree-id157 . -1) (undo-tree-id158 . -1) (#("n" 0 1 (fontified t)) . -4720) (undo-tree-id159 . -1) (undo-tree-id160 . -1) (undo-tree-id161 . -1) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (undo-tree-id164 . -1) (undo-tree-id165 . -1) (undo-tree-id166 . -1) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) (undo-tree-id172 . -1) (undo-tree-id173 . -1) (undo-tree-id174 . -1) (undo-tree-id175 . -1) (undo-tree-id176 . -1) (undo-tree-id177 . -1) (undo-tree-id178 . -1) (undo-tree-id179 . -1) (undo-tree-id180 . -1) (undo-tree-id181 . -1) (undo-tree-id182 . -1) (undo-tree-id183 . -1) (undo-tree-id184 . -1) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (#("t" 0 1 (fontified t)) . -4721) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) (undo-tree-id207 . -1) (undo-tree-id208 . -1) (#(" " 0 1 (fontified t)) . -4722) (undo-tree-id209 . -1) (undo-tree-id210 . -1) (undo-tree-id211 . -1) (undo-tree-id212 . -1) (undo-tree-id213 . -1) (undo-tree-id214 . -1) (undo-tree-id215 . -1) (undo-tree-id216 . -1) (undo-tree-id217 . -1) (undo-tree-id218 . -1) (undo-tree-id219 . -1) 4723) nil (26807 19464 835356 0) 0 nil])
([nil nil ((4717 . 4723)) nil (26807 19464 835221 0) 0 nil])
([nil nil ((4723 . 4724)) nil (26807 19464 835220 0) 0 nil])
([nil nil ((4724 . 4725)) nil (26807 19464 835220 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -4724) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) 4725) nil (26807 19464 835219 0) 0 nil])
([nil nil ((4724 . 4725)) nil (26807 19464 835215 0) 0 nil])
([nil nil ((4725 . 4726)) nil (26807 19464 835214 0) 0 nil])
([nil nil ((4726 . 4731)) nil (26807 19464 835214 0) 0 nil])
([nil nil ((4731 . 4732)) nil (26807 19464 835214 0) 0 nil])
([nil nil ((4732 . 4735)) nil (26807 19464 835213 0) 0 nil])
([nil nil ((#("é" 0 1 (face font-lock-string-face fontified t)) . -4734) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 4735) nil (26807 19464 835212 0) 0 nil])
([nil nil ((4734 . 4737)) nil (26807 19464 835196 0) 0 nil])
([nil nil ((4737 . 4738)) nil (26807 19464 835195 0) 0 nil])
([nil nil ((4738 . 4740)) nil (26807 19464 835194 0) 0 nil])
([nil nil ((4740 . 4742)) nil (26807 19464 835190 0) 0 nil])
([nil nil ((7556 . 7566) (t 26807 19464 0 0)) nil (26807 19738 711894 0) 0 nil])
([nil nil ((7566 . 7572)) nil (26807 19738 711894 0) 0 nil])
([nil nil ((7572 . 7573)) nil (26807 19738 711893 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7750 . 7751) (nil fontified nil 7748 . 7751) (nil fontified nil 7746 . 7748) (nil fontified nil 7739 . 7746) (nil fontified nil 7673 . 7739) (nil fontified nil 7665 . 7673) (nil fontified nil 7659 . 7665) (nil fontified nil 7654 . 7659) (nil fontified nil 7597 . 7654) (nil fontified nil 7592 . 7597) (nil fontified nil 7573 . 7592) (7573 . 7751)) nil (26807 19738 711891 0) 0 nil])
([nil nil ((7751 . 7752)) nil (26807 19738 711883 0) 0 nil])
([nil nil ((4834 . 4839) (t 26807 19738 0 0)) nil (26807 19783 142673 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4864 . 4865) (nil fontified nil 4860 . 4865) (nil fontified nil 4849 . 4860) (nil fontified nil 4839 . 4849) (4839 . 4865)) nil (26807 19783 142672 0) 0 nil])
([nil nil ((#("CFG" 0 3 (face font-lock-string-face fontified t)) . -4850) (undo-tree-id225 . -3) (undo-tree-id226 . -1) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -3) (undo-tree-id232 . -3) (undo-tree-id233 . -3) (undo-tree-id234 . -3) 4853) nil (26807 19783 142671 0) 0 nil])
([nil nil ((4850 . 4854)) nil (26807 19783 142664 0) 0 nil])
([nil nil ((#("cfg" 0 3 (fontified t)) . -4862) (undo-tree-id220 . -3) (undo-tree-id221 . -3) (undo-tree-id222 . -3) (undo-tree-id223 . -3) (undo-tree-id224 . -3) 4865) nil (26807 19783 142662 0) 0 nil])
([nil nil ((4862 . 4866)) nil (26807 19783 142646 0) 0 nil])
([nil nil ((#("toplevel" 0 8 (face font-lock-builtin-face fontified t)) . -4823) (undo-tree-id255 . -8) (undo-tree-id256 . -2) (undo-tree-id257 . -2) (undo-tree-id258 . -2) (undo-tree-id259 . -2) (undo-tree-id260 . -2) (undo-tree-id261 . -8) (undo-tree-id262 . -8) (undo-tree-id263 . -8) (undo-tree-id264 . -8) (undo-tree-id265 . -8) (undo-tree-id266 . -8) (undo-tree-id267 . -8) (undo-tree-id268 . -8) 4831 (t 26807 19783 0 0)) nil (26807 19811 709542 0) 0 nil])
([nil nil ((4823 . 4832)) nil (26807 19811 709533 0) 0 nil])
([nil nil ((4822 . 4836) (#(":pooled-na" 0 10 (face font-lock-builtin-face fontified t)) . -4822) (undo-tree-id235 . -1) (undo-tree-id236 . -10) (undo-tree-id237 . -1) (undo-tree-id238 . -1) (undo-tree-id239 . -1) (undo-tree-id240 . -1) (undo-tree-id241 . -1) (undo-tree-id242 . -1) (undo-tree-id243 . -1) (undo-tree-id244 . -1) (undo-tree-id245 . -1) (undo-tree-id246 . -1) (undo-tree-id247 . -1) (undo-tree-id248 . -1) (undo-tree-id249 . -1) (undo-tree-id250 . -1) (undo-tree-id251 . -10) (undo-tree-id252 . -10) (undo-tree-id253 . -10) (undo-tree-id254 . -10) 4832) nil (26807 19811 709529 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-string-face fontified t)) . 4788) (t 26807 19811 0 0)) nil (26807 19842 805814 0) 0 nil])
([nil nil ((4788 . 4789)) nil (26807 19842 805810 0) 0 nil])
([nil nil ((4784 . 4785) (t 26807 19842 0 0)) nil (26807 20203 283081 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -4784) (undo-tree-id316 . -1) 4785) nil (26807 20203 283080 0) 0 nil])
([nil nil ((4758 . 4765)) nil (26807 20203 283079 0) 0 nil])
([nil nil ((4765 . 4766)) nil (26807 20203 283078 0) 0 nil])
([nil nil ((4766 . 4776)) nil (26807 20203 283078 0) 0 nil])
([nil nil ((4767 . 4780) (#("string-up" 0 9 (fontified t)) . -4767) (undo-tree-id315 . -9) 4776) nil (26807 20203 283077 0) 0 nil])
([nil nil ((4780 . 4781)) nil (26807 20203 283076 0) 0 nil])
([nil nil ((4828 . 4829)) nil (26807 20203 283076 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -4828) (undo-tree-id314 . -1) 4829) nil (26807 20203 283075 0) 0 nil])
([nil nil ((4828 . 4830)) nil (26807 20203 283074 0) 0 nil])
([nil nil ((4830 . 4840)) nil (26807 20203 283074 0) 0 nil])
([nil nil ((4840 . 4845)) nil (26807 20203 283073 0) 0 nil])
([nil nil ((4840 . 4848) (#(":keyw" 0 5 (face font-lock-builtin-face fontified t)) . -4840) (undo-tree-id313 . -5) 4845) nil (26807 20203 283073 0) 0 nil])
([nil nil ((4848 . 4849)) nil (26807 20203 283071 0) 0 nil])
([nil nil ((#(":default :pooled-native" 0 8 (face font-lock-builtin-face fontified t) 8 9 (fontified t) 9 23 (face font-lock-builtin-face fontified t)) . 4857) (undo-tree-id310 . -23) (undo-tree-id311 . -9) (undo-tree-id312 . -23) 4880) nil (26807 20203 283071 0) 0 nil])
([nil nil ((4758 . 4762) (#(" " 0 1 (fontified nil)) . 4757) (undo-tree-id303 . -1) (undo-tree-id304 . -1) (undo-tree-id305 . -1) (undo-tree-id306 . -1) (undo-tree-id307 . -1) (undo-tree-id308 . -1) (undo-tree-id309 . -1) (4758 . 4759)) nil (26807 20203 283068 0) 0 nil])
([nil nil ((4770 . 4775) (#(" " 0 1 (fontified nil)) . 4769) (undo-tree-id296 . -1) (undo-tree-id297 . -1) (undo-tree-id298 . -1) (undo-tree-id299 . -1) (undo-tree-id300 . -1) (undo-tree-id301 . -1) (undo-tree-id302 . -1) (4770 . 4771)) nil (26807 20203 283063 0) 0 nil])
([nil nil ((4837 . 4838)) nil (26807 20203 283058 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4860 . 4861) (nil fontified nil 4847 . 4861) (nil fontified nil 4846 . 4847) (nil fontified nil 4838 . 4846) (4838 . 4861)) nil (26807 20203 283058 0) 0 nil])
([nil nil ((4790 . 4796) (#(" " 0 1 (fontified nil)) . 4789) (undo-tree-id289 . -1) (undo-tree-id290 . -1) (undo-tree-id291 . -1) (undo-tree-id292 . -1) (undo-tree-id293 . -1) (undo-tree-id294 . -1) (undo-tree-id295 . -1) (4790 . 4791)) nil (26807 20203 283057 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4869) (undo-tree-id283 . -1) (undo-tree-id284 . -1) (undo-tree-id285 . -1) (undo-tree-id286 . -1) (undo-tree-id287 . -1) (undo-tree-id288 . -1)) nil (26807 20203 283052 0) 0 nil])
([nil nil ((#("	       " 0 8 (fontified nil)) . -4875) (4875 . 4876) (#("	" 0 1 (fontified nil)) . 4875) (4871 . 4875) (4869 . 4870)) nil (26807 20203 283046 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4884) (undo-tree-id279 . -1) (undo-tree-id280 . -1) (undo-tree-id281 . -1) (undo-tree-id282 . -1)) nil (26807 20203 283044 0) 0 nil])
([nil nil ((#("					  )))" 0 7 (fontified t) 7 10 (fontified t)) . 4884) (undo-tree-id269 . -7) (undo-tree-id270 . -7) (undo-tree-id271 . -7) (undo-tree-id272 . -7) (undo-tree-id273 . -7) (undo-tree-id274 . -7) (undo-tree-id275 . -7) (undo-tree-id276 . -7) (undo-tree-id277 . -7) (undo-tree-id278 . -10)) nil (26807 20203 283040 0) 0 nil])
([nil nil ((4884 . 4886)) nil (26807 20203 283018 0) 0 nil])
([nil nil ((7263 . 7266) (t 26807 20203 0 0)) nil (26807 21780 439263 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7332 . 7333) (nil fontified nil 7266 . 7333) (7266 . 7333)) nil (26807 21780 439259 0) 0 nil])
([nil nil ((#("
 " 0 2 (fontified t)) . -7280) (undo-tree-id317 . -2) (undo-tree-id318 . -1) (undo-tree-id319 . -2) (undo-tree-id320 . -2) 7282 (t 26807 21780 0 0)) nil (26807 21786 391697 0) 0 nil])
([nil nil ((#("(ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))" 0 1 (fontified t) 1 14 (face font-lock-keyword-face fontified t) 14 33 (fontified t) 33 63 (face font-lock-string-face fontified t) 63 64 (fontified t) 64 65 (rear-nonsticky t fontified t)) . 7266) (undo-tree-id322 . -14) (undo-tree-id323 . -14) (undo-tree-id324 . -14) (undo-tree-id325 . -14) (undo-tree-id326 . -14) (undo-tree-id327 . -14) (undo-tree-id328 . -14) (undo-tree-id329 . -14) (undo-tree-id330 . -14) (undo-tree-id331 . -65) (t 26807 21786 0 0)) nil (26807 22013 864363 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 7263) (undo-tree-id321 . -1)) nil (26807 22013 864352 0) 0 nil])
([nil nil ((8069 . 8074)) nil (26807 22013 864340 0) 0 nil])
([nil nil ((nil fontified nil 8138 . 8139) (nil fontified nil 8137 . 8138) (nil fontified nil 8107 . 8137) (nil fontified nil 8088 . 8107) (nil fontified nil 8075 . 8088) (nil fontified nil 8074 . 8075) (8074 . 8139)) nil (26807 22013 864335 0) 0 nil])
([nil nil ((#("(print (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t))" 0 88 (fontified t) 88 93 (face font-lock-builtin-face fontified t) 93 99 (fontified t) 99 107 (face font-lock-builtin-face fontified t) 107 173 (fontified t) 173 182 (face font-lock-builtin-face fontified t) 182 186 (fontified t)) . -7653) (undo-tree-id1 . -186) (undo-tree-id2 . -186) (undo-tree-id3 . -186) (undo-tree-id4 . -186) (undo-tree-id5 . -186) (undo-tree-id6 . -116) (undo-tree-id7 . -186) (undo-tree-id8 . -186) 7839 (t 26807 22013 0 0)) nil (26807 59612 899771 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 7643) (undo-tree-id0 . -1)) nil (26807 59612 899760 0) 0 nil])
([nil nil ((#("
  (format t \"CFG: ~A~%\" cfg)" 0 13 (fontified t) 13 24 (face font-lock-string-face fontified t) 24 29 (fontified t)) . 4713) (undo-tree-id12 . -29) (t 26807 59612 0 0)) nil (26808 2978 895881 0) 0 nil])
([nil nil ((#("
    (format t \"MODE: ~A~%\" mode)" 0 15 (fontified t) 15 27 (face font-lock-string-face fontified t) 27 33 (fontified t)) . 4857) (undo-tree-id9 . -33) (undo-tree-id10 . -33) (undo-tree-id11 . -33)) nil (26808 2978 895878 0) 0 nil])
([nil nil ((19250 . 19253) (t 26808 2978 0 0)) nil (26809 24186 21072 0) 0 nil])
([nil nil ((19253 . 19259)) nil (26809 24186 21071 0) 0 nil])
([nil nil ((19259 . 19260)) nil (26809 24186 21069 0) 0 nil])
([nil nil ((19260 . 19267)) nil (26809 24186 21065 0) 0 nil])
([nil nil ((19548 . 19553) (t 26809 24186 0 0)) nil (26809 24326 849968 0) 0 nil])
([nil nil ((19553 . 19558)) nil (26809 24326 849967 0) 0 nil])
([nil nil ((19558 . 19559)) nil (26809 24326 849967 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -19557) (undo-tree-id2 . -1) (#(" " 0 1 (fontified t)) . -19558) (undo-tree-id3 . -1) 19559) nil (26809 24326 849966 0) 0 nil])
([nil nil ((19557 . 19559)) nil (26809 24326 849964 0) 0 nil])
([nil nil ((#("," 0 1 (fontified t)) . -19557) (undo-tree-id0 . -1) (#("t" 0 1 (fontified t)) . -19558) (undo-tree-id1 . -1) 19559) nil (26809 24326 849963 0) 0 nil])
([nil nil ((19557 . 19559)) nil (26809 24326 849947 0) 0 nil])
([nil nil ((19559 . 19560)) nil (26809 24326 849946 0) 0 nil])
([nil nil ((19560 . 19565)) nil (26809 24326 849943 0) 0 nil])
([nil nil ((14982 . 14983) (t 26809 24326 0 0)) nil (26809 39534 36731 0) 0 nil])
([nil nil ((14983 . 14985)) nil (26809 39534 36727 0) 0 nil])
([nil nil ((19568 . 19573) (t 26809 39534 0 0)) nil (26809 40885 902436 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19602 . 19603) (nil fontified nil 19596 . 19603) (nil fontified nil 19586 . 19596) (nil fontified nil 19583 . 19586) (nil fontified nil 19578 . 19583) (nil fontified nil 19573 . 19578) (19573 . 19603)) nil (26809 40885 902435 0) 0 nil])
([nil nil ((#("
    (print args)" 0 1 (fontified t) 1 17 (fontified t)) . 19551) (undo-tree-id27 . -17) (undo-tree-id28 . -17) (undo-tree-id29 . -17) (undo-tree-id30 . -17) (undo-tree-id31 . -17) (undo-tree-id32 . -17) (undo-tree-id33 . -17) (undo-tree-id34 . -17) (undo-tree-id35 . -17) (undo-tree-id36 . -17) (undo-tree-id37 . -17) (undo-tree-id38 . -17) (undo-tree-id39 . -17) (undo-tree-id40 . -17) (undo-tree-id41 . -1) (undo-tree-id42 . -17) (undo-tree-id43 . -17) (undo-tree-id44 . -17) (undo-tree-id45 . -17) (undo-tree-id46 . -17)) nil (26809 40885 902434 0) 0 nil])
([nil nil ((#("
  (print params)" 0 17 (fontified t)) . 19253) (undo-tree-id18 . -17) (undo-tree-id19 . -10) (undo-tree-id20 . -10) (undo-tree-id21 . -10) (undo-tree-id22 . -17) (undo-tree-id23 . -17) (undo-tree-id24 . -17) (undo-tree-id25 . -17) (undo-tree-id26 . -17)) nil (26809 40885 902421 0) 0 nil])
([nil nil ((#("p-tid" 0 5 (fontified t)) . -19563) (undo-tree-id3 . -5) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -5) (undo-tree-id11 . -5) (undo-tree-id12 . -5) (undo-tree-id13 . -5) (undo-tree-id14 . -5) (undo-tree-id15 . -5) (undo-tree-id16 . -5) (undo-tree-id17 . -5) 19568) nil (26809 40885 902415 0) 0 nil])
([nil nil ((19563 . 19567)) nil (26809 40885 902405 0) 0 nil])
([nil nil ((#("P TID" 0 2 (face font-lock-string-face fontified t) 2 5 (face font-lock-string-face fontified t)) . -19550) (undo-tree-id0 . -5) (undo-tree-id1 . -5) (undo-tree-id2 . -5) 19555) nil (26809 40885 902404 0) 0 nil])
([nil nil ((19550 . 19554)) nil (26809 40885 902370 0) 0 nil])
([nil nil ((19567 . 19572) (t 26809 40885 0 0)) nil (26809 41012 989342 0) 0 nil])
([nil nil ((19572 . 19577)) nil (26809 41012 989341 0) 0 nil])
([nil nil ((19573 . 19579) (#("form" 0 4 (fontified t)) . -19573) (undo-tree-id59 . -4) 19577) nil (26809 41012 989341 0) 0 nil])
([nil nil ((19579 . 19580)) nil (26809 41012 989339 0) 0 nil])
([nil nil ((19580 . 19581)) nil (26809 41012 989339 0) 0 nil])
([nil nil ((19581 . 19582)) nil (26809 41012 989338 0) 0 nil])
([nil nil ((#("(format y " 0 1 (fontified t) 1 10 (fontified t)) . -19572) (undo-tree-id58 . -10) 19582) nil (26809 41012 989338 0) 0 nil])
([nil nil ((nil fontified nil 19599 . 19600) (nil fontified nil 19594 . 19599) (nil fontified nil 19587 . 19594) (nil fontified nil 19582 . 19587) (nil fontified nil 19577 . 19582) (nil fontified nil 19572 . 19577) (19572 . 19600)) nil (26809 41012 989337 0) 0 nil])
([nil nil ((#("ARGS" 0 4 (face font-lock-string-face fontified t)) . -19583) (undo-tree-id57 . -4) 19587) nil (26809 41012 989336 0) 0 nil])
([nil nil ((19583 . 19586)) nil (26809 41012 989335 0) 0 nil])
([nil nil ((#("args" 0 4 (fontified t)) . -19594) (undo-tree-id50 . -4) (undo-tree-id51 . -4) (undo-tree-id52 . -4) (undo-tree-id53 . -4) (undo-tree-id54 . -4) (undo-tree-id55 . -4) (undo-tree-id56 . -4) 19598) nil (26809 41012 989334 0) 0 nil])
([nil nil ((19594 . 19596)) nil (26809 41012 989329 0) 0 nil])
([nil nil ((#("l" 0 1 (fontified t)) . -19595) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) 19596) nil (26809 41012 989327 0) 0 nil])
([nil nil ((19595 . 19597)) nil (26809 41012 989315 0) 0 nil])
([nil nil ((20390 . 20396) (t 26809 41012 0 0)) nil (26809 41299 993028 0) 0 nil])
([nil nil ((20396 . 20402)) nil (26809 41299 993028 0) 0 nil])
([nil nil ((20402 . 20403)) nil (26809 41299 993027 0) 0 nil])
([nil nil ((20403 . 20408)) nil (26809 41299 993027 0) 0 nil])
([nil nil ((#("V" 0 1 (face font-lock-string-face fontified t)) . -20404) (undo-tree-id60 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -20405) (undo-tree-id61 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -20406) (undo-tree-id62 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -20407) (undo-tree-id63 . -1) 20408) nil (26809 41299 993025 0) 0 nil])
([nil nil ((20404 . 20411)) nil (26809 41299 993011 0) 0 nil])
([nil nil ((#("
	    (print \"NBNVN\")" 0 13 (fontified t) 13 20 (face font-lock-string-face fontified t) 20 21 (fontified t)) . 20390) (undo-tree-id0 . -21) (t 26809 41299 0 0)) nil (26821 52430 879572 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21279 . 21280) (nil fontified nil 21275 . 21280) (nil fontified nil 21265 . 21275) (nil fontified nil 21244 . 21265) (nil fontified nil 21231 . 21244) (nil fontified nil 21214 . 21231) (nil fontified nil 21209 . 21214) (nil fontified nil 21197 . 21209) (nil fontified nil 21183 . 21197) (nil fontified nil 21175 . 21183) (nil fontified nil 21168 . 21175) (nil fontified nil 21142 . 21168) (nil fontified nil 21119 . 21142) (nil fontified nil 21114 . 21119) (nil fontified nil 20968 . 21114) (nil fontified nil 20959 . 20968) (nil fontified nil 20954 . 20959) (nil fontified nil 20952 . 20954) (nil fontified nil 20939 . 20952) (nil fontified nil 20938 . 20939) (nil fontified nil 20930 . 20938) (nil fontified nil 20929 . 20930) (20929 . 21280) (t 26821 52430 0 0)) nil (26957 4576 998444 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -20927) (undo-tree-id1 . -1) 20928) nil (26957 4576 998439 0) 0 nil])
([nil nil ((589 . 590)) nil (26957 4576 998436 0) 0 nil])
([nil nil ((590 . 596)) nil (26957 4576 998435 0) 0 nil])
([nil nil ((596 . 599)) nil (26957 4576 998435 0) 0 nil])
([nil nil ((590 . 604) (#(":with-rol" 0 9 (face font-lock-builtin-face fontified t)) . -590) (undo-tree-id0 . -9) 599) nil (26957 4576 998432 0) 0 nil])
([nil nil ((21294 . 21295)) nil (26957 4576 998409 0) 0 nil])
([nil nil ((3077 . 3079) (#("  " 0 2 (fontified nil)) . 3076) (undo-tree-id0 . -2) (3075 . 3079) (t 26957 4577 0 0)) nil (26957 39013 54210 0) 0 nil])
([nil nil ((3079 . 3085)) nil (26957 39013 54197 0) 0 nil])
([nil nil ((3085 . 3086)) nil (26957 39013 54196 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3102 . 3103) (nil fontified nil 3086 . 3103) (3086 . 3103)) nil (26957 39013 54195 0) 0 nil])
([nil nil ((3103 . 3104)) nil (26957 39013 54191 0) 0 nil])
([nil nil ((3104 . 3107) (t 26957 39013 0 0)) nil (26957 39104 559293 0) 0 nil])
([nil nil ((3107 . 3113)) nil (26957 39104 559293 0) 0 nil])
([nil nil ((3113 . 3114)) nil (26957 39104 559291 0) 0 nil])
([nil nil ((3114 . 3121)) nil (26957 39104 559288 0) 0 nil])
([nil nil ((2996 . 2999) (t 26957 39104 0 0)) nil (26957 39461 128035 0) 0 nil])
([nil nil ((2999 . 3000)) nil (26957 39461 128035 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3022 . 3023) (nil fontified nil 3022 . 3023) (nil fontified nil 3013 . 3022) (nil fontified nil 3000 . 3013) (3000 . 3023)) nil (26957 39461 128034 0) 0 nil])
([nil nil ((3023 . 3033)) nil (26957 39461 128033 0) 0 nil])
([nil nil ((3112 . 3113)) nil (26957 39461 128033 0) 0 nil])
([nil nil ((#("database" 0 8 (face font-lock-builtin-face fontified t)) . -3014) (undo-tree-id3 . -8) 3022) nil (26957 39461 128032 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -3013) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 3014) nil (26957 39461 128029 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3031 . 3032) (nil fontified nil 3013 . 3032) (3013 . 3032)) nil (26957 39461 128014 0) 0 nil])
([nil nil ((#("
  (print *connection-mode*)
  (print \"OKKK\")" 0 1 (fontified t) 1 10 (fontified t) 10 26 (fontified t) 26 27 (fontified t rear-nonsticky t) 27 29 (fontified t) 29 38 (fontified t) 38 44 (face font-lock-string-face fontified t) 44 45 (fontified t)) . 3124) (undo-tree-id4 . -45) (undo-tree-id5 . -28) (undo-tree-id6 . -10) (undo-tree-id7 . -45) (undo-tree-id8 . -45) (undo-tree-id9 . -45) (undo-tree-id10 . -45) (t 26957 39461 0 0)) nil (26958 8256 484077 0) 0 nil])
([nil nil ((#("
#|
(defmacro with-conn (&body body)
  \"Ouvre une connexion selon *connection-mode* avec les bons paramètres Postmodern.\"
  #+postmodern
  `(ecase *connection-mode*
     (:toplevel
      (progn ,@body))
     (:scoped
      (let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
          ,@body)))
     (:pooled-native
      ;; On utilise le sémaphore *pool-sema* pour borner la concurrence,
      ;; mais on *n’inspecte plus* son compte. On expose in-use via *pool-inflight*.
      (let* ((deadline (+ (get-internal-real-time)
                          (* cl:internal-time-units-per-second
                             (/ (max 1 *pool-wait-ms*) 1000.0))))
             (t0 (get-internal-real-time)))
        ;; on entre en file d’attente
        (%pool-incf! '*pool-waiters* 1)
        (unwind-protect
             (progn
               (labels ((acquire-slot ()
                          (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                              (if (< (get-internal-real-time) deadline)
                                  (acquire-slot)
                                  (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                 (acquire-slot))
               ;; slot acquis → sortie d’attente / entrée en vol
               (%pool-incf! '*pool-waiters*  -1)
               (%pool-incf! '*pool-inflight* 1)
               (let* ((t1 (get-internal-real-time))
                      (wait-ms (* 1000.0 (/ (- t1 t0) cl:internal-time-units-per-second))))
                 ;; publier métrique (in-use = connexions tenues)
                 (multiple-value-bind (in-use _waiters) (%pool-snapshot)
                   (declare (ignore _waiters))
                   (ignore-errors
                     (lumen.data.metrics:record-pool-stats in-use wait-ms))))
               ;; exécuter le corps dans une connexion Postmodern poolée
               (let* ((cfg *current-config*)
                      (db   (getf cfg :database))
                      (user (getf cfg :user))
                      (pass (getf cfg :password))
                      (host (or (getf cfg :host) \"localhost\"))
                      (port (or (getf cfg :port) 5432))
                      (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                 (unwind-protect
                      (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl
                                                        ;; NB: on peut passer :pooled-p t ici si tu veux explicitement le pool PM
                                                        )
                        ,@body)
                   ;; sortie : on libère la connexion + met à jour in-flight
                   (%pool-incf! '*pool-inflight* -1)
                   (bt:signal-semaphore *pool-sema*))))
          ;; si une erreur survient AVANT l’acquisition du slot, on décrémente la file d’attente
          (when (> *pool-waiters* 0)
            (%pool-incf! '*pool-waiters* -1))))))
  #-postmodern
  `(progn ,@body))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 1377 (face font-lock-comment-face fontified t) 1377 1475 (face font-lock-comment-face fontified t) 1475 2975 (face font-lock-comment-face fontified t) 2975 3046 (face font-lock-comment-face fontified t) 3046 3244 (fontified t face font-lock-comment-face) 3244 3540 (face font-lock-comment-face fontified t) 3540 3542 (face font-lock-comment-delimiter-face fontified t) 3542 3543 (fontified t)) . -8952) (undo-tree-id16 . -3543) (undo-tree-id17 . -2213) 12495 (t 26958 8256 0 0)) nil (26958 9622 95545 0) 0 nil])
([nil nil ((#("
#|
(defmacro with-statement-timeout ((ms) &body body)
  \"Exécute BODY avec SET LOCAL statement_timeout = MS (dans une transaction),
si MS est non-NIL et > 0. N’affecte que la transaction courante.\"
  `(ensure-connection
     (if (and ,ms (> ,ms 0))
         (postmodern:with-transaction ()
           ;; SET LOCAL ne persiste que le temps de cette transaction
           (postmodern:query
             (format nil \"set local statement_timeout = ~d\" (truncate ,ms)))
           ,@body)ent
         (progn ,@body))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 516 (face font-lock-comment-face fontified t) 516 518 (face font-lock-comment-delimiter-face fontified t)) . -11018) (undo-tree-id15 . -518) 11536) nil (26958 9622 95543 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 11018)) nil (26958 9622 95542 0) 0 nil])
([nil nil ((4710 . 4711)) nil (26958 9622 95541 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4779 . 4780) (nil fontified nil 4711 . 4780) (4711 . 4780)) nil (26958 9622 95541 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-doc-face fontified t)) . 4780)) nil (26958 9622 95540 0) 0 nil])
([nil nil ((4780 . 4781)) nil (26958 9622 95540 0) 0 nil])
([nil nil ((#("(thunk &key (cfg (lumen.data.config:db-config)))" 0 4 (fontified t) 4 7 (fontified t) 7 11 (face font-lock-type-face fontified t) 11 35 (fontified t) 35 36 (fontified t) 36 48 (fontified t)) . -4589) (undo-tree-id14 . -48) 4637) nil (26958 9622 95539 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4658 . 4659) (nil fontified nil 4589 . 4659) (4589 . 4659)) nil (26958 9622 95537 0) 0 nil])
([nil nil ((#("(let* ((mode
	   (intern
	    (string-upcase
	     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))
	    :keyword)))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 78 (fontified t) 78 98 (face font-lock-string-face fontified t) 98 99 (fontified t) 99 107 (face font-lock-builtin-face fontified t) 107 108 (fontified t) 108 122 (face font-lock-builtin-face fontified t) 122 130 (fontified t) 130 138 (face font-lock-builtin-face fontified t) 138 141 (fontified t)) . -4872) (undo-tree-id13 . -141) 5013) nil (26958 9622 95537 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5166 . 5167) (nil fontified nil 4872 . 5167) (4872 . 5167)) nil (26958 9622 95535 0) 0 nil])
([nil nil ((4596 . 4605) (#(" " 0 1 (fontified nil)) . 4595) (undo-tree-id12 . -1) (4596 . 4597)) nil (26958 9622 95534 0) 0 nil])
([nil nil ((17537 . 17538)) nil (26958 9622 95532 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17868 . 17869) (nil fontified nil 17538 . 17869) (17538 . 17869)) nil (26958 9622 95532 0) 0 nil])
([nil nil ((17184 . 17185)) nil (26958 9622 95531 0) 0 nil])
([nil nil ((17185 . 17187)) nil (26958 9622 95530 0) 0 nil])
([nil nil ((17540 . 17542)) nil (26958 9622 95530 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-comment-face fontified t)) . -17541) (undo-tree-id11 . -1) 17542) nil (26958 9622 95529 0) 0 nil])
([nil nil ((17541 . 17542)) nil (26958 9622 95519 0) 0 nil])
([nil nil ((17542 . 17543)) nil (26958 9622 95518 0) 0 nil])
([nil nil ((17875 . 17876)) nil (26958 9622 95515 0) 0 nil])
([nil nil ((2937 . 2940) (t 26958 9622 0 0)) nil (26974 15484 997356 0) 0 nil])
([nil nil ((2940 . 2946)) nil (26974 15484 997356 0) 0 nil])
([nil nil ((2946 . 2947)) nil (26974 15484 997355 0) 0 nil])
([nil nil ((2947 . 2951)) nil (26974 15484 997355 0) 0 nil])
([nil nil ((#("N" 0 1 (fontified t)) . -2949) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (#("N" 0 1 (fontified t)) . -2950) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) 2951) nil (26974 15484 997354 0) 0 nil])
([nil nil ((#("é" 0 1 (fontified t)) . -2947) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (#("I" 0 1 (fontified t)) . -2948) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) 2949) nil (26974 15484 997346 0) 0 nil])
([nil nil ((2947 . 2955)) nil (26974 15484 997336 0) 0 nil])
([nil nil ((#("S" 0 1 (face font-lock-string-face fontified t)) . -2950) (undo-tree-id0 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -2951) (undo-tree-id1 . -1) (#("A" 0 1 (face font-lock-string-face fontified t)) . -2952) (undo-tree-id2 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -2953) (undo-tree-id3 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -2954) (undo-tree-id4 . -1) 2955) nil (26974 15484 997334 0) 0 nil])
([nil nil ((2950 . 2951)) nil (26974 15484 997315 0) 0 nil])
([nil nil ((2951 . 2959)) nil (26974 15484 997314 0) 0 nil])
([nil nil ((2959 . 2962)) nil (26974 15484 997314 0) 0 nil])
([nil nil ((2962 . 2968)) nil (26974 15484 997314 0) 0 nil])
([nil nil ((2968 . 2969)) nil (26974 15484 997313 0) 0 nil])
([nil nil ((2969 . 2974)) nil (26974 15484 997312 0) 0 nil])
([nil nil ((2974 . 2976)) nil (26974 15484 997309 0) 0 nil])
([nil nil ((3160 . 3162) (3136 . 3138) (#("     " 0 5 (fontified nil)) . 3136) (3162 . 3163) (t 26974 15484 0 0)) nil (26974 15854 200219 0) 0 nil])
([nil nil ((3162 . 3167)) nil (26974 15854 200219 0) 0 nil])
([nil nil ((3167 . 3168)) nil (26974 15854 200218 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3182 . 3183) (nil fontified nil 3168 . 3183) (3168 . 3183)) nil (26974 15854 200218 0) 0 nil])
([nil nil ((#("thing" 0 5 (fontified t)) . -3177) (undo-tree-id31 . -5) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -5) (undo-tree-id39 . -5) (undo-tree-id40 . -5) (undo-tree-id41 . -5) 3182) nil (26974 15854 200216 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3193 . 3194) (nil fontified nil 3177 . 3194) (3177 . 3194)) nil (26974 15854 200200 0) 0 nil])
([nil nil ((3195 . 3200)) nil (26974 15854 200268 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3252 . 3253) (nil fontified nil 3252 . 3253) (nil fontified nil 3244 . 3252) (nil fontified nil 3200 . 3244) (3200 . 3253)) nil (26974 15869 981465 0) 0 nil] [nil nil ((nil rear-nonsticky nil 3216 . 3217) (nil fontified nil 3200 . 3217) (3200 . 3217)) ((#("*connection-mode*" 0 16 (fontified nil) 16 17 (rear-nonsticky nil fontified nil)) . 3200) (undo-tree-id42 . -17) (nil rear-nonsticky t 3216 . 3217)) (26974 15854 200195 0) 0 nil])
([nil nil ((3200 . 3205)) nil (26974 15869 981464 0) 0 nil])
nil
([nil nil ((3205 . 3206)) nil (26974 15869 981464 0) 0 nil])
([nil nil ((nil fontified nil 3222 . 3223) (nil fontified nil 3206 . 3222) (3206 . 3223)) nil (26974 15869 981463 0) 0 nil])
([nil nil ((3223 . 3224)) nil (26974 15869 981461 0) 0 nil])
([nil nil ((3277 . 3279)) nil (26974 15869 981458 0) 0 nil])
([nil nil ((#("thing" 0 5 (fontified t)) . -3260) (undo-tree-id43 . -5) (undo-tree-id44 . -5) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -5) (undo-tree-id51 . -5) (undo-tree-id52 . -5) (undo-tree-id53 . -5) 3265 (t 26974 15869 0 0)) nil (26974 15889 590799 0) 0 nil])
([nil nil ((nil fontified nil 3276 . 3277) (nil fontified nil 3260 . 3276) (3260 . 3277)) nil (26974 15889 590782 0) 0 nil])
([nil nil ((3291 . 3294) (t 26974 15889 0 0)) nil (26974 16001 578442 0) 0 nil])
([nil nil ((3294 . 3300)) nil (26974 16001 578442 0) 0 nil])
([nil nil ((3300 . 3301)) nil (26974 16001 578441 0) 0 nil])
([nil nil ((nil fontified nil 3317 . 3318) (nil fontified nil 3301 . 3317) (3301 . 3318)) nil (26974 16001 578440 0) 0 nil])
([nil nil ((3318 . 3319)) nil (26974 16001 578436 0) 0 nil])
([nil nil ((#("(symbol-name " 0 13 (fontified t)) . -3247) (undo-tree-id54 . -13) (undo-tree-id55 . -13) (undo-tree-id56 . -13) (undo-tree-id57 . -13) 3260 (t 26974 16001 0 0)) nil (26974 16038 97477 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . 3264)) nil (26974 16038 97461 0) 0 nil])
([nil nil ((15989 . 15994) (t 26974 16038 0 0)) nil (26975 58388 717925 0) 0 nil])
([nil nil ((16027 . 16032)) nil (26975 58388 717924 0) 0 nil])
([nil nil ((15740 . 15743)) nil (26975 58388 717924 0) 0 nil])
([nil nil ((15743 . 15745)) nil (26975 58388 717923 0) 0 nil])
([nil nil ((15745 . 15746)) nil (26975 58388 717923 0) 0 nil])
([nil nil ((15746 . 15752)) nil (26975 58388 717922 0) 0 nil])
([nil nil ((15752 . 15753)) nil (26975 58388 717922 0) 0 nil])
([nil nil ((15753 . 15759)) nil (26975 58388 717921 0) 0 nil])
([nil nil ((15815 . 15818)) nil (26975 58388 717921 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15833 . 15834) (nil fontified nil 15832 . 15834) (nil fontified nil 15828 . 15832) (nil fontified nil 15818 . 15828) (15818 . 15834)) nil (26975 58388 717920 0) 0 nil])
([nil nil ((15885 . 15888)) nil (26975 58388 717920 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15903 . 15904) (nil fontified nil 15902 . 15904) (nil fontified nil 15898 . 15902) (nil fontified nil 15888 . 15898) (15888 . 15904)) nil (26975 58388 717919 0) 0 nil])
([nil nil ((15990 . 15993)) nil (26975 58388 717918 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16008 . 16009) (nil fontified nil 16007 . 16009) (nil fontified nil 16003 . 16007) (nil fontified nil 15993 . 16003) (15993 . 16009)) nil (26975 58388 717918 0) 0 nil])
([nil nil ((15692 . 15695)) nil (26975 58388 717917 0) 0 nil])
([nil nil ((15695 . 15696)) nil (26975 58388 717916 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -15695) (undo-tree-id89 . -1) 15696) nil (26975 58388 717916 0) 0 nil])
([nil nil ((15695 . 15696)) nil (26975 58388 717915 0) 0 nil])
([nil nil ((16069 . 16071)) nil (26975 58388 717914 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16110 . 16111) (nil fontified nil 16109 . 16111) (16109 . 16111)) nil (26975 58388 717913 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -15695) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) 15696) nil (26975 58388 717912 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15729 . 15730) (nil fontified nil 15724 . 15730) (nil fontified nil 15705 . 15724) (nil fontified nil 15695 . 15705) (15695 . 15730)) nil (26975 58388 717905 0) 0 nil])
([nil nil ((#("ARGS" 0 4 (face font-lock-string-face fontified t)) . -15713) (undo-tree-id68 . -4) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -4) (undo-tree-id75 . -4) (undo-tree-id76 . -4) (undo-tree-id77 . -4) 15717) nil (26975 58388 717903 0) 0 nil])
([nil nil ((15713 . 15719)) nil (26975 58388 717897 0) 0 nil])
([nil nil ((#("args" 0 4 (fontified t)) . -15727) (undo-tree-id58 . -4) (undo-tree-id59 . -2) (undo-tree-id60 . -2) (undo-tree-id61 . -2) (undo-tree-id62 . -2) (undo-tree-id63 . -2) (undo-tree-id64 . -4) (undo-tree-id65 . -4) (undo-tree-id66 . -4) (undo-tree-id67 . -4) 15731) nil (26975 58388 717895 0) 0 nil])
([nil nil ((15727 . 15733)) nil (26975 58388 717875 0) 0 nil])
([nil nil ((#("(format t \"~&EXEC:SQL: ~A~%\" sql)" 0 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 12 (face font-lock-string-face fontified t) 12 13 (face font-lock-string-face fontified t rear-nonsticky t) 13 28 (face font-lock-string-face fontified t) 28 33 (fontified t)) . 16136) (undo-tree-id96 . -11) (t 26975 58388 0 0)) nil (26975 58879 219050 0) 0 nil])
([nil nil ((15734 . 15737)) nil (26975 58879 219049 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15769 . 15770) (nil fontified nil 15765 . 15770) (nil fontified nil 15750 . 15765) (nil fontified nil 15749 . 15750) (nil fontified nil 15748 . 15749) (nil fontified nil 15747 . 15748) (nil fontified nil 15737 . 15747) (15737 . 15770)) nil (26975 58879 219048 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -15831) (undo-tree-id95 . -4) 15835) nil (26975 58879 219047 0) 0 nil])
([nil nil ((15831 . 15833)) nil (26975 58879 219046 0) 0 nil])
([nil nil ((15833 . 15835)) nil (26975 58879 219045 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -15906) (undo-tree-id94 . -4) 15910) nil (26975 58879 219044 0) 0 nil])
([nil nil ((15906 . 15910)) nil (26975 58879 219043 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -15976) (undo-tree-id93 . -4) 15980) nil (26975 58879 219043 0) 0 nil])
([nil nil ((15976 . 15980)) nil (26975 58879 219041 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -16081) (undo-tree-id90 . -4) (undo-tree-id91 . -4) (undo-tree-id92 . -4) 16085) nil (26975 58879 219039 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16090 . 16091) (nil fontified nil 16081 . 16091) (16081 . 16091)) nil (26975 58879 219024 0) 0 nil])
([nil nil ((17506 . 17508) (t 26975 58879 0 0)) nil (26975 60479 945245 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19901 . 19902) (nil fontified nil 17508 . 19902) (17508 . 19902)) nil (26975 60479 945245 0) 0 nil])
([nil nil ((15493 . 15494)) nil (26975 60479 945244 0) 0 nil])
([nil nil ((15494 . 15496)) nil (26975 60479 945244 0) 0 nil])
([nil nil ((17510 . 17512)) nil (26975 60479 945243 0) 0 nil])
([nil nil ((17512 . 17513)) nil (26975 60479 945243 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -17688) (undo-tree-id109 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -17689) (undo-tree-id110 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -17690) (undo-tree-id111 . -1) 17691) nil (26975 60479 945242 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -18446) (undo-tree-id106 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18447) (undo-tree-id107 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18448) (undo-tree-id108 . -1) 18449) nil (26975 60479 945237 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -18486) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18487) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18488) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) 18489) nil (26975 60479 945231 0) 0 nil])
([nil nil ((19832 . 19838) (#("      " 0 6 (fontified nil)) . 19831) (undo-tree-id112 . -6) (#("      " 0 6 (fontified nil)) . -19837) (undo-tree-id113 . -6) (19843 . 19844) (t 26975 60479 0 0)) nil (26976 11389 444321 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20011 . 20012) (nil fontified nil 19838 . 20012) (19838 . 20012)) nil (26976 11389 444310 0) 0 nil])
([nil nil ((20012 . 20019)) nil (26976 11389 444305 0) 0 nil])
([nil nil ((10721 . 10726) (t 26976 11389 0 0)) nil (26976 12374 272864 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10943 . 10944) (nil fontified nil 10726 . 10944) (10726 . 10944)) nil (26976 12374 272862 0) 0 nil])
([nil nil ((10944 . 10949)) nil (26976 12374 272859 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\")))
    `(let ((,g-attempt 0)
           (,g-retries ,retries)
           (,g-sleep ,sleep-ms))
       (loop
         (handler-case
             (return
               (ensure-connection
                 #+postmodern
                 (postmodern:with-transaction () ,@body)
                 #-postmodern
                 (progn ,@body)
		 ))
	   ;; Elles sortiront du with-transaction (provoquant un ROLLBACK automatique)
           ;; et seront attrapées par le middleware HTTP plus haut.
           (lumen.core.error:application-error (c)
             (error c))
	   
           (condition (c)
             ;; Convertit en condition Lumen sans la signaler, puis évalue la rejouabilité
             (let ((mapped (lumen.data.errors:map-db-error c)))
               (if (and (< ,g-attempt ,g-retries)
                        (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (incf ,g-attempt)
                     ;; Backoff simple (optionnel)
                     (when (plusp ,g-sleep)
                       (sleep (/ (max 0 ,g-sleep) 1000.0)))
                     ;; et on boucle pour retenter
                     (continue))
                   ;; Pas rejouable (ou plus de retries) → signaler l’erreur Lumen
                   (error mapped)))))))))" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 42 (fontified t) 42 45 (face font-lock-keyword-face fontified t) 45 66 (fontified t) 66 71 (face font-lock-string-face fontified t) 71 101 (fontified t) 101 106 (face font-lock-string-face fontified t) 106 136 (fontified t) 136 143 (face font-lock-string-face fontified t) 143 153 (fontified t) 153 156 (face font-lock-keyword-face fontified t) 156 247 (fontified t) 247 251 (face font-lock-keyword-face fontified t) 251 262 (fontified t) 262 274 (face font-lock-keyword-face fontified t) 274 289 (fontified t) 289 295 (face font-lock-keyword-face fontified t) 295 378 (fontified t) 378 405 (face font-lock-keyword-face fontified t) 405 434 (fontified t) 434 478 (face slime-reader-conditional-face fontified t) 478 489 (fontified t) 489 492 (face font-lock-comment-delimiter-face fontified t) 492 565 (face font-lock-comment-face fontified t) 565 576 (fontified t) 576 579 (face font-lock-comment-delimiter-face fontified t) 579 633 (face font-lock-comment-face fontified t) 633 698 (fontified t) 698 703 (face font-lock-warning-face fontified t) 703 752 (fontified t) 752 755 (face font-lock-comment-delimiter-face fontified t) 755 756 (face font-lock-comment-face fontified t) 756 830 (face font-lock-comment-face fontified t) 830 844 (fontified t) 844 847 (face font-lock-keyword-face fontified t) 847 910 (fontified t) 910 912 (face font-lock-keyword-face fontified t) 912 1037 (fontified t) 1037 1042 (face font-lock-keyword-face fontified t) 1042 1103 (fontified t) 1103 1106 (face font-lock-comment-delimiter-face fontified t) 1106 1133 (face font-lock-comment-face fontified t) 1133 1155 (fontified t) 1155 1159 (face font-lock-keyword-face fontified t) 1159 1258 (fontified t) 1258 1261 (face font-lock-comment-delimiter-face fontified t) 1261 1288 (face font-lock-comment-face fontified t) 1288 1340 (fontified t) 1340 1343 (face font-lock-comment-delimiter-face fontified t) 1343 1404 (face font-lock-comment-face fontified t) 1404 1424 (fontified t) 1424 1429 (face font-lock-warning-face fontified t) 1429 1445 (fontified t)) . -10237) (undo-tree-id6 . -1445) (undo-tree-id7 . -173) (undo-tree-id8 . -434) (undo-tree-id9 . -436) (undo-tree-id10 . -830) (undo-tree-id11 . -109) (undo-tree-id12 . -239) (undo-tree-id13 . -417) (undo-tree-id14 . -417) (undo-tree-id15 . -417) (undo-tree-id16 . -417) (undo-tree-id17 . -417) (undo-tree-id18 . -417) (undo-tree-id19 . -417) (undo-tree-id20 . -417) (undo-tree-id21 . -526) (undo-tree-id22 . -526) (undo-tree-id23 . -526) (undo-tree-id24 . -526) (undo-tree-id25 . -526) (undo-tree-id26 . -1404) 11682 (t 26976 12374 0 0)) nil (26976 14033 337962 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12284 . 12285) (nil fontified nil 10237 . 12285) (10237 . 12285)) nil (26976 14033 337948 0) 0 nil])
([nil nil ((12285 . 12286)) nil (26976 14033 337947 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -12284) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (#(")" 0 1 (fontified t)) . -12285) (undo-tree-id4 . -1) (undo-tree-id5 . -1) 12286) nil (26976 14033 337945 0) 0 nil])
([nil nil ((12284 . 12285)) nil (26976 14033 337927 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-result  (gensym \"RES\"))
        (g-retry-token (gensym \"RETRY\")))
    `(let ((,g-attempt 0)
           (,g-retries ,retries)
           (,g-sleep ,sleep-ms))
       (loop
         (let ((,g-result
                 (handler-case
                     ;; On capture les valeurs de retour dans une liste
                     (multiple-value-list
                      (ensure-connection
                        #+postmodern
                        (postmodern:with-transaction () ,@body)
                        #-postmodern
                        (progn ,@body)))

                   ;; 1. Erreur Métier : On la relance IMMEDIATEMENT.
                   ;; Cela sort du LET, sort du LOOP, et remonte au Middleware.
                   (lumen.core.error:application-error (c)
                     (error c))
                   
                   ;; 2. Erreur Technique : On analyse si on doit réessayer
                   (condition (c)
                     (let ((mapped (lumen.data.errors:map-db-error c)))
                       (if (and (< ,g-attempt ,g-retries)
                                (lumen.data.errors:retryable-db-error-p mapped))
                           (progn
                             (incf ,g-attempt)
                             (when (plusp ,g-sleep)
                               (sleep (/ (max 0 ,g-sleep) 1000.0)))
                             ;; On renvoie un token spécial pour dire \"c'est pas fini\"
                             ',g-retry-token)
                           
                           ;; Sinon, c'est une vraie erreur fatale
                           (error mapped)))))))

           ;; C'est ICI que se fait le contrôle de flux, hors du handler-case
           ;; Si le résultat n'est pas le token de retry, on quitte la boucle proprement
           (unless (eq ,g-result ',g-retry-token)
             (return (values-list ,g-result))))))))
" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 42 (fontified t) 42 45 (face font-lock-keyword-face fontified t) 45 66 (fontified t) 66 71 (face font-lock-string-face fontified t) 71 101 (fontified t) 101 106 (face font-lock-string-face fontified t) 106 136 (fontified t) 136 143 (face font-lock-string-face fontified t) 143 173 (fontified t) 173 178 (face font-lock-string-face fontified t) 178 212 (fontified t) 212 219 (face font-lock-string-face fontified t) 219 229 (fontified t) 229 232 (face font-lock-keyword-face fontified t) 232 323 (fontified t) 323 327 (face font-lock-keyword-face fontified t) 327 338 (fontified t) 338 341 (face font-lock-keyword-face fontified t) 341 372 (fontified t) 372 384 (face font-lock-keyword-face fontified t) 384 406 (fontified t) 406 409 (face font-lock-comment-delimiter-face fontified t) 409 457 (face font-lock-comment-face fontified t) 457 602 (fontified t) 602 629 (face font-lock-keyword-face fontified t) 629 665 (fontified t) 665 716 (face slime-reader-conditional-face fontified t) 716 739 (fontified t) 739 742 (face font-lock-comment-delimiter-face fontified t) 742 790 (face font-lock-comment-face fontified t) 790 809 (fontified t) 809 812 (face font-lock-comment-delimiter-face fontified t) 812 870 (face font-lock-comment-face fontified t) 870 951 (fontified t) 951 956 (face font-lock-warning-face fontified t) 956 1000 (fontified t) 1000 1003 (face font-lock-comment-delimiter-face fontified t) 1003 1057 (face font-lock-comment-face fontified t) 1057 1113 (fontified t) 1113 1116 (face font-lock-keyword-face fontified t) 1116 1187 (fontified t) 1187 1189 (face font-lock-keyword-face fontified t) 1189 1330 (fontified t) 1330 1335 (face font-lock-keyword-face fontified t) 1335 1413 (fontified t) 1413 1417 (face font-lock-keyword-face fontified t) 1417 1498 (fontified t) 1498 1503 (fontified t) 1503 1532 (fontified t) 1532 1535 (face font-lock-comment-delimiter-face fontified t) 1535 1590 (face font-lock-comment-face fontified t) 1590 1691 (fontified t) 1691 1694 (face font-lock-comment-delimiter-face fontified t) 1694 1731 (face font-lock-comment-face fontified t) 1731 1759 (fontified t) 1759 1764 (face font-lock-warning-face fontified t) 1764 1791 (fontified t) 1791 1794 (face font-lock-comment-delimiter-face fontified t) 1794 1858 (face font-lock-comment-face fontified t) 1858 1869 (fontified t) 1869 1872 (face font-lock-comment-delimiter-face fontified t) 1872 1947 (face font-lock-comment-face fontified t) 1947 1959 (fontified t) 1959 1965 (face font-lock-keyword-face fontified t) 1965 1997 (fontified t) 1997 2011 (fontified t) 2011 2017 (face font-lock-keyword-face fontified t) 2017 2048 (fontified t) 2048 2049 (fontified t)) . -10237) (undo-tree-id27 . -2048) (undo-tree-id28 . -2049) (undo-tree-id29 . -181) (undo-tree-id30 . -719) (undo-tree-id31 . -719) (undo-tree-id32 . -719) (undo-tree-id33 . -719) (undo-tree-id34 . -1057) (undo-tree-id35 . -1435) (undo-tree-id36 . -1435) (undo-tree-id37 . -1503) (undo-tree-id38 . -1503) (undo-tree-id39 . -2049) 12286 (t 26976 14033 0 0)) nil (26976 36362 307860 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12554 . 12555) (nil fontified nil 10237 . 12555) (10237 . 12555)) nil (26976 36362 307835 0) 0 nil])
([nil nil ((12555 . 12556)) nil (26976 36362 307831 0) 0 nil])
([nil nil ((12555 . 12556) (t 26976 36362 0 0)) nil (26976 36367 834148 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12555) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) 12556) nil (26976 36367 834145 0) 0 nil])
([nil nil ((#("
#|
(defmacro with-rollback (&body body)
  \"Exécute BODY dans UNE connexion Postmodern unique, BEGIN au début, ROLLBACK à la fin.
Toutes les requêtes internes partagent la même *database*.\"
  `(lumen.data.db:with-conn
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect
          (progn ,@body)
       (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 356 (face font-lock-comment-face fontified t) 356 358 (face font-lock-comment-delimiter-face fontified t) 358 359 (fontified t)) . 21177) (undo-tree-id49 . -359) (t 26976 36367 0 0)) nil (26976 37468 303524 0) 0 nil])
([nil nil ((#("
#|
(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
Options :
  :timeout-ms <int>
Si le SQL a une clause RETURNING, renvoie la 1ère ligne en alist.\"
  (format t \"~&EXEC:PARAMS: ~A~%\" params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if #'keywordp params))
	 (x (print kpos))
         (args (if kpos (subseq params 0 kpos) params))
	 (x (print args))
         (opts (if kpos (subseq params kpos) '()))
	 (x (print opts))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
	 (x (print timeout-ms))
         (t0 (get-internal-real-time)))
    (format t \"~&EXEC:ARGS: ~A~%\" args)
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                ;; Chemin RETURNING : une seule exécution, on récupère la 1ère ligne.
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                ;; Chemin sans RETURNING : voie execute (aucun résultat), n = rows affected.
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            ;; métriques
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      (condition (c)
        (translate-db-error c)))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 495 (face font-lock-comment-face fontified t) 495 579 (face font-lock-comment-face fontified t) 579 2017 (face font-lock-comment-face fontified t) 2017 2019 (face font-lock-comment-delimiter-face fontified t)) . -16594) (undo-tree-id47 . -2019) (undo-tree-id48 . -707) 18613) nil (26976 37468 303521 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -16593) (undo-tree-id45 . -1) (undo-tree-id46 . -1) 16594) nil (26976 37468 303516 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))
        (g-result  (gensym \"RES\"))
        (g-error   (gensym \"ERR\")))
    `(block ,g-block
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         (loop
           (let ((,g-result nil)
                 (,g-error nil))
             
             ;; BLOC 1 : Tentative d'exécution protégée
             (handler-case
                 (setf ,g-result 
                       (multiple-value-list
                        (ensure-connection
                          #+postmodern
                          (postmodern:with-transaction () ,@body)
                          #-postmodern
                          (progn ,@body))))

               ;; Cas A : Erreur Métier -> On capture juste l'objet erreur
               (lumen.core.error:application-error (c)
                 (setf ,g-error c))

               ;; Cas B : Erreur Technique -> On capture et on analyse le retry
               (condition (c)
                 (let ((mapped (lumen.data.errors:map-db-error c)))
                   (if (and (< ,g-attempt ,g-retries)
                            (lumen.data.errors:retryable-db-error-p mapped))
                       ;; C'est un retry -> on ne setf pas g-error, le loop continuera
                       (progn
                         (incf ,g-attempt)
                         (when (plusp ,g-sleep)
                           (sleep (/ (max 0 ,g-sleep) 1000.0))))
                       
                       ;; C'est fatal -> on capture l'erreur mappée
                       (setf ,g-error mapped)))))

             ;; BLOC 2 : Action hors du contexte protégé (Safe Zone)
             (cond
               ;; S'il y a une erreur capturée, on la relance ICI, 
               ;; alors que la stack transactionnelle est déjà propre.
               (,g-error 
                (error ,g-error))
               
               ;; Si on a un résultat, on retourne
               (,g-result 
                (return-from ,g-block (values-list ,g-result)))
               
               ;; Sinon (cas du retry), on laisse la boucle (loop) continuer
               (t nil))))))))" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 42 (fontified t) 42 45 (face font-lock-keyword-face fontified t) 45 66 (fontified t) 66 71 (face font-lock-string-face fontified t) 71 101 (fontified t) 101 106 (face font-lock-string-face fontified t) 106 136 (fontified t) 136 143 (face font-lock-string-face fontified t) 143 173 (fontified t) 173 178 (face font-lock-string-face fontified t) 178 208 (fontified t) 208 213 (face font-lock-string-face fontified t) 213 243 (fontified t) 243 248 (face font-lock-string-face fontified t) 248 258 (fontified t) 258 263 (face font-lock-keyword-face fontified t) 263 281 (fontified t) 281 284 (face font-lock-keyword-face fontified t) 284 381 (fontified t) 381 385 (face font-lock-keyword-face fontified t) 385 398 (fontified t) 398 401 (face font-lock-keyword-face fontified t) 401 479 (fontified t) 479 482 (face font-lock-comment-delimiter-face fontified t) 482 522 (face font-lock-comment-face fontified t) 522 536 (fontified t) 536 548 (face font-lock-keyword-face fontified t) 548 736 (fontified t) 736 756 (face font-lock-keyword-face fontified t) 756 763 (face font-lock-keyword-face fontified t) 763 775 (fontified t) 775 801 (fontified t) 801 854 (face slime-reader-conditional-face fontified t) 854 874 (fontified t) 874 877 (face font-lock-comment-delimiter-face fontified t) 877 934 (face font-lock-comment-face fontified t) 934 1041 (fontified t) 1041 1044 (face font-lock-comment-delimiter-face fontified t) 1044 1106 (face font-lock-comment-face fontified t) 1106 1154 (fontified t) 1154 1157 (face font-lock-keyword-face fontified t) 1157 1224 (fontified t) 1224 1226 (face font-lock-keyword-face fontified t) 1226 1358 (fontified t) 1358 1361 (face font-lock-comment-delimiter-face fontified t) 1361 1422 (face font-lock-comment-face fontified t) 1422 1446 (fontified t) 1446 1451 (face font-lock-keyword-face fontified t) 1451 1521 (fontified t) 1521 1525 (face font-lock-keyword-face fontified t) 1525 1655 (fontified t) 1655 1658 (face font-lock-comment-delimiter-face fontified t) 1658 1700 (face font-lock-comment-face fontified t) 1700 1764 (fontified t) 1764 1767 (face font-lock-comment-delimiter-face fontified t) 1767 1820 (face font-lock-comment-face fontified t) 1820 1834 (fontified t) 1834 1838 (face font-lock-keyword-face fontified t) 1838 1854 (fontified t) 1854 1857 (face font-lock-comment-delimiter-face fontified t) 1857 1907 (face font-lock-comment-face fontified t) 1907 1922 (fontified t) 1922 1925 (face font-lock-comment-delimiter-face fontified t) 1925 1978 (face font-lock-comment-face fontified t) 1978 2021 (fontified t) 2021 2026 (face font-lock-warning-face fontified t) 2026 2069 (fontified t) 2069 2072 (face font-lock-comment-delimiter-face fontified t) 2072 2105 (face font-lock-comment-face fontified t) 2105 2149 (fontified t) 2149 2160 (face font-lock-keyword-face fontified t) 2160 2227 (fontified t) 2227 2230 (face font-lock-comment-delimiter-face fontified t) 2230 2275 (face font-lock-comment-face fontified t) 2275 2289 (face font-lock-comment-face fontified t) 2289 2318 (fontified t)) . -10237) (undo-tree-id2 . -2318) (undo-tree-id3 . -1136) (undo-tree-id4 . -1162) (undo-tree-id5 . -801) (undo-tree-id6 . -803) (undo-tree-id7 . -2289) (undo-tree-id8 . -2053) (undo-tree-id9 . -2289) 12555 (t 26976 37468 0 0)) nil (26976 39101 245139 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12934 . 12935) (nil fontified nil 10237 . 12935) (10237 . 12935)) nil (26976 39101 245132 0) 0 nil])
([nil nil ((12935 . 12936)) nil (26976 39101 245130 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12935) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 12936) nil (26976 39101 245127 0) 0 nil])
([nil nil ((12935 . 12937) (t 26976 39101 0 0)) nil (26976 39351 828202 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16444 . 16445) (nil fontified nil 12937 . 16445) (12937 . 16445)) nil (26976 39351 828201 0) 0 nil])
([nil nil ((9475 . 9477)) nil (26976 39351 828200 0) 0 nil])
([nil nil ((12938 . 12940)) nil (26976 39351 828199 0) 0 nil])
([nil nil ((12940 . 12941)) nil (26976 39351 828195 0) 0 nil])
([nil nil ((12941 . 12943) (t 26976 39351 0 0)) nil (26976 39794 249591 0) 0 nil])
([nil nil ((16453 . 16455)) nil (26976 39794 249590 0) 0 nil])
([nil nil ((16455 . 16457)) nil (26976 39794 249590 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19466 . 19467) (nil fontified nil 16457 . 19467) (16457 . 19467)) nil (26976 39794 249588 0) 0 nil])
([nil nil ((19467 . 19468)) nil (26976 39794 249584 0) 0 nil])
([nil nil ((#("
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))
        (g-outcome (gensym \"OUT\"))
        (g-payload (gensym \"PAY\")))
    
    `(block ,g-block
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         
         (loop
           (multiple-value-bind (,g-outcome ,g-payload)
               (handler-case
                   ;; EXÉCUTION
                   (values :success 
                           (multiple-value-list
                            (ensure-connection
                              #+postmodern
                              (postmodern:with-transaction () ,@body)
                              #-postmodern
                              (progn ,@body))))

                 ;; Cas A : Business Error (On capture Type + Message)
                 ;; On ne retourne PAS l'objet condition 'c' pour éviter le bug SBCL
                 (lumen.core.error:application-error (c)
                   (values :app-error 
                           (list (type-of c) (princ-to-string c))))

                 ;; Cas B : Erreur DB (On capture l'objet mappé, c'est safe ici)
                 (condition (c)
                   (let ((mapped (lumen.data.errors:map-db-error c)))
                     (if (and (< ,g-attempt ,g-retries)
                              (lumen.data.errors:retryable-db-error-p mapped))
                         (values :retry nil)
                         (values :db-error mapped)))))
             
             ;; SORTIE DE ZONE (Safe Zone)
             (case ,g-outcome
               (:success
                (return-from ,g-block (values-list ,g-payload)))
               
               ;; CLONAGE DE L'ERREUR MÉTIER (Le Fix)
               (:app-error
                (destructuring-bind (err-type err-msg) ,g-payload
                  ;; On nettoie le message car princ-to-string inclut parfois le préfixe du Report
                  ;; ex: \"Business Error: XXX\" -> \"XXX\"
                  (let* ((prefix \"Business Error: \")
                         (clean-msg (if (search prefix err-msg) 
                                        (subseq err-msg (length prefix)) 
                                        err-msg)))
                    ;; On signale une NOUVELLE instance.
                    ;; On suppose que l'erreur accepte :message (ce qui est le cas de business-error)
                    (error (make-condition err-type :message clean-msg)))))
               
               ;; Erreur DB standard
               (:db-error
                (error ,g-payload))
               
               (:retry
                (incf ,g-attempt)
                (when (plusp ,g-sleep)
                  (sleep (/ (max 0 ,g-sleep) 1000.0)))))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 21 (fontified t) 21 25 (face font-lock-type-face fontified t) 25 37 (fontified t) 37 52 (face font-lock-builtin-face fontified t) 52 141 (fontified t) 141 146 (face font-lock-type-face fontified t) 146 156 (fontified t) 156 163 (face font-lock-keyword-face fontified t) 163 197 (fontified t) 197 200 (face font-lock-keyword-face fontified t) 200 221 (fontified t) 221 226 (face font-lock-string-face fontified t) 226 256 (fontified t) 256 261 (face font-lock-string-face fontified t) 261 291 (fontified t) 291 298 (face font-lock-string-face fontified t) 298 328 (fontified t) 328 333 (face font-lock-string-face fontified t) 333 363 (fontified t) 363 368 (face font-lock-string-face fontified t) 368 398 (fontified t) 398 403 (face font-lock-string-face fontified t) 403 418 (fontified t) 418 423 (face font-lock-keyword-face fontified t) 423 441 (fontified t) 441 444 (face font-lock-keyword-face fontified t) 444 551 (fontified t) 551 555 (face font-lock-keyword-face fontified t) 555 568 (fontified t) 568 587 (face font-lock-keyword-face fontified t) 587 628 (fontified t) 628 640 (face font-lock-keyword-face fontified t) 640 660 (fontified t) 660 663 (face font-lock-comment-delimiter-face fontified t) 663 673 (face font-lock-comment-face fontified t) 673 700 (fontified t) 700 708 (face font-lock-builtin-face fontified t) 708 879 (fontified t) 879 906 (face font-lock-keyword-face fontified t) 906 948 (fontified t) 948 1005 (face slime-reader-conditional-face fontified t) 1005 1027 (fontified t) 1027 1030 (face font-lock-comment-delimiter-face fontified t) 1030 1081 (face font-lock-comment-face fontified t) 1081 1098 (fontified t) 1098 1101 (face font-lock-comment-delimiter-face fontified t) 1101 1166 (face font-lock-comment-face fontified t) 1166 1250 (fontified t) 1250 1260 (face font-lock-builtin-face fontified t) 1260 1348 (fontified t) 1348 1351 (face font-lock-comment-delimiter-face fontified t) 1351 1412 (face font-lock-comment-face fontified t) 1412 1464 (fontified t) 1464 1467 (face font-lock-keyword-face fontified t) 1467 1501 (fontified t) 1501 1514 (fontified t) 1514 1536 (fontified t) 1536 1538 (face font-lock-keyword-face fontified t) 1538 1682 (fontified t) 1682 1688 (face font-lock-builtin-face fontified t) 1688 1727 (fontified t) 1727 1736 (face font-lock-builtin-face fontified t) 1736 1776 (fontified t) 1776 1779 (face font-lock-comment-delimiter-face fontified t) 1779 1806 (face font-lock-comment-face fontified t) 1806 1820 (fontified t) 1820 1824 (face font-lock-keyword-face fontified t) 1824 1852 (fontified t) 1852 1860 (face font-lock-builtin-face fontified t) 1860 1878 (fontified t) 1878 1889 (face font-lock-keyword-face fontified t) 1889 1957 (fontified t) 1957 1960 (face font-lock-comment-delimiter-face fontified t) 1960 1996 (face font-lock-comment-face fontified t) 1996 2012 (fontified t) 2012 2022 (face font-lock-builtin-face fontified t) 2022 2040 (fontified t) 2040 2058 (face font-lock-keyword-face fontified t) 2058 2107 (fontified t) 2107 2110 (face font-lock-comment-delimiter-face fontified t) 2110 2188 (face font-lock-comment-face fontified t) 2188 2206 (fontified t) 2206 2209 (face font-lock-comment-delimiter-face fontified t) 2209 2244 (face font-lock-comment-face fontified t) 2244 2263 (fontified t) 2263 2267 (face font-lock-keyword-face fontified t) 2267 2277 (fontified t) 2277 2295 (face font-lock-string-face fontified t) 2295 2334 (fontified t) 2334 2336 (face font-lock-keyword-face fontified t) 2336 2507 (fontified t) 2507 2510 (face font-lock-comment-delimiter-face fontified t) 2510 2544 (face font-lock-comment-face fontified t) 2544 2564 (fontified t) 2564 2567 (face font-lock-comment-delimiter-face fontified t) 2567 2646 (face font-lock-comment-face fontified t) 2646 2667 (fontified t) 2667 2672 (face font-lock-warning-face fontified t) 2672 2698 (fontified t) 2698 2706 (face font-lock-builtin-face fontified t) 2706 2753 (fontified t) 2753 2756 (face font-lock-comment-delimiter-face fontified t) 2756 2775 (face font-lock-comment-face fontified t) 2775 2791 (fontified t) 2791 2800 (face font-lock-builtin-face fontified t) 2800 2818 (fontified t) 2818 2823 (face font-lock-warning-face fontified t) 2823 2869 (fontified t) 2869 2875 (face font-lock-builtin-face fontified t) 2875 2927 (fontified t) 2927 2931 (face font-lock-keyword-face fontified t) 2931 2949 (fontified t) 2949 3010 (fontified t) 3010 3011 (rear-nonsticky t fontified t) 3011 3012 (fontified t)) . -16456) (undo-tree-id0 . -3012) (undo-tree-id1 . -3012) (undo-tree-id2 . -1926) (undo-tree-id3 . -1926) (undo-tree-id4 . -3012) (undo-tree-id5 . -1330) (undo-tree-id6 . -3012) (undo-tree-id7 . -2089) (undo-tree-id8 . -1) (undo-tree-id9 . -3012) 19468 (t 26976 39794 0 0)) nil (26976 40260 68534 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19186 . 19187) (nil fontified nil 16456 . 19187) (16456 . 19187)) nil (26976 40260 68510 0) 0 nil])
([nil nil ((19187 . 19188)) nil (26976 40260 68506 0) 0 nil])
([nil current ((#("#|
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
		      (retries 0) (sleep-ms 50))
                   &body body)
  \"Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts.

Transaction avec **retries** automatiques sur erreurs retryables (deadlock/serialization/timeout).
Arguments :
  :isolation  — décoratif pour l’instant (hook possible si tu veux paramétrer).
  :read-only  — décoratif / futur.
  :retries    — nombre de tentatives additionnelles (0 = pas de retry).
  :sleep-ms   — temps d’attente entre tentatives (backoff linéaire simple).
Exemple : (with-tx (:retries 3 :sleep-ms 100) ...)\"
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))     ;; Bloc de sortie global
        (g-outcome (gensym \"OUT\"))     ;; Résultat de l'exécution (:success, :retry, :error)
        (g-payload (gensym \"PAY\")))    ;; Donnée associée (valeurs ou condition)
    
    `(block ,g-block
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         
         ;; BOUCLE DE RETRY
         (loop
           ;; 1. EXÉCUTION PROTÉGÉE
           ;; On capture tout ce qui se passe et on le stocke dans des variables.
           ;; On ne fait AUCUN saut (return/error) ici.
           (multiple-value-bind (,g-outcome ,g-payload)
               (handler-case
                   ;; Essai nominal
                   (values :success 
                           (multiple-value-list
                            (ensure-connection
                              #+postmodern
                              (postmodern:with-transaction () ,@body)
                              #-postmodern
                              (progn ,@body))))
                 
                 ;; Cas A : Erreur Métier (Business/Application Error)
                 ;; On capture l'objet erreur et on marque comme :error (non retryable)
                 (lumen.core.error:application-error (c)
                   (values :error c))
                 
                 ;; Cas B : Erreur Technique (DB Error)
                 (condition (c)
                   (let ((mapped (lumen.data.errors:map-db-error c)))
                     (if (and (< ,g-attempt ,g-retries)
                              (lumen.data.errors:retryable-db-error-p mapped))
                         (values :retry nil) ;; On demande un retry
                         (values :error mapped))))) ;; Erreur fatale
             
             ;; 2. LOGIQUE DE CONTRÔLE (HORS TRANSACTION)
             ;; Ici, la transaction est fermée (commit ou rollback fait).
             ;; La stack est propre. On peut agir.
             (case ,g-outcome
               
               ;; SUCCÈS : On retourne les valeurs stockées
               (:success
                (return-from ,g-block (values-list ,g-payload)))
               
               ;; ERREUR : On relance l'exception (vers le middleware)
               (:error
                (error ,g-payload))
               
               ;; RETRY : On dort et on laisse le (loop) refaire un tour
               (:retry
                (incf ,g-attempt)
                (when (plusp ,g-sleep)
                  (sleep (/ (max 0 ,g-sleep) 1000.0)))))))))))
|#
#|
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))
        (g-outcome (gensym \"OUT\"))
        (g-payload (gensym \"PAY\")))
    
    `(block ,g-block
       (format *terminal-io* \"~&[TX-DEBUG] >>> DÉBUT BLOC with-tx~%\")
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         
         (loop
           (format *terminal-io* \"~&[TX-DEBUG] --- Début LOOP (Essai ~A) ---~%\" ,g-attempt)
           
           (multiple-value-bind (,g-outcome ,g-payload)
               (handler-case
                   (progn
                     (format *terminal-io* \"~&[TX-DEBUG] Avant ensure-connection~%\")
                     (let ((res 
                            (ensure-connection
                              #+postmodern
                              (postmodern:with-transaction ()
                                (format *terminal-io* \"~&[TX-DEBUG] DEDANS Transaction DB. Exécution du BODY...~%\")
                                (let ((r (progn ,@body)))
                                  (format *terminal-io* \"~&[TX-DEBUG] BODY terminé avec SUCCÈS.~%\")
                                  r))
                              #-postmodern
                              (progn ,@body))))
                       
                       (format *terminal-io* \"~&[TX-DEBUG] Transaction COMMITÉE.~%\")
                       (values :success (multiple-value-list res))))

                 ;; Cas A : Business Error
                 (qalm.backend.core.error:business-error (c)
                   (format *terminal-io* \"~&[TX-DEBUG] !!! CATCHED BUSINESS-ERROR: ~A~%\" c)
                   (values :error c))

                 ;; Cas B : Erreur générique (pour voir ce qui tombe vraiment)
                 (error (c)
                   (format *terminal-io* \"~&[TX-DEBUG] !!! CATCHED ERROR (Type: ~S): ~A~%\" (type-of c) c)
                   (let ((mapped (lumen.data.errors:map-db-error c)))
                     (if (and (< ,g-attempt ,g-retries)
                              (lumen.data.errors:retryable-db-error-p mapped))
                         (progn
                           (format *terminal-io* \"~&[TX-DEBUG] -> Retryable~%\")
                           (values :retry nil))
                         (progn
                           (format *terminal-io* \"~&[TX-DEBUG] -> FATAL DB Error~%\")
                           (values :error mapped))))))
             
             ;; ZONE DE SÉCURITÉ
             (format *terminal-io* \"~&[TX-DEBUG] HORS handler-case. Outcome: ~A~%\" ,g-outcome)
             
             (case ,g-outcome
               (:success
                (format *terminal-io* \"~&[TX-DEBUG] <<< RETOUR SUCCÈS~%\")
                (return-from ,g-block (values-list ,g-payload)))
               
               (:error
                (format *terminal-io* \"~&[TX-DEBUG] <<< RELANCE ERREUR (Signal)~%\")
                ;; C'est souvent ICI que le CONTROL-ERROR arrive
                (error ,g-payload))
               
               (:retry
                (format *terminal-io* \"~&[TX-DEBUG] ... Sleeping for retry ...~%\")
                (incf ,g-attempt)
                (when (plusp ,g-sleep)
                  (sleep (/ (max 0 ,g-sleep) 1000.0)))))))))))
|#" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 3 (face font-lock-comment-face fontified t) 3 4 (face font-lock-comment-face fontified t) 4 12 (face font-lock-comment-face fontified t) 12 13 (face font-lock-comment-face fontified t) 13 20 (face font-lock-comment-face fontified t) 20 23 (face font-lock-comment-face fontified t) 23 27 (face font-lock-comment-face fontified t) 27 39 (face font-lock-comment-face fontified t) 39 54 (face font-lock-comment-face fontified t) 54 72 (face font-lock-comment-face fontified t) 72 126 (face font-lock-comment-face fontified t) 126 131 (face font-lock-comment-face fontified t) 131 140 (face font-lock-comment-face fontified t) 140 761 (face font-lock-comment-face fontified t) 761 765 (face font-lock-comment-face fontified t) 765 772 (face font-lock-comment-face fontified t) 772 806 (face font-lock-comment-face fontified t) 806 809 (face font-lock-comment-face fontified t) 809 830 (face font-lock-comment-face fontified t) 830 835 (face font-lock-comment-face fontified t) 835 865 (face font-lock-comment-face fontified t) 865 870 (face font-lock-comment-face fontified t) 870 900 (face font-lock-comment-face fontified t) 900 907 (face font-lock-comment-face fontified t) 907 937 (face font-lock-comment-face fontified t) 937 942 (face font-lock-comment-face fontified t) 942 949 (face font-lock-comment-face fontified t) 949 952 (face font-lock-comment-face fontified t) 952 974 (face font-lock-comment-face fontified t) 974 1001 (face font-lock-comment-face fontified t) 1001 1006 (face font-lock-comment-face fontified t) 1006 1013 (face font-lock-comment-face fontified t) 1013 1016 (face font-lock-comment-face fontified t) 1016 1067 (face font-lock-comment-face fontified t) 1067 1094 (face font-lock-comment-face fontified t) 1094 1099 (face font-lock-comment-face fontified t) 1099 1106 (face font-lock-comment-face fontified t) 1106 1109 (face font-lock-comment-face fontified t) 1109 1148 (face font-lock-comment-face fontified t) 1148 1159 (face font-lock-comment-face fontified t) 1159 1164 (face font-lock-comment-face fontified t) 1164 1182 (face font-lock-comment-face fontified t) 1182 1185 (face font-lock-comment-face fontified t) 1185 1243 (face font-lock-comment-face fontified t) 1243 1272 (face font-lock-comment-face fontified t) 1272 1291 (face font-lock-comment-face fontified t) 1291 1294 (face font-lock-comment-face fontified t) 1294 1310 (face font-lock-comment-face fontified t) 1310 1320 (face font-lock-comment-face fontified t) 1320 1324 (face font-lock-comment-face fontified t) 1324 1336 (face font-lock-comment-face fontified t) 1336 1339 (face font-lock-comment-face fontified t) 1339 1361 (face font-lock-comment-face fontified t) 1361 1372 (face font-lock-comment-face fontified t) 1372 1375 (face font-lock-comment-face fontified t) 1375 1443 (face font-lock-comment-face fontified t) 1443 1454 (face font-lock-comment-face fontified t) 1454 1457 (face font-lock-comment-face fontified t) 1457 1499 (face font-lock-comment-face fontified t) 1499 1511 (face font-lock-comment-face fontified t) 1511 1530 (face font-lock-comment-face fontified t) 1530 1571 (face font-lock-comment-face fontified t) 1571 1572 (face font-lock-comment-face fontified t) 1572 1583 (face font-lock-comment-face fontified t) 1583 1584 (face font-lock-comment-face fontified t) 1584 1603 (face font-lock-comment-face fontified t) 1603 1606 (face font-lock-comment-face fontified t) 1606 1620 (face font-lock-comment-face fontified t) 1620 1647 (face font-lock-comment-face fontified t) 1647 1655 (face font-lock-comment-face fontified t) 1655 1826 (face font-lock-comment-face fontified t) 1826 1853 (face font-lock-comment-face fontified t) 1853 1895 (face font-lock-comment-face fontified t) 1895 1952 (face font-lock-comment-face fontified t) 1952 1991 (face font-lock-comment-face fontified t) 1991 1994 (face font-lock-comment-face fontified t) 1994 2045 (face font-lock-comment-face fontified t) 2045 2062 (face font-lock-comment-face fontified t) 2062 2065 (face font-lock-comment-face fontified t) 2065 2133 (face font-lock-comment-face fontified t) 2133 2217 (face font-lock-comment-face fontified t) 2217 2223 (face font-lock-comment-face fontified t) 2223 2263 (face font-lock-comment-face fontified t) 2263 2266 (face font-lock-comment-face fontified t) 2266 2302 (face font-lock-comment-face fontified t) 2302 2354 (face font-lock-comment-face fontified t) 2354 2357 (face font-lock-comment-face fontified t) 2357 2426 (face font-lock-comment-face fontified t) 2426 2428 (face font-lock-comment-face fontified t) 2428 2572 (face font-lock-comment-face fontified t) 2572 2578 (face font-lock-comment-face fontified t) 2578 2584 (face font-lock-comment-face fontified t) 2584 2587 (face font-lock-comment-face fontified t) 2587 2607 (face font-lock-comment-face fontified t) 2607 2640 (face font-lock-comment-face fontified t) 2640 2646 (face font-lock-comment-face fontified t) 2646 2659 (face font-lock-comment-face fontified t) 2659 2662 (face font-lock-comment-face fontified t) 2662 2676 (face font-lock-comment-face fontified t) 2676 2703 (face font-lock-comment-face fontified t) 2703 2706 (face font-lock-comment-face fontified t) 2706 2748 (face font-lock-comment-face fontified t) 2748 2761 (face font-lock-comment-face fontified t) 2761 2764 (face font-lock-comment-face fontified t) 2764 2772 (face font-lock-comment-face fontified t) 2772 2822 (face font-lock-comment-face fontified t) 2822 2835 (face font-lock-comment-face fontified t) 2835 2838 (face font-lock-comment-face fontified t) 2838 2873 (face font-lock-comment-face fontified t) 2873 2887 (face font-lock-comment-face fontified t) 2887 2891 (face font-lock-comment-face fontified t) 2891 2934 (face font-lock-comment-face fontified t) 2934 2937 (face font-lock-comment-face fontified t) 2937 2979 (face font-lock-comment-face fontified t) 2979 2995 (face font-lock-comment-face fontified t) 2995 3003 (face font-lock-comment-face fontified t) 3003 3021 (face font-lock-comment-face fontified t) 3021 3032 (face font-lock-comment-face fontified t) 3032 3084 (face font-lock-comment-face fontified t) 3084 3085 (face font-lock-comment-face fontified t) 3085 3100 (face font-lock-comment-face fontified t) 3100 3103 (face font-lock-comment-face fontified t) 3103 3156 (face font-lock-comment-face fontified t) 3156 3172 (face font-lock-comment-face fontified t) 3172 3178 (face font-lock-comment-face fontified t) 3178 3196 (face font-lock-comment-face fontified t) 3196 3201 (face font-lock-comment-face fontified t) 3201 3246 (face font-lock-comment-face fontified t) 3246 3249 (face font-lock-comment-face fontified t) 3249 3304 (face font-lock-comment-face fontified t) 3304 3320 (face font-lock-comment-face fontified t) 3320 3326 (face font-lock-comment-face fontified t) 3326 3378 (face font-lock-comment-face fontified t) 3378 3382 (face font-lock-comment-face fontified t) 3382 3400 (face font-lock-comment-face fontified t) 3400 3463 (face font-lock-comment-face fontified t) 3463 3465 (face font-lock-comment-delimiter-face fontified t) 3465 3466 (fontified t) 3466 3468 (face font-lock-comment-delimiter-face fontified t) 3468 3469 (face font-lock-comment-face fontified t) 3469 3470 (face font-lock-comment-face fontified t) 3470 3478 (face font-lock-comment-face fontified t) 3478 3479 (face font-lock-comment-face fontified t) 3479 3486 (face font-lock-comment-face fontified t) 3486 3489 (face font-lock-comment-face fontified t) 3489 3493 (face font-lock-comment-face fontified t) 3493 3505 (face font-lock-comment-face fontified t) 3505 3520 (face font-lock-comment-face fontified t) 3520 3609 (face font-lock-comment-face fontified t) 3609 3614 (face font-lock-comment-face fontified t) 3614 3624 (face font-lock-comment-face fontified t) 3624 3631 (face font-lock-comment-face fontified t) 3631 3665 (face font-lock-comment-face fontified t) 3665 3668 (face font-lock-comment-face fontified t) 3668 3689 (face font-lock-comment-face fontified t) 3689 3694 (face font-lock-comment-face fontified t) 3694 3724 (face font-lock-comment-face fontified t) 3724 3729 (face font-lock-comment-face fontified t) 3729 3759 (face font-lock-comment-face fontified t) 3759 3766 (face font-lock-comment-face fontified t) 3766 3796 (face font-lock-comment-face fontified t) 3796 3801 (face font-lock-comment-face fontified t) 3801 3831 (face font-lock-comment-face fontified t) 3831 3836 (face font-lock-comment-face fontified t) 3836 3866 (face font-lock-comment-face fontified t) 3866 3871 (face font-lock-comment-face fontified t) 3871 3886 (face font-lock-comment-face fontified t) 3886 3891 (face font-lock-comment-face fontified t) 3891 3930 (face font-lock-comment-face fontified t) 3930 3969 (face font-lock-comment-face fontified t) 3969 3979 (face font-lock-comment-face fontified t) 3979 3982 (face font-lock-comment-face fontified t) 3982 4089 (face font-lock-comment-face fontified t) 4089 4093 (face font-lock-comment-face fontified t) 4093 4127 (face font-lock-comment-face fontified t) 4127 4173 (face font-lock-comment-face fontified t) 4173 4210 (face font-lock-comment-face fontified t) 4210 4229 (face font-lock-comment-face fontified t) 4229 4270 (face font-lock-comment-face fontified t) 4270 4282 (face font-lock-comment-face fontified t) 4282 4303 (face font-lock-comment-face fontified t) 4303 4308 (face font-lock-comment-face fontified t) 4308 4352 (face font-lock-comment-face fontified t) 4352 4392 (face font-lock-comment-face fontified t) 4392 4416 (face font-lock-comment-face fontified t) 4416 4419 (face font-lock-comment-face fontified t) 4419 4548 (face font-lock-comment-face fontified t) 4548 4575 (face font-lock-comment-face fontified t) 4575 4590 (face font-lock-comment-face fontified t) 4590 4633 (face font-lock-comment-face fontified t) 4633 4693 (face font-lock-comment-face fontified t) 4693 4695 (face font-lock-comment-face fontified t) 4695 4728 (face font-lock-comment-face fontified t) 4728 4731 (face font-lock-comment-face fontified t) 4731 4737 (face font-lock-comment-face fontified t) 4737 4742 (face font-lock-comment-face fontified t) 4742 4809 (face font-lock-comment-face fontified t) 4809 4851 (face font-lock-comment-face fontified t) 4851 4921 (face font-lock-comment-face fontified t) 4921 4967 (face font-lock-comment-face fontified t) 4967 4969 (face font-lock-comment-face fontified t) 4969 4978 (face font-lock-comment-face fontified t) 4978 4982 (face font-lock-comment-face fontified t) 4982 5051 (face font-lock-comment-face fontified t) 5051 5089 (face font-lock-comment-face fontified t) 5089 5122 (face font-lock-comment-face fontified t) 5122 5130 (face font-lock-comment-face fontified t) 5130 5178 (face font-lock-comment-face fontified t) 5178 5181 (face font-lock-comment-face fontified t) 5181 5204 (face font-lock-comment-face fontified t) 5204 5306 (face font-lock-comment-face fontified t) 5306 5353 (face font-lock-comment-face fontified t) 5353 5384 (face font-lock-comment-face fontified t) 5384 5390 (face font-lock-comment-face fontified t) 5390 5413 (face font-lock-comment-face fontified t) 5413 5416 (face font-lock-comment-face fontified t) 5416 5475 (face font-lock-comment-face fontified t) 5475 5493 (face font-lock-comment-face fontified t) 5493 5498 (face font-lock-comment-face fontified t) 5498 5544 (face font-lock-comment-face fontified t) 5544 5593 (face font-lock-comment-face fontified t) 5593 5629 (face font-lock-comment-face fontified t) 5629 5632 (face font-lock-comment-face fontified t) 5632 5701 (face font-lock-comment-face fontified t) 5701 5703 (face font-lock-comment-face fontified t) 5703 5840 (face font-lock-comment-face fontified t) 5840 5845 (face font-lock-comment-face fontified t) 5845 5895 (face font-lock-comment-face fontified t) 5895 5924 (face font-lock-comment-face fontified t) 5924 5961 (face font-lock-comment-face fontified t) 5961 5967 (face font-lock-comment-face fontified t) 5967 6000 (face font-lock-comment-face fontified t) 6000 6005 (face font-lock-comment-face fontified t) 6005 6055 (face font-lock-comment-face fontified t) 6055 6089 (face font-lock-comment-face fontified t) 6089 6126 (face font-lock-comment-face fontified t) 6126 6132 (face font-lock-comment-face fontified t) 6132 6173 (face font-lock-comment-face fontified t) 6173 6176 (face font-lock-comment-face fontified t) 6176 6193 (face font-lock-comment-face fontified t) 6193 6228 (face font-lock-comment-face fontified t) 6228 6275 (face font-lock-comment-face fontified t) 6275 6316 (face font-lock-comment-face fontified t) 6316 6320 (face font-lock-comment-face fontified t) 6320 6348 (face font-lock-comment-face fontified t) 6348 6356 (face font-lock-comment-face fontified t) 6356 6395 (face font-lock-comment-face fontified t) 6395 6429 (face font-lock-comment-face fontified t) 6429 6448 (face font-lock-comment-face fontified t) 6448 6459 (face font-lock-comment-face fontified t) 6459 6482 (face font-lock-comment-face fontified t) 6482 6496 (face font-lock-comment-face fontified t) 6496 6528 (face font-lock-comment-face fontified t) 6528 6534 (face font-lock-comment-face fontified t) 6534 6573 (face font-lock-comment-face fontified t) 6573 6617 (face font-lock-comment-face fontified t) 6617 6635 (face font-lock-comment-face fontified t) 6635 6638 (face font-lock-comment-face fontified t) 6638 6684 (face font-lock-comment-face fontified t) 6684 6701 (face font-lock-comment-face fontified t) 6701 6706 (face font-lock-comment-face fontified t) 6706 6752 (face font-lock-comment-face fontified t) 6752 6758 (face font-lock-comment-face fontified t) 6758 6797 (face font-lock-comment-face fontified t) 6797 6840 (face font-lock-comment-face fontified t) 6840 6893 (face font-lock-comment-face fontified t) 6893 6897 (face font-lock-comment-face fontified t) 6897 6976 (face font-lock-comment-face fontified t) 6976 6977 (face font-lock-comment-face fontified t rear-nonsticky t) 6977 6978 (face font-lock-comment-face fontified t) 6978 6980 (face font-lock-comment-delimiter-face fontified t)) . 9475) (undo-tree-id10 . -6980) (undo-tree-id11 . -3462) (undo-tree-id12 . -3463) (undo-tree-id13 . -3465) (undo-tree-id14 . -3466) (undo-tree-id15 . -6922) (undo-tree-id16 . -6978) (undo-tree-id17 . -3469) (undo-tree-id18 . -6980) (undo-tree-id19 . -6980) (t 26976 40260 0 0)) nil (26976 40929 188970 0) 0 nil])
nil
