(undo-tree-save-format-version . 1)
"76bdda19d06cbfd708e35ba1a6b2bc798be74b2e"
[nil nil nil nil (26806 46357 496849 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 9310 . 9311) (nil fontified nil 1 . 9311) (1 . 9311) (t . -1)) nil (26806 46357 496848 0) 0 nil])
([nil nil ((47 . 51)) nil (26806 46357 496847 0) 0 nil])
([nil nil ((#("e" 0 1 (face font-lock-type-face fontified t)) . -50) (undo-tree-id4 . -1) 51) nil (26806 46357 496846 0) 0 nil])
([nil nil ((50 . 52)) nil (26806 46357 496844 0) 0 nil])
([nil nil ((856 . 861)) nil (26806 46357 496844 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-type-face fontified t)) . -47) (undo-tree-id2 . -1) (undo-tree-id3 . -1) 48) nil (26806 46357 496843 0) 0 nil])
([nil nil ((47 . 48)) nil (26806 46357 496841 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -856) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 857) nil (26806 46357 496839 0) 0 nil])
([nil nil ((856 . 857)) nil (26806 46357 496824 0) 0 nil])
([nil nil ((1731 . 1741) (#(" " 0 1 (fontified nil)) . 1730) (undo-tree-id5 . -1) (1731 . 1732) (t 26806 46357 0 0)) nil (26806 53567 733801 0) 0 nil])
([nil nil ((1 . 6) (t 26806 53567 0 0)) nil (26806 55129 781433 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -1) (undo-tree-id0 . -1) (#("e" 0 1 (fontified t)) . -2) (undo-tree-id1 . -1) (#("p" 0 1 (fontified t)) . -3) (undo-tree-id2 . -1) (#("o" 0 1 (fontified t)) . -4) (undo-tree-id3 . -1) (#("-" 0 1 (fontified t)) . -5) (undo-tree-id4 . -1) 6) nil (26806 55129 781431 0) 0 nil])
([nil nil ((6173 . 6175)) nil (26806 55129 781418 0) 0 nil])
([nil nil ((6175 . 6176)) nil (26806 55129 781418 0) 0 nil])
([nil nil ((6207 . 6208)) nil (26806 55129 781417 0) 0 nil])
([nil nil ((6208 . 6210)) nil (26806 55129 781413 0) 0 nil])
([nil nil ((7308 . 7309) (t 26806 55129 0 0)) nil (26806 55218 739910 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7315 . 7316) (nil fontified nil 7309 . 7316) (7309 . 7316)) nil (26806 58422 936426 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1420 . 1421) (nil fontified nil 1420 . 1421) (nil fontified nil 1419 . 1420) (nil fontified nil 1414 . 1419) (nil fontified nil 1406 . 1414) (nil fontified nil 1405 . 1406) (nil fontified nil 1404 . 1405) (nil fontified nil 1384 . 1404) (nil fontified nil 1383 . 1384) (1383 . 1421) (t 26806 55218 0 0)) nil (26807 801 302382 0) 0 nil] [nil nil ((nil rear-nonsticky nil 1424 . 1425) (nil fontified nil 1424 . 1425) (nil fontified nil 1414 . 1424) (nil fontified nil 1409 . 1414) (nil fontified nil 1397 . 1409) (nil fontified nil 1396 . 1397) (nil fontified nil 1384 . 1396) (nil fontified nil 1383 . 1384) (1383 . 1425) (t 26806 55218 0 0)) ((#("(:import-from :lumen.utils
    :alist-get)" 0 1 (fontified nil) 1 13 (face font-lock-builtin-face fontified nil) 13 14 (fontified nil) 14 26 (face font-lock-builtin-face fontified nil) 26 27 (fontified nil) 27 31 (fontified nil) 31 41 (face font-lock-builtin-face fontified nil) 41 42 (rear-nonsticky nil fontified nil)) . 1383) (undo-tree-id24 . -42) (undo-tree-id25 . -8) (undo-tree-id26 . -8) (undo-tree-id27 . -27) (undo-tree-id28 . -27) (nil fontified t 1409 . 1410) (nil rear-nonsticky t 1424 . 1425)) (26806 58422 570949 0) 0 nil] [nil nil ((#("(cdr (assoc :scopes jwt)) (cdr (assoc \"scopes\" jwt))" 0 12 (fontified t) 12 19 (face font-lock-builtin-face fontified t) 19 38 (fontified t) 38 46 (face font-lock-string-face fontified t) 46 52 (fontified t)) . -1383) (undo-tree-id5 . -52) (undo-tree-id6 . -52) (undo-tree-id7 . -52) (undo-tree-id8 . -52) (undo-tree-id9 . -52) (undo-tree-id10 . -52) (undo-tree-id11 . -52) (undo-tree-id12 . -52) (undo-tree-id13 . -52) (undo-tree-id14 . -52) (undo-tree-id15 . -52) (undo-tree-id16 . -52) (undo-tree-id17 . -52) (undo-tree-id18 . -52) 1435 (t 26806 55218 0 0)) ((1383 . 1435)) (26806 58349 450752 0) 0 nil])
([nil nil ((1421 . 1422)) nil (26807 801 302380 0) 0 nil])
([nil nil ((1425 . 1426)) ((#(" " 0 1 (fontified t)) . 1425)) (26806 58422 570905 0) 0 nil])
([nil nil ((nil fontified nil 1403 . 1404) (nil fontified nil 1383 . 1403) (1383 . 1404)) ((#("lumen.utils:alist-get" 0 20 (fontified nil slime-repl-old-input 10) 20 21 (fontified nil rear-nonsticky t slime-repl-old-input 10)) . 1383) (undo-tree-id23 . -21) (nil fontified t 1403 . 1404)) (26806 58349 246095 0) 0 nil])
([nil nil ((#("email" 0 4 (face font-lock-builtin-face fontified t) 4 5 (face font-lock-builtin-face fontified t rear-nonsticky t)) . -1415) (undo-tree-id31 . -5) 1420) nil (26807 801 302380 0) 0 nil])
nil
([nil nil ((1404 . 1405)) ((#(" " 0 1 (fontified t)) . 1404) (undo-tree-id22 . -1)) (26806 58349 51438 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1420 . 1421) (nil fontified nil 1415 . 1421) (1415 . 1421)) nil (26807 801 302378 0) 0 nil])
([nil nil ((1405 . 1408)) ((#("jwt" 0 3 (fontified t)) . 1405) (undo-tree-id21 . -3)) (26806 58348 861624 0) 0 nil])
([nil nil ((#("payload" 0 7 (fontified t)) . -1406) (undo-tree-id30 . -7) 1413) nil (26807 801 302377 0) 0 nil])
([nil nil ((1408 . 1409)) ((#(" " 0 1 (fontified t)) . 1408) (undo-tree-id20 . -1)) (26806 58348 702003 0) 0 nil])
([nil nil ((1406 . 1409)) nil (26807 801 302375 0) 0 nil])
([nil nil ((1409 . 1410)) ((#(":" 0 1 (fontified t)) . 1409) (undo-tree-id19 . -1)) (26806 58348 701928 0) 0 nil])
([nil nil ((#(" (cdr (assoc :scopes jwt)) (cdr (assoc \"scopes\" jwt))" 0 1 (fontified t) 1 13 (fontified t) 13 20 (face font-lock-builtin-face fontified t) 20 39 (fontified t) 39 47 (face font-lock-string-face fontified t) 47 53 (fontified t)) . -1418) (undo-tree-id29 . -53) 1471) nil (26807 801 302372 0) 0 nil])
nil
([nil nil ((508 . 509) (t 26807 801 0 0)) nil (26808 24276 940973 0) 0 nil])
([nil nil ((509 . 517)) nil (26808 24276 940973 0) 0 nil])
([nil nil ((509 . 526) (#("ensure-c" 0 8 (fontified t)) . -509) (undo-tree-id15 . -8) 517) nil (26808 24276 940972 0) 0 nil])
([nil nil ((509 . 510)) nil (26808 24276 940971 0) 0 nil])
([nil nil ((527 . 528)) nil (26808 24276 940971 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-builtin-face fontified t)) . -527) (undo-tree-id14 . -1) 528) nil (26808 24276 940970 0) 0 nil])
([nil nil ((3790 . 3796)) nil (26808 24276 940969 0) 0 nil])
([nil nil ((3796 . 3801)) nil (26808 24276 940969 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -3797) (undo-tree-id10 . -1) (#("n" 0 1 (fontified t)) . -3798) (undo-tree-id11 . -1) (#("s" 0 1 (fontified t)) . -3799) (undo-tree-id12 . -1) (#("u" 0 1 (fontified t)) . -3800) (undo-tree-id13 . -1) 3801) nil (26808 24276 940968 0) 0 nil])
([nil nil ((3797 . 3812)) nil (26808 24276 940965 0) 0 nil])
([nil nil ((3812 . 3816)) nil (26808 24276 940965 0) 0 nil])
([nil nil ((3797 . 3828) (#("lumen.data.db:ensur" 0 19 (fontified t)) . -3797) (undo-tree-id9 . -19) 3816) nil (26808 24276 940964 0) 0 nil])
([nil nil ((3828 . 3829)) nil (26808 24276 940963 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -3828) (undo-tree-id8 . -1) 3829) nil (26808 24276 940963 0) 0 nil])
([nil nil ((4158 . 4159)) nil (26808 24276 940962 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -4158) (undo-tree-id7 . -1) 4159) nil (26808 24276 940962 0) 0 nil])
([nil nil ((4158 . 4159)) nil (26808 24276 940960 0) 0 nil])
([nil nil ((4959 . 4964)) nil (26808 24276 940960 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4995 . 4996) (nil fontified nil 4965 . 4996) (nil fontified nil 4964 . 4965) (4964 . 4996)) nil (26808 24276 940960 0) 0 nil])
([nil nil ((5541 . 5542)) nil (26808 24276 940959 0) 0 nil])
([nil nil ((5970 . 5975)) nil (26808 24276 940959 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6006 . 6007) (nil fontified nil 5976 . 6007) (nil fontified nil 5975 . 5976) (5975 . 6007)) nil (26808 24276 940958 0) 0 nil])
([nil nil ((6100 . 6101)) nil (26808 24276 940958 0) 0 nil])
([nil nil ((6401 . 6406)) nil (26808 24276 940957 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6437 . 6438) (nil fontified nil 6407 . 6438) (nil fontified nil 6406 . 6407) (6406 . 6438)) nil (26808 24276 940957 0) 0 nil])
([nil nil ((6567 . 6568)) nil (26808 24276 940956 0) 0 nil])
([nil nil ((7142 . 7149)) nil (26808 24276 940956 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7180 . 7181) (nil fontified nil 7150 . 7181) (nil fontified nil 7149 . 7150) (7149 . 7181)) nil (26808 24276 940956 0) 0 nil])
([nil nil ((7326 . 7327)) nil (26808 24276 940955 0) 0 nil])
([nil nil ((7512 . 7515)) nil (26808 24276 940955 0) 0 nil])
([nil nil ((7515 . 7520)) nil (26808 24276 940954 0) 0 nil])
([nil nil ((#("w" 0 1 (fontified t)) . -7516) (undo-tree-id3 . -1) (#("i" 0 1 (fontified t)) . -7517) (undo-tree-id4 . -1) (#("t" 0 1 (fontified t)) . -7518) (undo-tree-id5 . -1) (#("h" 0 1 (fontified t)) . -7519) (undo-tree-id6 . -1) 7520) nil (26808 24276 940953 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7547 . 7548) (nil fontified nil 7517 . 7548) (nil fontified nil 7516 . 7517) (7516 . 7548)) nil (26808 24276 940949 0) 0 nil])
([nil nil ((#("ensure-connection" 0 16 (fontified t) 16 17 (rear-nonsticky t fontified t)) . -7531) (undo-tree-id2 . -17) 7548) nil (26808 24276 940948 0) 0 nil])
([nil nil ((7531 . 7532)) nil (26808 24276 940947 0) 0 nil])
([nil nil ((7532 . 7538)) nil (26808 24276 940946 0) 0 nil])
([nil nil ((7538 . 7539)) nil (26808 24276 940946 0) 0 nil])
([nil nil ((7539 . 7541)) nil (26808 24276 940945 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -7515) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 7516) nil (26808 24276 940944 0) 0 nil])
([nil nil ((7698 . 7699)) nil (26808 24276 940927 0) 0 nil])
([nil nil ((9568 . 9570) (t 26808 24276 0 0)) nil (26809 12807 760989 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11179 . 11180) (nil fontified nil 9570 . 11180) (9570 . 11180)) nil (26809 12807 760988 0) 0 nil])
([nil nil ((#("
(defmethod repo-create :around ((entity symbol) payload ctx)
  ;; impose un tenant UUID correct
  (multiple-value-bind (tid payload1) (%coerce-tenant-id payload ctx)
    (unless tid
      (error 'db-error :message \"missing or invalid tenant-id\"))
    ;; réinjecte un tenant_id **UUID** propre
    (let ((payload2 (acons :tenant_id tid payload1)))
      (call-next-method entity payload2 ctx))))

(defmethod repo-update :around ((entity symbol) id payload ctx)
  (multiple-value-bind (tid payload1) (%coerce-tenant-id payload ctx)
    (let ((payload2 (if tid (acons :tenant_id tid payload1) payload1)))
      (call-next-method entity id payload2 ctx))))
" 0 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 23 (face font-lock-function-name-face fontified t) 23 24 (fontified t) 24 31 (face font-lock-builtin-face fontified t) 31 64 (fontified t) 64 67 (face font-lock-comment-delimiter-face fontified t) 67 97 (face font-lock-comment-face fontified t) 97 100 (fontified t) 100 119 (face font-lock-keyword-face fontified t) 119 172 (fontified t) 172 178 (face font-lock-keyword-face fontified t) 178 190 (fontified t) 190 195 (face font-lock-warning-face fontified t) 195 206 (fontified t) 206 214 (face font-lock-builtin-face fontified t) 214 215 (fontified t) 215 245 (face font-lock-string-face fontified t) 245 252 (fontified t) 252 255 (face font-lock-comment-delimiter-face fontified t) 255 294 (face font-lock-comment-face fontified t) 294 299 (fontified t) 299 302 (face font-lock-keyword-face fontified t) 302 321 (fontified t) 321 331 (face font-lock-builtin-face fontified t) 331 397 (fontified t) 397 398 (fontified t) 398 407 (face font-lock-keyword-face fontified t) 407 408 (fontified t) 408 419 (face font-lock-function-name-face fontified t) 419 420 (fontified t) 420 427 (face font-lock-builtin-face fontified t) 427 464 (fontified t) 464 483 (face font-lock-keyword-face fontified t) 483 536 (fontified t) 536 539 (face font-lock-keyword-face fontified t) 539 543 (fontified t) 543 552 (fontified t) 552 554 (face font-lock-keyword-face fontified t) 554 566 (fontified t) 566 576 (face font-lock-builtin-face fontified t) 576 603 (fontified t) 603 652 (fontified t) 652 653 (rear-nonsticky t fontified t) 653 654 (fontified t)) . 10527) (undo-tree-id28 . -654)) nil (26809 12807 760987 0) 0 nil])
([nil nil ((10527 . 10528)) nil (26809 12807 760986 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11364 . 11365) (nil fontified nil 10528 . 11365) (10528 . 11365)) nil (26809 12807 760985 0) 0 nil])
([nil nil ((9443 . 9445)) nil (26809 12807 760984 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9631 . 9632) (nil fontified nil 9445 . 9632) (9445 . 9632)) nil (26809 12807 760983 0) 0 nil])
([nil nil ((#("
(defmethod repo-index :around (entity ctx &rest args)
  (declare (ignore args))
  (let ((op :index)) (repo-authorize op entity ctx) (call-next-method)))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 22 (face font-lock-function-name-face fontified t) 22 23 (fontified t) 23 30 (face font-lock-builtin-face fontified t) 30 39 (fontified t) 39 43 (fontified t) 43 48 (face font-lock-type-face fontified t) 48 55 (fontified t) 55 58 (fontified t) 58 65 (face font-lock-keyword-face fontified t) 65 81 (fontified t) 81 84 (fontified t) 84 87 (face font-lock-keyword-face fontified t) 87 93 (fontified t) 93 99 (face font-lock-builtin-face fontified t) 99 153 (fontified t)) . 9290) (undo-tree-id27 . -153)) nil (26809 12807 760982 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 9290)) nil (26809 12807 760980 0) 0 nil])
([nil nil ((9478 . 9480)) nil (26809 12807 760980 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10030 . 10031) (nil fontified nil 9480 . 10031) (9480 . 10031)) nil (26809 12807 760979 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -10030) (undo-tree-id26 . -1) 10031) nil (26809 12807 760978 0) 0 nil])
([nil nil ((10030 . 10031)) nil (26809 12807 760976 0) 0 nil])
([nil nil ((9290 . 9291)) nil (26809 12807 760976 0) 0 nil])
([nil nil ((9291 . 9293)) nil (26809 12807 760975 0) 0 nil])
([nil nil ((9482 . 9484)) nil (26809 12807 760974 0) 0 nil])
([nil nil ((9484 . 9485)) nil (26809 12807 760974 0) 0 nil])
([nil nil ((3156 . 3158)) nil (26809 12807 760973 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3938 . 3939) (nil fontified nil 3158 . 3939) (3158 . 3939)) nil (26809 12807 760972 0) 0 nil])
([nil nil ((12742 . 12744)) nil (26809 12807 760972 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14897 . 14898) (nil fontified nil 12744 . 14898) (12744 . 14898)) nil (26809 12807 760971 0) 0 nil])
([nil nil ((#("
(defun %coerce-tenant-id (payload ctx)
  \"Retourne (tenant-id-uuid, payload-sans-champ-tenant-dangereux).\"
  (let* ((from-ctx (getf ctx :tenant-id))              ; déjà un UUID ? (middleware vhost)
         (raw (or (cdr (assoc :tenant_id payload))     ; ce que le client a envoyé
                  (cdr (assoc \"tenant_id\" payload))))
         ;; si le client envoie un code ('tenant-b'), on résout vers l'UUID
         (resolved (cond
                     (from-ctx from-ctx)
                     ((and raw (crd.backend.repo:maybe-uuid-p raw)) raw)
                     (raw (crd.backend.repo:tenant-id-by-code raw)) ; <— SELECT sur tenants(code)
                     (t nil))))
    (values resolved
            (remove :tenant_id payload :key #'car :test (lambda (a b)
                                                          (or (eq a b)
                                                              (and (stringp a) (string-equal a \"tenant_id\"))))))))

(defun maybe-uuid-p (s)
  (and (stringp s)
       (cl-ppcre:scan \"^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$\" (string-downcase s))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 25 (face font-lock-function-name-face fontified t) 25 42 (fontified t) 42 107 (face font-lock-doc-face fontified t) 107 111 (fontified t) 111 115 (face font-lock-keyword-face fontified t) 115 137 (fontified t) 137 147 (face font-lock-builtin-face fontified t) 147 163 (fontified t) 163 199 (face font-lock-comment-face fontified t) 199 229 (fontified t) 229 239 (face font-lock-builtin-face fontified t) 239 254 (fontified t) 254 282 (face font-lock-comment-face fontified t) 282 312 (fontified t) 312 323 (face font-lock-string-face fontified t) 323 345 (fontified t) 345 348 (face font-lock-comment-delimiter-face fontified t) 348 412 (face font-lock-comment-face fontified t) 412 432 (fontified t) 432 436 (face font-lock-keyword-face fontified t) 436 619 (fontified t) 619 628 (face font-lock-comment-face fontified t) 628 634 (face font-lock-comment-face fontified t) 634 649 (face font-lock-comment-face fontified t) 649 722 (fontified t) 722 732 (face font-lock-builtin-face fontified t) 732 741 (fontified t) 741 745 (face font-lock-builtin-face fontified t) 745 752 (fontified t) 752 757 (face font-lock-builtin-face fontified t) 757 759 (fontified t) 759 765 (face font-lock-keyword-face fontified t) 765 823 (fontified t) 823 843 (fontified t) 843 938 (fontified t) 938 949 (face font-lock-string-face fontified t) 949 958 (fontified t) 958 959 (fontified t) 959 960 (fontified t) 960 965 (face font-lock-keyword-face fontified t) 965 966 (fontified t) 966 978 (face font-lock-function-name-face fontified t) 978 1024 (fontified t) 1024 1088 (face font-lock-string-face fontified t) 1088 1111 (fontified t)) . -10946) (undo-tree-id24 . -959) (undo-tree-id25 . -1111) 12057) nil (26809 12807 760969 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 10946)) nil (26809 12807 760964 0) 0 nil])
([nil nil ((10945 . 10947)) nil (26809 12807 760963 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11455 . 11456) (nil fontified nil 10947 . 11456) (10947 . 11456)) nil (26809 12807 760962 0) 0 nil])
([nil nil ((10821 . 10822)) nil (26809 12807 760961 0) 0 nil])
([nil nil ((10822 . 10824)) nil (26809 12807 760960 0) 0 nil])
([nil nil ((10949 . 10951)) nil (26809 12807 760959 0) 0 nil])
([nil nil ((10951 . 10952)) nil (26809 12807 760959 0) 0 nil])
([nil nil ((#("(defmethod repo-normalize ((op (eql :create)) (entity symbol) ctx payload)
  (let* ((p0 (%normalize-payload-keys payload))
         ;; on enlève les champs protégés, l’ID est généré côté DB
         (p1 (%remove-protected-fields p0))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid
      (error 'db-error :message \"missing or invalid tenant-id\"))
    ;; impose tenant_id (écrase toute valeur client)
    (acons :tenant_id tid p1)))

(defmethod repo-normalize ((op (eql :patch)) (entity symbol) ctx payload)
  (let* ((p0 (%normalize-payload-keys payload))
         (p1 (%remove-protected-fields p0))
         (tid (%resolve-tenant-id ctx p1)))
    ;; en PATCH, on **peut** imposer à nouveau tenant_id par défense en profondeur
    (if tid (acons :tenant_id tid p1) p1)))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 25 (face font-lock-function-name-face fontified t) 25 36 (fontified t) 36 43 (face font-lock-builtin-face fontified t) 43 78 (fontified t) 78 82 (face font-lock-keyword-face fontified t) 82 132 (fontified t) 132 135 (face font-lock-comment-delimiter-face fontified t) 135 190 (face font-lock-comment-face fontified t) 190 283 (fontified t) 283 289 (face font-lock-keyword-face fontified t) 289 301 (fontified t) 301 306 (face font-lock-warning-face fontified t) 306 317 (fontified t) 317 325 (face font-lock-builtin-face fontified t) 325 326 (fontified t) 326 356 (face font-lock-string-face fontified t) 356 363 (fontified t) 363 366 (face font-lock-comment-delimiter-face fontified t) 366 412 (face font-lock-comment-face fontified t) 412 423 (fontified t) 423 433 (face font-lock-builtin-face fontified t) 433 446 (fontified t) 446 455 (face font-lock-keyword-face fontified t) 455 456 (fontified t) 456 470 (face font-lock-function-name-face fontified t) 470 481 (fontified t) 481 487 (face font-lock-builtin-face fontified t) 487 522 (fontified t) 522 526 (face font-lock-keyword-face fontified t) 526 659 (fontified t) 659 662 (face font-lock-comment-delimiter-face fontified t) 662 738 (face font-lock-comment-face fontified t) 738 743 (fontified t) 743 745 (face font-lock-keyword-face fontified t) 745 757 (fontified t) 757 767 (face font-lock-builtin-face fontified t) 767 780 (fontified t) 780 781 (rear-nonsticky t fontified t)) . -3158) (undo-tree-id19 . -122) (undo-tree-id20 . -122) (undo-tree-id21 . -122) (undo-tree-id22 . -443) (undo-tree-id23 . -781) 3939) nil (26809 12807 760957 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5009 . 5010) (nil fontified nil 3158 . 5010) (3158 . 5010)) nil (26809 12807 760951 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3564) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) 3565) nil (26809 12807 760948 0) 0 nil])
([nil nil ((15373 . 15374)) nil (26809 12807 760928 0) 0 nil])
([nil nil ((842 . 843) (t 26809 12807 0 0)) nil (26809 12900 726444 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -842) (undo-tree-id33 . -1) 843) nil (26809 12900 726442 0) 0 nil])
([nil nil ((843 . 844)) nil (26809 12900 726441 0) 0 nil])
([nil nil ((844 . 845)) nil (26809 12900 726440 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 862 . 863) (nil fontified nil 856 . 863) (nil fontified nil 845 . 856) (845 . 863)) nil (26809 12900 726439 0) 0 nil])
([nil nil ((863 . 864)) nil (26809 12900 726438 0) 0 nil])
([nil nil ((864 . 867)) nil (26809 12900 726437 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -866) (undo-tree-id32 . -1) 867) nil (26809 12900 726436 0) 0 nil])
([nil nil ((866 . 870)) nil (26809 12900 726434 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -868) (undo-tree-id30 . -1) (#("-" 0 1 (fontified t)) . -869) (undo-tree-id31 . -1) 870) nil (26809 12900 726433 0) 0 nil])
([nil nil ((868 . 876)) nil (26809 12900 726428 0) 0 nil])
([nil nil ((864 . 881) (#("tenant-id-by" 0 12 (fontified t)) . -864) (undo-tree-id29 . -12) 876) nil (26809 12900 726425 0) 0 nil])
([nil nil ((864 . 865)) nil (26809 12900 726407 0) 0 nil])
([nil nil ((882 . 883) (t 26809 12900 0 0)) nil (26809 12926 785095 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-builtin-face fontified t)) . -882) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) 883) nil (26809 12926 785089 0) 0 nil])
([nil nil ((#("crd.backend.repo:" 0 17 (fontified t)) . -15082) (undo-tree-id51 . -17) (undo-tree-id52 . -17) (undo-tree-id53 . -17) 15099 (t 26809 12926 0 0)) nil (26809 12945 83763 0) 0 nil])
([nil nil ((1 . 15496) (#("(in-package :cl)

(defpackage :lumen.data.repo.core
  (:use :cl)
  (:import-from :lumen.data.dao
    :entity-metadata :entity-fields :row->entity :entity->row-alist
    :entity-insert! :entity-update! :entity-delete! :validate-entity!
    :entity-slot-symbol)
  (:import-from :lumen.data.repo.query   ;; helpers SQL existants (select*, count*, etc.)
    :select* :select-page-keyset* :select-page-keyset-prev* :count*)
  (:import-from :lumen.utils
    :alist-get)
  (:import-from :lumen.data.db
    :with-tx :ensure-connection)
  (:export
    ;; API “haut-niveau” (appelées par les contrôleurs, routes CRUD, jobs…)
    :repo-index :repo-show :repo-create :repo-patch :repo-delete
    ;; Hooks extensibles par entité
    :repo-authorize :repo-normalize :repo-validate :repo-before :repo-persist :repo-after
    ;; Utilitaires
    :ctx-from-req :tenant-id-for-host :tenant-id-by-code))

(in-package :lumen.data.repo.core)

;;; ---------------------------------------------------------------------------
;;; Contexte standard (req -> ctx)
;;; ---------------------------------------------------------------------------
(defun ctx-from-req (req)
  \"Projette le contexte HTTP vers un ctx alist standard utilisé par repo-*.\"
  (let* ((jwt (lumen.core.http:current-jwt req)))
    (list :req       req
          :tenant-id (lumen.core.http:ctx-get req :tenant-id)
          :actor-id  (lumen.core.http:current-user-id req)
          :scopes    (or (lumen.utils:alist-get jwt :scopes) '())
          :audit?    t)))

;;; ---------------------------------------------------------------------------
;;; API générique (génériques CLOS)
;;; ---------------------------------------------------------------------------
(defgeneric repo-index  (entity ctx &key filters order select page
				      page-size limit offset after before key))
(defgeneric repo-show   (entity ctx id))
(defgeneric repo-create (entity ctx payload))
(defgeneric repo-patch  (entity ctx id payload))
(defgeneric repo-delete (entity ctx id))

;;; Hooks transverses (spécialisables par entité)
(defgeneric repo-authorize (op entity ctx &key id payload))
(defgeneric repo-normalize (op entity ctx payload))
(defgeneric repo-validate (op entity ctx payload))
(defgeneric repo-before   (op entity ctx &key id payload))
(defgeneric repo-persist  (op entity ctx &key id payload))
(defgeneric repo-after    (op entity ctx result &key id payload))

;;; ---------------------------------------------------------------------------
;;; Defaults : autorisations, normalisation, validation, after (audit)…
;;; ---------------------------------------------------------------------------
(defmethod repo-authorize (op (entity symbol) ctx &key id payload)
  (declare (ignore id payload))
  ;; Par défaut : lecture libre ; écriture nécessite scope \"<table>:write\"
  (let* ((md (entity-metadata entity))
         (table (string-downcase (or (getf md :table) (symbol-name entity))))
         (write? (member op '(:create :patch :delete))))
    (if write?
        (member (format nil \"~a:write\" table) (getf ctx :scopes) :test #'string=)
        t)))

(defmethod repo-normalize (op (entity symbol) ctx payload)
  (declare (ignore op entity ctx))
  payload)

;;; ---------------------------------------------------------------------------
;;; Garde-fous framework (CLOS :around)
;;; - S'exécutent AVANT tout (CLOS), mais on délègue aux primaires via
;;;   (call-next-method), puis on RÉ-APPLIQUE les invariants.
;;; - Rend le socle plus robuste même si une app oublie call-next-method.
;;; ---------------------------------------------------------------------------
(defmethod repo-normalize :around ((op (eql :create)) (entity symbol) ctx payload)
  \"Pipeline final framework pour CREATE :
   1) Laisse les méthodes primaires spécifiques s’exécuter,
   2) puis garantit les invariants Lumen (idempotents).\"
  (let* ((out (call-next-method))                            ; ← primaires (app + socle)
         (p0 (%normalize-payload-keys out))                  ; clés normalisées (kw/strings)
         (p1 (%remove-protected-fields p0))                  ; retire :id, :created_at, etc.
         (tid (%resolve-tenant-id ctx p1)))                  ; trouve le tenant depuis ctx/payload
    (unless tid
      (error 'lumen.data.errors:db-error
             :message \"missing or invalid tenant-id\"))
    ;; impose/écrase tenant_id (idempotent) + renvoie un payload propre
    (acons :tenant_id tid p1)))

(defmethod repo-normalize :around ((op (eql :patch)) (entity symbol) ctx payload)
  \"Pipeline final framework pour PATCH :
   - Retire les champs protégés
   - Verrouille le tenant (impossible de changer de tenant).\"
  (let* ((out (call-next-method))
         (p0 (%normalize-payload-keys out))
         (p1 (%remove-protected-fields p0))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid
      (error 'lumen.data.errors:db-error
             :message \"missing or invalid tenant-id\"))
    ;; Ne JAMAIS permettre de modifier :tenant_id par PATCH
    (remf p1 :tenant_id)
    (acons :tenant_id tid p1)))

(defmethod repo-validate (op (entity symbol) ctx payload)
  (declare (ignore op entity))
  ;; Validation DSL si l’app fournit (sinon no-op)
  (ignore-errors
    (let* ((ent (row->entity entity payload)))
      (validate-entity! ent)))
  payload)

(defmethod repo-before (op (entity symbol) ctx &key id payload)
  (declare (ignore op entity ctx id payload))
  ;; no-op par défaut
  (values))

(defmethod repo-after (op (entity symbol) ctx result &key id payload)
  (declare (ignore op entity id payload))
  ;; Audit optionnel (si l’app/ENV a installé une table audit_log et veut logguer)
  (when (getf ctx :audit?)
    (ignore-errors
     (lumen.data.db:ensure-connection
      (lumen.data.db:exec
       \"insert into audit_log(actor_id, tenant_id, action, resource, payload)
        values($1,$2,$3,$4,$5)\"
       (getf ctx :actor-id)
       (getf ctx :tenant-id)
       (string-downcase (symbol-name op))
       (string-downcase (symbol-name entity))
       (cl-json:encode-json-to-string result)))))
  result)

;;; ---------------------------------------------------------------------------
;;; Implémentations par défaut (primaire) — s’appuient sur metadata defentity
;;; ---------------------------------------------------------------------------

;; INDEX (liste)
(defmethod repo-index ((entity symbol) ctx &key filters order select page page-size limit offset after before key)
  (let* ((md (entity-metadata entity))
         (table (getf md :table))
         (allowed (mapcar (lambda (f) (getf f :col)) (entity-fields entity)))
         (filters* (append filters
                           (let ((tid (getf ctx :tenant-id))
                                 (tcol (or (getf md :tenant-id-col) :tenant_id)))
                             (when (and tid (find tcol allowed)) (list '= tcol tid))))))
    (lumen.data.db:ensure-connection
    (cond
      ((or after before)
       ;; key = liste de colonnes correspondant à ORDER
       (select-page-keyset* table
         :filters filters* :order order :key key
         :after after :before before :limit (or limit 20)
         :order-whitelist allowed))
      (t
       (select* table
         :filters filters* :order order :select (or select :*)
         :limit (or (and page-size (* 1 page-size)) limit 20)
         :offset (or offset (and page page-size (* (max 0 (1- page)) page-size)))
         :order-whitelist allowed))))))

;; SHOW (lecture par PK, filtrée tenant si présent)
(defmethod repo-show ((entity symbol) ctx id)
  (let* ((md (entity-metadata entity))
         (table (getf md :table))
         (pk    (or (getf md :primary-key) :id))
         (filters (list '= pk id)))
    (let* ((tid (getf ctx :tenant-id))
           (tcol (or (getf md :tenant-id-col) :tenant_id)))
      (when tid (setf filters (list 'and filters (list '= tcol tid)))))
    (lumen.data.db:ensure-connection
    (let ((rows (select* table :filters filters :limit 1)))
      (and rows (first rows))))))

;; CREATE
(defmethod repo-create ((entity symbol) ctx payload)
  (repo-persist :create entity ctx :payload payload))

(defmethod repo-persist ((op (eql :create)) (entity symbol) ctx &key id payload)
  (declare (ignore ctx id))
  (let* ((ent (row->entity entity payload)))
    (validate-entity! ent)
    (lumen.data.db:ensure-connection
    (multiple-value-bind (n ent2) (entity-insert! ent :returning t)
      (declare (ignore n))
      (entity->row-alist ent2)))))

;; PATCH (partial update)
(defmethod repo-patch ((entity symbol) ctx id payload)
  (repo-persist :patch entity ctx :id id :payload payload))

(defmethod repo-persist ((op (eql :patch)) (entity symbol) ctx &key id payload)
  (declare (ignore ctx))
  (let* ((cur (repo-show entity (list) id)))
    (unless cur (error \"not_found\"))
    (let* ((ent (row->entity entity cur)))
      (dolist (kv payload)
        (let* ((col (car kv)) (val (cdr kv))
               (slot (entity-slot-symbol entity col)))
          (setf (slot-value ent slot) val)))
      (validate-entity! ent)
      (lumen.data.db:ensure-connection
      (multiple-value-bind (n ent2) (entity-update! ent :patch t :returning t)
        (declare (ignore n))
        (entity->row-alist ent2))))))

;; DELETE
(defmethod repo-delete ((entity symbol) ctx id)
  (repo-persist :delete entity ctx :id id))

(defmethod repo-persist ((op (eql :delete)) (entity symbol) ctx &key id payload)
  (lumen.data.db:with-tx ()
  (let ((cur (repo-show entity (list) id)))
    (unless cur (error \"not_found\"))
    (entity-delete! (row->entity entity cur))
    (list :deleted t :id id))))

;;; ---------------------------------------------------------------------------
;;; Transactions & hooks orchestrés via :around
;;; ---------------------------------------------------------------------------

(defmacro %with-read-tx (&body body)
  ;; lecture sans obligation de BEGIN distinct (optionnel)
  `(progn ,@body))

(defmacro %with-write-tx (&body body)
  `(with-tx () ,@body))

;; create
(defmethod repo-create :around (entity ctx payload)
  (%with-write-tx
    (let ((op :create))
      (repo-authorize op entity ctx :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        (repo-before   op entity ctx :payload p1)
        (let ((res (call-next-method entity ctx p1)))
          (repo-after op entity ctx res :payload p1))))))

;; patch
(defmethod repo-patch :around (entity ctx id payload)
  (%with-write-tx
    (let ((op :patch))
      (repo-authorize op entity ctx :id id :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        (repo-before   op entity ctx :id id :payload p1)
        (let ((res (call-next-method entity ctx id p1)))
          (repo-after op entity ctx res :id id :payload p1))))))

;; delete
(defmethod repo-delete :around (entity ctx id)
  (%with-write-tx
    (let ((op :delete))
      (repo-authorize op entity ctx :id id)
      (repo-before   op entity ctx :id id)
      (let ((res (call-next-method entity ctx id)))
        (repo-after op entity ctx res :id id)))))

;; index/show — lecture (pas de BEGIN obligatoire)
#|
(defmethod repo-index :around (entity ctx &rest args)
  (let ((op :index))
    (repo-authorize op entity ctx)
    ;; ⚠️ relayer les args !
    (apply #'call-next-method entity ctx args)))
|#

(defmethod repo-index :around (entity ctx &rest args)
  (destructuring-bind (&key filters &allow-other-keys) args
    (let* ((tid (getf ctx :tenant-id))
           (filters* (if tid (list 'and filters (list '= :tenant_id tid)) filters))
           (args* (alexandria:plist-alist
                   (alexandria:copy-plist args))))
      ;; replace :filters
      (setf (cdr (assoc :filters args*)) filters*)
      (let ((op :index))
        (repo-authorize op entity ctx)
        (apply #'call-next-method entity ctx (alexandria:alist-plist args*))))))

#|
(defmethod repo-show :around (entity ctx id)
  (let ((op :show)) (repo-authorize op entity ctx :id id) (call-next-method)))
|#

(defmethod repo-show :around (entity ctx id)
  (let ((op :show))
    (repo-authorize op entity ctx :id id)
    (let* ((row (call-next-method))      ;; la méthode primaire fait le SELECT
           (tid (getf ctx :tenant-id)))
      (if (and row tid
               (string/= (string-downcase (or (cdr (assoc :tenant_id row)) \"\"))
                         (string-downcase tid)))
          ;; masquer les fuites cross-tenant
          (respond-404)                  ;; ou NIL selon ton contrat
          row))))

(defun tenant-id-by-code (code)
  ;; SELECT id FROM tenants WHERE code = $1 LIMIT 1
  (let ((row (lumen.data.repo.query:select* :tenants
               :filters (list '= :code code) :limit 1)))
    (when (and row (first row))
      (cdr (assoc :id (first row))))))

(defun tenant-id-for-host (host)
  ;; à toi de voir : table tenant_domains, ou mapping mémoire dev
  ;; ex: SELECT t.id FROM tenant_domains d JOIN tenants t ON t.id=d.tenant_id WHERE d.host=$1 LIMIT 1
  (let ((row (lumen.data.repo.query:select* :tenant_domains
               :filters (list '= :host host) :select '(:tenant_id) :limit 1)))
    (when (and row (first row))
      (cdr (assoc :tenant_id (first row))))))

;;; ------------------------------------------------------------
;;; Helpers génériques
;;; ------------------------------------------------------------
(defun %kw (x)
  (etypecase x
    (keyword x)
    (symbol  (intern (string-upcase (symbol-name x)) :keyword))
    (string  (intern (string-upcase x) :keyword))))

(defun %normalize-payload-keys (payload)
  \"Homogénéise les clés (keywords) et enlève les doublons string/keyword.\"
  (let ((ht (make-hash-table :test 'equal)))
    (dolist (kv payload)
      (setf (gethash (%kw (car kv)) ht) (cdr kv)))
    (let (out)
      (maphash (lambda (k v) (push (cons k v) out)) ht)
      (nreverse out))))

(defun %remove-protected-fields (payload &key (extra '()))
  (let* ((protected '(:id :created_at :updated_at :lock_version))
         (drop (append protected extra)))
    (remove-if (lambda (kv) (member (car kv) drop))
               payload)))

(defun %maybe-uuid-p (s)
  (and (stringp s)
       (cl-ppcre:scan \"^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$\"
                      (string-downcase s))))

;;; ------------------------------------------------------------
;;; Sanitation tenant_id
;;;   - ctx :tenant-id prioritaire (UUID attendu)
;;;   - sinon payload :tenant_id (UUID) ou code fonctionnel → résolu via app
;;; ------------------------------------------------------------
(defun %resolve-tenant-id (ctx payload)
  (let* ((ctx-tid (or (getf ctx :tenant-id) (getf ctx :tenant_id)))
         (p-tid   (cdr (assoc :tenant_id payload)))
         (tid
          (cond
            ((and ctx-tid (%maybe-uuid-p ctx-tid)) ctx-tid)
            ((and p-tid (%maybe-uuid-p p-tid))     p-tid)
            (p-tid                                  ;; code fonctionnel → UUID
             (or (handler-case
                     (funcall (or (symbol-function 'tenant-id-by-code)
                                  (lambda (_code) (declare (ignore _code)) nil))
                              p-tid)
                   (undefined-function () nil))
                 ;; dernier recours: NIL provoquera une erreur contrôlée
                 nil))
            (t nil))))
    tid))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 51 (face font-lock-type-face fontified t) 51 55 (fontified t) 55 59 (face font-lock-builtin-face fontified t) 59 60 (fontified t) 60 63 (face font-lock-builtin-face fontified t) 63 68 (fontified t) 68 80 (face font-lock-builtin-face fontified t) 80 81 (fontified t) 81 96 (face font-lock-builtin-face fontified t) 96 101 (fontified t) 101 117 (face font-lock-builtin-face fontified t) 117 118 (fontified t) 118 132 (face font-lock-builtin-face fontified t) 132 133 (fontified t) 133 145 (face font-lock-builtin-face fontified t) 145 146 (fontified t) 146 164 (face font-lock-builtin-face fontified t) 164 169 (fontified t) 169 184 (face font-lock-builtin-face fontified t) 184 185 (fontified t) 185 200 (face font-lock-builtin-face fontified t) 200 201 (fontified t) 201 216 (face font-lock-builtin-face fontified t) 216 217 (fontified t) 217 234 (face font-lock-builtin-face fontified t) 234 239 (fontified t) 239 258 (face font-lock-builtin-face fontified t) 258 263 (fontified t) 263 275 (face font-lock-builtin-face fontified t) 275 276 (fontified t) 276 298 (face font-lock-builtin-face fontified t) 298 301 (fontified t) 301 304 (face font-lock-comment-delimiter-face fontified t) 304 350 (face font-lock-comment-face fontified t) 350 354 (fontified t) 354 362 (face font-lock-builtin-face fontified t) 362 363 (fontified t) 363 383 (face font-lock-builtin-face fontified t) 383 384 (fontified t) 384 409 (face font-lock-builtin-face fontified t) 409 410 (fontified t) 410 417 (face font-lock-builtin-face fontified t) 417 422 (fontified t) 422 434 (face font-lock-builtin-face fontified t) 434 435 (fontified t) 435 447 (face font-lock-builtin-face fontified t) 447 452 (fontified t) 452 462 (face font-lock-builtin-face fontified t) 462 467 (fontified t) 467 479 (face font-lock-builtin-face fontified t) 479 480 (fontified t) 480 494 (face font-lock-builtin-face fontified t) 494 499 (fontified t) 499 507 (face font-lock-builtin-face fontified t) 507 508 (fontified t) 508 526 (face font-lock-builtin-face fontified t) 526 531 (fontified t) 531 538 (face font-lock-builtin-face fontified t) 538 543 (fontified t) 543 546 (face font-lock-comment-delimiter-face fontified t) 546 615 (face font-lock-comment-face fontified t) 615 619 (fontified t) 619 630 (face font-lock-builtin-face fontified t) 630 631 (fontified t) 631 641 (face font-lock-builtin-face fontified t) 641 642 (fontified t) 642 654 (face font-lock-builtin-face fontified t) 654 655 (fontified t) 655 666 (face font-lock-builtin-face fontified t) 666 667 (fontified t) 667 679 (face font-lock-builtin-face fontified t) 679 684 (fontified t) 684 687 (face font-lock-comment-delimiter-face fontified t) 687 716 (face font-lock-comment-face fontified t) 716 720 (fontified t) 720 735 (face font-lock-builtin-face fontified t) 735 736 (fontified t) 736 751 (face font-lock-builtin-face fontified t) 751 752 (fontified t) 752 766 (face font-lock-builtin-face fontified t) 766 767 (fontified t) 767 779 (face font-lock-builtin-face fontified t) 779 780 (fontified t) 780 793 (face font-lock-builtin-face fontified t) 793 794 (fontified t) 794 805 (face font-lock-builtin-face fontified t) 805 810 (fontified t) 810 813 (face font-lock-comment-delimiter-face fontified t) 813 825 (face font-lock-comment-face fontified t) 825 829 (fontified t) 829 842 (face font-lock-builtin-face fontified t) 842 843 (fontified t) 843 862 (face font-lock-builtin-face fontified t) 862 863 (fontified t) 863 881 (face font-lock-builtin-face fontified t) 881 886 (fontified t) 886 896 (face font-lock-keyword-face fontified t) 896 897 (fontified t) 897 918 (face font-lock-builtin-face fontified t) 918 921 (fontified t) 921 925 (face font-lock-comment-delimiter-face fontified t) 925 1001 (face font-lock-comment-face fontified t) 1001 1005 (face font-lock-comment-delimiter-face fontified t) 1005 1036 (face font-lock-comment-face fontified t) 1036 1040 (face font-lock-comment-delimiter-face fontified t) 1040 1116 (face font-lock-comment-face fontified t) 1116 1117 (fontified t) 1117 1122 (face font-lock-keyword-face fontified t) 1122 1123 (fontified t) 1123 1135 (face font-lock-function-name-face fontified t) 1135 1144 (fontified t) 1144 1218 (face font-lock-doc-face fontified t) 1218 1222 (fontified t) 1222 1226 (face font-lock-keyword-face fontified t) 1226 1279 (fontified t) 1279 1283 (face font-lock-builtin-face fontified t) 1283 1304 (fontified t) 1304 1314 (face font-lock-builtin-face fontified t) 1314 1344 (fontified t) 1344 1354 (face font-lock-builtin-face fontified t) 1354 1366 (fontified t) 1366 1375 (face font-lock-builtin-face fontified t) 1375 1425 (fontified t) 1425 1432 (face font-lock-builtin-face fontified t) 1432 1467 (fontified t) 1467 1474 (face font-lock-builtin-face fontified t) 1474 1491 (fontified t) 1491 1498 (face font-lock-builtin-face fontified t) 1498 1500 (fontified t) 1500 1507 (fontified t) 1507 15395 (fontified nil)) . 1) (t 26809 12945 0 0)) nil (26809 16135 99706 0) 0 nil])
([nil nil ((#("alexandria" 0 10 (fontified t)) . -11777) (undo-tree-id7 . -10) (undo-tree-id8 . -10) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -10) (undo-tree-id16 . -10) (undo-tree-id17 . -10) (undo-tree-id18 . -10) (undo-tree-id19 . -10) (undo-tree-id20 . -10) (undo-tree-id21 . -10) (undo-tree-id22 . -10) (undo-tree-id23 . -4) (undo-tree-id24 . -4) (undo-tree-id25 . -4) (undo-tree-id26 . -4) (undo-tree-id27 . -4) (undo-tree-id28 . -4) (undo-tree-id29 . -10) (undo-tree-id30 . -10) (undo-tree-id31 . -10) (undo-tree-id32 . -10) 11787 (t 26809 16138 0 0)) nil (26809 17116 410169 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11788 . 11789) (nil fontified nil 11777 . 11789) (11777 . 11789)) nil (26809 17116 410152 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . -11777) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 11778) nil (26809 17116 410151 0) 0 nil])
([nil nil ((563 . 564)) nil (26809 17116 410133 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 574 . 575) (nil fontified nil 569 . 575) (nil fontified nil 564 . 569) (564 . 575)) nil (26809 17116 410129 0) 0 nil])
([nil nil ((994 . 995) (t 26809 17116 0 0)) nil (26809 18024 199476 0) 0 nil])
([nil nil ((995 . 996)) nil (26809 18024 199475 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1012 . 1013) (nil fontified nil 996 . 1013) (996 . 1013)) nil (26809 18024 199474 0) 0 nil])
([nil nil ((13388 . 13390)) nil (26809 18024 199474 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13643 . 13644) (nil fontified nil 13390 . 13644) (13390 . 13644)) nil (26809 18024 199473 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -13389) (undo-tree-id33 . -1) (undo-tree-id34 . -1) 13390) nil (26809 18024 199471 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13567 . 13568) (nil fontified nil 13546 . 13568) (13546 . 13568)) nil (26809 18024 199459 0) 0 nil])
([nil nil ((#("query" 0 5 (fontified t)) . -13562) (undo-tree-id36 . -5) 13567 (t 26809 18024 0 0)) nil (26809 18067 275497 0) 0 nil])
([nil nil ((13562 . 13564)) nil (26809 18067 275495 0) 0 nil])
([nil nil ((#("repo" 0 4 (fontified t)) . -13557) (undo-tree-id35 . -4) 13561) nil (26809 18067 275494 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . 13557)) nil (26809 18067 275485 0) 0 nil])
([nil nil ((639 . 640)) nil (26809 18067 275484 0) 0 nil])
([nil nil ((640 . 648)) nil (26809 18067 275483 0) 0 nil])
([nil nil ((640 . 641)) nil (26809 18067 275480 0) 0 nil])
([nil nil ((13539 . 13544) (t 26809 18067 0 0)) nil (26809 21786 347173 0) 0 nil])
([nil nil ((13544 . 13553)) nil (26809 21786 347172 0) 0 nil])
([nil nil ((13545 . 13562) (#("ensure-c" 0 8 (fontified t)) . -13545) (undo-tree-id50 . -8) 13553) nil (26809 21786 347172 0) 0 nil])
([nil nil ((13545 . 13553)) nil (26809 21786 347171 0) 0 nil])
([nil nil ((13553 . 13559)) nil (26809 21786 347170 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . 13558)) nil (26809 21786 347170 0) 0 nil])
([nil nil ((13558 . 13559)) nil (26809 21786 347169 0) 0 nil])
([nil nil ((13704 . 13705)) nil (26809 21786 347169 0) 0 nil])
([nil nil ((13659 . 13662) (#("      " 0 6 (fontified t)) . 13659) (13577 . 13578) (#("    " 0 4 (fontified t)) . 13577) 13400) nil (26809 21786 347168 0) 0 nil])
([nil nil ((13181 . 13184)) nil (26809 21786 347168 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13214 . 13215) (nil fontified nil 13198 . 13215) (nil fontified nil 13184 . 13198) (13184 . 13215)) nil (26809 21786 347167 0) 0 nil])
([nil nil ((13184 . 13185)) nil (26809 21786 347166 0) 0 nil])
([nil nil ((13433 . 13434)) nil (26809 21786 347166 0) 0 nil])
([nil nil ((12798 . 12801)) nil (26809 21786 347166 0) 0 nil])
([nil nil ((12801 . 12802)) nil (26809 21786 347165 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12832 . 12833) (nil fontified nil 12816 . 12833) (nil fontified nil 12802 . 12816) (12802 . 12833)) nil (26809 21786 347165 0) 0 nil])
([nil nil ((13014 . 13015)) nil (26809 21786 347164 0) 0 nil])
([nil nil ((13416 . 13419) (#("      " 0 6 (fontified t)) . 13416) (13387 . 13388) (#("    " 0 4 (fontified t)) . 13387) (13317 . 13323) (#("               " 0 15 (fontified t)) . 13317) (13255 . 13259) 13017) nil (26809 21786 347164 0) 0 nil])
([nil nil ((12968 . 12971) (#("      " 0 6 (fontified t)) . 12968) (12939 . 12940) (#("    " 0 4 (fontified t)) . 12939) (12891 . 12897) (#("               " 0 15 (fontified t)) . 12891) (12836 . 12840) 12715) nil (26809 21786 347162 0) 0 nil])
([nil nil ((13290 . 13294) (#(" " 0 1 (fontified nil)) . 13289) (undo-tree-id49 . -1) (13290 . 13291)) nil (26809 21786 347161 0) 0 nil])
([nil nil ((#("
						" 0 1 (fontified t) 1 7 (fontified t)) . -13309) (undo-tree-id48 . -7) 13316) nil (26809 21786 347160 0) 0 nil])
([nil nil ((13309 . 13310)) nil (26809 21786 347158 0) 0 nil])
([nil nil ((13340 . 13346) (#(" " 0 1 (fontified nil)) . 13339) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (13340 . 13341)) nil (26809 21786 347155 0) 0 nil])
([nil nil ((12882 . 12886) (#(" " 0 1 (fontified nil)) . 12881) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (12882 . 12883) (t 26809 21786 0 0)) nil (26809 21792 776641 0) 0 nil])
([nil nil ((#("
						" 0 1 (fontified t) 1 7 (fontified t)) . -12894) (undo-tree-id51 . -7) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -7) (undo-tree-id55 . -7) 12901) nil (26809 21792 776636 0) 0 nil])
([nil nil ((12894 . 12895)) nil (26809 21792 776619 0) 0 nil])
([nil nil ((13377 . 13379) (t 26809 21792 0 0)) nil (26809 22069 653541 0) 0 nil])
([nil nil ((13379 . 13385)) nil (26809 22069 653540 0) 0 nil])
([nil nil ((13385 . 13386)) nil (26809 22069 653540 0) 0 nil])
([nil nil ((13386 . 13387)) nil (26809 22069 653539 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -13386) (undo-tree-id67 . -1) 13387) nil (26809 22069 653538 0) 0 nil])
([nil nil ((13386 . 13393)) nil (26809 22069 653537 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -13392) (undo-tree-id66 . -1) 13393) nil (26809 22069 653537 0) 0 nil])
([nil nil ((13392 . 13393)) nil (26809 22069 653535 0) 0 nil])
([nil nil ((13393 . 13395)) nil (26809 22069 653535 0) 0 nil])
([nil nil ((13395 . 13401)) nil (26809 22069 653534 0) 0 nil])
([nil nil ((13401 . 13402)) nil (26809 22069 653534 0) 0 nil])
([nil nil ((13402 . 13407)) nil (26809 22069 653534 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -13406) (undo-tree-id65 . -1) 13407) nil (26809 22069 653533 0) 0 nil])
([nil nil ((13406 . 13407)) nil (26809 22069 653531 0) 0 nil])
([nil nil ((4360 . 4365)) nil (26809 22069 653531 0) 0 nil])
([nil nil ((4365 . 4372)) nil (26809 22069 653530 0) 0 nil])
([nil nil ((4372 . 4373)) nil (26809 22069 653530 0) 0 nil])
([nil nil ((4373 . 4374)) nil (26809 22069 653529 0) 0 nil])
([nil nil ((4374 . 4375)) nil (26809 22069 653529 0) 0 nil])
([nil nil ((4375 . 4381)) nil (26809 22069 653528 0) 0 nil])
([nil nil ((#("U" 0 1 (face font-lock-string-face fontified t)) . -4379) (undo-tree-id63 . -1) (#("D" 0 1 (face font-lock-string-face fontified t)) . -4380) (undo-tree-id64 . -1) 4381) nil (26809 22069 653527 0) 0 nil])
([nil nil ((4379 . 4382)) nil (26809 22069 653514 0) 0 nil])
([nil nil ((4382 . 4383)) nil (26809 22069 653514 0) 0 nil])
([nil nil ((4383 . 4388)) nil (26809 22069 653513 0) 0 nil])
([nil nil ((4388 . 4389)) nil (26809 22069 653512 0) 0 nil])
([nil nil ((4389 . 4393)) nil (26809 22069 653508 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -13438) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) 13439 (t 26809 22069 0 0)) nil (26809 22104 717768 0) 0 nil])
([nil nil ((13237 . 13240) (t 26809 22104 0 0)) nil (26809 22537 368775 0) 0 nil])
([nil nil ((13240 . 13246)) nil (26809 22537 368775 0) 0 nil])
([nil nil ((13246 . 13247)) nil (26809 22537 368774 0) 0 nil])
([nil nil ((13247 . 13252)) nil (26809 22537 368774 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -13251) (undo-tree-id77 . -1) 13252) nil (26809 22537 368772 0) 0 nil])
([nil nil ((13251 . 13252)) nil (26809 22537 368760 0) 0 nil])
([nil nil ((5427 . 5432) (#(" " 0 1 (fontified nil)) . -5384) (5427 . 5428) (t 26809 22537 0 0)) nil (26809 23315 133794 0) 0 nil])
([nil nil ((5432 . 5438)) nil (26809 23315 133794 0) 0 nil])
([nil nil ((5438 . 5439)) nil (26809 23315 133793 0) 0 nil])
([nil nil ((5439 . 5444)) nil (26809 23315 133793 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -5443) (undo-tree-id88 . -1) (undo-tree-id89 . -1) 5444) nil (26809 23315 133792 0) 0 nil])
([nil nil ((5443 . 5445)) nil (26809 23315 133791 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -5444) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) 5445) nil (26809 23315 133790 0) 0 nil])
([nil nil ((5444 . 5445)) nil (26809 23315 133787 0) 0 nil])
([nil nil ((5445 . 5451)) nil (26809 23315 133786 0) 0 nil])
([nil nil ((5451 . 5452)) nil (26809 23315 133786 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -5451) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) 5452) nil (26809 23315 133785 0) 0 nil])
([nil nil ((5451 . 5457)) nil (26809 23315 133770 0) 0 nil])
([nil nil ((5457 . 5458)) nil (26809 23315 133769 0) 0 nil])
([nil nil ((5458 . 5462)) nil (26809 23315 133765 0) 0 nil])
([nil nil ((5363 . 5366) (t 26809 23315 0 0)) nil (26809 23427 719870 0) 0 nil])
([nil nil ((5366 . 5370)) nil (26809 23427 719870 0) 0 nil])
([nil nil ((5370 . 5372)) nil (26809 23427 719869 0) 0 nil])
([nil nil ((5372 . 5373)) nil (26809 23427 719869 0) 0 nil])
([nil nil ((5373 . 5376)) nil (26809 23427 719868 0) 0 nil])
([nil nil ((5376 . 5377)) nil (26809 23427 719868 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5389 . 5390) (nil fontified nil 5377 . 5390) (5377 . 5390)) nil (26809 23427 719867 0) 0 nil])
([nil nil ((5390 . 5392)) nil (26809 23427 719867 0) 0 nil])
([nil nil ((5377 . 5381) (#("repo" 0 4 (face font-lock-string-face fontified t)) . 5377)) nil (26809 23427 719866 0) 0 nil])
([nil nil ((5381 . 5390) (#("-validate" 0 8 (face font-lock-string-face fontified t) 8 9 (face font-lock-string-face rear-nonsticky t fontified t)) . 5381)) nil (26809 23427 719865 0) 0 nil])
([nil nil ((5374 . 5378)) nil (26809 23427 719864 0) 0 nil])
([nil nil ((5378 . 5379)) nil (26809 23427 719860 0) 0 nil])
([nil nil ((8509 . 8514) (t 26809 23427 0 0)) nil (26809 23765 575119 0) 0 nil])
([nil nil ((8514 . 8520)) nil (26809 23765 575118 0) 0 nil])
([nil nil ((8520 . 8521)) nil (26809 23765 575118 0) 0 nil])
([nil nil ((8521 . 8522)) nil (26809 23765 575118 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -8521) (undo-tree-id101 . -1) 8522) nil (26809 23765 575117 0) 0 nil])
([nil nil ((8521 . 8531)) nil (26809 23765 575116 0) 0 nil])
([nil nil ((8531 . 8536)) nil (26809 23765 575116 0) 0 nil])
([nil nil ((8536 . 8537)) nil (26809 23765 575115 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -8536) (undo-tree-id100 . -1) 8537) nil (26809 23765 575115 0) 0 nil])
([nil nil ((8536 . 8541)) nil (26809 23765 575113 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -8536) (undo-tree-id95 . -1) (#("p" 0 1 (fontified t)) . -8537) (undo-tree-id96 . -1) (#("r" 0 1 (fontified t)) . -8538) (undo-tree-id97 . -1) (#("i" 0 1 (fontified t)) . -8539) (undo-tree-id98 . -1) (#("n" 0 1 (fontified t)) . -8540) (undo-tree-id99 . -1) 8541) nil (26809 23765 575111 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -8531) (undo-tree-id90 . -1) (#(" " 0 1 (fontified t)) . -8532) (undo-tree-id91 . -1) (#(" " 0 1 (fontified t)) . -8533) (undo-tree-id92 . -1) (#(" " 0 1 (fontified t)) . -8534) (undo-tree-id93 . -1) (#(" " 0 1 (fontified t)) . -8535) (undo-tree-id94 . -1) 8536) nil (26809 23765 575103 0) 0 nil])
([nil nil ((8723 . 8728) (t 26809 23765 0 0)) nil (26809 23858 81486 0) 0 nil])
([nil nil ((8728 . 8734)) nil (26809 23858 81486 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -8732) (undo-tree-id104 . -1) (#("n" 0 1 (fontified t)) . -8733) (undo-tree-id105 . -1) 8734) nil (26809 23858 81485 0) 0 nil])
([nil nil ((8732 . 8734)) nil (26809 23858 81483 0) 0 nil])
([nil nil ((8734 . 8735)) nil (26809 23858 81483 0) 0 nil])
([nil nil ((8735 . 8740)) nil (26809 23858 81482 0) 0 nil])
([nil nil ((8740 . 8741)) nil (26809 23858 81482 0) 0 nil])
([nil nil ((8741 . 8746)) nil (26809 23858 81481 0) 0 nil])
([nil nil ((#("S" 0 1 (face font-lock-string-face fontified t)) . -8745) (undo-tree-id103 . -1) 8746) nil (26809 23858 81481 0) 0 nil])
([nil nil ((8745 . 8746)) nil (26809 23858 81479 0) 0 nil])
([nil nil ((8746 . 8752)) nil (26809 23858 81478 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -8751) (undo-tree-id102 . -1) 8752) nil (26809 23858 81478 0) 0 nil])
([nil nil ((8751 . 8753)) nil (26809 23858 81468 0) 0 nil])
([nil nil ((8753 . 8754)) nil (26809 23858 81467 0) 0 nil])
([nil nil ((8754 . 8757)) nil (26809 23858 81467 0) 0 nil])
([nil nil ((8759 . 8760)) nil (26809 23858 81466 0) 0 nil])
([nil nil ((8685 . 8688) (#("      " 0 6 (fontified t)) . 8685) (8661 . 8664) (#("      " 0 6 (fontified t)) . 8661) (8596 . 8597) (#("    " 0 4 (fontified t)) . 8596) 8356) nil (26809 23858 81461 0) 0 nil])
([nil nil ((8558 . 8563) (t 26809 23858 0 0)) nil (26809 23912 69592 0) 0 nil])
([nil nil ((8563 . 8569)) nil (26809 23912 69591 0) 0 nil])
([nil nil ((8569 . 8570)) nil (26809 23912 69591 0) 0 nil])
([nil nil ((8570 . 8577)) nil (26809 23912 69586 0) 0 nil])
([nil nil ((8614 . 8616) (t 26809 23912 0 0)) nil (26809 23988 467940 0) 0 nil])
([nil nil ((8616 . 8622)) nil (26809 23988 467939 0) 0 nil])
([nil nil ((8622 . 8623)) nil (26809 23988 467939 0) 0 nil])
([nil nil ((8623 . 8626)) nil (26809 23988 467938 0) 0 nil])
([nil nil ((#("B" 0 1 (face font-lock-string-face fontified t)) . -8625) (undo-tree-id107 . -1) 8626) nil (26809 23988 467938 0) 0 nil])
([nil nil ((8625 . 8626)) nil (26809 23988 467936 0) 0 nil])
([nil nil ((8626 . 8627)) nil (26809 23988 467936 0) 0 nil])
([nil nil ((8627 . 8630)) nil (26809 23988 467935 0) 0 nil])
([nil nil ((8719 . 8723)) nil (26809 23988 467935 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8736 . 8737) (nil fontified nil 8736 . 8737) (nil fontified nil 8730 . 8736) (nil fontified nil 8723 . 8730) (8723 . 8737)) nil (26809 23988 467934 0) 0 nil])
([nil nil ((#("A" 0 1 (face font-lock-string-face fontified t)) . -8734) (undo-tree-id106 . -1) 8735) nil (26809 23988 467932 0) 0 nil])
([nil nil ((8734 . 8735)) nil (26809 23988 467920 0) 0 nil])
([nil nil ((#("
    (print \"**** REPO PERSIST OK\")" 0 12 (fontified t) 12 34 (face font-lock-string-face fontified t) 34 35 (fontified t)) . 8767) (undo-tree-id0 . -35) (undo-tree-id1 . -35) (undo-tree-id2 . -35) (undo-tree-id3 . -35) (undo-tree-id4 . -35) (undo-tree-id5 . -35) (t 26809 23988 0 0)) nil (26809 26029 397774 0) 0 nil])
([nil nil ((8719 . 8723) (t 26809 26029 0 0)) nil (26809 26518 41533 0) 0 nil])
([nil nil ((8723 . 8726)) nil (26809 26518 41533 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -8724) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (#("r" 0 1 (fontified t)) . -8725) (undo-tree-id9 . -1) 8726) nil (26809 26518 41532 0) 0 nil])
([nil nil ((8724 . 8729)) nil (26809 26518 41520 0) 0 nil])
([nil nil ((8729 . 8730)) nil (26809 26518 41520 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8753 . 8754) (nil fontified nil 8730 . 8754) (8730 . 8754)) nil (26809 26518 41519 0) 0 nil])
([nil nil ((8754 . 8755)) nil (26809 26518 41515 0) 0 nil])
([nil nil ((10685 . 10689) (t 26809 26518 0 0)) nil (26809 26892 187304 0) 0 nil])
([nil nil ((10689 . 10695)) nil (26809 26892 187303 0) 0 nil])
([nil nil ((10695 . 10696)) nil (26809 26892 187303 0) 0 nil])
([nil nil ((10696 . 10701)) nil (26809 26892 187302 0) 0 nil])
([nil nil ((10701 . 10702)) nil (26809 26892 187301 0) 0 nil])
([nil nil ((10702 . 10709)) nil (26809 26892 187296 0) 0 nil])
([nil nil ((5879 . 5882) (t 26809 26892 0 0)) nil (26809 27073 191192 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6064 . 6065) (nil fontified nil 5930 . 6065) (nil fontified nil 5920 . 5930) (nil fontified nil 5901 . 5920) (nil fontified nil 5892 . 5901) (nil fontified nil 5882 . 5892) (5882 . 6065)) nil (26809 27073 191191 0) 0 nil])
([nil nil ((5882 . 5888)) nil (26809 27073 191191 0) 0 nil])
([nil nil ((5888 . 5889)) nil (26809 27073 191190 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -5887) (undo-tree-id16 . -1) (#(" " 0 1 (fontified t)) . -5888) (undo-tree-id17 . -1) 5889) nil (26809 27073 191189 0) 0 nil])
([nil nil ((5887 . 5888)) nil (26809 27073 191188 0) 0 nil])
([nil nil ((5888 . 5889)) nil (26809 27073 191187 0) 0 nil])
([nil nil ((#("n" 0 1 (fontified t)) . -5886) (undo-tree-id13 . -1) (#("c" 0 1 (fontified t)) . -5887) (undo-tree-id14 . -1) (#(" " 0 1 (fontified t)) . -5888) (undo-tree-id15 . -1) 5889) nil (26809 27073 191186 0) 0 nil])
([nil nil ((5886 . 5888)) nil (26809 27073 191182 0) 0 nil])
([nil nil ((5888 . 5889)) nil (26809 27073 191182 0) 0 nil])
([nil nil ((5889 . 5890)) nil (26809 27073 191181 0) 0 nil])
([nil nil ((#("\\" 0 1 (fontified t)) . -5889) (undo-tree-id12 . -1) 5890) nil (26809 27073 191181 0) 0 nil])
([nil nil ((5889 . 5894)) nil (26809 27073 191179 0) 0 nil])
([nil nil ((5894 . 5895)) nil (26809 27073 191179 0) 0 nil])
([nil nil ((#("y" 0 1 (fontified t)) . -5893) (undo-tree-id10 . -1) (#(" " 0 1 (fontified t)) . -5894) (undo-tree-id11 . -1) 5895) nil (26809 27073 191178 0) 0 nil])
([nil nil ((5893 . 5894)) nil (26809 27073 191168 0) 0 nil])
([nil nil ((5894 . 5895)) nil (26809 27073 191167 0) 0 nil])
([nil nil ((6078 . 6080)) nil (26809 27073 191163 0) 0 nil])
([nil nil ((15739 . 15742) (t 26809 27073 0 0)) nil (26809 34267 874564 0) 0 nil])
([nil nil ((15742 . 15744)) nil (26809 34267 874563 0) 0 nil])
([nil nil ((15744 . 15745)) nil (26809 34267 874563 0) 0 nil])
([nil nil ((15745 . 15749)) nil (26809 34267 874562 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -15746) (undo-tree-id27 . -1) (#("r" 0 1 (fontified t)) . -15747) (undo-tree-id28 . -1) (#("i" 0 1 (fontified t)) . -15748) (undo-tree-id29 . -1) 15749) nil (26809 34267 874562 0) 0 nil])
([nil nil ((15746 . 15751)) nil (26809 34267 874560 0) 0 nil])
([nil nil ((15751 . 15752)) nil (26809 34267 874559 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -15746) (undo-tree-id21 . -1) (#("r" 0 1 (fontified t)) . -15747) (undo-tree-id22 . -1) (#("o" 0 1 (fontified t)) . -15748) (undo-tree-id23 . -1) (#("g" 0 1 (face font-lock-keyword-face fontified t)) . -15749) (undo-tree-id24 . -1) (#("n" 0 1 (face font-lock-keyword-face fontified t)) . -15750) (undo-tree-id25 . -1) (#(" " 0 1 (fontified t)) . -15751) (undo-tree-id26 . -1) 15752) nil (26809 34267 874558 0) 0 nil])
([nil nil ((15746 . 15752)) nil (26809 34267 874554 0) 0 nil])
([nil nil ((15752 . 15753)) nil (26809 34267 874554 0) 0 nil])
([nil nil ((15753 . 15754)) nil (26809 34267 874554 0) 0 nil])
([nil nil ((15754 . 15755)) nil (26809 34267 874553 0) 0 nil])
([nil nil ((15755 . 15757)) nil (26809 34267 874553 0) 0 nil])
([nil nil ((15757 . 15758)) nil (26809 34267 874553 0) 0 nil])
([nil nil ((15758 . 15762)) nil (26809 34267 874552 0) 0 nil])
([nil nil ((15762 . 15763)) nil (26809 34267 874552 0) 0 nil])
([nil nil ((15763 . 15764)) nil (26809 34267 874552 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-string-face fontified t)) . -15763) (undo-tree-id20 . -1) 15764) nil (26809 34267 874551 0) 0 nil])
([nil nil ((15763 . 15766)) nil (26809 34267 874550 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-string-face fontified t)) . -15765) (undo-tree-id19 . -1) 15766) nil (26809 34267 874549 0) 0 nil])
([nil nil ((15765 . 15767)) nil (26809 34267 874548 0) 0 nil])
([nil nil ((15767 . 15768)) nil (26809 34267 874547 0) 0 nil])
([nil nil ((15768 . 15769)) nil (26809 34267 874547 0) 0 nil])
([nil nil ((15769 . 15776)) nil (26809 34267 874546 0) 0 nil])
([nil nil ((16003 . 16010)) nil (26809 34267 874546 0) 0 nil])
([nil nil ((16010 . 16016)) nil (26809 34267 874546 0) 0 nil])
([nil nil ((16016 . 16017)) nil (26809 34267 874545 0) 0 nil])
([nil nil ((16017 . 16023)) nil (26809 34267 874545 0) 0 nil])
([nil nil ((16023 . 16024)) nil (26809 34267 874544 0) 0 nil])
([nil nil ((16024 . 16030)) nil (26809 34267 874544 0) 0 nil])
([nil nil ((4261 . 4264)) nil (26809 34267 874544 0) 0 nil])
([nil nil ((4264 . 4267)) nil (26809 34267 874543 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -4266) (undo-tree-id18 . -1) 4267) nil (26809 34267 874543 0) 0 nil])
([nil nil ((4266 . 4267)) nil (26809 34267 874534 0) 0 nil])
([nil nil ((4267 . 4273)) nil (26809 34267 874534 0) 0 nil])
([nil nil ((4273 . 4274)) nil (26809 34267 874533 0) 0 nil])
([nil nil ((4274 . 4278)) nil (26809 34267 874533 0) 0 nil])
([nil nil ((4168 . 4171)) nil (26809 34267 874532 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4184 . 4185) (nil fontified nil 4171 . 4185) (4171 . 4185)) nil (26809 34267 874531 0) 0 nil])
([nil nil ((#("1" 0 1 (fontified t)) . 4182)) nil (26809 34267 874530 0) 0 nil])
([nil nil ((4182 . 4183)) nil (26809 34267 874527 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -15741) (undo-tree-id37 . -10) 15751 (t 26809 34267 0 0)) nil (26809 34391 378902 0) 0 nil])
([nil nil ((15741 . 15748)) nil (26809 34391 378901 0) 0 nil])
([nil nil ((#("i" 0 1 (fontified t)) . -15747) (undo-tree-id36 . -1) 15748) nil (26809 34391 378900 0) 0 nil])
([nil nil ((15747 . 15748)) nil (26809 34391 378899 0) 0 nil])
([nil nil ((15741 . 15762) (#("lumen.u" 0 7 (fontified t)) . -15741) (undo-tree-id35 . -7) 15748) nil (26809 34391 378898 0) 0 nil])
([nil nil ((15740 . 15742)) nil (26809 34391 378897 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -15741) (undo-tree-id34 . -1) 15742) nil (26809 34391 378897 0) 0 nil])
([nil nil ((15741 . 15743)) nil (26809 34391 378895 0) 0 nil])
([nil nil ((15743 . 15744)) nil (26809 34391 378895 0) 0 nil])
([nil nil ((#("payload" 0 7 (fontified t)) . 15778) (undo-tree-id33 . -7) 15785) nil (26809 34391 378894 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -15777) (undo-tree-id31 . -1) (undo-tree-id32 . -1) 15778) nil (26809 34391 378893 0) 0 nil])
([nil nil ((15766 . 15767)) nil (26809 34391 378888 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15773 . 15774) (nil fontified nil 15767 . 15774) (15767 . 15774)) nil (26809 34391 378887 0) 0 nil])
([nil nil ((15786 . 15795)) nil (26809 34391 378886 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15836 . 15837) (nil fontified nil 15836 . 15837) (nil fontified nil 15826 . 15836) (nil fontified nil 15825 . 15826) (nil fontified nil 15824 . 15825) (nil fontified nil 15818 . 15824) (nil fontified nil 15796 . 15818) (nil fontified nil 15795 . 15796) (15795 . 15837)) nil (26809 34391 378885 0) 0 nil])
([nil nil ((#("_" 0 1 (face font-lock-builtin-face fontified t)) . -15833) (undo-tree-id30 . -1) 15834) nil (26809 34391 378883 0) 0 nil])
([nil nil ((15833 . 15834)) nil (26809 34391 378871 0) 0 nil])
([nil nil ((15721 . 15724) (t 26809 34391 0 0)) nil (26809 34748 165700 0) 0 nil])
([nil nil ((15724 . 15726)) nil (26809 34748 165700 0) 0 nil])
([nil nil ((15726 . 15727)) nil (26809 34748 165699 0) 0 nil])
([nil nil ((15727 . 15733)) nil (26809 34748 165698 0) 0 nil])
([nil nil ((15733 . 15734)) nil (26809 34748 165698 0) 0 nil])
([nil nil ((15734 . 15737)) nil (26809 34748 165697 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -15734) (undo-tree-id38 . -1) (#("l" 0 1 (fontified t)) . -15735) (undo-tree-id39 . -1) (#("o" 0 1 (fontified t)) . -15736) (undo-tree-id40 . -1) 15737) nil (26809 34748 165696 0) 0 nil])
([nil nil ((15734 . 15743)) nil (26809 34748 165681 0) 0 nil])
([nil nil ((#("(x (print p0))" 0 13 (fontified t) 13 14 (rear-nonsticky t fontified t)) . 4171) (undo-tree-id42 . -14) (undo-tree-id43 . -14) (undo-tree-id44 . -14) (undo-tree-id45 . -14) (undo-tree-id46 . -14) (undo-tree-id47 . -14) (undo-tree-id48 . -14) (undo-tree-id49 . -14) 4185 (t 26809 34748 0 0)) nil (26809 34916 410429 0) 0 nil])
([nil nil ((4925 . 4928)) nil (26809 34916 410423 0) 0 nil])
([nil nil ((nil fontified nil 4941 . 4942) (nil fontified nil 4928 . 4941) (4928 . 4942)) nil (26809 34916 410423 0) 0 nil])
([nil nil ((#("(x (print p1))" 0 14 (fontified t)) . 4267) (undo-tree-id41 . -14)) nil (26809 34916 410422 0) 0 nil])
([nil nil ((4972 . 4975)) nil (26809 34916 410413 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4988 . 4989) (nil fontified nil 4975 . 4989) (4975 . 4989)) nil (26809 34916 410413 0) 0 nil])
([nil nil ((5033 . 5038)) nil (26809 34916 410411 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5065 . 5066) (nil fontified nil 5061 . 5066) (nil fontified nil 5048 . 5061) (nil fontified nil 5038 . 5048) (5038 . 5066)) nil (26809 34916 410407 0) 0 nil])
([nil nil ((4867 . 4870) (t 26809 34916 0 0)) nil (26809 34967 431177 0) 0 nil])
([nil nil ((4870 . 4872)) nil (26809 34967 431177 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -4871) (undo-tree-id50 . -1) 4872) nil (26809 34967 431172 0) 0 nil])
([nil nil ((4871 . 4872)) nil (26809 34967 431164 0) 0 nil])
([nil nil ((4872 . 4873)) nil (26809 34967 431163 0) 0 nil])
([nil nil ((4873 . 4879)) nil (26809 34967 431163 0) 0 nil])
([nil nil ((4879 . 4880)) nil (26809 34967 431162 0) 0 nil])
([nil nil ((4880 . 4885)) nil (26809 34967 431158 0) 0 nil])
([nil nil ((4865 . 4866) (t 26809 34967 0 0)) nil (26809 35305 154577 0) 0 nil])
([nil nil ((4866 . 4867)) nil (26809 35305 154577 0) 0 nil])
([nil nil ((4867 . 4868)) nil (26809 35305 154576 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4867) (undo-tree-id54 . -1) 4868) nil (26809 35305 154576 0) 0 nil])
([nil nil ((4867 . 4868)) nil (26809 35305 154574 0) 0 nil])
([nil nil ((4868 . 4869)) nil (26809 35305 154574 0) 0 nil])
([nil nil ((4869 . 4871)) nil (26809 35305 154573 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -4870) (undo-tree-id53 . -1) 4871) nil (26809 35305 154573 0) 0 nil])
([nil nil ((4870 . 4873)) nil (26809 35305 154572 0) 0 nil])
([nil nil ((4869 . 4875) (#("enti" 0 4 (fontified t)) . -4869) (undo-tree-id52 . -4) 4873) nil (26809 35305 154571 0) 0 nil])
([nil nil ((4875 . 4876)) nil (26809 35305 154569 0) 0 nil])
([nil nil ((4876 . 4879)) nil (26809 35305 154568 0) 0 nil])
([nil nil ((#("c" 0 1 (fontified t)) . -4878) (undo-tree-id51 . -1) 4879) nil (26809 35305 154567 0) 0 nil])
([nil nil ((4878 . 4879)) nil (26809 35305 154558 0) 0 nil])
([nil nil ((4879 . 4880)) nil (26809 35305 154557 0) 0 nil])
([nil nil ((4880 . 4887)) nil (26809 35305 154554 0) 0 nil])
([nil nil ((9850 . 9854) (9817 . 9821) (9733 . 9736) (#("      " 0 6 (fontified t)) . 9733) 9263 (t 26809 35305 0 0)) nil (26809 36700 866356 0) 0 nil])
([nil nil ((8514 . 8517) (#("      " 0 6 (fontified t)) . 8514) (8457 . 8458) (#("    " 0 4 (fontified t)) . 8457) 8045 (t 26809 36700 0 0)) nil (26809 36941 918916 0) 0 nil])
([nil nil ((9406 . 9411)) nil (26809 36941 918915 0) 0 nil])
([nil nil ((9411 . 9417)) nil (26809 36941 918915 0) 0 nil])
([nil nil ((9417 . 9418)) nil (26809 36941 918914 0) 0 nil])
([nil nil ((9418 . 9425)) nil (26809 36941 918914 0) 0 nil])
([nil nil ((9425 . 9428)) nil (26809 36941 918913 0) 0 nil])
([nil nil ((9428 . 9433)) nil (26809 36941 918913 0) 0 nil])
([nil nil ((9433 . 9435)) nil (26809 36941 918912 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -9434) (undo-tree-id55 . -1) 9435) nil (26809 36941 918911 0) 0 nil])
([nil nil ((9434 . 9439)) nil (26809 36941 918899 0) 0 nil])
([nil nil ((9439 . 9440)) nil (26809 36941 918898 0) 0 nil])
([nil nil ((9440 . 9444)) nil (26809 36941 918895 0) 0 nil])
([nil nil ((15755 . 15756) (t 26809 36941 0 0)) nil (26809 39109 827028 0) 0 nil])
([nil nil ((#("x" 0 1 (face font-lock-function-name-face fontified t)) . -15755) (undo-tree-id65 . -1) 15756) nil (26809 39109 827028 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -4593) (undo-tree-id64 . -1) 4594) nil (26809 39109 827027 0) 0 nil])
([nil nil ((4593 . 4594)) nil (26809 39109 827025 0) 0 nil])
([nil nil ((#("(acons :tenant_id tid p1)" 0 7 (fontified t) 7 17 (face font-lock-builtin-face fontified t) 17 25 (fontified t)) . -4588) (undo-tree-id56 . -18) (undo-tree-id57 . -25) (undo-tree-id58 . -25) (undo-tree-id59 . -25) (undo-tree-id60 . -25) (undo-tree-id61 . -25) (undo-tree-id62 . -25) (undo-tree-id63 . -25) 4613) nil (26809 39109 827024 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4639 . 4640) (nil fontified nil 4588 . 4640) (4588 . 4640)) nil (26809 39109 827007 0) 0 nil])
([nil nil ((9752 . 9759) (t 26809 39109 0 0)) nil (26809 39534 85886 0) 0 nil])
([nil nil ((9759 . 9765)) nil (26809 39534 85885 0) 0 nil])
([nil nil ((9765 . 9766)) nil (26809 39534 85884 0) 0 nil])
([nil nil ((9766 . 9767)) nil (26809 39534 85883 0) 0 nil])
([nil nil ((#("
      (print (" 0 1 (fontified t) 1 15 (fontified t)) . 9752) (undo-tree-id66 . -15) (undo-tree-id67 . -15)) nil (26809 39534 85880 0) 0 nil])
([nil nil ((9551 . 9558) (t 26809 39534 0 0)) nil (26809 40431 539615 0) 0 nil])
([nil nil ((9558 . 9560)) nil (26809 40431 539614 0) 0 nil])
([nil nil ((9729 . 9735) (#("    " 0 4 (face font-lock-comment-face fontified nil)) . -9694) (9732 . 9733)) nil (26809 40431 539612 0) 0 nil])
([nil nil ((9735 . 9737)) nil (26809 40431 539608 0) 0 nil])
([nil nil ((9766 . 9773) (t 26809 40431 0 0)) nil (26809 40641 726830 0) 0 nil])
([nil nil ((9773 . 9779)) nil (26809 40641 726829 0) 0 nil])
([nil nil ((9779 . 9780)) nil (26809 40641 726828 0) 0 nil])
([nil nil ((9780 . 9794)) nil (26809 40641 726824 0) 0 nil])
([nil nil ((9766 . 9773) (t 26809 40641 0 0)) nil (26809 40682 795700 0) 0 nil])
([nil nil ((9773 . 9777)) nil (26809 40682 795700 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -9776) (undo-tree-id117 . -1) 9777) nil (26809 40682 795699 0) 0 nil])
([nil nil ((9776 . 9784)) nil (26809 40682 795698 0) 0 nil])
([nil nil ((9774 . 9785) (#("lumen.data" 0 10 (fontified t)) . -9774) (undo-tree-id102 . -10) (undo-tree-id103 . -8) (undo-tree-id104 . -8) (undo-tree-id105 . -8) (undo-tree-id106 . -8) (undo-tree-id107 . -8) (undo-tree-id108 . -8) (undo-tree-id109 . -9) (undo-tree-id110 . -9) (undo-tree-id111 . -10) (undo-tree-id112 . -10) (undo-tree-id113 . -10) (undo-tree-id114 . -10) (undo-tree-id115 . -10) (undo-tree-id116 . -10) 9784) nil (26809 40682 795696 0) 0 nil])
([nil nil ((#("
      (lumen.data." 0 1 (fontified t) 1 8 (fontified t) 8 19 (fontified t)) . 9766) (undo-tree-id68 . -19) (undo-tree-id69 . -1) (undo-tree-id70 . -8) (undo-tree-id71 . -8) (undo-tree-id72 . -8) (undo-tree-id73 . -8) (undo-tree-id74 . -8) (undo-tree-id75 . -8) (undo-tree-id76 . -1) (undo-tree-id77 . -8) (undo-tree-id78 . -8) (undo-tree-id79 . -1) (undo-tree-id80 . -8) (undo-tree-id81 . -8) (undo-tree-id82 . -8) (undo-tree-id83 . -8) (undo-tree-id84 . -8) (undo-tree-id85 . -8) (undo-tree-id86 . -1) (undo-tree-id87 . -19) (undo-tree-id88 . -19) (undo-tree-id89 . -19) (undo-tree-id90 . -19) (undo-tree-id91 . -19) (undo-tree-id92 . -19) (undo-tree-id93 . -19) (undo-tree-id94 . -19) (undo-tree-id95 . -19) (undo-tree-id96 . -19) (undo-tree-id97 . -19) (undo-tree-id98 . -19) (undo-tree-id99 . -19) (undo-tree-id100 . -19) (undo-tree-id101 . -19)) nil (26809 40682 795683 0) 0 nil])
([nil nil ((9942 . 9948) (t 26809 40682 0 0)) nil (26809 41525 994752 0) 0 nil])
([nil nil ((9948 . 9954)) nil (26809 41525 994752 0) 0 nil])
([nil nil ((9954 . 9955)) nil (26809 41525 994751 0) 0 nil])
([nil nil ((9955 . 9956)) nil (26809 41525 994751 0) 0 nil])
([nil nil ((#("X" 0 1 (fontified t)) . -9955) (undo-tree-id130 . -1) 9956) nil (26809 41525 994750 0) 0 nil])
([nil nil ((9955 . 9956)) nil (26809 41525 994750 0) 0 nil])
([nil nil ((#("A" 0 1 (fontified t)) . -9955) (undo-tree-id129 . -1) 9956) nil (26809 41525 994749 0) 0 nil])
([nil nil ((9955 . 9964)) nil (26809 41525 994748 0) 0 nil])
([nil nil ((9964 . 9970)) nil (26809 41525 994747 0) 0 nil])
([nil nil ((9970 . 9976)) nil (26809 41525 994747 0) 0 nil])
([nil nil ((9976 . 9977)) nil (26809 41525 994746 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10000 . 10001) (nil fontified nil 9977 . 10001) (9977 . 10001)) nil (26809 41525 994745 0) 0 nil])
([nil nil ((10001 . 10002)) nil (26809 41525 994744 0) 0 nil])
([nil nil ((10002 . 10008)) nil (26809 41525 994744 0) 0 nil])
([nil nil ((10008 . 10009)) nil (26809 41525 994744 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -10008) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) 10009) nil (26809 41525 994743 0) 0 nil])
([nil nil ((10008 . 10013)) nil (26809 41525 994739 0) 0 nil])
([nil nil ((10013 . 10014)) nil (26809 41525 994739 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -10013) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) 10014) nil (26809 41525 994738 0) 0 nil])
([nil nil ((10013 . 10014)) nil (26809 41525 994734 0) 0 nil])
([nil nil ((10014 . 10015)) nil (26809 41525 994734 0) 0 nil])
([nil nil ((10015 . 10016)) nil (26809 41525 994733 0) 0 nil])
([nil nil ((10016 . 10022)) nil (26809 41525 994733 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -10021) (undo-tree-id118 . -1) 10022) nil (26809 41525 994731 0) 0 nil])
([nil nil ((10021 . 10022)) nil (26809 42337 290078 0) 0 nil])
([nil nil ((#("ent2" 0 4 (fontified t)) . -9861) (undo-tree-id400 . -4) 9865) nil (26809 42368 946573 0) 0 nil] [nil nil ((#("ent2" 0 4 (fontified t)) . -8991) (undo-tree-id140 . -4) 8995 (t 26809 41525 0 0)) ((8991 . 8995)) (26809 42336 822052 0) 0 nil])
([nil nil ((9861 . 9864)) nil (26809 42368 946572 0) 0 nil])
([nil nil ((8991 . 8994)) ((#("ret" 0 3 (fontified t)) . 8991)) (26809 42335 128734 0) 0 nil])
([nil nil ((#("(entity->row-alist ent2)" 0 23 (fontified t) 23 24 (fontified t rear-nonsticky t)) . -9976) (undo-tree-id393 . -24) (undo-tree-id394 . -23) (undo-tree-id395 . -23) (undo-tree-id396 . -23) (undo-tree-id397 . -23) (undo-tree-id398 . -24) (undo-tree-id399 . -24) 10000) nil (26809 42368 946571 0) 0 nil])
([nil nil ((#("(print (entity->row-alist ent2))
	  (print \"IN B\")
	  (entity->row-alist ent2)" 0 7 (fontified t) 7 30 (fontified t) 30 31 (fontified t rear-nonsticky t) 31 32 (fontified t) 32 33 (fontified t) 33 43 (fontified t) 43 49 (face font-lock-string-face fontified t) 49 51 (fontified t) 51 78 (fontified t)) . -9057) (undo-tree-id131 . -78) (undo-tree-id133 . -78) (undo-tree-id135 . -78) (undo-tree-id137 . -51) (undo-tree-id139 . -78) 9135) ((9057 . 9135)) (26809 42334 663750 0) 0 nil])
([nil nil ((9976 . 9979)) nil (26809 42368 946565 0) 0 nil])
([nil nil ((9057 . 9060)) ((#("ret" 0 3 (fontified t)) . 9057)) (26809 42334 309050 0) 0 nil])
([nil nil ((#("(entity->row-alist ent2)" 0 24 (fontified t)) . -10013) (undo-tree-id390 . -24) (undo-tree-id391 . -24) (undo-tree-id392 . -24) 10037) nil (26809 42368 946564 0) 0 nil])
([nil nil ((9053 . 9057) (t 26809 41759 0 0)) ((#("
	  " 0 1 (fontified t) 1 4 (fontified t)) . 9053) (undo-tree-id373 . -4) (undo-tree-id374 . -4) (undo-tree-id375 . -4) (undo-tree-id376 . -4) (undo-tree-id377 . -4) (undo-tree-id378 . -4) (undo-tree-id379 . -4) (undo-tree-id380 . -4) (undo-tree-id381 . -4) (undo-tree-id382 . -4) (undo-tree-id383 . -4) (undo-tree-id384 . -4) (undo-tree-id385 . -1) (undo-tree-id386 . -1) (undo-tree-id387 . -1) (undo-tree-id388 . -1) (undo-tree-id389 . -1)) (26809 42333 965878 0) 0 nil])
([nil nil ((10013 . 10016)) nil (26809 42368 946550 0) 0 nil])
([nil nil ((9057 . 9063)) ((#("(print" 0 6 (fontified t)) . 9057) (undo-tree-id361 . -6) (undo-tree-id362 . -6) (undo-tree-id363 . -6) (undo-tree-id364 . -6) (undo-tree-id365 . -6) (undo-tree-id366 . -6) (undo-tree-id367 . -6) (undo-tree-id368 . -6) (undo-tree-id369 . -6) (undo-tree-id370 . -6) (undo-tree-id371 . -6) (undo-tree-id372 . -6)) (26809 42333 659922 0) 0 nil])
([nil nil ((#("ret" 0 3 (fontified t)) . -9861) (undo-tree-id429 . -3) 9864 (t 26809 42368 0 0)) nil (26809 43046 250545 0) 0 nil])
([nil nil ((9063 . 9064)) ((#(" " 0 1 (fontified t)) . 9063) (undo-tree-id349 . -1) (undo-tree-id350 . -1) (undo-tree-id351 . -1) (undo-tree-id352 . -1) (undo-tree-id353 . -1) (undo-tree-id354 . -1) (undo-tree-id355 . -1) (undo-tree-id356 . -1) (undo-tree-id357 . -1) (undo-tree-id358 . -1) (undo-tree-id359 . -1) (undo-tree-id360 . -1)) (26809 42333 307557 0) 0 nil])
([nil nil ((9861 . 9865)) nil (26809 43046 250543 0) 0 nil])
([nil nil ((9064 . 9070)) ((#("\"RET\")" 0 5 (face font-lock-string-face fontified t) 5 6 (fontified t)) . 9064) (undo-tree-id337 . -6) (undo-tree-id338 . -6) (undo-tree-id339 . -6) (undo-tree-id340 . -6) (undo-tree-id341 . -6) (undo-tree-id342 . -6) (undo-tree-id343 . -6) (undo-tree-id344 . -6) (undo-tree-id345 . -6) (undo-tree-id346 . -6) (undo-tree-id347 . -6) (undo-tree-id348 . -6)) (26809 42332 867525 0) 0 nil])
([nil nil ((#("ret" 0 3 (fontified t)) . -9977) (undo-tree-id415 . -3) (undo-tree-id416 . -1) (undo-tree-id417 . -1) (undo-tree-id418 . -1) (undo-tree-id419 . -1) (undo-tree-id420 . -1) (undo-tree-id421 . -3) (undo-tree-id422 . -3) (undo-tree-id423 . -3) (undo-tree-id424 . -3) (undo-tree-id425 . -3) (undo-tree-id426 . -3) (undo-tree-id427 . -3) (undo-tree-id428 . -3) 9980) nil (26809 43046 250542 0) 0 nil])
([nil nil ((9070 . 9074)) ((#("
	  " 0 1 (fontified t) 1 4 (fontified t)) . 9070) (undo-tree-id324 . -4) (undo-tree-id325 . -1) (undo-tree-id326 . -4) (undo-tree-id327 . -4) (undo-tree-id328 . -4) (undo-tree-id329 . -4) (undo-tree-id330 . -1) (undo-tree-id331 . -1) (undo-tree-id332 . -1) (undo-tree-id333 . -1) (undo-tree-id334 . -1) (undo-tree-id335 . -1) (undo-tree-id336 . -1)) (26809 42332 506324 0) 0 nil])
([nil nil ((9977 . 9981)) nil (26809 43046 250532 0) 0 nil])
([nil nil ((9074 . 9080)) ((#("(prunt" 0 3 (fontified t) 3 4 (fontified t) 4 5 (fontified t) 5 6 (fontified t)) . 9074) (undo-tree-id319 . -6) (undo-tree-id320 . -3) (undo-tree-id321 . -3) (undo-tree-id322 . -3) (undo-tree-id323 . -3)) (26809 42332 156128 0) 0 nil])
([nil nil ((#("ret" 0 3 (fontified t)) . -10015) (undo-tree-id401 . -3) (undo-tree-id402 . -1) (undo-tree-id403 . -1) (undo-tree-id404 . -1) (undo-tree-id405 . -1) (undo-tree-id406 . -1) (undo-tree-id407 . -3) (undo-tree-id408 . -3) (undo-tree-id409 . -3) (undo-tree-id410 . -3) (undo-tree-id411 . -3) (undo-tree-id412 . -3) (undo-tree-id413 . -3) (undo-tree-id414 . -3) 10018) nil (26809 43046 250529 0) 0 nil])
([nil nil ((9080 . 9081)) ((#(" " 0 1 (fontified t)) . 9080) (undo-tree-id318 . -1)) (26809 42331 836716 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10038 . 10039) (nil fontified nil 10015 . 10039) (10015 . 10039)) nil (26809 43046 250503 0) 0 nil])
([nil nil ((#("u" 0 1 (fontified t)) . -9077) (undo-tree-id141 . -1) (#("n" 0 1 (fontified t)) . -9078) (undo-tree-id142 . -1) (#("t" 0 1 (fontified t)) . -9079) (undo-tree-id143 . -1) (#(" " 0 1 (fontified t)) . -9080) (undo-tree-id144 . -1) 9081) ((9077 . 9081)) (26809 42331 521893 0) 0 nil])
([nil nil ((9471 . 9476) (t 26809 43046 0 0)) nil (26809 45070 243 0) 0 nil])
([nil nil ((9077 . 9080)) ((#("int" 0 3 (fontified t)) . 9077) (undo-tree-id313 . -3) (undo-tree-id314 . -3) (undo-tree-id315 . -3) (undo-tree-id316 . -3) (undo-tree-id317 . -3)) (26809 42331 190395 0) 0 nil])
([nil nil ((9476 . 9482)) nil (26809 45070 243 0) 0 nil])
([nil nil ((9080 . 9081)) ((#(" " 0 1 (fontified t)) . 9080) (undo-tree-id308 . -1) (undo-tree-id309 . -1) (undo-tree-id310 . -1) (undo-tree-id311 . -1) (undo-tree-id312 . -1)) (26809 42330 840024 0) 0 nil])
([nil nil ((9482 . 9483)) nil (26809 45070 242 0) 0 nil])
([nil nil ((9081 . 9083)) ((#("re" 0 2 (fontified t)) . 9081) (undo-tree-id303 . -2) (undo-tree-id304 . -2) (undo-tree-id305 . -2) (undo-tree-id306 . -2) (undo-tree-id307 . -2)) (26809 42330 187400 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -9478) (undo-tree-id430 . -1) (#("i" 0 1 (fontified t)) . -9479) (undo-tree-id431 . -1) (#("n" 0 1 (fontified t)) . -9480) (undo-tree-id432 . -1) (#("t" 0 1 (fontified t)) . -9481) (undo-tree-id433 . -1) (#(" " 0 1 (fontified t)) . -9482) (undo-tree-id434 . -1) 9483) nil (26809 45070 240 0) 0 nil])
([nil nil ((9083 . 9085)) ((#("t)" 0 2 (fontified t)) . 9083)) (26809 42329 727566 0) 0 nil])
([nil nil ((9478 . 9482)) nil (26809 45070 227 0) 0 nil])
([nil nil ((9178 . 9181) (t 26809 42133 0 0)) ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . 9178) (undo-tree-id289 . -3) (undo-tree-id290 . -3) (undo-tree-id291 . -3) (undo-tree-id292 . -1) (undo-tree-id293 . -1) (undo-tree-id294 . -1) (undo-tree-id295 . -1) (undo-tree-id296 . -1) (undo-tree-id297 . -1) (undo-tree-id298 . -1) (undo-tree-id299 . -1) (undo-tree-id300 . -1) (undo-tree-id301 . -1) (undo-tree-id302 . -1)) (26809 42329 511296 0) 0 nil])
([nil nil ((9482 . 9483)) nil (26809 45070 226 0) 0 nil])
([nil nil ((9181 . 9187)) ((#("(print" 0 6 (fontified t)) . 9181) (undo-tree-id286 . -6) (undo-tree-id287 . -6) (undo-tree-id288 . -6)) (26809 42329 273275 0) 0 nil])
([nil nil ((9483 . 9491)) nil (26809 45070 221 0) 0 nil])
([nil nil ((9187 . 9188)) ((#(" " 0 1 (fontified t)) . 9187) (undo-tree-id283 . -1) (undo-tree-id284 . -1) (undo-tree-id285 . -1)) (26809 42329 54929 0) 0 nil])
([nil nil ((9222 . 9225) (t 26809 45070 0 0)) nil (26809 46036 394100 0) 0 nil])
([nil nil ((9188 . 9191)) ((#("\"IN" 0 3 (face font-lock-string-face fontified t)) . 9188) (undo-tree-id280 . -1) (undo-tree-id281 . -3) (undo-tree-id282 . -3)) (26809 42328 792057 0) 0 nil])
([nil nil ((9225 . 9231)) nil (26809 46036 394100 0) 0 nil])
([nil nil ((9191 . 9192)) ((#(" " 0 1 (face font-lock-string-face fontified t)) . 9191) (undo-tree-id278 . -1) (undo-tree-id279 . -1)) (26809 42328 527818 0) 0 nil])
([nil nil ((9231 . 9232)) nil (26809 46036 394099 0) 0 nil])
([nil nil ((9192 . 9196)) ((#("REPO" 0 4 (face font-lock-string-face fontified t)) . 9192) (undo-tree-id276 . -4) (undo-tree-id277 . -4)) (26809 42328 244346 0) 0 nil])
([nil nil ((9232 . 9241)) nil (26809 46036 394095 0) 0 nil])
([nil nil ((9196 . 9197)) ((#(" " 0 1 (face font-lock-string-face fontified t)) . 9196) (undo-tree-id274 . -1) (undo-tree-id275 . -1)) (26809 42327 948726 0) 0 nil])
([nil nil ((4399 . 4404) (t 26809 46036 0 0)) nil (26809 46119 429979 0) 0 nil])
([nil nil ((9197 . 9203)) ((#("PATCH\"" 0 6 (face font-lock-string-face fontified t)) . 9197) (undo-tree-id272 . -5) (undo-tree-id273 . -6)) (26809 42327 657461 0) 0 nil])
([nil nil ((4404 . 4410)) nil (26809 46119 429978 0) 0 nil])
([nil nil ((9203 . 9204)) ((#("à" 0 1 (fontified t)) . 9203) (undo-tree-id271 . -1)) (26809 42327 378594 0) 0 nil])
([nil nil ((4410 . 4411)) nil (26809 46119 429977 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -9203) (undo-tree-id186 . -1) 9204) ((9203 . 9204)) (26809 42327 30419 0) 0 nil])
([nil nil ((4411 . 4414)) nil (26809 46119 429972 0) 0 nil])
([nil nil ((9203 . 9204)) ((#(")" 0 1 (fontified t)) . 9203)) (26809 42326 475973 0) 0 nil])
([nil nil ((#("(print p1)" 0 10 (fontified t)) . 4404) (undo-tree-id435 . -10) (undo-tree-id436 . -10) (undo-tree-id437 . -10) (undo-tree-id438 . -10) (undo-tree-id439 . -10) (undo-tree-id440 . -10) (undo-tree-id441 . -10) (undo-tree-id442 . -10) (undo-tree-id443 . -10) (undo-tree-id444 . -10) (undo-tree-id445 . -10) (undo-tree-id446 . -10) (t 26809 46119 0 0)) nil (26809 46243 417233 0) 0 nil])
([nil nil ((9263 . 9266)) ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . 9263) (undo-tree-id267 . -3) (undo-tree-id268 . -3) (undo-tree-id269 . -1) (undo-tree-id270 . -1)) (26809 42326 137292 0) 0 nil])
([nil nil ((5138 . 5143)) nil (26809 46243 417216 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9321 . 9322) (nil fontified nil 9313 . 9322) (nil fontified nil 9305 . 9313) (nil fontified nil 9301 . 9305) (nil fontified nil 9298 . 9301) (nil fontified nil 9286 . 9298) (nil fontified nil 9280 . 9286) (nil fontified nil 9276 . 9280) (nil fontified nil 9266 . 9276) (9266 . 9322)) ((#("(repo-persist :patch entity ctx :id id :payload payload)" 0 10 (fontified nil) 10 14 (fontified nil) 14 20 (face font-lock-builtin-face fontified nil) 20 32 (fontified nil) 32 35 (face font-lock-builtin-face fontified nil) 35 39 (fontified nil) 39 47 (face font-lock-builtin-face fontified nil) 47 55 (fontified nil) 55 56 (fontified nil rear-nonsticky nil)) . 9266) (nil rear-nonsticky t 9321 . 9322)) (26809 42325 804259 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5152 . 5153) (nil fontified nil 5143 . 5153) (5143 . 5153)) nil (26809 46243 417213 0) 0 nil])
([nil nil ((9263 . 9266)) ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . 9263) (undo-tree-id256 . -3) (undo-tree-id257 . -3) (undo-tree-id258 . -3) (undo-tree-id259 . -1) (undo-tree-id260 . -1) (undo-tree-id261 . -1) (undo-tree-id262 . -1) (undo-tree-id263 . -1) (undo-tree-id264 . -1) (undo-tree-id265 . -1) (undo-tree-id266 . -1)) (26809 42325 544993 0) 0 nil])
([nil nil ((5380 . 5385) (t 26809 46243 0 0)) nil (26809 46328 172346 0) 0 nil])
([nil nil ((9266 . 9272)) ((#("(print" 0 6 (fontified t)) . 9266) (undo-tree-id253 . -6) (undo-tree-id254 . -6) (undo-tree-id255 . -6)) (26809 42325 288686 0) 0 nil])
([nil nil ((5330 . 5332)) nil (26809 46328 172346 0) 0 nil])
([nil nil ((9272 . 9273)) ((#(" " 0 1 (fontified t)) . 9272) (undo-tree-id250 . -1) (undo-tree-id251 . -1) (undo-tree-id252 . -1)) (26809 42325 8381 0) 0 nil])
([nil nil ((5357 . 5359)) nil (26809 46328 172345 0) 0 nil])
([nil nil ((9273 . 9274)) ((#("(" 0 1 (fontified t)) . 9273) (undo-tree-id247 . -1) (undo-tree-id248 . -1) (undo-tree-id249 . -1)) (26809 42324 734269 0) 0 nil])
([nil nil ((5384 . 5389)) nil (26809 46328 172345 0) 0 nil])
([nil nil ((9274 . 9278)) ((#("\"FAT" 0 1 (face font-lock-string-face fontified t) 1 2 (face font-lock-string-face fontified t) 2 3 (face font-lock-string-face fontified t) 3 4 (face font-lock-string-face fontified t)) . 9274) (undo-tree-id244 . -4) (undo-tree-id245 . -1) (undo-tree-id246 . -1)) (26809 42324 464307 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5413 . 5414) (nil fontified nil 5406 . 5414) (nil fontified nil 5396 . 5406) (nil fontified nil 5389 . 5396) (5389 . 5414)) nil (26809 46328 172344 0) 0 nil])
([nil nil ((#("F" 0 1 (face font-lock-string-face fontified t)) . -9275) (undo-tree-id183 . -1) (#("A" 0 1 (face font-lock-string-face fontified t)) . -9276) (undo-tree-id184 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -9277) (undo-tree-id185 . -1) 9278) ((9275 . 9278)) (26809 42324 178552 0) 0 nil])
([nil nil ((#("(acons :tenant_id tid p1)" 0 7 (fontified t) 7 17 (face font-lock-builtin-face fontified t) 17 24 (fontified t) 24 25 (rear-nonsticky t fontified t)) . -5389) (undo-tree-id447 . -25) (undo-tree-id448 . -25) (undo-tree-id449 . -25) (undo-tree-id450 . -4) (undo-tree-id451 . -4) (undo-tree-id452 . -4) (undo-tree-id453 . -4) (undo-tree-id454 . -4) (undo-tree-id455 . -1) (undo-tree-id456 . -6) (undo-tree-id457 . -6) (undo-tree-id458 . -1) (undo-tree-id459 . -6) (undo-tree-id460 . -6) (undo-tree-id461 . -6) (undo-tree-id462 . -6) (undo-tree-id463 . -6) (undo-tree-id464 . -6) (undo-tree-id465 . -1) (undo-tree-id466 . -25) (undo-tree-id467 . -25) (undo-tree-id468 . -25) (undo-tree-id469 . -25) (undo-tree-id470 . -25) (undo-tree-id471 . -25) 5414) nil (26809 46328 172342 0) 0 nil])
([nil nil ((9275 . 9280)) ((#("AFTER" 0 5 (face font-lock-string-face fontified t)) . 9275) (undo-tree-id234 . -5) (undo-tree-id235 . -5) (undo-tree-id236 . -5) (undo-tree-id237 . -5) (undo-tree-id238 . -5) (undo-tree-id239 . -5) (undo-tree-id240 . -5) (undo-tree-id241 . -5) (undo-tree-id242 . -5) (undo-tree-id243 . -5)) (26809 42323 894714 0) 0 nil])
([nil nil ((nil fontified nil 5440 . 5441) (nil fontified nil 5435 . 5440) (nil fontified nil 5430 . 5435) (nil fontified nil 5425 . 5430) (nil fontified nil 5415 . 5425) (nil fontified nil 5389 . 5415) (5389 . 5441)) nil (26809 46328 172313 0) 0 nil])
([nil nil ((9280 . 9281)) ((#(" " 0 1 (face font-lock-string-face fontified t)) . 9280) (undo-tree-id224 . -1) (undo-tree-id225 . -1) (undo-tree-id226 . -1) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -1) (undo-tree-id232 . -1) (undo-tree-id233 . -1)) (26809 42323 586180 0) 0 nil])
([nil nil ((9683 . 9685) (t 26809 46328 0 0)) nil (26809 46398 572879 0) 0 nil])
([nil nil ((9281 . 9285)) ((#("REPO" 0 4 (face font-lock-string-face fontified t)) . 9281) (undo-tree-id214 . -4) (undo-tree-id215 . -4) (undo-tree-id216 . -4) (undo-tree-id217 . -4) (undo-tree-id218 . -4) (undo-tree-id219 . -4) (undo-tree-id220 . -4) (undo-tree-id221 . -4) (undo-tree-id222 . -4) (undo-tree-id223 . -4)) (26809 42323 295186 0) 0 nil])
([nil nil ((9862 . 9864)) nil (26809 46398 572875 0) 0 nil])
([nil nil ((9285 . 9286)) ((#(" " 0 1 (face font-lock-string-face fontified t)) . 9285) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) (undo-tree-id207 . -1) (undo-tree-id208 . -1) (undo-tree-id209 . -1) (undo-tree-id210 . -1) (undo-tree-id211 . -1) (undo-tree-id212 . -1) (undo-tree-id213 . -1)) (26809 42322 998513 0) 0 nil])
([nil nil ((10433 . 10439) (10389 . 10391) (10430 . 10431) (t 26809 46398 0 0)) nil (26809 46984 818997 0) 0 nil])
([nil nil ((9286 . 9293)) ((#("PATCH\")" 0 6 (face font-lock-string-face fontified t) 6 7 (fontified t)) . 9286) (undo-tree-id195 . -7) (undo-tree-id196 . -5) (undo-tree-id197 . -5) (undo-tree-id198 . -5) (undo-tree-id199 . -5) (undo-tree-id200 . -7) (undo-tree-id201 . -7) (undo-tree-id202 . -7) (undo-tree-id203 . -7)) (26809 42322 684433 0) 0 nil])
([nil nil ((10439 . 10445)) nil (26809 46984 818997 0) 0 nil])
([nil nil ((9207 . 9213)) ((#("(print" 0 6 (fontified t)) . 9207) (undo-tree-id194 . -6)) (26809 42322 355043 0) 0 nil])
([nil nil ((10445 . 10446)) nil (26809 46984 818996 0) 0 nil])
([nil nil ((9213 . 9214)) ((#(" " 0 1 (fontified t)) . 9213)) (26809 42321 950126 0) 0 nil])
([nil nil ((10446 . 10449)) nil (26809 46984 818996 0) 0 nil])
([nil nil ((9270 . 9271)) ((#(")" 0 1 (fontified t)) . 9270) (undo-tree-id192 . -1) (undo-tree-id193 . -1)) (26809 42321 583414 0) 0 nil])
([nil nil ((10449 . 10450)) nil (26809 46984 818996 0) 0 nil])
([nil nil ((9301 . 9302)) ((#(")" 0 1 (fontified t)) . 9301)) (26809 42321 241046 0) 0 nil])
([nil nil ((10450 . 10454)) nil (26809 46984 818995 0) 0 nil])
([nil nil ((9204 . 9205)) ((#(")" 0 1 (fontified t)) . 9204) (undo-tree-id191 . -1)) (26809 42320 852087 0) 0 nil])
([nil nil ((10454 . 10455)) nil (26809 46984 818995 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9204) (undo-tree-id175 . -1) (undo-tree-id177 . -1) (undo-tree-id179 . -1) (undo-tree-id181 . -1) 9205) ((9204 . 9205)) (26809 42320 506854 0) 0 nil])
([nil nil ((10455 . 10464)) nil (26809 46984 818994 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9301) (undo-tree-id165 . -1) (undo-tree-id167 . -1) (undo-tree-id169 . -1) (undo-tree-id171 . -1) (undo-tree-id173 . -1) 9302) ((9301 . 9302)) (26809 42320 178614 0) 0 nil])
([nil nil ((10550 . 10556) (10506 . 10508) (10547 . 10548)) nil (26809 46984 818994 0) 0 nil])
([nil nil ((9301 . 9302)) ((#(")" 0 1 (fontified t)) . 9301) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1)) (26809 42319 848087 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10580 . 10581) (nil fontified nil 10580 . 10581) (nil fontified nil 10563 . 10580) (nil fontified nil 10556 . 10563) (10556 . 10581)) nil (26809 46984 818993 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -9281) (undo-tree-id158 . -1) (undo-tree-id160 . -1) (undo-tree-id162 . -1) (undo-tree-id164 . -1) 9282) ((9281 . 9282)) (26809 42319 536858 0) 0 nil])
([nil nil ((10579 . 10580)) nil (26809 46984 818992 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9300) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id148 . -1) (undo-tree-id150 . -1) (undo-tree-id152 . -1) (undo-tree-id154 . -1) (undo-tree-id156 . -1) 9301) ((9300 . 9301) (t 26809 42207 0 0)) (26809 42207 465429 0) 0 nil])
([nil nil ((10580 . 10582)) nil (26809 46984 818991 0) 0 nil])
nil
([nil nil ((10591 . 10593) (10469 . 10471) 10278) nil (26809 46984 818988 0) 0 nil])
([nil nil ((10586 . 10593) (t 26809 46984 0 0)) nil (26809 47194 274956 0) 0 nil])
([nil nil ((10593 . 10599)) nil (26809 47194 274955 0) 0 nil])
([nil nil ((10599 . 10600)) nil (26809 47194 274955 0) 0 nil])
([nil nil ((10600 . 10603)) nil (26809 47194 274954 0) 0 nil])
([nil nil ((2521 . 2523)) nil (26809 47194 274953 0) 0 nil])
([nil nil ((#("x" 0 1 (fontified t)) . -2521) (undo-tree-id472 . -1) (#("b" 0 1 (fontified t)) . -2522) (undo-tree-id473 . -1) 2523) nil (26809 47194 274950 0) 0 nil])
([nil nil ((6022 . 6025) (t 26809 47194 0 0)) nil (26809 47585 674223 0) 0 nil])
([nil nil ((6025 . 6031)) nil (26809 47585 674223 0) 0 nil])
([nil nil ((6031 . 6032)) nil (26809 47585 674222 0) 0 nil])
([nil nil ((6032 . 6036)) nil (26809 47585 674222 0) 0 nil])
([nil nil ((6036 . 6039)) nil (26809 47585 674222 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -6035) (undo-tree-id481 . -1) 6036) nil (26809 47585 674221 0) 0 nil])
([nil nil ((6035 . 6036)) nil (26809 47585 674220 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 6036) (undo-tree-id478 . -1) (undo-tree-id479 . -1) (undo-tree-id480 . -1)) nil (26809 47585 674219 0) 0 nil])
([nil nil ((#("	 " 0 1 (fontified nil) 1 2 (fontified nil)) . -6039) (undo-tree-id474 . -2) (undo-tree-id475 . -2) (undo-tree-id476 . -2) (undo-tree-id477 . -2) (6039 . 6040) (#("	" 0 1 (fontified nil)) . 6039) (6036 . 6039)) nil (26809 47585 674216 0) 0 nil])
([nil nil ((6039 . 6045)) nil (26809 47585 674204 0) 0 nil])
([nil nil ((6045 . 6046)) nil (26809 47585 674204 0) 0 nil])
([nil nil ((6046 . 6053)) nil (26809 47585 674200 0) 0 nil])
([nil nil ((12181 . 12183) (t 26809 47585 0 0)) nil (26809 47724 266721 0) 0 nil])
([nil nil ((12183 . 12184)) nil (26809 47724 266721 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -12183) (undo-tree-id490 . -1) 12184) nil (26809 47724 266720 0) 0 nil])
([nil nil ((12183 . 12188)) nil (26809 47724 266719 0) 0 nil])
([nil nil ((12188 . 12189)) nil (26809 47724 266719 0) 0 nil])
([nil nil ((12189 . 12190)) nil (26809 47724 266719 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -12183) (undo-tree-id483 . -1) (#("r" 0 1 (fontified t)) . -12184) (undo-tree-id484 . -1) (#("i" 0 1 (fontified t)) . -12185) (undo-tree-id485 . -1) (#("n" 0 1 (fontified t)) . -12186) (undo-tree-id486 . -1) (#("t" 0 1 (fontified t)) . -12187) (undo-tree-id487 . -1) (#(" " 0 1 (fontified t)) . -12188) (undo-tree-id488 . -1) (#("'" 0 1 (fontified t)) . -12189) (undo-tree-id489 . -1) 12190) nil (26809 47724 266718 0) 0 nil])
([nil nil ((12183 . 12189)) nil (26809 47724 266712 0) 0 nil])
([nil nil ((12189 . 12190)) nil (26809 47724 266711 0) 0 nil])
([nil nil ((12190 . 12191)) nil (26809 47724 266711 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -12190) (undo-tree-id482 . -1) 12191) nil (26809 47724 266710 0) 0 nil])
([nil nil ((12190 . 12197)) nil (26809 47724 266701 0) 0 nil])
([nil nil ((12197 . 12198)) nil (26809 47724 266701 0) 0 nil])
([nil nil ((12198 . 12206)) nil (26809 47724 266700 0) 0 nil])
([nil nil ((12206 . 12208)) nil (26809 47724 266700 0) 0 nil])
([nil nil ((12208 . 12214)) nil (26809 47724 266699 0) 0 nil])
([nil nil ((12214 . 12215)) nil (26809 47724 266699 0) 0 nil])
([nil nil ((12215 . 12219)) nil (26809 47724 266695 0) 0 nil])
([nil nil ((6022 . 6025) (t 26809 47724 0 0)) nil (26809 47774 116141 0) 0 nil])
([nil nil ((6025 . 6031)) nil (26809 47774 116140 0) 0 nil])
([nil nil ((6031 . 6032)) nil (26809 47774 116140 0) 0 nil])
([nil nil ((6032 . 6035)) nil (26809 47774 116140 0) 0 nil])
([nil nil ((6035 . 6036)) nil (26809 47774 116139 0) 0 nil])
([nil nil ((6036 . 6040)) nil (26809 47774 116139 0) 0 nil])
([nil nil ((6040 . 6041)) nil (26809 47774 116138 0) 0 nil])
([nil nil ((6041 . 6047)) nil (26809 47774 116138 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -6046) (undo-tree-id491 . -1) (undo-tree-id492 . -1) 6047) nil (26809 47774 116137 0) 0 nil])
([nil nil ((6046 . 6048)) nil (26809 47774 116123 0) 0 nil])
([nil nil ((6048 . 6049) (t 26809 47774 0 0)) nil (26809 47777 64693 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -6048) (undo-tree-id493 . -1) (undo-tree-id494 . -1) (undo-tree-id495 . -1) (undo-tree-id496 . -1) (undo-tree-id497 . -1) 6049 (t 26809 47777 0 0)) nil (26809 47778 295272 0) 0 nil])
([nil nil ((#("list" 0 4 (fontified t)) . -10668) (undo-tree-id498 . -4) (undo-tree-id499 . -4) (undo-tree-id500 . -4) 10672 (t 26809 47778 0 0)) nil (26809 48002 674943 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 10668)) nil (26809 48002 674932 0) 0 nil])
([nil nil ((10667 . 10669)) nil (26809 48002 674931 0) 0 nil])
([nil nil ((10685 . 10686)) nil (26809 48002 674930 0) 0 nil])
([nil nil ((10692 . 10693)) nil (26809 48002 674926 0) 0 nil])
([nil nil ((10680 . 10681) (t 26809 48002 0 0)) nil (26809 48015 473173 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -10680) (undo-tree-id501 . -1) (undo-tree-id502 . -1) (undo-tree-id503 . -1) (undo-tree-id504 . -1) (undo-tree-id505 . -1) (undo-tree-id506 . -1) (undo-tree-id507 . -1) (undo-tree-id508 . -1) (undo-tree-id509 . -1) (undo-tree-id510 . -1) (undo-tree-id511 . -1) 10681) nil (26809 48015 473171 0) 0 nil])
([nil nil ((10680 . 10681)) nil (26809 48015 473154 0) 0 nil])
([nil nil ((10679 . 10680)) nil (26809 48015 473154 0) 0 nil])
([nil nil ((10680 . 10681)) nil (26809 48015 473153 0) 0 nil])
([nil nil ((10684 . 10685)) nil (26809 48015 473153 0) 0 nil])
([nil nil ((10688 . 10689)) nil (26809 48015 473152 0) 0 nil])
([nil nil ((10689 . 10690)) nil (26809 48015 473148 0) 0 nil])
([nil nil ((#("
	    (print \"AAAAAA\")
	    (print ent2)
	    (print \"JJJJ\")" 0 1 (fontified t) 1 13 (fontified t) 13 21 (face font-lock-string-face fontified t) 21 23 (fontified t) 23 39 (fontified t) 39 41 (fontified t) 41 53 (fontified t) 53 59 (face font-lock-string-face fontified t) 59 60 (fontified t)) . 10128) (undo-tree-id583 . -60) (t 26809 48015 0 0)) nil (26810 37955 317941 0) 0 nil])
([nil nil ((#("
      (print \"ZZZZZZZZZZZ\")" 0 1 (fontified t) 1 14 (fontified t) 14 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 9952) (undo-tree-id582 . -28)) nil (26810 37955 317940 0) 0 nil])
([nil nil ((#("
    (print \"CURRRRR\")
    (print cur)
    (print payload)" 0 1 (fontified t) 1 12 (fontified t) 12 20 (face font-lock-string-face fontified t) 20 21 (face font-lock-string-face fontified t) 21 23 (fontified t) 23 39 (fontified t) 39 58 (fontified t)) . 9595) (undo-tree-id581 . -58)) nil (26810 37955 317939 0) 0 nil])
([nil nil ((#("
  (print \"INNNNN\")" 0 1 (fontified t) 1 10 (fontified t) 10 18 (face font-lock-string-face fontified t) 18 19 (fontified t)) . 9365) (undo-tree-id580 . -19)) nil (26810 37955 317938 0) 0 nil])
([nil nil ((#("
	  (print \"IN B\")" 0 1 (fontified t) 1 11 (fontified t) 11 17 (face font-lock-string-face fontified t) 17 18 (fontified t)) . 9233) (undo-tree-id579 . -18)) nil (26810 37955 317937 0) 0 nil])
([nil nil ((#("
	(print \"IN A\")" 0 1 (fontified t) 1 9 (fontified t) 9 15 (face font-lock-string-face fontified t) 15 16 (fontified t)) . 9092) (undo-tree-id578 . -16)) nil (26810 37955 317936 0) 0 nil])
([nil nil ((#("
    (print \"XXXX\")" 0 12 (fontified t) 12 18 (face font-lock-string-face fontified t) 18 19 (fontified t)) . 9036) (undo-tree-id577 . -19)) nil (26810 37955 317935 0) 0 nil])
([nil nil ((#("
    (print \"ENTTTTT\")" 0 12 (fontified t) 12 21 (face font-lock-string-face fontified t) 21 22 (fontified t)) . 8987) (undo-tree-id576 . -22)) nil (26810 37955 317934 0) 0 nil])
([nil nil ((#("
	(print \"DELETE AROUND\")
	(print res)" 0 1 (fontified t) 1 9 (fontified t) 9 24 (face font-lock-string-face fontified t) 24 26 (fontified t) 26 38 (fontified t)) . 11972) (undo-tree-id575 . -38)) nil (26810 37955 317933 0) 0 nil])
([nil nil ((#("
	  (print \"REPO AFTER\")" 0 1 (fontified t) 1 11 (fontified t) 11 12 (face font-lock-string-face fontified t) 12 22 (face font-lock-string-face fontified t) 22 23 (face font-lock-string-face fontified t) 23 24 (fontified t)) . 11208) (undo-tree-id574 . -24)) nil (26810 37955 317932 0) 0 nil])
([nil nil ((#("
      (print \"IN REPO PERSIST 11\")
      (print id)" 0 1 (fontified t) 1 7 (fontified t) 7 14 (fontified t) 14 34 (face font-lock-string-face fontified t) 34 35 (fontified t rear-nonsticky t) 35 36 (fontified t) 36 52 (fontified t)) . 10368) (undo-tree-id573 . -52)) nil (26810 37955 317931 0) 0 nil])
([nil nil ((#("
      (print \"IN REPO PERSIST\")" 0 1 (fontified t) 1 14 (fontified t) 14 31 (face font-lock-string-face fontified t) 31 32 (fontified t)) . 10249) (undo-tree-id570 . -32) (undo-tree-id571 . -32) (undo-tree-id572 . -32)) nil (26810 37955 317930 0) 0 nil])
([nil nil ((#("
  (print \"IN REPO AFTER\")
  (print ctx)
  (print result)" 0 1 (fontified t) 1 10 (fontified t) 10 25 (face font-lock-string-face fontified t) 25 26 (fontified t) 26 27 (fontified t) 27 41 (fontified t) 41 57 (fontified t)) . 6022) (undo-tree-id569 . -57)) nil (26810 37955 317928 0) 0 nil])
([nil nil ((#("
     (print \"ENT\")
     (print ent)" 0 13 (fontified t) 13 18 (face font-lock-string-face fontified t) 18 36 (fontified t)) . 5686) (undo-tree-id568 . -36)) nil (26810 37955 317927 0) 0 nil])
([nil nil ((#("
  (print \"**** IN REPO-VALIDATE\")" 0 1 (face font-lock-comment-face fontified t) 1 10 (fontified t) 10 33 (face font-lock-string-face fontified t) 33 34 (fontified t)) . 5589) (undo-tree-id567 . -34)) nil (26810 37955 317926 0) 0 nil])
([nil nil ((#("
    (format t \"~&TID: ~A~%\" tid)
    (print p1)" 0 1 (fontified t) 1 5 (fontified t) 5 15 (fontified t) 15 28 (fontified t face font-lock-string-face) 28 32 (fontified t) 32 33 (fontified t rear-nonsticky t) 33 34 (fontified t) 34 38 (fontified t) 38 47 (fontified t) 47 48 (fontified t rear-nonsticky t)) . 5105) (undo-tree-id566 . -48)) nil (26810 37955 317926 0) 0 nil])
([nil nil ((#("
	 (x (print p1))" 0 1 (fontified t) 1 3 (fontified t) 3 16 (fontified t) 16 17 (fontified t rear-nonsticky t)) . 5044) (undo-tree-id565 . -17)) nil (26810 37955 317925 0) 0 nil])
([nil nil ((#("
	 (x (print p0))" 0 1 (fontified t) 1 3 (fontified t) 3 16 (fontified t) 16 17 (fontified t rear-nonsticky t)) . 4983) (undo-tree-id564 . -17)) nil (26810 37955 317924 0) 0 nil])
([nil nil ((#("
	 (x (print out))" 0 1 (fontified t) 1 18 (fontified t)) . 4921) (undo-tree-id563 . -18)) nil (26810 37955 317923 0) 0 nil])
([nil nil ((#("
    (format t \"~&TID: ~A~%\" tid)" 0 1 (face font-lock-comment-face fontified t) 1 15 (fontified t) 15 28 (face font-lock-string-face fontified t) 28 33 (fontified t)) . 4366) (undo-tree-id562 . -33)) nil (26810 37955 317922 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4042) (undo-tree-id556 . -1) (#(" " 0 1 (fontified t)) . -4043) (undo-tree-id557 . -1) (#(" " 0 1 (fontified t)) . -4044) (undo-tree-id558 . -1) (#(" " 0 1 (fontified t)) . -4045) (undo-tree-id559 . -1) (#(" " 0 1 (fontified t)) . -4046) (undo-tree-id560 . -1) (#(" " 0 1 (fontified t)) . -4047) (undo-tree-id561 . -1) 4048) nil (26810 37955 317920 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4125) (undo-tree-id550 . -1) (#(" " 0 1 (fontified t)) . -4126) (undo-tree-id551 . -1) (#(" " 0 1 (fontified t)) . -4127) (undo-tree-id552 . -1) (#(" " 0 1 (fontified t)) . -4128) (undo-tree-id553 . -1) (#(" " 0 1 (fontified t)) . -4129) (undo-tree-id554 . -1) (#(" " 0 1 (fontified t)) . -4130) (undo-tree-id555 . -1) 4131) nil (26810 37955 317916 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4122) (undo-tree-id547 . -1) (#(" " 0 1 (fontified t)) . -4123) (undo-tree-id548 . -1) (#(" " 0 1 (fontified t)) . -4124) (undo-tree-id549 . -1) 4125) nil (26810 37955 317912 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4039) (undo-tree-id544 . -1) (#(" " 0 1 (fontified t)) . -4040) (undo-tree-id545 . -1) (#(" " 0 1 (fontified t)) . -4041) (undo-tree-id546 . -1) 4042) nil (26810 37955 317909 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4206) (undo-tree-id535 . -1) (#(" " 0 1 (fontified t)) . -4207) (undo-tree-id536 . -1) (#(" " 0 1 (fontified t)) . -4208) (undo-tree-id537 . -1) (#(" " 0 1 (fontified t)) . -4209) (undo-tree-id538 . -1) (#(" " 0 1 (fontified t)) . -4210) (undo-tree-id539 . -1) (#(" " 0 1 (fontified t)) . -4211) (undo-tree-id540 . -1) (#(" " 0 1 (fontified t)) . -4212) (undo-tree-id541 . -1) (#(" " 0 1 (fontified t)) . -4213) (undo-tree-id542 . -1) (#(" " 0 1 (fontified t)) . -4214) (undo-tree-id543 . -1) 4215) nil (26810 37955 317906 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4290) (undo-tree-id523 . -1) (#(" " 0 1 (fontified t)) . -4291) (undo-tree-id524 . -1) (#(" " 0 1 (fontified t)) . -4292) (undo-tree-id525 . -1) (#(" " 0 1 (fontified t)) . -4293) (undo-tree-id526 . -1) (#(" " 0 1 (fontified t)) . -4294) (undo-tree-id527 . -1) (#(" " 0 1 (fontified t)) . -4295) (undo-tree-id528 . -1) (#(" " 0 1 (fontified t)) . -4296) (undo-tree-id529 . -1) (#(" " 0 1 (fontified t)) . -4297) (undo-tree-id530 . -1) (#(" " 0 1 (fontified t)) . -4298) (undo-tree-id531 . -1) (#(" " 0 1 (fontified t)) . -4299) (undo-tree-id532 . -1) (#(" " 0 1 (fontified t)) . -4300) (undo-tree-id533 . -1) (#(" " 0 1 (fontified t)) . -4301) (undo-tree-id534 . -1) 4302) nil (26810 37955 317899 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4203) (undo-tree-id520 . -1) (#(" " 0 1 (fontified t)) . -4204) (undo-tree-id521 . -1) (#(" " 0 1 (fontified t)) . -4205) (undo-tree-id522 . -1) 4206) nil (26810 37955 317892 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4116) (undo-tree-id517 . -1) (#(" " 0 1 (fontified t)) . -4117) (undo-tree-id518 . -1) (#(" " 0 1 (fontified t)) . -4118) (undo-tree-id519 . -1) 4119) nil (26810 37955 317889 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -4036) (undo-tree-id514 . -1) (#(" " 0 1 (fontified t)) . -4037) (undo-tree-id515 . -1) (#(" " 0 1 (fontified t)) . -4038) (undo-tree-id516 . -1) 4039) nil (26810 37955 317884 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3664) (undo-tree-id513 . -1) 3665) nil (26810 37955 317881 0) 0 nil])
([nil nil ((3664 . 3665)) nil (26810 37955 317878 0) 0 nil])
([nil nil ((#("
	(print \"ROWS\")
	(print row)" 0 9 (fontified t) 9 15 (face font-lock-string-face fontified t) 15 29 (fontified t)) . 13727) (undo-tree-id512 . -29)) nil (26810 37955 317874 0) 0 nil])
([nil nil ((#(" :tenant-id-for-host :tenant-id-by-code :tenant-code-by-id" 0 1 (fontified t) 1 20 (face font-lock-builtin-face fontified t) 20 21 (fontified t) 21 39 (face font-lock-builtin-face fontified t) 39 40 (fontified t) 40 58 (face font-lock-builtin-face fontified t)) . -965) (undo-tree-id617 . -2) (undo-tree-id618 . -20) (undo-tree-id619 . -58) 1023 (t 26810 37955 0 0)) nil (26810 38044 874596 0) 0 nil])
([nil nil ((650 . 652) (#(" " 0 1 (fontified nil)) . -611) (650 . 651)) nil (26810 38044 874593 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 761 . 762) (nil fontified nil 761 . 762) (nil fontified nil 760 . 761) (nil fontified nil 747 . 760) (nil fontified nil 746 . 747) (nil fontified nil 745 . 746) (nil fontified nil 727 . 745) (nil fontified nil 724 . 727) (nil fontified nil 723 . 724) (nil fontified nil 704 . 723) (nil fontified nil 703 . 704) (nil fontified nil 685 . 703) (nil fontified nil 684 . 685) (nil fontified nil 666 . 684) (nil fontified nil 665 . 666) (nil fontified nil 653 . 665) (nil fontified nil 652 . 653) (652 . 762)) nil (26810 38044 874592 0) 0 nil])
([nil nil ((#(":normalize-host" 0 1 (face font-lock-builtin-face fontified t) 1 14 (face font-lock-builtin-face fontified t) 14 15 (face font-lock-builtin-face fontified t rear-nonsticky t)) . -746) (undo-tree-id603 . -15) (undo-tree-id604 . -10) (undo-tree-id605 . -10) (undo-tree-id606 . -10) (undo-tree-id607 . -10) (undo-tree-id608 . -10) (undo-tree-id609 . -15) (undo-tree-id610 . -15) (undo-tree-id611 . -15) (undo-tree-id612 . -15) (undo-tree-id613 . -15) (undo-tree-id614 . -15) (undo-tree-id615 . -15) (undo-tree-id616 . -15) 761) nil (26810 38044 874588 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -745) (undo-tree-id584 . -1) (undo-tree-id585 . -1) (undo-tree-id586 . -1) (undo-tree-id587 . -1) (undo-tree-id588 . -1) (undo-tree-id589 . -1) (undo-tree-id590 . -1) (undo-tree-id591 . -1) (undo-tree-id592 . -1) (undo-tree-id593 . -1) (undo-tree-id594 . -1) (undo-tree-id595 . -1) (undo-tree-id596 . -1) (undo-tree-id597 . -1) (undo-tree-id598 . -1) (undo-tree-id599 . -1) (undo-tree-id600 . -1) (undo-tree-id601 . -1) (undo-tree-id602 . -1) 746) nil (26810 38044 874578 0) 0 nil])
([nil nil ((#("
	 (x (format t \"P TID: ~A~%\" p-tid))" 0 1 (fontified t) 1 11 (fontified t) 11 16 (fontified t) 16 19 (face font-lock-string-face fontified t) 19 29 (face font-lock-string-face fontified t) 29 37 (fontified t)) . 15742) (undo-tree-id622 . -37) (t 26810 38044 0 0)) nil (26810 38822 958582 0) 0 nil])
([nil nil ((#("
	 (x (print payload))" 0 1 (fontified t) 1 22 (fontified t)) . 15602) (undo-tree-id621 . -22)) nil (26810 38822 958579 0) 0 nil])
([nil nil ((#("
	     (print \"C'EST PTID\")" 0 1 (face font-lock-comment-face fontified t) 1 14 (fontified t) 14 17 (face font-lock-string-face fontified t) 17 26 (face font-lock-string-face fontified t) 26 27 (fontified t)) . 15947) (undo-tree-id620 . -27)) nil (26810 38822 958575 0) 0 nil])
([nil nil ((164 . 165) (t 26810 38822 0 0)) nil (26812 49442 76477 0) 0 nil])
([nil nil ((165 . 172)) nil (26812 49442 76476 0) 0 nil])
([nil nil ((165 . 176) (#("respond" 0 7 (fontified t)) . -165) (undo-tree-id0 . -7) (undo-tree-id1 . -7) (undo-tree-id2 . -7) (undo-tree-id3 . -7) 172) nil (26812 49442 76474 0) 0 nil])
([nil nil ((165 . 166)) nil (26812 49442 76445 0) 0 nil])
([nil nil ((#("entity" 0 6 (fontified t)) . -5400) (undo-tree-id59 . -6) 5406 (t 26812 49442 0 0)) nil (26812 50233 431231 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -5399) (undo-tree-id57 . -1) (undo-tree-id58 . -1) 5400) nil (26812 50233 431229 0) 0 nil])
([nil nil ((#("entity" 0 6 (fontified t)) . -5796) (undo-tree-id56 . -6) 5802) nil (26812 50233 431227 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -5792) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (#("o" 0 1 (fontified t)) . -5793) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (#("p" 0 1 (fontified t)) . -5794) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (#(" " 0 1 (fontified t)) . -5795) (undo-tree-id54 . -1) (undo-tree-id55 . -1) 5796) nil (26812 50233 431225 0) 0 nil])
([nil nil ((#(" :before before" 0 1 (fontified t) 1 8 (face font-lock-builtin-face fontified t) 8 15 (fontified t)) . -7537) (undo-tree-id47 . -15) 7552) nil (26812 50233 431220 0) 0 nil])
([nil nil ((#("
         " 0 1 (fontified t) 1 10 (fontified t)) . -7558) (undo-tree-id46 . -10) 7568) nil (26812 50233 431218 0) 0 nil])
([nil nil ((7558 . 7559)) nil (26812 50233 431217 0) 0 nil])
([nil nil ((9156 . 9157)) nil (26812 50233 431217 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9163 . 9164) (nil fontified nil 9157 . 9164) (9157 . 9164)) nil (26812 50233 431216 0) 0 nil])
([nil nil ((#("payload" 0 6 (fontified t) 6 7 (rear-nonsticky t fontified t)) . -9157) (undo-tree-id45 . -7) 9164) nil (26812 50233 431215 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -9156) (undo-tree-id43 . -1) (undo-tree-id44 . -1) 9157) nil (26812 50233 431213 0) 0 nil])
([nil nil ((9877 . 9880)) nil (26812 50233 431207 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9901 . 9902) (nil fontified nil 9900 . 9902) (nil fontified nil 9888 . 9900) (nil fontified nil 9881 . 9888) (nil fontified nil 9880 . 9881) (9880 . 9902)) nil (26812 50233 431206 0) 0 nil])
([nil nil ((9900 . 9901)) nil (26812 50233 431205 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9907 . 9908) (nil fontified nil 9901 . 9908) (9901 . 9908)) nil (26812 50233 431205 0) 0 nil])
([nil nil ((#("(or " 0 4 (fontified t)) . -15966) (undo-tree-id42 . -4) 15970) nil (26812 50233 431204 0) 0 nil])
([nil nil ((#("
                 ;; dernier recours: NIL provoquera une erreur contrôlée
                 nil" 0 18 (fontified t) 18 21 (face font-lock-comment-delimiter-face fontified t) 21 74 (face font-lock-comment-face fontified t) 74 94 (fontified t)) . -16216) (undo-tree-id22 . -94) (undo-tree-id23 . -29) (undo-tree-id24 . -73) (undo-tree-id25 . -73) (undo-tree-id26 . -18) (undo-tree-id27 . -18) (undo-tree-id28 . -18) (undo-tree-id29 . -18) (undo-tree-id30 . -18) (undo-tree-id31 . -18) (undo-tree-id32 . -18) (undo-tree-id33 . -18) (undo-tree-id34 . -18) (undo-tree-id35 . -94) (undo-tree-id36 . -94) (undo-tree-id37 . -94) (undo-tree-id38 . -94) (undo-tree-id39 . -74) (undo-tree-id40 . -94) (undo-tree-id41 . -94) 16310) nil (26812 50233 431200 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -16217) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 16218) nil (26812 50233 431179 0) 0 nil])
([nil nil ((#("(defun tenant-id-by-code (code)
  ;; SELECT id FROM tenants WHERE code = $1 LIMIT 1
  (lumen.data.db:ensure-connection
      (let ((row (lumen.data.repo.query:select*
		  :tenants :filters (list '= :code code) :limit 1)))
	(when (and row (first row))
	  (cdr (assoc :id (first row)))))))

(defun tenant-id-for-host (host)
  ;; à toi de voir : table tenant_domains, ou mapping mémoire dev
  ;; ex: SELECT t.id FROM tenant_domains d JOIN tenants t ON t.id=d.tenant_id WHERE d.host=$1 LIMIT 1
  (print host)
  (lumen.data.db:ensure-connection
      (let ((row (lumen.data.repo.query:select*
		  :tenant_domains :filters (list '= :host host)
				  :select '(:tenant_id) :limit 1)))
	(when (and row (first row))
	  (cdr (assoc :tenant_id (first row)))))))

(defun tenant-code-by-id (tid)
  \"Retourne le code (string) du tenant ayant l’ID TID.
   Renvoie NIL si aucun tenant n’existe.\"
  (when tid
    (lumen.data.db:ensure-connection
	(let ((row (lumen.data.db:query-1a \"SELECT code FROM tenants WHERE id=$1\" tid)))
	  (and row (cdr (assoc :code row)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 24 (face font-lock-function-name-face fontified t) 24 34 (fontified t) 34 37 (face font-lock-comment-delimiter-face fontified t) 37 84 (face font-lock-comment-face fontified t) 84 126 (fontified t) 126 129 (face font-lock-keyword-face fontified t) 129 171 (fontified t) 171 179 (face font-lock-builtin-face fontified t) 179 180 (fontified t) 180 188 (face font-lock-builtin-face fontified t) 188 198 (fontified t) 198 203 (face font-lock-builtin-face fontified t) 203 210 (fontified t) 210 216 (face font-lock-builtin-face fontified t) 216 224 (fontified t) 224 228 (face font-lock-keyword-face fontified t) 228 266 (fontified t) 266 269 (face font-lock-builtin-face fontified t) 269 289 (fontified t) 289 290 (fontified t) 290 295 (face font-lock-keyword-face fontified t) 295 296 (fontified t) 296 314 (face font-lock-function-name-face fontified t) 314 324 (fontified t) 324 327 (face font-lock-comment-delimiter-face fontified t) 327 388 (face font-lock-comment-face fontified t) 388 390 (fontified t) 390 393 (face font-lock-comment-delimiter-face fontified t) 393 490 (face font-lock-comment-face fontified t) 490 547 (fontified t) 547 550 (face font-lock-keyword-face fontified t) 550 592 (fontified t) 592 607 (face font-lock-builtin-face fontified t) 607 608 (fontified t) 608 616 (face font-lock-builtin-face fontified t) 616 626 (fontified t) 626 631 (face font-lock-builtin-face fontified t) 631 635 (fontified t) 635 638 (fontified t) 638 644 (fontified t) 644 651 (face font-lock-builtin-face fontified t) 651 654 (fontified t) 654 664 (face font-lock-builtin-face fontified t) 664 666 (fontified t) 666 672 (face font-lock-builtin-face fontified t) 672 680 (fontified t) 680 684 (face font-lock-keyword-face fontified t) 684 722 (fontified t) 722 732 (face font-lock-builtin-face fontified t) 732 753 (fontified t) 753 758 (face font-lock-keyword-face fontified t) 758 759 (fontified t) 759 776 (face font-lock-function-name-face fontified t) 776 785 (fontified t) 785 879 (face font-lock-doc-face fontified t) 879 883 (fontified t) 883 887 (face font-lock-keyword-face fontified t) 887 931 (fontified t) 931 934 (face font-lock-keyword-face fontified t) 934 965 (fontified t) 965 1003 (face font-lock-string-face fontified t) 1003 1035 (fontified t) 1035 1040 (face font-lock-builtin-face fontified t) 1040 1051 (fontified t)) . 13093) (undo-tree-id0 . -1051) (undo-tree-id1 . -17) (undo-tree-id2 . -17) (undo-tree-id3 . -17) (undo-tree-id4 . -17) (undo-tree-id5 . -17) (undo-tree-id6 . -17) (undo-tree-id7 . -17) (undo-tree-id8 . -17) (undo-tree-id9 . -17) (undo-tree-id10 . -17) (undo-tree-id11 . -17) (undo-tree-id12 . -17) (undo-tree-id13 . -750) (undo-tree-id14 . -750) (undo-tree-id15 . -750) (undo-tree-id16 . -750) (undo-tree-id17 . -750) (undo-tree-id18 . -750) (undo-tree-id19 . -750) (undo-tree-id20 . -750) (undo-tree-id21 . -750) (undo-tree-id22 . -750) (undo-tree-id23 . -750) (undo-tree-id24 . -288) (undo-tree-id25 . -288) (undo-tree-id26 . -288) (undo-tree-id27 . -288) (undo-tree-id28 . -288) (undo-tree-id29 . -288) (undo-tree-id30 . -1051) (undo-tree-id31 . -1051) (undo-tree-id32 . -1051) (undo-tree-id33 . -1051) (undo-tree-id34 . -750) (undo-tree-id35 . -1051) (t 26812 50233 0 0)) nil (26819 3494 267775 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13093) (#("
" 0 1 (fontified t)) . 13093)) nil (26819 3494 267730 0) 0 nil])
([nil nil ((7111 . 7112) (t 26819 3494 0 0)) nil (26819 12995 798942 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -7111) (undo-tree-id48 . -1) 7112) nil (26819 12995 798941 0) 0 nil])
([nil nil ((6886 . 6889)) nil (26819 12995 798940 0) 0 nil])
([nil nil ((6889 . 6896)) nil (26819 12995 798940 0) 0 nil])
([nil nil ((6896 . 6897)) nil (26819 12995 798939 0) 0 nil])
([nil nil ((6897 . 6898)) nil (26819 12995 798939 0) 0 nil])
([nil nil ((6898 . 6899)) nil (26819 12995 798939 0) 0 nil])
([nil nil ((6899 . 6909)) nil (26819 12995 798938 0) 0 nil])
([nil nil ((#("R" 0 1 (face font-lock-string-face fontified t)) . -6907) (undo-tree-id46 . -1) (#("S" 0 1 (face font-lock-string-face fontified t)) . -6908) (undo-tree-id47 . -1) 6909) nil (26819 12995 798938 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-string-face fontified t)) . -6905) (undo-tree-id44 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -6906) (undo-tree-id45 . -1) 6907) nil (26819 12995 798936 0) 0 nil])
([nil nil ((6905 . 6910)) nil (26819 12995 798934 0) 0 nil])
([nil nil ((6910 . 6911)) nil (26819 12995 798934 0) 0 nil])
([nil nil ((6911 . 6914)) nil (26819 12995 798933 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-string-face fontified t)) . -6913) (undo-tree-id43 . -1) 6914) nil (26819 12995 798933 0) 0 nil])
([nil nil ((6913 . 6915)) nil (26819 12995 798932 0) 0 nil])
([nil nil ((6915 . 6916)) nil (26819 12995 798931 0) 0 nil])
([nil nil ((6916 . 6917)) nil (26819 12995 798931 0) 0 nil])
([nil nil ((6917 . 6924)) nil (26819 12995 798930 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -6923) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) 6924) nil (26819 12995 798929 0) 0 nil])
([nil nil ((6916 . 6917)) nil (26819 12995 798926 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -6915) (undo-tree-id36 . -1) (#("b" 0 1 (face font-lock-string-face fontified t)) . -6916) (undo-tree-id37 . -1) 6917) nil (26819 12995 798925 0) 0 nil])
([nil nil ((6915 . 6916)) nil (26819 12995 798915 0) 0 nil])
([nil nil ((6916 . 6917)) nil (26819 12995 798915 0) 0 nil])
([nil nil ((6924 . 6925)) nil (26819 12995 798914 0) 0 nil])
([nil nil ((7343 . 7348)) nil (26819 12995 798914 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7383 . 7384) (nil fontified nil 7376 . 7384) (nil fontified nil 7375 . 7376) (nil fontified nil 7358 . 7375) (nil fontified nil 7348 . 7358) (7348 . 7384)) nil (26819 12995 798913 0) 0 nil])
([nil nil ((7368 . 7369)) nil (26819 12995 798911 0) 0 nil])
([nil nil ((7384 . 7385)) nil (26819 12995 798907 0) 0 nil])
([nil nil ((7326 . 7331) (t 26819 12995 0 0)) nil (26819 14647 452910 0) 0 nil])
([nil nil ((7331 . 7332)) nil (26819 14647 452910 0) 0 nil])
([nil nil ((7320 . 7330) (#(" " 0 1 (fontified nil)) . 7319) (undo-tree-id51 . -1) (7320 . 7321)) nil (26819 14647 452909 0) 0 nil])
([nil nil ((7359 . 7360)) nil (26819 14647 452907 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13307 . 13308) (nil fontified nil 11995 . 13308) (11995 . 13308)) nil (26819 14647 452906 0) 0 nil])
([nil nil ((#("
(defmethod repo-index :around (entity ctx &rest args)
  (destructuring-bind (&key filters &allow-other-keys) args
    (let* ((tid (getf ctx :tenant-id))
           (filters* (if tid (list 'and filters (list '= :tenant_id tid)) filters))
           (args* (alexandria:plist-alist
                   (lumen.utils:copy-plist args))))
      ;; replace :filters
      (setf (cdr (assoc :filters args*)) filters*)
      (let ((op :index))
        (repo-authorize op entity ctx)
        (apply #'call-next-method entity ctx (alexandria:alist-plist args*))))))" 0 1 (fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 22 (face font-lock-function-name-face fontified t) 22 23 (fontified t) 23 30 (face font-lock-builtin-face fontified t) 30 43 (fontified t) 43 48 (face font-lock-type-face fontified t) 48 58 (fontified t) 58 76 (face font-lock-keyword-face fontified t) 76 78 (fontified t) 78 82 (face font-lock-type-face fontified t) 82 91 (fontified t) 91 108 (face font-lock-type-face fontified t) 108 120 (fontified t) 120 124 (face font-lock-keyword-face fontified t) 124 141 (fontified t) 141 151 (face font-lock-builtin-face fontified t) 151 176 (fontified t) 176 178 (face font-lock-keyword-face fontified t) 178 211 (fontified t) 211 221 (face font-lock-builtin-face fontified t) 221 319 (fontified t) 319 332 (fontified t) 332 338 (fontified t) 338 341 (face font-lock-comment-delimiter-face fontified t) 341 358 (face font-lock-comment-face fontified t) 358 382 (fontified t) 382 390 (face font-lock-builtin-face fontified t) 390 416 (fontified t) 416 419 (face font-lock-keyword-face fontified t) 419 425 (fontified t) 425 431 (face font-lock-builtin-face fontified t) 431 553 (fontified t)) . -13308) (undo-tree-id50 . -553) 13861) nil (26819 14647 452971 0) 0 nil])
([nil nil ((#("

;;; Méthode corrigée ------------------------------------------------------" 0 2 (fontified t) 2 6 (face font-lock-comment-delimiter-face fontified t) 6 77 (face font-lock-comment-face fontified t)) . 12506) (undo-tree-id92 . -77)) nil (26819 15069 792224 0) 0 nil] [nil nil ((#("

;;; Méthode corrigée ------------------------------------------------------" 0 2 (fontified t) 2 6 (face font-lock-comment-delimiter-face fontified t) 6 77 (face font-lock-comment-face fontified t)) . -12506) (undo-tree-id49 . -77) 12583) ((12506 . 12583)) (26819 14647 452900 0) 0 nil])
([nil nil ((6771 . 6772)) nil (26819 15069 792223 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 8555 . 8556) (nil fontified nil 6772 . 8556) (6772 . 8556)) nil (26819 15069 792222 0) 0 nil])
([nil nil ((7433 . 7436)) nil (26819 15069 792222 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7471 . 7472) (nil fontified nil 7464 . 7472) (nil fontified nil 7463 . 7464) (nil fontified nil 7446 . 7463) (nil fontified nil 7436 . 7446) (7436 . 7472)) nil (26819 15069 792221 0) 0 nil])
([nil nil ((7987 . 7992)) nil (26819 15069 792220 0) 0 nil])
([nil nil ((nil fontified nil 8029 . 8030) (nil fontified nil 8021 . 8029) (nil fontified nil 8020 . 8021) (nil fontified nil 8002 . 8020) (nil fontified nil 7992 . 8002) (7992 . 8030)) nil (26819 15069 792219 0) 0 nil])
([nil nil ((#("
(defmethod repo-index ((entity symbol) ctx &key filters order select page page-size limit offset after before key)
  (format t \"~&FILTERS: ~A~%\" filters)
  (let* ((md (entity-metadata entity))
         (table (getf md :table))
         (allowed (mapcar (lambda (f) (getf f :col)) (entity-fields entity)))
         (filters* (append filters
                           (let ((tid (getf ctx :tenant-id))
                                 (tcol (or (getf md :tenant-id-col) :tenant_id)))
                             (when (and tid (find tcol allowed))
			       (list (list '= tcol tid)))))))
    (format t \"~&FILTERS*: ~A~%\" filters*)
    (lumen.data.db:ensure-connection
    (cond
      ((or after before)
       ;; key = liste de colonnes correspondant à ORDER
       (select-page-keyset* table
         :filters filters* :order order :key key
         :after after :limit (or limit 20) :order-whitelist allowed))
      (t
       (select* table
         :filters filters* :order order :select (or select :*)
         :limit (or (and page-size (* 1 page-size)) limit 20)
         :offset (or offset (and page page-size (* (max 0 (1- page)) page-size)))
         :order-whitelist allowed))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 22 (face font-lock-function-name-face fontified t) 22 44 (fontified t) 44 48 (face font-lock-type-face fontified t) 48 116 (fontified t) 116 128 (fontified t) 128 145 (face font-lock-string-face fontified t) 145 146 (fontified t) 146 154 (fontified t) 154 155 (fontified t) 155 158 (fontified t) 158 162 (face font-lock-keyword-face fontified t) 162 219 (fontified t) 219 225 (face font-lock-builtin-face fontified t) 225 255 (fontified t) 255 261 (face font-lock-keyword-face fontified t) 261 274 (fontified t) 274 278 (face font-lock-builtin-face fontified t) 278 341 (fontified t) 341 369 (fontified t) 369 372 (face font-lock-keyword-face fontified t) 372 378 (fontified t) 378 389 (fontified t) 389 399 (face font-lock-builtin-face fontified t) 399 402 (fontified t) 402 454 (fontified t) 454 468 (face font-lock-builtin-face fontified t) 468 470 (fontified t) 470 480 (face font-lock-builtin-face fontified t) 480 484 (fontified t) 484 514 (fontified t) 514 518 (face font-lock-keyword-face fontified t) 518 549 (fontified t) 549 590 (fontified t) 590 594 (fontified t) 594 604 (fontified t) 604 622 (face font-lock-string-face fontified t) 622 623 (fontified t) 623 631 (fontified t) 631 632 (fontified t rear-nonsticky t) 632 633 (fontified t) 633 675 (fontified t) 675 679 (face font-lock-keyword-face fontified t) 679 712 (fontified t) 712 715 (face font-lock-comment-delimiter-face fontified t) 715 761 (face font-lock-comment-face fontified t) 761 804 (fontified t) 804 812 (face font-lock-builtin-face fontified t) 812 822 (fontified t) 822 828 (face font-lock-builtin-face fontified t) 828 835 (fontified t) 835 839 (face font-lock-builtin-face fontified t) 839 853 (fontified t) 853 859 (face font-lock-builtin-face fontified t) 859 866 (fontified t) 866 872 (face font-lock-builtin-face fontified t) 872 887 (fontified t) 887 893 (face font-lock-builtin-face fontified t) 893 903 (face font-lock-builtin-face fontified t) 903 914 (fontified t) 914 954 (fontified t) 954 962 (face font-lock-builtin-face fontified t) 962 964 (fontified t) 964 972 (fontified t) 972 978 (face font-lock-builtin-face fontified t) 978 985 (fontified t) 985 992 (face font-lock-builtin-face fontified t) 992 1004 (fontified t) 1004 1006 (face font-lock-builtin-face fontified t) 1006 1008 (fontified t) 1008 1017 (fontified t) 1017 1023 (face font-lock-builtin-face fontified t) 1023 1079 (fontified t) 1079 1086 (face font-lock-builtin-face fontified t) 1086 1161 (fontified t) 1161 1177 (face font-lock-builtin-face fontified t) 1177 1192 (fontified t)) . -8638) (undo-tree-id52 . -594) (undo-tree-id53 . -12) (undo-tree-id54 . -22) (undo-tree-id55 . -1192) (undo-tree-id56 . -1) (undo-tree-id57 . -118) (undo-tree-id58 . -594) (undo-tree-id59 . -594) (undo-tree-id60 . -594) (undo-tree-id61 . -594) (undo-tree-id62 . -632) (undo-tree-id63 . -632) (undo-tree-id64 . -632) (undo-tree-id65 . -632) (undo-tree-id66 . -632) (undo-tree-id67 . -632) (undo-tree-id68 . -632) (undo-tree-id69 . -632) (undo-tree-id70 . -632) (undo-tree-id71 . -632) (undo-tree-id72 . -594) (undo-tree-id73 . -46) (undo-tree-id74 . -46) (undo-tree-id75 . -46) (undo-tree-id76 . -46) (undo-tree-id77 . -46) (undo-tree-id78 . -46) (undo-tree-id79 . -46) (undo-tree-id80 . -46) (undo-tree-id81 . -46) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -914) (undo-tree-id86 . -590) (undo-tree-id87 . -795) (undo-tree-id88 . -795) (undo-tree-id89 . -844) (undo-tree-id90 . -844) (undo-tree-id91 . -1192) 9830) nil (26819 15069 792217 0) 0 nil])
([nil nil ((7416 . 7420) (#(" " 0 1 (fontified nil)) . 7416) (7415 . 7416)) nil (26819 15069 792181 0) 0 nil])
([nil nil ((8536 . 8542) (#("           " 0 11 (fontified t)) . 8536) (8456 . 8462) (#("           " 0 11 (fontified t)) . 8456) (8395 . 8401) (#("           " 0 11 (fontified t)) . 8395) (8365 . 8371) (#("           " 0 11 (fontified t)) . 8365) (8344 . 8350) (#("           " 0 11 (fontified t)) . 8344) (8320 . 8326) (#("           " 0 11 (fontified t)) . 8320) (8303 . 8305) (8289 . 8291) (8250 . 8254) (#("           " 0 11 (fontified t)) . 8250) (8223 . 8227) (#("           " 0 11 (fontified t)) . 8223) (8204 . 8208) (#("           " 0 11 (fontified t)) . 8204) (8187 . 8191) (#("           " 0 11 (fontified t)) . 8187) (8168 . 8172) (#("           " 0 11 (fontified t)) . 8168) (8146 . 8150) (#("           " 0 11 (fontified t)) . 8146) (8117 . 8119) (8087 . 8089) (8072 . 8073) (#("      " 0 6 (fontified t)) . 8072) 7296) nil (26819 15069 792175 0) 0 nil])
([nil nil ((#("
(defun %ensure-filter-list (f)
  \"Normalise :filters en liste de clauses (AND implicite).\"
  (cond
    ((null f) '())
    ((and (listp f) (member (first f) '(and :AND))) (rest f))
    ((and (listp f) (every #'listp f)) f)
    (t (list f))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 27 (face font-lock-function-name-face fontified t) 27 34 (fontified t) 34 91 (face font-lock-doc-face fontified t) 91 95 (fontified t) 95 99 (face font-lock-keyword-face fontified t) 99 163 (fontified t) 163 167 (face font-lock-builtin-face fontified t) 167 241 (fontified t)) . 6771) (undo-tree-id93 . -241) (undo-tree-id94 . -241) (undo-tree-id95 . -1) (undo-tree-id96 . -241) (undo-tree-id97 . -241) (undo-tree-id98 . -241) (undo-tree-id99 . -15) (undo-tree-id100 . -15) (undo-tree-id101 . -15) (undo-tree-id102 . -15) (undo-tree-id103 . -15) (undo-tree-id104 . -8) (undo-tree-id105 . -27) (undo-tree-id106 . -27) (undo-tree-id107 . -8) (undo-tree-id108 . -27) (undo-tree-id109 . -27) (undo-tree-id110 . -27) (undo-tree-id111 . -27) (undo-tree-id112 . -27) (undo-tree-id113 . -27) (undo-tree-id114 . -27) (undo-tree-id115 . -27) (undo-tree-id116 . -27) (undo-tree-id117 . -27) (undo-tree-id118 . -27) (undo-tree-id119 . -27) (undo-tree-id120 . -27) (undo-tree-id121 . -27) (undo-tree-id122 . -27) (undo-tree-id123 . -27) (undo-tree-id124 . -27) (undo-tree-id125 . -27) (undo-tree-id126 . -27) (undo-tree-id127 . -27) (undo-tree-id128 . -27) (undo-tree-id129 . -27) (undo-tree-id130 . -27) (undo-tree-id131 . -27) (undo-tree-id132 . -27) (undo-tree-id133 . -241) (undo-tree-id134 . -241) (undo-tree-id135 . -241) (undo-tree-id136 . -8) (undo-tree-id137 . -241) (t 26819 15069 0 0)) nil (26819 15116 597576 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 6771)) nil (26819 15116 597538 0) 0 nil])
([nil nil ((7052 . 7054) (t 26819 15116 0 0)) nil (26819 16659 226409 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8441 . 8442) (nil fontified nil 7054 . 8442) (7054 . 8442)) nil (26819 16659 226408 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -8441) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) 8442) nil (26819 16659 226407 0) 0 nil])
([nil nil ((#("(allowed (mapcar (lambda (f) (getf f :col)) (entity-fields entity)))" 0 18 (fontified t) 18 24 (face font-lock-keyword-face fontified t) 24 37 (fontified t) 37 41 (face font-lock-builtin-face fontified t) 41 68 (fontified t)) . -8713) (undo-tree-id138 . -68) (undo-tree-id139 . -68) (undo-tree-id140 . -68) (undo-tree-id141 . -68) (undo-tree-id142 . -68) (undo-tree-id143 . -68) 8781) nil (26819 16659 226404 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8784 . 8785) (nil fontified nil 8713 . 8785) (8713 . 8785)) nil (26819 16659 226386 0) 0 nil])
([nil nil ((6514 . 6515) (t 26819 16659 0 0)) nil (26821 14732 141104 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7540 . 7541) (nil fontified nil 6515 . 7541) (6515 . 7541)) nil (26821 14732 141104 0) 0 nil])
([nil nil ((#("(defmethod repo-after (op (entity symbol) ctx result &key id payload)
  (declare (ignore id payload))
  ;; Audit optionnel (si l’app/ENV a installé une table audit_log et veut logguer)
  (print (list (getf ctx :actor-id)
       (getf ctx :tenant-id)
       (string-downcase (symbol-name op))
       (string-downcase (symbol-name entity))
       (cl-json:encode-json-to-string result)))
  (when (getf ctx :audit?)
    (ignore-errors
     (lumen.data.db:ensure-connection
      (lumen.data.db:exec
       \"insert into audit_log(actor_id, tenant_id, action, resource, payload)
        values($1,$2,$3,$4,$5)\"
       (getf ctx :actor-id)
       (getf ctx :tenant-id)
       (string-downcase (symbol-name op))
       (string-downcase (symbol-name entity))
       (cl-json:encode-json-to-string result)))))
  result)" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 21 (face font-lock-function-name-face fontified t) 21 53 (fontified t) 53 57 (face font-lock-type-face fontified t) 57 73 (fontified t) 73 80 (face font-lock-keyword-face fontified t) 80 104 (fontified t) 104 107 (face font-lock-comment-delimiter-face fontified t) 107 185 (face font-lock-comment-face fontified t) 185 210 (fontified t) 210 219 (face font-lock-builtin-face fontified t) 219 238 (fontified t) 238 248 (face font-lock-builtin-face fontified t) 248 389 (fontified t) 389 393 (face font-lock-keyword-face fontified t) 393 404 (fontified t) 404 411 (face font-lock-builtin-face fontified t) 411 414 (fontified t) 414 418 (fontified t) 418 431 (face font-lock-keyword-face fontified t) 431 432 (fontified t) 432 503 (fontified t) 503 605 (face font-lock-string-face fontified t) 605 623 (fontified t) 623 632 (face font-lock-builtin-face fontified t) 632 651 (fontified t) 651 661 (face font-lock-builtin-face fontified t) 661 801 (fontified t) 801 810 (fontified t)) . 5704) (undo-tree-id149 . -810) (undo-tree-id150 . -386) (undo-tree-id151 . -810) (undo-tree-id152 . -810) (undo-tree-id153 . -810) (undo-tree-id154 . -810) (undo-tree-id155 . -810) (undo-tree-id156 . -810)) nil (26821 14732 141102 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 5704) (undo-tree-id147 . -1) (undo-tree-id148 . -1)) nil (26821 14732 141089 0) 0 nil])
([nil nil ((#(":ctx-from-req" 0 13 (face font-lock-builtin-face fontified t)) . 1061) (undo-tree-id158 . -13) 1074 (t 26821 14732 0 0)) nil (26821 16741 939468 0) 0 nil])
([nil nil ((#("

;;; ---------------------------------------------------------------------------
;;; Contexte standard (req -> ctx)
;;; ---------------------------------------------------------------------------
(defun ctx-from-req (req)
  \"Projette le contexte HTTP vers un ctx alist standard utilisé par repo-*.\"
  (let* ((jwt (lumen.core.http:current-jwt req)))
    (list :req       req
          :tenant-id (lumen.core.http:ctx-get req :tenant-id)
          :actor-id  (lumen.core.http:current-user-id req)
          :scopes    (or (lumen.utils:alist-get jwt :scopes) '())
          :audit?    t)))" 0 2 (fontified t) 2 6 (face font-lock-comment-delimiter-face fontified t) 6 82 (face font-lock-comment-face fontified t) 82 86 (face font-lock-comment-delimiter-face fontified t) 86 117 (face font-lock-comment-face fontified t) 117 121 (face font-lock-comment-delimiter-face fontified t) 121 197 (face font-lock-comment-face fontified t) 197 198 (fontified t) 198 203 (face font-lock-keyword-face fontified t) 203 204 (fontified t) 204 216 (face font-lock-function-name-face fontified t) 216 225 (fontified t) 225 299 (face font-lock-doc-face fontified t) 299 303 (fontified t) 303 307 (face font-lock-keyword-face fontified t) 307 360 (fontified t) 360 364 (face font-lock-builtin-face fontified t) 364 385 (fontified t) 385 389 (face font-lock-builtin-face fontified t) 389 395 (face font-lock-builtin-face fontified t) 395 425 (fontified t) 425 435 (face font-lock-builtin-face fontified t) 435 437 (fontified t) 437 447 (fontified t) 447 456 (face font-lock-builtin-face fontified t) 456 506 (fontified t) 506 513 (face font-lock-builtin-face fontified t) 513 548 (fontified t) 548 555 (face font-lock-builtin-face fontified t) 555 572 (fontified t) 572 579 (face font-lock-builtin-face fontified t) 579 587 (fontified t)) . 1099) (undo-tree-id157 . -587)) nil (26821 16741 939463 0) 0 nil])
([nil nil ((177 . 181)) nil (26821 16741 939450 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 193 . 194) (nil fontified nil 181 . 194) (181 . 194)) nil (26821 16741 939444 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -15031) (undo-tree-id14 . -1) 15032 (t 26821 16741 0 0)) nil (26821 17811 621791 0) 0 nil])
([nil nil ((15031 . 15032)) nil (26821 17811 621789 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -15030) (undo-tree-id13 . -1) 15031) nil (26821 17811 621789 0) 0 nil])
([nil nil ((15030 . 15031)) nil (26821 17811 621787 0) 0 nil])
([nil nil ((15267 . 15269)) nil (26821 17811 621786 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15960 . 15961) (nil fontified nil 15269 . 15961) (15269 . 15961)) nil (26821 17811 621785 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face rear-nonsticky t fontified t)) . -15960) (undo-tree-id12 . -1) 15961) nil (26821 17811 621784 0) 0 nil])
([nil nil ((#("prudence" 0 8 (face font-lock-comment-face fontified t)) . 15786) (undo-tree-id11 . -8) 15794) nil (26821 17811 621783 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15702 . 15703) (nil fontified nil 15695 . 15703) (15695 . 15703)) nil (26821 17811 621781 0) 0 nil])
([nil nil ((#("renvoie" 0 7 (face font-lock-comment-face fontified t)) . 15703)) nil (26821 17811 621779 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15793 . 15794) (nil fontified nil 15787 . 15794) (15787 . 15794)) nil (26821 17811 621778 0) 0 nil])
([nil nil ((#("row" 0 3 (fontified t)) . 15634) (undo-tree-id10 . -3) 15637) nil (26821 17811 621777 0) 0 nil])
([nil nil ((15634 . 15637)) nil (26821 17811 621775 0) 0 nil])
([nil nil ((#("nil" 0 3 (fontified t)) . -15724) (undo-tree-id9 . -3) 15727) nil (26821 17811 621773 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15726 . 15727) (nil fontified nil 15724 . 15727) (15724 . 15727)) nil (26821 17811 621770 0) 0 nil])
([nil nil ((#("
(defmethod repo-show :around (entity ctx id)
  (let ((op :show))
    (repo-authorize op entity ctx :id id)
    (let* ((row (call-next-method))      ;; la méthode primaire fait le SELECT
           (tid (getf ctx :tenant-id)))
      (if (and row tid
               (string/= (string-downcase (or (cdr (assoc :tenant_id row)) \"\"))
                         (string-downcase tid)))
          ;; masquer les fuites cross-tenant
          (respond-404)                  ;; ou NIL selon ton contrat
          row))))
" 0 1 (fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 21 (face font-lock-function-name-face fontified t) 21 22 (fontified t) 22 29 (face font-lock-builtin-face fontified t) 29 49 (fontified t) 49 52 (face font-lock-keyword-face fontified t) 52 58 (fontified t) 58 63 (face font-lock-builtin-face fontified t) 63 100 (fontified t) 100 103 (face font-lock-builtin-face fontified t) 103 113 (fontified t) 113 117 (face font-lock-keyword-face fontified t) 117 149 (fontified t) 149 152 (face font-lock-comment-delimiter-face fontified t) 152 187 (face font-lock-comment-face fontified t) 187 213 (fontified t) 213 223 (face font-lock-builtin-face fontified t) 223 234 (fontified t) 234 236 (face font-lock-keyword-face fontified t) 236 250 (fontified t) 250 308 (fontified t) 308 318 (face font-lock-builtin-face fontified t) 318 325 (fontified t) 325 327 (face font-lock-string-face fontified t) 327 330 (fontified t) 330 389 (fontified t) 389 392 (face font-lock-comment-delimiter-face fontified t) 392 424 (face font-lock-comment-face fontified t) 424 465 (fontified t) 465 468 (face font-lock-comment-delimiter-face fontified t) 468 493 (face font-lock-comment-face fontified t) 493 511 (fontified t)) . 14757) (undo-tree-id0 . -511) (undo-tree-id1 . -378) (undo-tree-id2 . -249) (undo-tree-id3 . -328) (undo-tree-id4 . -378) (undo-tree-id5 . -446) (undo-tree-id6 . -273) (undo-tree-id7 . -1) (undo-tree-id8 . -511)) nil (26821 17811 621765 0) 0 nil])
([nil nil ((10339 . 10341) (t 26821 17811 0 0)) nil (26822 36089 914634 0) 0 nil])
([nil nil ((8220 . 8222)) nil (26822 36089 914633 0) 0 nil])
([nil nil ((8782 . 8784)) nil (26822 36089 914629 0) 0 nil])
([nil nil ((7395 . 7397) (t 26822 36089 0 0)) nil (26832 36358 865992 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8065 . 8066) (nil fontified nil 7397 . 8066) (7397 . 8066)) nil (26832 36358 865991 0) 0 nil])
([nil nil ((8067 . 8069) (#("  " 0 2 (fontified nil)) . 8066) (8066 . 8068) (8066 . 8067)) nil (26832 36358 865990 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9152 . 9153) (nil fontified nil 8069 . 9153) (8069 . 9153)) nil (26832 36358 865989 0) 0 nil])
([nil nil ((#("

(defun entity-allowed-cols (entity &key include-pk? include-tenant? include-lock?)
  \"Union des colonnes :fields + timestamps + (optionnel) pk/tenant/lock_version.\"
  (let* ((md        (entity-metadata entity))
         (pk        (and include-pk?     (%kw-col (or (getf md :primary-key) :id))))
         (tenantcol (and include-tenant? (%kw-col (or (getf md :tenant-id-col) :tenant_id))))
         (lockcol   (and include-lock?   (%kw-col (getf md :lock-version)))))
    (remove-duplicates
     (remove nil
             (append (entity-field-cols entity)
                     (entity-timestamp-cols entity)
                     (list pk tenantcol lockcol)))
     :test #'eq)))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 28 (face font-lock-function-name-face fontified t) 28 37 (fontified t) 37 41 (face font-lock-type-face fontified t) 41 87 (fontified t) 87 166 (face font-lock-doc-face fontified t) 166 170 (fontified t) 170 174 (face font-lock-keyword-face fontified t) 174 276 (fontified t) 276 288 (face font-lock-builtin-face fontified t) 288 290 (fontified t) 290 293 (face font-lock-builtin-face fontified t) 293 361 (fontified t) 361 375 (face font-lock-builtin-face fontified t) 375 377 (fontified t) 377 387 (face font-lock-builtin-face fontified t) 387 451 (fontified t) 451 464 (face font-lock-builtin-face fontified t) 464 666 (fontified t) 666 671 (face font-lock-builtin-face fontified t) 671 680 (fontified t)) . -9153) (undo-tree-id33 . -680) 9833) nil (26832 36358 865988 0) 0 nil])
([nil nil ((8001 . 8002)) nil (26832 36358 865987 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -8068) (undo-tree-id31 . -1) (undo-tree-id32 . -1) 8069) nil (26832 36358 865986 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 8068) (undo-tree-id30 . -1)) nil (26832 36358 865984 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -12895) (undo-tree-id28 . -1) (undo-tree-id29 . -1) 12896) nil (26832 36358 865983 0) 0 nil])
([nil nil ((8066 . 8068)) nil (26832 36358 865981 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11075 . 11076) (nil fontified nil 8068 . 11076) (8068 . 11076)) nil (26832 36358 865980 0) 0 nil])
([nil nil ((11076 . 11077)) nil (26832 36358 865979 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -11076) (undo-tree-id27 . -1) 11077) nil (26832 36358 865978 0) 0 nil])
([nil nil ((#("(defmethod repo-index ((entity symbol) ctx
                       &key filters order select page page-size limit offset
			 after before key)
  ;;(format t \"~&FILTERS: ~A~%\" filters)
  (let* ((md      (entity-metadata entity))
         (table   (getf md :table))
         (allowed (entity-allowed-cols entity :include-pk? t :include-tenant? t))
         (tid     (getf ctx :tenant-id))
         (tcol    (or (getf md :tenant-id-col) :tenant_id))
         (filters* (let ((flt (%ensure-filter-list filters)))
                     (if (and tid (find tcol allowed) (not (%has-tenant-clause-p flt tcol tid)))
                         (append flt (list (list '= tcol tid)))
                         flt))))
    ;;(format t \"~&FILTERS*: ~A~%\" filters*)
    (lumen.data.db:ensure-connection
	(cond
          ((or after before)
           (select-page-keyset* table
				:filters filters*
				:order   order
				:key     key
				:after   after
				:limit   (or limit 20)
				:order-whitelist allowed))
          (t
           (select* table
		    :filters filters*
		    :order   order
		    :select  (or select :*)
		    :limit   (or (and page-size (* 1 page-size)) limit 20)
		    :offset  (or offset (and page page-size (* (max 0 (1- page)) page-size)))
		    :order-whitelist allowed))))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 21 (face font-lock-function-name-face fontified t) 21 66 (fontified t) 66 70 (face font-lock-type-face fontified t) 70 144 (fontified t) 144 146 (face font-lock-comment-delimiter-face fontified t) 146 183 (face font-lock-comment-face fontified t) 183 186 (fontified t) 186 190 (face font-lock-keyword-face fontified t) 190 254 (fontified t) 254 260 (face font-lock-builtin-face fontified t) 260 309 (fontified t) 309 321 (face font-lock-builtin-face fontified t) 321 324 (fontified t) 324 340 (face font-lock-builtin-face fontified t) 340 373 (fontified t) 373 383 (face font-lock-builtin-face fontified t) 383 412 (fontified t) 412 414 (fontified t) 414 417 (fontified t) 417 431 (face font-lock-builtin-face fontified t) 431 433 (fontified t) 433 443 (face font-lock-builtin-face fontified t) 443 446 (fontified t) 446 466 (fontified t) 466 469 (face font-lock-keyword-face fontified t) 469 498 (fontified t) 498 508 (fontified t) 508 530 (fontified t) 530 532 (face font-lock-keyword-face fontified t) 532 706 (fontified t) 706 708 (face font-lock-comment-delimiter-face fontified t) 708 747 (face font-lock-comment-face fontified t) 747 786 (fontified t) 786 790 (face font-lock-keyword-face fontified t) 790 820 (fontified t) 820 847 (fontified t) 847 858 (fontified t) 858 862 (fontified t) 862 870 (face font-lock-builtin-face fontified t) 870 884 (fontified t) 884 890 (face font-lock-builtin-face fontified t) 890 903 (fontified t) 903 907 (face font-lock-builtin-face fontified t) 907 920 (fontified t) 920 926 (face font-lock-builtin-face fontified t) 926 939 (fontified t) 939 945 (face font-lock-builtin-face fontified t) 945 966 (fontified t) 966 982 (face font-lock-builtin-face fontified t) 982 1038 (fontified t) 1038 1046 (face font-lock-builtin-face fontified t) 1046 1062 (fontified t) 1062 1068 (face font-lock-builtin-face fontified t) 1068 1083 (fontified t) 1083 1090 (face font-lock-builtin-face fontified t) 1090 1103 (fontified t) 1103 1105 (face font-lock-builtin-face fontified t) 1105 1113 (fontified t) 1113 1119 (face font-lock-builtin-face fontified t) 1119 1174 (fontified t) 1174 1181 (face font-lock-builtin-face fontified t) 1181 1254 (fontified t) 1254 1270 (face font-lock-builtin-face fontified t) 1270 1284 (fontified t)) . -12163) (undo-tree-id26 . -1284) 13447) nil (26832 36358 865977 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13410 . 13411) (nil fontified nil 12163 . 13411) (12163 . 13411)) nil (26832 36358 865976 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -13409) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (#("
" 0 1 (rear-nonsticky t fontified t)) . -13410) (undo-tree-id24 . -1) (undo-tree-id25 . -1) 13411) nil (26832 36358 865975 0) 0 nil])
([nil nil ((13462 . 13463)) nil (26832 36358 865970 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14005 . 14006) (nil fontified nil 13463 . 14006) (13463 . 14006)) nil (26832 36358 865969 0) 0 nil])
([nil nil ((#("
(defmethod repo-show ((entity symbol) ctx id)
  (let* ((md (entity-metadata entity))
         (table (getf md :table))
         (pk    (or (getf md :primary-key) :id))
         (filters (list '= pk id)))
    (let* ((tid (getf ctx :tenant-id))
           (tcol (or (getf md :tenant-id-col) :tenant_id)))
      (when tid (setf filters (list 'and filters (list '= tcol tid)))))
    (lumen.data.db:ensure-connection
	(let ((rows (select* table :filters filters :limit 1)))
	  (and rows (first rows))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 21 (face font-lock-function-name-face fontified t) 21 50 (fontified t) 50 54 (face font-lock-keyword-face fontified t) 54 111 (fontified t) 111 117 (face font-lock-builtin-face fontified t) 117 149 (fontified t) 149 161 (face font-lock-builtin-face fontified t) 161 162 (fontified t) 162 163 (fontified t) 163 166 (face font-lock-builtin-face fontified t) 166 169 (fontified t) 169 210 (fontified t) 210 214 (face font-lock-keyword-face fontified t) 214 231 (fontified t) 231 241 (face font-lock-builtin-face fontified t) 241 274 (fontified t) 274 288 (face font-lock-builtin-face fontified t) 288 290 (fontified t) 290 300 (face font-lock-builtin-face fontified t) 300 311 (fontified t) 311 315 (face font-lock-keyword-face fontified t) 315 415 (fontified t) 415 418 (face font-lock-keyword-face fontified t) 418 441 (fontified t) 441 449 (face font-lock-builtin-face fontified t) 449 458 (fontified t) 458 464 (face font-lock-builtin-face fontified t) 464 501 (fontified t)) . -14006) (undo-tree-id17 . -501) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -304) (undo-tree-id21 . -501) 14507) nil (26832 36358 865968 0) 0 nil])
([nil nil ((#("(defmethod repo-create ((entity symbol) ctx payload)
  (repo-persist :create entity ctx :payload payload))

(defmethod repo-persist ((op (eql :create)) (entity symbol) ctx &key id payload)
  (declare (ignore ctx id))
  (let* ((ent (row->entity entity payload)))
    (validate-entity! ent)
    (lumen.data.db:ensure-connection
	(multiple-value-bind (n ent2) (entity-insert! ent :returning t)
	  (declare (ignore n))
	  ;;(print (entity->row-alist ent2))
	  (entity->row-alist ent2)))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 22 (face font-lock-function-name-face fontified t) 22 69 (fontified t) 69 76 (face font-lock-builtin-face fontified t) 76 88 (fontified t) 88 96 (face font-lock-builtin-face fontified t) 96 97 (fontified t) 97 107 (fontified t) 107 108 (fontified t) 108 109 (fontified t) 109 118 (face font-lock-keyword-face fontified t) 118 119 (fontified t) 119 131 (face font-lock-function-name-face fontified t) 131 142 (fontified t) 142 149 (face font-lock-builtin-face fontified t) 149 159 (fontified t) 159 172 (fontified t) 172 176 (face font-lock-type-face fontified t) 176 189 (fontified t) 189 192 (fontified t) 192 199 (face font-lock-keyword-face fontified t) 199 220 (fontified t) 220 224 (face font-lock-keyword-face fontified t) 224 328 (fontified t) 328 347 (face font-lock-keyword-face fontified t) 347 377 (fontified t) 377 387 (face font-lock-builtin-face fontified t) 387 395 (fontified t) 395 402 (face font-lock-keyword-face fontified t) 402 418 (fontified t) 418 420 (face font-lock-comment-delimiter-face fontified t) 420 453 (face font-lock-comment-face fontified t) 453 484 (fontified t)) . -14017) (undo-tree-id13 . -484) (undo-tree-id14 . -453) (undo-tree-id15 . -484) (undo-tree-id16 . -484) 14501) nil (26832 36358 865964 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14560 . 14561) (nil fontified nil 14017 . 14561) (14017 . 14561)) nil (26832 36358 865960 0) 0 nil])
([nil nil ((#("
(defmethod repo-patch ((entity symbol) ctx id payload)
  (repo-persist :patch entity ctx :id id :payload payload))

(defmethod repo-persist ((op (eql :patch)) (entity symbol) ctx &key id payload)
  (declare (ignore ctx))
  (let* ((cur (repo-show entity (list) id)))
    (unless cur (error \"not_found\"))
    (let* ((ent (row->entity entity cur)))
      ;;#|
      (dolist (kv payload)
        (let* ((col (car kv)) (val (cdr kv))
               (slot (entity-slot-symbol entity col)))
      (setf (slot-value ent slot) val)))
      ;;|#
      (validate-entity! ent)
      (lumen.data.db:ensure-connection
	  (multiple-value-bind (n ent2) (entity-update! ent :patch t :returning t)
            (declare (ignore n))
            (entity->row-alist ent2))))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 22 (face font-lock-function-name-face fontified t) 22 72 (fontified t) 72 78 (face font-lock-builtin-face fontified t) 78 90 (fontified t) 90 93 (face font-lock-builtin-face fontified t) 93 97 (fontified t) 97 105 (face font-lock-builtin-face fontified t) 105 118 (fontified t) 118 127 (face font-lock-keyword-face fontified t) 127 128 (fontified t) 128 140 (face font-lock-function-name-face fontified t) 140 151 (fontified t) 151 157 (face font-lock-builtin-face fontified t) 157 180 (fontified t) 180 184 (face font-lock-type-face fontified t) 184 200 (fontified t) 200 207 (face font-lock-keyword-face fontified t) 207 225 (fontified t) 225 229 (face font-lock-keyword-face fontified t) 229 272 (fontified t) 272 278 (face font-lock-keyword-face fontified t) 278 284 (fontified t) 284 289 (face font-lock-warning-face fontified t) 289 290 (fontified t) 290 301 (face font-lock-string-face fontified t) 301 309 (fontified t) 309 313 (face font-lock-keyword-face fontified t) 313 353 (fontified t) 353 355 (face font-lock-comment-delimiter-face fontified t) 355 358 (face font-lock-comment-face fontified t) 358 365 (fontified t) 365 371 (face font-lock-keyword-face fontified t) 371 394 (fontified t) 394 398 (face font-lock-keyword-face fontified t) 398 424 (fontified t) 424 425 (fontified t) 425 430 (fontified t) 430 478 (fontified t) 478 485 (fontified t) 485 532 (fontified t) 532 534 (face font-lock-comment-delimiter-face fontified t) 534 537 (face font-lock-comment-face fontified t) 537 609 (fontified t) 609 628 (face font-lock-keyword-face fontified t) 628 646 (fontified t) 646 658 (fontified t) 658 664 (face font-lock-builtin-face fontified t) 664 667 (fontified t) 667 677 (face font-lock-builtin-face fontified t) 677 681 (fontified t) 681 694 (fontified t) 694 701 (face font-lock-keyword-face fontified t) 701 755 (fontified t)) . -14588) (undo-tree-id9 . -755) (undo-tree-id10 . -714) (undo-tree-id11 . -755) (undo-tree-id12 . -755) 15343) nil (26832 36358 865959 0) 0 nil])
([nil nil ((14588 . 14589)) nil (26832 36358 865956 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15461 . 15462) (nil fontified nil 14589 . 15462) (14589 . 15462)) nil (26832 36358 865955 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -15461) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 15462) nil (26832 36358 865954 0) 0 nil])
([nil nil ((15564 . 15566)) nil (26832 36358 865952 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15872 . 15873) (nil fontified nil 15566 . 15873) (15566 . 15873)) nil (26832 36358 865950 0) 0 nil])
([nil nil ((#("

(defmethod repo-persist ((op (eql :delete)) (entity symbol) ctx &key id payload)
  (declare (ignore ctx payload))
  (lumen.data.db:with-tx ()
    (let ((cur (repo-show entity (list) id)))
      (unless cur (error \"not_found\"))
      (entity-delete! (row->entity entity cur))
      `((:deleted . t) (:id . ,id)))))" 0 1 (fontified t) 1 3 (fontified t) 3 12 (face font-lock-keyword-face fontified t) 12 13 (fontified t) 13 25 (face font-lock-function-name-face fontified t) 25 36 (fontified t) 36 43 (face font-lock-builtin-face fontified t) 43 66 (fontified t) 66 70 (face font-lock-type-face fontified t) 70 86 (fontified t) 86 93 (face font-lock-keyword-face fontified t) 93 119 (fontified t) 119 120 (face font-lock-keyword-face fontified t) 120 121 (face font-lock-keyword-face fontified t) 121 140 (face font-lock-keyword-face fontified t) 140 144 (fontified t) 144 149 (fontified t) 149 152 (face font-lock-keyword-face fontified t) 152 197 (fontified t) 197 203 (face font-lock-keyword-face fontified t) 203 209 (fontified t) 209 214 (face font-lock-warning-face fontified t) 214 215 (fontified t) 215 226 (face font-lock-string-face fontified t) 226 286 (fontified t) 286 294 (face font-lock-builtin-face fontified t) 294 301 (fontified t) 301 304 (face font-lock-builtin-face fontified t) 304 315 (fontified t)) . -15873) (undo-tree-id0 . -315) (undo-tree-id1 . -225) (undo-tree-id2 . -312) (undo-tree-id3 . -312) (undo-tree-id4 . -312) (undo-tree-id5 . -312) (undo-tree-id6 . -277) 16188) nil (26832 36358 865947 0) 0 nil])
([nil nil ((#("
#|
(defmethod repo-show :around (entity ctx id)
  (let ((op :show)) (repo-authorize op entity ctx :id id) (call-next-method)))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 17 (face font-lock-comment-face fontified t) 17 49 (face font-lock-comment-face fontified t) 49 128 (face font-lock-comment-face fontified t) 128 130 (face font-lock-comment-delimiter-face fontified t) 130 131 (fontified t)) . 18895) (undo-tree-id39 . -131) (t 26832 36358 0 0)) nil (26833 1231 976461 0) 0 nil])
([nil nil ((18169 . 18171)) nil (26833 1231 976460 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18996 . 18997) (nil fontified nil 18171 . 18997) (18171 . 18997)) nil (26944 14430 767521 0) 0 nil])
([nil nil ((15268 . 15275)) nil (26944 15140 400808 0) 0 nil] [nil nil ((#("

(defmethod repo-index :around (entity ctx &rest args)
  (destructuring-bind (&key filters &allow-other-keys) args
    (let* ((tid        (getf ctx :tenant-id))
           (base       (%ensure-filter-list filters))
           (ten-clause (%tenant-filter-clause tid))
           ;; Ajoute le tenant_id à la fin (AND implicite)
           (filters*   (if ten-clause (append base (list ten-clause)) base))
           ;; Remplace :filters dans les args
           (args*      (alexandria:plist-alist (lumen.utils:copy-plist args))))
      (setf (cdr (assoc :filters args*)) filters*)
      (let ((op :index))
        (repo-authorize op entity ctx)
        (apply #'call-next-method entity ctx (alexandria:alist-plist args*))))))
" 0 1 (fontified t) 1 3 (fontified t) 3 12 (face font-lock-keyword-face fontified t) 12 13 (fontified t) 13 23 (face font-lock-function-name-face fontified t) 23 24 (fontified t) 24 31 (face font-lock-builtin-face fontified t) 31 44 (fontified t) 44 49 (face font-lock-type-face fontified t) 49 59 (fontified t) 59 77 (face font-lock-keyword-face fontified t) 77 79 (fontified t) 79 83 (face font-lock-type-face fontified t) 83 92 (fontified t) 92 109 (face font-lock-type-face fontified t) 109 121 (fontified t) 121 125 (face font-lock-keyword-face fontified t) 125 149 (fontified t) 149 159 (face font-lock-builtin-face fontified t) 159 279 (fontified t) 279 282 (face font-lock-comment-delimiter-face fontified t) 282 327 (face font-lock-comment-face fontified t) 327 351 (fontified t) 351 353 (face font-lock-keyword-face fontified t) 353 415 (fontified t) 415 418 (face font-lock-comment-delimiter-face fontified t) 418 450 (face font-lock-comment-face fontified t) 450 554 (fontified t) 554 562 (face font-lock-builtin-face fontified t) 562 588 (fontified t) 588 591 (face font-lock-keyword-face fontified t) 591 597 (fontified t) 597 603 (face font-lock-builtin-face fontified t) 603 726 (fontified t)) . -18997) 19723) ((18997 . 19723) (t 26833 1529 0 0)) (26833 1527 828596 0) 0 nil])
([nil nil ((15275 . 15281)) nil (26944 15140 400808 0) 0 nil])
([nil nil ((#("(defmethod repo-show :around (entity ctx id)
  (let ((op :show))
    (repo-authorize op entity ctx :id id)
    (let* ((row (call-next-method))      ; SELECT primaire
           (tid (getf ctx :tenant-id))
           (rid (and row (cdr (assoc :tenant_id row)))))
      (cond
        ((null row) nil)                                 ; rien trouvé
        ((null tid) nil)                                 ; pas de scope tenant → prudence
        ((null rid) row)                                 ; pas de colonne tenant → renvoie
        ((string-equal (string rid) (string tid)) row)   ; même tenant → OK
        (t nil)))))                                      ; cross-tenant → masque la fuite" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 20 (face font-lock-function-name-face fontified t) 20 21 (fontified t) 21 28 (face font-lock-builtin-face fontified t) 28 48 (fontified t) 48 51 (face font-lock-keyword-face fontified t) 51 57 (fontified t) 57 62 (face font-lock-builtin-face fontified t) 62 99 (fontified t) 99 102 (face font-lock-builtin-face fontified t) 102 112 (fontified t) 112 116 (face font-lock-keyword-face fontified t) 116 148 (fontified t) 148 166 (face font-lock-comment-face fontified t) 166 192 (fontified t) 192 202 (face font-lock-builtin-face fontified t) 202 242 (fontified t) 242 252 (face font-lock-builtin-face fontified t) 252 269 (fontified t) 269 273 (face font-lock-keyword-face fontified t) 273 331 (fontified t) 331 345 (face font-lock-comment-face fontified t) 345 402 (fontified t) 402 435 (face font-lock-comment-face fontified t) 435 492 (fontified t) 492 526 (face font-lock-comment-face fontified t) 526 583 (fontified t) 583 602 (face font-lock-comment-face fontified t) 602 659 (fontified t) 659 691 (face font-lock-comment-face fontified t)) . 18998) (undo-tree-id34 . -691) (undo-tree-id36 . -691)) ((18998 . 19689)) (26833 1527 4451 0) 0 nil])
([nil nil ((15281 . 15282)) nil (26944 15140 400808 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20015 . 20016) (nil fontified nil 18998 . 20016) (18998 . 20016)) ((#("(defmethod repo-show :around (entity ctx id)
  (let ((op :show))
    (repo-authorize op entity ctx :id id)
    (let* ((row (call-next-method))                ; SELECT primaire
           (md  (entity-metadata entity))
           (tcol (%entity-tenant-col entity md))   ; NIL si pas de colonne tenant
           (tid (getf ctx :tenant-id)))
      (cond
        ((null row) nil)                           ; rien trouvé
        ((null tcol) row)                          ; pas de colonne tenant → OK
        ((null tid) row)                           ; pas de tenant dans ctx → on ne bloque pas
        (t
         (let* ((rid (or (cdr (assoc tcol row))
                         (cdr (assoc (string-downcase (symbol-name tcol))
                                     row :test #'string=)))))
           (if (and rid
                    (string-equal (princ-to-string rid)
                                  (princ-to-string tid)))
               row
               nil))))))                           ; cross-tenant → masque" 0 1 (fontified nil) 1 10 (face font-lock-keyword-face fontified nil) 10 11 (fontified nil) 11 20 (face font-lock-function-name-face fontified nil) 20 21 (fontified nil) 21 28 (face font-lock-builtin-face fontified nil) 28 48 (fontified nil) 48 51 (face font-lock-keyword-face fontified nil) 51 57 (fontified nil) 57 62 (face font-lock-builtin-face fontified nil) 62 99 (fontified nil) 99 102 (face font-lock-builtin-face fontified nil) 102 112 (fontified nil) 112 116 (face font-lock-keyword-face fontified nil) 116 158 (fontified nil) 158 176 (face font-lock-comment-face fontified nil) 176 269 (fontified nil) 269 300 (face font-lock-comment-face fontified nil) 300 326 (fontified nil) 326 336 (face font-lock-builtin-face fontified nil) 336 347 (fontified nil) 347 351 (face font-lock-keyword-face fontified nil) 351 403 (fontified nil) 403 417 (face font-lock-comment-face fontified nil) 417 468 (fontified nil) 468 497 (face font-lock-comment-face fontified nil) 497 548 (fontified nil) 548 592 (face font-lock-comment-face fontified nil) 592 613 (fontified nil) 613 617 (face font-lock-keyword-face fontified nil) 617 766 (fontified nil) 766 771 (face font-lock-builtin-face fontified nil) 771 799 (fontified nil) 799 801 (face font-lock-keyword-face fontified nil) 801 944 (fontified nil) 944 995 (fontified nil) 995 1017 (face font-lock-comment-face fontified nil) 1017 1018 (face font-lock-comment-face rear-nonsticky nil fontified nil)) . 18998) (undo-tree-id41 . -968) (undo-tree-id42 . -968) (undo-tree-id43 . -968) (undo-tree-id44 . -591) (undo-tree-id45 . -591) (undo-tree-id46 . -591) (undo-tree-id47 . -591) (undo-tree-id48 . -591) (undo-tree-id49 . -591) (undo-tree-id50 . -944) (undo-tree-id51 . -968) (undo-tree-id52 . -944) (undo-tree-id53 . -968) (undo-tree-id54 . -968) (undo-tree-id55 . -968) (nil fontified t 19799 . 19942) (nil fontified t 19797 . 19799) (nil fontified t 19769 . 19797) (nil fontified t 19764 . 19769) (nil fontified t 19615 . 19764) (nil fontified t 19611 . 19615) (nil fontified t 19590 . 19611) (nil fontified t 19546 . 19590) (nil fontified t 19495 . 19546) (nil fontified t 19466 . 19495) (nil fontified t 19415 . 19466) (nil fontified t 19401 . 19415) (nil fontified t 19349 . 19401) (nil fontified t 19345 . 19349) (nil fontified t 19334 . 19345) (nil fontified t 19324 . 19334) (nil fontified t 19298 . 19324) (nil fontified t 19267 . 19298) (nil fontified t 19174 . 19267) (nil fontified t 19156 . 19174) (nil fontified t 19114 . 19156) (nil fontified t 19110 . 19114) (nil fontified t 19100 . 19110) (nil fontified t 19097 . 19100) (nil fontified t 19060 . 19097) (nil fontified t 19055 . 19060) (nil fontified t 19049 . 19055) (nil fontified t 19046 . 19049) (nil fontified t 19026 . 19046) (nil fontified t 19019 . 19026) (nil fontified t 19018 . 19019) (nil fontified t 19009 . 19018) (nil fontified t 19008 . 19009) (nil fontified t 18999 . 19008) (nil fontified t 18998 . 18999) (nil rear-nonsticky t 20015 . 20016)) (26833 1526 513399 0) 0 nil])
([nil nil ((15282 . 15285)) nil (26944 15140 400807 0) 0 nil])
([nil nil ((19966 . 19967) (t 26833 1231 0 0)) ((#(")" 0 1 (fontified t)) . 19966) (undo-tree-id40 . -1) (t 26833 1253 0 0)) (26833 1253 433610 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -15282) (undo-tree-id1 . -1) (#("X" 0 1 (face font-lock-string-face fontified t)) . -15283) (undo-tree-id2 . -1) (#("X" 0 1 (face font-lock-string-face fontified t)) . -15284) (undo-tree-id3 . -1) 15285) nil (26944 15140 400806 0) 0 nil])
nil
([nil nil ((15282 . 15289)) nil (26944 15140 400803 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -15288) (undo-tree-id0 . -1) 15289) nil (26944 15140 400803 0) 0 nil])
([nil nil ((15288 . 15289)) nil (26944 15140 400790 0) 0 nil])
([nil nil ((15289 . 15296)) nil (26944 15140 400789 0) 0 nil])
([nil nil ((15296 . 15302)) nil (26944 15140 400789 0) 0 nil])
([nil nil ((15302 . 15303)) nil (26944 15140 400789 0) 0 nil])
([nil nil ((15303 . 15307)) nil (26944 15140 400788 0) 0 nil])
([nil nil ((14991 . 14998)) nil (26944 15140 400787 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15008 . 15009) (nil fontified nil 14998 . 15009) (14998 . 15009)) nil (26944 15140 400783 0) 0 nil])
([nil nil ((17057 . 17059) (t 26944 15140 0 0)) nil (26944 15413 353138 0) 0 nil])
([nil nil ((17059 . 17065)) nil (26944 15413 353137 0) 0 nil])
([nil nil ((17065 . 17066)) nil (26944 15413 353137 0) 0 nil])
([nil nil ((17066 . 17071)) nil (26944 15413 353136 0) 0 nil])
([nil nil ((#("é" 0 1 (face font-lock-string-face fontified t)) . -17070) (undo-tree-id15 . -1) 17071) nil (26944 15413 353136 0) 0 nil])
([nil nil ((17070 . 17072)) nil (26944 15413 353135 0) 0 nil])
([nil nil ((17000 . 17002)) nil (26944 15413 353134 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17014 . 17015) (nil fontified nil 17014 . 17015) (nil fontified nil 17009 . 17014) (nil fontified nil 17002 . 17009) (17002 . 17015)) nil (26944 15413 353134 0) 0 nil])
([nil nil ((#("333" 0 3 (face font-lock-string-face fontified t)) . -17010) (undo-tree-id5 . -3) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -3) (undo-tree-id12 . -3) (undo-tree-id13 . -3) (undo-tree-id14 . -3) 17013) nil (26944 15413 353132 0) 0 nil])
([nil nil ((17010 . 17013)) nil (26944 15413 353125 0) 0 nil])
([nil nil ((16902 . 16909)) nil (26944 15413 353124 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16921 . 16922) (nil fontified nil 16921 . 16922) (nil fontified nil 16916 . 16921) (nil fontified nil 16909 . 16916) (16909 . 16922)) nil (26944 15413 353123 0) 0 nil])
([nil nil ((#("333" 0 3 (face font-lock-string-face fontified t)) . 16917) (undo-tree-id4 . -3)) nil (26944 15413 353122 0) 0 nil])
([nil nil ((16917 . 16919)) nil (26944 15413 353113 0) 0 nil])
([nil nil ((16919 . 16920)) nil (26944 15413 353109 0) 0 nil])
([nil nil ((15200 . 15204) (t 26944 15413 0 0)) nil (26944 15497 302272 0) 0 nil])
([nil nil ((15204 . 15210)) nil (26944 15497 302271 0) 0 nil])
([nil nil ((15210 . 15211)) nil (26944 15497 302270 0) 0 nil])
([nil nil ((15211 . 15216)) nil (26944 15497 302267 0) 0 nil])
([nil nil ((15009 . 15016) (t 26944 15497 0 0)) nil (26944 15526 265541 0) 0 nil])
([nil nil ((nil fontified nil 15026 . 15027) (nil fontified nil 15016 . 15026) (15016 . 15027)) nil (26944 15526 265540 0) 0 nil])
([nil nil ((#("ent" 0 3 (fontified t)) . -15023) (undo-tree-id16 . -3) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -3) (undo-tree-id23 . -3) (undo-tree-id24 . -3) (undo-tree-id25 . -3) (undo-tree-id26 . -3) (undo-tree-id27 . -3) (undo-tree-id28 . -3) (undo-tree-id29 . -3) 15026) nil (26944 15526 265538 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15030 . 15031) (nil fontified nil 15023 . 15031) (15023 . 15031)) nil (26944 15526 265516 0) 0 nil])
([nil nil ((15106 . 15108) (t 26944 15526 0 0)) nil (26944 15663 667754 0) 0 nil])
([nil nil ((15108 . 15114)) nil (26944 15663 667753 0) 0 nil])
([nil nil ((15114 . 15115)) nil (26944 15663 667752 0) 0 nil])
([nil nil ((15115 . 15121)) nil (26944 15663 667749 0) 0 nil])
([nil nil ((15152 . 15161) (t 26944 15663 0 0)) nil (26944 15767 187167 0) 0 nil])
([nil nil ((15161 . 15163)) nil (26944 15767 187166 0) 0 nil])
([nil nil ((15163 . 15164)) nil (26944 15767 187165 0) 0 nil])
([nil nil ((15164 . 15170)) nil (26944 15767 187165 0) 0 nil])
([nil nil ((15170 . 15171)) nil (26944 15767 187165 0) 0 nil])
([nil nil ((15171 . 15176)) nil (26944 15767 187164 0) 0 nil])
([nil nil ((15176 . 15185)) nil (26944 15767 187164 0) 0 nil])
([nil nil ((15185 . 15187)) nil (26944 15767 187163 0) 0 nil])
([nil nil ((15187 . 15188)) nil (26944 15767 187163 0) 0 nil])
([nil nil ((15188 . 15194)) nil (26944 15767 187162 0) 0 nil])
([nil nil ((15194 . 15195)) nil (26944 15767 187162 0) 0 nil])
([nil nil ((#("(x (print " 0 10 (fontified t)) . 15185) (undo-tree-id94 . -10) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -3) (undo-tree-id100 . -3) (undo-tree-id101 . -3) (undo-tree-id102 . -3) (undo-tree-id103 . -6) (undo-tree-id104 . -6) (undo-tree-id105 . -7) (undo-tree-id106 . -7) (undo-tree-id107 . -8) (undo-tree-id108 . -8) (undo-tree-id109 . -10) (undo-tree-id110 . -10) (undo-tree-id111 . -10) (undo-tree-id112 . -10) (undo-tree-id113 . -10) (undo-tree-id114 . -10) (undo-tree-id115 . -10) (undo-tree-id116 . -10) (undo-tree-id117 . -10) (undo-tree-id118 . -10) (undo-tree-id119 . -10) (undo-tree-id120 . -10) (undo-tree-id121 . -10) (undo-tree-id122 . -10) 15195) nil (26944 15767 187161 0) 0 nil])
([nil nil ((#("
	       " 0 1 (fontified t) 1 9 (fontified t)) . 15176) (undo-tree-id42 . -9) (undo-tree-id43 . 9) (undo-tree-id44 . -1) (undo-tree-id45 . -9) (undo-tree-id46 . -9) (undo-tree-id47 . -9) (undo-tree-id48 . -9) (undo-tree-id49 . -1) (undo-tree-id50 . -9) (undo-tree-id51 . -1) (undo-tree-id52 . -9) (undo-tree-id53 . -9) (undo-tree-id54 . -9) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -9) (undo-tree-id59 . -9) (undo-tree-id60 . -1) (undo-tree-id61 . -9) (undo-tree-id62 . -9) (undo-tree-id63 . -1) (undo-tree-id64 . -9) (undo-tree-id65 . -9) (undo-tree-id66 . -1) (undo-tree-id67 . -9) (undo-tree-id68 . -1) (undo-tree-id69 . -9) (undo-tree-id70 . -9) (undo-tree-id71 . -9) (undo-tree-id72 . -9) (undo-tree-id73 . -9) (undo-tree-id74 . -9) (undo-tree-id75 . -9) (undo-tree-id76 . -9) (undo-tree-id77 . -9) (undo-tree-id78 . -9) (undo-tree-id79 . -9) (undo-tree-id80 . -9) (undo-tree-id81 . -9) (undo-tree-id82 . -9) (undo-tree-id83 . -9) (undo-tree-id84 . -9) (undo-tree-id85 . -9) (undo-tree-id86 . -1) (undo-tree-id87 . -9) (undo-tree-id88 . -9) (undo-tree-id89 . -9) (undo-tree-id90 . -9) (undo-tree-id91 . -9) (undo-tree-id92 . -9) (undo-tree-id93 . -9)) nil (26944 15767 187146 0) 0 nil])
([nil nil ((15207 . 15216)) nil (26944 15767 187124 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15225 . 15226) (nil fontified nil 15216 . 15226) (15216 . 15226)) nil (26944 15767 187124 0) 0 nil])
([nil nil ((15226 . 15227)) nil (26944 15767 187123 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -15226) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) 15227) nil (26944 15767 187122 0) 0 nil])
([nil nil ((15226 . 15230)) nil (26944 15767 187120 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -15229) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) 15230) nil (26944 15767 187118 0) 0 nil])
([nil nil ((15229 . 15231)) nil (26944 15767 187105 0) 0 nil])
([nil nil ((1117 . 1118) (t 26944 15767 0 0)) nil (26944 15915 160859 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1420 . 1421) (nil fontified nil 1309 . 1421) (nil fontified nil 1300 . 1309) (nil fontified nil 1294 . 1300) (nil fontified nil 1291 . 1294) (nil fontified nil 1287 . 1291) (nil fontified nil 1146 . 1287) (nil fontified nil 1139 . 1146) (nil fontified nil 1125 . 1139) (nil fontified nil 1124 . 1125) (nil fontified nil 1119 . 1124) (nil fontified nil 1118 . 1119) (1118 . 1421)) nil (26944 15915 160858 0) 0 nil])
([nil nil ((1421 . 1422)) nil (26944 15915 160857 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15461 . 15462) (nil fontified nil 15448 . 15462) (15448 . 15462)) nil (26944 15915 160856 0) 0 nil])
([nil nil ((15462 . 15463)) nil (26944 15915 160856 0) 0 nil])
([nil nil ((15448 . 15449)) nil (26944 15915 160855 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -15447) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (#("\"" 0 1 (face font-lock-string-face fontified t)) . -15448) (undo-tree-id131 . -1) 15449) nil (26944 15915 160854 0) 0 nil])
([nil nil ((15447 . 15448)) nil (26944 15915 160851 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -15447) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) 15448) nil (26944 15915 160850 0) 0 nil])
([nil nil ((15447 . 15448)) nil (26944 15915 160839 0) 0 nil])
([nil nil ((15472 . 15473)) nil (26944 15915 160835 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -1395) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) 1396 (t 26944 15915 0 0)) nil (26944 16016 129467 0) 0 nil])
([nil nil ((1395 . 1396)) nil (26944 16016 129465 0) 0 nil])
([nil nil ((#("_" 0 1 (fontified t)) . -1399) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) 1400) nil (26944 16016 129463 0) 0 nil])
([nil nil ((1399 . 1400)) nil (26944 16016 129449 0) 0 nil])
([nil nil ((#("_" 0 1 (face font-lock-doc-face fontified t)) . -1165) (undo-tree-id192 . -1) 1166 (t 26944 16016 0 0)) nil (26944 16074 142963 0) 0 nil])
([nil nil ((1165 . 1166)) nil (26944 16074 142961 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-doc-face fontified t)) . -1171) (undo-tree-id191 . -1) 1172) nil (26944 16074 142960 0) 0 nil])
([nil nil ((1171 . 1172)) nil (26944 16074 142959 0) 0 nil])
([nil nil ((#("
	(print \"111\")" 0 1 (fontified t) 1 2 (fontified t) 2 9 (fontified t) 9 12 (fontified t face font-lock-string-face) 12 14 (face font-lock-string-face fontified t) 14 15 (fontified t rear-nonsticky t)) . 17443) (undo-tree-id190 . -15)) nil (26944 16074 142958 0) 0 nil])
([nil nil ((#("
      (print \"000\")" 0 1 (fontified t) 1 7 (fontified t) 7 14 (fontified t) 14 19 (face font-lock-string-face fontified t) 19 20 (fontified t rear-nonsticky t)) . 17325) (undo-tree-id187 . -20) (undo-tree-id188 . -20) (undo-tree-id189 . -20)) nil (26944 16074 142956 0) 0 nil])
([nil nil ((#("
	(print \"333\")" 0 1 (fontified t) 1 9 (fontified t) 9 14 (face font-lock-string-face fontified t) 14 15 (fontified t)) . 17480) (undo-tree-id182 . -15) (undo-tree-id183 . -15) (undo-tree-id184 . -15) (undo-tree-id185 . -15) (undo-tree-id186 . -15)) nil (26944 16074 142954 0) 0 nil])
([nil nil ((#("
	       (x (print col))" 0 1 (fontified t) 1 14 (fontified t) 14 16 (fontified t) 16 24 (fontified t)) . 15473) (undo-tree-id168 . -24) (undo-tree-id169 . -24) (undo-tree-id170 . -16) (undo-tree-id171 . -16) (undo-tree-id172 . -16) (undo-tree-id173 . -16) (undo-tree-id174 . -16) (undo-tree-id175 . -16) (undo-tree-id176 . -16) (undo-tree-id177 . -16) (undo-tree-id178 . -24) (undo-tree-id179 . -24) (undo-tree-id180 . -24) (undo-tree-id181 . -24)) nil (26944 16074 142949 0) 0 nil])
([nil nil ((#("
	       (x (print val))" 0 1 (fontified t) 1 9 (fontified t) 9 18 (fontified t) 18 19 (fontified t rear-nonsticky t) 19 24 (fontified t)) . 15504) (undo-tree-id162 . -24) (undo-tree-id163 . -9) (undo-tree-id164 . -24) (undo-tree-id165 . -24) (undo-tree-id166 . -24) (undo-tree-id167 . -24)) nil (26944 16074 142940 0) 0 nil])
([nil nil ((#("
	  (print slot)" 0 1 (fontified t) 1 16 (fontified t)) . 15559) (undo-tree-id157 . -16) (undo-tree-id158 . -16) (undo-tree-id159 . -16) (undo-tree-id160 . -16) (undo-tree-id161 . -16)) nil (26944 16074 142934 0) 0 nil])
([nil nil ((#("
	(print \"XXX\")" 0 1 (fontified t) 1 9 (fontified t) 9 14 (face font-lock-string-face fontified t) 14 15 (fontified t)) . 15411) (undo-tree-id152 . -15) (undo-tree-id153 . -15) (undo-tree-id154 . -15) (undo-tree-id155 . -15) (undo-tree-id156 . -15)) nil (26944 16074 142930 0) 0 nil])
([nil nil ((#("
      (print ent)
      (print payload*)" 0 1 (fontified t) 1 7 (fontified t) 7 17 (fontified t) 17 18 (fontified t rear-nonsticky t) 18 19 (fontified t) 19 25 (fontified t) 25 32 (fontified t) 32 39 (fontified t) 39 40 (fontified t rear-nonsticky t) 40 41 (fontified t rear-nonsticky t)) . 15296) (undo-tree-id145 . -41) (undo-tree-id146 . -18) (undo-tree-id147 . -32) (undo-tree-id148 . -41) (undo-tree-id149 . -41) (undo-tree-id150 . -41) (undo-tree-id151 . -41)) nil (26944 16074 142925 0) 0 nil])
([nil nil ((#("
      (print \"2222\")
      (print ent)" 0 1 (fontified t) 1 14 (fontified t) 14 20 (face font-lock-string-face fontified t) 20 22 (fontified t) 22 39 (fontified t)) . 15589) (undo-tree-id140 . -39) (undo-tree-id141 . -39) (undo-tree-id142 . -39) (undo-tree-id143 . -39) (undo-tree-id144 . -39)) nil (26944 16074 142916 0) 0 nil])
([nil nil ((14374 . 14377) (t 26944 16074 0 0)) nil (26948 13305 550554 0) 0 nil])
([nil nil ((14377 . 14383)) nil (26948 13305 550554 0) 0 nil])
([nil nil ((14383 . 14384)) nil (26948 13305 550553 0) 0 nil])
([nil nil ((14384 . 14387)) nil (26948 13305 550553 0) 0 nil])
([nil nil ((14387 . 14388)) nil (26948 13305 550552 0) 0 nil])
([nil nil ((14388 . 14392)) nil (26948 13305 550552 0) 0 nil])
([nil nil ((14392 . 14393)) nil (26948 13305 550551 0) 0 nil])
([nil nil ((14393 . 14399)) nil (26948 13305 550551 0) 0 nil])
([nil nil ((14399 . 14400)) nil (26948 13305 550550 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -14399) (undo-tree-id1 . -1) 14400) nil (26948 13305 550549 0) 0 nil])
([nil nil ((14399 . 14401)) nil (26948 13305 550547 0) 0 nil])
([nil nil ((14561 . 14564)) nil (26948 13305 550547 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14587 . 14588) (nil fontified nil 14587 . 14588) (nil fontified nil 14571 . 14587) (nil fontified nil 14564 . 14571) (14564 . 14588)) nil (26948 13305 550546 0) 0 nil])
([nil nil ((#("CREATE" 0 6 (face font-lock-string-face fontified t)) . -14580) (undo-tree-id0 . -6) 14586) nil (26948 13305 550544 0) 0 nil])
([nil nil ((14580 . 14587)) nil (26948 13305 550524 0) 0 nil])
([nil nil ((16852 . 16854) (t 26948 13305 0 0)) nil (26949 34653 146946 0) 0 nil])
([nil nil ((16854 . 16860)) nil (26949 34653 146946 0) 0 nil])
([nil nil ((16860 . 16861)) nil (26949 34653 146945 0) 0 nil])
([nil nil ((16861 . 16864)) nil (26949 34653 146945 0) 0 nil])
([nil nil ((16955 . 16957)) nil (26949 34653 146945 0) 0 nil])
([nil nil ((16957 . 16963)) nil (26949 34653 146944 0) 0 nil])
([nil nil ((16963 . 16964)) nil (26949 34653 146943 0) 0 nil])
([nil nil ((16964 . 16969)) nil (26949 34653 146943 0) 0 nil])
([nil nil ((16969 . 16970)) nil (26949 34653 146942 0) 0 nil])
([nil nil ((16970 . 16974)) nil (26949 34653 146941 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -16973) (undo-tree-id4 . -1) 16974) nil (26949 34653 146941 0) 0 nil])
([nil nil ((16973 . 16974)) nil (26949 34653 146939 0) 0 nil])
([nil nil ((16741 . 16748)) nil (26949 34653 146939 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16764 . 16765) (nil fontified nil 16764 . 16765) (nil fontified nil 16755 . 16764) (nil fontified nil 16748 . 16755) (16748 . 16765)) nil (26949 34653 146938 0) 0 nil])
([nil nil ((16756 . 16758)) nil (26949 34653 146937 0) 0 nil])
([nil nil ((16758 . 16759)) nil (26949 34653 146937 0) 0 nil])
([nil nil ((#(" OK" 0 3 (face font-lock-string-face fontified t)) . 16763)) nil (26949 34653 146936 0) 0 nil])
([nil nil ((16763 . 16764)) nil (26949 34653 146935 0) 0 nil])
([nil nil ((16764 . 16769)) nil (26949 34653 146935 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -16767) (undo-tree-id2 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -16768) (undo-tree-id3 . -1) 16769) nil (26949 34653 146934 0) 0 nil])
([nil nil ((16767 . 16770)) nil (26949 34653 146921 0) 0 nil])
([nil nil ((16770 . 16771)) nil (26949 34653 146920 0) 0 nil])
([nil nil ((16771 . 16777)) nil (26949 34653 146916 0) 0 nil])
([nil nil ((18615 . 18616) (t 26949 34653 0 0)) nil (26949 38479 796454 0) 0 nil])
([nil nil ((18616 . 18618)) nil (26949 38479 796454 0) 0 nil])
([nil nil ((19445 . 19447)) nil (26949 38479 796453 0) 0 nil])
([nil nil ((20100 . 20104)) nil (26949 38479 796453 0) 0 nil])
([nil nil ((20104 . 20105)) nil (26949 38479 796452 0) 0 nil])
([nil nil ((20105 . 20110)) nil (26949 38479 796452 0) 0 nil])
([nil nil ((20110 . 20111)) nil (26949 38479 796451 0) 0 nil])
([nil nil ((20179 . 20181)) nil (26949 38479 796451 0) 0 nil])
([nil nil ((20181 . 20185)) nil (26949 38479 796450 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20233 . 20234) (nil fontified nil 20230 . 20234) (nil fontified nil 20222 . 20230) (nil fontified nil 20218 . 20222) (nil fontified nil 20215 . 20218) (nil fontified nil 20185 . 20215) (20185 . 20234)) nil (26949 38479 796449 0) 0 nil])
([nil nil ((#(" :id id :payload p1" 0 1 (fontified t) 1 4 (face font-lock-builtin-face fontified t) 4 8 (fontified t) 8 16 (face font-lock-builtin-face fontified t) 16 19 (fontified t)) . -20214) (undo-tree-id18 . -19) 20233) nil (26949 38479 796447 0) 0 nil])
([nil nil ((20219 . 20220)) nil (26949 38479 796445 0) 0 nil])
([nil nil ((20148 . 20153) (#(" " 0 1 (fontified nil)) . 20147) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (20148 . 20149)) nil (26949 38479 796442 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20486) (undo-tree-id23 . -1) (#(")" 0 1 (fontified t)) . -20487) (undo-tree-id24 . -1) 20488 (t 26949 38479 0 0)) nil (26949 38657 886038 0) 0 nil])
([nil nil ((20486 . 20487)) nil (26949 38657 886036 0) 0 nil])
([nil nil ((20487 . 20492)) nil (26949 38657 886036 0) 0 nil])
([nil nil ((20492 . 20496)) nil (26949 38657 886035 0) 0 nil])
([nil nil ((20496 . 20497)) nil (26949 38657 886034 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20856) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) 20857) nil (26949 38657 886033 0) 0 nil])
([nil nil ((20926 . 20933)) nil (26949 38657 886030 0) 0 nil])
([nil nil ((20933 . 20937)) nil (26949 38657 886030 0) 0 nil])
([nil nil ((20937 . 20938)) nil (26949 38657 886030 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -20937) (undo-tree-id19 . -1) 20938) nil (26949 38657 886028 0) 0 nil])
([nil nil ((20937 . 20938)) nil (26949 38657 886020 0) 0 nil])
([nil nil ((20938 . 20939)) nil (26949 38657 886020 0) 0 nil])
([nil nil ((20939 . 20942)) nil (26949 38657 886019 0) 0 nil])
([nil nil ((20942 . 20944)) nil (26949 38657 886018 0) 0 nil])
([nil nil ((nil fontified nil 20973 . 20974) (nil fontified nil 20944 . 20973) (20944 . 20974)) nil (26949 38657 886017 0) 0 nil])
([nil nil ((20974 . 20978)) nil (26949 38657 886013 0) 0 nil])
([nil nil ((15351 . 15358) (t 26949 38657 0 0)) nil (26975 57988 132695 0) 0 nil])
([nil nil ((15358 . 15364)) nil (26975 57988 132694 0) 0 nil])
([nil nil ((15364 . 15365)) nil (26975 57988 132691 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -15359) (undo-tree-id101 . -1) (#("r" 0 1 (fontified t)) . -15360) (undo-tree-id102 . -1) (#("i" 0 1 (fontified t)) . -15361) (undo-tree-id103 . -1) (#("n" 0 1 (fontified t)) . -15362) (undo-tree-id104 . -1) (#("t" 0 1 (fontified t)) . -15363) (undo-tree-id105 . -1) (#(" " 0 1 (fontified t)) . -15364) (undo-tree-id106 . -1) 15365) nil (26975 57988 132689 0) 0 nil])
([nil nil ((15359 . 15365)) nil (26975 57988 132684 0) 0 nil])
([nil nil ((15365 . 15366)) nil (26975 57988 132684 0) 0 nil])
([nil nil ((15366 . 15367)) nil (26975 57988 132683 0) 0 nil])
([nil nil ((15367 . 15368)) nil (26975 57988 132683 0) 0 nil])
([nil nil ((15368 . 15369)) nil (26975 57988 132683 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . -15368) (undo-tree-id100 . -1) 15369) nil (26975 57988 132682 0) 0 nil])
([nil nil ((15368 . 15377)) nil (26975 57988 132681 0) 0 nil])
([nil nil ((15369 . 15387)) nil (26975 57988 132680 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-string-face fontified t)) . -15386) (undo-tree-id99 . -1) 15387) nil (26975 57988 132680 0) 0 nil])
([nil nil ((15386 . 15387)) nil (26975 57988 132679 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-string-face fontified t)) . -15386) (undo-tree-id98 . -1) 15387) nil (26975 57988 132678 0) 0 nil])
([nil nil ((15386 . 15387)) nil (26975 57988 132677 0) 0 nil])
([nil nil ((#("L" 0 1 (face font-lock-string-face fontified t)) . -15388) (undo-tree-id97 . -1) 15389) nil (26975 57988 132676 0) 0 nil])
([nil nil ((15394 . 15395)) nil (26975 57988 132675 0) 0 nil])
([nil nil ((15395 . 15396)) nil (26975 57988 132675 0) 0 nil])
([nil nil ((15369 . 15371)) nil (26975 57988 132674 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -15397) (undo-tree-id96 . -1) 15398) nil (26975 57988 132674 0) 0 nil])
([nil nil ((15397 . 15398)) nil (26975 57988 132671 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-string-face fontified t)) . -15397) (undo-tree-id95 . -1) 15398) nil (26975 57988 132670 0) 0 nil])
([nil nil ((15397 . 15398)) nil (26975 57988 132669 0) 0 nil])
([nil nil ((15398 . 15400)) nil (26975 57988 132669 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-string-face fontified t)) . -15398) (undo-tree-id93 . -1) (#("!" 0 1 (face font-lock-string-face fontified t)) . -15399) (undo-tree-id94 . -1) 15400) nil (26975 57988 132668 0) 0 nil])
([nil nil ((15398 . 15400)) nil (26975 57988 132667 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-string-face fontified t)) . -15399) (undo-tree-id91 . -1) (undo-tree-id92 . -1) 15400) nil (26975 57988 132666 0) 0 nil])
([nil nil ((15399 . 15400)) nil (26975 57988 132664 0) 0 nil])
([nil nil ((15400 . 15405)) nil (26975 57988 132664 0) 0 nil])
([nil nil ((#("M" 0 1 (face font-lock-string-face fontified t)) . -15403) (undo-tree-id89 . -1) (#("%" 0 1 (face font-lock-string-face fontified t)) . -15404) (undo-tree-id90 . -1) 15405) nil (26975 57988 132663 0) 0 nil])
([nil nil ((15403 . 15404)) nil (26975 57988 132661 0) 0 nil])
([nil nil ((15404 . 15405)) nil (26975 57988 132661 0) 0 nil])
([nil nil ((15405 . 15406)) nil (26975 57988 132661 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15413 . 15414) (nil fontified nil 15406 . 15414) (15406 . 15414)) nil (26975 57988 132660 0) 0 nil])
([nil nil ((15414 . 15415)) nil (26975 57988 132659 0) 0 nil])
([nil nil ((15708 . 15715)) nil (26975 57988 132659 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15771 . 15772) (nil fontified nil 15771 . 15772) (nil fontified nil 15770 . 15771) (nil fontified nil 15763 . 15770) (nil fontified nil 15762 . 15763) (nil fontified nil 15725 . 15762) (nil fontified nil 15715 . 15725) (15715 . 15772)) nil (26975 57988 132658 0) 0 nil])
([nil nil ((#("PAYLOAD" 0 7 (face font-lock-string-face fontified t)) . -15746) (undo-tree-id78 . -7) (undo-tree-id79 . -2) (undo-tree-id80 . -2) (undo-tree-id81 . -2) (undo-tree-id82 . -2) (undo-tree-id83 . -2) (undo-tree-id84 . -2) (undo-tree-id85 . -7) (undo-tree-id86 . -7) (undo-tree-id87 . -7) (undo-tree-id88 . -7) 15753) nil (26975 57988 132657 0) 0 nil])
([nil nil ((#("*" 0 1 (face font-lock-string-face fontified t)) . 15746)) nil (26975 57988 132649 0) 0 nil])
([nil nil ((15746 . 15756)) nil (26975 57988 132649 0) 0 nil])
([nil nil ((15756 . 15757)) nil (26975 57988 132648 0) 0 nil])
([nil nil ((15757 . 15759)) nil (26975 57988 132648 0) 0 nil])
([nil nil ((15746 . 15752)) nil (26975 57988 132647 0) 0 nil])
([nil nil ((15752 . 15753)) nil (26975 57988 132647 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -15768) (undo-tree-id75 . -1) (#("~" 0 1 (face font-lock-string-face fontified t)) . -15769) (undo-tree-id76 . -1) (#("A" 0 1 (face font-lock-string-face fontified t)) . -15770) (undo-tree-id77 . -1) 15771) nil (26975 57988 132646 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -15766) (undo-tree-id73 . -1) (#(":" 0 1 (face font-lock-string-face fontified t)) . -15767) (undo-tree-id74 . -1) 15768) nil (26975 57988 132643 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -15769) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (#("p" 0 1 (fontified t)) . -15770) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (#("a" 0 1 (fontified t)) . -15771) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (#("y" 0 1 (fontified t)) . -15772) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (#("l" 0 1 (fontified t)) . -15773) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (#("o" 0 1 (fontified t)) . -15774) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (#("a" 0 1 (fontified t)) . -15775) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (#("d" 0 1 (fontified t)) . -15776) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (#("*" 0 1 (fontified t rear-nonsticky t)) . -15777) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) 15778) nil (26975 57988 132638 0) 0 nil])
([nil nil ((15923 . 15927)) nil (26975 57988 132599 0) 0 nil])
([nil nil ((nil fontified nil 15981 . 15982) (nil fontified nil 15937 . 15981) (nil fontified nil 15927 . 15937) (15927 . 15982)) nil (26975 57988 132598 0) 0 nil])
([nil nil ((#("VALIDATION" 0 10 (face font-lock-string-face fontified t)) . -15965) (undo-tree-id0 . -10) (undo-tree-id1 . -2) (undo-tree-id2 . -2) (undo-tree-id3 . -2) (undo-tree-id4 . -2) (undo-tree-id5 . -2) (undo-tree-id6 . -10) (undo-tree-id7 . -10) (undo-tree-id8 . -10) (undo-tree-id9 . -10) 15975) nil (26975 57988 132596 0) 0 nil])
([nil nil ((15965 . 15971)) nil (26975 57988 132570 0) 0 nil])
([nil nil ((#("
#|
(defmethod repo-index :around (entity ctx &rest args)
  (destructuring-bind (&key filters &allow-other-keys) args
    (let* ((md   (entity-metadata entity))
           (tcol (%entity-tenant-col entity md))       ; NIL si pas de colonne tenant
           (tid  (getf ctx :tenant-id))
           (base (%ensure-filter-list filters))
           (filters*
             (if (and tcol tid (not (%has-tenant-clause-p base tcol tid)))
                 (append base (list (list '= tcol tid)))
                 base))
           ;; Remplacer :filters dans les args
           (args* (alexandria:plist-alist (lumen.utils:copy-plist args))))
      (setf (cdr (assoc :filters args*)) filters*)
      (let ((op :index))
        (repo-authorize op entity ctx)
        (apply #'call-next-method entity ctx (alexandria:alist-plist args*))))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 830 (face font-lock-comment-face fontified t) 830 832 (face font-lock-comment-delimiter-face fontified t)) . 18796) (undo-tree-id3 . -832) (t 26975 57988 0 0)) nil (26976 37468 366616 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -18795) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 18796) nil (26976 37468 366613 0) 0 nil])
([nil nil ((#("
;; index/show — lecture (pas de BEGIN obligatoire)
#|
(defmethod repo-index :around (entity ctx &rest args)
  (let ((op :index))
    (repo-authorize op entity ctx)
    ;; ⚠️ relayer les args !
    (apply #'call-next-method entity ctx args)))
|#" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 52 (face font-lock-comment-face fontified t) 52 54 (face font-lock-comment-delimiter-face fontified t) 54 198 (face font-lock-comment-face fontified t) 198 243 (face font-lock-comment-face fontified t) 243 245 (face font-lock-comment-delimiter-face fontified t)) . 18038) (undo-tree-id0 . -245)) nil (26976 37468 366607 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.repo.core
  (:use :cl)
  (:import-from :lumen.core.http
   :ctx-get :ctx-set! :current-jwt :current-role :current-user-id :respond-404
   :ctx-from-req)
  (:import-from :lumen.data.dao
    :entity-metadata :entity-fields :row->entity :entity->row-alist
    :entity-insert! :entity-update! :entity-delete! :validate-entity!
    :entity-slot-symbol)
  (:import-from :lumen.data.repo.query   ;; helpers SQL existants (select*, count*, etc.)
    :select* :select-page-keyset* :select-page-keyset-prev* :count*)
  (:import-from :lumen.utils
    :alist-get :copy-plist)
  (:import-from :lumen.data.db
   :with-tx :ensure-connection :query-1a)
  (:import-from :lumen.data.tenant :tenant-code-by-id :tenant-id-for-host
   :tenant-id-by-code)
  (:export
    ;; API “haut-niveau” (appelées par les contrôleurs, routes CRUD, jobs…)
    :repo-index :repo-show :repo-create :repo-patch :repo-delete
    ;; Hooks extensibles par entité
    :repo-authorize :repo-normalize :repo-validate :repo-before :repo-persist :repo-after
    ;; Utilitaires
    ))

(in-package :lumen.data.repo.core)

(defun %norm-col-name (x)
  \"UPCASE + remplace - par _ pour comparer des noms de colonnes entre
   nos :fields (:CREATED_AT) et les clés d'alist renvoyées (CREATED-AT).\"
  (let ((s (etypecase x
             (symbol (symbol-name x))
             (string x))))
    (substitute #\\_ #\\- (string-upcase s))))

;;; ---------------------------------------------------------------------------
;;; API générique (génériques CLOS)
;;; ---------------------------------------------------------------------------
(defgeneric repo-index  (entity ctx &key filters order select page
				      page-size limit offset after before key))
(defgeneric repo-show   (entity ctx id))
(defgeneric repo-create (entity ctx payload))
(defgeneric repo-patch  (entity ctx id payload))
(defgeneric repo-delete (entity ctx id))

;;; Hooks transverses (spécialisables par entité)
(defgeneric repo-authorize (op entity ctx &key id payload))
(defgeneric repo-normalize (op entity ctx payload))
(defgeneric repo-validate (op entity ctx payload))
(defgeneric repo-before   (op entity ctx &key id payload))
(defgeneric repo-persist  (op entity ctx &key id payload))
(defgeneric repo-after    (op entity ctx result &key id payload))

;;; ---------------------------------------------------------------------------
;;; Defaults : autorisations, normalisation, validation, after (audit)…
;;; ---------------------------------------------------------------------------
(defmethod repo-authorize (op (entity symbol) ctx &key id payload)
  (declare (ignore id payload))
  ;; Par défaut : lecture libre ; écriture nécessite scope \"<table>:write\"
  (let* ((md (entity-metadata entity))
         (table (string-downcase (or (getf md :table) (symbol-name entity))))
         (write? (member op '(:create :patch :delete))))
    (if write?
        (member (format nil \"~a:write\" table) (getf ctx :scopes) :test #'string=)
        t)))

(defmethod repo-normalize (op (entity symbol) ctx payload)
  (declare (ignore op entity ctx))
  payload)

;;; ---------------------------------------------------------------------------
;;; Garde-fous framework (CLOS :around)
;;; - S'exécutent AVANT tout (CLOS), mais on délègue aux primaires via
;;;   (call-next-method), puis on RÉ-APPLIQUE les invariants.
;;; - Rend le socle plus robuste même si une app oublie call-next-method.
;;; ---------------------------------------------------------------------------
(defmethod repo-normalize :around ((op (eql :create)) (entity symbol) ctx payload)
  \"Pipeline final framework pour CREATE :
   1) Laisse les méthodes primaires spécifiques s’exécuter,
   2) puis garantit les invariants Lumen (idempotents).\"
  (let* ((out (call-next-method))                ; ← primaires (app + socle)
         (p0 (%normalize-payload-keys out))      ; clés normalisées (kw/strings)
	 
         (p1 (%remove-protected-fields p0))      ; retire :id, :created_at, etc.
	 
         (tid (%resolve-tenant-id ctx p1)))      ; trouve le tenant depuis ctx/payload
    
    (unless tid
      (error 'lumen.data.errors:db-error
             :message \"missing or invalid tenant-id\"))
    ;; impose/écrase tenant_id (idempotent) + renvoie un payload propre
    (lumen.utils:alist-set p1 :tenant_id tid :test #'eq)))

(defmethod repo-normalize :around ((op (eql :patch)) (entity symbol) ctx payload)
  \"Pipeline final framework pour PATCH :
   - Retire les champs protégés
   - Verrouille le tenant (impossible de changer de tenant).\"
  (let* ((out (call-next-method op entity ctx payload))
         (p0 (%normalize-payload-keys out))
         (p1 (%remove-protected-fields p0))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid
      (error 'lumen.data.errors:db-error
             :message \"missing or invalid tenant-id\"))
    ;; Ne JAMAIS permettre de modifier :tenant_id par PATCH
    ;;(remf p1 :tenant_id)
    ;;(acons :tenant_id tid p1)
    (lumen.utils:alist-set p1 :tenant_id tid :test #'eq)
    ))

(defmethod repo-validate (op (entity symbol) ctx payload)
  (declare (ignore op))
  ;; Validation DSL si l’app fournit (sinon no-op)
  (ignore-errors
   (let* ((ent (row->entity entity payload)))
      (validate-entity! ent)))
  payload)

(defmethod repo-before (op (entity symbol) ctx &key id payload)
  (declare (ignore op entity ctx id payload))
  ;; no-op par défaut
  (values))

(defmethod repo-after (op (entity symbol) ctx result &key id payload)
  (declare (ignore id payload))
  (let* ((req   (getf ctx :req))
         ;; fallbacks : si :actor-id absent, on essaie via req/JWT
         (actor (or (getf ctx :actor-id)
                    (and req (lumen.core.http:current-user-id req))))
         (tenant (getf ctx :tenant-id))
         (audit? (getf ctx :audit?)))
    ;; debug
    (format t \"~&[repo-after] actor=~A tenant=~A op=~A ent=~A~%\"
            actor tenant (string-downcase (symbol-name op))
            (string-downcase (symbol-name entity)))
    ;; Audit optionnel
    (when audit?
      (ignore-errors
        (lumen.data.db:ensure-connection
          (lumen.data.db:exec
           \"insert into audit_log(actor_id, tenant_id, action, resource, payload)
            values($1,$2,$3,$4,$5)\"
           actor
           tenant
           (string-downcase (symbol-name op))
           (string-downcase (symbol-name entity))
           (cl-json:encode-json-to-string result))))))
  result)

;;; ---------------------------------------------------------------------------
;;; Implémentations par défaut (primaire) — s’appuient sur metadata defentity
;;; ---------------------------------------------------------------------------

;; INDEX (liste)
(defun %has-tenant-clause-p (filters tcol tid)
  (let ((clauses (%ensure-filter-list filters)))
    (some (lambda (c)
            (and (consp c)
                 (eq (first c) '=)
                 (eql (second c) tcol)
                 (equal (third c) tid)))
          clauses)))

;;; Utilitaires colonne → keyword
(defun %kw-col (x)
  (cond
    ((null x) nil)
    ((keywordp x) x)
    ((symbolp x)  (intern (string-upcase (symbol-name x)) :keyword))
    ((stringp x)  (intern (string-upcase x) :keyword))
    (t nil)))

(defun entity-timestamp-cols (entity)
  \"Retourne la liste des colonnes timestamps (:created / :updated) si définies via :timestamps.\"
  (let* ((md (entity-metadata entity))
         (ts (getf md :timestamps)))
    (when ts
      (remove nil (list (%kw-col (getf ts :created))
                        (%kw-col (getf ts :updated)))))))

(defun entity-field-cols (entity)
  \"Colonnes déclarées dans :fields.\"
  (mapcar (lambda (f) (getf f :col)) (entity-fields entity)))

(defun %entity-tenant-col (entity &optional md)
  \"Retourne la colonne tenant-id *si et seulement si* elle est déclarée ET présente dans :fields.\"
  (let* ((md     (or md (entity-metadata entity)))
         (fields (getf md :fields))
         (decl   (getf md :tenant-id-col)))
    (labels ((has-col-p (kw)
               (and kw (some (lambda (f) (eq (getf f :col) kw)) fields))))
      (cond
        ((and decl (has-col-p decl)) decl)          ; colonne explicitement déclarée et présente
        ((has-col-p :tenant_id) :tenant_id)         ; fallback si :tenant_id existe réellement
        (t nil)))))                                   ; sinon pas de colonne tenant

(defun %maybe-add-tenant-filter (filters tcol tid)
  \"Ajoute (= tcol tid) si tcol/tid présents et que le filtre n’est pas déjà là.\"
  (let ((flt (%ensure-filter-list filters)))
    (if (and tcol tid (not (%has-tenant-clause-p flt tcol tid)))
        (append flt (list (list '= tcol tid)))
        flt)))

(defun %ensure-tenant-on-payload (entity ctx payload &key (op :create) (forbid-change-p t))
  \"Pour CREATE, injecte (tcol . tid) si absent.
   Pour PATCH, bloque (ou ignore) toute tentative de changer le tenant.\"
  (let* ((md   (entity-metadata entity))
         (tcol (%entity-tenant-col entity md))
         (tid  (getf ctx :tenant-id)))
    (cond
      ;; Pas de colonne tenant sur cette entité → payload inchangé
      ((null tcol) payload)

      ;; CREATE : si tenant présent dans ctx et absent dans payload → on l’injecte
      ((eq op :create)
       (cond
         ((null tid) payload) ; rien à injecter sans tenant courant
         ;; déjà au bon format (keyword)
         ((assoc tcol payload)
          (let ((v (cdr (assoc tcol payload))))
            (when (and v tid (string/= (string-downcase (princ-to-string v))
                                       (string-downcase (princ-to-string tid))))
              (error \"forbidden: tenant mismatch on create (~A ≠ ~A)\" v tid))
            payload))
         ;; présent sous forme string \"tenant_id\"
         ((assoc (string-downcase (symbol-name tcol)) payload :test #'string=)
          (let ((v (cdr (assoc (string-downcase (symbol-name tcol)) payload :test #'string=))))
            (when (and v tid (string/= (string-downcase (princ-to-string v))
                                       (string-downcase (princ-to-string tid))))
              (error \"forbidden: tenant mismatch on create (~A ≠ ~A)\" v tid))
            ;; on normalise en keyword
            (acons tcol (or v tid) (remove (string-downcase (symbol-name tcol)) payload
                                           :key #'car :test #'string=))))
         ;; absent → on injecte
         (t (acons tcol tid payload))))

      ;; PATCH : on empêche (par défaut) le changement de tenant
      ((eq op :patch)
       (let* ((kw-pair (assoc tcol payload))
              (str-key (string-downcase (symbol-name tcol)))
              (str-pair (assoc str-key payload :test #'string=)))
         (when (and forbid-change-p (or kw-pair str-pair))
           (let* ((newv (or (cdr kw-pair) (cdr str-pair)))
                  (curv tid))
             (when (and newv curv (string/= (string-downcase (princ-to-string newv))
                                             (string-downcase (princ-to-string curv))))
               (error \"forbidden: cannot change tenant on patch\"))))
         ;; on retire toute tentative de changer le tenant pour éviter une update inutile
         (remove tcol
                 (if str-pair
                     (remove str-key payload :key #'car :test #'string=)
                     payload)
                 :key #'car :test #'eq)))

      (t payload))))

(defun entity-allowed-cols (entity &key include-pk? include-tenant? include-lock?)
  \"Union des colonnes :fields + timestamps + (optionnel) pk/tenant/lock_version.
N’ajoute la colonne tenant que si elle existe effectivement sur l’entité.\"
  (let* ((md        (entity-metadata entity))
         (fields    (getf md :fields))
         (pk        (and include-pk?     (%kw-col (or (getf md :primary-key) :id))))
         (tcol      (%entity-tenant-col entity md))
         (tenantcol (and include-tenant? tcol))
         ;; lock_version seulement si déclaré ET présent côté fields
         (lock-decl (getf md :lock-version))
         (lockcol   (and include-lock?
                         lock-decl
                         (some (lambda (f) (eq (getf f :col) lock-decl)) fields)
                         (%kw-col lock-decl))))
    (remove-duplicates
     (remove nil
             (append (entity-field-cols entity)
                     (entity-timestamp-cols entity)  ; created_at/updated_at si timestamps présents
                     (list pk tenantcol lockcol)))
     :test #'eq)))

(defmethod repo-index ((entity symbol) ctx
                       &key filters order select page page-size limit offset
                            after before key)
  (let* ((md      (entity-metadata entity))
         (table   (getf md :table))
         (allowed (entity-allowed-cols entity :include-pk? t :include-tenant? t))
         (tid     (getf ctx :tenant-id))
         (tcol    (%entity-tenant-col entity md))
         (filters* (%maybe-add-tenant-filter filters tcol tid)))
    (lumen.data.db:ensure-connection
      (cond
        ((or after before)
         (select-page-keyset* table
                              :filters filters*
                              :order   order
                              :key     key
                              :after   after
                              :limit   (or limit 20)
                              :order-whitelist allowed))
        (t
         (select* table
                  :filters filters*
                  :order   order
                  :select  (or select :*)
                  :limit   (or (and page-size (* 1 page-size)) limit 20)
                  :offset  (or offset (and page page-size (* (max 0 (1- page)) page-size)))
                  :order-whitelist allowed))))))

;; SHOW (lecture par PK, filtrée tenant si présent)
(defmethod repo-show ((entity symbol) ctx id)
  (let* ((md   (entity-metadata entity))
         (tbl  (getf md :table))
         (pk   (or (getf md :primary-key) :id))
         (base (list '= pk id))
         (tid  (getf ctx :tenant-id))
         (tcol (%entity-tenant-col entity md))
         (filters (if (and tcol tid)
                      (list 'and base (list '= tcol tid))
                      base)))
    (lumen.data.db:ensure-connection
      (let ((rows (select* tbl :filters filters :limit 1)))
        (and rows (first rows))))))

;; CREATE
(defmethod repo-create ((entity symbol) ctx payload)
  (print \"IN REPO CREATE\")
  (repo-persist :create entity ctx :payload payload))

(defmethod repo-persist ((op (eql :create)) (entity symbol) ctx &key id payload)
  (declare (ignore id))
  (print \"IN REPO PERSIST\")
  (let* ((payload* (%ensure-tenant-on-payload entity ctx payload :op :create))
         (ent      (row->entity entity payload*)))
    (validate-entity! ent)
    (lumen.data.db:ensure-connection
      (multiple-value-bind (_n ent2) (entity-insert! ent :returning t)
        (declare (ignore _n))
        (entity->row-alist ent2)))))

;; PATCH (partial update)
(defmethod repo-patch ((entity symbol) ctx id payload)
  (repo-persist :patch entity ctx :id id :payload payload))

(defmethod repo-persist ((op (eql :patch)) (entity symbol) ctx &key id payload)
  (let* ((cur (repo-show entity ctx id)))
    (unless cur (error \"not_found\"))
    (let* ((payload* (%ensure-tenant-on-payload entity ctx payload :op :patch))
           (ent      (row->entity entity cur)))
      (format t \"~&REPO-PERSIT:PATCH:PAYLOAD* : ~A~%\" payload*)
      ;; appliquer le patch (hors tenant col)
      (dolist (kv payload*)
        (let* ((col (%norm-col-name (car kv)))
               (val  (cdr kv))
               (slot (entity-slot-symbol entity col)))
          (when slot (setf (slot-value ent slot) val))))
      (validate-entity! ent)
      (format t \"~&REPO-PERSIT:PATCH:ENTITY VALIDATION OK~%\")
      (lumen.data.db:ensure-connection
        (multiple-value-bind (_n ent2) (entity-update! ent :patch t :returning t)
          (declare (ignore _n))
	  (format t \"~&REPO-PERSIT:PATCH:ENTITY UPDATE OK~%\")
          (entity->row-alist ent2))))))

;; DELETE
(defmethod repo-delete ((entity symbol) ctx id)
  (repo-persist :delete entity ctx :id id))


(defmethod repo-persist ((op (eql :delete)) (entity symbol) ctx &key id payload)
  (declare (ignore payload))
  (lumen.data.db:with-tx ()
    (let ((cur (repo-show entity ctx id)))
      (unless cur (error \"not_found\"))
      (entity-delete! (row->entity entity cur))
      `((:deleted . t) (:id . ,id)))))

;;; ---------------------------------------------------------------------------
;;; Transactions & hooks orchestrés via :around
;;; ---------------------------------------------------------------------------
(defmacro %with-read-tx (&body body)
  ;; lecture sans obligation de BEGIN distinct (optionnel)
  `(progn ,@body))

(defmacro %with-write-tx (&body body)
  `(with-tx () ,@body))

;; create
(defmethod repo-create :around (entity ctx payload)
  (%with-write-tx
    (let ((op :create))
      (print \"IN REPO CREATE AROUND\")
      (repo-authorize op entity ctx :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
	(print p1)
        (repo-validate op entity ctx p1)
        (repo-before   op entity ctx :payload p1)
	(print \"REPO OK\")
        (let ((res (call-next-method entity ctx p1)))
          (repo-after op entity ctx res :payload p1))))))

;; patch
(defmethod repo-patch :around (entity ctx id payload)
  (%with-write-tx
    (let ((op :patch))
      (repo-authorize op entity ctx :id id :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        (repo-before   op entity ctx :id id :payload p1)
        (let ((res (call-next-method entity ctx id p1)))
          (repo-after op entity ctx res :id id :payload p1))))))

;; delete
(defmethod repo-delete :around (entity ctx id)
  (%with-write-tx
    (let ((op :delete))
      (repo-authorize op entity ctx :id id)
      (repo-before   op entity ctx :id id)
      (let ((res (call-next-method entity ctx id)))
        (repo-after op entity ctx res :id id)))))

(defun %ensure-filter-list (f)
  \"Normalise :filters en liste de clauses (AND implicite).
   Accepte NIL, une seule clause, une liste de clauses, ou (:AND ...).\"
  (cond
    ((null f) '())
    ;; (:AND ...) ou (and ...) → on prend le reste
    ((and (listp f) (member (first f) '(and :AND))) (rest f))
    ;; déjà une liste de clauses ? on suppose oui
    ((and (listp f) (every #'listp f)) f)
    ;; une seule clause
    (t (list f))))

(defun %tenant-filter-clause (tid)
  (when tid (list '= :tenant_id tid)))

(defmethod repo-index :around (entity ctx &rest args)
  (destructuring-bind (&key filters &allow-other-keys) args
    (let* ((tid        (getf ctx :tenant-id))
           (base       (%ensure-filter-list filters))
           (ten-clause (%tenant-filter-clause tid))
           ;; Ajoute le tenant_id à la fin (AND implicite)
           (filters*   (if ten-clause (append base (list ten-clause)) base))
           ;; Remplace :filters dans les args
           (args*      (alexandria:plist-alist (lumen.utils:copy-plist args))))
      (setf (cdr (assoc :filters args*)) filters*)
      (let ((op :index))
        (repo-authorize op entity ctx)
        (let ((res (apply #'call-next-method entity ctx
			  (alexandria:alist-plist args*))))
	  (repo-after op entity ctx res))))))

(defmethod repo-show :around (entity ctx id)
  (let ((op :show))
    (repo-authorize op entity ctx :id id)
    (let* ((row (call-next-method))      ; SELECT primaire
           (tid (getf ctx :tenant-id))
           (rid (and row (cdr (assoc :tenant_id row))))
	   (res 
      (cond
        ((null row) nil)                                 ; rien trouvé
        ((null tid) nil)                                 ; pas de scope tenant → prudence
        ((null rid) row)                                 ; pas de colonne tenant → renvoie
        ((string-equal (string rid) (string tid)) row)   ; même tenant → OK
        (t nil))))                                      ; cross-tenant → masque la fuite
      (when res
	(repo-after op entity ctx res)))))

;;; ------------------------------------------------------------
;;; Helpers génériques
;;; ------------------------------------------------------------
(defun %kw (x)
  (etypecase x
    (keyword x)
    (symbol  (intern (string-upcase (symbol-name x)) :keyword))
    (string  (intern (string-upcase x) :keyword))))

(defun %normalize-payload-keys (payload)
  \"Homogénéise les clés (keywords) et enlève les doublons string/keyword.\"
  (let ((ht (make-hash-table :test 'equal)))
    (dolist (kv payload)
      (setf (gethash (%kw (car kv)) ht) (cdr kv)))
    (let (out)
      (maphash (lambda (k v) (push (cons k v) out)) ht)
      (nreverse out))))

(defun %remove-protected-fields (payload &key (extra '()))
  (let* ((protected '(:id :created_at :updated_at :lock_version))
         (drop (append protected extra)))
    (remove-if (lambda (kv) (member (car kv) drop))
               payload)))

(defun %maybe-uuid-p (s)
  (and (stringp s)
       (cl-ppcre:scan \"^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$\"
                      (string-downcase s))))

;;; ------------------------------------------------------------
;;; Sanitation tenant_id
;;;   - ctx :tenant-id prioritaire (UUID attendu)
;;;   - sinon payload :tenant_id (UUID) ou code fonctionnel → résolu via app
;;; ------------------------------------------------------------
(defun %resolve-tenant-id (ctx payload)
  (let* ((ctx-tid (or (getf ctx :tenant-id) (getf ctx :tenant_id)))
         (p-tid   (or (lumen.utils:alist-get payload :tenant_id)
		      (lumen.utils:alist-get payload :tenant-id)))
         (tid
          (cond
            ((and ctx-tid (%maybe-uuid-p ctx-tid)) ctx-tid)
            ((and p-tid (%maybe-uuid-p p-tid))     p-tid)
            (p-tid                                  ;; code fonctionnel → UUID
             (handler-case
                     (funcall (or (symbol-function 'tenant-id-by-code)
                                  (lambda (_code) (declare (ignore _code)) nil))
                              p-tid)
                   (undefined-function () nil)))
            (t nil))))
    tid))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 51 (face font-lock-type-face fontified t) 51 55 (fontified t) 55 59 (face font-lock-builtin-face fontified t) 59 60 (fontified t) 60 63 (face font-lock-builtin-face fontified t) 63 68 (fontified t) 68 80 (face font-lock-builtin-face fontified t) 80 81 (fontified t) 81 97 (face font-lock-builtin-face fontified t) 97 101 (fontified t) 101 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 132 (face font-lock-builtin-face fontified t) 132 133 (fontified t) 133 146 (face font-lock-builtin-face fontified t) 146 147 (fontified t) 147 163 (face font-lock-builtin-face fontified t) 163 164 (fontified t) 164 176 (face font-lock-builtin-face fontified t) 176 180 (fontified t) 180 193 (face font-lock-builtin-face fontified t) 193 198 (fontified t) 198 210 (face font-lock-builtin-face fontified t) 210 211 (fontified t) 211 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 247 (face font-lock-builtin-face fontified t) 247 248 (fontified t) 248 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 275 (face font-lock-builtin-face fontified t) 275 276 (fontified t) 276 294 (face font-lock-builtin-face fontified t) 294 299 (fontified t) 299 314 (face font-lock-builtin-face fontified t) 314 315 (fontified t) 315 330 (face font-lock-builtin-face fontified t) 330 331 (fontified t) 331 346 (face font-lock-builtin-face fontified t) 346 347 (fontified t) 347 364 (face font-lock-builtin-face fontified t) 364 369 (fontified t) 369 388 (face font-lock-builtin-face fontified t) 388 393 (fontified t) 393 405 (face font-lock-builtin-face fontified t) 405 406 (fontified t) 406 428 (face font-lock-builtin-face fontified t) 428 431 (fontified t) 431 434 (face font-lock-comment-delimiter-face fontified t) 434 480 (face font-lock-comment-face fontified t) 480 484 (fontified t) 484 492 (face font-lock-builtin-face fontified t) 492 493 (fontified t) 493 513 (face font-lock-builtin-face fontified t) 513 514 (fontified t) 514 539 (face font-lock-builtin-face fontified t) 539 540 (fontified t) 540 547 (face font-lock-builtin-face fontified t) 547 552 (fontified t) 552 564 (face font-lock-builtin-face fontified t) 564 565 (fontified t) 565 577 (face font-lock-builtin-face fontified t) 577 582 (fontified t) 582 592 (face font-lock-builtin-face fontified t) 592 593 (fontified t) 593 604 (face font-lock-builtin-face fontified t) 604 609 (fontified t) 609 621 (face font-lock-builtin-face fontified t) 621 622 (fontified t) 622 636 (face font-lock-builtin-face fontified t) 636 640 (fontified t) 640 648 (face font-lock-builtin-face fontified t) 648 649 (fontified t) 649 667 (face font-lock-builtin-face fontified t) 667 668 (fontified t) 668 677 (face font-lock-builtin-face fontified t) 677 682 (fontified t) 682 694 (face font-lock-builtin-face fontified t) 694 695 (fontified t) 695 713 (face font-lock-builtin-face fontified t) 713 714 (fontified t) 714 732 (face font-lock-builtin-face fontified t) 732 733 (fontified t) 733 752 (face font-lock-builtin-face fontified t) 752 756 (fontified t) 756 774 (face font-lock-builtin-face fontified t) 774 779 (fontified t) 779 786 (face font-lock-builtin-face fontified t) 786 791 (fontified t) 791 794 (face font-lock-comment-delimiter-face fontified t) 794 863 (face font-lock-comment-face fontified t) 863 867 (fontified t) 867 878 (face font-lock-builtin-face fontified t) 878 879 (fontified t) 879 889 (face font-lock-builtin-face fontified t) 889 890 (fontified t) 890 902 (face font-lock-builtin-face fontified t) 902 903 (fontified t) 903 914 (face font-lock-builtin-face fontified t) 914 915 (fontified t) 915 927 (face font-lock-builtin-face fontified t) 927 932 (fontified t) 932 935 (face font-lock-comment-delimiter-face fontified t) 935 964 (face font-lock-comment-face fontified t) 964 968 (fontified t) 968 983 (face font-lock-builtin-face fontified t) 983 984 (fontified t) 984 999 (face font-lock-builtin-face fontified t) 999 1000 (fontified t) 1000 1014 (face font-lock-builtin-face fontified t) 1014 1015 (fontified t) 1015 1027 (face font-lock-builtin-face fontified t) 1027 1028 (fontified t) 1028 1041 (face font-lock-builtin-face fontified t) 1041 1042 (fontified t) 1042 1053 (face font-lock-builtin-face fontified t) 1053 1058 (fontified t) 1058 1061 (face font-lock-comment-delimiter-face fontified t) 1061 1073 (face font-lock-comment-face fontified t) 1073 1082 (fontified t) 1082 1092 (face font-lock-keyword-face fontified t) 1092 1093 (fontified t) 1093 1114 (face font-lock-builtin-face fontified t) 1114 1118 (fontified t) 1118 1123 (face font-lock-keyword-face fontified t) 1123 1124 (fontified t) 1124 1138 (face font-lock-function-name-face fontified t) 1138 1145 (fontified t) 1145 1286 (face font-lock-doc-face fontified t) 1286 1290 (fontified t) 1290 1293 (face font-lock-keyword-face fontified t) 1293 1299 (fontified t) 1299 1308 (face font-lock-keyword-face fontified t) 1308 1422 (fontified t) 1422 1426 (face font-lock-comment-delimiter-face fontified t) 1426 1500 (face font-lock-comment-face fontified t) 1500 1502 (face font-lock-comment-face fontified t) 1502 1506 (face font-lock-comment-delimiter-face fontified t) 1506 1538 (face font-lock-comment-face fontified t) 1538 1542 (face font-lock-comment-delimiter-face fontified t) 1542 1618 (face font-lock-comment-face fontified t) 1618 1619 (fontified t) 1619 1629 (face font-lock-keyword-face fontified t) 1629 1630 (fontified t) 1630 1640 (face font-lock-function-name-face fontified t) 1640 1654 (fontified t) 1654 1658 (face font-lock-type-face fontified t) 1658 1738 (fontified t) 1738 1748 (face font-lock-keyword-face fontified t) 1748 1749 (fontified t) 1749 1758 (face font-lock-function-name-face fontified t) 1758 1779 (fontified t) 1779 1789 (face font-lock-keyword-face fontified t) 1789 1790 (fontified t) 1790 1801 (face font-lock-function-name-face fontified t) 1801 1825 (fontified t) 1825 1835 (face font-lock-keyword-face fontified t) 1835 1836 (fontified t) 1836 1846 (face font-lock-function-name-face fontified t) 1846 1874 (fontified t) 1874 1884 (face font-lock-keyword-face fontified t) 1884 1885 (fontified t) 1885 1896 (face font-lock-function-name-face fontified t) 1896 1915 (fontified t) 1915 1919 (face font-lock-comment-delimiter-face fontified t) 1919 1965 (face font-lock-comment-face fontified t) 1965 1966 (fontified t) 1966 1976 (face font-lock-keyword-face fontified t) 1976 1977 (fontified t) 1977 1991 (face font-lock-function-name-face fontified t) 1991 2007 (fontified t) 2007 2011 (face font-lock-type-face fontified t) 2011 2026 (fontified t) 2026 2036 (face font-lock-keyword-face fontified t) 2036 2037 (fontified t) 2037 2051 (face font-lock-function-name-face fontified t) 2051 2078 (fontified t) 2078 2088 (face font-lock-keyword-face fontified t) 2088 2089 (fontified t) 2089 2102 (face font-lock-function-name-face fontified t) 2102 2129 (fontified t) 2129 2139 (face font-lock-keyword-face fontified t) 2139 2140 (fontified t) 2140 2151 (face font-lock-function-name-face fontified t) 2151 2169 (fontified t) 2169 2173 (face font-lock-type-face fontified t) 2173 2188 (fontified t) 2188 2198 (face font-lock-keyword-face fontified t) 2198 2199 (fontified t) 2199 2211 (face font-lock-function-name-face fontified t) 2211 2228 (fontified t) 2228 2232 (face font-lock-type-face fontified t) 2232 2247 (fontified t) 2247 2257 (face font-lock-keyword-face fontified t) 2257 2258 (fontified t) 2258 2268 (face font-lock-function-name-face fontified t) 2268 2294 (fontified t) 2294 2298 (face font-lock-type-face fontified t) 2298 2313 (fontified t) 2313 2317 (face font-lock-comment-delimiter-face fontified t) 2317 2393 (face font-lock-comment-face fontified t) 2393 2397 (face font-lock-comment-delimiter-face fontified t) 2397 2465 (face font-lock-comment-face fontified t) 2465 2469 (face font-lock-comment-delimiter-face fontified t) 2469 2545 (face font-lock-comment-face fontified t) 2545 2546 (fontified t) 2546 2555 (face font-lock-keyword-face fontified t) 2555 2556 (fontified t) 2556 2570 (face font-lock-function-name-face fontified t) 2570 2595 (fontified t) 2595 2599 (face font-lock-type-face fontified t) 2599 2615 (fontified t) 2615 2622 (face font-lock-keyword-face fontified t) 2622 2646 (fontified t) 2646 2649 (face font-lock-comment-delimiter-face fontified t) 2649 2719 (face font-lock-comment-face fontified t) 2719 2722 (fontified t) 2722 2726 (face font-lock-keyword-face fontified t) 2726 2804 (fontified t) 2804 2810 (face font-lock-builtin-face fontified t) 2810 2866 (fontified t) 2866 2873 (face font-lock-builtin-face fontified t) 2873 2874 (fontified t) 2874 2880 (face font-lock-builtin-face fontified t) 2880 2881 (fontified t) 2881 2888 (face font-lock-builtin-face fontified t) 2888 2898 (fontified t) 2898 2900 (face font-lock-keyword-face fontified t) 2900 2936 (fontified t) 2936 2946 (face font-lock-string-face fontified t) 2946 2964 (fontified t) 2964 2971 (face font-lock-builtin-face fontified t) 2971 2973 (fontified t) 2973 2978 (face font-lock-builtin-face fontified t) 2978 3002 (fontified t) 3002 3003 (fontified t) 3003 3005 (fontified t) 3005 3014 (face font-lock-keyword-face fontified t) 3014 3015 (fontified t) 3015 3029 (face font-lock-function-name-face fontified t) 3029 3066 (fontified t) 3066 3073 (face font-lock-keyword-face fontified t) 3073 3110 (fontified t) 3110 3114 (face font-lock-comment-delimiter-face fontified t) 3114 3190 (face font-lock-comment-face fontified t) 3190 3194 (face font-lock-comment-delimiter-face fontified t) 3194 3230 (face font-lock-comment-face fontified t) 3230 3234 (face font-lock-comment-delimiter-face fontified t) 3234 3301 (face font-lock-comment-face fontified t) 3301 3307 (face font-lock-comment-delimiter-face fontified t) 3307 3363 (face font-lock-comment-face fontified t) 3363 3367 (face font-lock-comment-delimiter-face fontified t) 3367 3437 (face font-lock-comment-face fontified t) 3437 3441 (face font-lock-comment-delimiter-face fontified t) 3441 3517 (face font-lock-comment-face fontified t) 3517 3518 (fontified t) 3518 3527 (face font-lock-keyword-face fontified t) 3527 3528 (fontified t) 3528 3542 (face font-lock-function-name-face fontified t) 3542 3543 (fontified t) 3543 3550 (face font-lock-builtin-face fontified t) 3550 3561 (fontified t) 3561 3568 (face font-lock-builtin-face fontified t) 3568 3602 (fontified t) 3602 3758 (face font-lock-string-face fontified t) 3758 3762 (fontified t) 3762 3766 (face font-lock-keyword-face fontified t) 3766 3808 (fontified t) 3808 3836 (face font-lock-comment-face fontified t) 3836 3885 (fontified t) 3885 3917 (face font-lock-comment-face fontified t) 3917 3969 (fontified t) 3969 4001 (face font-lock-comment-face fontified t) 4001 4053 (fontified t) 4053 4091 (face font-lock-comment-face fontified t) 4091 4101 (fontified t) 4101 4107 (face font-lock-keyword-face fontified t) 4107 4119 (fontified t) 4119 4124 (face font-lock-warning-face fontified t) 4124 4166 (fontified t) 4166 4174 (face font-lock-builtin-face fontified t) 4174 4175 (fontified t) 4175 4205 (face font-lock-string-face fontified t) 4205 4212 (fontified t) 4212 4215 (face font-lock-comment-delimiter-face fontified t) 4215 4280 (face font-lock-comment-face fontified t) 4280 4310 (fontified t) 4310 4320 (face font-lock-builtin-face fontified t) 4320 4325 (fontified t) 4325 4330 (face font-lock-builtin-face fontified t) 4330 4340 (fontified t) 4340 4341 (fontified t) 4341 4350 (face font-lock-keyword-face fontified t) 4350 4351 (fontified t) 4351 4365 (face font-lock-function-name-face fontified t) 4365 4366 (fontified t) 4366 4373 (face font-lock-builtin-face fontified t) 4373 4384 (fontified t) 4384 4390 (face font-lock-builtin-face fontified t) 4390 4424 (fontified t) 4424 4503 (face font-lock-string-face fontified t) 4503 4556 (face font-lock-string-face fontified t) 4556 4557 (fontified t) 4557 4560 (fontified t) 4560 4564 (face font-lock-keyword-face fontified t) 4564 4750 (fontified t) 4750 4756 (face font-lock-keyword-face fontified t) 4756 4768 (fontified t) 4768 4773 (face font-lock-warning-face fontified t) 4773 4815 (fontified t) 4815 4823 (face font-lock-builtin-face fontified t) 4823 4824 (fontified t) 4824 4854 (face font-lock-string-face fontified t) 4854 4861 (fontified t) 4861 4864 (face font-lock-comment-delimiter-face fontified t) 4864 4917 (face font-lock-comment-face fontified t) 4917 4921 (fontified t) 4921 4923 (face font-lock-comment-delimiter-face fontified t) 4923 4944 (face font-lock-comment-face fontified t) 4944 4948 (fontified t) 4948 4950 (face font-lock-comment-delimiter-face fontified t) 4950 4976 (face font-lock-comment-face fontified t) 4976 5006 (fontified t) 5006 5016 (face font-lock-builtin-face fontified t) 5016 5021 (fontified t) 5021 5026 (face font-lock-builtin-face fontified t) 5026 5042 (fontified t) 5042 5051 (face font-lock-keyword-face fontified t) 5051 5052 (fontified t) 5052 5065 (face font-lock-function-name-face fontified t) 5065 5102 (fontified t) 5102 5109 (face font-lock-keyword-face fontified t) 5109 5125 (fontified t) 5125 5128 (face font-lock-comment-delimiter-face fontified t) 5128 5174 (face font-lock-comment-face fontified t) 5174 5177 (fontified t) 5177 5190 (face font-lock-keyword-face fontified t) 5190 5195 (fontified t) 5195 5199 (face font-lock-keyword-face fontified t) 5199 5281 (fontified t) 5281 5290 (face font-lock-keyword-face fontified t) 5290 5291 (fontified t) 5291 5302 (face font-lock-function-name-face fontified t) 5302 5327 (fontified t) 5327 5331 (face font-lock-type-face fontified t) 5331 5347 (fontified t) 5347 5354 (face font-lock-keyword-face fontified t) 5354 5392 (fontified t) 5392 5395 (face font-lock-comment-delimiter-face fontified t) 5395 5412 (face font-lock-comment-face fontified t) 5412 5425 (fontified t) 5425 5426 (fontified t) 5426 5435 (face font-lock-keyword-face fontified t) 5435 5436 (fontified t) 5436 5446 (face font-lock-function-name-face fontified t) 5446 5478 (fontified t) 5478 5482 (face font-lock-type-face fontified t) 5482 5498 (fontified t) 5498 5505 (face font-lock-keyword-face fontified t) 5505 5530 (fontified t) 5530 5534 (face font-lock-keyword-face fontified t) 5534 5553 (fontified t) 5553 5557 (face font-lock-builtin-face fontified t) 5557 5569 (fontified t) 5569 5572 (face font-lock-comment-delimiter-face fontified t) 5572 5627 (face font-lock-comment-face fontified t) 5627 5657 (fontified t) 5657 5666 (face font-lock-builtin-face fontified t) 5666 5765 (fontified t) 5765 5775 (face font-lock-builtin-face fontified t) 5775 5805 (fontified t) 5805 5812 (face font-lock-builtin-face fontified t) 5812 5820 (fontified t) 5820 5823 (face font-lock-comment-delimiter-face fontified t) 5823 5829 (face font-lock-comment-face fontified t) 5829 5843 (fontified t) 5843 5893 (face font-lock-string-face fontified t) 5893 6010 (fontified t) 6010 6013 (face font-lock-comment-delimiter-face fontified t) 6013 6029 (face font-lock-comment-face fontified t) 6029 6034 (fontified t) 6034 6038 (face font-lock-keyword-face fontified t) 6038 6053 (fontified t) 6053 6057 (face font-lock-keyword-face fontified t) 6057 6066 (face font-lock-keyword-face fontified t) 6066 6067 (fontified t) 6067 6149 (fontified t) 6149 6255 (face font-lock-string-face fontified t) 6255 6453 (fontified t) 6453 6457 (face font-lock-comment-delimiter-face fontified t) 6457 6533 (face font-lock-comment-face fontified t) 6533 6537 (face font-lock-comment-delimiter-face fontified t) 6537 6611 (face font-lock-comment-face fontified t) 6611 6615 (face font-lock-comment-delimiter-face fontified t) 6615 6691 (face font-lock-comment-face fontified t) 6691 6692 (fontified t) 6692 6695 (face font-lock-comment-delimiter-face fontified t) 6695 6709 (face font-lock-comment-face fontified t) 6709 6710 (fontified t) 6710 6715 (face font-lock-keyword-face fontified t) 6715 6716 (fontified t) 6716 6736 (face font-lock-function-name-face fontified t) 6736 6759 (fontified t) 6759 6762 (face font-lock-keyword-face fontified t) 6762 6816 (fontified t) 6816 6822 (face font-lock-keyword-face fontified t) 6822 6991 (fontified t) 6991 6995 (face font-lock-comment-delimiter-face fontified t) 6995 7025 (face font-lock-comment-face fontified t) 7025 7026 (fontified t) 7026 7031 (face font-lock-keyword-face fontified t) 7031 7032 (fontified t) 7032 7039 (face font-lock-function-name-face fontified t) 7039 7047 (fontified t) 7047 7051 (face font-lock-keyword-face fontified t) 7051 7150 (fontified t) 7150 7158 (face font-lock-builtin-face fontified t) 7158 7205 (fontified t) 7205 7213 (face font-lock-builtin-face fontified t) 7213 7232 (fontified t) 7232 7237 (face font-lock-keyword-face fontified t) 7237 7238 (fontified t) 7238 7259 (face font-lock-function-name-face fontified t) 7259 7271 (fontified t) 7271 7365 (face font-lock-doc-face fontified t) 7365 7369 (fontified t) 7369 7373 (face font-lock-keyword-face fontified t) 7373 7427 (fontified t) 7427 7438 (face font-lock-builtin-face fontified t) 7438 7447 (fontified t) 7447 7451 (face font-lock-keyword-face fontified t) 7451 7497 (fontified t) 7497 7505 (face font-lock-builtin-face fontified t) 7505 7550 (fontified t) 7550 7558 (face font-lock-builtin-face fontified t) 7558 7567 (fontified t) 7567 7568 (fontified t) 7568 7573 (face font-lock-keyword-face fontified t) 7573 7574 (fontified t) 7574 7591 (face font-lock-function-name-face fontified t) 7591 7603 (fontified t) 7603 7637 (face font-lock-doc-face fontified t) 7637 7649 (fontified t) 7649 7655 (face font-lock-keyword-face fontified t) 7655 7668 (fontified t) 7668 7672 (face font-lock-builtin-face fontified t) 7672 7702 (fontified t) 7702 7707 (face font-lock-keyword-face fontified t) 7707 7708 (fontified t) 7708 7726 (face font-lock-function-name-face fontified t) 7726 7735 (fontified t) 7735 7744 (face font-lock-type-face fontified t) 7744 7751 (fontified t) 7751 7847 (face font-lock-doc-face fontified t) 7847 7851 (fontified t) 7851 7855 (face font-lock-keyword-face fontified t) 7855 7925 (fontified t) 7925 7932 (face font-lock-builtin-face fontified t) 7932 7961 (fontified t) 7961 7975 (face font-lock-builtin-face fontified t) 7975 7984 (fontified t) 7984 7990 (face font-lock-keyword-face fontified t) 7990 8038 (fontified t) 8038 8044 (face font-lock-keyword-face fontified t) 8044 8061 (fontified t) 8061 8065 (face font-lock-builtin-face fontified t) 8065 8090 (fontified t) 8090 8094 (face font-lock-keyword-face fontified t) 8094 8147 (fontified t) 8147 8192 (face font-lock-comment-face fontified t) 8192 8212 (fontified t) 8212 8222 (face font-lock-builtin-face fontified t) 8222 8224 (fontified t) 8224 8234 (face font-lock-builtin-face fontified t) 8234 8244 (fontified t) 8244 8287 (face font-lock-comment-face fontified t) 8287 8341 (fontified t) 8341 8371 (face font-lock-comment-face fontified t) 8371 8373 (fontified t) 8373 8378 (face font-lock-keyword-face fontified t) 8378 8379 (fontified t) 8379 8403 (face font-lock-function-name-face fontified t) 8403 8425 (fontified t) 8425 8503 (face font-lock-doc-face fontified t) 8503 8507 (fontified t) 8507 8510 (face font-lock-keyword-face fontified t) 8510 8554 (fontified t) 8554 8556 (face font-lock-keyword-face fontified t) 8556 8677 (fontified t) 8677 8678 (fontified t) 8678 8683 (face font-lock-keyword-face fontified t) 8683 8684 (fontified t) 8684 8709 (face font-lock-function-name-face fontified t) 8709 8730 (fontified t) 8730 8734 (face font-lock-type-face fontified t) 8734 8739 (fontified t) 8739 8746 (face font-lock-builtin-face fontified t) 8746 8771 (fontified t) 8771 8889 (face font-lock-doc-face fontified t) 8889 8893 (fontified t) 8893 8897 (face font-lock-keyword-face fontified t) 8897 9003 (fontified t) 9003 9013 (face font-lock-builtin-face fontified t) 9013 9022 (fontified t) 9022 9026 (face font-lock-keyword-face fontified t) 9026 9033 (fontified t) 9033 9036 (face font-lock-comment-delimiter-face fontified t) 9036 9067 (face font-lock-comment-face fontified t) 9067 9094 (face font-lock-comment-face fontified t) 9094 9129 (fontified t) 9129 9132 (face font-lock-comment-delimiter-face fontified t) 9132 9206 (face font-lock-comment-face fontified t) 9206 9220 (fontified t) 9220 9227 (face font-lock-builtin-face fontified t) 9227 9237 (fontified t) 9237 9241 (face font-lock-keyword-face fontified t) 9241 9272 (fontified t) 9272 9310 (face font-lock-comment-face fontified t) 9310 9319 (fontified t) 9319 9322 (face font-lock-comment-delimiter-face fontified t) 9322 9351 (face font-lock-comment-face fontified t) 9351 9393 (fontified t) 9393 9396 (face font-lock-keyword-face fontified t) 9396 9443 (fontified t) 9443 9447 (face font-lock-keyword-face fontified t) 9447 9603 (fontified t) 9603 9608 (face font-lock-warning-face fontified t) 9608 9609 (fontified t) 9609 9657 (face font-lock-string-face fontified t) 9657 9697 (fontified t) 9697 9700 (face font-lock-comment-delimiter-face fontified t) 9700 9738 (face font-lock-comment-face fontified t) 9738 9800 (fontified t) 9800 9805 (face font-lock-builtin-face fontified t) 9805 9828 (fontified t) 9828 9831 (face font-lock-keyword-face fontified t) 9831 9893 (fontified t) 9893 9898 (face font-lock-builtin-face fontified t) 9898 9926 (fontified t) 9926 9930 (face font-lock-keyword-face fontified t) 9930 10086 (fontified t) 10086 10091 (face font-lock-warning-face fontified t) 10091 10092 (fontified t) 10092 10140 (face font-lock-string-face fontified t) 10140 10161 (fontified t) 10161 10164 (face font-lock-comment-delimiter-face fontified t) 10164 10188 (face font-lock-comment-face fontified t) 10188 10319 (fontified t) 10319 10323 (face font-lock-builtin-face fontified t) 10323 10330 (fontified t) 10330 10335 (face font-lock-builtin-face fontified t) 10335 10359 (fontified t) 10359 10362 (face font-lock-comment-delimiter-face fontified t) 10362 10382 (face font-lock-comment-face fontified t) 10382 10429 (fontified t) 10429 10432 (face font-lock-comment-delimiter-face fontified t) 10432 10488 (face font-lock-comment-face fontified t) 10488 10502 (fontified t) 10502 10508 (face font-lock-builtin-face fontified t) 10508 10518 (fontified t) 10518 10522 (face font-lock-keyword-face fontified t) 10522 10594 (fontified t) 10594 10616 (fontified t) 10616 10663 (fontified t) 10663 10668 (face font-lock-builtin-face fontified t) 10668 10692 (fontified t) 10692 10696 (face font-lock-keyword-face fontified t) 10696 10753 (fontified t) 10753 10757 (face font-lock-keyword-face fontified t) 10757 10844 (fontified t) 10844 10848 (face font-lock-keyword-face fontified t) 10848 11019 (fontified t) 11019 11024 (face font-lock-warning-face fontified t) 11024 11025 (fontified t) 11025 11067 (face font-lock-string-face fontified t) 11067 11081 (fontified t) 11081 11084 (face font-lock-comment-delimiter-face fontified t) 11084 11162 (face font-lock-comment-face fontified t) 11162 11202 (fontified t) 11202 11204 (face font-lock-keyword-face fontified t) 11204 11259 (fontified t) 11259 11263 (face font-lock-builtin-face fontified t) 11263 11270 (fontified t) 11270 11275 (face font-lock-builtin-face fontified t) 11275 11334 (fontified t) 11334 11338 (face font-lock-builtin-face fontified t) 11338 11345 (fontified t) 11345 11350 (face font-lock-builtin-face fontified t) 11350 11382 (fontified t) 11382 11383 (fontified t) 11383 11388 (face font-lock-keyword-face fontified t) 11388 11389 (fontified t) 11389 11408 (face font-lock-function-name-face fontified t) 11408 11417 (fontified t) 11417 11421 (face font-lock-type-face fontified t) 11421 11467 (fontified t) 11467 11620 (face font-lock-doc-face fontified t) 11620 11624 (fontified t) 11624 11628 (face font-lock-keyword-face fontified t) 11628 11696 (fontified t) 11696 11703 (face font-lock-builtin-face fontified t) 11703 11769 (fontified t) 11769 11781 (face font-lock-builtin-face fontified t) 11781 11783 (fontified t) 11783 11786 (face font-lock-builtin-face fontified t) 11786 11900 (fontified t) 11900 11903 (face font-lock-comment-delimiter-face fontified t) 11903 11960 (face font-lock-comment-face fontified t) 11960 11989 (fontified t) 11989 12002 (face font-lock-builtin-face fontified t) 12002 12111 (fontified t) 12111 12116 (face font-lock-keyword-face fontified t) 12116 12117 (face font-lock-keyword-face fontified t) 12117 12134 (fontified t) 12134 12138 (face font-lock-builtin-face fontified t) 12138 12160 (fontified t) 12160 12349 (fontified t) 12349 12396 (face font-lock-comment-face fontified t) 12396 12452 (fontified t) 12452 12457 (face font-lock-builtin-face fontified t) 12457 12467 (fontified t) 12467 12468 (fontified t) 12468 12477 (face font-lock-keyword-face fontified t) 12477 12478 (fontified t) 12478 12488 (face font-lock-function-name-face fontified t) 12488 12533 (fontified t) 12533 12537 (face font-lock-type-face fontified t) 12537 12636 (fontified t) 12636 12640 (face font-lock-keyword-face fontified t) 12640 12704 (fontified t) 12704 12710 (face font-lock-builtin-face fontified t) 12710 12759 (fontified t) 12759 12771 (face font-lock-builtin-face fontified t) 12771 12774 (fontified t) 12774 12790 (face font-lock-builtin-face fontified t) 12790 12823 (fontified t) 12823 12833 (face font-lock-builtin-face fontified t) 12833 12995 (fontified t) 12995 12999 (face font-lock-keyword-face fontified t) 12999 13093 (fontified t) 13093 13101 (face font-lock-builtin-face fontified t) 13101 13141 (fontified t) 13141 13147 (face font-lock-builtin-face fontified t) 13147 13186 (fontified t) 13186 13190 (face font-lock-builtin-face fontified t) 13190 13229 (fontified t) 13229 13235 (face font-lock-builtin-face fontified t) 13235 13274 (fontified t) 13274 13280 (face font-lock-builtin-face fontified t) 13280 13327 (fontified t) 13327 13343 (face font-lock-builtin-face fontified t) 13343 13407 (fontified t) 13407 13415 (face font-lock-builtin-face fontified t) 13415 13443 (fontified t) 13443 13449 (face font-lock-builtin-face fontified t) 13449 13476 (fontified t) 13476 13483 (face font-lock-builtin-face fontified t) 13483 13496 (fontified t) 13496 13498 (face font-lock-builtin-face fontified t) 13498 13518 (fontified t) 13518 13524 (face font-lock-builtin-face fontified t) 13524 13591 (fontified t) 13591 13598 (face font-lock-builtin-face fontified t) 13598 13660 (fontified t) 13660 13665 (fontified t) 13665 13683 (fontified t) 13683 13699 (face font-lock-builtin-face fontified t) 13699 13715 (fontified t) 13715 13718 (face font-lock-comment-delimiter-face fontified t) 13718 13767 (face font-lock-comment-face fontified t) 13767 13768 (fontified t) 13768 13777 (face font-lock-keyword-face fontified t) 13777 13778 (fontified t) 13778 13787 (face font-lock-function-name-face fontified t) 13787 13816 (fontified t) 13816 13820 (face font-lock-keyword-face fontified t) 13820 13878 (fontified t) 13878 13884 (face font-lock-builtin-face fontified t) 13884 13915 (fontified t) 13915 13927 (face font-lock-builtin-face fontified t) 13927 13929 (fontified t) 13929 13932 (face font-lock-builtin-face fontified t) 13932 13992 (fontified t) 13992 14002 (face font-lock-builtin-face fontified t) 14002 14071 (fontified t) 14071 14073 (face font-lock-keyword-face fontified t) 14073 14221 (fontified t) 14221 14224 (face font-lock-keyword-face fontified t) 14224 14245 (fontified t) 14245 14253 (face font-lock-builtin-face fontified t) 14253 14262 (fontified t) 14262 14268 (face font-lock-builtin-face fontified t) 14268 14311 (fontified t) 14311 14314 (face font-lock-comment-delimiter-face fontified t) 14314 14321 (face font-lock-comment-face fontified t) 14321 14322 (fontified t) 14322 14331 (face font-lock-keyword-face fontified t) 14331 14332 (fontified t) 14332 14343 (face font-lock-function-name-face fontified t) 14343 14383 (fontified t) 14383 14399 (face font-lock-string-face fontified t) 14399 14417 (fontified t) 14417 14424 (face font-lock-builtin-face fontified t) 14424 14436 (fontified t) 14436 14444 (face font-lock-builtin-face fontified t) 14444 14457 (fontified t) 14457 14466 (face font-lock-keyword-face fontified t) 14466 14467 (fontified t) 14467 14479 (face font-lock-function-name-face fontified t) 14479 14490 (fontified t) 14490 14497 (face font-lock-builtin-face fontified t) 14497 14520 (fontified t) 14520 14524 (face font-lock-type-face fontified t) 14524 14540 (fontified t) 14540 14547 (face font-lock-keyword-face fontified t) 14547 14570 (fontified t) 14570 14587 (face font-lock-string-face fontified t) 14587 14592 (fontified t) 14592 14596 (face font-lock-keyword-face fontified t) 14596 14654 (fontified t) 14654 14657 (face font-lock-builtin-face fontified t) 14657 14658 (fontified t) 14658 14665 (face font-lock-builtin-face fontified t) 14665 14790 (fontified t) 14790 14809 (face font-lock-keyword-face fontified t) 14809 14840 (fontified t) 14840 14850 (face font-lock-builtin-face fontified t) 14850 14863 (fontified t) 14863 14870 (face font-lock-keyword-face fontified t) 14870 14922 (fontified t) 14922 14925 (face font-lock-comment-delimiter-face fontified t) 14925 14948 (face font-lock-comment-face fontified t) 14948 14949 (fontified t) 14949 14958 (face font-lock-keyword-face fontified t) 14958 14959 (fontified t) 14959 14969 (face font-lock-function-name-face fontified t) 14969 15019 (fontified t) 15019 15025 (face font-lock-builtin-face fontified t) 15025 15037 (fontified t) 15037 15040 (face font-lock-builtin-face fontified t) 15040 15044 (fontified t) 15044 15052 (face font-lock-builtin-face fontified t) 15052 15064 (fontified t) 15064 15065 (fontified t) 15065 15074 (face font-lock-keyword-face fontified t) 15074 15075 (fontified t) 15075 15087 (face font-lock-function-name-face fontified t) 15087 15098 (fontified t) 15098 15104 (face font-lock-builtin-face fontified t) 15104 15127 (fontified t) 15127 15131 (face font-lock-type-face fontified t) 15131 15147 (fontified t) 15147 15151 (face font-lock-keyword-face fontified t) 15151 15165 (fontified t) 15165 15186 (fontified t) 15186 15191 (fontified t) 15191 15197 (face font-lock-keyword-face fontified t) 15197 15203 (fontified t) 15203 15208 (face font-lock-warning-face fontified t) 15208 15209 (fontified t) 15209 15220 (face font-lock-string-face fontified t) 15220 15228 (fontified t) 15228 15232 (face font-lock-keyword-face fontified t) 15232 15290 (fontified t) 15290 15293 (face font-lock-builtin-face fontified t) 15293 15294 (fontified t) 15294 15300 (face font-lock-builtin-face fontified t) 15300 15367 (fontified t) 15367 15404 (face font-lock-string-face fontified t) 15404 15421 (fontified t) 15421 15424 (face font-lock-comment-delimiter-face fontified t) 15424 15461 (face font-lock-comment-face fontified t) 15461 15468 (fontified t) 15468 15474 (face font-lock-keyword-face fontified t) 15474 15498 (fontified t) 15498 15502 (face font-lock-keyword-face fontified t) 15502 15633 (fontified t) 15633 15637 (face font-lock-keyword-face fontified t) 15637 15724 (fontified t) 15724 15768 (face font-lock-string-face fontified t) 15768 15818 (fontified t) 15818 15837 (face font-lock-keyword-face fontified t) 15837 15868 (fontified t) 15868 15874 (face font-lock-builtin-face fontified t) 15874 15877 (fontified t) 15877 15887 (face font-lock-builtin-face fontified t) 15887 15902 (fontified t) 15902 15909 (face font-lock-keyword-face fontified t) 15909 15936 (fontified t) 15936 15976 (face font-lock-string-face fontified t) 15976 16019 (fontified t) 16019 16022 (face font-lock-comment-delimiter-face fontified t) 16022 16029 (face font-lock-comment-face fontified t) 16029 16030 (fontified t) 16030 16039 (face font-lock-keyword-face fontified t) 16039 16040 (fontified t) 16040 16051 (face font-lock-function-name-face fontified t) 16051 16093 (fontified t) 16093 16100 (face font-lock-builtin-face fontified t) 16100 16112 (fontified t) 16112 16115 (face font-lock-builtin-face fontified t) 16115 16124 (fontified t) 16124 16133 (face font-lock-keyword-face fontified t) 16133 16134 (fontified t) 16134 16146 (face font-lock-function-name-face fontified t) 16146 16157 (fontified t) 16157 16164 (face font-lock-builtin-face fontified t) 16164 16187 (fontified t) 16187 16191 (face font-lock-type-face fontified t) 16191 16207 (fontified t) 16207 16214 (face font-lock-keyword-face fontified t) 16214 16236 (fontified t) 16236 16257 (face font-lock-keyword-face fontified t) 16257 16266 (fontified t) 16266 16269 (face font-lock-keyword-face fontified t) 16269 16311 (fontified t) 16311 16317 (face font-lock-keyword-face fontified t) 16317 16323 (fontified t) 16323 16328 (face font-lock-warning-face fontified t) 16328 16329 (fontified t) 16329 16340 (face font-lock-string-face fontified t) 16340 16400 (fontified t) 16400 16408 (face font-lock-builtin-face fontified t) 16408 16415 (fontified t) 16415 16418 (face font-lock-builtin-face fontified t) 16418 16431 (fontified t) 16431 16435 (face font-lock-comment-delimiter-face fontified t) 16435 16511 (face font-lock-comment-face fontified t) 16511 16515 (face font-lock-comment-delimiter-face fontified t) 16515 16559 (face font-lock-comment-face fontified t) 16559 16563 (face font-lock-comment-delimiter-face fontified t) 16563 16639 (face font-lock-comment-face fontified t) 16639 16640 (fontified t) 16640 16648 (face font-lock-keyword-face fontified t) 16648 16649 (fontified t) 16649 16662 (face font-lock-function-name-face fontified t) 16662 16664 (fontified t) 16664 16669 (face font-lock-type-face fontified t) 16669 16678 (fontified t) 16678 16681 (face font-lock-comment-delimiter-face fontified t) 16681 16686 (face font-lock-comment-face fontified t) 16686 16735 (face font-lock-comment-face fontified t) 16735 16739 (fontified t) 16739 16744 (face font-lock-keyword-face fontified t) 16744 16756 (fontified t) 16756 16764 (face font-lock-keyword-face fontified t) 16764 16765 (fontified t) 16765 16779 (face font-lock-function-name-face fontified t) 16779 16781 (fontified t) 16781 16786 (face font-lock-type-face fontified t) 16786 16797 (fontified t) 16797 16804 (face font-lock-keyword-face fontified t) 16804 16818 (fontified t) 16818 16821 (face font-lock-comment-delimiter-face fontified t) 16821 16828 (face font-lock-comment-face fontified t) 16828 16829 (fontified t) 16829 16838 (face font-lock-keyword-face fontified t) 16838 16839 (fontified t) 16839 16850 (face font-lock-function-name-face fontified t) 16850 16851 (fontified t) 16851 16858 (face font-lock-builtin-face fontified t) 16858 16903 (fontified t) 16903 16906 (face font-lock-keyword-face fontified t) 16906 16912 (fontified t) 16912 16919 (face font-lock-builtin-face fontified t) 16919 16935 (fontified t) 16935 16958 (face font-lock-string-face fontified t) 16958 16996 (fontified t) 16996 17004 (face font-lock-builtin-face fontified t) 17004 17021 (fontified t) 17021 17024 (face font-lock-keyword-face fontified t) 17024 17161 (fontified t) 17161 17169 (face font-lock-builtin-face fontified t) 17169 17182 (fontified t) 17182 17191 (face font-lock-string-face fontified t) 17191 17202 (fontified t) 17202 17205 (face font-lock-keyword-face fontified t) 17205 17287 (fontified t) 17287 17295 (face font-lock-builtin-face fontified t) 17295 17306 (fontified t) 17306 17309 (face font-lock-comment-delimiter-face fontified t) 17309 17315 (face font-lock-comment-face fontified t) 17315 17316 (fontified t) 17316 17325 (face font-lock-keyword-face fontified t) 17325 17326 (fontified t) 17326 17336 (face font-lock-function-name-face fontified t) 17336 17337 (fontified t) 17337 17344 (face font-lock-builtin-face fontified t) 17344 17392 (fontified t) 17392 17395 (face font-lock-keyword-face fontified t) 17395 17401 (fontified t) 17401 17407 (face font-lock-builtin-face fontified t) 17407 17446 (fontified t) 17446 17449 (face font-lock-builtin-face fontified t) 17449 17453 (fontified t) 17453 17461 (face font-lock-builtin-face fontified t) 17461 17478 (fontified t) 17478 17481 (face font-lock-keyword-face fontified t) 17481 17606 (fontified t) 17606 17609 (face font-lock-builtin-face fontified t) 17609 17613 (fontified t) 17613 17621 (face font-lock-builtin-face fontified t) 17621 17635 (fontified t) 17635 17638 (face font-lock-keyword-face fontified t) 17638 17723 (fontified t) 17723 17726 (face font-lock-builtin-face fontified t) 17726 17730 (fontified t) 17730 17738 (face font-lock-builtin-face fontified t) 17738 17749 (fontified t) 17749 17752 (face font-lock-comment-delimiter-face fontified t) 17752 17759 (face font-lock-comment-face fontified t) 17759 17760 (fontified t) 17760 17769 (face font-lock-keyword-face fontified t) 17769 17770 (fontified t) 17770 17781 (face font-lock-function-name-face fontified t) 17781 17782 (fontified t) 17782 17789 (face font-lock-builtin-face fontified t) 17789 17829 (fontified t) 17829 17832 (face font-lock-keyword-face fontified t) 17832 17838 (fontified t) 17838 17845 (face font-lock-builtin-face fontified t) 17845 17884 (fontified t) 17884 17887 (face font-lock-builtin-face fontified t) 17887 17927 (fontified t) 17927 17930 (face font-lock-builtin-face fontified t) 17930 17942 (fontified t) 17942 17945 (face font-lock-keyword-face fontified t) 17945 18025 (fontified t) 18025 18028 (face font-lock-builtin-face fontified t) 18028 18038 (fontified t) 18038 18039 (fontified t) 18039 18044 (face font-lock-keyword-face fontified t) 18044 18045 (fontified t) 18045 18064 (face font-lock-function-name-face fontified t) 18064 18071 (fontified t) 18071 18199 (face font-lock-doc-face fontified t) 18199 18203 (fontified t) 18203 18207 (face font-lock-keyword-face fontified t) 18207 18231 (fontified t) 18231 18234 (face font-lock-comment-delimiter-face fontified t) 18234 18235 (face font-lock-comment-face fontified t) 18235 18278 (face font-lock-comment-face fontified t) 18278 18322 (fontified t) 18322 18326 (face font-lock-builtin-face fontified t) 18326 18344 (fontified t) 18344 18347 (face font-lock-comment-delimiter-face fontified t) 18347 18390 (face font-lock-comment-face fontified t) 18390 18436 (fontified t) 18436 18439 (face font-lock-comment-delimiter-face fontified t) 18439 18456 (face font-lock-comment-face fontified t) 18456 18477 (fontified t) 18477 18482 (face font-lock-keyword-face fontified t) 18482 18483 (fontified t) 18483 18504 (face font-lock-function-name-face fontified t) 18504 18514 (fontified t) 18514 18518 (face font-lock-keyword-face fontified t) 18518 18532 (fontified t) 18532 18542 (face font-lock-builtin-face fontified t) 18542 18552 (fontified t) 18552 18561 (face font-lock-keyword-face fontified t) 18561 18562 (fontified t) 18562 18572 (face font-lock-function-name-face fontified t) 18572 18573 (fontified t) 18573 18580 (face font-lock-builtin-face fontified t) 18580 18593 (fontified t) 18593 18598 (face font-lock-type-face fontified t) 18598 18608 (fontified t) 18608 18626 (face font-lock-keyword-face fontified t) 18626 18628 (fontified t) 18628 18632 (face font-lock-type-face fontified t) 18632 18641 (fontified t) 18641 18658 (face font-lock-type-face fontified t) 18658 18670 (fontified t) 18670 18674 (face font-lock-keyword-face fontified t) 18674 18698 (fontified t) 18698 18708 (face font-lock-builtin-face fontified t) 18708 18828 (fontified t) 18828 18831 (face font-lock-comment-delimiter-face fontified t) 18831 18876 (face font-lock-comment-face fontified t) 18876 18900 (fontified t) 18900 18902 (face font-lock-keyword-face fontified t) 18902 18964 (fontified t) 18964 18967 (face font-lock-comment-delimiter-face fontified t) 18967 18999 (face font-lock-comment-face fontified t) 18999 19103 (fontified t) 19103 19111 (face font-lock-builtin-face fontified t) 19111 19137 (fontified t) 19137 19140 (face font-lock-keyword-face fontified t) 19140 19146 (fontified t) 19146 19152 (face font-lock-builtin-face fontified t) 19152 19203 (fontified t) 19203 19206 (face font-lock-keyword-face fontified t) 19206 19329 (fontified t) 19329 19330 (fontified t) 19330 19339 (face font-lock-keyword-face fontified t) 19339 19340 (fontified t) 19340 19349 (face font-lock-function-name-face fontified t) 19349 19350 (fontified t) 19350 19357 (face font-lock-builtin-face fontified t) 19357 19377 (fontified t) 19377 19380 (face font-lock-keyword-face fontified t) 19380 19386 (fontified t) 19386 19391 (face font-lock-builtin-face fontified t) 19391 19428 (fontified t) 19428 19431 (face font-lock-builtin-face fontified t) 19431 19441 (fontified t) 19441 19445 (face font-lock-keyword-face fontified t) 19445 19477 (fontified t) 19477 19495 (face font-lock-comment-face fontified t) 19495 19521 (fontified t) 19521 19531 (face font-lock-builtin-face fontified t) 19531 19571 (fontified t) 19571 19581 (face font-lock-builtin-face fontified t) 19581 19607 (fontified t) 19607 19611 (face font-lock-keyword-face fontified t) 19611 19669 (fontified t) 19669 19683 (face font-lock-comment-face fontified t) 19683 19740 (fontified t) 19740 19773 (face font-lock-comment-face fontified t) 19773 19778 (fontified t) 19778 19830 (fontified t) 19830 19864 (face font-lock-comment-face fontified t) 19864 19921 (fontified t) 19921 19940 (face font-lock-comment-face fontified t) 19940 19996 (fontified t) 19996 20029 (face font-lock-comment-face fontified t) 20029 20036 (fontified t) 20036 20040 (face font-lock-keyword-face fontified t) 20040 20082 (fontified t) 20082 20086 (face font-lock-comment-delimiter-face fontified t) 20086 20147 (face font-lock-comment-face fontified t) 20147 20151 (face font-lock-comment-delimiter-face fontified t) 20151 20170 (face font-lock-comment-face fontified t) 20170 20174 (face font-lock-comment-delimiter-face fontified t) 20174 20235 (face font-lock-comment-face fontified t) 20235 20236 (fontified t) 20236 20241 (face font-lock-keyword-face fontified t) 20241 20242 (fontified t) 20242 20245 (face font-lock-function-name-face fontified t) 20245 20253 (fontified t) 20253 20262 (face font-lock-keyword-face fontified t) 20262 20334 (fontified t) 20334 20342 (face font-lock-builtin-face fontified t) 20342 20384 (fontified t) 20384 20392 (face font-lock-builtin-face fontified t) 20392 20399 (fontified t) 20399 20404 (face font-lock-keyword-face fontified t) 20404 20405 (fontified t) 20405 20428 (face font-lock-function-name-face fontified t) 20428 20441 (fontified t) 20441 20513 (face font-lock-doc-face fontified t) 20513 20517 (fontified t) 20517 20520 (face font-lock-keyword-face fontified t) 20520 20543 (fontified t) 20543 20548 (face font-lock-builtin-face fontified t) 20548 20564 (fontified t) 20564 20570 (face font-lock-keyword-face fontified t) 20570 20640 (fontified t) 20640 20643 (face font-lock-keyword-face fontified t) 20643 20666 (fontified t) 20666 20672 (face font-lock-keyword-face fontified t) 20672 20732 (fontified t) 20732 20737 (face font-lock-keyword-face fontified t) 20737 20738 (fontified t) 20738 20762 (face font-lock-function-name-face fontified t) 20762 20772 (fontified t) 20772 20776 (face font-lock-type-face fontified t) 20776 20793 (fontified t) 20793 20797 (face font-lock-keyword-face fontified t) 20797 20812 (fontified t) 20812 20815 (face font-lock-builtin-face fontified t) 20815 20816 (fontified t) 20816 20827 (face font-lock-builtin-face fontified t) 20827 20828 (fontified t) 20828 20839 (face font-lock-builtin-face fontified t) 20839 20840 (fontified t) 20840 20853 (face font-lock-builtin-face fontified t) 20853 20914 (fontified t) 20914 20920 (face font-lock-keyword-face fontified t) 20920 20978 (fontified t) 20978 20983 (face font-lock-keyword-face fontified t) 20983 20984 (fontified t) 20984 20997 (face font-lock-function-name-face fontified t) 20997 21043 (fontified t) 21043 21107 (face font-lock-string-face fontified t) 21107 21154 (fontified t) 21154 21158 (face font-lock-comment-delimiter-face fontified t) 21158 21219 (face font-lock-comment-face fontified t) 21219 21223 (face font-lock-comment-delimiter-face fontified t) 21223 21244 (face font-lock-comment-face fontified t) 21244 21250 (face font-lock-comment-delimiter-face fontified t) 21250 21294 (face font-lock-comment-face fontified t) 21294 21300 (face font-lock-comment-delimiter-face fontified t) 21300 21364 (face font-lock-comment-face fontified t) 21364 21371 (face font-lock-comment-face fontified t) 21371 21375 (face font-lock-comment-delimiter-face fontified t) 21375 21436 (face font-lock-comment-face fontified t) 21436 21437 (fontified t) 21437 21442 (face font-lock-keyword-face fontified t) 21442 21443 (fontified t) 21443 21461 (face font-lock-function-name-face fontified t) 21461 21479 (fontified t) 21479 21483 (face font-lock-keyword-face fontified t) 21483 21508 (fontified t) 21508 21518 (face font-lock-builtin-face fontified t) 21518 21530 (fontified t) 21530 21540 (face font-lock-builtin-face fontified t) 21540 21597 (fontified t) 21597 21607 (face font-lock-builtin-face fontified t) 21607 21648 (fontified t) 21648 21658 (face font-lock-builtin-face fontified t) 21658 21687 (fontified t) 21687 21691 (face font-lock-keyword-face fontified t) 21691 21862 (fontified t) 21862 21865 (face font-lock-comment-delimiter-face fontified t) 21865 21889 (face font-lock-comment-face fontified t) 21889 21903 (fontified t) 21903 21915 (face font-lock-keyword-face fontified t) 21915 22022 (fontified t) 22022 22028 (face font-lock-keyword-face fontified t) 22028 22038 (fontified t) 22038 22045 (face font-lock-keyword-face fontified t) 22045 22187 (fontified t)) . 1) (undo-tree-id0 . -2612) (undo-tree-id1 . -4340) (undo-tree-id2 . -4557) (undo-tree-id3 . -3642) (undo-tree-id4 . -4208) (undo-tree-id5 . -5425) (undo-tree-id6 . -6067) (undo-tree-id7 . -4802) (undo-tree-id8 . -5279) (undo-tree-id9 . -5829) (undo-tree-id10 . -6452) (undo-tree-id11 . -7044) (undo-tree-id12 . -8677) (undo-tree-id13 . -9094) (undo-tree-id14 . -7638) (undo-tree-id15 . -8504) (undo-tree-id16 . -8677) (undo-tree-id17 . -10616) (undo-tree-id18 . -9310) (undo-tree-id19 . -11382) (undo-tree-id20 . -12160) (undo-tree-id21 . -10488) (undo-tree-id22 . -11546) (undo-tree-id23 . -12467) (undo-tree-id24 . -13665) (undo-tree-id25 . -12633) (undo-tree-id26 . -13665) (undo-tree-id27 . -15064) (undo-tree-id28 . -15186) (undo-tree-id29 . -14589) (undo-tree-id30 . -16639) (undo-tree-id31 . -16735) (undo-tree-id32 . -15770) (undo-tree-id33 . -16793) (undo-tree-id34 . -18038) (undo-tree-id35 . -18278) (undo-tree-id36 . -17759) (undo-tree-id37 . -19329) (undo-tree-id38 . -19864) (undo-tree-id39 . -18876) (undo-tree-id40 . -20170) (undo-tree-id41 . -21371) (undo-tree-id42 . -21371) (undo-tree-id43 . -21371) (undo-tree-id44 . -22187) (undo-tree-id45 . -22187) (undo-tree-id46 . -22187) (undo-tree-id47 . -22187) (undo-tree-id48 . -22187) (undo-tree-id49 . -22187) (undo-tree-id50 . -22187) (undo-tree-id51 . -22187) (undo-tree-id52 . -22187) (undo-tree-id53 . -22104) (undo-tree-id54 . -22104) (undo-tree-id55 . -22104) (undo-tree-id56 . -22104) (undo-tree-id57 . -22104) (undo-tree-id58 . -22104) (undo-tree-id59 . -22104) (undo-tree-id60 . -22104) (undo-tree-id61 . -22104) (undo-tree-id62 . -22104) (undo-tree-id63 . -21916) (undo-tree-id64 . -21662) (undo-tree-id65 . -21244) (undo-tree-id66 . -20976) (undo-tree-id67 . -22187) (undo-tree-id68 . -20976) (undo-tree-id69 . -20976) (undo-tree-id70 . -22187) (t 26976 37468 0 0)) nil (26976 63442 53951 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10283 . 10284) (nil fontified nil 1 . 10284) (1 . 10284)) nil (26976 63442 53897 0) 0 nil])
([nil nil ((10284 . 10285)) nil (26976 63442 53893 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.repo.core
  (:use :cl)
  (:import-from :lumen.core.http
   :ctx-get :ctx-set! :current-jwt :current-role :current-user-id :respond-404
   :ctx-from-req)
  (:import-from :lumen.data.dao
    :entity-metadata :entity-fields :row->entity :entity->row-alist
    :entity-insert! :entity-update! :entity-delete! :validate-entity!
    :entity-slot-symbol)
  (:import-from :lumen.data.repo.query
    :select* :select-page-keyset* :select-page-keyset-prev* :count*)
  (:import-from :lumen.utils
    :alist-get :copy-plist :alist-set)
  (:import-from :lumen.data.db
   :with-tx :ensure-connection :query-1a :exec) ;; Ajout de exec
  (:import-from :lumen.data.tenant :tenant-code-by-id :tenant-id-for-host
   :tenant-id-by-code)
  (:export
    :repo-index :repo-show :repo-create :repo-patch :repo-delete
    :repo-authorize :repo-normalize :repo-validate :repo-before :repo-persist :repo-after))

(in-package :lumen.data.repo.core)

(defun %norm-col-name (x)
  (let ((s (etypecase x
             (symbol (symbol-name x))
             (string x))))
    (substitute #\\_ #\\- (string-upcase s))))

;;; ---------------------------------------------------------------------------
;;; API générique
;;; ---------------------------------------------------------------------------
(defgeneric repo-index  (entity ctx &key filters order select page page-size limit offset after before key))
(defgeneric repo-show   (entity ctx id))
(defgeneric repo-create (entity ctx payload))
(defgeneric repo-patch  (entity ctx id payload))
(defgeneric repo-delete (entity ctx id))

(defgeneric repo-authorize (op entity ctx &key id payload))
(defgeneric repo-normalize (op entity ctx payload))
(defgeneric repo-validate (op entity ctx payload))
(defgeneric repo-before    (op entity ctx &key id payload))
(defgeneric repo-persist   (op entity ctx &key id payload))
(defgeneric repo-after     (op entity ctx result &key id payload))

;;; ---------------------------------------------------------------------------
;;; Defaults
;;; ---------------------------------------------------------------------------
(defmethod repo-authorize (op (entity symbol) ctx &key id payload)
  (declare (ignore id payload))
  (let* ((md (entity-metadata entity))
         (table (string-downcase (or (getf md :table) (symbol-name entity))))
         (write? (member op '(:create :patch :delete))))
    (if write?
        (member (format nil \"~a:write\" table) (getf ctx :scopes) :test #'string=)
        t)))

(defmethod repo-normalize (op (entity symbol) ctx payload)
  (declare (ignore op entity ctx))
  payload)

(defmethod repo-validate (op (entity symbol) ctx payload)
  (declare (ignore op))
  (ignore-errors
   (let* ((ent (row->entity entity payload)))
      (validate-entity! ent)))
  payload)

(defmethod repo-before (op (entity symbol) ctx &key id payload)
  (declare (ignore op entity ctx id payload))
  (values))

(defmethod repo-after (op (entity symbol) ctx result &key id payload)
  (declare (ignore id payload))
  ;; Logique d'audit simplifiée
  (let* ((req   (getf ctx :req))
         (actor (or (getf ctx :actor-id)
                    (and req (lumen.core.http:current-user-id req))))
         (tenant (getf ctx :tenant-id))
         (audit? (getf ctx :audit?)))
    (when audit?
      (ignore-errors
        (lumen.data.db:ensure-connection
          (lumen.data.db:exec
           \"insert into audit_log(actor_id, tenant_id, action, resource, payload) values($1,$2,$3,$4,$5)\"
           actor tenant (string-downcase (symbol-name op)) (string-downcase (symbol-name entity))
           (cl-json:encode-json-to-string result))))))
  result)

;;; ---------------------------------------------------------------------------
;;; Invariants Framework (:around methods)
;;; ---------------------------------------------------------------------------

(defun %kw (x)
  (etypecase x
    (keyword x)
    (symbol  (intern (string-upcase (symbol-name x)) :keyword))
    (string  (intern (string-upcase x) :keyword))))

(defun %normalize-payload-keys (payload)
  (let ((ht (make-hash-table :test 'equal)))
    (dolist (kv payload)
      (setf (gethash (%kw (car kv)) ht) (cdr kv)))
    (let (out)
      (maphash (lambda (k v) (push (cons k v) out)) ht)
      (nreverse out))))

(defun %remove-protected-fields (payload &key (extra '()))
  (let* ((protected '(:id :created_at :updated_at :lock_version))
         (drop (append protected extra)))
    (remove-if (lambda (kv) (member (car kv) drop)) payload)))

(defun %resolve-tenant-id (ctx payload)
  (let* ((ctx-tid (or (getf ctx :tenant-id) (getf ctx :tenant_id)))
         (p-tid   (or (lumen.utils:alist-get payload :tenant_id)
                      (lumen.utils:alist-get payload :tenant-id))))
    (or ctx-tid p-tid))) ;; Version simplifiée, remettre la logique complexe si nécessaire

;; CREATE Invariants
(defmethod repo-normalize :around ((op (eql :create)) (entity symbol) ctx payload)
  (let* ((out (call-next-method))
         (p0 (%normalize-payload-keys out))
         (p1 (%remove-protected-fields p0))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid
      (error 'lumen.data.errors:db-error :message \"missing or invalid tenant-id\"))
    (lumen.utils:alist-set p1 :tenant_id tid :test #'eq)))

;; PATCH Invariants
(defmethod repo-normalize :around ((op (eql :patch)) (entity symbol) ctx payload)
  (let* ((out (call-next-method op entity ctx payload))
         (p0 (%normalize-payload-keys out))
         (p1 (%remove-protected-fields p0))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid
      (error 'lumen.data.errors:db-error :message \"missing or invalid tenant-id\"))
    (lumen.utils:alist-set p1 :tenant_id tid :test #'eq)))


;;; ---------------------------------------------------------------------------
;;; Implémentations CRUD
;;; ---------------------------------------------------------------------------

;; Helpers
(defun %kw-col (x) (and x (intern (string-upcase (string x)) :keyword)))

(defun entity-allowed-cols (entity &key include-pk? include-tenant? include-lock?)
   ;; Votre logique de colonnes (abrégée pour l'exemple)
   '(:*)) 

(defun %entity-tenant-col (entity &optional md)
  (declare (ignore md))
  :tenant_id) ;; Simplifié

(defun %maybe-add-tenant-filter (filters tcol tid)
  (let ((flt (if (listp (car filters)) filters (list filters))))
    (if (and tcol tid)
        (append flt (list (list '= tcol tid)))
        flt)))

;; INDEX
(defmethod repo-index ((entity symbol) ctx &key filters order select page page-size limit offset after before key)
  (let* ((md (entity-metadata entity))
         (table (getf md :table))
         (tid (getf ctx :tenant-id))
         (filters* (%maybe-add-tenant-filter filters :tenant_id tid)))
    (lumen.data.db:ensure-connection
      (select* table :filters filters* :order order :limit limit :offset offset))))

;; SHOW
(defmethod repo-show ((entity symbol) ctx id)
  (let* ((md (entity-metadata entity))
         (table (getf md :table))
         (pk (or (getf md :primary-key) :id))
         (tid (getf ctx :tenant-id))
         (filters (list (list '= pk id) (list '= :tenant_id tid))))
    (lumen.data.db:ensure-connection
      (first (select* table :filters filters :limit 1)))))

;; PERSIST (Cœur de l'écriture)
(defmethod repo-persist ((op (eql :create)) (entity symbol) ctx &key id payload)
  (declare (ignore id))
  (let ((ent (row->entity entity payload)))
    (lumen.data.db:ensure-connection
      (multiple-value-bind (_ ent2) (entity-insert! ent :returning t)
        (declare (ignore _))
        (entity->row-alist ent2)))))

(defmethod repo-persist ((op (eql :patch)) (entity symbol) ctx &key id payload)
  ;; Note: Le payload a déjà été normalisé et validé par les hooks
  (let ((cur (repo-show entity ctx id)))
    (unless cur (error 'lumen.data.errors:not-found-error)) ;; Utilisez une vraie condition
    
    (let ((ent (row->entity entity cur)))
      ;; Application du patch sur l'entité
      (dolist (kv payload)
        (let* ((col (%norm-col-name (car kv)))
               (slot (entity-slot-symbol entity col)))
          (when slot (setf (slot-value ent slot) (cdr kv)))))
      
      (lumen.data.db:ensure-connection
        (multiple-value-bind (_ ent2) (entity-update! ent :patch t :returning t)
          (declare (ignore _))
          (entity->row-alist ent2))))))

(defmethod repo-persist ((op (eql :delete)) (entity symbol) ctx &key id payload)
  (declare (ignore payload))
  (let ((cur (repo-show entity ctx id)))
    (unless cur (error \"not_found\"))
    (entity-delete! (row->entity entity cur))
    `((:deleted . t) (:id . ,id))))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS & ORCHESTRATION (:around)
;;; ---------------------------------------------------------------------------

(defmacro %with-write-tx (&body body)
  `(lumen.data.db:with-tx () ,@body))

(defmethod repo-create :around (entity ctx payload)
  (%with-write-tx
    (let ((op :create))
      (repo-authorize op entity ctx :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        (repo-before    op entity ctx :payload p1)
        (let ((res (call-next-method entity ctx p1)))
          (repo-after op entity ctx res :payload p1))))))

(defmethod repo-patch :around (entity ctx id payload)
  (%with-write-tx
    (let ((op :patch))
      (repo-authorize op entity ctx :id id :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        ;; On peut refaire une validation ici si besoin
        (repo-before    op entity ctx :id id :payload p1)
        
        ;; C'EST ICI QUE CA PLANTAIT AVANT : 
        ;; call-next-method doit être dans le scope dynamique de with-tx
        ;; Avec le nouveau with-tx (unwind-protect), ça marche.
        (let ((res (call-next-method entity ctx id p1)))
          (repo-after op entity ctx res :id id :payload p1))))))

(defmethod repo-delete :around (entity ctx id)
  (%with-write-tx
    (let ((op :delete))
      (repo-authorize op entity ctx :id id)
      (repo-before    op entity ctx :id id)
      (let ((res (call-next-method entity ctx id)))
        (repo-after op entity ctx res :id id)))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 51 (face font-lock-type-face fontified t) 51 55 (fontified t) 55 59 (face font-lock-builtin-face fontified t) 59 60 (fontified t) 60 63 (face font-lock-builtin-face fontified t) 63 68 (fontified t) 68 80 (face font-lock-builtin-face fontified t) 80 81 (fontified t) 81 97 (face font-lock-builtin-face fontified t) 97 101 (fontified t) 101 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 119 (face font-lock-builtin-face fontified t) 119 120 (fontified t) 120 132 (face font-lock-builtin-face fontified t) 132 133 (fontified t) 133 146 (face font-lock-builtin-face fontified t) 146 147 (fontified t) 147 163 (face font-lock-builtin-face fontified t) 163 164 (fontified t) 164 176 (face font-lock-builtin-face fontified t) 176 180 (fontified t) 180 193 (face font-lock-builtin-face fontified t) 193 198 (fontified t) 198 210 (face font-lock-builtin-face fontified t) 210 211 (fontified t) 211 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 247 (face font-lock-builtin-face fontified t) 247 248 (fontified t) 248 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 275 (face font-lock-builtin-face fontified t) 275 276 (fontified t) 276 294 (face font-lock-builtin-face fontified t) 294 299 (fontified t) 299 314 (face font-lock-builtin-face fontified t) 314 315 (fontified t) 315 330 (face font-lock-builtin-face fontified t) 330 331 (fontified t) 331 346 (face font-lock-builtin-face fontified t) 346 347 (fontified t) 347 364 (face font-lock-builtin-face fontified t) 364 369 (fontified t) 369 388 (face font-lock-builtin-face fontified t) 388 393 (fontified t) 393 405 (face font-lock-builtin-face fontified t) 405 406 (fontified t) 406 428 (face font-lock-builtin-face fontified t) 428 433 (fontified t) 433 441 (face font-lock-builtin-face fontified t) 441 442 (fontified t) 442 462 (face font-lock-builtin-face fontified t) 462 463 (fontified t) 463 488 (face font-lock-builtin-face fontified t) 488 489 (fontified t) 489 496 (face font-lock-builtin-face fontified t) 496 501 (fontified t) 501 513 (face font-lock-builtin-face fontified t) 513 514 (fontified t) 514 526 (face font-lock-builtin-face fontified t) 526 531 (fontified t) 531 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 553 (face font-lock-builtin-face fontified t) 553 554 (fontified t) 554 564 (face font-lock-builtin-face fontified t) 564 569 (fontified t) 569 581 (face font-lock-builtin-face fontified t) 581 582 (fontified t) 582 596 (face font-lock-builtin-face fontified t) 596 600 (fontified t) 600 608 (face font-lock-builtin-face fontified t) 608 609 (fontified t) 609 627 (face font-lock-builtin-face fontified t) 627 628 (fontified t) 628 637 (face font-lock-builtin-face fontified t) 637 638 (fontified t) 638 643 (face font-lock-builtin-face fontified t) 643 645 (fontified t) 645 648 (face font-lock-comment-delimiter-face fontified t) 648 662 (face font-lock-comment-face fontified t) 662 665 (fontified t) 665 677 (face font-lock-builtin-face fontified t) 677 678 (fontified t) 678 696 (face font-lock-builtin-face fontified t) 696 697 (fontified t) 697 715 (face font-lock-builtin-face fontified t) 715 716 (fontified t) 716 735 (face font-lock-builtin-face fontified t) 735 739 (fontified t) 739 757 (face font-lock-builtin-face fontified t) 757 762 (fontified t) 762 769 (face font-lock-builtin-face fontified t) 769 774 (fontified t) 774 785 (face font-lock-builtin-face fontified t) 785 786 (fontified t) 786 796 (face font-lock-builtin-face fontified t) 796 797 (fontified t) 797 809 (face font-lock-builtin-face fontified t) 809 810 (fontified t) 810 821 (face font-lock-builtin-face fontified t) 821 822 (fontified t) 822 834 (face font-lock-builtin-face fontified t) 834 839 (fontified t) 839 854 (face font-lock-builtin-face fontified t) 854 855 (fontified t) 855 870 (face font-lock-builtin-face fontified t) 870 871 (fontified t) 871 885 (face font-lock-builtin-face fontified t) 885 886 (fontified t) 886 898 (face font-lock-builtin-face fontified t) 898 899 (fontified t) 899 912 (face font-lock-builtin-face fontified t) 912 913 (fontified t) 913 924 (face font-lock-builtin-face fontified t) 924 929 (fontified t) 929 939 (face font-lock-keyword-face fontified t) 939 940 (fontified t) 940 961 (face font-lock-builtin-face fontified t) 961 965 (fontified t) 965 970 (face font-lock-keyword-face fontified t) 970 971 (fontified t) 971 985 (face font-lock-function-name-face fontified t) 985 993 (fontified t) 993 996 (face font-lock-keyword-face fontified t) 996 1002 (fontified t) 1002 1011 (face font-lock-keyword-face fontified t) 1011 1125 (fontified t) 1125 1129 (face font-lock-comment-delimiter-face fontified t) 1129 1205 (face font-lock-comment-face fontified t) 1205 1209 (face font-lock-comment-delimiter-face fontified t) 1209 1223 (face font-lock-comment-face fontified t) 1223 1227 (face font-lock-comment-delimiter-face fontified t) 1227 1303 (face font-lock-comment-face fontified t) 1303 1304 (fontified t) 1304 1314 (face font-lock-keyword-face fontified t) 1314 1315 (fontified t) 1315 1325 (face font-lock-function-name-face fontified t) 1325 1339 (fontified t) 1339 1343 (face font-lock-type-face fontified t) 1343 1413 (fontified t) 1413 1423 (face font-lock-keyword-face fontified t) 1423 1424 (fontified t) 1424 1433 (face font-lock-function-name-face fontified t) 1433 1454 (fontified t) 1454 1464 (face font-lock-keyword-face fontified t) 1464 1465 (fontified t) 1465 1476 (face font-lock-function-name-face fontified t) 1476 1500 (fontified t) 1500 1510 (face font-lock-keyword-face fontified t) 1510 1511 (fontified t) 1511 1521 (face font-lock-function-name-face fontified t) 1521 1548 (fontified t) 9322 9323 (fontified t) 9323 9332 (fontified t face font-lock-keyword-face) 9332 9333 (fontified t) 9333 9343 (fontified t face font-lock-function-name-face) 9343 9344 (fontified t) 9344 9351 (fontified t face font-lock-builtin-face) 9351 9399 (fontified t) 9399 9402 (fontified t face font-lock-keyword-face) 9402 9408 (fontified t) 9408 9414 (fontified t face font-lock-builtin-face) 9414 9417 (fontified t) 9417 9453 (fontified t) 9453 9456 (face font-lock-builtin-face fontified t) 9456 9460 (fontified t) 9460 9468 (face font-lock-builtin-face fontified t) 9468 9478 (fontified t) 9478 9485 (fontified t) 9485 9488 (face font-lock-keyword-face fontified t) 9488 9584 (fontified t) 9584 9587 (face font-lock-comment-delimiter-face fontified t) 9587 9632 (face font-lock-comment-face fontified t) 9632 9670 (fontified t) 9670 9673 (face font-lock-builtin-face fontified t) 9673 9677 (fontified t) 9677 9685 (face font-lock-builtin-face fontified t) 9685 9707 (fontified t) 9707 9710 (face font-lock-comment-delimiter-face fontified t) 9710 9745 (face font-lock-comment-face fontified t) 9745 9753 (fontified t) 9753 9756 (face font-lock-comment-delimiter-face fontified t) 9756 9818 (face font-lock-comment-face fontified t) 9818 9826 (fontified t) 9826 9829 (face font-lock-comment-delimiter-face fontified t) 9829 9882 (face font-lock-comment-face fontified t) 9882 9891 (fontified t) 9891 9894 (face font-lock-keyword-face fontified t) 9894 9979 (fontified t) 9979 9982 (face font-lock-builtin-face fontified t) 9982 9986 (fontified t) 9986 9994 (face font-lock-builtin-face fontified t) 9994 10005 (fontified t) 10005 10006 (fontified t) 10006 10015 (face font-lock-keyword-face fontified t) 10015 10016 (fontified t) 10016 10027 (face font-lock-function-name-face fontified t) 10027 10028 (fontified t) 10028 10035 (face font-lock-builtin-face fontified t) 10035 10075 (fontified t) 10075 10078 (face font-lock-keyword-face fontified t) 10078 10084 (fontified t) 10084 10091 (face font-lock-builtin-face fontified t) 10091 10130 (fontified t) 10130 10133 (face font-lock-builtin-face fontified t) 10133 10174 (fontified t) 10174 10177 (face font-lock-builtin-face fontified t) 10177 10189 (fontified t) 10189 10192 (face font-lock-keyword-face fontified t) 10192 10234 (fontified t) 10234 10272 (fontified t) 10272 10275 (face font-lock-builtin-face fontified t) 10275 10282 (fontified t) 10282 10283 (fontified t rear-nonsticky t) 10283 10284 (fontified t)) . 1) (undo-tree-id71 . -10284) (undo-tree-id72 . -9417) (undo-tree-id73 . -10284) (undo-tree-id74 . -10284) (t 26976 63442 0 0)) nil (26976 64539 444665 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8386 . 8387) (nil fontified nil 1 . 8387) (1 . 8387)) nil (26976 64539 444653 0) 0 nil])
([nil nil ((8387 . 8388) 8197) nil (26976 64539 444649 0) 0 nil])
([nil nil ((620 . 621) (t 26976 64539 0 0)) nil (26977 4891 38847 0) 0 nil])
([nil nil ((621 . 622)) nil (26977 4891 38847 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 639 . 640) (nil fontified nil 622 . 640) (622 . 640)) nil (26977 4891 38846 0) 0 nil])
([nil nil ((7282 . 7284)) nil (26977 4891 38845 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7894 . 7895) (nil fontified nil 7284 . 7895) (7284 . 7895)) nil (26977 4891 38845 0) 0 nil])
([nil nil ((#("(defmethod repo-create :around (entity ctx payload)
  (%with-write-tx
    (let ((op :create))
      (repo-authorize op entity ctx :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        (repo-before    op entity ctx :payload p1)
        (let ((res (call-next-method entity ctx p1)))
          (repo-after op entity ctx res :payload p1))))))

(defmethod repo-patch :around (entity ctx id payload)
  (%with-write-tx
    (let ((op :patch))
      (repo-authorize op entity ctx :id id :payload payload)
      (let ((p1 (repo-normalize op entity ctx payload)))
        (repo-validate op entity ctx p1)
        (repo-before    op entity ctx :id id :payload p1)
        (let ((res (call-next-method entity ctx id p1)))
          (repo-after op entity ctx res :id id :payload p1))))))

(defmethod repo-delete :around (entity ctx id)
  (%with-write-tx
    (let ((op :delete))
      (repo-authorize op entity ctx :id id)
      (repo-before    op entity ctx :id id)
      (let ((res (call-next-method entity ctx id)))
        (repo-after op entity ctx res :id id)))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 22 (face font-lock-function-name-face fontified t) 22 23 (fontified t) 23 30 (face font-lock-builtin-face fontified t) 30 75 (fontified t) 75 78 (face font-lock-keyword-face fontified t) 78 84 (fontified t) 84 91 (face font-lock-builtin-face fontified t) 91 130 (fontified t) 130 138 (face font-lock-builtin-face fontified t) 138 155 (fontified t) 155 158 (face font-lock-keyword-face fontified t) 158 284 (fontified t) 284 292 (face font-lock-builtin-face fontified t) 292 306 (fontified t) 306 309 (face font-lock-keyword-face fontified t) 309 391 (fontified t) 391 399 (face font-lock-builtin-face fontified t) 399 411 (fontified t) 411 420 (face font-lock-keyword-face fontified t) 420 421 (fontified t) 421 431 (face font-lock-function-name-face fontified t) 431 432 (fontified t) 432 439 (face font-lock-builtin-face fontified t) 439 487 (fontified t) 487 490 (face font-lock-keyword-face fontified t) 490 496 (fontified t) 496 502 (face font-lock-builtin-face fontified t) 502 541 (fontified t) 541 544 (face font-lock-builtin-face fontified t) 544 548 (fontified t) 548 556 (face font-lock-builtin-face fontified t) 556 573 (fontified t) 573 576 (face font-lock-keyword-face fontified t) 576 702 (fontified t) 702 705 (face font-lock-builtin-face fontified t) 705 709 (fontified t) 709 717 (face font-lock-builtin-face fontified t) 717 731 (fontified t) 731 734 (face font-lock-keyword-face fontified t) 734 819 (fontified t) 819 822 (face font-lock-builtin-face fontified t) 822 826 (fontified t) 826 834 (face font-lock-builtin-face fontified t) 834 846 (fontified t) 846 855 (face font-lock-keyword-face fontified t) 855 856 (fontified t) 856 867 (face font-lock-function-name-face fontified t) 867 868 (fontified t) 868 875 (face font-lock-builtin-face fontified t) 875 915 (fontified t) 915 918 (face font-lock-keyword-face fontified t) 918 924 (fontified t) 924 931 (face font-lock-builtin-face fontified t) 931 970 (fontified t) 970 973 (face font-lock-builtin-face fontified t) 973 1014 (fontified t) 1014 1017 (face font-lock-builtin-face fontified t) 1017 1029 (fontified t) 1029 1032 (face font-lock-keyword-face fontified t) 1032 1066 (fontified t) 1066 1074 (fontified t) 1074 1112 (fontified t) 1112 1115 (face font-lock-builtin-face fontified t) 1115 1123 (fontified t)) . 7897) (undo-tree-id0 . -1123) (undo-tree-id1 . -1123) (undo-tree-id2 . -1123) (undo-tree-id3 . -1123)) nil (26977 4891 38843 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9656 . 9657) (nil fontified nil 7897 . 9657) (7897 . 9657)) nil (26977 4891 38826 0) 0 nil])
([nil nil ((735 . 738) (t 26977 4891 0 0)) nil (26977 8068 10244 0) 0 nil])
([nil nil ((nil fontified nil 843 . 844) (nil fontified nil 842 . 843) (nil fontified nil 821 . 842) (nil fontified nil 820 . 821) (nil fontified nil 819 . 820) (nil fontified nil 818 . 819) (nil fontified nil 794 . 818) (nil fontified nil 793 . 794) (nil fontified nil 792 . 793) (nil fontified nil 791 . 792) (nil fontified nil 774 . 791) (nil fontified nil 771 . 774) (nil fontified nil 769 . 771) (nil fontified nil 768 . 769) (nil fontified nil 752 . 768) (nil fontified nil 751 . 752) (nil fontified nil 739 . 751) (nil fontified nil 738 . 739) (738 . 844)) nil (26977 8068 10243 0) 0 nil])
([nil nil ((#("(defun %handle-tx-result (result)
  (if (and (consp result) (keywordp (car result)))
      (case (car result)
        ;; C'est ici qu'on recrée l'erreur pour le Middleware
        ;; On est hors de la DB, la pile est propre.
        (:business-error 
         (error 'lumen.core.error:application-error :message (cdr result)))
        
        (:fatal-error
         (error \"Database Error: ~A\" (cdr result)))
        
        ;; Cas improbable (si la fonction a renvoyé une cons cell par hasard)
        (t result))
      ;; Succès normal
      result))" 0 1 (fontified t) 1 6 (fontified t face font-lock-keyword-face) 6 7 (fontified t) 7 24 (fontified t face font-lock-function-name-face) 24 37 (fontified t) 37 39 (face font-lock-keyword-face fontified t) 39 92 (fontified t) 92 96 (face font-lock-keyword-face fontified t) 96 118 (fontified t) 118 121 (face font-lock-comment-delimiter-face fontified t) 121 172 (face font-lock-comment-face fontified t) 172 180 (fontified t) 180 183 (face font-lock-comment-delimiter-face fontified t) 183 225 (face font-lock-comment-face fontified t) 225 234 (fontified t) 234 249 (face font-lock-builtin-face fontified t) 249 261 (fontified t) 261 266 (face font-lock-warning-face fontified t) 266 303 (fontified t) 303 311 (face font-lock-builtin-face fontified t) 311 345 (fontified t) 345 357 (face font-lock-builtin-face fontified t) 357 368 (fontified t) 368 373 (face font-lock-warning-face fontified t) 373 374 (fontified t) 374 394 (face font-lock-string-face fontified t) 394 427 (fontified t) 427 430 (face font-lock-comment-delimiter-face fontified t) 430 497 (face font-lock-comment-face fontified t) 497 523 (fontified t) 523 526 (face font-lock-comment-delimiter-face fontified t) 526 540 (face font-lock-comment-face fontified t) 540 553 (fontified t) 553 554 (fontified t rear-nonsticky t)) . 7450) (undo-tree-id4 . -554) (undo-tree-id5 . -315) (undo-tree-id6 . -24)) nil (26977 8068 10241 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8123 . 8124) (nil fontified nil 7450 . 8124) (7450 . 8124)) nil (26977 8068 10228 0) 0 nil])
([nil nil ((7729 . 7734) (t 26977 8068 0 0)) nil (26977 11864 472048 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7805 . 7806) (nil fontified nil 7793 . 7806) (nil fontified nil 7744 . 7793) (nil fontified nil 7734 . 7744) (7734 . 7806)) nil (26977 11864 472047 0) 0 nil])
([nil nil ((#("DB " 0 3 (face font-lock-string-face fontified t)) . -7748) (undo-tree-id19 . -3) 7751) nil (26977 11864 472046 0) 0 nil])
([nil nil ((7748 . 7752)) nil (26977 11864 472045 0) 0 nil])
([nil nil ((7752 . 7753)) nil (26977 11864 472045 0) 0 nil])
([nil nil ((7758 . 7759)) nil (26977 11864 472044 0) 0 nil])
([nil nil ((7759 . 7760)) nil (26977 11864 472044 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7776 . 7777) (nil fontified nil 7760 . 7777) (7760 . 7777)) nil (26977 11864 472043 0) 0 nil])
([nil nil ((7761 . 7767) (#("handle" 0 6 (face font-lock-string-face fontified t)) . 7761)) nil (26977 11864 472042 0) 0 nil])
([nil nil ((7767 . 7770) (#("-tx" 0 3 (face font-lock-string-face fontified t)) . 7767)) nil (26977 11864 472042 0) 0 nil])
([nil nil ((7770 . 7777) (#("-result" 0 6 (face font-lock-string-face fontified t) 6 7 (face font-lock-string-face rear-nonsticky t fontified t)) . 7770)) nil (26977 11864 472041 0) 0 nil])
([nil nil ((7760 . 7761)) nil (26977 11864 472040 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -7759) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (#("*" 0 1 (face font-lock-string-face fontified t)) . -7760) (undo-tree-id18 . -1) 7761) nil (26977 11864 472039 0) 0 nil])
([nil nil ((#("Inspection de l'erreur métier" 0 29 (face font-lock-string-face fontified t)) . -7778) (undo-tree-id15 . -29) 7807) nil (26977 11864 472037 0) 0 nil])
([nil nil ((7778 . 7783)) nil (26977 11864 472036 0) 0 nil])
([nil nil ((7783 . 7784)) nil (26977 11864 472035 0) 0 nil])
([nil nil ((7784 . 7785)) nil (26977 11864 472035 0) 0 nil])
([nil nil ((#("R" 0 1 (face font-lock-string-face fontified t)) . -7779) (undo-tree-id9 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -7780) (undo-tree-id10 . -1) (#("O" 0 1 (face font-lock-string-face fontified t)) . -7781) (undo-tree-id11 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -7782) (undo-tree-id12 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -7783) (undo-tree-id13 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -7784) (undo-tree-id14 . -1) 7785) nil (26977 11864 472034 0) 0 nil])
([nil nil ((7779 . 7783)) nil (26977 11864 472026 0) 0 nil])
([nil nil ((7783 . 7784)) nil (26977 11864 472026 0) 0 nil])
([nil nil ((7784 . 7792)) nil (26977 11864 472026 0) 0 nil])
([nil nil ((7792 . 7793)) nil (26977 11864 472025 0) 0 nil])
([nil nil ((7793 . 7797)) nil (26977 11864 472024 0) 0 nil])
([nil nil ((#("(type-of c" 0 10 (fontified t)) . -7804) (undo-tree-id8 . -10) 7814) nil (26977 11864 472023 0) 0 nil])
([nil nil ((7804 . 7808)) nil (26977 11864 472020 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -7809) (undo-tree-id7 . -1) 7810) nil (26977 11864 472017 0) 0 nil])
([nil nil ((8204 . 8206) (t 26977 11864 0 0)) nil (26977 16278 611787 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10248 . 10249) (nil fontified nil 10208 . 10249) (nil fontified nil 10204 . 10208) (nil fontified nil 10197 . 10204) (nil fontified nil 10164 . 10197) (nil fontified nil 10108 . 10164) (nil fontified nil 10089 . 10108) (nil fontified nil 10032 . 10089) (nil fontified nil 9998 . 10032) (nil fontified nil 9946 . 9998) (nil fontified nil 9941 . 9946) (nil fontified nil 9908 . 9941) (nil fontified nil 9851 . 9908) (nil fontified nil 9837 . 9851) (nil fontified nil 9779 . 9837) (nil fontified nil 9775 . 9779) (nil fontified nil 9749 . 9775) (nil fontified nil 9739 . 9749) (nil fontified nil 9699 . 9739) (nil fontified nil 9689 . 9699) (nil fontified nil 9663 . 9689) (nil fontified nil 9645 . 9663) (nil fontified nil 9613 . 9645) (nil fontified nil 9609 . 9613) (nil fontified nil 9599 . 9609) (nil fontified nil 9596 . 9599) (nil fontified nil 9559 . 9596) (nil fontified nil 9554 . 9559) (nil fontified nil 9548 . 9554) (nil fontified nil 9545 . 9548) (nil fontified nil 9525 . 9545) (nil fontified nil 9518 . 9525) (nil fontified nil 9517 . 9518) (nil fontified nil 9508 . 9517) (nil fontified nil 9507 . 9508) (nil fontified nil 9498 . 9507) (nil fontified nil 9497 . 9498) (nil fontified nil 9374 . 9497) (nil fontified nil 9371 . 9374) (nil fontified nil 9320 . 9371) (nil fontified nil 9314 . 9320) (nil fontified nil 9308 . 9314) (nil fontified nil 9305 . 9308) (nil fontified nil 9279 . 9305) (nil fontified nil 9271 . 9279) (nil fontified nil 9167 . 9271) (nil fontified nil 9135 . 9167) (nil fontified nil 9132 . 9135) (nil fontified nil 9070 . 9132) (nil fontified nil 9068 . 9070) (nil fontified nil 9044 . 9068) (nil fontified nil 8999 . 9044) (nil fontified nil 8996 . 8999) (nil fontified nil 8876 . 8996) (nil fontified nil 8866 . 8876) (nil fontified nil 8842 . 8866) (nil fontified nil 8838 . 8842) (nil fontified nil 8826 . 8838) (nil fontified nil 8809 . 8826) (nil fontified nil 8800 . 8809) (nil fontified nil 8796 . 8800) (nil fontified nil 8794 . 8796) (nil fontified nil 8776 . 8794) (nil fontified nil 8766 . 8776) (nil fontified nil 8761 . 8766) (nil fontified nil 8748 . 8761) (nil fontified nil 8741 . 8748) (nil fontified nil 8740 . 8741) (nil fontified nil 8730 . 8740) (nil fontified nil 8729 . 8730) (nil fontified nil 8720 . 8729) (nil fontified nil 8710 . 8720) (nil fontified nil 8700 . 8710) (nil fontified nil 8686 . 8700) (nil fontified nil 8682 . 8686) (nil fontified nil 8672 . 8682) (nil fontified nil 8651 . 8672) (nil fontified nil 8650 . 8651) (nil fontified nil 8645 . 8650) (nil fontified nil 8624 . 8645) (nil fontified nil 8607 . 8624) (nil fontified nil 8604 . 8607) (nil fontified nil 8558 . 8604) (nil fontified nil 8515 . 8558) (nil fontified nil 8512 . 8515) (nil fontified nil 8494 . 8512) (nil fontified nil 8490 . 8494) (nil fontified nil 8446 . 8490) (nil fontified nil 8403 . 8446) (nil fontified nil 8402 . 8403) (nil fontified nil 8399 . 8402) (nil fontified nil 8375 . 8399) (nil fontified nil 8371 . 8375) (nil fontified nil 8367 . 8371) (nil fontified nil 8239 . 8367) (nil fontified nil 8232 . 8239) (nil fontified nil 8213 . 8232) (nil fontified nil 8212 . 8213) (nil fontified nil 8207 . 8212) (nil fontified nil 8206 . 8207) (8206 . 10249)) nil (26977 16278 611784 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -10248) (undo-tree-id25 . -1) 10249) nil (26977 16278 611775 0) 0 nil])
([nil nil ((10073 . 10080) (#("                                      " 0 38 (fontified nil)) . 10073) (10056 . 10063) (10028 . 10029) (#("   " 0 3 (fontified nil)) . 10028) (9975 . 9982) (9927 . 9933) (#("                                 " 0 33 (fontified nil)) . 9927) (9904 . 9911) (9857 . 9863) (#("                                 " 0 33 (fontified nil)) . 9857) (9834 . 9841) (9806 . 9812) (#("                                 " 0 33 (fontified nil)) . 9806) (9783 . 9790) (9763 . 9769) (#("      " 0 6 (fontified t)) . 9763) (9639 . 9640) (#("      " 0 6 (fontified t)) . 9639) 9497) nil (26977 16278 611773 0) 0 nil])
([nil nil ((#("(defmethod repo-index :around (entity ctx &rest args)
  (destructuring-bind (&key filters &allow-other-keys) args
    (let* ((tid        (getf ctx :tenant-id))
           (base       (%ensure-filter-list filters))
           (ten-clause (%tenant-filter-clause tid))
           ;; Ajoute le tenant_id à la fin (AND implicite)
           (filters*   (if ten-clause (append base (list ten-clause)) base))
           ;; Remplace :filters dans les args
           (args*      (alexandria:plist-alist (lumen.utils:copy-plist args))))
      (setf (cdr (assoc :filters args*)) filters*)
      (let ((op :index))
        (repo-authorize op entity ctx)
        (let ((res (apply #'call-next-method entity ctx
			  (alexandria:alist-plist args*))))
	  (repo-after op entity ctx res))))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 21 (face font-lock-function-name-face fontified t) 21 22 (fontified t) 22 29 (face font-lock-builtin-face fontified t) 29 42 (fontified t) 42 47 (face font-lock-type-face fontified t) 47 57 (fontified t) 57 75 (face font-lock-keyword-face fontified t) 75 77 (fontified t) 77 81 (face font-lock-type-face fontified t) 81 90 (fontified t) 90 107 (face font-lock-type-face fontified t) 107 119 (fontified t) 119 123 (face font-lock-keyword-face fontified t) 123 147 (fontified t) 147 157 (face font-lock-builtin-face fontified t) 157 277 (fontified t) 277 280 (face font-lock-comment-delimiter-face fontified t) 280 325 (face font-lock-comment-face fontified t) 325 349 (fontified t) 349 351 (face font-lock-keyword-face fontified t) 351 413 (fontified t) 413 416 (face font-lock-comment-delimiter-face fontified t) 416 448 (face font-lock-comment-face fontified t) 448 552 (fontified t) 552 560 (face font-lock-builtin-face fontified t) 560 586 (fontified t) 586 589 (face font-lock-keyword-face fontified t) 589 595 (fontified t) 595 601 (face font-lock-builtin-face fontified t) 601 652 (fontified t) 652 655 (face font-lock-keyword-face fontified t) 655 776 (fontified t)) . -8719) (undo-tree-id24 . -776) 9495) nil (26977 16278 611771 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10183 . 10184) (nil fontified nil 8719 . 10184) (8719 . 10184)) nil (26977 16278 611769 0) 0 nil])
([nil nil ((#("(defmethod repo-show :around (entity ctx id)
  (let ((op :show))
    (repo-authorize op entity ctx :id id)
    (let* ((row (call-next-method))	; SELECT primaire
           (tid (getf ctx :tenant-id))
           (rid (and row (cdr (assoc :tenant_id row))))
	   (res 
	     (cond
               ((null row) nil)	     ; rien trouvé
               ((null tid) nil)	     ; pas de scope tenant → prudence
               ((null rid) row)	     ; pas de colonne tenant → renvoie
               ((string-equal (string rid) (string tid)) row) ; même tenant → OK
               (t nil))))	      ; cross-tenant → masque la fuite
      (when res
	(repo-after op entity ctx res)))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 20 (face font-lock-function-name-face fontified t) 20 21 (fontified t) 21 28 (face font-lock-builtin-face fontified t) 28 48 (fontified t) 48 51 (face font-lock-keyword-face fontified t) 51 57 (fontified t) 57 62 (face font-lock-builtin-face fontified t) 62 99 (fontified t) 99 102 (face font-lock-builtin-face fontified t) 102 107 (fontified t) 107 112 (fontified t) 112 116 (face font-lock-keyword-face fontified t) 116 143 (fontified t) 143 161 (face font-lock-comment-face fontified t) 161 187 (fontified t) 187 197 (face font-lock-builtin-face fontified t) 197 204 (fontified t) 204 237 (fontified t) 237 247 (face font-lock-builtin-face fontified t) 247 256 (fontified t) 256 266 (fontified t) 266 272 (fontified t) 272 273 (fontified t) 273 277 (face font-lock-keyword-face fontified t) 277 278 (fontified t) 278 315 (fontified t) 315 329 (face font-lock-comment-face fontified t) 329 366 (fontified t) 366 399 (face font-lock-comment-face fontified t) 399 404 (fontified t) 404 436 (fontified t) 436 470 (face font-lock-comment-face fontified t) 470 532 (fontified t) 532 551 (face font-lock-comment-face fontified t) 551 583 (fontified t) 583 616 (face font-lock-comment-face fontified t) 616 623 (fontified t) 623 627 (face font-lock-keyword-face fontified t) 627 632 (fontified t) 632 667 (fontified t)) . -10186) (undo-tree-id20 . -667) (undo-tree-id21 . -632) (undo-tree-id22 . -667) (undo-tree-id23 . -667) 10853) nil (26977 16278 611767 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11585 . 11586) (nil fontified nil 10186 . 11586) (10186 . 11586)) nil (26977 16278 611748 0) 0 nil])
([nil nil ((#("(defmethod repo-create ((entity symbol) ctx payload) (repo-persist :create entity ctx :payload payload))" 0 1 (fontified t) 1 10 (fontified t face font-lock-keyword-face) 10 11 (fontified t) 11 22 (fontified t face font-lock-function-name-face) 22 67 (fontified t) 67 74 (face font-lock-builtin-face fontified t) 74 86 (fontified t) 86 94 (face font-lock-builtin-face fontified t) 94 104 (fontified t)) . -5710) (undo-tree-id30 . -22) (undo-tree-id31 . -22) (undo-tree-id32 . -22) (undo-tree-id33 . -104) (undo-tree-id34 . -11) (undo-tree-id35 . -22) (undo-tree-id36 . -22) (undo-tree-id37 . -22) (undo-tree-id38 . -22) (undo-tree-id39 . -104) (undo-tree-id40 . -104) (undo-tree-id41 . -11) (undo-tree-id42 . -104) (undo-tree-id43 . -104) 5814 (t 26977 16278 0 0)) nil (26977 16988 986906 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5842 . 5843) (nil fontified nil 5833 . 5843) (nil fontified nil 5825 . 5833) (nil fontified nil 5813 . 5825) (nil fontified nil 5806 . 5813) (nil fontified nil 5788 . 5806) (nil fontified nil 5772 . 5788) (nil fontified nil 5732 . 5772) (nil fontified nil 5721 . 5732) (nil fontified nil 5720 . 5721) (nil fontified nil 5711 . 5720) (nil fontified nil 5710 . 5711) (5710 . 5843)) nil (26977 16988 986895 0) 0 nil])
([nil nil ((5843 . 5844)) nil (26977 16988 986893 0) 0 nil])
([nil nil ((#("(defmethod repo-persist ((op (eql :create)) (entity symbol) ctx &key id payload)
  (declare (ignore id))
  (let ((ent (row->entity entity payload)))
    (validate-entity! ent)
    (lumen.data.db:ensure-connection
      (multiple-value-bind (_ ent2) (entity-insert! ent :returning t)
        (declare (ignore _))
        (entity->row-alist ent2)))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 23 (face font-lock-function-name-face fontified t) 23 34 (fontified t) 34 41 (face font-lock-builtin-face fontified t) 41 64 (fontified t) 64 68 (face font-lock-type-face fontified t) 68 84 (fontified t) 84 91 (face font-lock-keyword-face fontified t) 91 108 (fontified t) 108 111 (face font-lock-keyword-face fontified t) 111 220 (fontified t) 220 239 (face font-lock-keyword-face fontified t) 239 269 (fontified t) 269 279 (face font-lock-builtin-face fontified t) 279 292 (fontified t) 292 299 (face font-lock-keyword-face fontified t) 299 348 (fontified t)) . -6049) (undo-tree-id26 . -348) (undo-tree-id27 . -312) (undo-tree-id28 . -348) (undo-tree-id29 . -348) 6397) nil (26977 16988 986891 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6512 . 6513) (nil fontified nil 6463 . 6513) (nil fontified nil 6456 . 6463) (nil fontified nil 6443 . 6456) (nil fontified nil 6433 . 6443) (nil fontified nil 6402 . 6433) (nil fontified nil 6383 . 6402) (nil fontified nil 6258 . 6383) (nil fontified nil 6251 . 6258) (nil fontified nil 6250 . 6251) (nil fontified nil 6247 . 6250) (nil fontified nil 6189 . 6247) (nil fontified nil 6185 . 6189) (nil fontified nil 6180 . 6185) (nil fontified nil 6163 . 6180) (nil fontified nil 6140 . 6163) (nil fontified nil 6133 . 6140) (nil fontified nil 6117 . 6133) (nil fontified nil 6113 . 6117) (nil fontified nil 6090 . 6113) (nil fontified nil 6083 . 6090) (nil fontified nil 6072 . 6083) (nil fontified nil 6060 . 6072) (nil fontified nil 6059 . 6060) (nil fontified nil 6050 . 6059) (nil fontified nil 6049 . 6050) (6049 . 6513)) nil (26977 16988 986873 0) 0 nil])
([nil nil ((4104 . 4106) (t 26977 16988 0 0)) nil (26977 17837 25973 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6809 . 6810) (nil fontified nil 6779 . 6810) (nil fontified nil 6774 . 6779) (nil fontified nil 6767 . 6774) (nil fontified nil 6763 . 6767) (nil fontified nil 6704 . 6763) (nil fontified nil 6699 . 6704) (nil fontified nil 6692 . 6699) (nil fontified nil 6688 . 6692) (nil fontified nil 6633 . 6688) (nil fontified nil 6631 . 6633) (nil fontified nil 6591 . 6631) (nil fontified nil 6513 . 6591) (nil fontified nil 6510 . 6513) (nil fontified nil 6496 . 6510) (nil fontified nil 6454 . 6496) (nil fontified nil 6453 . 6454) (nil fontified nil 6448 . 6453) (nil fontified nil 6277 . 6448) (nil fontified nil 6273 . 6277) (nil fontified nil 6186 . 6273) (nil fontified nil 6182 . 6186) (nil fontified nil 6125 . 6182) (nil fontified nil 6121 . 6125) (nil fontified nil 6097 . 6121) (nil fontified nil 6092 . 6097) (nil fontified nil 6045 . 6092) (nil fontified nil 6023 . 6045) (nil fontified nil 5951 . 6023) (nil fontified nil 5947 . 5951) (nil fontified nil 5937 . 5947) (nil fontified nil 5931 . 5937) (nil fontified nil 5917 . 5931) (nil fontified nil 5861 . 5917) (nil fontified nil 5858 . 5861) (nil fontified nil 5811 . 5858) (nil fontified nil 5791 . 5811) (nil fontified nil 5788 . 5791) (nil fontified nil 5764 . 5788) (nil fontified nil 5759 . 5764) (nil fontified nil 5752 . 5759) (nil fontified nil 5748 . 5752) (nil fontified nil 5617 . 5748) (nil fontified nil 5593 . 5617) (nil fontified nil 5590 . 5593) (nil fontified nil 5569 . 5590) (nil fontified nil 5521 . 5569) (nil fontified nil 5520 . 5521) (nil fontified nil 5515 . 5520) (nil fontified nil 5359 . 5515) (nil fontified nil 5355 . 5359) (nil fontified nil 5327 . 5355) (nil fontified nil 5322 . 5327) (nil fontified nil 5260 . 5322) (nil fontified nil 5257 . 5260) (nil fontified nil 5234 . 5257) (nil fontified nil 5229 . 5234) (nil fontified nil 5167 . 5229) (nil fontified nil 5129 . 5167) (nil fontified nil 5126 . 5129) (nil fontified nil 5086 . 5126) (nil fontified nil 5038 . 5086) (nil fontified nil 5037 . 5038) (nil fontified nil 5032 . 5037) (nil fontified nil 4876 . 5032) (nil fontified nil 4872 . 4876) (nil fontified nil 4825 . 4872) (nil fontified nil 4822 . 4825) (nil fontified nil 4780 . 4822) (nil fontified nil 4751 . 4780) (nil fontified nil 4748 . 4751) (nil fontified nil 4739 . 4748) (nil fontified nil 4701 . 4739) (nil fontified nil 4670 . 4701) (nil fontified nil 4666 . 4670) (nil fontified nil 4656 . 4666) (nil fontified nil 4649 . 4656) (nil fontified nil 4635 . 4649) (nil fontified nil 4561 . 4635) (nil fontified nil 4558 . 4561) (nil fontified nil 4523 . 4558) (nil fontified nil 4496 . 4523) (nil fontified nil 4465 . 4496) (nil fontified nil 4462 . 4465) (nil fontified nil 4455 . 4462) (nil fontified nil 4451 . 4455) (nil fontified nil 4442 . 4451) (nil fontified nil 4432 . 4442) (nil fontified nil 4326 . 4432) (nil fontified nil 4322 . 4326) (nil fontified nil 4318 . 4322) (nil fontified nil 4200 . 4318) (nil fontified nil 4175 . 4200) (nil fontified nil 4168 . 4175) (nil fontified nil 4163 . 4168) (nil fontified nil 4159 . 4163) (nil fontified nil 4138 . 4159) (nil fontified nil 4113 . 4138) (nil fontified nil 4112 . 4113) (nil fontified nil 4107 . 4112) (nil fontified nil 4106 . 4107) (4106 . 6810)) nil (26977 17837 25970 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -6809) (undo-tree-id78 . -1) (undo-tree-id79 . -1) 6810) nil (26977 17837 25961 0) 0 nil])
([nil nil ((#("(defmethod repo-index ((entity symbol) ctx &key filters order select page page-size limit offset after before key)
  (lumen.data.db:ensure-connection
    (lumen.data.repo.query:select* (getf (lumen.data.dao:entity-metadata entity) :table)
      :filters (%maybe-add-tenant-filter filters :tenant_id (getf ctx :tenant-id))
      :limit limit :offset offset :order order)))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 21 (face font-lock-function-name-face fontified t) 21 43 (fontified t) 43 47 (face font-lock-type-face fontified t) 47 231 (fontified t) 231 237 (face font-lock-builtin-face fontified t) 237 245 (fontified t) 245 253 (face font-lock-builtin-face fontified t) 253 288 (fontified t) 288 298 (face font-lock-builtin-face fontified t) 298 309 (fontified t) 309 319 (face font-lock-builtin-face fontified t) 319 328 (fontified t) 328 334 (face font-lock-builtin-face fontified t) 334 341 (fontified t) 341 348 (face font-lock-builtin-face fontified t) 348 356 (fontified t) 356 362 (face font-lock-builtin-face fontified t) 362 371 (fontified t)) . -7783) (undo-tree-id76 . -264) (undo-tree-id77 . -371) 8154) nil (26977 17837 25959 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9028 . 9029) (nil fontified nil 9015 . 9029) (nil fontified nil 8999 . 9015) (nil fontified nil 8981 . 8999) (nil fontified nil 8976 . 8981) (nil fontified nil 8914 . 8976) (nil fontified nil 8907 . 8914) (nil fontified nil 8840 . 8907) (nil fontified nil 8834 . 8840) (nil fontified nil 8814 . 8834) (nil fontified nil 8812 . 8814) (nil fontified nil 8799 . 8812) (nil fontified nil 8792 . 8799) (nil fontified nil 8765 . 8792) (nil fontified nil 8759 . 8765) (nil fontified nil 8731 . 8759) (nil fontified nil 8723 . 8731) (nil fontified nil 8659 . 8723) (nil fontified nil 8643 . 8659) (nil fontified nil 8596 . 8643) (nil fontified nil 8590 . 8596) (nil fontified nil 8551 . 8590) (nil fontified nil 8545 . 8551) (nil fontified nil 8506 . 8545) (nil fontified nil 8502 . 8506) (nil fontified nil 8463 . 8502) (nil fontified nil 8457 . 8463) (nil fontified nil 8417 . 8457) (nil fontified nil 8409 . 8417) (nil fontified nil 8315 . 8409) (nil fontified nil 8311 . 8315) (nil fontified nil 8149 . 8311) (nil fontified nil 8139 . 8149) (nil fontified nil 8106 . 8139) (nil fontified nil 8090 . 8106) (nil fontified nil 8087 . 8090) (nil fontified nil 8075 . 8087) (nil fontified nil 8026 . 8075) (nil fontified nil 8020 . 8026) (nil fontified nil 7956 . 8020) (nil fontified nil 7952 . 7956) (nil fontified nil 7853 . 7952) (nil fontified nil 7849 . 7853) (nil fontified nil 7804 . 7849) (nil fontified nil 7794 . 7804) (nil fontified nil 7793 . 7794) (nil fontified nil 7784 . 7793) (nil fontified nil 7783 . 7784) (7783 . 9029)) nil (26977 17837 25956 0) 0 nil])
([nil nil ((#("(defmethod repo-show ((entity symbol) ctx id)
  (lumen.data.db:ensure-connection
    (first (lumen.data.repo.query:select* (getf (lumen.data.dao:entity-metadata entity) :table)
      :filters `((= :id ,id) (= :tenant_id ,(getf ctx :tenant-id))) :limit 1))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 20 (face font-lock-function-name-face fontified t) 20 153 (fontified t) 153 154 (fontified t) 154 169 (fontified t) 169 175 (face font-lock-builtin-face fontified t) 175 177 (fontified t) 177 183 (fontified t) 183 191 (face font-lock-builtin-face fontified t) 191 197 (fontified t) 197 200 (face font-lock-builtin-face fontified t) 200 209 (fontified t) 209 219 (face font-lock-builtin-face fontified t) 219 231 (fontified t) 231 241 (face font-lock-builtin-face fontified t) 241 245 (fontified t) 245 251 (face font-lock-builtin-face fontified t) 251 257 (fontified t)) . -9031) (undo-tree-id75 . -257) 9288) nil (26977 17837 25952 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9624 . 9625) (nil fontified nil 9584 . 9625) (nil fontified nil 9578 . 9584) (nil fontified nil 9569 . 9578) (nil fontified nil 9561 . 9569) (nil fontified nil 9540 . 9561) (nil fontified nil 9537 . 9540) (nil fontified nil 9389 . 9537) (nil fontified nil 9387 . 9389) (nil fontified nil 9318 . 9387) (nil fontified nil 9308 . 9318) (nil fontified nil 9248 . 9308) (nil fontified nil 9245 . 9248) (nil fontified nil 9243 . 9245) (nil fontified nil 9231 . 9243) (nil fontified nil 9200 . 9231) (nil fontified nil 9194 . 9200) (nil fontified nil 9136 . 9194) (nil fontified nil 9132 . 9136) (nil fontified nil 9103 . 9132) (nil fontified nil 9094 . 9103) (nil fontified nil 9093 . 9094) (nil fontified nil 9084 . 9093) (nil fontified nil 9083 . 9084) (nil fontified nil 9034 . 9083) (nil fontified nil 9031 . 9034) (9031 . 9625)) nil (26977 17837 25950 0) 0 nil])
([nil nil ((7541 . 7542)) nil (26977 17837 25947 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8210 . 8211) (nil fontified nil 8182 . 8211) (nil fontified nil 8128 . 8182) (nil fontified nil 8085 . 8128) (nil fontified nil 8075 . 8085) (nil fontified nil 8065 . 8075) (nil fontified nil 8063 . 8065) (nil fontified nil 8053 . 8063) (nil fontified nil 8033 . 8053) (nil fontified nil 7988 . 8033) (nil fontified nil 7935 . 7988) (nil fontified nil 7931 . 7935) (nil fontified nil 7906 . 7931) (nil fontified nil 7902 . 7906) (nil fontified nil 7885 . 7902) (nil fontified nil 7879 . 7885) (nil fontified nil 7831 . 7879) (nil fontified nil 7825 . 7831) (nil fontified nil 7816 . 7825) (nil fontified nil 7802 . 7816) (nil fontified nil 7773 . 7802) (nil fontified nil 7766 . 7773) (nil fontified nil 7696 . 7766) (nil fontified nil 7692 . 7696) (nil fontified nil 7688 . 7692) (nil fontified nil 7592 . 7688) (nil fontified nil 7585 . 7592) (nil fontified nil 7576 . 7585) (nil fontified nil 7567 . 7576) (nil fontified nil 7549 . 7567) (nil fontified nil 7548 . 7549) (nil fontified nil 7543 . 7548) (nil fontified nil 7542 . 7543) (7542 . 8211)) nil (26977 17837 25946 0) 0 nil])
([nil nil ((8211 . 8212)) nil (26977 17837 25943 0) 0 nil])
([nil nil ((10488 . 10490) (#(" " 0 1 (fontified nil)) . 10487) (undo-tree-id74 . -1) (10488 . 10489)) nil (26977 17837 25942 0) 0 nil])
([nil nil ((10547 . 10548)) nil (26977 17837 25941 0) 0 nil])
([nil nil ((#("(defmethod repo-after (op (entity symbol) ctx result &key id payload)
  (declare (ignore id payload))
  ;; Audit Log simplifié
  (let ((audit? (getf ctx :audit?)))
    (when audit?
      (ignore-errors
        (let ((actor (or (getf ctx :actor-id) (and (getf ctx :req) (lumen.core.http:current-user-id (getf ctx :req))))))
          (lumen.data.db:ensure-connection
            (lumen.data.db:exec \"insert into audit_log(actor_id, tenant_id, action, resource, payload) values($1,$2,$3,$4,$5)\"
                                actor (getf ctx :tenant-id) (string-downcase (symbol-name op)) (string-downcase (symbol-name entity))
                                (cl-json:encode-json-to-string result)))))))
  result)" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 21 (face font-lock-function-name-face fontified t) 21 53 (fontified t) 53 57 (face font-lock-type-face fontified t) 57 73 (fontified t) 73 80 (face font-lock-keyword-face fontified t) 80 104 (fontified t) 104 107 (face font-lock-comment-delimiter-face fontified t) 107 127 (face font-lock-comment-face fontified t) 127 130 (fontified t) 130 133 (face font-lock-keyword-face fontified t) 133 153 (fontified t) 153 160 (face font-lock-builtin-face fontified t) 160 169 (fontified t) 169 173 (face font-lock-keyword-face fontified t) 173 188 (fontified t) 188 201 (face font-lock-keyword-face fontified t) 201 211 (fontified t) 211 214 (face font-lock-keyword-face fontified t) 214 237 (fontified t) 237 246 (face font-lock-builtin-face fontified t) 246 263 (fontified t) 263 267 (face font-lock-builtin-face fontified t) 267 312 (fontified t) 312 316 (face font-lock-builtin-face fontified t) 316 398 (fontified t) 398 492 (face font-lock-string-face fontified t) 492 541 (fontified t) 541 551 (face font-lock-builtin-face fontified t) 551 713 (fontified t)) . -2616) (undo-tree-id73 . -713) 3329) nil (26977 17837 25940 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3641 . 3642) (nil fontified nil 3446 . 3642) (nil fontified nil 3340 . 3446) (nil fontified nil 3258 . 3340) (nil fontified nil 3257 . 3258) (nil fontified nil 3248 . 3257) (nil fontified nil 3244 . 3248) (nil fontified nil 3229 . 3244) (nil fontified nil 3225 . 3229) (nil fontified nil 3220 . 3225) (nil fontified nil 3204 . 3220) (nil fontified nil 3201 . 3204) (nil fontified nil 3084 . 3201) (nil fontified nil 3034 . 3084) (nil fontified nil 3020 . 3034) (nil fontified nil 3014 . 3020) (nil fontified nil 3011 . 3014) (nil fontified nil 3003 . 3011) (nil fontified nil 2996 . 3003) (nil fontified nil 2966 . 2996) (nil fontified nil 2956 . 2966) (nil fontified nil 2857 . 2956) (nil fontified nil 2848 . 2857) (nil fontified nil 2818 . 2848) (nil fontified nil 2763 . 2818) (nil fontified nil 2760 . 2763) (nil fontified nil 2748 . 2760) (nil fontified nil 2744 . 2748) (nil fontified nil 2725 . 2744) (nil fontified nil 2721 . 2725) (nil fontified nil 2696 . 2721) (nil fontified nil 2689 . 2696) (nil fontified nil 2673 . 2689) (nil fontified nil 2669 . 2673) (nil fontified nil 2637 . 2669) (nil fontified nil 2627 . 2637) (nil fontified nil 2626 . 2627) (nil fontified nil 2617 . 2626) (nil fontified nil 2616 . 2617) (2616 . 3642)) nil (26977 17837 25938 0) 0 nil])
([nil nil ((2561 . 2563) (#(" " 0 1 (fontified nil)) . 2560) (undo-tree-id72 . -1) (2561 . 2562)) nil (26977 17837 25934 0) 0 nil])
([nil nil ((2607 . 2609) (#(" " 0 1 (fontified nil)) . 2606) (undo-tree-id71 . -1) (2607 . 2608)) nil (26977 17837 25932 0) 0 nil])
([nil nil ((2496 . 2497)) nil (26977 17837 25931 0) 0 nil])
([nil nil ((2402 . 2404) (#(" " 0 1 (fontified nil)) . 2401) (undo-tree-id70 . -1) (2402 . 2403)) nil (26977 17837 25930 0) 0 nil])
([nil nil ((2426 . 2428) (#(" " 0 1 (fontified nil)) . 2425) (undo-tree-id69 . -1) (2426 . 2427)) nil (26977 17837 25929 0) 0 nil])
([nil nil ((2343 . 2344)) nil (26977 17837 25928 0) 0 nil])
([nil nil ((2493 . 2495) (#(" " 0 1 (fontified nil)) . 2492) (undo-tree-id68 . -1) (2493 . 2494)) nil (26977 17837 25927 0) 0 nil])
([nil nil ((2302 . 2304) (#(" " 0 1 (fontified nil)) . 2301) (undo-tree-id67 . -1) (2302 . 2303)) nil (26977 17837 25925 0) 0 nil])
([nil nil ((2337 . 2339) (#(" " 0 1 (fontified nil)) . 2336) (undo-tree-id66 . -1) (2337 . 2338)) nil (26977 17837 25924 0) 0 nil])
([nil nil ((#("

(defmethod repo-normalize :around ((op (eql :create)) (entity symbol) ctx payload)
  (let* ((p1 (%remove-protected-fields (%normalize-payload-keys (call-next-method))))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid (error 'lumen.data.errors:db-error :message \"missing tenant-id\"))
    (lumen.utils:alist-set p1 :tenant_id tid :test #'eq)))

(defmethod repo-normalize :around ((op (eql :patch)) (entity symbol) ctx payload)
  (let* ((p1 (%remove-protected-fields (%normalize-payload-keys (call-next-method op entity ctx payload))))
         (tid (%resolve-tenant-id ctx p1)))
    (unless tid (error 'lumen.data.errors:db-error :message \"missing tenant-id\"))
    (lumen.utils:alist-set p1 :tenant_id tid :test #'eq)))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 12 (fontified t face font-lock-keyword-face) 12 13 (fontified t) 13 27 (fontified t face font-lock-function-name-face) 27 28 (fontified t) 28 35 (fontified t face font-lock-builtin-face) 35 46 (fontified t) 46 53 (face font-lock-builtin-face fontified t) 53 88 (fontified t) 88 92 (face font-lock-keyword-face fontified t) 92 220 (fontified t) 220 226 (face font-lock-keyword-face fontified t) 226 232 (fontified t) 232 237 (face font-lock-warning-face fontified t) 237 266 (fontified t) 266 274 (face font-lock-builtin-face fontified t) 274 275 (fontified t) 275 294 (face font-lock-string-face fontified t) 294 297 (fontified t) 297 327 (fontified t) 327 337 (face font-lock-builtin-face fontified t) 337 342 (fontified t) 342 347 (face font-lock-builtin-face fontified t) 347 357 (fontified t) 357 358 (fontified t) 358 367 (face font-lock-keyword-face fontified t) 367 368 (fontified t) 368 382 (face font-lock-function-name-face fontified t) 382 383 (fontified t) 383 390 (face font-lock-builtin-face fontified t) 390 401 (fontified t) 401 407 (face font-lock-builtin-face fontified t) 407 442 (fontified t) 442 446 (face font-lock-keyword-face fontified t) 446 591 (fontified t) 591 596 (fontified t) 596 602 (face font-lock-keyword-face fontified t) 602 608 (fontified t) 608 613 (face font-lock-warning-face fontified t) 613 642 (fontified t) 642 650 (face font-lock-builtin-face fontified t) 650 651 (fontified t) 651 670 (face font-lock-string-face fontified t) 670 703 (fontified t) 703 713 (face font-lock-builtin-face fontified t) 713 718 (fontified t) 718 723 (face font-lock-builtin-face fontified t) 723 731 (fontified t)) . 7138) (undo-tree-id64 . -731) (undo-tree-id65 . -35)) nil (26977 17837 25922 0) 0 nil])
([nil nil ((13052 . 13054)) nil (26977 17837 25920 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14575 . 14576) (nil fontified nil 14563 . 14576) (nil fontified nil 14558 . 14563) (nil fontified nil 14553 . 14558) (nil fontified nil 14543 . 14553) (nil fontified nil 14513 . 14543) (nil fontified nil 14487 . 14513) (nil fontified nil 14485 . 14487) (nil fontified nil 14481 . 14485) (nil fontified nil 14460 . 14481) (nil fontified nil 14458 . 14460) (nil fontified nil 14454 . 14458) (nil fontified nil 14401 . 14454) (nil fontified nil 14398 . 14401) (nil fontified nil 14391 . 14398) (nil fontified nil 14361 . 14391) (nil fontified nil 14360 . 14361) (nil fontified nil 14352 . 14360) (nil fontified nil 14310 . 14352) (nil fontified nil 14305 . 14310) (nil fontified nil 14293 . 14305) (nil fontified nil 14287 . 14293) (nil fontified nil 14101 . 14287) (nil fontified nil 14097 . 14101) (nil fontified nil 14094 . 14097) (nil fontified nil 14093 . 14094) (nil fontified nil 14040 . 14093) (nil fontified nil 13961 . 14040) (nil fontified nil 13927 . 13961) (nil fontified nil 13921 . 13927) (nil fontified nil 13910 . 13921) (nil fontified nil 13903 . 13910) (nil fontified nil 13902 . 13903) (nil fontified nil 13888 . 13902) (nil fontified nil 13887 . 13888) (nil fontified nil 13878 . 13887) (nil fontified nil 13877 . 13878) (nil fontified nil 13867 . 13877) (nil fontified nil 13862 . 13867) (nil fontified nil 13857 . 13862) (nil fontified nil 13847 . 13857) (nil fontified nil 13817 . 13847) (nil fontified nil 13752 . 13817) (nil fontified nil 13749 . 13752) (nil fontified nil 13742 . 13749) (nil fontified nil 13712 . 13742) (nil fontified nil 13711 . 13712) (nil fontified nil 13703 . 13711) (nil fontified nil 13661 . 13703) (nil fontified nil 13656 . 13661) (nil fontified nil 13644 . 13656) (nil fontified nil 13638 . 13644) (nil fontified nil 13628 . 13638) (nil fontified nil 13590 . 13628) (nil fontified nil 13538 . 13590) (nil fontified nil 13506 . 13538) (nil fontified nil 13454 . 13506) (nil fontified nil 13422 . 13454) (nil fontified nil 13373 . 13422) (nil fontified nil 13345 . 13373) (nil fontified nil 13303 . 13345) (nil fontified nil 13299 . 13303) (nil fontified nil 13295 . 13299) (nil fontified nil 13139 . 13295) (nil fontified nil 13105 . 13139) (nil fontified nil 13098 . 13105) (nil fontified nil 13087 . 13098) (nil fontified nil 13080 . 13087) (nil fontified nil 13079 . 13080) (nil fontified nil 13065 . 13079) (nil fontified nil 13064 . 13065) (nil fontified nil 13055 . 13064) (nil fontified nil 13054 . 13055) (13054 . 14576)) nil (26977 17837 25918 0) 0 nil])
([nil nil ((1487 . 1489)) nil (26977 17837 25912 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1537 . 1538) (nil fontified nil 1493 . 1538) (nil fontified nil 1489 . 1493) (1489 . 1538)) nil (26977 17837 25911 0) 0 nil])
([nil nil ((1183 . 1185)) nil (26977 17837 25910 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1464 . 1465) (nil fontified nil 1298 . 1465) (nil fontified nil 1292 . 1298) (nil fontified nil 1238 . 1292) (nil fontified nil 1235 . 1238) (nil fontified nil 1212 . 1235) (nil fontified nil 1192 . 1212) (nil fontified nil 1191 . 1192) (nil fontified nil 1186 . 1191) (nil fontified nil 1185 . 1186) (1185 . 1465)) nil (26977 17837 25909 0) 0 nil])
([nil nil ((#("(defun %maybe-add-tenant-filter (filters tcol tid)
  (let ((flt (if (and (listp filters) (not (keywordp (car filters)))) filters (list filters))))
    (if (and tcol tid) (append flt (list (list '= tcol tid))) flt)))" 0 1 (fontified t) 1 6 (fontified t face font-lock-keyword-face) 6 7 (fontified t) 7 31 (fontified t face font-lock-function-name-face) 31 54 (fontified t) 54 57 (face font-lock-keyword-face fontified t) 57 65 (fontified t) 65 67 (face font-lock-keyword-face fontified t) 67 107 (fontified t) 107 147 (fontified t) 147 152 (fontified t) 152 154 (face font-lock-keyword-face fontified t) 154 215 (fontified t)) . -8168) (undo-tree-id62 . -31) (undo-tree-id63 . -215) 8383) nil (26977 17837 25908 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -8167) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) 8168) nil (26977 17837 25906 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 8167)) nil (26977 17837 25901 0) 0 nil])
([nil nil ((1465 . 1467)) nil (26977 17837 25901 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1769 . 1770) (nil fontified nil 1651 . 1770) (nil fontified nil 1649 . 1651) (nil fontified nil 1605 . 1649) (nil fontified nil 1602 . 1605) (nil fontified nil 1598 . 1602) (nil fontified nil 1520 . 1598) (nil fontified nil 1498 . 1520) (nil fontified nil 1474 . 1498) (nil fontified nil 1473 . 1474) (nil fontified nil 1468 . 1473) (nil fontified nil 1467 . 1468) (1467 . 1770)) nil (26977 17837 25900 0) 0 nil])
([nil nil ((#("(defun %kw (x) (etypecase x (keyword x) (symbol (intern (string-upcase (symbol-name x)) :keyword)) (string (intern (string-upcase x) :keyword))))

(defun %normalize-payload-keys (payload)
  (let ((ht (make-hash-table :test 'equal)))
    (dolist (kv payload) (setf (gethash (%kw (car kv)) ht) (cdr kv)))
    (let (out) (maphash (lambda (k v) (push (cons k v) out)) ht) (nreverse out))))

(defun %remove-protected-fields (payload &key (extra '()))
  (remove-if (lambda (kv) (member (car kv) (append '(:id :created_at :updated_at :lock_version) extra))) payload))

(defun %resolve-tenant-id (ctx payload)
  (or (getf ctx :tenant-id) (getf ctx :tenant_id) (lumen.utils:alist-get payload :tenant_id) (lumen.utils:alist-get payload :tenant-id)))

(defun %ensure-tenant-on-payload (entity ctx payload &key (op :create) (forbid-change-p t))
  \"Pour CREATE, injecte (tcol . tid) si absent.
   Pour PATCH, bloque (ou ignore) toute tentative de changer le tenant.\"
  (let* ((md   (entity-metadata entity))
         (tcol (%entity-tenant-col entity md))
         (tid  (getf ctx :tenant-id)))
    (cond
      ;; Pas de colonne tenant sur cette entité → payload inchangé
      ((null tcol) payload)

      ;; CREATE : si tenant présent dans ctx et absent dans payload → on l’injecte
      ((eq op :create)
       (cond
         ((null tid) payload) ; rien à injecter sans tenant courant
         ;; déjà au bon format (keyword)
         ((assoc tcol payload)
          (let ((v (cdr (assoc tcol payload))))
            (when (and v tid (string/= (string-downcase (princ-to-string v))
                                       (string-downcase (princ-to-string tid))))
              (error \"forbidden: tenant mismatch on create (~A ≠ ~A)\" v tid))
            payload))
         ;; présent sous forme string \"tenant_id\"
         ((assoc (string-downcase (symbol-name tcol)) payload :test #'string=)
          (let ((v (cdr (assoc (string-downcase (symbol-name tcol)) payload :test #'string=))))
            (when (and v tid (string/= (string-downcase (princ-to-string v))
                                       (string-downcase (princ-to-string tid))))
              (error \"forbidden: tenant mismatch on create (~A ≠ ~A)\" v tid))
            ;; on normalise en keyword
            (acons tcol (or v tid) (remove (string-downcase (symbol-name tcol)) payload
                                           :key #'car :test #'string=))))
         ;; absent → on injecte
         (t (acons tcol tid payload))))

      ;; PATCH : on empêche (par défaut) le changement de tenant
      ((eq op :patch)
       (let* ((kw-pair (assoc tcol payload))
              (str-key (string-downcase (symbol-name tcol)))
              (str-pair (assoc str-key payload :test #'string=)))
         (when (and forbid-change-p (or kw-pair str-pair))
           (let* ((newv (or (cdr kw-pair) (cdr str-pair)))
                  (curv tid))
             (when (and newv curv (string/= (string-downcase (princ-to-string newv))
                                             (string-downcase (princ-to-string curv))))
               (error \"forbidden: cannot change tenant on patch\"))))
         ;; on retire toute tentative de changer le tenant pour éviter une update inutile
         (remove tcol
                 (if str-pair
                     (remove str-key payload :key #'car :test #'string=)
                     payload)
                 :key #'car :test #'eq)))

      (t payload))))

(defun %entity-tenant-col (entity &optional md)
  \"Retourne la colonne tenant-id *si et seulement si* elle est déclarée ET présente dans :fields.\"
  (let* ((md     (or md (entity-metadata entity)))
         (fields (getf md :fields))
         (decl   (getf md :tenant-id-col)))
    (labels ((has-col-p (kw)
               (and kw (some (lambda (f) (eq (getf f :col) kw)) fields))))
      (cond
        ((and decl (has-col-p decl)) decl)          ; colonne explicitement déclarée et présente
        ((has-col-p :tenant_id) :tenant_id)         ; fallback si :tenant_id existe réellement
        (t nil)))))                                   ; sinon pas de colonne tenant
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 10 (face font-lock-function-name-face fontified t) 10 16 (fontified t) 16 25 (face font-lock-keyword-face fontified t) 25 88 (fontified t) 88 96 (face font-lock-builtin-face fontified t) 96 133 (fontified t) 133 141 (face font-lock-builtin-face fontified t) 141 147 (fontified t) 147 148 (fontified t) 148 153 (face font-lock-keyword-face fontified t) 153 154 (fontified t) 154 157 (face font-lock-function-name-face fontified t) 157 177 (face font-lock-function-name-face fontified t) 177 188 (fontified t) 188 191 (fontified t) 191 194 (face font-lock-keyword-face fontified t) 194 217 (fontified t) 217 222 (face font-lock-builtin-face fontified t) 222 237 (fontified t) 237 238 (fontified t) 238 244 (face font-lock-keyword-face fontified t) 244 303 (fontified t) 303 308 (fontified t) 308 311 (face font-lock-keyword-face fontified t) 311 314 (fontified t) 314 315 (fontified t) 315 328 (fontified t) 328 334 (face font-lock-keyword-face fontified t) 334 386 (fontified t) 386 387 (fontified t) 387 388 (fontified t) 388 393 (face font-lock-keyword-face fontified t) 393 394 (fontified t) 394 418 (face font-lock-function-name-face fontified t) 418 428 (fontified t) 428 432 (face font-lock-type-face fontified t) 432 437 (fontified t) 437 446 (fontified t) 446 460 (fontified t) 460 466 (face font-lock-keyword-face fontified t) 466 479 (fontified t) 479 499 (fontified t) 499 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 514 (face font-lock-builtin-face fontified t) 514 515 (fontified t) 515 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 540 (face font-lock-builtin-face fontified t) 540 561 (fontified t) 561 562 (fontified t) 562 563 (fontified t) 563 568 (face font-lock-keyword-face fontified t) 568 569 (fontified t) 569 587 (face font-lock-function-name-face fontified t) 587 602 (fontified t) 602 618 (fontified t) 618 628 (face font-lock-builtin-face fontified t) 628 632 (fontified t) 632 640 (fontified t) 640 650 (face font-lock-builtin-face fontified t) 650 683 (fontified t) 683 693 (face font-lock-builtin-face fontified t) 693 726 (fontified t) 726 736 (face font-lock-builtin-face fontified t) 736 740 (fontified t) 740 741 (fontified t) 741 742 (fontified t) 742 747 (face font-lock-keyword-face fontified t) 747 748 (fontified t) 748 773 (face font-lock-function-name-face fontified t) 773 794 (fontified t) 794 798 (face font-lock-type-face fontified t) 798 803 (fontified t) 803 810 (face font-lock-builtin-face fontified t) 810 829 (fontified t) 829 833 (fontified t) 833 835 (fontified t) 835 953 (face font-lock-doc-face fontified t) 953 957 (fontified t) 957 961 (face font-lock-keyword-face fontified t) 961 1067 (fontified t) 1067 1077 (face font-lock-builtin-face fontified t) 1077 1086 (fontified t) 1086 1090 (face font-lock-keyword-face fontified t) 1090 1097 (fontified t) 1097 1100 (face font-lock-comment-delimiter-face fontified t) 1100 1131 (face font-lock-comment-face fontified t) 1131 1158 (face font-lock-comment-face fontified t) 1158 1193 (fontified t) 1193 1196 (face font-lock-comment-delimiter-face fontified t) 1196 1270 (face font-lock-comment-face fontified t) 1270 1284 (fontified t) 1284 1291 (face font-lock-builtin-face fontified t) 1291 1301 (fontified t) 1301 1305 (face font-lock-keyword-face fontified t) 1305 1336 (fontified t) 1336 1374 (face font-lock-comment-face fontified t) 1374 1383 (fontified t) 1383 1386 (face font-lock-comment-delimiter-face fontified t) 1386 1415 (face font-lock-comment-face fontified t) 1415 1457 (fontified t) 1457 1460 (face font-lock-keyword-face fontified t) 1460 1465 (fontified t) 1465 1494 (fontified t) 1494 1507 (fontified t) 1507 1511 (face font-lock-keyword-face fontified t) 1511 1667 (fontified t) 1667 1672 (face font-lock-warning-face fontified t) 1672 1673 (fontified t) 1673 1721 (face font-lock-string-face fontified t) 1721 1761 (fontified t) 1761 1764 (face font-lock-comment-delimiter-face fontified t) 1764 1802 (face font-lock-comment-face fontified t) 1802 1864 (fontified t) 1864 1869 (face font-lock-builtin-face fontified t) 1869 1892 (fontified t) 1892 1895 (face font-lock-keyword-face fontified t) 1895 1957 (fontified t) 1957 1962 (face font-lock-builtin-face fontified t) 1962 1990 (fontified t) 1990 1994 (face font-lock-keyword-face fontified t) 1994 2150 (fontified t) 2150 2155 (face font-lock-warning-face fontified t) 2155 2156 (fontified t) 2156 2204 (face font-lock-string-face fontified t) 2204 2225 (fontified t) 2225 2228 (face font-lock-comment-delimiter-face fontified t) 2228 2241 (face font-lock-comment-face fontified t) 2241 2252 (face font-lock-comment-face fontified t) 2252 2273 (fontified t) 2273 2333 (fontified t) 2333 2340 (fontified t) 2340 2383 (fontified t) 2383 2387 (face font-lock-builtin-face fontified t) 2387 2394 (fontified t) 2394 2399 (face font-lock-builtin-face fontified t) 2399 2423 (fontified t) 2423 2426 (face font-lock-comment-delimiter-face fontified t) 2426 2446 (face font-lock-comment-face fontified t) 2446 2493 (fontified t) 2493 2496 (face font-lock-comment-delimiter-face fontified t) 2496 2552 (face font-lock-comment-face fontified t) 2552 2566 (fontified t) 2566 2572 (face font-lock-builtin-face fontified t) 2572 2582 (fontified t) 2582 2586 (face font-lock-keyword-face fontified t) 2586 2619 (fontified t) 2619 2658 (fontified t) 2658 2680 (fontified t) 2680 2727 (fontified t) 2727 2732 (face font-lock-builtin-face fontified t) 2732 2756 (fontified t) 2756 2760 (face font-lock-keyword-face fontified t) 2760 2817 (fontified t) 2817 2821 (face font-lock-keyword-face fontified t) 2821 2908 (fontified t) 2908 2912 (face font-lock-keyword-face fontified t) 2912 3083 (fontified t) 3083 3088 (face font-lock-warning-face fontified t) 3088 3089 (fontified t) 3089 3131 (face font-lock-string-face fontified t) 3131 3145 (fontified t) 3145 3148 (face font-lock-comment-delimiter-face fontified t) 3148 3226 (face font-lock-comment-face fontified t) 3226 3266 (fontified t) 3266 3268 (face font-lock-keyword-face fontified t) 3268 3323 (fontified t) 3323 3327 (face font-lock-builtin-face fontified t) 3327 3334 (fontified t) 3334 3339 (face font-lock-builtin-face fontified t) 3339 3381 (fontified t) 3381 3398 (fontified t) 3398 3402 (face font-lock-builtin-face fontified t) 3402 3409 (fontified t) 3409 3414 (face font-lock-builtin-face fontified t) 3414 3424 (fontified t) 3424 3444 (fontified t) 3444 3445 (fontified t) 3445 3446 (fontified t) 3446 3447 (fontified t) 3447 3452 (face font-lock-keyword-face fontified t) 3452 3453 (fontified t) 3453 3471 (face font-lock-function-name-face fontified t) 3471 3480 (fontified t) 3480 3489 (face font-lock-type-face fontified t) 3489 3496 (fontified t) 3496 3592 (face font-lock-doc-face fontified t) 3592 3596 (fontified t) 3596 3600 (face font-lock-keyword-face fontified t) 3600 3670 (fontified t) 3670 3677 (face font-lock-builtin-face fontified t) 3677 3706 (fontified t) 3706 3720 (face font-lock-builtin-face fontified t) 3720 3729 (fontified t) 3729 3735 (face font-lock-keyword-face fontified t) 3735 3783 (fontified t) 3783 3789 (face font-lock-keyword-face fontified t) 3789 3806 (fontified t) 3806 3810 (face font-lock-builtin-face fontified t) 3810 3835 (fontified t) 3835 3839 (face font-lock-keyword-face fontified t) 3839 3840 (fontified t) 3840 3892 (fontified t) 3892 3937 (face font-lock-comment-face fontified t) 3937 3957 (fontified t) 3957 3967 (face font-lock-builtin-face fontified t) 3967 3969 (fontified t) 3969 3979 (face font-lock-builtin-face fontified t) 3979 3989 (fontified t) 3989 4032 (face font-lock-comment-face fontified t) 4032 4086 (fontified t) 4086 4114 (face font-lock-comment-face fontified t) 4114 4115 (face font-lock-comment-face fontified t rear-nonsticky t) 4115 4116 (face font-lock-comment-face fontified t)) . 4332) (undo-tree-id57 . -4116) (undo-tree-id58 . -3136) 8448) nil (26977 17837 25898 0) 0 nil])
([nil nil ((1770 . 1772)) nil (26977 17837 25896 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5887 . 5888) (nil fontified nil 5887 . 5888) (nil fontified nil 5886 . 5887) (nil fontified nil 5858 . 5886) (nil fontified nil 5804 . 5858) (nil fontified nil 5761 . 5804) (nil fontified nil 5751 . 5761) (nil fontified nil 5741 . 5751) (nil fontified nil 5739 . 5741) (nil fontified nil 5729 . 5739) (nil fontified nil 5709 . 5729) (nil fontified nil 5664 . 5709) (nil fontified nil 5612 . 5664) (nil fontified nil 5611 . 5612) (nil fontified nil 5607 . 5611) (nil fontified nil 5582 . 5607) (nil fontified nil 5578 . 5582) (nil fontified nil 5561 . 5578) (nil fontified nil 5555 . 5561) (nil fontified nil 5507 . 5555) (nil fontified nil 5501 . 5507) (nil fontified nil 5492 . 5501) (nil fontified nil 5478 . 5492) (nil fontified nil 5449 . 5478) (nil fontified nil 5442 . 5449) (nil fontified nil 5372 . 5442) (nil fontified nil 5368 . 5372) (nil fontified nil 5364 . 5368) (nil fontified nil 5268 . 5364) (nil fontified nil 5261 . 5268) (nil fontified nil 5252 . 5261) (nil fontified nil 5243 . 5252) (nil fontified nil 5225 . 5243) (nil fontified nil 5224 . 5225) (nil fontified nil 5219 . 5224) (nil fontified nil 5218 . 5219) (nil fontified nil 5217 . 5218) (nil fontified nil 5216 . 5217) (nil fontified nil 5196 . 5216) (nil fontified nil 5186 . 5196) (nil fontified nil 5181 . 5186) (nil fontified nil 5174 . 5181) (nil fontified nil 5170 . 5174) (nil fontified nil 5153 . 5170) (nil fontified nil 5111 . 5153) (nil fontified nil 5106 . 5111) (nil fontified nil 5099 . 5106) (nil fontified nil 5095 . 5099) (nil fontified nil 5040 . 5095) (nil fontified nil 5038 . 5040) (nil fontified nil 4998 . 5038) (nil fontified nil 4920 . 4998) (nil fontified nil 4917 . 4920) (nil fontified nil 4903 . 4917) (nil fontified nil 4861 . 4903) (nil fontified nil 4860 . 4861) (nil fontified nil 4855 . 4860) (nil fontified nil 4684 . 4855) (nil fontified nil 4680 . 4684) (nil fontified nil 4593 . 4680) (nil fontified nil 4589 . 4593) (nil fontified nil 4532 . 4589) (nil fontified nil 4528 . 4532) (nil fontified nil 4504 . 4528) (nil fontified nil 4499 . 4504) (nil fontified nil 4452 . 4499) (nil fontified nil 4430 . 4452) (nil fontified nil 4391 . 4430) (nil fontified nil 4358 . 4391) (nil fontified nil 4354 . 4358) (nil fontified nil 4344 . 4354) (nil fontified nil 4338 . 4344) (nil fontified nil 4324 . 4338) (nil fontified nil 4268 . 4324) (nil fontified nil 4265 . 4268) (nil fontified nil 4218 . 4265) (nil fontified nil 4198 . 4218) (nil fontified nil 4195 . 4198) (nil fontified nil 4171 . 4195) (nil fontified nil 4166 . 4171) (nil fontified nil 4159 . 4166) (nil fontified nil 4155 . 4159) (nil fontified nil 4112 . 4155) (nil fontified nil 4105 . 4112) (nil fontified nil 4045 . 4105) (nil fontified nil 4024 . 4045) (nil fontified nil 4013 . 4024) (nil fontified nil 4000 . 4013) (nil fontified nil 3997 . 4000) (nil fontified nil 3976 . 3997) (nil fontified nil 3928 . 3976) (nil fontified nil 3927 . 3928) (nil fontified nil 3922 . 3927) (nil fontified nil 3766 . 3922) (nil fontified nil 3762 . 3766) (nil fontified nil 3734 . 3762) (nil fontified nil 3729 . 3734) (nil fontified nil 3667 . 3729) (nil fontified nil 3664 . 3667) (nil fontified nil 3641 . 3664) (nil fontified nil 3636 . 3641) (nil fontified nil 3574 . 3636) (nil fontified nil 3536 . 3574) (nil fontified nil 3533 . 3536) (nil fontified nil 3493 . 3533) (nil fontified nil 3445 . 3493) (nil fontified nil 3444 . 3445) (nil fontified nil 3439 . 3444) (nil fontified nil 3283 . 3439) (nil fontified nil 3279 . 3283) (nil fontified nil 3266 . 3279) (nil fontified nil 3237 . 3266) (nil fontified nil 3232 . 3237) (nil fontified nil 3229 . 3232) (nil fontified nil 3187 . 3229) (nil fontified nil 3158 . 3187) (nil fontified nil 3155 . 3158) (nil fontified nil 3146 . 3155) (nil fontified nil 3108 . 3146) (nil fontified nil 3077 . 3108) (nil fontified nil 3073 . 3077) (nil fontified nil 3063 . 3073) (nil fontified nil 3056 . 3063) (nil fontified nil 3042 . 3056) (nil fontified nil 2968 . 3042) (nil fontified nil 2965 . 2968) (nil fontified nil 2930 . 2965) (nil fontified nil 2903 . 2930) (nil fontified nil 2872 . 2903) (nil fontified nil 2869 . 2872) (nil fontified nil 2862 . 2869) (nil fontified nil 2858 . 2862) (nil fontified nil 2849 . 2858) (nil fontified nil 2839 . 2849) (nil fontified nil 2733 . 2839) (nil fontified nil 2729 . 2733) (nil fontified nil 2725 . 2729) (nil fontified nil 2607 . 2725) (nil fontified nil 2605 . 2607) (nil fontified nil 2601 . 2605) (nil fontified nil 2582 . 2601) (nil fontified nil 2575 . 2582) (nil fontified nil 2570 . 2575) (nil fontified nil 2566 . 2570) (nil fontified nil 2545 . 2566) (nil fontified nil 2520 . 2545) (nil fontified nil 2519 . 2520) (nil fontified nil 2514 . 2519) (nil fontified nil 2513 . 2514) (nil fontified nil 2512 . 2513) (nil fontified nil 2508 . 2512) (nil fontified nil 2498 . 2508) (nil fontified nil 2465 . 2498) (nil fontified nil 2455 . 2465) (nil fontified nil 2422 . 2455) (nil fontified nil 2412 . 2422) (nil fontified nil 2404 . 2412) (nil fontified nil 2400 . 2404) (nil fontified nil 2390 . 2400) (nil fontified nil 2374 . 2390) (nil fontified nil 2359 . 2374) (nil fontified nil 2341 . 2359) (nil fontified nil 2340 . 2341) (nil fontified nil 2335 . 2340) (nil fontified nil 2334 . 2335) (nil fontified nil 2333 . 2334) (nil fontified nil 2312 . 2333) (nil fontified nil 2299 . 2312) (nil fontified nil 2298 . 2299) (nil fontified nil 2287 . 2298) (nil fontified nil 2286 . 2287) (nil fontified nil 2275 . 2286) (nil fontified nil 2274 . 2275) (nil fontified nil 2271 . 2274) (nil fontified nil 2251 . 2271) (nil fontified nil 2238 . 2251) (nil fontified nil 2232 . 2238) (nil fontified nil 2218 . 2232) (nil fontified nil 2209 . 2218) (nil fontified nil 2204 . 2209) (nil fontified nil 2200 . 2204) (nil fontified nil 2190 . 2200) (nil fontified nil 2166 . 2190) (nil fontified nil 2165 . 2166) (nil fontified nil 2160 . 2165) (nil fontified nil 2159 . 2160) (nil fontified nil 2158 . 2159) (nil fontified nil 2106 . 2158) (nil fontified nil 2100 . 2106) (nil fontified nil 2087 . 2100) (nil fontified nil 2086 . 2087) (nil fontified nil 2083 . 2086) (nil fontified nil 2080 . 2083) (nil fontified nil 2075 . 2080) (nil fontified nil 2016 . 2075) (nil fontified nil 2010 . 2016) (nil fontified nil 2009 . 2010) (nil fontified nil 1994 . 2009) (nil fontified nil 1989 . 1994) (nil fontified nil 1966 . 1989) (nil fontified nil 1963 . 1966) (nil fontified nil 1960 . 1963) (nil fontified nil 1949 . 1960) (nil fontified nil 1929 . 1949) (nil fontified nil 1926 . 1929) (nil fontified nil 1925 . 1926) (nil fontified nil 1920 . 1925) (nil fontified nil 1919 . 1920) (nil fontified nil 1913 . 1919) (nil fontified nil 1905 . 1913) (nil fontified nil 1868 . 1905) (nil fontified nil 1860 . 1868) (nil fontified nil 1797 . 1860) (nil fontified nil 1788 . 1797) (nil fontified nil 1782 . 1788) (nil fontified nil 1779 . 1782) (nil fontified nil 1778 . 1779) (nil fontified nil 1773 . 1778) (nil fontified nil 1772 . 1773) (1772 . 5888)) nil (26977 17837 25891 0) 0 nil])
([nil nil ((5216 . 5218)) nil (26977 17837 25872 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6300 . 6301) (nil fontified nil 6293 . 6301) (nil fontified nil 6288 . 6293) (nil fontified nil 6232 . 6288) (nil fontified nil 6185 . 6232) (nil fontified nil 5996 . 6185) (nil fontified nil 5974 . 5996) (nil fontified nil 5970 . 5974) (nil fontified nil 5953 . 5970) (nil fontified nil 5952 . 5953) (nil fontified nil 5947 . 5952) (nil fontified nil 5838 . 5947) (nil fontified nil 5825 . 5838) (nil fontified nil 5796 . 5825) (nil fontified nil 5739 . 5796) (nil fontified nil 5736 . 5739) (nil fontified nil 5622 . 5736) (nil fontified nil 5619 . 5622) (nil fontified nil 5617 . 5619) (nil fontified nil 5605 . 5617) (nil fontified nil 5539 . 5605) (nil fontified nil 5532 . 5539) (nil fontified nil 5464 . 5532) (nil fontified nil 5460 . 5464) (nil fontified nil 5456 . 5460) (nil fontified nil 5303 . 5456) (nil fontified nil 5257 . 5303) (nil fontified nil 5253 . 5257) (nil fontified nil 5244 . 5253) (nil fontified nil 5225 . 5244) (nil fontified nil 5224 . 5225) (nil fontified nil 5219 . 5224) (nil fontified nil 5218 . 5219) (5218 . 6301)) nil (26977 17837 25871 0) 0 nil])
([nil nil ((#("(defun %ensure-filter-list (f)
  \"Normalise :filters en liste de clauses (AND implicite).
   Accepte NIL, une seule clause, une liste de clauses, ou (:AND ...).\"
  (cond
    ((null f) '())
    ;; (:AND ...) ou (and ...) → on prend le reste
    ((and (listp f) (member (first f) '(and :AND))) (rest f))
    ;; déjà une liste de clauses ? on suppose oui
    ((and (listp f) (every #'listp f)) f)
    ;; une seule clause
    (t (list f))))

(defun %tenant-filter-clause (tid)
  (when tid (list '= :tenant_id tid)))
" 0 1 (fontified t) 1 6 (fontified t face font-lock-keyword-face) 6 7 (fontified t) 7 26 (fontified t face font-lock-function-name-face) 26 33 (fontified t) 33 161 (face font-lock-doc-face fontified t) 161 165 (fontified t) 165 169 (face font-lock-keyword-face fontified t) 169 193 (fontified t) 193 196 (face font-lock-comment-delimiter-face fontified t) 196 197 (face font-lock-comment-face fontified t) 197 240 (face font-lock-comment-face fontified t) 240 284 (fontified t) 284 288 (face font-lock-builtin-face fontified t) 288 306 (fontified t) 306 309 (face font-lock-comment-delimiter-face fontified t) 309 352 (face font-lock-comment-face fontified t) 352 398 (fontified t) 398 401 (face font-lock-comment-delimiter-face fontified t) 401 418 (face font-lock-comment-face fontified t) 418 438 (fontified t) 438 439 (fontified t) 439 444 (face font-lock-keyword-face fontified t) 444 445 (fontified t) 445 466 (face font-lock-function-name-face fontified t) 466 473 (fontified t) 473 476 (fontified t) 476 480 (face font-lock-keyword-face fontified t) 480 494 (fontified t) 494 504 (face font-lock-builtin-face fontified t) 504 512 (fontified t)) . 14049) (undo-tree-id56 . -512) 14561) nil (26977 17837 25867 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -14048) (undo-tree-id54 . -1) (undo-tree-id55 . -1) 14049) nil (26977 17837 25866 0) 0 nil])
([nil nil ((6973 . 6974)) nil (26977 17837 25864 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7485 . 7486) (nil fontified nil 7478 . 7486) (nil fontified nil 7468 . 7478) (nil fontified nil 7454 . 7468) (nil fontified nil 7450 . 7454) (nil fontified nil 7447 . 7450) (nil fontified nil 7440 . 7447) (nil fontified nil 7419 . 7440) (nil fontified nil 7418 . 7419) (nil fontified nil 7413 . 7418) (nil fontified nil 7412 . 7413) (nil fontified nil 7392 . 7412) (nil fontified nil 7375 . 7392) (nil fontified nil 7372 . 7375) (nil fontified nil 7326 . 7372) (nil fontified nil 7283 . 7326) (nil fontified nil 7280 . 7283) (nil fontified nil 7262 . 7280) (nil fontified nil 7258 . 7262) (nil fontified nil 7214 . 7258) (nil fontified nil 7171 . 7214) (nil fontified nil 7170 . 7171) (nil fontified nil 7167 . 7170) (nil fontified nil 7143 . 7167) (nil fontified nil 7139 . 7143) (nil fontified nil 7135 . 7139) (nil fontified nil 7007 . 7135) (nil fontified nil 7000 . 7007) (nil fontified nil 6981 . 7000) (nil fontified nil 6980 . 6981) (nil fontified nil 6975 . 6980) (nil fontified nil 6974 . 6975) (6974 . 7486)) nil (26977 17837 25862 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -7485) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) 7486) nil (26977 17837 26041 0) 0 nil])
([nil nil ((#("(defmacro %with-write-tx (&body body) `(lumen.data.db:with-tx () ,@body))

;; Helper pour traiter le résultat de run-in-transaction
(defun %handle-tx-result (result)
  (if (and (consp result) (keywordp (car result)))
      (case (car result)
        ;; On déstructure la liste (:business-error \"msg\" 422)
        (:business-error 
         (destructuring-bind (_ msg code) result
           (declare (ignore _))
	   (format t \"~&[REPO DEBUG:%HANDLE-TX-RESULT] Error Response Code : ~A\" code)
           ;; On recrée une application-error propre pour Mount-CRUD!
           (error 'lumen.core.error:application-error 
                  :message msg 
                  :code (or code 400))))
        
        (:fatal-error
         (destructuring-bind (_ msg) result
           (declare (ignore _))
           (error \"Database Error: ~A\" msg)))
        
        (t result))
      result))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 24 (face font-lock-function-name-face fontified t) 24 26 (fontified t) 26 31 (face font-lock-type-face fontified t) 31 40 (fontified t) 40 61 (face font-lock-keyword-face fontified t) 61 74 (fontified t) 74 75 (fontified t) 75 78 (face font-lock-comment-delimiter-face fontified t) 78 132 (face font-lock-comment-face fontified t) 132 133 (fontified t) 133 138 (face font-lock-keyword-face fontified t) 138 139 (fontified t) 139 156 (face font-lock-function-name-face fontified t) 156 169 (fontified t) 169 171 (face font-lock-keyword-face fontified t) 171 224 (fontified t) 224 228 (face font-lock-keyword-face fontified t) 228 250 (fontified t) 250 253 (face font-lock-comment-delimiter-face fontified t) 253 305 (face font-lock-comment-face fontified t) 305 314 (fontified t) 314 329 (face font-lock-builtin-face fontified t) 329 341 (fontified t) 341 359 (face font-lock-keyword-face fontified t) 359 380 (fontified t) 380 392 (fontified t) 392 399 (face font-lock-keyword-face fontified t) 399 412 (fontified t) 412 416 (fontified t) 416 426 (fontified t) 426 441 (face font-lock-string-face fontified t) 441 457 (face font-lock-string-face fontified t) 457 458 (face font-lock-string-face fontified t rear-nonsticky t) 458 485 (face font-lock-string-face fontified t) 485 491 (fontified t) 491 492 (fontified t) 492 503 (fontified t) 503 506 (face font-lock-comment-delimiter-face fontified t) 506 549 (face font-lock-comment-face fontified t) 549 550 (face font-lock-comment-face fontified t) 550 562 (face font-lock-comment-face fontified t) 562 574 (fontified t) 574 579 (face font-lock-warning-face fontified t) 579 635 (fontified t) 635 643 (face font-lock-builtin-face fontified t) 643 667 (fontified t) 667 672 (face font-lock-builtin-face fontified t) 672 708 (fontified t) 708 720 (face font-lock-builtin-face fontified t) 720 731 (fontified t) 731 749 (face font-lock-keyword-face fontified t) 749 777 (fontified t) 777 784 (face font-lock-keyword-face fontified t) 784 809 (fontified t) 809 814 (face font-lock-warning-face fontified t) 814 815 (fontified t) 815 835 (face font-lock-string-face fontified t) 835 868 (fontified t) 868 872 (fontified t) 872 885 (fontified t) 885 886 (fontified t rear-nonsticky t)) . 13673) (undo-tree-id91 . -886) (undo-tree-id92 . -491)) nil (26977 18079 275246 0) 0 nil] [nil nil ((#("(defmacro %with-write-tx (&body body) `(lumen.data.db:with-tx () ,@body))

;; Helper pour traiter le résultat de run-in-transaction
(defun %handle-tx-result (result)
  (if (and (consp result) (keywordp (car result)))
      (case (car result)
        ;; On déstructure la liste (:business-error \"msg\" 422)
        (:business-error 
         (destructuring-bind (_ msg code) result
           (declare (ignore _))
	   (format t \"~&[REPO DEBUG:%HANDLE-TX-RESULT] Error Response Code : ~A\" code)
           ;; On recrée une application-error propre pour Mount-CRUD!
           (error 'lumen.core.error:application-error 
                  :message msg 
                  :code (or code 400))))
        
        (:fatal-error
         (destructuring-bind (_ msg) result
           (declare (ignore _))
           (error \"Database Error: ~A\" msg)))
        
        (t resul" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 24 (face font-lock-function-name-face fontified t) 24 26 (fontified t) 26 31 (face font-lock-type-face fontified t) 31 40 (fontified t) 40 61 (face font-lock-keyword-face fontified t) 61 74 (fontified t) 74 75 (fontified t) 75 78 (face font-lock-comment-delimiter-face fontified t) 78 132 (face font-lock-comment-face fontified t) 132 133 (fontified t) 133 138 (face font-lock-keyword-face fontified t) 138 139 (fontified t) 139 156 (face font-lock-function-name-face fontified t) 156 169 (fontified t) 169 171 (face font-lock-keyword-face fontified t) 171 224 (fontified t) 224 228 (face font-lock-keyword-face fontified t) 228 250 (fontified t) 250 253 (face font-lock-comment-delimiter-face fontified t) 253 305 (face font-lock-comment-face fontified t) 305 314 (fontified t) 314 329 (face font-lock-builtin-face fontified t) 329 341 (fontified t) 341 359 (face font-lock-keyword-face fontified t) 359 380 (fontified t) 380 392 (fontified t) 392 399 (face font-lock-keyword-face fontified t) 399 412 (fontified t) 412 416 (fontified t) 416 426 (fontified t) 426 441 (face font-lock-string-face fontified t) 441 457 (face font-lock-string-face fontified t) 457 458 (face font-lock-string-face fontified t rear-nonsticky t) 458 485 (face font-lock-string-face fontified t) 485 491 (fontified t) 491 492 (fontified t) 492 503 (fontified t) 503 506 (face font-lock-comment-delimiter-face fontified t) 506 549 (face font-lock-comment-face fontified t) 549 550 (face font-lock-comment-face fontified t) 550 562 (face font-lock-comment-face fontified t) 562 574 (fontified t) 574 579 (face font-lock-warning-face fontified t) 579 635 (fontified t) 635 643 (face font-lock-builtin-face fontified t) 643 667 (fontified t) 667 672 (face font-lock-builtin-face fontified t) 672 708 (fontified t) 708 720 (face font-lock-builtin-face fontified t) 720 731 (fontified t) 731 749 (face font-lock-keyword-face fontified t) 749 777 (fontified t) 777 784 (face font-lock-keyword-face fontified t) 784 809 (fontified t) 809 814 (face font-lock-warning-face fontified t) 814 815 (fontified t) 815 835 (face font-lock-string-face fontified t) 835 868 (fontified t)) . 13673) (undo-tree-id44 . -868) (undo-tree-id45 . -491) (undo-tree-id46 . -331) (undo-tree-id47 . -868) (undo-tree-id48 . -868) (undo-tree-id49 . -868) (undo-tree-id50 . -868)) ((13673 . 14541)) (26977 17837 25851 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -13672) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) 13673) nil (26977 18079 275243 0) 0 nil])
nil
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 13672)) nil (26977 18079 275240 0) 0 nil])
([nil nil ((7485 . 7487)) nil (26977 18079 275240 0) 0 nil])
([nil nil ((nil fontified nil 8372 . 8373) (nil fontified nil 8359 . 8372) (nil fontified nil 8355 . 8359) (nil fontified nil 8322 . 8355) (nil fontified nil 8302 . 8322) (nil fontified nil 8301 . 8302) (nil fontified nil 8296 . 8301) (nil fontified nil 8271 . 8296) (nil fontified nil 8264 . 8271) (nil fontified nil 8236 . 8264) (nil fontified nil 8218 . 8236) (nil fontified nil 8207 . 8218) (nil fontified nil 8195 . 8207) (nil fontified nil 8159 . 8195) (nil fontified nil 8154 . 8159) (nil fontified nil 8130 . 8154) (nil fontified nil 8122 . 8130) (nil fontified nil 8066 . 8122) (nil fontified nil 8061 . 8066) (nil fontified nil 8049 . 8061) (nil fontified nil 8037 . 8049) (nil fontified nil 8036 . 8037) (nil fontified nil 7993 . 8036) (nil fontified nil 7990 . 7993) (nil fontified nil 7979 . 7990) (nil fontified nil 7978 . 7979) (nil fontified nil 7972 . 7978) (nil fontified nil 7945 . 7972) (nil fontified nil 7944 . 7945) (nil fontified nil 7928 . 7944) (nil fontified nil 7913 . 7928) (nil fontified nil 7903 . 7913) (nil fontified nil 7899 . 7903) (nil fontified nil 7886 . 7899) (nil fontified nil 7879 . 7886) (nil fontified nil 7867 . 7879) (nil fontified nil 7846 . 7867) (nil fontified nil 7828 . 7846) (nil fontified nil 7816 . 7828) (nil fontified nil 7801 . 7816) (nil fontified nil 7792 . 7801) (nil fontified nil 7740 . 7792) (nil fontified nil 7737 . 7740) (nil fontified nil 7715 . 7737) (nil fontified nil 7711 . 7715) (nil fontified nil 7658 . 7711) (nil fontified nil 7656 . 7658) (nil fontified nil 7643 . 7656) (nil fontified nil 7626 . 7643) (nil fontified nil 7625 . 7626) (nil fontified nil 7620 . 7625) (nil fontified nil 7619 . 7620) (nil fontified nil 7565 . 7619) (nil fontified nil 7562 . 7565) (nil fontified nil 7561 . 7562) (nil fontified nil 7548 . 7561) (nil fontified nil 7527 . 7548) (nil fontified nil 7518 . 7527) (nil fontified nil 7513 . 7518) (nil fontified nil 7511 . 7513) (nil fontified nil 7497 . 7511) (nil fontified nil 7496 . 7497) (nil fontified nil 7488 . 7496) (nil fontified nil 7487 . 7488) (7487 . 8373)) nil (26977 18079 275238 0) 0 nil])
([nil nil ((#("(defun %kw (x) (etypecase x (keyword x) (symbol (intern (string-upcase (symbol-name x)) :keyword)) (string (intern (string-upcase x) :keyword))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 10 (face font-lock-function-name-face fontified t) 10 16 (fontified t) 16 25 (face font-lock-keyword-face fontified t) 25 88 (fontified t) 88 96 (face font-lock-builtin-face fontified t) 96 133 (fontified t) 133 141 (face font-lock-builtin-face fontified t) 141 145 (fontified t)) . -1772) (undo-tree-id86 . -10) (undo-tree-id87 . -145) 1917) nil (26977 18079 275231 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1932 . 1933) (nil fontified nil 1929 . 1933) (nil fontified nil 1921 . 1929) (nil fontified nil 1879 . 1921) (nil fontified nil 1871 . 1879) (nil fontified nil 1799 . 1871) (nil fontified nil 1790 . 1799) (nil fontified nil 1782 . 1790) (nil fontified nil 1779 . 1782) (nil fontified nil 1778 . 1779) (nil fontified nil 1773 . 1778) (nil fontified nil 1772 . 1773) (1772 . 1933)) nil (26977 18079 275229 0) 0 nil])
([nil nil ((#("(defun %resolve-tenant-id (ctx payload)
  (or (getf ctx :tenant-id) (getf ctx :tenant_id) (lumen.utils:alist-get payload :tenant_id) (lumen.utils:alist-get payload :tenant-id)))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 40 (fontified t) 40 56 (fontified t) 56 66 (face font-lock-builtin-face fontified t) 66 70 (fontified t) 70 78 (fontified t) 78 88 (face font-lock-builtin-face fontified t) 88 121 (fontified t) 121 131 (face font-lock-builtin-face fontified t) 131 164 (fontified t) 164 174 (face font-lock-builtin-face fontified t) 174 177 (fontified t)) . -2350) (undo-tree-id85 . -177) 2527) nil (26977 18079 275227 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3099 . 3100) (nil fontified nil 2959 . 3100) (nil fontified nil 2952 . 2959) (nil fontified nil 2942 . 2952) (nil fontified nil 2936 . 2942) (nil fontified nil 2829 . 2936) (nil fontified nil 2817 . 2829) (nil fontified nil 2803 . 2817) (nil fontified nil 2779 . 2803) (nil fontified nil 2776 . 2779) (nil fontified nil 2646 . 2776) (nil fontified nil 2605 . 2646) (nil fontified nil 2601 . 2605) (nil fontified nil 2572 . 2601) (nil fontified nil 2562 . 2572) (nil fontified nil 2523 . 2562) (nil fontified nil 2521 . 2523) (nil fontified nil 2511 . 2521) (nil fontified nil 2495 . 2511) (nil fontified nil 2454 . 2495) (nil fontified nil 2444 . 2454) (nil fontified nil 2432 . 2444) (nil fontified nil 2422 . 2432) (nil fontified nil 2397 . 2422) (nil fontified nil 2393 . 2397) (nil fontified nil 2375 . 2393) (nil fontified nil 2357 . 2375) (nil fontified nil 2356 . 2357) (nil fontified nil 2351 . 2356) (nil fontified nil 2350 . 2351) (2350 . 3100)) nil (26977 18079 275225 0) 0 nil])
([nil nil ((2349 . 2350)) nil (26977 18079 275222 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2630 . 2631) (nil fontified nil 2571 . 2631) (nil fontified nil 2567 . 2571) (nil fontified nil 2560 . 2567) (nil fontified nil 2496 . 2560) (nil fontified nil 2490 . 2496) (nil fontified nil 2446 . 2490) (nil fontified nil 2440 . 2446) (nil fontified nil 2419 . 2440) (nil fontified nil 2415 . 2419) (nil fontified nil 2354 . 2415) (nil fontified nil 2350 . 2354) (2350 . 2631)) nil (26977 18079 275221 0) 0 nil])
([nil nil ((2349 . 2350)) nil (26977 18079 275220 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2524 . 2525) (nil fontified nil 2480 . 2525) (nil fontified nil 2416 . 2480) (nil fontified nil 2370 . 2416) (nil fontified nil 2357 . 2370) (nil fontified nil 2356 . 2357) (nil fontified nil 2351 . 2356) (nil fontified nil 2350 . 2351) (2350 . 2525)) nil (26977 18079 275219 0) 0 nil])
([nil nil ((2525 . 2526)) nil (26977 18079 275218 0) 0 nil])
([nil nil ((#("(defun %remove-protected-fields (payload &key (extra '()))
  (remove-if (lambda (kv) (member (car kv) (append '(:id :created_at :updated_at :lock_version) extra))) payload))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 31 (face font-lock-function-name-face fontified t) 31 41 (fontified t) 41 45 (face font-lock-type-face fontified t) 45 50 (fontified t) 50 59 (fontified t) 59 73 (fontified t) 73 79 (face font-lock-keyword-face fontified t) 79 92 (fontified t) 92 112 (fontified t) 112 115 (face font-lock-builtin-face fontified t) 115 116 (fontified t) 116 127 (face font-lock-builtin-face fontified t) 127 128 (fontified t) 128 139 (face font-lock-builtin-face fontified t) 139 140 (fontified t) 140 153 (face font-lock-builtin-face fontified t) 153 173 (fontified t)) . -2175) (undo-tree-id84 . -173) 2348) nil (26977 18079 275217 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2418 . 2419) (nil fontified nil 2364 . 2419) (nil fontified nil 2358 . 2364) (nil fontified nil 2297 . 2358) (nil fontified nil 2284 . 2297) (nil fontified nil 2283 . 2284) (nil fontified nil 2272 . 2283) (nil fontified nil 2271 . 2272) (nil fontified nil 2260 . 2271) (nil fontified nil 2259 . 2260) (nil fontified nil 2256 . 2259) (nil fontified nil 2241 . 2256) (nil fontified nil 2237 . 2241) (nil fontified nil 2220 . 2237) (nil fontified nil 2216 . 2220) (nil fontified nil 2206 . 2216) (nil fontified nil 2182 . 2206) (nil fontified nil 2181 . 2182) (nil fontified nil 2176 . 2181) (nil fontified nil 2175 . 2176) (2175 . 2419)) nil (26977 18080 125083 0) 0 nil])
([nil nil ((#("(defmethod repo-persist ((op (eql :patch)) (entity symbol) ctx &key id payload)
  (let ((cur (repo-show entity ctx id)))
    (unless cur (error 'lumen.data.errors:not-found-error))
    (let ((ent (row->entity entity cur)))
      (dolist (kv payload)
        (let ((slot (entity-slot-symbol entity (lumen.data.repo.core::%norm-col-name (car kv)))))
          (when slot (setf (slot-value ent slot) (cdr kv)))))
      (validate-entity! ent)
      (lumen.data.db:ensure-connection
        (multiple-value-bind (_ ent2) (entity-update! ent :patch t :returning t)
          (declare (ignore _))
          (entity->row-alist ent2))))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 23 (face font-lock-function-name-face fontified t) 23 34 (fontified t) 34 40 (face font-lock-builtin-face fontified t) 40 63 (fontified t) 63 67 (face font-lock-type-face fontified t) 67 83 (fontified t) 83 86 (face font-lock-keyword-face fontified t) 86 126 (fontified t) 126 132 (face font-lock-keyword-face fontified t) 132 138 (fontified t) 138 143 (face font-lock-warning-face fontified t) 143 151 (fontified t) 151 181 (fontified t) 181 186 (fontified t) 186 189 (face font-lock-keyword-face fontified t) 189 230 (fontified t) 230 236 (face font-lock-keyword-face fontified t) 236 259 (fontified t) 259 262 (face font-lock-keyword-face fontified t) 262 359 (fontified t) 359 363 (face font-lock-keyword-face fontified t) 363 410 (fontified t) 410 435 (fontified t) 435 439 (fontified t) 439 487 (fontified t) 487 506 (face font-lock-keyword-face fontified t) 506 536 (fontified t) 536 542 (face font-lock-builtin-face fontified t) 542 545 (fontified t) 545 555 (face font-lock-builtin-face fontified t) 555 570 (fontified t) 570 577 (face font-lock-keyword-face fontified t) 577 581 (fontified t) 581 590 (fontified t) 590 613 (fontified t) 613 629 (fontified t)) . -14731) (undo-tree-id215 . -629) 15360) nil (26977 18485 843087 0) 0 nil] [nil nil ((#("(defmethod repo-persist ((op (eql :create)) (entity symbol) ctx &key id payload)
  (declare (ignore id))
  (print \"IN REPO PERSIST\")
  (let* ((payload* (%ensure-tenant-on-payload entity ctx payload :op :create))
         (ent      (row->entity entity payload*)))
    (validate-entity! ent)
    (lumen.data.db:ensure-connection
      (multiple-value-bind (_n ent2) (entity-insert! ent :returning t)
        (declare (ignore _n))
        (entity->row-alist ent2)))))" 0 1 (fontified t) 1 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 23 (face font-lock-function-name-face fontified t) 23 34 (fontified t) 34 41 (face font-lock-builtin-face fontified t) 41 64 (fontified t) 64 68 (face font-lock-type-face fontified t) 68 78 (fontified t) 78 81 (fontified t) 81 84 (fontified t) 84 91 (face font-lock-keyword-face fontified t) 91 105 (fontified t) 105 114 (fontified t) 114 131 (face font-lock-string-face fontified t) 131 136 (fontified t) 136 140 (face font-lock-keyword-face fontified t) 140 198 (fontified t) 198 201 (face font-lock-builtin-face fontified t) 201 202 (fontified t) 202 209 (face font-lock-builtin-face fontified t) 209 305 (fontified t) 305 327 (fontified t) 327 334 (fontified t) 334 353 (face font-lock-keyword-face fontified t) 353 384 (fontified t) 384 394 (face font-lock-builtin-face fontified t) 394 407 (fontified t) 407 414 (face font-lock-keyword-face fontified t) 414 428 (fontified t) 428 463 (fontified t) 463 464 (fontified t rear-nonsticky t)) . -14265) (undo-tree-id80 . -464) (undo-tree-id81 . -428) (undo-tree-id82 . -464) (undo-tree-id83 . -464) 14729) ((14265 . 14729)) (26977 18079 275385 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15683 . 15684) (nil fontified nil 15643 . 15684) (nil fontified nil 15603 . 15643) (nil fontified nil 15576 . 15603) (nil fontified nil 15569 . 15576) (nil fontified nil 15554 . 15569) (nil fontified nil 15544 . 15554) (nil fontified nil 15541 . 15544) (nil fontified nil 15535 . 15541) (nil fontified nil 15504 . 15535) (nil fontified nil 15485 . 15504) (nil fontified nil 15435 . 15485) (nil fontified nil 15391 . 15435) (nil fontified nil 15304 . 15391) (nil fontified nil 15300 . 15304) (nil fontified nil 15169 . 15300) (nil fontified nil 15165 . 15169) (nil fontified nil 15156 . 15165) (nil fontified nil 15141 . 15156) (nil fontified nil 15135 . 15141) (nil fontified nil 15134 . 15135) (nil fontified nil 15128 . 15134) (nil fontified nil 15091 . 15128) (nil fontified nil 15088 . 15091) (nil fontified nil 15071 . 15088) (nil fontified nil 15034 . 15071) (nil fontified nil 14967 . 15034) (nil fontified nil 14961 . 14967) (nil fontified nil 14960 . 14961) (nil fontified nil 14957 . 14960) (nil fontified nil 14899 . 14957) (nil fontified nil 14895 . 14899) (nil fontified nil 14887 . 14895) (nil fontified nil 14876 . 14887) (nil fontified nil 14875 . 14876) (nil fontified nil 14870 . 14875) (nil fontified nil 14864 . 14870) (nil fontified nil 14858 . 14864) (nil fontified nil 14853 . 14858) (nil fontified nil 14832 . 14853) (nil fontified nil 14818 . 14832) (nil fontified nil 14814 . 14818) (nil fontified nil 14798 . 14814) (nil fontified nil 14794 . 14798) (nil fontified nil 14771 . 14794) (nil fontified nil 14765 . 14771) (nil fontified nil 14754 . 14765) (nil fontified nil 14742 . 14754) (nil fontified nil 14741 . 14742) (nil fontified nil 14732 . 14741) (nil fontified nil 14731 . 14732) (14731 . 15684)) nil (26977 18485 843083 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15217 . 15218) (nil fontified nil 15177 . 15218) (nil fontified nil 15137 . 15177) (nil fontified nil 15110 . 15137) (nil fontified nil 15103 . 15110) (nil fontified nil 15088 . 15103) (nil fontified nil 15078 . 15088) (nil fontified nil 15075 . 15078) (nil fontified nil 15069 . 15075) (nil fontified nil 15038 . 15069) (nil fontified nil 15019 . 15038) (nil fontified nil 14969 . 15019) (nil fontified nil 14925 . 14969) (nil fontified nil 14838 . 14925) (nil fontified nil 14834 . 14838) (nil fontified nil 14703 . 14834) (nil fontified nil 14699 . 14703) (nil fontified nil 14690 . 14699) (nil fontified nil 14675 . 14690) (nil fontified nil 14669 . 14675) (nil fontified nil 14668 . 14669) (nil fontified nil 14662 . 14668) (nil fontified nil 14625 . 14662) (nil fontified nil 14622 . 14625) (nil fontified nil 14605 . 14622) (nil fontified nil 14568 . 14605) (nil fontified nil 14501 . 14568) (nil fontified nil 14495 . 14501) (nil fontified nil 14494 . 14495) (nil fontified nil 14491 . 14494) (nil fontified nil 14433 . 14491) (nil fontified nil 14429 . 14433) (nil fontified nil 14421 . 14429) (nil fontified nil 14410 . 14421) (nil fontified nil 14409 . 14410) (nil fontified nil 14404 . 14409) (nil fontified nil 14398 . 14404) (nil fontified nil 14392 . 14398) (nil fontified nil 14387 . 14392) (nil fontified nil 14366 . 14387) (nil fontified nil 14352 . 14366) (nil fontified nil 14348 . 14352) (nil fontified nil 14332 . 14348) (nil fontified nil 14328 . 14332) (nil fontified nil 14305 . 14328) (nil fontified nil 14299 . 14305) (nil fontified nil 14288 . 14299) (nil fontified nil 14276 . 14288) (nil fontified nil 14275 . 14276) (nil fontified nil 14266 . 14275) (nil fontified nil 14265 . 14266) (14265 . 15218)) ((#("(defmethod repo-persist ((op (eql :patch)) (entity symbol) ctx &key id payload)
  (let* ((cur (repo-show entity ctx id)))
    (unless cur (error \"not_found\"))
    (let* ((payload* (%ensure-tenant-on-payload entity ctx payload :op :patch))
           (ent      (row->entity entity cur)))
      (format t \"~&REPO-PERSIT:PATCH:PAYLOAD* : ~A~%\" payload*)
      ;; appliquer le patch (hors tenant col)
      (dolist (kv payload*)
        (let* ((col (%norm-col-name (car kv)))
               (val  (cdr kv))
               (slot (entity-slot-symbol entity col)))
          (when slot (setf (slot-value ent slot) val))))
      (validate-entity! ent)
      (format t \"~&REPO-PERSIT:PATCH:ENTITY VALIDATION OK~%\")
      (lumen.data.db:ensure-connection
        (multiple-value-bind (_n ent2) (entity-update! ent :patch t :returning t)
          (declare (ignore _n))
	  (format t \"~&REPO-PERSIT:PATCH:ENTITY UPDATE OK~%\")
          (entity->row-alist ent2))))))" 0 1 (fontified nil) 1 10 (face font-lock-keyword-face fontified nil) 10 11 (fontified nil) 11 23 (face font-lock-function-name-face fontified nil) 23 34 (fontified nil) 34 40 (face font-lock-builtin-face fontified nil) 40 63 (fontified nil) 63 67 (face font-lock-type-face fontified nil) 67 80 (fontified nil) 80 83 (fontified nil) 83 87 (face font-lock-keyword-face fontified nil) 87 101 (fontified nil) 101 122 (fontified nil) 122 127 (fontified nil) 127 133 (face font-lock-keyword-face fontified nil) 133 139 (fontified nil) 139 144 (face font-lock-warning-face fontified nil) 144 145 (fontified nil) 145 156 (face font-lock-string-face fontified nil) 156 159 (fontified nil) 159 164 (fontified nil) 164 168 (face font-lock-keyword-face fontified nil) 168 226 (fontified nil) 226 229 (face font-lock-builtin-face fontified nil) 229 230 (fontified nil) 230 236 (face font-lock-builtin-face fontified nil) 236 287 (fontified nil) 287 303 (fontified nil) 303 340 (face font-lock-string-face fontified nil) 340 351 (fontified nil) 351 357 (fontified nil) 357 360 (face font-lock-comment-delimiter-face fontified nil) 360 397 (face font-lock-comment-face fontified nil) 397 403 (fontified nil) 403 404 (fontified nil) 404 410 (face font-lock-keyword-face fontified nil) 410 425 (fontified nil) 425 434 (fontified nil) 434 438 (face font-lock-keyword-face fontified nil) 438 558 (fontified nil) 558 569 (fontified nil) 569 573 (face font-lock-keyword-face fontified nil) 573 644 (fontified nil) 644 660 (fontified nil) 660 704 (face font-lock-string-face fontified nil) 704 745 (fontified nil) 745 754 (fontified nil) 754 773 (face font-lock-keyword-face fontified nil) 773 804 (fontified nil) 804 810 (face font-lock-builtin-face fontified nil) 810 813 (fontified nil) 813 823 (face font-lock-builtin-face fontified nil) 823 827 (fontified nil) 827 838 (fontified nil) 838 845 (face font-lock-keyword-face fontified nil) 845 859 (fontified nil) 859 872 (fontified nil) 872 912 (face font-lock-string-face fontified nil) 912 914 (fontified nil) 914 952 (fontified nil) 952 953 (rear-nonsticky nil fontified nil)) . 14265) (undo-tree-id93 . -953) (undo-tree-id94 . -914) (nil fontified t 14332 . 14345) (nil fontified t 14366 . 14387) (nil fontified t 14421 . 14424) (nil fontified t 14501 . 14552) (nil fontified t 14605 . 14616) (nil fontified t 14625 . 14662) (nil fontified t 14675 . 14690) (nil fontified t 14703 . 14823) (nil fontified t 14838 . 14909) (nil fontified t 14969 . 15010) (nil fontified t 15088 . 15092) (nil fontified t 15110 . 15124) (nil fontified t 15177 . 15179) (nil rear-nonsticky t 15217 . 15218)) (26977 18079 275192 0) 0 nil])
([nil nil ((14222 . 14224) (#(" " 0 1 (fontified nil)) . 14221) (undo-tree-id214 . -1) (14222 . 14223)) nil (26977 18485 843076 0) 0 nil])
nil
([nil nil ((1933 . 1935)) nil (26977 18485 843075 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2138 . 2139) (nil fontified nil 2123 . 2139) (nil fontified nil 2115 . 2123) (nil fontified nil 2068 . 2115) (nil fontified nil 2060 . 2068) (nil fontified nil 1961 . 2060) (nil fontified nil 1957 . 1961) (nil fontified nil 1949 . 1957) (nil fontified nil 1942 . 1949) (nil fontified nil 1941 . 1942) (nil fontified nil 1936 . 1941) (nil fontified nil 1935 . 1936) (1935 . 2139)) nil (26977 18485 843074 0) 0 nil])
([nil nil ((8297 . 8299)) nil (26977 18485 843072 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8632 . 8633) (nil fontified nil 8626 . 8633) (nil fontified nil 8618 . 8626) (nil fontified nil 8573 . 8618) (nil fontified nil 8565 . 8573) (nil fontified nil 8519 . 8565) (nil fontified nil 8515 . 8519) (nil fontified nil 8506 . 8515) (nil fontified nil 8495 . 8506) (nil fontified nil 8441 . 8495) (nil fontified nil 8437 . 8441) (nil fontified nil 8433 . 8437) (nil fontified nil 8339 . 8433) (nil fontified nil 8327 . 8339) (nil fontified nil 8306 . 8327) (nil fontified nil 8305 . 8306) (nil fontified nil 8300 . 8305) (nil fontified nil 8299 . 8300) (8299 . 8633)) nil (26977 18485 843070 0) 0 nil])
([nil nil ((6541 . 6543)) nil (26977 18485 843068 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6559 . 6560) (nil fontified nil 6543 . 6560) (6543 . 6560)) nil (26977 18485 843067 0) 0 nil])
([nil nil ((#("entity-field-cols" 0 16 (fontified t) 16 17 (rear-nonsticky t fontified t)) . -6543) (undo-tree-id212 . -17) (undo-tree-id213 . -17) 6560) nil (26977 18485 843066 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6674 . 6675) (nil fontified nil 6648 . 6675) (nil fontified nil 6644 . 6648) (nil fontified nil 6631 . 6644) (nil fontified nil 6625 . 6631) (nil fontified nil 6613 . 6625) (nil fontified nil 6579 . 6613) (nil fontified nil 6567 . 6579) (nil fontified nil 6550 . 6567) (nil fontified nil 6549 . 6550) (nil fontified nil 6544 . 6549) (nil fontified nil 6543 . 6544) (6543 . 6675)) nil (26977 18485 843063 0) 0 nil])
([nil nil ((6541 . 6543)) nil (26977 18485 843060 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7211 . 7212) (nil fontified nil 7183 . 7212) (nil fontified nil 7129 . 7183) (nil fontified nil 7086 . 7129) (nil fontified nil 7076 . 7086) (nil fontified nil 7066 . 7076) (nil fontified nil 7064 . 7066) (nil fontified nil 7054 . 7064) (nil fontified nil 7034 . 7054) (nil fontified nil 6989 . 7034) (nil fontified nil 6936 . 6989) (nil fontified nil 6932 . 6936) (nil fontified nil 6907 . 6932) (nil fontified nil 6903 . 6907) (nil fontified nil 6886 . 6903) (nil fontified nil 6880 . 6886) (nil fontified nil 6832 . 6880) (nil fontified nil 6826 . 6832) (nil fontified nil 6817 . 6826) (nil fontified nil 6803 . 6817) (nil fontified nil 6774 . 6803) (nil fontified nil 6767 . 6774) (nil fontified nil 6697 . 6767) (nil fontified nil 6693 . 6697) (nil fontified nil 6689 . 6693) (nil fontified nil 6593 . 6689) (nil fontified nil 6586 . 6593) (nil fontified nil 6577 . 6586) (nil fontified nil 6568 . 6577) (nil fontified nil 6550 . 6568) (nil fontified nil 6549 . 6550) (nil fontified nil 6544 . 6549) (nil fontified nil 6543 . 6544) (6543 . 7212)) nil (26977 18485 843058 0) 0 nil])
([nil nil ((#(";; Invariants Framework (:around)
" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 34 (face font-lock-comment-face fontified t)) . 13367) (undo-tree-id209 . -34) (undo-tree-id210 . -34) (undo-tree-id211 . -34)) nil (26977 18485 843054 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13367)) nil (26977 18485 843050 0) 0 nil])
([nil nil ((#("
(defmacro %with-write-tx (&body body) `(lumen.data.db:with-tx () ,@body))" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 25 (face font-lock-function-name-face fontified t) 25 27 (fontified t) 27 32 (face font-lock-type-face fontified t) 32 41 (fontified t) 41 62 (face font-lock-keyword-face fontified t) 62 74 (fontified t)) . 9952) (undo-tree-id155 . -74) (undo-tree-id156 . -62) (undo-tree-id157 . -62) (undo-tree-id158 . -62) (undo-tree-id159 . -62) (undo-tree-id160 . -62) (undo-tree-id161 . -62) (undo-tree-id162 . -62) (undo-tree-id163 . -62) (undo-tree-id164 . -62) (undo-tree-id165 . -62) (undo-tree-id166 . -62) (undo-tree-id167 . -62) (undo-tree-id168 . -62) (undo-tree-id169 . -62) (undo-tree-id170 . -62) (undo-tree-id171 . -62) (undo-tree-id172 . -23) (undo-tree-id173 . -23) (undo-tree-id174 . -23) (undo-tree-id175 . -23) (undo-tree-id176 . -24) (undo-tree-id177 . -24) (undo-tree-id178 . -22) (undo-tree-id179 . -22) (undo-tree-id180 . -22) (undo-tree-id181 . -22) (undo-tree-id182 . -22) (undo-tree-id183 . -11) (undo-tree-id184 . -25) (undo-tree-id185 . -25) (undo-tree-id186 . -23) (undo-tree-id187 . -11) (undo-tree-id188 . -25) (undo-tree-id189 . -25) (undo-tree-id190 . -25) (undo-tree-id191 . -25) (undo-tree-id192 . -25) (undo-tree-id193 . -25) (undo-tree-id194 . -25) (undo-tree-id195 . -25) (undo-tree-id196 . -25) (undo-tree-id197 . -25) (undo-tree-id198 . -25) (undo-tree-id199 . -25) (undo-tree-id200 . -25) (undo-tree-id201 . -25) (undo-tree-id202 . -25) (undo-tree-id203 . -25) (undo-tree-id204 . -74) (undo-tree-id205 . -74) (undo-tree-id206 . -74) (undo-tree-id207 . -11) (undo-tree-id208 . -74)) nil (26977 18485 843046 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -9951) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) (undo-tree-id150 . -1) (undo-tree-id151 . -1) (undo-tree-id152 . -1) (undo-tree-id153 . -1) (undo-tree-id154 . -1) 9952) nil (26977 18485 842998 0) 0 nil])
([nil nil ((10764 . 10766) (t 26977 18485 0 0)) nil (26977 21730 432742 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12145 . 12146) (nil fontified nil 10766 . 12146) (10766 . 12146)) nil (26977 21730 432741 0) 0 nil])
([nil nil ((#("
(defun %handle-tx-result (tx-result)
  \"Traite le résultat de run-in-transaction (Result Pattern).\"
  (cond
    ;; Cas 1 : Succès (tx-result est l'objet créé/mis à jour)
    ;; Note : On assume que vos objets ne sont pas des listes commençant par des keywords d'erreur
    ((not (and (listp tx-result) 
               (member (car tx-result) '(:business-error :fatal-error))))
     ;; C'est un succès, on renvoie l'objet (converti en JSON par Lumen)
     (lumen.core.http:respond-json tx-result :status 200))

    ;; Cas 2 : Erreur Métier (ex: Validation, Règle de gestion) -> HTTP 400 ou 422
    ((eq (car tx-result) :business-error)
     (destructuring-bind (_ msg code) tx-result
       (declare (ignore _))
       (lumen.core.http:respond-json 
        `((:status . \"error\")
          (:code . ,(or code \"BUSINESS_ERROR\"))
          (:message . ,msg))
        :status 422))) ;; Ou 400 selon vos préférences

    ;; Cas 3 : Erreur Fatale (ex: DB hors ligne) -> HTTP 500
    ((eq (car tx-result) :fatal-error)
     (destructuring-bind (_ msg) tx-result
       (declare (ignore _))
       ;; Log l'erreur critique ici si nécessaire
       (format t \"~&[CRITICAL] DB Error: ~A~%\" msg)
       (lumen.core.http:respond-json 
        `((:status . \"error\")
          (:code . \"INTERNAL_SERVER_ERROR\")
          (:message . \"Une erreur interne est survenue.\"))
        :status 500)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 25 (face font-lock-function-name-face fontified t) 25 40 (fontified t) 40 100 (face font-lock-doc-face fontified t) 100 104 (fontified t) 104 108 (face font-lock-keyword-face fontified t) 108 113 (fontified t) 113 116 (face font-lock-comment-delimiter-face fontified t) 116 171 (face font-lock-comment-face fontified t) 171 175 (fontified t) 175 178 (face font-lock-comment-delimiter-face fontified t) 178 270 (face font-lock-comment-face fontified t) 270 345 (fontified t) 345 360 (face font-lock-builtin-face fontified t) 360 361 (fontified t) 361 373 (face font-lock-builtin-face fontified t) 373 383 (fontified t) 383 386 (face font-lock-comment-delimiter-face fontified t) 386 451 (face font-lock-comment-face fontified t) 451 496 (fontified t) 496 503 (face font-lock-builtin-face fontified t) 503 515 (fontified t) 515 518 (face font-lock-comment-delimiter-face fontified t) 518 594 (face font-lock-comment-face fontified t) 594 619 (fontified t) 619 634 (face font-lock-builtin-face fontified t) 634 642 (fontified t) 642 660 (face font-lock-keyword-face fontified t) 660 692 (fontified t) 692 699 (face font-lock-keyword-face fontified t) 699 761 (fontified t) 761 768 (face font-lock-builtin-face fontified t) 768 771 (fontified t) 771 778 (face font-lock-string-face fontified t) 778 791 (fontified t) 791 796 (face font-lock-builtin-face fontified t) 796 809 (fontified t) 809 825 (face font-lock-string-face fontified t) 825 839 (fontified t) 839 847 (face font-lock-builtin-face fontified t) 847 865 (fontified t) 865 872 (face font-lock-builtin-face fontified t) 872 880 (fontified t) 880 883 (face font-lock-comment-delimiter-face fontified t) 883 912 (face font-lock-comment-face fontified t) 912 917 (fontified t) 917 920 (face font-lock-comment-delimiter-face fontified t) 920 974 (face font-lock-comment-face fontified t) 974 999 (fontified t) 999 1011 (face font-lock-builtin-face fontified t) 1011 1019 (fontified t) 1019 1037 (face font-lock-keyword-face fontified t) 1037 1064 (fontified t) 1064 1071 (face font-lock-keyword-face fontified t) 1071 1091 (fontified t) 1091 1094 (face font-lock-comment-delimiter-face fontified t) 1094 1134 (face font-lock-comment-face fontified t) 1134 1151 (fontified t) 1151 1180 (face font-lock-string-face fontified t) 1180 1235 (fontified t) 1235 1242 (face font-lock-builtin-face fontified t) 1242 1245 (fontified t) 1245 1252 (face font-lock-string-face fontified t) 1252 1265 (fontified t) 1265 1270 (face font-lock-builtin-face fontified t) 1270 1273 (fontified t) 1273 1296 (face font-lock-string-face fontified t) 1296 1309 (fontified t) 1309 1317 (face font-lock-builtin-face fontified t) 1317 1320 (fontified t) 1320 1354 (face font-lock-string-face fontified t) 1354 1365 (fontified t) 1365 1372 (face font-lock-builtin-face fontified t) 1372 1380 (fontified t) 1380 1381 (rear-nonsticky t fontified t) 1381 1382 (fontified t)) . 10765) (undo-tree-id216 . -1382) (undo-tree-id217 . -1) (undo-tree-id218 . -1382)) nil (26977 21730 432740 0) 0 nil])
([nil nil ((22174 . 22179)) nil (26977 21730 432728 0) 0 nil])
([nil nil ((22179 . 22180)) nil (26977 21730 432723 0) 0 nil])
([nil nil ((22193 . 22199) (t 26977 21730 0 0)) nil (26977 21914 527819 0) 0 nil])
([nil nil ((22199 . 22200)) nil (26977 21914 527818 0) 0 nil])
([nil nil ((22200 . 22204)) nil (26977 21914 527818 0) 0 nil])
([nil nil ((22186 . 22193)) nil (26977 21914 527817 0) 0 nil])
([nil nil ((22193 . 22199)) nil (26977 21914 527817 0) 0 nil])
([nil nil ((22199 . 22200)) nil (26977 21914 527816 0) 0 nil])
([nil nil ((22200 . 22201)) nil (26977 21914 527815 0) 0 nil])
([nil nil ((22201 . 22207)) nil (26977 21914 527811 0) 0 nil])
([nil nil ((22214 . 22216) (t 26977 21914 0 0)) nil (26978 5759 957395 0) 0 nil])
([nil nil ((22193 . 22195) (t 26978 5759 0 0)) nil (26978 5762 663930 0) 0 nil])
([nil nil ((15122 . 15124) (t 26978 5762 0 0)) nil (26978 28219 951034 0) 0 nil])
([nil nil ((15124 . 15130)) nil (26978 28219 951033 0) 0 nil])
([nil nil ((15130 . 15131)) nil (26978 28219 951032 0) 0 nil])
([nil nil ((15131 . 15136)) nil (26978 28219 951028 0) 0 nil])
([nil nil ((#("(print rows)" 0 12 (fontified t)) . 15124) (undo-tree-id15 . -12) (undo-tree-id16 . -12) (undo-tree-id17 . -12) (t 26978 28219 0 0)) nil (26978 28402 687571 0) 0 nil])
([nil nil ((20077 . 20084)) nil (26978 28402 687569 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20095 . 20096) (nil fontified nil 20084 . 20096) (20084 . 20096)) nil (26978 28402 687568 0) 0 nil])
([nil nil ((#("rows" 0 4 (fontified t)) . -20091) (undo-tree-id0 . -4) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -4) (undo-tree-id8 . -4) (undo-tree-id9 . -4) (undo-tree-id10 . -4) (undo-tree-id11 . -4) (undo-tree-id12 . -4) (undo-tree-id13 . -4) (undo-tree-id14 . -4) 20095) nil (26978 28402 687566 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20096 . 20097) (nil fontified nil 20091 . 20097) (20091 . 20097)) nil (26978 28402 687537 0) 0 nil])
([nil nil ((20159 . 20166) (t 26978 28402 0 0)) nil (26978 28669 99213 0) 0 nil])
([nil nil ((20166 . 20172)) nil (26978 28669 99212 0) 0 nil])
([nil nil ((20172 . 20173)) nil (26978 28669 99211 0) 0 nil])
([nil nil ((20173 . 20179)) nil (26978 28669 99211 0) 0 nil])
([nil nil ((20179 . 20180)) nil (26978 28669 99211 0) 0 nil])
([nil nil ((20180 . 20185)) nil (26978 28669 99210 0) 0 nil])
([nil nil ((20185 . 20186)) nil (26978 28669 99210 0) 0 nil])
([nil nil ((20186 . 20193)) nil (26978 28669 99209 0) 0 nil])
([nil nil ((20193 . 20194)) nil (26978 28669 99209 0) 0 nil])
([nil nil ((20194 . 20197)) nil (26978 28669 99208 0) 0 nil])
([nil nil ((20197 . 20198)) nil (26978 28669 99208 0) 0 nil])
([nil nil ((20198 . 20202)) nil (26978 28669 99207 0) 0 nil])
([nil nil ((#("]" 0 1 (fontified t)) . -20201) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) 20202) nil (26978 28669 99205 0) 0 nil])
([nil nil ((20201 . 20202)) nil (26978 28669 99189 0) 0 nil])
([nil nil ((20265 . 20272) (t 26978 28669 0 0)) nil (26978 28846 571606 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20307 . 20308) (nil fontified nil 20307 . 20308) (nil fontified nil 20279 . 20307) (nil fontified nil 20272 . 20279) (20272 . 20308)) nil (26978 28846 571605 0) 0 nil])
([nil nil ((#("\"[REPO INDEX AROUND] OUT TX\"" 0 28 (face font-lock-string-face fontified t)) . -20279) (undo-tree-id23 . -28) (undo-tree-id24 . -28) (undo-tree-id25 . -28) (undo-tree-id26 . -28) (undo-tree-id27 . -28) (undo-tree-id28 . -28) (undo-tree-id29 . -28) 20307) nil (26978 28846 571603 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20301 . 20302) (nil fontified nil 20279 . 20302) (20279 . 20302)) nil (26978 28846 571573 0) 0 nil])
([nil nil ((20303 . 20310)) nil (26978 28846 571572 0) 0 nil])
([nil nil ((20310 . 20316)) nil (26978 28846 571571 0) 0 nil])
([nil nil ((20316 . 20317)) nil (26978 28846 571570 0) 0 nil])
([nil nil ((20317 . 20322)) nil (26978 28846 571565 0) 0 nil])
([nil nil ((10043 . 10046) (t 26978 28846 0 0)) nil (26978 29123 238558 0) 0 nil])
([nil nil ((10046 . 10052)) nil (26978 29123 238557 0) 0 nil])
([nil nil ((10052 . 10053)) nil (26978 29123 238556 0) 0 nil])
([nil nil ((10053 . 10056)) nil (26978 29123 238556 0) 0 nil])
([nil nil ((10056 . 10057)) nil (26978 29123 238555 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10073 . 10074) (nil fontified nil 10057 . 10074) (10057 . 10074)) nil (26978 29123 238555 0) 0 nil])
([nil nil ((10074 . 10076)) nil (26978 29123 238554 0) 0 nil])
([nil nil ((10074 . 10075)) nil (26978 29123 238554 0) 0 nil])
([nil nil ((10075 . 10076)) nil (26978 29123 238553 0) 0 nil])
([nil nil ((10076 . 10078)) nil (26978 29123 238553 0) 0 nil])
([nil nil ((10079 . 10080)) nil (26978 29123 238552 0) 0 nil])
([nil nil ((10080 . 10086)) nil (26978 29123 238552 0) 0 nil])
([nil nil ((#("print" 0 5 (fontified t)) . -10047) (undo-tree-id30 . -5) (undo-tree-id31 . -4) (undo-tree-id32 . -4) (undo-tree-id33 . -4) (undo-tree-id34 . -4) (undo-tree-id35 . -4) (undo-tree-id36 . -5) (undo-tree-id37 . -5) (undo-tree-id38 . -5) (undo-tree-id39 . -5) (undo-tree-id40 . -5) (undo-tree-id41 . -5) 10052) nil (26978 29123 238550 0) 0 nil])
([nil nil ((10047 . 10048)) nil (26978 29123 238530 0) 0 nil])
([nil nil ((10048 . 10053)) nil (26978 29123 238529 0) 0 nil])
([nil nil ((10053 . 10054)) nil (26978 29123 238529 0) 0 nil])
([nil nil ((10054 . 10055)) nil (26978 29123 238529 0) 0 nil])
([nil nil ((10057 . 10059)) nil (26978 29123 238528 0) 0 nil])
([nil nil ((10083 . 10084)) nil (26978 29123 238527 0) 0 nil])
([nil nil ((10084 . 10085)) nil (26978 29123 238522 0) 0 nil])
([nil nil ((1010 . 1013) (#(" " 0 1 (fontified nil)) . -924) (1010 . 1011) (t 26978 29123 0 0)) nil (26979 31992 481101 0) 0 nil])
([nil nil ((1013 . 1014)) nil (26979 31992 481166 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -1013) (undo-tree-id76 . -1) (undo-tree-id77 . -1) 1014) nil (26979 32818 931773 0) 0 nil] [nil nil ((nil rear-nonsticky nil 1097 . 1098) (nil fontified nil 1014 . 1098) (1014 . 1098)) ((#(":find-one
    :find-by
    :find-all
    :count-all
    :delete-by-id
    :delete-by" 0 9 (face font-lock-builtin-face fontified nil) 9 14 (fontified nil) 14 22 (face font-lock-builtin-face fontified nil) 22 27 (fontified nil) 27 36 (face font-lock-builtin-face fontified nil) 36 41 (fontified nil) 41 51 (face font-lock-builtin-face fontified nil) 51 56 (fontified nil) 56 69 (face font-lock-builtin-face fontified nil) 69 70 (fontified nil) 70 74 (fontified nil) 74 83 (face font-lock-builtin-face fontified nil) 83 84 (face font-lock-builtin-face rear-nonsticky nil fontified nil)) . 1014) (undo-tree-id42 . -84) (undo-tree-id43 . -70) (nil fontified t 1083 . 1084) (nil fontified t 1070 . 1083) (nil fontified t 1065 . 1070) (nil fontified t 1055 . 1065) (nil fontified t 1050 . 1055) (nil fontified t 1041 . 1050) (nil fontified t 1036 . 1041) (nil fontified t 1028 . 1036) (nil fontified t 1023 . 1028) (nil fontified t 1014 . 1023) (nil rear-nonsticky t 1097 . 1098)) (26979 31992 481095 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1096 . 1097) (nil fontified nil 1013 . 1097) (1013 . 1097)) nil (26979 32818 931772 0) 0 nil])
nil
([nil nil ((#("
   " 0 4 (fontified t)) . -1022) (undo-tree-id75 . -4) 1026) nil (26979 32818 931771 0) 0 nil])
([nil nil ((#("
    " 0 1 (fontified t) 1 5 (fontified t)) . -1031) (undo-tree-id74 . -5) 1036) nil (26979 32818 931770 0) 0 nil])
([nil nil ((1031 . 1032)) nil (26979 32818 931769 0) 0 nil])
([nil nil ((#("
   " 0 1 (fontified t) 1 4 (fontified t)) . -1041) (undo-tree-id73 . -4) 1045) nil (26979 32818 931769 0) 0 nil])
([nil nil ((#("
   " 0 1 (fontified t) 1 4 (fontified t)) . -1052) (undo-tree-id72 . -4) 1056) nil (26979 32818 931767 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -1066) (undo-tree-id71 . -3) 1069) nil (26979 32818 931766 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 1066)) nil (26979 32818 931765 0) 0 nil])
([nil nil ((292 . 293)) nil (26979 32818 931765 0) 0 nil])
([nil nil ((293 . 306)) nil (26979 32818 931764 0) 0 nil])
([nil nil ((306 . 307)) nil (26979 32818 931764 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 325 . 326) (nil fontified nil 307 . 326) (307 . 326)) nil (26979 32818 931764 0) 0 nil])
([nil nil ((2240 . 2242)) nil (26979 32818 931763 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2619 . 2620) (nil fontified nil 2242 . 2620) (2242 . 2620)) nil (26979 32818 931763 0) 0 nil])
([nil nil ((24094 . 24095)) nil (26979 32818 931762 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26814 . 26815) (nil fontified nil 24095 . 26815) (24095 . 26815)) nil (26979 32818 931762 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -26184) (undo-tree-id70 . -1) 26185) nil (26979 32818 931761 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -24123) (undo-tree-id69 . -1) 24124) nil (26979 32818 931760 0) 0 nil])
([nil nil ((24094 . 24095)) nil (26979 32818 931759 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24122 . 24123) (nil fontified nil 24098 . 24123) (nil fontified nil 24095 . 24098) (24095 . 24123)) nil (26979 32818 931758 0) 0 nil])
([nil nil ((24123 . 24124)) nil (26979 32818 931758 0) 0 nil])
([nil nil ((24094 . 24096)) nil (26979 32818 931757 0) 0 nil])
([nil nil ((24096 . 24097)) nil (26979 32818 931757 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24099 . 24100) (nil fontified nil 24097 . 24100) (24097 . 24100)) nil (26979 32818 931756 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24102 . 24103) (nil fontified nil 24100 . 24103) (24100 . 24103)) nil (26979 32818 931756 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24105 . 24106) (nil fontified nil 24103 . 24106) (24103 . 24106)) nil (26979 32818 931755 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24108 . 24109) (nil fontified nil 24106 . 24109) (24106 . 24109)) nil (26979 32818 931754 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24111 . 24112) (nil fontified nil 24109 . 24112) (24109 . 24112)) nil (26979 32818 931754 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24114 . 24115) (nil fontified nil 24112 . 24115) (24112 . 24115)) nil (26979 32818 931753 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24117 . 24118) (nil fontified nil 24115 . 24118) (24115 . 24118)) nil (26979 32818 931753 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24120 . 24121) (nil fontified nil 24118 . 24121) (24118 . 24121)) nil (26979 32818 931752 0) 0 nil])
([nil nil ((#("READERS (LECTURE)" 0 17 (face font-lock-comment-face fontified t)) . -24129) (undo-tree-id68 . -17) 24146) nil (26979 32818 931751 0) 0 nil])
([nil nil ((24129 . 24135)) nil (26979 32818 931727 0) 0 nil])
([nil nil ((24135 . 24136)) nil (26979 32818 931727 0) 0 nil])
([nil nil ((#("R" 0 1 (face font-lock-comment-face fontified t)) . -24132) (undo-tree-id64 . -1) (#("E" 0 1 (face font-lock-comment-face fontified t)) . -24133) (undo-tree-id65 . -1) (#("S" 0 1 (face font-lock-comment-face fontified t)) . -24134) (undo-tree-id66 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24135) (undo-tree-id67 . -1) 24136) nil (26979 32818 931726 0) 0 nil])
([nil nil ((#("S" 0 1 (face font-lock-comment-face fontified t)) . -24129) (undo-tree-id61 . -1) (#("U" 0 1 (face font-lock-comment-face fontified t)) . -24130) (undo-tree-id62 . -1) (#("C" 0 1 (face font-lock-comment-face fontified t)) . -24131) (undo-tree-id63 . -1) 24132) nil (26979 32818 931722 0) 0 nil])
([nil nil ((24129 . 24132)) nil (26979 32818 931690 0) 0 nil])
([nil nil ((24133 . 24147)) nil (26979 32818 931690 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -24146) (undo-tree-id60 . -1) 24147) nil (26979 32818 931689 0) 0 nil])
([nil nil ((24129 . 24130)) nil (26979 32818 931688 0) 0 nil])
([nil nil ((24130 . 24137)) nil (26979 32818 931688 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -24135) (undo-tree-id58 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24136) (undo-tree-id59 . -1) 24137) nil (26979 32818 931687 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -24144) (undo-tree-id52 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24145) (undo-tree-id53 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24146) (undo-tree-id54 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24147) (undo-tree-id55 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24148) (undo-tree-id56 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -24149) (undo-tree-id57 . -1) 24150) nil (26979 32818 931684 0) 0 nil])
([nil nil ((nil fontified nil 24176 . 24177) (nil fontified nil 24174 . 24176) (nil fontified nil 24173 . 24174) (nil fontified nil 24171 . 24173) (nil fontified nil 24170 . 24171) (nil fontified nil 24168 . 24170) (nil fontified nil 24167 . 24168) (nil fontified nil 24165 . 24167) (nil fontified nil 24164 . 24165) (nil fontified nil 24162 . 24164) (nil fontified nil 24161 . 24162) (nil fontified nil 24159 . 24161) (nil fontified nil 24158 . 24159) (nil fontified nil 24156 . 24158) (nil fontified nil 24155 . 24156) (nil fontified nil 24153 . 24155) (nil fontified nil 24150 . 24153) (24150 . 24177)) nil (26979 32818 931679 0) 0 nil])
([nil nil ((24093 . 24095)) nil (26979 32818 931678 0) 0 nil])
([nil nil ((24179 . 24180)) nil (26979 32818 931677 0) 0 nil])
([nil nil ((588 . 589)) nil (26979 32818 931677 0) 0 nil])
([nil nil ((589 . 590)) nil (26979 32818 931677 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 602 . 603) (nil fontified nil 590 . 603) (590 . 603)) nil (26979 32818 931676 0) 0 nil])
([nil nil ((603 . 604)) nil (26979 32818 931675 0) 0 nil])
([nil nil ((604 . 611)) nil (26979 32818 931675 0) 0 nil])
([nil nil ((604 . 605)) nil (26979 32818 931674 0) 0 nil])
([nil nil ((#(";; ------------------------
;; ---       ORM        ---
;; ------------------------

;; --- READERS (LECTURE) ---
(defun find-one (entity-class id &key (cols \"*\"))
  \"Récupère une entité par sa clé primaire.
   Exemple: (find-one 'audit \\\"uuid-123\\\")\"
  (let* ((table (%get-table entity-class))
         (pk    (%get-pk-col entity-class))
         (sql   (format nil \"SELECT ~A FROM ~A WHERE ~A = $1 LIMIT 1\" 
                        cols table pk))
         (row   (lumen.data.db:query-1a sql id)))
    (when row
      ;; Hydratation via votre DAO existant
      (lumen.data.dao:row->entity entity-class row))))

(defun find-by (entity-class field value &key (cols \"*\"))
  \"Récupère la PREMIÈRE entité correspondant au critère.
   Exemple: (find-by 'user :email \\\"bob@mail.com\\\")\"
  (let* ((table (%get-table entity-class))
         (col   (%kw-to-col field))
         (sql   (format nil \"SELECT ~A FROM ~A WHERE ~A = $1 LIMIT 1\" 
                        cols table col))
         (row   (lumen.data.db:query-1a sql value)))
    (when row
      (lumen.data.dao:row->entity entity-class row))))

(defun find-all (entity-class &key (where \"true\") (params nil) (limit 100) (offset 0) (order-by \"created_at DESC\"))
  \"Récupère une liste d'entités avec filtrage SQL brut et pagination.
   Exemple: (find-all 'audit :where \\\"status = $1\\\" :params '(\\\"done\\\"))\"
  (let* ((table (%get-table entity-class))
         (sql   (format nil \"SELECT * FROM ~A WHERE ~A ORDER BY ~A LIMIT ~D OFFSET ~D\"
                        table where order-by limit offset))
         (rows  (lumen.data.db:query-a sql params)))
    ;; On mappe le constructeur d'entité sur la liste de résultats
    (mapcar (lambda (row) (lumen.data.dao:row->entity entity-class row))
            rows)))

(defun count-all (entity-class &key (where \"true\") (params nil))
  \"Compte les entités.\"
  (let* ((table (%get-table entity-class))
         (sql   (format nil \"SELECT count(*) as c FROM ~A WHERE ~A\" table where))
         (res   (lumen.data.db:query-1a sql params)))
    ;; Gestion robuste du retour (alist ou valeur)
    (if (listp res)
        (cdr (assoc :c res))
        res)))

;; --- WRITERS (ÉCRITURE) ---
(defun delete-by-id (entity-class id)
  \"Supprime une entité par sa PK. Retourne le nombre de lignes affectées (0 ou 1).\"
  (let* ((table (%get-table entity-class))
         (pk    (%get-pk-col entity-class))
         (sql   (format nil \"DELETE FROM ~A WHERE ~A = $1\" table pk)))
    (lumen.data.db:exec sql id)))

(defun delete-by (entity-class field value)
  \"Supprime des entités par un champ spécifique (ex: audit_id pour des findings).\"
  (let* ((table (%get-table entity-class))
         (col   (%kw-to-col field))
         (sql   (format nil \"DELETE FROM ~A WHERE ~A = $1\" table col)))
    (lumen.data.db:exec sql value)))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 5 (face font-lock-comment-face fontified t) 5 6 (face font-lock-comment-face fontified t rear-nonsticky t) 6 8 (face font-lock-comment-face fontified t) 8 9 (face font-lock-comment-face fontified t rear-nonsticky t) 9 11 (face font-lock-comment-face fontified t) 11 12 (face font-lock-comment-face fontified t rear-nonsticky t) 12 14 (face font-lock-comment-face fontified t) 14 15 (face font-lock-comment-face fontified t rear-nonsticky t) 15 17 (face font-lock-comment-face fontified t) 17 18 (face font-lock-comment-face fontified t rear-nonsticky t) 18 20 (face font-lock-comment-face fontified t) 20 21 (face font-lock-comment-face fontified t rear-nonsticky t) 21 23 (face font-lock-comment-face fontified t) 23 24 (face font-lock-comment-face fontified t rear-nonsticky t) 24 26 (face font-lock-comment-face fontified t) 26 27 (face font-lock-comment-face fontified t rear-nonsticky t) 27 28 (face font-lock-comment-face fontified t) 28 31 (face font-lock-comment-delimiter-face fontified t) 31 54 (face font-lock-comment-face fontified t) 54 55 (face font-lock-comment-face fontified t rear-nonsticky t) 55 56 (face font-lock-comment-face fontified t) 56 59 (face font-lock-comment-delimiter-face fontified t) 59 61 (face font-lock-comment-face fontified t) 61 62 (face font-lock-comment-face fontified t rear-nonsticky t) 62 64 (face font-lock-comment-face fontified t) 64 65 (face font-lock-comment-face fontified t rear-nonsticky t) 65 67 (face font-lock-comment-face fontified t) 67 68 (face font-lock-comment-face fontified t rear-nonsticky t) 68 70 (face font-lock-comment-face fontified t) 70 71 (face font-lock-comment-face fontified t rear-nonsticky t) 71 73 (face font-lock-comment-face fontified t) 73 74 (face font-lock-comment-face fontified t rear-nonsticky t) 74 76 (face font-lock-comment-face fontified t) 76 77 (face font-lock-comment-face fontified t rear-nonsticky t) 77 79 (face font-lock-comment-face fontified t) 79 80 (face font-lock-comment-face fontified t rear-nonsticky t) 80 82 (face font-lock-comment-face fontified t) 82 83 (face font-lock-comment-face fontified t rear-nonsticky t) 83 84 (face font-lock-comment-face fontified t) 84 85 (fontified t) 85 88 (face font-lock-comment-delimiter-face fontified t) 88 113 (face font-lock-comment-face fontified t) 113 114 (face font-lock-comment-face fontified t) 114 115 (fontified t) 115 120 (face font-lock-keyword-face fontified t) 120 121 (fontified t) 121 129 (face font-lock-function-name-face fontified t) 129 147 (fontified t) 147 151 (face font-lock-type-face fontified t) 151 158 (fontified t) 158 161 (face font-lock-string-face fontified t) 161 166 (fontified t) 166 251 (face font-lock-doc-face fontified t) 251 255 (fontified t) 255 259 (face font-lock-keyword-face fontified t) 259 367 (fontified t) 367 408 (face font-lock-string-face fontified t) 408 505 (fontified t) 505 509 (face font-lock-keyword-face fontified t) 509 520 (fontified t) 520 523 (face font-lock-comment-delimiter-face fontified t) 523 558 (face font-lock-comment-face fontified t) 558 614 (fontified t) 614 615 (fontified t) 615 620 (face font-lock-keyword-face fontified t) 620 621 (fontified t) 621 628 (face font-lock-function-name-face fontified t) 628 655 (fontified t) 655 659 (face font-lock-type-face fontified t) 659 666 (fontified t) 666 669 (face font-lock-string-face fontified t) 669 674 (fontified t) 674 781 (face font-lock-doc-face fontified t) 781 785 (fontified t) 785 789 (face font-lock-keyword-face fontified t) 789 889 (fontified t) 889 925 (face font-lock-string-face fontified t) 925 930 (face font-lock-string-face fontified t) 930 932 (fontified t) 932 1031 (fontified t) 1031 1035 (face font-lock-keyword-face fontified t) 1035 1096 (fontified t) 1096 1097 (fontified t) 1097 1102 (face font-lock-keyword-face fontified t) 1102 1103 (fontified t) 1103 1111 (face font-lock-function-name-face fontified t) 1111 1126 (fontified t) 1126 1130 (face font-lock-type-face fontified t) 1130 1138 (fontified t) 1138 1144 (face font-lock-string-face fontified t) 1144 1192 (fontified t) 1192 1209 (face font-lock-string-face fontified t) 1209 1214 (fontified t) 1214 1355 (face font-lock-doc-face fontified t) 1355 1359 (fontified t) 1359 1363 (face font-lock-keyword-face fontified t) 1363 1427 (fontified t) 1427 1485 (face font-lock-string-face fontified t) 1485 1501 (fontified t) 1501 1546 (fontified t) 1546 1555 (fontified t) 1555 1556 (fontified t) 1556 1584 (fontified t) 1584 1585 (fontified t) 1585 1599 (fontified t) 1599 1603 (fontified t) 1603 1606 (face font-lock-comment-delimiter-face fontified t) 1606 1614 (face font-lock-comment-face fontified t) 1614 1666 (face font-lock-comment-face fontified t) 1666 1679 (fontified t) 1679 1685 (face font-lock-keyword-face fontified t) 1685 1761 (fontified t) 1761 1766 (face font-lock-keyword-face fontified t) 1766 1767 (fontified t) 1767 1776 (face font-lock-function-name-face fontified t) 1776 1791 (fontified t) 1791 1795 (face font-lock-type-face fontified t) 1795 1803 (fontified t) 1803 1809 (face font-lock-string-face fontified t) 1809 1827 (fontified t) 1827 1848 (face font-lock-doc-face fontified t) 1848 1852 (fontified t) 1852 1856 (face font-lock-keyword-face fontified t) 1856 1920 (fontified t) 1920 1959 (face font-lock-string-face fontified t) 1959 2032 (fontified t) 2032 2035 (face font-lock-comment-delimiter-face fontified t) 2035 2079 (face font-lock-comment-face fontified t) 2079 2084 (fontified t) 2084 2086 (face font-lock-keyword-face fontified t) 2086 2119 (fontified t) 2119 2121 (face font-lock-builtin-face fontified t) 2121 2144 (fontified t) 2144 2147 (face font-lock-comment-delimiter-face fontified t) 2147 2173 (face font-lock-comment-face fontified t) 2173 2174 (face font-lock-comment-face fontified t) 2174 2175 (fontified t) 2175 2180 (face font-lock-keyword-face fontified t) 2180 2181 (fontified t) 2181 2193 (face font-lock-function-name-face fontified t) 2193 2214 (fontified t) 2214 2295 (face font-lock-doc-face fontified t) 2295 2299 (fontified t) 2299 2303 (face font-lock-keyword-face fontified t) 2303 2411 (fontified t) 2411 2432 (face font-lock-string-face fontified t) 2432 2441 (face font-lock-string-face fontified t) 2441 2454 (fontified t) 2454 2490 (fontified t) 2490 2495 (face font-lock-keyword-face fontified t) 2495 2496 (fontified t) 2496 2505 (face font-lock-function-name-face fontified t) 2505 2535 (fontified t) 2535 2615 (face font-lock-doc-face fontified t) 2615 2619 (fontified t) 2619 2623 (face font-lock-keyword-face fontified t) 2623 2723 (fontified t) 2723 2753 (face font-lock-string-face fontified t) 2753 2802 (fontified t) 2802 2803 (fontified t rear-nonsticky t)) . 24120) (undo-tree-id50 . -2803) (undo-tree-id51 . -973) 26923) nil (26979 32818 931674 0) 0 nil])
([nil nil ((#("(defun %kw-to-col (k)
  \"Convertit :my-field en string \\\"my_field\\\" pour le SQL.\"
  (lumen.utils:to-snake-case (string k)))

(defun %get-pk-col (class-sym)
  \"Récupère le nom de la colonne PK pour une entité.\"
  (%kw-to-col (lumen.data.dao:entity-primary-key class-sym)))

(defun %get-table (class-sym)
  \"Récupère le nom de la table.\"
  (lumen.data.dao:entity-table class-sym))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 17 (face font-lock-function-name-face fontified t) 17 24 (fontified t) 24 81 (face font-lock-doc-face fontified t) 81 126 (fontified t) 126 131 (face font-lock-keyword-face fontified t) 131 132 (fontified t) 132 143 (face font-lock-function-name-face fontified t) 143 158 (fontified t) 158 209 (face font-lock-doc-face fontified t) 209 274 (fontified t) 274 279 (face font-lock-keyword-face fontified t) 279 280 (fontified t) 280 290 (face font-lock-function-name-face fontified t) 290 305 (fontified t) 305 335 (face font-lock-doc-face fontified t) 335 377 (fontified t) 377 378 (fontified t rear-nonsticky t)) . 2266) (undo-tree-id49 . -378) 2644) nil (26979 32818 931672 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2264) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (#("
" 0 1 (fontified t)) . -2265) (undo-tree-id47 . -1) (undo-tree-id48 . -1) 2266) nil (26979 32818 931670 0) 0 nil])
([nil nil ((#(":find-one :find-by :find-all :count-all :delete-by-id :delete-by" 0 9 (face font-lock-builtin-face fontified t) 9 10 (fontified t) 10 18 (face font-lock-builtin-face fontified t) 18 19 (fontified t) 19 28 (face font-lock-builtin-face fontified t) 28 29 (fontified t) 29 39 (face font-lock-builtin-face fontified t) 39 40 (fontified t) 40 53 (face font-lock-builtin-face fontified t) 53 54 (fontified t) 54 63 (face font-lock-builtin-face fontified t) 63 64 (face font-lock-builtin-face fontified t rear-nonsticky t)) . 1071) (undo-tree-id44 . -64) 1135) nil (26979 32818 931664 0) 0 nil])
([nil nil ((#("cdr (assoc" 0 10 (fontified t)) . -20928) (undo-tree-id11 . -10) 20938 (t 26979 32818 0 0)) nil (26985 57048 573912 0) 0 nil])
([nil nil ((20928 . 20939)) nil (26985 57048 573911 0) 0 nil])
([nil nil ((20928 . 20947) (#("lumen.utils" 0 11 (fontified t)) . -20928) (undo-tree-id10 . -11) 20939) nil (26985 57048 573910 0) 0 nil])
([nil nil ((20927 . 20930)) nil (26985 57048 573909 0) 0 nil])
([nil nil ((20930 . 20931)) nil (26985 57048 573908 0) 0 nil])
([nil nil ((#(":tenant_id" 0 10 (face font-lock-builtin-face fontified t)) . 20952) (undo-tree-id9 . -10) 20962) nil (26985 57048 573908 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -20951) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 20952) nil (26985 57048 573906 0) 0 nil])
([nil nil ((20955 . 20956)) nil (26985 57048 573904 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20965 . 20966) (nil fontified nil 20956 . 20966) (20956 . 20966)) nil (26985 57048 573904 0) 0 nil])
([nil nil ((20967 . 20979)) nil (26985 57048 573903 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21014 . 21015) (nil fontified nil 21014 . 21015) (nil fontified nil 21013 . 21014) (nil fontified nil 21004 . 21013) (nil fontified nil 20999 . 21004) (nil fontified nil 20980 . 20999) (nil fontified nil 20979 . 20980) (20979 . 21015)) nil (26985 57048 573902 0) 0 nil])
([nil nil ((#("_" 0 1 (face font-lock-builtin-face fontified t)) . -21011) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 21012) nil (26985 57048 573896 0) 0 nil])
([nil nil ((21011 . 21012)) nil (26985 57048 573874 0) 0 nil])
([nil nil ((21650 . 21653) (t 26985 57048 0 0)) nil (26985 57084 715102 0) 0 nil])
([nil nil ((21653 . 21659)) nil (26985 57084 715102 0) 0 nil])
([nil nil ((21659 . 21660)) nil (26985 57084 715101 0) 0 nil])
([nil nil ((#("n" 0 1 (fontified t)) . -21657) (undo-tree-id18 . -1) (#("t" 0 1 (fontified t)) . -21658) (undo-tree-id19 . -1) (#(" " 0 1 (fontified t)) . -21659) (undo-tree-id20 . -1) 21660) nil (26985 57084 715100 0) 0 nil])
([nil nil ((21657 . 21659)) nil (26985 57084 715098 0) 0 nil])
([nil nil ((21659 . 21660)) nil (26985 57084 715097 0) 0 nil])
([nil nil ((21660 . 21663)) nil (26985 57084 715097 0) 0 nil])
([nil nil ((21663 . 21664)) nil (26985 57084 715096 0) 0 nil])
([nil nil ((21664 . 21673)) nil (26985 57084 715096 0) 0 nil])
([nil nil ((#("W" 0 1 (face font-lock-string-face fontified t)) . -21671) (undo-tree-id16 . -1) (#("O" 0 1 (face font-lock-string-face fontified t)) . -21672) (undo-tree-id17 . -1) 21673) nil (26985 57084 715095 0) 0 nil])
([nil nil ((21671 . 21672)) nil (26985 57084 715093 0) 0 nil])
([nil nil ((21672 . 21675)) nil (26985 57084 715093 0) 0 nil])
([nil nil ((21675 . 21678)) nil (26985 57084 715092 0) 0 nil])
([nil nil ((21678 . 21684)) nil (26985 57084 715092 0) 0 nil])
([nil nil ((21684 . 21685)) nil (26985 57084 715091 0) 0 nil])
([nil nil ((21685 . 21689)) nil (26985 57084 715091 0) 0 nil])
([nil nil ((21689 . 21692)) nil (26985 57084 715090 0) 0 nil])
([nil nil ((21692 . 21693)) nil (26985 57084 715090 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -21692) (undo-tree-id15 . -1) 21693) nil (26985 57084 715089 0) 0 nil])
([nil nil ((21692 . 21698)) nil (26985 57084 715087 0) 0 nil])
([nil nil ((21698 . 21699)) nil (26985 57084 715087 0) 0 nil])
([nil nil ((21699 . 21702)) nil (26985 57084 715086 0) 0 nil])
([nil nil ((21702 . 21708)) nil (26985 57084 715085 0) 0 nil])
([nil nil ((21699 . 21709) (#("secure-ro" 0 9 (fontified t)) . -21699) (undo-tree-id12 . -9) (undo-tree-id13 . -9) (undo-tree-id14 . -9) 21708) nil (26985 57084 715083 0) 0 nil])
([nil nil ((21709 . 21710)) nil (26985 57084 715069 0) 0 nil])
([nil nil ((#("(print \"IN REPO-SHOW\")
		(print row)
		(print secure-row)" 0 7 (fontified t) 7 21 (face font-lock-string-face fontified t) 21 23 (fontified t) 23 37 (fontified t) 37 46 (fontified t) 46 57 (fontified t)) . 21653) (undo-tree-id97 . -46) (undo-tree-id98 . -57) (undo-tree-id99 . -57) 21710 (t 26985 57084 0 0)) nil (26985 57630 93828 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -21652) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (#(" " 0 1 (fontified nil)) . -21653) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (#(" " 0 1 (fontified nil)) . -21654) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (#(" " 0 1 (fontified t)) . -21655) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (#(" " 0 1 (fontified t)) . -21656) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (#(" " 0 1 (fontified t)) . -21657) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (#(" " 0 1 (fontified t)) . -21658) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (#(" " 0 1 (fontified nil)) . -21659) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (#("	" 0 1 (fontified nil)) . 21660) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (21652 . 21660) 21653) nil (26985 57630 93824 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -21650) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (#(" " 0 1 (fontified t)) . -21651) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (#(" " 0 1 (fontified t)) . -21652) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (#(" " 0 1 (fontified t)) . -21653) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (#(" " 0 1 (fontified t)) . -21654) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (#(" " 0 1 (fontified t)) . -21655) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (#(" " 0 1 (fontified t)) . -21656) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (#(" " 0 1 (fontified t)) . -21657) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (#(" " 0 1 (fontified nil)) . -21658) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (#("	" 0 1 (fontified nil)) . 21659) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (21651 . 21659) 21652) nil (26985 57630 93799 0) 0 nil])
([nil nil ((20189 . 20196)) nil (26985 57630 136057 0) 0 nil])
([nil nil ((20196 . 20202)) nil (26985 57643 712099 0) 0 nil] [nil nil ((nil rear-nonsticky nil 20205 . 20206) (nil fontified nil 20196 . 20206) (20196 . 20206)) ((#("repo-after" 0 9 (fontified nil) 9 10 (rear-nonsticky nil fontified nil)) . 20196) (undo-tree-id100 . -10) (nil rear-nonsticky t 20205 . 20206)) (26985 57630 93755 0) 0 nil])
([nil nil ((20202 . 20203)) nil (26985 57643 712098 0) 0 nil])
nil
([nil nil ((20203 . 20222)) nil (26985 57643 712097 0) 0 nil])
([nil nil ((20243 . 20250)) nil (26985 57643 712096 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20275 . 20276) (nil fontified nil 20275 . 20276) (nil fontified nil 20257 . 20275) (nil fontified nil 20250 . 20257) (20250 . 20276)) nil (26985 57643 712092 0) 0 nil])
([nil nil ((20330 . 20337) (t 26985 57643 0 0)) nil (26985 57967 869570 0) 0 nil])
([nil nil ((nil fontified nil 20362 . 20363) (nil fontified nil 20344 . 20362) (nil fontified nil 20337 . 20344) (20337 . 20363)) nil (26985 57967 869569 0) 0 nil])
([nil nil ((20363 . 20370)) nil (26985 57967 869568 0) 0 nil])
([nil nil ((12477 . 12480)) nil (26985 57967 869567 0) 0 nil])
([nil nil ((12480 . 12486)) nil (26985 57967 869567 0) 0 nil])
([nil nil ((12486 . 12487)) nil (26985 57967 869566 0) 0 nil])
([nil nil ((12487 . 12493)) nil (26985 57967 869566 0) 0 nil])
([nil nil ((12493 . 12494)) nil (26985 57967 869565 0) 0 nil])
([nil nil ((12494 . 12496)) nil (26985 57967 869565 0) 0 nil])
([nil nil ((12496 . 12497)) nil (26985 57967 869564 0) 0 nil])
([nil nil ((12497 . 12509)) nil (26985 57967 869560 0) 0 nil])
([nil nil ((20329 . 20335) (t 26985 57967 0 0)) nil (26985 58041 290154 0) 0 nil])
([nil nil ((20335 . 20336)) nil (26985 58041 290154 0) 0 nil])
([nil nil ((20369 . 20370)) nil (26985 58041 290153 0) 0 nil])
([nil nil ((20403 . 20410)) nil (26985 58041 290153 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20442 . 20443) (nil fontified nil 20410 . 20443) (20410 . 20443)) nil (26985 58041 290152 0) 0 nil])
([nil nil ((#("
		    (print \"****************\")
                    (print (repo-after op entity ctx result))" 0 1 (fontified t) 1 7 (fontified t) 7 14 (fontified t) 14 32 (face font-lock-string-face fontified t) 32 33 (fontified t rear-nonsticky t) 33 34 (fontified t) 34 95 (fontified t)) . 20275) (undo-tree-id101 . -95) (undo-tree-id102 . -7) (undo-tree-id103 . -62) (undo-tree-id104 . -72) (undo-tree-id105 . -54) (undo-tree-id106 . -34) (undo-tree-id107 . -59) (undo-tree-id108 . -59) (undo-tree-id109 . -34) (undo-tree-id110 . -61) (undo-tree-id111 . -34) (undo-tree-id112 . -61) (undo-tree-id113 . -61) (undo-tree-id114 . -61) (undo-tree-id115 . -61) (undo-tree-id116 . -61) (undo-tree-id117 . -61) (undo-tree-id118 . -61) (undo-tree-id119 . -61) (undo-tree-id120 . -53) (undo-tree-id121 . -61) (undo-tree-id122 . -94) (undo-tree-id123 . -94) (undo-tree-id124 . -94) (undo-tree-id125 . -94) (undo-tree-id126 . -34) (undo-tree-id127 . -95) (undo-tree-id128 . -95) (undo-tree-id129 . -95) (undo-tree-id130 . -95) (undo-tree-id131 . -95) (undo-tree-id132 . -61) (undo-tree-id133 . -95) (undo-tree-id134 . -95) (undo-tree-id135 . -95) (undo-tree-id136 . -33) (undo-tree-id137 . -33) (undo-tree-id138 . -33) (undo-tree-id139 . -33) (undo-tree-id140 . -95)) nil (26985 58041 290148 0) 0 nil])
([nil nil ((#(";; API Générique" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 16 (face font-lock-comment-face fontified t)) . 10878) (undo-tree-id148 . -16) (t 26985 58041 0 0)) nil (26985 58438 262042 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11072 . 11073) (nil fontified nil 10998 . 11073) (nil fontified nil 10994 . 10998) (nil fontified nil 10962 . 10994) (nil fontified nil 10958 . 10962) (nil fontified nil 10956 . 10958) (nil fontified nil 10882 . 10956) (nil fontified nil 10878 . 10882) (10878 . 11073)) nil (26985 58438 262040 0) 0 nil])
([nil nil ((11760 . 11761)) nil (26985 58438 262038 0) 0 nil])
([nil nil ((nil fontified nil 11839 . 11840) (nil fontified nil 11765 . 11839) (nil fontified nil 11761 . 11765) (11761 . 11840)) nil (26985 58438 262038 0) 0 nil])
([nil nil ((11549 . 11550)) nil (26985 58438 262037 0) 0 nil])
([nil nil ((13333 . 13334)) nil (26985 58438 262035 0) 0 nil])
([nil nil ((#("q" 0 1 (fontified t)) . -13333) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id147 . -1) 13334) nil (26985 58438 262032 0) 0 nil])
([nil nil ((20819 . 20820) (t 26985 58438 0 0)) nil (26985 59177 66305 0) 0 nil])
([nil nil ((19226 . 19229)) nil (26985 59177 66304 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19320 . 19321) (nil fontified nil 19229 . 19321) (19229 . 19321)) nil (26985 59177 66300 0) 0 nil])
([nil nil ((13694 . 13696) (t 26985 59177 0 0)) nil (26985 60084 658468 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -13694) (undo-tree-id0 . -1) (#(" " 0 1 (fontified t)) . -13695) (undo-tree-id1 . -1) 13696) nil (26985 60084 658464 0) 0 nil])
([nil nil ((14138 . 14141) (t 26985 60084 0 0)) nil (26990 19945 643497 0) 0 nil])
([nil nil ((14141 . 14143)) nil (26990 19945 643496 0) 0 nil])
([nil nil ((14143 . 14144)) nil (26990 19945 643496 0) 0 nil])
([nil nil ((14144 . 14150)) nil (26990 19945 643495 0) 0 nil])
([nil nil ((14150 . 14151)) nil (26990 19945 643495 0) 0 nil])
([nil nil ((14151 . 14164)) nil (26990 19945 643494 0) 0 nil])
([nil nil ((14229 . 14234)) nil (26990 19945 643494 0) 0 nil])
([nil nil ((14234 . 14240)) nil (26990 19945 643493 0) 0 nil])
([nil nil ((14240 . 14241)) nil (26990 19945 643493 0) 0 nil])
([nil nil ((14241 . 14252)) nil (26990 19945 643493 0) 0 nil])
([nil nil ((14252 . 14257)) nil (26990 19945 643492 0) 0 nil])
([nil nil ((14257 . 14263)) nil (26990 19945 643491 0) 0 nil])
([nil nil ((14263 . 14264)) nil (26990 19945 643491 0) 0 nil])
([nil nil ((14264 . 14272)) nil (26990 19945 643490 0) 0 nil])
([nil nil ((14272 . 14273)) nil (26990 19945 643486 0) 0 nil])
([nil nil ((14273 . 14278) (t 26990 19945 0 0)) nil (26990 20351 715742 0) 0 nil])
([nil nil ((14278 . 14284)) nil (26990 20351 715741 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -14280) (undo-tree-id13 . -1) (#("i" 0 1 (fontified t)) . -14281) (undo-tree-id14 . -1) (#("n" 0 1 (fontified t)) . -14282) (undo-tree-id15 . -1) (#("y" 0 1 (fontified t)) . -14283) (undo-tree-id16 . -1) 14284) nil (26990 20351 715740 0) 0 nil])
([nil nil ((14280 . 14284)) nil (26990 20351 715738 0) 0 nil])
([nil nil ((14284 . 14285)) nil (26990 20351 715737 0) 0 nil])
([nil nil ((14285 . 14291)) nil (26990 20351 715737 0) 0 nil])
([nil nil ((13883 . 13885) (#("   " 0 3 (fontified nil)) . -13865) (13885 . 13886)) nil (26990 20351 715736 0) 0 nil])
([nil nil ((13885 . 13886)) nil (26990 20351 715736 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -13885) (undo-tree-id12 . -1) 13886) nil (26990 20351 715735 0) 0 nil])
([nil nil ((13885 . 13886)) nil (26990 20351 715734 0) 0 nil])
([nil nil ((13886 . 13891)) nil (26990 20351 715734 0) 0 nil])
([nil nil ((13891 . 13892)) nil (26990 20351 715734 0) 0 nil])
([nil nil ((13892 . 13895)) nil (26990 20351 715733 0) 0 nil])
([nil nil ((13895 . 13896)) nil (26990 20351 715733 0) 0 nil])
([nil nil ((13896 . 13905)) nil (26990 20351 715732 0) 0 nil])
([nil nil ((13905 . 13906)) nil (26990 20351 715732 0) 0 nil])
([nil nil ((#("6" 0 1 (face font-lock-string-face fontified t)) . -13900) (undo-tree-id6 . -1) (#("I" 0 1 (face font-lock-string-face fontified t)) . -13901) (undo-tree-id7 . -1) (#("D" 0 1 (face font-lock-string-face fontified t)) . -13902) (undo-tree-id8 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -13903) (undo-tree-id9 . -1) (#("X" 0 1 (face font-lock-string-face fontified t)) . -13904) (undo-tree-id10 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -13905) (undo-tree-id11 . -1) 13906) nil (26990 20351 715731 0) 0 nil])
([nil nil ((13900 . 13903)) nil (26990 20351 715726 0) 0 nil])
([nil nil ((13903 . 13906)) nil (26990 20351 715726 0) 0 nil])
([nil nil ((13906 . 13907)) nil (26990 20351 715725 0) 0 nil])
([nil nil ((13907 . 13918)) nil (26990 20351 715725 0) 0 nil])
([nil nil ((13962 . 13965)) nil (26990 20351 715725 0) 0 nil])
([nil nil ((13965 . 13967)) nil (26990 20351 715724 0) 0 nil])
([nil nil ((13967 . 13968)) nil (26990 20351 715724 0) 0 nil])
([nil nil ((13968 . 13975)) nil (26990 20351 715724 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -13974) (undo-tree-id5 . -1) 13975) nil (26990 20351 715723 0) 0 nil])
([nil nil ((13974 . 13975)) nil (26990 20351 715722 0) 0 nil])
([nil nil ((13975 . 13982)) nil (26990 20351 715721 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -13981) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 13982) nil (26990 20351 715720 0) 0 nil])
([nil nil ((13981 . 13983)) nil (26990 20351 715704 0) 0 nil])
([nil nil ((14019 . 14022)) nil (26990 20351 715703 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14039 . 14040) (nil fontified nil 14038 . 14040) (nil fontified nil 14032 . 14038) (nil fontified nil 14022 . 14032) (14022 . 14040)) nil (26990 20351 715703 0) 0 nil])
([nil nil ((14122 . 14125)) nil (26990 20351 715702 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14142 . 14143) (nil fontified nil 14141 . 14143) (nil fontified nil 14135 . 14141) (nil fontified nil 14125 . 14135) (14125 . 14143)) nil (26990 20351 715701 0) 0 nil])
([nil nil ((14184 . 14187)) nil (26990 20351 715700 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14204 . 14205) (nil fontified nil 14203 . 14205) (nil fontified nil 14197 . 14203) (nil fontified nil 14187 . 14197) (14187 . 14205)) nil (26990 20351 715697 0) 0 nil])
([nil nil ((13882 . 13885) (t 26990 20351 0 0)) nil (26990 20802 830743 0) 0 nil])
([nil nil ((13885 . 13891)) nil (26990 20802 830742 0) 0 nil])
([nil nil ((13891 . 13892)) nil (26990 20802 830742 0) 0 nil])
([nil nil ((13892 . 13897)) nil (26990 20802 830742 0) 0 nil])
([nil nil ((#("(print ctsx)" 0 12 (fontified t)) . 13885) (undo-tree-id25 . -12)) nil (26990 20802 830741 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -13882) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (#(" " 0 1 (fontified t)) . -13883) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (#(" " 0 1 (fontified t)) . -13884) (undo-tree-id23 . -1) (undo-tree-id24 . -1) 13885) nil (26990 20802 830740 0) 0 nil])
([nil nil ((13918 . 13921)) nil (26990 20802 830735 0) 0 nil])
([nil nil ((13921 . 13927)) nil (26990 20802 830735 0) 0 nil])
([nil nil ((13927 . 13928)) nil (26990 20802 830735 0) 0 nil])
([nil nil ((13928 . 13930)) nil (26990 20802 830734 0) 0 nil])
([nil nil ((#("x" 0 1 (fontified t)) . -13928) (undo-tree-id17 . -1) (#("t" 0 1 (fontified t)) . -13929) (undo-tree-id18 . -1) 13930) nil (26990 20802 830733 0) 0 nil])
([nil nil ((13928 . 13932)) nil (26990 20802 830719 0) 0 nil])
([nil nil ((#("dr (assoc" 0 9 (fontified t)) . -20421) (undo-tree-id42 . -9) 20430 (t 26990 20802 0 0)) nil (26990 27973 293088 0) 0 nil])
([nil nil ((20421 . 20423)) nil (26990 27973 293086 0) 0 nil])
([nil nil ((#("c" 0 1 (fontified t)) . -20420) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (#("l" 0 1 (fontified t)) . -20421) (undo-tree-id40 . -1) (#("u" 0 1 (fontified t)) . -20422) (undo-tree-id41 . -1) 20423) nil (26990 27973 293085 0) 0 nil])
([nil nil ((20420 . 20431)) nil (26990 27973 293082 0) 0 nil])
([nil nil ((20420 . 20439) (#("lumen.utils" 0 11 (fontified t)) . -20420) (undo-tree-id37 . -11) 20431) nil (26990 27973 293081 0) 0 nil])
([nil nil ((20420 . 20441) (#("lumen.utils:col-get" 0 19 (fontified t)) . -20420) (undo-tree-id36 . -19) 20439) nil (26990 27973 293080 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20428 . 20429) (nil fontified nil 20419 . 20429) (20419 . 20429)) nil (26990 27973 293079 0) 0 nil])
([nil nil ((20429 . 20430)) nil (26990 27973 293078 0) 0 nil])
([nil nil ((#("args-alist" 0 10 (fontified t)) . 20462) (undo-tree-id35 . -10) 20472) nil (26990 27973 293078 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20462 . 20463) (nil fontified nil 20453 . 20463) (20453 . 20463)) nil (26990 27973 293076 0) 0 nil])
([nil nil ((20463 . 20464)) nil (26990 27973 293076 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -20472) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (#(")" 0 1 (fontified t)) . -20473) (undo-tree-id33 . -1) (#(")" 0 1 (fontified t)) . -20474) (undo-tree-id34 . -1) 20475) nil (26990 27973 293075 0) 0 nil])
([nil nil ((20482 . 20483)) nil (26990 27973 293072 0) 0 nil])
([nil nil ((20323 . 20329)) nil (26990 27973 293071 0) 0 nil])
([nil nil ((20329 . 20330)) nil (26990 27973 293071 0) 0 nil])
([nil nil ((20330 . 20339)) nil (26990 27973 293071 0) 0 nil])
([nil nil ((20339 . 20344)) nil (26990 27973 293070 0) 0 nil])
([nil nil ((20344 . 20345)) nil (26990 27973 293070 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -20344) (undo-tree-id30 . -1) 20345) nil (26990 27973 293069 0) 0 nil])
([nil nil ((20344 . 20347)) nil (26990 27973 293068 0) 0 nil])
([nil nil ((20347 . 20351)) nil (26990 27973 293068 0) 0 nil])
([nil nil ((#("g" 0 1 (fontified t)) . -20349) (undo-tree-id28 . -1) (#("t" 0 1 (fontified t)) . -20350) (undo-tree-id29 . -1) 20351) nil (26990 27973 293067 0) 0 nil])
([nil nil ((20349 . 20350)) nil (26990 27973 293063 0) 0 nil])
([nil nil ((20350 . 20351)) nil (26990 27973 293062 0) 0 nil])
([nil nil ((20351 . 20361)) nil (26990 27973 293062 0) 0 nil])
([nil nil ((20356 . 20357)) nil (26990 27973 293061 0) 0 nil])
([nil nil ((20524 . 20528) (#("		  " 0 4 (fontified nil)) . 20523) (undo-tree-id27 . -4) (20522 . 20528)) nil (26990 27973 293061 0) 0 nil])
([nil nil ((20528 . 20530)) nil (26990 27973 293058 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -20529) (undo-tree-id26 . -1) 20530) nil (26990 27973 293057 0) 0 nil])
([nil nil ((20529 . 20534)) nil (26990 27973 293047 0) 0 nil])
([nil nil ((20534 . 20535)) nil (26990 27973 293047 0) 0 nil])
([nil nil ((20535 . 20546)) nil (26990 27973 293047 0) 0 nil])
([nil nil ((20546 . 20551)) nil (26990 27973 293046 0) 0 nil])
([nil nil ((20551 . 20557)) nil (26990 27973 293046 0) 0 nil])
([nil nil ((20557 . 20558)) nil (26990 27973 293045 0) 0 nil])
([nil nil ((20558 . 20564)) nil (26990 27973 293045 0) 0 nil])
([nil nil ((20564 . 20565)) nil (26990 27973 293044 0) 0 nil])
([nil nil ((20565 . 20584)) nil (26990 27973 293040 0) 0 nil])
([nil nil ((16556 . 16558) (t 26990 27973 0 0)) nil (26990 32157 555136 0) 0 nil])
([nil nil ((16558 . 16564)) nil (26990 32157 555136 0) 0 nil])
([nil nil ((16564 . 16565)) nil (26990 32157 555135 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16588 . 16589) (nil fontified nil 16565 . 16589) (16565 . 16589)) nil (26990 32157 555135 0) 0 nil])
([nil nil ((16589 . 16590)) nil (26990 32157 555134 0) 0 nil])
([nil nil ((16590 . 16592)) nil (26990 32157 555134 0) 0 nil])
([nil nil ((16592 . 16598)) nil (26990 32157 555134 0) 0 nil])
([nil nil ((16598 . 16599)) nil (26990 32157 555133 0) 0 nil])
([nil nil ((16599 . 16605)) nil (26990 32157 555133 0) 0 nil])
([nil nil ((#("N" 0 1 (face font-lock-string-face fontified t)) . -16601) (undo-tree-id45 . -1) (#("S" 0 1 (face font-lock-string-face fontified t)) . -16602) (undo-tree-id46 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -16603) (undo-tree-id47 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -16604) (undo-tree-id48 . -1) 16605) nil (26990 32157 555132 0) 0 nil])
([nil nil ((#("I" 0 1 (face font-lock-string-face fontified t)) . -16600) (undo-tree-id44 . -1) 16601) nil (26990 32157 555128 0) 0 nil])
([nil nil ((16600 . 16605)) nil (26990 32157 555126 0) 0 nil])
([nil nil ((16605 . 16606)) nil (26990 32157 555126 0) 0 nil])
([nil nil ((16606 . 16613)) nil (26990 32157 555125 0) 0 nil])
([nil nil ((#("I" 0 1 (face font-lock-string-face fontified t)) . -16612) (undo-tree-id43 . -1) 16613) nil (26990 32157 555124 0) 0 nil])
([nil nil ((16612 . 16613)) nil (26990 32157 555111 0) 0 nil])
([nil nil ((16613 . 16614)) nil (26990 32157 555110 0) 0 nil])
([nil nil ((16614 . 16618)) nil (26990 32157 555106 0) 0 nil])
([nil nil ((16556 . 16558) (t 26990 32157 0 0)) nil (26990 32255 661509 0) 0 nil])
([nil nil ((16558 . 16564)) nil (26990 32255 661509 0) 0 nil])
([nil nil ((16564 . 16565)) nil (26990 32255 661508 0) 0 nil])
([nil nil ((16565 . 16572)) nil (26990 32255 661508 0) 0 nil])
([nil nil ((16572 . 16573)) nil (26990 32255 661508 0) 0 nil])
([nil nil ((16573 . 16578)) nil (26990 32255 661507 0) 0 nil])
([nil nil ((16578 . 16579)) nil (26990 32255 661507 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -16578) (undo-tree-id60 . -1) 16579) nil (26990 32255 661506 0) 0 nil])
([nil nil ((16578 . 16579)) nil (26990 32255 661505 0) 0 nil])
([nil nil ((#("R" 0 1 (face font-lock-string-face fontified t)) . -16578) (undo-tree-id59 . -1) 16579) nil (26990 32255 661505 0) 0 nil])
([nil nil ((16578 . 16579)) nil (26990 32255 661501 0) 0 nil])
([nil nil ((16579 . 16580)) nil (26990 32255 661500 0) 0 nil])
([nil nil ((16580 . 16583)) nil (26990 32255 661500 0) 0 nil])
([nil nil ((16583 . 16584)) nil (26990 32255 661499 0) 0 nil])
([nil nil ((#("ROW" 0 3 (face font-lock-string-face fontified t)) . -16580) (undo-tree-id49 . -3) (undo-tree-id50 . -2) (undo-tree-id51 . -2) (undo-tree-id52 . -2) (undo-tree-id53 . -2) (undo-tree-id54 . -2) (undo-tree-id55 . -3) (undo-tree-id56 . -3) (undo-tree-id57 . -3) (undo-tree-id58 . -3) 16583) nil (26990 32255 661498 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16596 . 16597) (nil fontified nil 16580 . 16597) (16580 . 16597)) nil (26990 32255 661481 0) 0 nil])
([nil nil ((16597 . 16599)) nil (26990 32255 661481 0) 0 nil])
([nil nil ((16580 . 16586) (#("entity" 0 6 (face font-lock-string-face fontified t)) . 16580)) nil (26990 32255 661480 0) 0 nil])
([nil nil ((16586 . 16591) (#("->row" 0 5 (face font-lock-string-face fontified t)) . 16586)) nil (26990 32255 661478 0) 0 nil])
([nil nil ((16591 . 16597) (#("-alist" 0 5 (face font-lock-string-face fontified t) 5 6 (face font-lock-string-face rear-nonsticky t fontified t)) . 16591)) nil (26990 32255 661474 0) 0 nil])
([nil nil ((16556 . 16558) (t 26990 32255 0 0)) nil (26990 32304 337001 0) 0 nil])
([nil nil ((16558 . 16564)) nil (26990 32304 337001 0) 0 nil])
([nil nil ((16564 . 16565)) nil (26990 32304 337000 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16568 . 16569) (nil fontified nil 16565 . 16569) (16565 . 16569)) nil (26990 32304 336999 0) 0 nil])
([nil nil ((16569 . 16570)) nil (26990 32304 336994 0) 0 nil])
([nil nil ((#("
	(print \"***** PERSIST OK\")" 0 1 (fontified t) 1 9 (fontified t) 9 10 (face font-lock-string-face fontified t) 10 26 (face font-lock-string-face fontified t) 26 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 16648) (undo-tree-id103 . -28) (t 26990 32304 0 0)) nil (26991 9766 893567 0) 0 nil])
([nil nil ((#("
	(print ent2)
	(print \"****** BEFORE ENTITY->ROW-ALIST\") " 0 1 (fontified t) 1 9 (fontified t) 9 12 (fontified t) 12 13 (rear-nonsticky t fontified t) 13 14 (fontified t) 14 15 (fontified t) 15 23 (fontified t) 23 38 (face font-lock-string-face fontified t) 38 54 (face font-lock-string-face fontified t) 54 55 (face font-lock-string-face fontified t rear-nonsticky t) 55 56 (face font-lock-string-face fontified t) 56 57 (fontified t) 57 58 (fontified t)) . 16556) (undo-tree-id99 . -58) (undo-tree-id100 . -55) (undo-tree-id101 . -55) (undo-tree-id102 . -55)) nil (26991 9766 893566 0) 0 nil])
([nil nil ((#("
	(print (entity->row-alist ent2))" 0 1 (fontified t) 1 9 (fontified t) 9 32 (fontified t) 32 33 (fontified t rear-nonsticky t) 33 34 (fontified t)) . 16556) (undo-tree-id98 . -34)) nil (26991 9766 893563 0) 0 nil])
([nil nil ((15848 . 15855)) nil (26991 9766 893562 0) 0 nil])
([nil nil ((15855 . 15856)) nil (26991 9766 893562 0) 0 nil])
([nil nil ((15837 . 15840)) nil (26991 9766 893561 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15896 . 15897) (nil fontified nil 15891 . 15897) (nil fontified nil 15887 . 15891) (nil fontified nil 15886 . 15887) (nil fontified nil 15859 . 15886) (nil fontified nil 15851 . 15859) (nil fontified nil 15850 . 15851) (nil fontified nil 15840 . 15850) (15840 . 15897)) nil (26991 9766 893560 0) 0 nil])
([nil nil ((#("REPO-PERSIT:PATCH:PAYLOAD* : ~A" 0 6 (face font-lock-string-face fontified t) 6 31 (face font-lock-string-face fontified t)) . -15853) (undo-tree-id97 . -31) 15884) nil (26991 9766 893559 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15874 . 15875) (nil fontified nil 15871 . 15875) (nil fontified nil 15861 . 15871) (nil fontified nil 15853 . 15861) (15853 . 15875)) nil (26991 9766 893558 0) 0 nil])
([nil nil ((#("N" 0 1 (face font-lock-string-face fontified t)) . -15862) (undo-tree-id96 . -1) 15863) nil (26991 9766 893557 0) 0 nil])
([nil nil ((15862 . 15863)) nil (26991 9766 893557 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-string-face fontified t)) . -15862) (undo-tree-id95 . -1) 15863) nil (26991 9766 893556 0) 0 nil])
([nil nil ((15862 . 15863)) nil (26991 9766 893555 0) 0 nil])
([nil nil ((#("," 0 1 (face font-lock-string-face fontified t)) . -15862) (undo-tree-id94 . -1) 15863) nil (26991 9766 893555 0) 0 nil])
([nil nil ((15862 . 15863)) nil (26991 9766 893551 0) 0 nil])
([nil nil ((15875 . 15876)) nil (26991 9766 893551 0) 0 nil])
([nil nil ((15876 . 15880)) nil (26991 9766 893550 0) 0 nil])
([nil nil ((#("payload" 0 3 (fontified t) 3 7 (fontified t)) . -15884) (undo-tree-id93 . -7) 15891) nil (26991 9766 893549 0) 0 nil])
([nil nil ((15884 . 15885)) nil (26991 9766 893548 0) 0 nil])
([nil nil ((15885 . 15890)) nil (26991 9766 893548 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . 15890)) nil (26991 9766 893548 0) 0 nil])
([nil nil ((#("
  (print \"[Lumen] IN REPO CREATE\")" 0 1 (fontified t) 1 10 (fontified t) 10 19 (face font-lock-string-face fontified t) 19 29 (face font-lock-string-face fontified t) 29 33 (face font-lock-string-face fontified t) 33 34 (face font-lock-string-face fontified t) 34 35 (fontified t)) . 15891) (undo-tree-id92 . -35)) nil (26991 9766 893547 0) 0 nil])
([nil nil ((16001 . 16004)) nil (26991 9766 893546 0) 0 nil])
([nil nil ((nil fontified nil 16054 . 16055) (nil fontified nil 16047 . 16054) (nil fontified nil 16046 . 16047) (nil fontified nil 16044 . 16046) (nil fontified nil 16039 . 16044) (nil fontified nil 16038 . 16039) (nil fontified nil 16035 . 16038) (nil fontified nil 16025 . 16035) (nil fontified nil 16017 . 16025) (nil fontified nil 16015 . 16017) (nil fontified nil 16014 . 16015) (nil fontified nil 16004 . 16014) (16004 . 16055)) nil (26991 9766 893545 0) 0 nil])
([nil nil ((#("CREATE" 0 2 (face font-lock-string-face fontified t) 2 5 (face font-lock-string-face fontified t) 5 6 (face font-lock-string-face fontified t rear-nonsticky t)) . -16033) (undo-tree-id91 . -6) 16039) nil (26991 9766 893544 0) 0 nil])
([nil nil ((16033 . 16034)) nil (26991 9766 893543 0) 0 nil])
([nil nil ((#("p" 0 1 (face font-lock-string-face fontified t)) . -16033) (undo-tree-id90 . -1) 16034) nil (26991 9766 893543 0) 0 nil])
([nil nil ((16033 . 16038)) nil (26991 9766 893542 0) 0 nil])
([nil nil ((16163 . 16166)) nil (26991 9766 893541 0) 0 nil])
([nil nil ((nil fontified nil 16216 . 16217) (nil fontified nil 16209 . 16216) (nil fontified nil 16208 . 16209) (nil fontified nil 16206 . 16208) (nil fontified nil 16201 . 16206) (nil fontified nil 16200 . 16201) (nil fontified nil 16197 . 16200) (nil fontified nil 16187 . 16197) (nil fontified nil 16179 . 16187) (nil fontified nil 16177 . 16179) (nil fontified nil 16176 . 16177) (nil fontified nil 16166 . 16176) (16166 . 16217)) nil (26991 9766 893541 0) 0 nil])
([nil nil ((#("CREATE" 0 2 (face font-lock-string-face fontified t) 2 5 (face font-lock-string-face fontified t) 5 6 (face font-lock-string-face fontified t rear-nonsticky t)) . -16195) (undo-tree-id89 . -6) 16201) nil (26991 9766 893539 0) 0 nil])
([nil nil ((16195 . 16201)) nil (26991 9766 893538 0) 0 nil])
([nil nil ((15284 . 15287)) nil (26991 9766 893538 0) 0 nil])
([nil nil ((nil fontified nil 15337 . 15338) (nil fontified nil 15330 . 15337) (nil fontified nil 15329 . 15330) (nil fontified nil 15327 . 15329) (nil fontified nil 15322 . 15327) (nil fontified nil 15321 . 15322) (nil fontified nil 15318 . 15321) (nil fontified nil 15308 . 15318) (nil fontified nil 15300 . 15308) (nil fontified nil 15298 . 15300) (nil fontified nil 15297 . 15298) (nil fontified nil 15287 . 15297) (15287 . 15338)) nil (26991 9766 893537 0) 0 nil])
([nil nil ((#("CREATE" 0 2 (face font-lock-string-face fontified t) 2 5 (face font-lock-string-face fontified t) 5 6 (face font-lock-string-face fontified t rear-nonsticky t)) . -15316) (undo-tree-id88 . -6) 15322) nil (26991 9766 893536 0) 0 nil])
([nil nil ((15316 . 15320)) nil (26991 9766 893535 0) 0 nil])
([nil nil ((#("(print \"IN REPO-INDEX OKOKOKOOK\")" 0 7 (fontified t) 7 32 (face font-lock-string-face fontified t) 32 33 (fontified t)) . -13885) (undo-tree-id87 . -33) 13918) nil (26991 9766 893534 0) 0 nil])
([nil nil ((nil fontified nil 13935 . 13936) (nil fontified nil 13928 . 13935) (nil fontified nil 13927 . 13928) (nil fontified nil 13925 . 13927) (nil fontified nil 13920 . 13925) (nil fontified nil 13919 . 13920) (nil fontified nil 13916 . 13919) (nil fontified nil 13906 . 13916) (nil fontified nil 13898 . 13906) (nil fontified nil 13896 . 13898) (nil fontified nil 13895 . 13896) (nil fontified nil 13885 . 13895) (13885 . 13936)) nil (26991 9766 893533 0) 0 nil])
([nil nil ((#("CREATE" 0 2 (face font-lock-string-face fontified t) 2 5 (face font-lock-string-face fontified t) 5 6 (face font-lock-string-face fontified t rear-nonsticky t)) . -13914) (undo-tree-id86 . -6) 13920) nil (26991 9766 893531 0) 0 nil])
([nil nil ((13914 . 13915)) nil (26991 9766 893530 0) 0 nil])
([nil nil ((#("O" 0 1 (face font-lock-string-face fontified t)) . -13914) (undo-tree-id85 . -1) 13915) nil (26991 9766 893530 0) 0 nil])
([nil nil ((13914 . 13919)) nil (26991 9766 893529 0) 0 nil])
([nil nil ((#("
  (print ctx)" 0 1 (fontified t) 1 14 (fontified t)) . 13935) (undo-tree-id84 . -14)) nil (26991 9766 893528 0) 0 nil])
([nil nil ((#("
	 (x (print \"OKKK\"))" 0 1 (fontified t) 1 13 (fontified t) 13 19 (face font-lock-string-face fontified t) 19 21 (fontified t)) . 13979) (undo-tree-id83 . -21)) nil (26991 9766 893527 0) 0 nil])
([nil nil ((#("
	 (x (print \"OKKK\"))" 0 1 (fontified t) 1 3 (fontified t) 3 13 (fontified t) 13 19 (face font-lock-string-face fontified t) 19 20 (fontified t) 20 21 (fontified t rear-nonsticky t)) . 14015) (undo-tree-id82 . -21)) nil (26991 9766 893526 0) 0 nil])
([nil nil ((#("
	 (x (print \"OKKK\"))" 0 1 (fontified t) 1 3 (fontified t) 3 13 (fontified t) 13 19 (face font-lock-string-face fontified t) 19 20 (fontified t) 20 21 (fontified t rear-nonsticky t)) . 14097) (undo-tree-id81 . -21)) nil (26991 9766 893525 0) 0 nil])
([nil nil ((#("
	 (x (print \"OKKK\"))" 0 1 (fontified t) 1 3 (fontified t) 3 13 (fontified t) 13 19 (face font-lock-string-face fontified t) 19 20 (fontified t) 20 21 (fontified t rear-nonsticky t)) . 14138) (undo-tree-id80 . -21)) nil (26991 9766 893524 0) 0 nil])
([nil nil ((#("
	 (x (print \"YESYESYES\"))" 0 1 (fontified t) 1 13 (fontified t) 13 14 (face font-lock-string-face fontified t) 14 23 (face font-lock-string-face fontified t) 23 24 (face font-lock-string-face fontified t) 24 26 (fontified t)) . 14188) (undo-tree-id79 . -26)) nil (26991 9766 893523 0) 0 nil])
([nil nil ((#("
    (print \"FILTERS*\")
    (print filters*)
    (print table)" 0 1 (fontified t) 1 12 (fontified t) 12 13 (face font-lock-string-face fontified t) 13 21 (face font-lock-string-face fontified t) 21 22 (face font-lock-string-face fontified t) 22 24 (fontified t) 24 45 (fontified t) 45 62 (fontified t)) . 14253) (undo-tree-id78 . -62)) nil (26991 9766 893522 0) 0 nil])
([nil nil ((#("(print \"***** IN REPO-AFTER\")" 0 7 (fontified t) 7 28 (face font-lock-string-face fontified t) 28 29 (fontified t)) . -12740) (undo-tree-id77 . -29) 12769) nil (26991 9766 893521 0) 0 nil])
([nil nil ((nil fontified nil 12789 . 12790) (nil fontified nil 12782 . 12789) (nil fontified nil 12781 . 12782) (nil fontified nil 12779 . 12781) (nil fontified nil 12774 . 12779) (nil fontified nil 12761 . 12774) (nil fontified nil 12753 . 12761) (nil fontified nil 12751 . 12753) (nil fontified nil 12750 . 12751) (nil fontified nil 12740 . 12750) (12740 . 12790)) nil (26991 9766 893520 0) 0 nil])
([nil nil ((#("INDEX" 0 5 (face font-lock-string-face fontified t)) . -12769) (undo-tree-id76 . -5) 12774) nil (26991 9766 893518 0) 0 nil])
([nil nil ((12769 . 12774)) nil (26991 9766 893518 0) 0 nil])
([nil nil ((12576 . 12579)) nil (26991 9766 893517 0) 0 nil])
([nil nil ((nil fontified nil 12628 . 12629) (nil fontified nil 12621 . 12628) (nil fontified nil 12620 . 12621) (nil fontified nil 12618 . 12620) (nil fontified nil 12613 . 12618) (nil fontified nil 12600 . 12613) (nil fontified nil 12592 . 12600) (nil fontified nil 12590 . 12592) (nil fontified nil 12589 . 12590) (nil fontified nil 12579 . 12589) (12579 . 12629)) nil (26991 9766 893516 0) 0 nil])
([nil nil ((#("INDEX" 0 5 (face font-lock-string-face fontified t)) . -12608) (undo-tree-id75 . -5) 12613) nil (26991 9766 893515 0) 0 nil])
([nil nil ((12608 . 12614)) nil (26991 9766 893514 0) 0 nil])
([nil nil ((12616 . 12620)) nil (26991 9766 893513 0) 0 nil])
([nil nil ((12620 . 12621)) nil (26991 9766 893513 0) 0 nil])
([nil nil ((12623 . 12624)) nil (26991 9766 893513 0) 0 nil])
([nil nil ((12624 . 12625)) nil (26991 9766 893512 0) 0 nil])
([nil nil ((12625 . 12626)) nil (26991 9766 893512 0) 0 nil])
([nil nil ((12626 . 12629)) nil (26991 9766 893511 0) 0 nil])
([nil nil ((12629 . 12630)) nil (26991 9766 893511 0) 0 nil])
([nil nil ((12630 . 12632)) nil (26991 9766 893510 0) 0 nil])
([nil nil ((12643 . 12644)) nil (26991 9766 893510 0) 0 nil])
([nil nil ((12644 . 12646)) nil (26991 9766 893509 0) 0 nil])
([nil nil ((12410 . 12413)) nil (26991 9766 893509 0) 0 nil])
([nil nil ((nil fontified nil 12480 . 12481) (nil fontified nil 12470 . 12480) (nil fontified nil 12469 . 12470) (nil fontified nil 12467 . 12469) (nil fontified nil 12448 . 12467) (nil fontified nil 12434 . 12448) (nil fontified nil 12426 . 12434) (nil fontified nil 12424 . 12426) (nil fontified nil 12423 . 12424) (nil fontified nil 12413 . 12423) (12413 . 12481)) nil (26991 9766 893508 0) 0 nil])
([nil nil ((#("BEFORE" 0 6 (face font-lock-string-face fontified t)) . -12442) (undo-tree-id74 . -6) 12448) nil (26991 9766 893507 0) 0 nil])
([nil nil ((12442 . 12450)) nil (26991 9766 893506 0) 0 nil])
([nil nil ((12305 . 12308)) nil (26991 9766 893506 0) 0 nil])
([nil nil ((nil fontified nil 12375 . 12376) (nil fontified nil 12365 . 12375) (nil fontified nil 12364 . 12365) (nil fontified nil 12362 . 12364) (nil fontified nil 12343 . 12362) (nil fontified nil 12329 . 12343) (nil fontified nil 12321 . 12329) (nil fontified nil 12319 . 12321) (nil fontified nil 12318 . 12319) (nil fontified nil 12308 . 12318) (12308 . 12376)) nil (26991 9766 893505 0) 0 nil])
([nil nil ((#("BEFORE" 0 6 (face font-lock-string-face fontified t)) . -12337) (undo-tree-id73 . -6) 12343) nil (26991 9766 893504 0) 0 nil])
([nil nil ((12337 . 12346)) nil (26991 9766 893503 0) 0 nil])
([nil nil ((#("P" 0 1 (face font-lock-string-face fontified t)) . 12338)) nil (26991 9766 893502 0) 0 nil])
([nil nil ((12338 . 12339)) nil (26991 9766 893502 0) 0 nil])
([nil nil ((11929 . 11932)) nil (26991 9766 893501 0) 0 nil])
([nil nil ((nil fontified nil 11999 . 12000) (nil fontified nil 11989 . 11999) (nil fontified nil 11988 . 11989) (nil fontified nil 11986 . 11988) (nil fontified nil 11967 . 11986) (nil fontified nil 11953 . 11967) (nil fontified nil 11945 . 11953) (nil fontified nil 11943 . 11945) (nil fontified nil 11942 . 11943) (nil fontified nil 11932 . 11942) (11932 . 12000)) nil (26991 9766 893500 0) 0 nil])
([nil nil ((#("BEFORE" 0 6 (face font-lock-string-face fontified t)) . -11961) (undo-tree-id72 . -6) 11967) nil (26991 9766 893499 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11969 . 11970) (nil fontified nil 11961 . 11970) (11961 . 11970)) nil (26991 9766 893498 0) 0 nil])
([nil nil ((11961 . 11970) (#("authorize" 0 8 (face font-lock-string-face fontified t) 8 9 (face font-lock-string-face rear-nonsticky t fontified t)) . 11961)) nil (26991 9766 893497 0) 0 nil])
([nil nil ((#("
      (format t \"~&REPO-PERSIT:PATCH:PAYLOAD* : ~A~%\" payload*)" 0 17 (fontified t) 17 18 (face font-lock-string-face fontified t) 18 26 (face font-lock-string-face fontified t) 26 53 (face font-lock-string-face fontified t) 53 54 (face font-lock-string-face fontified t) 54 58 (fontified t) 58 64 (fontified t)) . 17211) (undo-tree-id71 . -64)) nil (26991 9766 893496 0) 0 nil])
([nil nil ((#("
	  (format t \"~&REPO-PERSIT:PATCH:ENTITY UPDATE OK~%\")" 0 14 (fontified t) 14 15 (face font-lock-string-face fontified t) 15 22 (face font-lock-string-face fontified t) 22 53 (face font-lock-string-face fontified t) 53 54 (face font-lock-string-face fontified t) 54 55 (fontified t)) . 17719) (undo-tree-id70 . -55)) nil (26991 9766 893495 0) 0 nil])
([nil nil ((#("
      (format t \"~&REPO-PERSIT:PATCH:ENTITY VALIDATION OK~%\")" 0 17 (fontified t) 17 18 (face font-lock-string-face fontified t) 18 60 (face font-lock-string-face fontified t) 60 61 (face font-lock-string-face fontified t) 61 62 (fontified t)) . 17504) (undo-tree-id69 . -62)) nil (26991 9766 893494 0) 0 nil])
([nil nil ((#("
  (print \"IN REPO PERSIST\")" 0 1 (fontified t) 1 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 26 (face font-lock-string-face fontified t) 26 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 16563) (undo-tree-id68 . -28)) nil (26991 9766 893493 0) 0 nil])
([nil nil ((#("
                  (print filters*)
		  (print args-alist)" 0 1 (fontified t) 1 36 (fontified t) 36 58 (fontified t)) . 20425) (undo-tree-id67 . -58)) nil (26991 9766 893492 0) 0 nil])
([nil nil ((#("
  (print (list :ENTITY-PASSED entity :TYPE (type-of entity) :PACKAGE (symbol-package entity)))" 0 6 (fontified t) 6 16 (fontified t) 16 30 (face font-lock-builtin-face fontified t) 30 38 (fontified t) 38 43 (face font-lock-builtin-face fontified t) 43 61 (fontified t) 61 69 (face font-lock-builtin-face fontified t) 69 95 (fontified t)) . 19566) (undo-tree-id66 . -95)) nil (26991 9766 893491 0) 0 nil])
([nil nil ((#("

		  (print args-alist)
		  (print \"C'EST CAAAAAAAAAAAAAAAA\")" 0 1 (fontified t) 1 2 (fontified t) 2 25 (fontified t) 25 36 (fontified t) 36 61 (face font-lock-string-face fontified t) 61 62 (fontified t)) . 20490) (undo-tree-id65 . -62)) nil (26991 9766 893489 0) 0 nil])
([nil nil ((#("
		    (print \"****************\")
		    (print result)
		    (print \"****************\")" 0 14 (fontified t) 14 32 (face font-lock-string-face fontified t) 32 68 (fontified t) 68 86 (face font-lock-string-face fontified t) 86 87 (fontified t)) . 20823) (undo-tree-id64 . -87)) nil (26991 9766 893488 0) 0 nil])
([nil nil ((#("
      (print \"[REPO INDEX AROUND] OUT TX\")" 0 14 (fontified t) 14 41 (face font-lock-string-face fontified t) 41 42 (face font-lock-string-face fontified t) 42 43 (fontified t)) . 20877) (undo-tree-id63 . -43)) nil (26991 9766 893487 0) 0 nil])
([nil nil ((#("
      (print (%handle-tx-result res))
      (print \"OK\")" 0 1 (face font-lock-comment-face fontified t) 1 52 (fontified t) 52 56 (face font-lock-string-face fontified t) 56 57 (fontified t)) . 20940) (undo-tree-id62 . -57)) nil (26991 9766 893485 0) 0 nil])
([nil nil ((#("
      ;;(print \"YYYY\")
      ;;(print res)" 0 7 (fontified t) 7 9 (face font-lock-comment-delimiter-face fontified t) 9 24 (face font-lock-comment-face fontified t) 24 30 (fontified t) 30 32 (face font-lock-comment-delimiter-face fontified t) 32 43 (face font-lock-comment-face fontified t)) . 22989) (undo-tree-id61 . -43)) nil (26991 9766 893480 0) 0 nil])
([nil nil ((10876 . 10878) (t 26991 9766 0 0)) nil (26991 13218 466597 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11343 . 11344) (nil fontified nil 10878 . 11344) (10878 . 11344)) nil (26991 13218 466596 0) 0 nil])
([nil nil ((15797 . 15799)) nil (26991 13218 466596 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17749 . 17750) (nil fontified nil 15799 . 17750) (15799 . 17750)) nil (26991 13218 466595 0) 0 nil])
([nil nil ((#("D" 0 1 (face font-lock-comment-face fontified t)) . -14499) (undo-tree-id132 . -1) 14500) nil (26991 13218 466595 0) 0 nil])
([nil nil ((14499 . 14500)) nil (26991 13218 466593 0) 0 nil])
([nil nil ((14500 . 14501)) nil (26991 13218 466593 0) 0 nil])
([nil nil ((14501 . 14503)) nil (26991 13218 466592 0) 0 nil])
([nil nil ((15801 . 15803)) nil (26991 13218 466592 0) 0 nil])
([nil nil ((15803 . 15804)) nil (26991 13218 466591 0) 0 nil])
([nil nil ((18406 . 18408)) nil (26991 13218 466591 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19058 . 19059) (nil fontified nil 18408 . 19059) (18408 . 19059)) nil (26991 13218 466590 0) 0 nil])
([nil nil ((17809 . 17810)) nil (26991 13218 466590 0) 0 nil])
([nil nil ((17810 . 17812)) nil (26991 13218 466589 0) 0 nil])
([nil nil ((18410 . 18412)) nil (26991 13218 466589 0) 0 nil])
([nil nil ((18412 . 18413)) nil (26991 13218 466588 0) 0 nil])
([nil nil ((#("
    (lumen.data.db:ensure-connection" 0 37 (fontified t)) . 19806) (undo-tree-id131 . -37)) nil (26991 13218 466588 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -19943) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) 19944) nil (26991 13218 466585 0) 0 nil])
([nil nil ((#("(error \"not_found\")" 0 1 (fontified t) 1 6 (face font-lock-warning-face fontified t) 6 7 (fontified t) 7 8 (face font-lock-string-face fontified t) 8 17 (face font-lock-string-face fontified t) 17 18 (face font-lock-string-face fontified t) 18 19 (fontified t)) . -20083) (undo-tree-id121 . -19) (undo-tree-id122 . -19) (undo-tree-id123 . -19) (undo-tree-id124 . -19) (undo-tree-id125 . -19) (undo-tree-id126 . -19) (undo-tree-id127 . -19) 20102) nil (26991 13218 466578 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20124 . 20125) (nil fontified nil 20083 . 20125) (20083 . 20125)) nil (26991 13218 466573 0) 0 nil])
([nil nil ((#("
      (lumen.data.db:ensure-connection" 0 1 (fontified t) 1 4 (fontified t) 4 30 (fontified t) 30 39 (fontified t)) . 20547) (undo-tree-id116 . -39) (undo-tree-id117 . -39) (undo-tree-id118 . -39) (undo-tree-id119 . -39) (undo-tree-id120 . -39)) nil (26991 13218 466645 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20700) (undo-tree-id134 . -1) 20701) nil (26991 13718 444586 0) 0 nil] [nil nil ((#(")" 0 1 (fontified t)) . -20660) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) 20661) ((20660 . 20661)) (26991 13218 466566 0) 0 nil])
([nil nil ((612 . 613)) nil (26991 13718 444583 0) 0 nil])
nil
([nil nil ((613 . 614)) nil (26991 13718 444583 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 630 . 631) (nil fontified nil 614 . 631) (614 . 631)) nil (26991 13718 444582 0) 0 nil])
([nil nil ((#("((string-equal (string rid) (string tid)) row)" 0 46 (fontified t)) . -25053) (undo-tree-id133 . -46) 25099) nil (26991 13718 444581 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25085 . 25086) (nil fontified nil 25053 . 25086) (25053 . 25086)) nil (26991 13718 444570 0) 0 nil])
([nil nil ((25086 . 25099)) nil (26991 13718 444565 0) 0 nil])
([nil nil ((20719 . 20721) (t 26991 13718 0 0)) nil (26991 13795 718483 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21774 . 21775) (nil fontified nil 20721 . 21775) (20721 . 21775)) nil (26991 13795 718482 0) 0 nil])
([nil nil ((#("
      ;; CHANGEMENT : On retire :patch t car entity-update! détecte tout seul les dirty slots." 0 1 (face font-lock-comment-face fontified t) 1 7 (fontified t) 7 10 (face font-lock-comment-delimiter-face fontified t) 10 95 (face font-lock-comment-face fontified t)) . -21485) (undo-tree-id135 . -95) (undo-tree-id136 . -1) (undo-tree-id137 . -95) (undo-tree-id138 . -95) 21580) nil (26991 13795 718481 0) 0 nil])
([nil nil ((19963 . 19964)) nil (26991 13795 718470 0) 0 nil])
([nil nil ((19964 . 19966)) nil (26991 13795 718469 0) 0 nil])
([nil nil ((20723 . 20725)) nil (26991 13795 718468 0) 0 nil])
([nil nil ((20725 . 20726)) nil (26991 13795 718464 0) 0 nil])
([nil nil ((#("(format t \"~&[Lumen] In REPO AUTHORIZE (Ent: ~A | Op: ~A)~%\" entity op)" 0 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 13 (face font-lock-string-face fontified t) 13 21 (face font-lock-string-face fontified t) 21 29 (face font-lock-string-face fontified t) 29 37 (face font-lock-string-face fontified t) 37 38 (face font-lock-string-face fontified t rear-nonsticky t) 38 57 (face font-lock-string-face fontified t) 57 59 (face font-lock-string-face fontified t) 59 60 (face font-lock-string-face fontified t) 60 70 (fontified t) 70 71 (fontified t rear-nonsticky t)) . 12419) (undo-tree-id139 . -9) (undo-tree-id140 . -9) (undo-tree-id141 . -9) (undo-tree-id142 . -9) (undo-tree-id143 . -9) (undo-tree-id144 . -9) (undo-tree-id145 . -9) (undo-tree-id146 . -71) (t 26991 13795 0 0)) nil (26991 13908 471439 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 12416)) nil (26991 13951 16857 0) 0 nil] [nil nil ((12416 . 12419)) ((#("
  " 0 3 (fontified t)) . 12416) (undo-tree-id147 . -3) (undo-tree-id148 . -1)) (26991 13908 471383 0) 0 nil])
([nil nil ((12450 . 12453)) nil (26991 13951 16857 0) 0 nil])
nil
([nil nil ((nil fontified nil 12523 . 12524) (nil fontified nil 12513 . 12523) (nil fontified nil 12512 . 12513) (nil fontified nil 12510 . 12512) (nil fontified nil 12491 . 12510) (nil fontified nil 12490 . 12491) (nil fontified nil 12482 . 12490) (nil fontified nil 12474 . 12482) (nil fontified nil 12466 . 12474) (nil fontified nil 12464 . 12466) (nil fontified nil 12463 . 12464) (nil fontified nil 12453 . 12463) (12453 . 12524)) nil (26991 13951 16856 0) 0 nil])
([nil nil ((#("(format t \"~&[Lumen] In REPO NORMALIZE (Ent: ~A | Op: ~A)~%\" entity op)" 0 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 13 (face font-lock-string-face fontified t) 13 21 (face font-lock-string-face fontified t) 21 38 (face font-lock-string-face fontified t) 38 57 (face font-lock-string-face fontified t) 57 59 (face font-lock-string-face fontified t) 59 60 (face font-lock-string-face fontified t) 60 70 (fontified t) 70 71 (fontified t rear-nonsticky t)) . 12871)) nil (26991 13951 16855 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 12868)) nil (26991 13951 16855 0) 0 nil])
([nil nil ((12905 . 12908)) nil (26991 13951 16854 0) 0 nil])
([nil nil ((nil fontified nil 12978 . 12979) (nil fontified nil 12968 . 12978) (nil fontified nil 12967 . 12968) (nil fontified nil 12965 . 12967) (nil fontified nil 12946 . 12965) (nil fontified nil 12929 . 12946) (nil fontified nil 12921 . 12929) (nil fontified nil 12919 . 12921) (nil fontified nil 12918 . 12919) (nil fontified nil 12908 . 12918) (12908 . 12979)) nil (26991 13951 16853 0) 0 nil])
([nil nil ((#("(format t \"~&[Lumen] In REPO VALIDATE (Ent: ~A | Op: ~A)~%\" entity op)" 0 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 13 (face font-lock-string-face fontified t) 13 21 (face font-lock-string-face fontified t) 21 37 (face font-lock-string-face fontified t) 37 56 (face font-lock-string-face fontified t) 56 58 (face font-lock-string-face fontified t) 58 59 (face font-lock-string-face fontified t) 59 69 (fontified t) 69 70 (fontified t rear-nonsticky t)) . 13052)) nil (26991 13951 16852 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13049)) nil (26991 13951 16852 0) 0 nil])
([nil nil ((13075 . 13078)) nil (26991 13951 16851 0) 0 nil])
([nil nil ((nil fontified nil 13147 . 13148) (nil fontified nil 13137 . 13147) (nil fontified nil 13136 . 13137) (nil fontified nil 13134 . 13136) (nil fontified nil 13115 . 13134) (nil fontified nil 13099 . 13115) (nil fontified nil 13091 . 13099) (nil fontified nil 13089 . 13091) (nil fontified nil 13088 . 13089) (nil fontified nil 13078 . 13088) (13078 . 13148)) nil (26991 13951 16850 0) 0 nil])
([nil nil ((#("(format t \"~&[Lumen] In REPO BEFORE (Ent: ~A | Op: ~A)~%\" entity op)" 0 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 13 (face font-lock-string-face fontified t) 13 21 (face font-lock-string-face fontified t) 21 35 (face font-lock-string-face fontified t) 35 54 (face font-lock-string-face fontified t) 54 56 (face font-lock-string-face fontified t) 56 57 (face font-lock-string-face fontified t) 57 67 (fontified t) 67 68 (fontified t rear-nonsticky t)) . 13293)) nil (26991 13951 16849 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13290)) nil (26991 13951 16849 0) 0 nil])
([nil nil ((13338 . 13341)) nil (26991 13951 16848 0) 0 nil])
([nil nil ((nil fontified nil 13408 . 13409) (nil fontified nil 13398 . 13408) (nil fontified nil 13397 . 13398) (nil fontified nil 13395 . 13397) (nil fontified nil 13376 . 13395) (nil fontified nil 13362 . 13376) (nil fontified nil 13354 . 13362) (nil fontified nil 13352 . 13354) (nil fontified nil 13351 . 13352) (nil fontified nil 13341 . 13351) (13341 . 13409)) nil (26991 13951 16843 0) 0 nil])
([nil nil ((17480 . 17487) (t 26991 13951 0 0)) nil (26991 14472 368473 0) 0 nil])
([nil nil ((17487 . 17494)) nil (26991 14472 368472 0) 0 nil])
([nil nil ((17494 . 17495)) nil (26991 14472 368472 0) 0 nil])
([nil nil ((17495 . 17496)) nil (26991 14472 368472 0) 0 nil])
([nil nil ((17496 . 17497)) nil (26991 14472 368471 0) 0 nil])
([nil nil ((17497 . 17500)) nil (26991 14472 368471 0) 0 nil])
([nil nil ((17500 . 17505)) nil (26991 14472 368470 0) 0 nil])
([nil nil ((17505 . 17506)) nil (26991 14472 368470 0) 0 nil])
([nil nil ((17506 . 17509)) nil (26991 14472 368470 0) 0 nil])
([nil nil ((17500 . 17505)) nil (26991 14472 368469 0) 0 nil])
([nil nil ((17505 . 17506)) nil (26991 14472 368469 0) 0 nil])
([nil nil ((17511 . 17512)) nil (26991 14472 368469 0) 0 nil])
([nil nil ((17516 . 17518)) nil (26991 14472 368468 0) 0 nil])
([nil nil ((17518 . 17519)) nil (26991 14472 368468 0) 0 nil])
([nil nil ((17519 . 17522)) nil (26991 14472 368467 0) 0 nil])
([nil nil ((#("Z" 0 1 (face font-lock-string-face fontified t)) . -17520) (undo-tree-id161 . -1) (#("é" 0 1 (face font-lock-string-face fontified t)) . -17521) (undo-tree-id162 . -1) 17522) nil (26991 14472 368467 0) 0 nil])
([nil nil ((17520 . 17522)) nil (26991 14472 368465 0) 0 nil])
([nil nil ((#("é" 0 1 (face font-lock-string-face fontified t)) . -17521) (undo-tree-id160 . -1) 17522) nil (26991 14472 368464 0) 0 nil])
([nil nil ((17521 . 17522)) nil (26991 14472 368463 0) 0 nil])
([nil nil ((17521 . 17526)) nil (26991 14472 368463 0) 0 nil])
([nil nil ((#("%" 0 1 (face font-lock-string-face fontified t)) . -17524) (undo-tree-id158 . -1) (#("*" 0 1 (face font-lock-string-face fontified t)) . -17525) (undo-tree-id159 . -1) 17526) nil (26991 14472 368462 0) 0 nil])
([nil nil ((17524 . 17525)) nil (26991 14472 368460 0) 0 nil])
([nil nil ((#("%" 0 1 (face font-lock-string-face fontified t)) . -17523) (undo-tree-id156 . -1) (#("*" 0 1 (face font-lock-string-face fontified t)) . -17524) (undo-tree-id157 . -1) 17525) nil (26991 14472 368460 0) 0 nil])
([nil nil ((17524 . 17525)) nil (26991 14472 368458 0) 0 nil])
([nil nil ((17525 . 17530)) nil (26991 14472 368458 0) 0 nil])
([nil nil ((11085 . 11088)) nil (26991 14472 368457 0) 0 nil])
([nil nil ((11088 . 11094)) nil (26991 14472 368457 0) 0 nil])
([nil nil ((11094 . 11095)) nil (26991 14472 368456 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11368 . 11369) (nil fontified nil 11314 . 11369) (nil fontified nil 11262 . 11314) (nil fontified nil 11259 . 11262) (nil fontified nil 11211 . 11259) (nil fontified nil 11208 . 11211) (nil fontified nil 11195 . 11208) (nil fontified nil 11132 . 11195) (nil fontified nil 11129 . 11132) (nil fontified nil 11110 . 11129) (nil fontified nil 11104 . 11110) (nil fontified nil 11095 . 11104) (11095 . 11369)) nil (26991 14472 368456 0) 0 nil])
([nil nil ((11369 . 11370)) nil (26991 14472 368454 0) 0 nil])
([nil nil ((11364 . 11366) (11354 . 11357) (#("          " 0 10 (fontified nil)) . 11354) (11370 . 11371)) nil (26991 14472 368454 0) 0 nil])
([nil nil ((11366 . 11367)) nil (26991 14472 368453 0) 0 nil])
([nil nil ((11367 . 11372)) nil (26991 14472 368452 0) 0 nil])
([nil nil ((11372 . 11373)) nil (26991 14472 368452 0) 0 nil])
([nil nil ((11373 . 11374)) nil (26991 14472 368451 0) 0 nil])
([nil nil ((#("(print \"" 0 7 (fontified t) 7 8 (face font-lock-string-face fontified t)) . -11366) (undo-tree-id155 . -8) 11374) nil (26991 14472 368451 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11413 . 11414) (nil fontified nil 11406 . 11414) (nil fontified nil 11376 . 11406) (nil fontified nil 11366 . 11376) (11366 . 11414)) nil (26991 14472 368450 0) 0 nil])
([nil nil ((#("In %handle-tx-result" 0 20 (face font-lock-string-face fontified t)) . -11379) (undo-tree-id154 . -20) 11399) nil (26991 14472 368449 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11403 . 11404) (nil fontified nil 11379 . 11404) (11379 . 11404)) nil (26991 14472 368448 0) 0 nil])
([nil nil ((#("~" 0 1 (face font-lock-string-face fontified t)) . -11406) (undo-tree-id152 . -1) (#("A" 0 1 (face font-lock-string-face fontified t)) . -11407) (undo-tree-id153 . -1) 11408) nil (26991 14472 368447 0) 0 nil])
([nil nil ((11406 . 11408)) nil (26991 14472 368445 0) 0 nil])
([nil nil ((11379 . 11383) (#("rows" 0 4 (face font-lock-string-face fontified t)) . 11379)) nil (26991 14472 368444 0) 0 nil])
([nil nil ((11383 . 11395) (#("->serialized" 0 12 (face font-lock-string-face fontified t)) . 11383)) nil (26991 14472 368444 0) 0 nil])
([nil nil ((11395 . 11404) (#("-entities" 0 8 (face font-lock-string-face fontified t) 8 9 (face font-lock-string-face rear-nonsticky t fontified t)) . 11395)) nil (26991 14472 368443 0) 0 nil])
([nil nil ((#("result" 0 6 (fontified t)) . -11412) (undo-tree-id151 . -6) 11418) nil (26991 14472 368442 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -11411) (undo-tree-id149 . -1) (undo-tree-id150 . -1) 11412) nil (26991 14472 368437 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17908 . 17909) (nil fontified nil 17886 . 17909) (17886 . 17909) (t 26991 14472 0 0)) nil (26991 14602 853270 0) 0 nil])
([nil nil ((17909 . 17910)) nil (26991 14602 853269 0) 0 nil])
([nil nil ((#("result" 0 6 (fontified t)) . -17901) (undo-tree-id163 . -6) (undo-tree-id164 . -4) (undo-tree-id165 . -4) (undo-tree-id166 . -4) (undo-tree-id167 . -4) (undo-tree-id168 . -4) (undo-tree-id169 . -6) (undo-tree-id170 . -6) (undo-tree-id171 . -6) (undo-tree-id172 . -6) (undo-tree-id173 . -6) (undo-tree-id174 . -6) (undo-tree-id175 . -6) (undo-tree-id176 . -6) 17907) nil (26991 14602 853268 0) 0 nil])
([nil current ((17901 . 17905)) nil (26991 14602 853247 0) 0 nil])
nil
