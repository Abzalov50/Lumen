(undo-tree-save-format-version . 1)
"ffa13bbcd9abcd463ed13dce97a20cf288a3624c"
[nil nil nil nil (26790 8220 256353 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 789 . 790) (nil fontified nil 789 . 790) (nil fontified nil 788 . 789) (nil fontified nil 726 . 788) (nil fontified nil 705 . 726) (nil fontified nil 702 . 705) (nil fontified nil 701 . 702) (nil fontified nil 648 . 701) (nil fontified nil 630 . 648) (nil fontified nil 629 . 630) (nil fontified nil 624 . 629) (nil fontified nil 565 . 624) (nil fontified nil 561 . 565) (nil fontified nil 467 . 561) (nil fontified nil 463 . 467) (nil fontified nil 363 . 463) (nil fontified nil 357 . 363) (nil fontified nil 350 . 357) (nil fontified nil 346 . 350) (nil fontified nil 323 . 346) (nil fontified nil 311 . 323) (nil fontified nil 310 . 311) (nil fontified nil 305 . 310) (nil fontified nil 275 . 305) (nil fontified nil 264 . 275) (nil fontified nil 251 . 264) (nil fontified nil 243 . 251) (nil fontified nil 231 . 243) (nil fontified nil 222 . 231) (nil fontified nil 211 . 222) (nil fontified nil 203 . 211) (nil fontified nil 188 . 203) (nil fontified nil 183 . 188) (nil fontified nil 171 . 183) (nil fontified nil 165 . 171) (nil fontified nil 156 . 165) (nil fontified nil 153 . 156) (nil fontified nil 117 . 153) (nil fontified nil 109 . 117) (nil fontified nil 108 . 109) (nil fontified nil 103 . 108) (nil fontified nil 101 . 103) (nil fontified nil 81 . 101) (nil fontified nil 79 . 81) (nil fontified nil 68 . 79) (nil fontified nil 63 . 68) (nil fontified nil 21 . 63) (nil fontified nil 13 . 21) (nil fontified nil 1 . 13) (1 . 790) (t 26790 8220 0 0)) nil (26798 57467 484537 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1242 . 1243) (nil fontified nil 1241 . 1243) (nil fontified nil 1240 . 1241) (nil fontified nil 1230 . 1240) (nil fontified nil 1229 . 1230) (nil fontified nil 1215 . 1229) (nil fontified nil 1214 . 1215) (nil fontified nil 1201 . 1214) (nil fontified nil 1200 . 1201) (nil fontified nil 1197 . 1200) (nil fontified nil 1196 . 1197) (nil fontified nil 1195 . 1196) (nil fontified nil 1182 . 1195) (nil fontified nil 1181 . 1182) (nil fontified nil 1178 . 1181) (nil fontified nil 1177 . 1178) (nil fontified nil 1168 . 1177) (nil fontified nil 1164 . 1168) (nil fontified nil 1163 . 1164) (nil fontified nil 1158 . 1163) (nil fontified nil 1154 . 1158) (nil fontified nil 1146 . 1154) (nil fontified nil 1142 . 1146) (nil fontified nil 1134 . 1142) (nil fontified nil 1131 . 1134) (nil fontified nil 1127 . 1131) (nil fontified nil 1101 . 1127) (nil fontified nil 1097 . 1101) (nil fontified nil 1085 . 1097) (nil fontified nil 1082 . 1085) (nil fontified nil 1070 . 1082) (nil fontified nil 1067 . 1070) (nil fontified nil 1063 . 1067) (nil fontified nil 1058 . 1063) (nil fontified nil 1055 . 1058) (nil fontified nil 1050 . 1055) (nil fontified nil 1047 . 1050) (nil fontified nil 1043 . 1047) (nil fontified nil 1028 . 1043) (nil fontified nil 1027 . 1028) (nil fontified nil 1020 . 1027) (nil fontified nil 1019 . 1020) (nil fontified nil 1007 . 1019) (nil fontified nil 1006 . 1007) (nil fontified nil 995 . 1006) (nil fontified nil 992 . 995) (nil fontified nil 984 . 992) (nil fontified nil 981 . 984) (nil fontified nil 977 . 981) (nil fontified nil 963 . 977) (nil fontified nil 962 . 963) (nil fontified nil 946 . 962) (nil fontified nil 943 . 946) (nil fontified nil 927 . 943) (nil fontified nil 924 . 927) (nil fontified nil 919 . 924) (nil fontified nil 907 . 919) (nil fontified nil 906 . 907) (nil fontified nil 901 . 906) (nil fontified nil 900 . 901) (nil fontified nil 893 . 900) (nil fontified nil 892 . 893) (nil fontified nil 887 . 892) (nil fontified nil 886 . 887) (nil fontified nil 880 . 886) (nil fontified nil 875 . 880) (nil fontified nil 854 . 875) (nil fontified nil 853 . 854) (nil fontified nil 844 . 853) (nil fontified nil 843 . 844) (nil fontified nil 835 . 843) (nil fontified nil 834 . 835) (nil fontified nil 806 . 834) (nil fontified nil 801 . 806) (nil fontified nil 788 . 801) (nil fontified nil 787 . 788) (nil fontified nil 777 . 787) (nil fontified nil 776 . 777) (nil fontified nil 769 . 776) (nil fontified nil 768 . 769) (nil fontified nil 762 . 768) (nil fontified nil 761 . 762) (nil fontified nil 750 . 761) (nil fontified nil 749 . 750) (nil fontified nil 731 . 749) (nil fontified nil 730 . 731) (nil fontified nil 723 . 730) (nil fontified nil 720 . 723) (nil fontified nil 719 . 720) (nil fontified nil 718 . 719) (nil fontified nil 717 . 718) (nil fontified nil 711 . 717) (nil fontified nil 710 . 711) (nil fontified nil 690 . 710) (nil fontified nil 689 . 690) (nil fontified nil 688 . 689) (nil fontified nil 676 . 688) (nil fontified nil 673 . 676) (nil fontified nil 671 . 673) (nil fontified nil 660 . 671) (nil fontified nil 659 . 660) (nil fontified nil 648 . 659) (nil fontified nil 647 . 648) (nil fontified nil 632 . 647) (nil fontified nil 631 . 632) (nil fontified nil 619 . 631) (nil fontified nil 616 . 619) (nil fontified nil 614 . 616) (nil fontified nil 598 . 614) (nil fontified nil 597 . 598) (nil fontified nil 580 . 597) (nil fontified nil 579 . 580) (nil fontified nil 565 . 579) (nil fontified nil 564 . 565) (nil fontified nil 553 . 564) (nil fontified nil 552 . 553) (nil fontified nil 541 . 552) (nil fontified nil 540 . 541) (nil fontified nil 529 . 540) (nil fontified nil 528 . 529) (nil fontified nil 518 . 528) (nil fontified nil 517 . 518) (nil fontified nil 508 . 517) (nil fontified nil 507 . 508) (nil fontified nil 489 . 507) (nil fontified nil 488 . 489) (nil fontified nil 475 . 488) (nil fontified nil 474 . 475) (nil fontified nil 461 . 474) (nil fontified nil 460 . 461) (nil fontified nil 448 . 460) (nil fontified nil 447 . 448) (nil fontified nil 434 . 447) (nil fontified nil 433 . 434) (nil fontified nil 422 . 433) (nil fontified nil 421 . 422) (nil fontified nil 402 . 421) (nil fontified nil 401 . 402) (nil fontified nil 389 . 401) (nil fontified nil 384 . 389) (nil fontified nil 367 . 384) (nil fontified nil 366 . 367) (nil fontified nil 350 . 366) (nil fontified nil 349 . 350) (nil fontified nil 337 . 349) (nil fontified nil 332 . 337) (nil fontified nil 315 . 332) (nil fontified nil 312 . 315) (nil fontified nil 296 . 312) (nil fontified nil 295 . 296) (nil fontified nil 281 . 295) (nil fontified nil 280 . 281) (nil fontified nil 267 . 280) (nil fontified nil 266 . 267) (nil fontified nil 262 . 266) (nil fontified nil 261 . 262) (nil fontified nil 258 . 261) (nil fontified nil 257 . 258) (nil fontified nil 245 . 257) (nil fontified nil 244 . 245) (nil fontified nil 232 . 244) (nil fontified nil 227 . 232) (nil fontified nil 218 . 227) (nil fontified nil 217 . 218) (nil fontified nil 209 . 217) (nil fontified nil 208 . 209) (nil fontified nil 198 . 208) (nil fontified nil 197 . 198) (nil fontified nil 185 . 197) (nil fontified nil 184 . 185) (nil fontified nil 172 . 184) (nil fontified nil 171 . 172) (nil fontified nil 158 . 171) (nil fontified nil 154 . 158) (nil fontified nil 142 . 154) (nil fontified nil 141 . 142) (nil fontified nil 131 . 141) (nil fontified nil 130 . 131) (nil fontified nil 121 . 130) (nil fontified nil 120 . 121) (nil fontified nil 112 . 120) (nil fontified nil 111 . 112) (nil fontified nil 95 . 111) (nil fontified nil 94 . 95) (nil fontified nil 82 . 94) (nil fontified nil 77 . 82) (nil fontified nil 66 . 77) (nil fontified nil 65 . 66) (nil fontified nil 62 . 65) (nil fontified nil 61 . 62) (nil fontified nil 57 . 61) (nil fontified nil 53 . 57) (nil fontified nil 31 . 53) (nil fontified nil 30 . 31) (nil fontified nil 20 . 30) (nil fontified nil 19 . 20) (nil fontified nil 16 . 19) (nil fontified nil 13 . 16) (nil fontified nil 12 . 13) (nil fontified nil 2 . 12) (nil fontified nil 1 . 2) (1 . 1243)) nil (26798 57467 484530 0) 0 nil])
([nil nil ((1245 . 1246) (1197 . 1201) (#("   " 0 3 (fontified nil)) . 1197) (1243 . 1244)) nil (26798 57467 484516 0) 0 nil])
([nil nil ((#("core" 0 4 (face font-lock-type-face fontified t)) . -38) (undo-tree-id5 . -4) 42) nil (26798 57467 484515 0) 0 nil])
([nil nil ((38 . 42)) nil (26798 57467 484514 0) 0 nil])
([nil nil ((#("middleware" 0 10 (face font-lock-type-face fontified t)) . -43) (undo-tree-id4 . -10) 53) nil (26798 57467 484513 0) 0 nil])
([nil nil ((43 . 47)) nil (26798 57467 484512 0) 0 nil])
([nil nil ((#(":my.repo" 0 8 (face font-lock-builtin-face fontified t)) . -1252) (undo-tree-id3 . -8) 1260) nil (26798 57467 484512 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1267 . 1268) (nil fontified nil 1252 . 1268) (1252 . 1268)) nil (26798 57467 484510 0) 0 nil])
([nil nil ((#(":define-middleware :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :*debug* :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :static-many
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
   :csrf
	   :auth-jwt
   :https-redirect
	   :auth-required :roles-allowed :rate-limit" 0 18 (face font-lock-builtin-face fontified t) 18 19 (fontified t) 19 30 (face font-lock-builtin-face fontified t) 30 31 (fontified t) 31 37 (face font-lock-builtin-face fontified t) 37 38 (fontified t) 38 45 (face font-lock-builtin-face fontified t) 45 46 (fontified t) 46 56 (face font-lock-builtin-face fontified t) 56 57 (fontified t) 57 70 (face font-lock-builtin-face fontified t) 70 75 (fontified t) 75 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 112 (face font-lock-builtin-face fontified t) 112 113 (fontified t) 113 122 (face font-lock-builtin-face fontified t) 122 123 (fontified t) 123 144 (face font-lock-builtin-face fontified t) 144 149 (fontified t) 149 155 (face font-lock-builtin-face fontified t) 155 156 (fontified t) 156 161 (face font-lock-builtin-face fontified t) 161 162 (fontified t) 162 169 (face font-lock-builtin-face fontified t) 169 170 (fontified t) 170 175 (face font-lock-builtin-face fontified t) 175 176 (fontified t) 176 188 (face font-lock-builtin-face fontified t) 188 193 (fontified t) 193 196 (face font-lock-comment-delimiter-face fontified t) 196 212 (face font-lock-comment-face fontified t) 212 215 (fontified t) 215 231 (face font-lock-builtin-face fontified t) 231 232 (fontified t) 232 246 (face font-lock-builtin-face fontified t) 246 250 (fontified t) 250 253 (face font-lock-comment-delimiter-face fontified t) 253 261 (face font-lock-comment-face fontified t) 261 264 (fontified t) 264 275 (face font-lock-builtin-face fontified t) 275 276 (fontified t) 276 288 (face font-lock-builtin-face fontified t) 288 289 (fontified t) 289 296 (face font-lock-builtin-face fontified t) 296 297 (fontified t) 297 312 (face font-lock-builtin-face fontified t) 312 316 (fontified t) 316 319 (face font-lock-comment-delimiter-face fontified t) 319 324 (face font-lock-comment-face fontified t) 324 327 (fontified t) 327 332 (face font-lock-builtin-face fontified t) 332 336 (fontified t) 336 339 (face font-lock-comment-delimiter-face fontified t) 339 351 (face font-lock-comment-face fontified t) 351 354 (fontified t) 354 366 (face font-lock-builtin-face fontified t) 366 370 (fontified t) 370 396 (face font-lock-builtin-face fontified t) 396 400 (fontified t) 400 403 (face font-lock-comment-delimiter-face fontified t) 403 411 (face font-lock-comment-face fontified t) 411 415 (fontified t) 415 423 (face font-lock-builtin-face fontified t) 423 427 (fontified t) 427 432 (face font-lock-builtin-face fontified t) 432 433 (fontified t) 433 437 (fontified t) 437 446 (face font-lock-builtin-face fontified t) 446 447 (fontified t) 447 450 (fontified t) 450 451 (face font-lock-builtin-face fontified t) 451 464 (face font-lock-builtin-face fontified t) 464 465 (face font-lock-builtin-face fontified t rear-nonsticky t) 465 466 (fontified t) 466 470 (fontified t) 470 471 (face font-lock-builtin-face fontified t) 471 484 (face font-lock-builtin-face fontified t) 484 485 (fontified t) 485 499 (face font-lock-builtin-face fontified t) 499 500 (fontified t) 500 510 (face font-lock-builtin-face fontified t) 510 511 (face font-lock-builtin-face fontified t rear-nonsticky t)) . 725) (undo-tree-id2 . -511)) nil (26798 57467 484510 0) 0 nil])
([nil nil ((725 . 726)) nil (26798 57467 484509 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 743 . 744) (nil fontified nil 726 . 744) (726 . 744)) nil (26798 57467 484508 0) 0 nil])
([nil nil ((744 . 745)) nil (26798 57467 484508 0) 0 nil])
([nil nil ((745 . 746)) nil (26798 57467 484507 0) 0 nil])
([nil nil ((746 . 747)) nil (26798 57467 484507 0) 0 nil])
([nil nil ((#("y" 0 1 (face font-lock-builtin-face fontified t)) . -746) (undo-tree-id1 . -1) 747) nil (26798 57467 484506 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 757 . 758) (nil fontified nil 746 . 758) (746 . 758)) nil (26798 57467 484504 0) 0 nil])
([nil nil ((725 . 726)) nil (26798 57467 484504 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 732 . 733) (nil fontified nil 726 . 733) (726 . 733)) nil (26798 57467 484503 0) 0 nil])
([nil nil ((733 . 734)) nil (26798 57467 484503 0) 0 nil])
([nil nil ((327 . 330)) nil (26798 57467 484502 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 358 . 359) (nil fontified nil 330 . 359) (330 . 359)) nil (26798 57467 484501 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 344 . 345) (nil fontified nil 344 . 345) (nil fontified nil 343 . 344) (nil fontified nil 331 . 343) (nil fontified nil 330 . 331) (330 . 345)) nil (26798 57467 484501 0) 0 nil])
([nil nil ((374 . 375)) nil (26798 57467 484500 0) 0 nil])
([nil nil ((360 . 361)) nil (26798 57467 484499 0) 0 nil])
([nil nil ((#("
  (:import-from :lumen.core.session :session-id :session-data :session-get :session-set! :session-del! :verify-signed-sid :sign-sid :store-get :store-put! :store-del! :rand-bytes :*session-ttl* :*session-cookie* :*secure-cookie*)
  (:import-from :lumen.core.jwt :jwt-encode :jwt-decode)
  (:import-from :lumen.core.ratelimit :allow?)" 0 4 (fontified t) 4 16 (face font-lock-builtin-face fontified t) 16 17 (fontified t) 17 36 (face font-lock-builtin-face fontified t) 36 37 (fontified t) 37 48 (face font-lock-builtin-face fontified t) 48 49 (fontified t) 49 62 (face font-lock-builtin-face fontified t) 62 63 (fontified t) 63 75 (face font-lock-builtin-face fontified t) 75 76 (fontified t) 76 89 (face font-lock-builtin-face fontified t) 89 90 (fontified t) 90 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 122 (face font-lock-builtin-face fontified t) 122 123 (fontified t) 123 132 (face font-lock-builtin-face fontified t) 132 133 (fontified t) 133 143 (face font-lock-builtin-face fontified t) 143 144 (fontified t) 144 155 (face font-lock-builtin-face fontified t) 155 156 (fontified t) 156 167 (face font-lock-builtin-face fontified t) 167 168 (fontified t) 168 179 (face font-lock-builtin-face fontified t) 179 180 (fontified t) 180 194 (face font-lock-builtin-face fontified t) 194 195 (fontified t) 195 212 (face font-lock-builtin-face fontified t) 212 213 (fontified t) 213 229 (face font-lock-builtin-face fontified t) 229 231 (fontified t) 231 234 (fontified t) 234 246 (face font-lock-builtin-face fontified t) 246 247 (fontified t) 247 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 274 (face font-lock-builtin-face fontified t) 274 275 (fontified t) 275 286 (face font-lock-builtin-face fontified t) 286 288 (fontified t) 288 291 (fontified t) 291 303 (face font-lock-builtin-face fontified t) 303 304 (fontified t) 304 305 (face font-lock-builtin-face fontified t) 305 325 (face font-lock-builtin-face fontified t) 325 326 (fontified t) 326 332 (face font-lock-builtin-face fontified t) 332 333 (face font-lock-builtin-face fontified t rear-nonsticky t) 333 334 (fontified t)) . -428) (undo-tree-id0 . -334) 762) nil (26798 57467 484496 0) 0 nil])
([nil nil ((326 . 327) (t 26798 57467 0 0)) nil (26798 60276 750161 0) 0 nil])
([nil nil ((327 . 328)) nil (26798 60276 750161 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 342 . 343) (nil fontified nil 328 . 343) (328 . 343)) nil (26798 60276 750160 0) 0 nil])
([nil nil ((#("alexandria:uuid-string" 0 22 (fontified t)) . -984) (undo-tree-id7 . -22) 1006) nil (26798 60276 750159 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1000 . 1001) (nil fontified nil 984 . 1001) (984 . 1001)) nil (26798 60276 750157 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -984) (undo-tree-id6 . -1) 985) nil (26798 60276 750156 0) 0 nil])
([nil nil ((984 . 995)) nil (26798 60276 750145 0) 0 nil])
([nil nil ((995 . 996)) nil (26798 60276 750144 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . 1011)) nil (26798 60276 750140 0) 0 nil])
([nil nil ((744 . 746) (t 26798 60276 0 0)) nil (26799 14313 613897 0) 0 nil])
([nil nil ((#("u" 0 1 (fontified t)) . -744) (undo-tree-id0 . -1) (#("t" 0 1 (fontified t)) . -745) (undo-tree-id1 . -1) 746) nil (26799 14313 613892 0) 0 nil])
([nil nil ((1 . 4570) (#("(in-package :cl)

(defpackage :lumen.data.repo
  (:use :cl :alexandria)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date :gen-uuid-string)
  (:import-from :lumen.core.auth :hash-password)
  (:import-from :lumen.core.body :parse-urlencoded)
  (:export :*users* :find-user-by-email :insert-user!))

(in-package :lumen.data.repo)

(defparameter *users* (make-hash-table :test #'equal)) ; email => user alist

(defun %mk-user (id email role salt iters dk)
  `((:id . ,id) (:email . ,email) (:role . ,role)
    (:pw-salt . ,salt) (:pw-iters . ,iters) (:pw-hash . ,dk)
    (:created-at . ,(get-universal-time))))

(defun insert-user! (email plain-password &key (role \"user\"))
  (multiple-value-bind (salt iters dk)
      (lumen.core.auth:hash-password plain-password)
    (let* ((id (lumen.utils:gen-uuid-string))
           (u (%mk-user id email role salt iters dk)))
      (setf (gethash (string-downcase email) *users*) u)
      u)))

(defun find-user-by-email (email)
  (gethash (string-downcase email) *users*))
;; Tu peux ajouter une petite CLI dev qui appelle insert-user! pour créer un user test.
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 46 (face font-lock-type-face fontified t) 46 50 (fontified t) 50 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 58 (face font-lock-builtin-face fontified t) 58 59 (fontified t) 59 70 (face font-lock-builtin-face fontified t) 70 75 (fontified t) 75 87 (face font-lock-builtin-face fontified t) 87 88 (fontified t) 88 104 (face font-lock-builtin-face fontified t) 104 105 (fontified t) 105 113 (face font-lock-builtin-face fontified t) 113 114 (fontified t) 114 123 (face font-lock-builtin-face fontified t) 123 124 (fontified t) 124 134 (face font-lock-builtin-face fontified t) 134 135 (fontified t) 135 147 (face font-lock-builtin-face fontified t) 147 151 (fontified t) 151 164 (face font-lock-builtin-face fontified t) 164 165 (fontified t) 165 177 (face font-lock-builtin-face fontified t) 177 178 (fontified t) 178 190 (face font-lock-builtin-face fontified t) 190 191 (fontified t) 191 201 (face font-lock-builtin-face fontified t) 201 202 (fontified t) 202 210 (face font-lock-builtin-face fontified t) 210 211 (fontified t) 211 220 (face font-lock-builtin-face fontified t) 220 225 (fontified t) 225 237 (face font-lock-builtin-face fontified t) 237 238 (fontified t) 238 250 (face font-lock-builtin-face fontified t) 250 251 (fontified t) 251 254 (face font-lock-builtin-face fontified t) 254 255 (fontified t) 255 259 (face font-lock-builtin-face fontified t) 259 260 (fontified t) 260 273 (face font-lock-builtin-face fontified t) 273 274 (fontified t) 274 288 (face font-lock-builtin-face fontified t) 288 289 (fontified t) 289 305 (face font-lock-builtin-face fontified t) 305 308 (fontified t) 308 325 (face font-lock-builtin-face fontified t) 325 326 (fontified t) 326 342 (face font-lock-builtin-face fontified t) 342 347 (fontified t) 347 359 (face font-lock-builtin-face fontified t) 359 360 (fontified t) 360 376 (face font-lock-builtin-face fontified t) 376 377 (fontified t) 377 391 (face font-lock-builtin-face fontified t) 391 396 (fontified t) 396 408 (face font-lock-builtin-face fontified t) 408 409 (fontified t) 409 425 (face font-lock-builtin-face fontified t) 425 426 (fontified t) 426 443 (face font-lock-builtin-face fontified t) 443 448 (fontified t) 448 455 (face font-lock-builtin-face fontified t) 455 456 (fontified t) 456 464 (face font-lock-builtin-face fontified t) 464 465 (fontified t) 465 484 (face font-lock-builtin-face fontified t) 484 485 (fontified t) 485 498 (face font-lock-builtin-face fontified t) 498 503 (fontified t) 503 513 (face font-lock-keyword-face fontified t) 513 514 (fontified t) 514 530 (face font-lock-builtin-face fontified t) 530 534 (fontified t) 534 546 (face font-lock-keyword-face fontified t) 546 547 (fontified t) 547 554 (face font-lock-variable-name-face fontified t) 554 572 (fontified t) 572 577 (face font-lock-builtin-face fontified t) 577 588 (fontified t) 588 610 (face font-lock-comment-face fontified t) 610 612 (fontified t) 612 617 (face font-lock-keyword-face fontified t) 617 618 (fontified t) 618 626 (face font-lock-function-name-face fontified t) 626 662 (fontified t) 662 665 (face font-lock-builtin-face fontified t) 665 674 (fontified t) 674 680 (face font-lock-builtin-face fontified t) 680 692 (fontified t) 692 697 (face font-lock-builtin-face fontified t) 697 712 (fontified t) 712 720 (face font-lock-builtin-face fontified t) 720 731 (fontified t) 731 740 (face font-lock-builtin-face fontified t) 740 752 (fontified t) 752 760 (face font-lock-builtin-face fontified t) 760 773 (fontified t) 773 784 (face font-lock-builtin-face fontified t) 784 814 (fontified t) 814 819 (face font-lock-keyword-face fontified t) 819 820 (fontified t) 820 832 (face font-lock-function-name-face fontified t) 832 855 (fontified t) 855 859 (face font-lock-type-face fontified t) 859 866 (fontified t) 866 872 (face font-lock-string-face fontified t) 872 878 (fontified t) 878 897 (face font-lock-keyword-face fontified t) 897 972 (fontified t) 972 976 (face font-lock-keyword-face fontified t) 976 1138 (fontified t) 1138 1143 (face font-lock-keyword-face fontified t) 1143 1144 (fontified t) 1144 1162 (face font-lock-function-name-face fontified t) 1162 1216 (fontified t) 1216 1219 (face font-lock-comment-delimiter-face fontified t) 1219 1304 (face font-lock-comment-face fontified t)) . 1) (t 26799 14313 0 0)) nil (26802 3661 400781 0) 0 nil])
([nil nil ((1 . 4607) (#("(in-package :cl)

(defpackage :lumen.data.repo
  (:use :cl :alexandria)
  (:import-from :lumen.data.db :query-a :query-1a :exec :tx)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date :gen-uuid-string)
  (:import-from :lumen.core.auth :hash-password)
  (:import-from :lumen.core.body :parse-urlencoded)
  (:export :*users* :find-user-by-email :insert-user!
	   :find-by-id :insert! :update! :delete! :select*))

(in-package :lumen.data.repo)

(defparameter *users* (make-hash-table :test #'equal)) ; email => user alist

(defun %mk-user (id email role salt iters dk)
  `((:id . ,id) (:email . ,email) (:role . ,role)
    (:pw-salt . ,salt) (:pw-iters . ,iters) (:pw-hash . ,dk)
    (:created-at . ,(get-universal-time))))

(defun %kw->col (k)
  \"Keyword → nom de colonne en snake_case (ici on prend le nom du keyword tel quel).\"
  (string-downcase (symbol-name k)))

(defun %build-insert-sql (table kv)
  (let* ((cols (mapcar (lambda (p) (%kw->col (car p))) kv))
         (n (length cols))
         (placeholders (loop for i from 1 to n collect (format nil \"$~D\" i)))
         (sql (format nil \"INSERT INTO ~A (~{~A~^,~}) VALUES (~{~A~^,~}) RETURNING *\"
                      table cols placeholders))
         (params (mapcar #'cdr kv)))
    (values sql params)))

(defun %build-update-sql (table id id-col kv)
  (let* ((assigns (loop for (k . v) in kv
                        for i from 1
                        collect (format nil \"~A = $~D\" (%kw->col k) i)))
         (sql (format nil \"UPDATE ~A SET ~{~A~^, ~} WHERE ~A = $~D RETURNING *\"
                      table assigns (%kw->col id-col) (1+ (length kv))))
         (params (append (mapcar #'cdr kv) (list id))))
    (values sql params)))

(defun %build-where (where start-index)
  \"WHERE simple en AND à partir d’une alist de filtres (k . v).\"
  (if (null where)
      (values \"\" '() start-index)
      (let* ((i start-index)
             (parts '())
             (vals  '()))
        (dolist (p where)
          (push (format nil \"~A = $~D\" (%kw->col (car p)) i) parts)
          (push (cdr p) vals)
          (incf i))
        (values (format nil \" WHERE ~{~A~^ AND ~}\" (nreverse parts))
                (nreverse vals)
                i))))

(defun select* (table &key (select '*) where order-by limit offset)
  \"SELECT générique. WHERE = alist (k . v). ORDER-BY = (\\\"col\\\" :desc) ou string.\"
  (let* ((cols (if (eq select '*) \"*\" (format nil \"~{~A~^,~}\" (mapcar #'%kw->col select))))
         (sql (format nil \"SELECT ~A FROM ~A\" cols table))
         (params '())
         (next 1))
    (multiple-value-bind (w pv i) (%build-where where next)
      (setf sql (concatenate 'string sql w)
            params pv
            next i))
    (when order-by
      (setf sql (format nil \"~A ORDER BY ~A\"
                        sql (etypecase order-by
                              (string order-by)
                              (list (destructuring-bind (col &optional dir) order-by
                                      (format nil \"~A ~A\" col (string-upcase (or (and dir (symbol-name dir)) \"\")))))))))
    (when limit  (setf sql (format nil \"~A LIMIT ~D\" sql limit)))
    (when offset (setf sql (format nil \"~A OFFSET ~D\" sql offset)))
    (apply #'query-a sql params)))

(defun find-by-id (table id &key (id-col :id))
  (query-1a (format nil \"SELECT * FROM ~A WHERE ~A = $1\" table (%kw->col id-col)) id))

(defun insert! (table kv)
  (multiple-value-bind (sql params) (%build-insert-sql table kv)
    (first (apply #'query-a sql params))))  ;; RETURNING *

(defun update! (table id kv &key (id-col :id))
  (multiple-value-bind (sql params) (%build-update-sql table id id-col kv)
    (first (apply #'query-a sql params))))

(defun delete! (table id &key (id-col :id))
  (multiple-value-bind (n _)
      (exec (format nil \"DELETE FROM ~A WHERE ~A = $1\" table (%kw->col id-col)) id)
    (declare (ignore _))
    n))

(defun insert-user! (email plain-password &key (role \"user\"))
  (multiple-value-bind (salt iters dk)
      (lumen.core.auth:hash-password plain-password)
    (let* ((id (lumen.utils:gen-uuid-string))
           (u (%mk-user id email role salt iters dk)))
      (setf (gethash (string-downcase email) *users*) u)
      u)))

(defun find-user-by-email (email)
  (gethash (string-downcase email) *users*))
;; Tu peux ajouter une petite CLI dev qui appelle insert-user! pour créer un user test.
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 46 (face font-lock-type-face fontified t) 46 50 (fontified t) 50 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 58 (face font-lock-builtin-face fontified t) 58 59 (fontified t) 59 70 (face font-lock-builtin-face fontified t) 70 75 (fontified t) 75 87 (face font-lock-builtin-face fontified t) 87 88 (fontified t) 88 102 (face font-lock-builtin-face fontified t) 102 103 (fontified t) 103 111 (face font-lock-builtin-face fontified t) 111 112 (fontified t) 112 121 (face font-lock-builtin-face fontified t) 121 122 (fontified t) 122 127 (face font-lock-builtin-face fontified t) 127 128 (fontified t) 128 131 (face font-lock-builtin-face fontified t) 131 136 (fontified t) 136 148 (face font-lock-builtin-face fontified t) 148 149 (fontified t) 149 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 174 (face font-lock-builtin-face fontified t) 174 175 (fontified t) 175 184 (face font-lock-builtin-face fontified t) 184 185 (fontified t) 185 195 (face font-lock-builtin-face fontified t) 195 196 (fontified t) 196 208 (face font-lock-builtin-face fontified t) 208 212 (fontified t) 212 225 (face font-lock-builtin-face fontified t) 225 226 (fontified t) 226 238 (face font-lock-builtin-face fontified t) 238 239 (fontified t) 239 251 (face font-lock-builtin-face fontified t) 251 252 (fontified t) 252 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 271 (face font-lock-builtin-face fontified t) 271 272 (fontified t) 272 281 (face font-lock-builtin-face fontified t) 281 286 (fontified t) 286 298 (face font-lock-builtin-face fontified t) 298 299 (fontified t) 299 311 (face font-lock-builtin-face fontified t) 311 312 (fontified t) 312 315 (face font-lock-builtin-face fontified t) 315 316 (fontified t) 316 320 (face font-lock-builtin-face fontified t) 320 321 (fontified t) 321 334 (face font-lock-builtin-face fontified t) 334 335 (fontified t) 335 349 (face font-lock-builtin-face fontified t) 349 350 (fontified t) 350 366 (face font-lock-builtin-face fontified t) 366 369 (fontified t) 369 386 (face font-lock-builtin-face fontified t) 386 387 (fontified t) 387 403 (face font-lock-builtin-face fontified t) 403 408 (fontified t) 408 420 (face font-lock-builtin-face fontified t) 420 421 (fontified t) 421 437 (face font-lock-builtin-face fontified t) 437 438 (fontified t) 438 452 (face font-lock-builtin-face fontified t) 452 457 (fontified t) 457 469 (face font-lock-builtin-face fontified t) 469 470 (fontified t) 470 486 (face font-lock-builtin-face fontified t) 486 487 (fontified t) 487 504 (face font-lock-builtin-face fontified t) 504 509 (fontified t) 509 516 (face font-lock-builtin-face fontified t) 516 517 (fontified t) 517 525 (face font-lock-builtin-face fontified t) 525 526 (fontified t) 526 545 (face font-lock-builtin-face fontified t) 545 546 (fontified t) 546 559 (face font-lock-builtin-face fontified t) 559 564 (fontified t) 564 575 (face font-lock-builtin-face fontified t) 575 576 (fontified t) 576 584 (face font-lock-builtin-face fontified t) 584 585 (fontified t) 585 593 (face font-lock-builtin-face fontified t) 593 594 (fontified t) 594 602 (face font-lock-builtin-face fontified t) 602 603 (fontified t) 603 611 (face font-lock-builtin-face fontified t) 611 616 (fontified t) 616 626 (face font-lock-keyword-face fontified t) 626 627 (fontified t) 627 643 (face font-lock-builtin-face fontified t) 643 647 (fontified t) 647 659 (face font-lock-keyword-face fontified t) 659 660 (fontified t) 660 667 (face font-lock-variable-name-face fontified t) 667 685 (fontified t) 685 690 (face font-lock-builtin-face fontified t) 690 701 (fontified t) 701 723 (face font-lock-comment-face fontified t) 723 725 (fontified t) 725 730 (face font-lock-keyword-face fontified t) 730 731 (fontified t) 731 739 (face font-lock-function-name-face fontified t) 739 775 (fontified t) 775 778 (face font-lock-builtin-face fontified t) 778 787 (fontified t) 787 793 (face font-lock-builtin-face fontified t) 793 805 (fontified t) 805 810 (face font-lock-builtin-face fontified t) 810 825 (fontified t) 825 833 (face font-lock-builtin-face fontified t) 833 844 (fontified t) 844 853 (face font-lock-builtin-face fontified t) 853 865 (fontified t) 865 873 (face font-lock-builtin-face fontified t) 873 886 (fontified t) 886 897 (face font-lock-builtin-face fontified t) 897 927 (fontified t) 927 932 (face font-lock-keyword-face fontified t) 932 933 (fontified t) 933 941 (face font-lock-function-name-face fontified t) 941 948 (fontified t) 948 1031 (face font-lock-doc-face fontified t) 1031 1071 (fontified t) 1071 1076 (face font-lock-keyword-face fontified t) 1076 1077 (fontified t) 1077 1094 (face font-lock-function-name-face fontified t) 1094 1109 (fontified t) 1109 1113 (face font-lock-keyword-face fontified t) 1113 1130 (fontified t) 1130 1136 (face font-lock-keyword-face fontified t) 1136 1217 (fontified t) 1217 1221 (face font-lock-keyword-face fontified t) 1221 1260 (fontified t) 1260 1265 (face font-lock-string-face fontified t) 1265 1297 (fontified t) 1297 1356 (face font-lock-string-face fontified t) 1356 1470 (fontified t) 1470 1475 (face font-lock-keyword-face fontified t) 1475 1476 (fontified t) 1476 1493 (face font-lock-function-name-face fontified t) 1493 1500 (fontified t) 1500 1515 (fontified t) 1515 4569 (fontified nil)) . 1) (t 26802 3661 0 0)) nil (26802 45297 324512 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.repo
  (:use :cl :alexandria)
  (:import-from :lumen.data.db :query-a :query-1a :exec :tx)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date :gen-uuid-string)
  (:import-from :lumen.core.auth :hash-password)
  (:import-from :lumen.core.body :parse-urlencoded)
  (:export :*users* :find-user-by-email :insert-user!
	   :find-by-id :insert! :update! :delete! :select*))

(in-package :lumen.data.repo)

(defparameter *users* (make-hash-table :test #'equal)) ; email => user alist

(defun %mk-user (id email role salt iters dk)
  `((:id . ,id) (:email . ,email) (:role . ,role)
    (:pw-salt . ,salt) (:pw-iters . ,iters) (:pw-hash . ,dk)
    (:created-at . ,(get-universal-time))))

;;; ---------------- CRUD génériques
(defun %kw->col (k)
  \"Keyword → nom de colonne en snake_case (ici on prend le nom du keyword tel quel).\"
  (string-downcase (symbol-name k)))

(defun %build-insert-sql (table kv)
  (let* ((cols (mapcar (lambda (p) (%kw->col (car p))) kv))
         (n (length cols))
         (placeholders (loop for i from 1 to n collect (format nil \"$~D\" i)))
         (sql (format nil \"INSERT INTO ~A (~{~A~^,~}) VALUES (~{~A~^,~}) RETURNING *\"
                      table cols placeholders))
         (params (mapcar #'cdr kv)))
    (values sql params)))

(defun %build-update-sql (table id id-col kv)
  (let* ((assigns (loop for (k . v) in kv
                        for i from 1
                        collect (format nil \"~A = $~D\" (%kw->col k) i)))
         (sql (format nil \"UPDATE ~A SET ~{~A~^, ~} WHERE ~A = $~D RETURNING *\"
                      table assigns (%kw->col id-col) (1+ (length kv))))
         (params (append (mapcar #'cdr kv) (list id))))
    (values sql params)))

(defun %build-where (where start-index)
  \"WHERE simple en AND à partir d’une alist de filtres (k . v).\"
  (if (null where)
      (values \"\" '() start-index)
      (let* ((i start-index)
             (parts '())
             (vals  '()))
        (dolist (p where)
          (push (format nil \"~A = $~D\" (%kw->col (car p)) i) parts)
          (push (cdr p) vals)
          (incf i))
        (values (format nil \" WHERE ~{~A~^ AND ~}\" (nreverse parts))
                (nreverse vals)
                i))))

(defun select* (table &key (select '*) where order-by limit offset)
  \"SELECT générique. WHERE = alist (k . v). ORDER-BY = (\\\"col\\\" :desc) ou string.\"
  (let* ((cols (if (eq select '*) \"*\" (format nil \"~{~A~^,~}\" (mapcar #'%kw->col select))))
         (sql (format nil \"SELECT ~A FROM ~A\" cols table))
         (params '())
         (next 1))
    (multiple-value-bind (w pv i) (%build-where where next)
      (setf sql (concatenate 'string sql w)
            params pv
            next i))
    (when order-by
      (setf sql (format nil \"~A ORDER BY ~A\"
                        sql (etypecase order-by
                              (string order-by)
                              (list (destructuring-bind (col &optional dir) order-by
                                      (format nil \"~A ~A\" col (string-upcase (or (and dir (symbol-name dir)) \"\")))))))))
    (when limit  (setf sql (format nil \"~A LIMIT ~D\" sql limit)))
    (when offset (setf sql (format nil \"~A OFFSET ~D\" sql offset)))
    (apply #'query-a sql params)))

(defun find-by-id (table id &key (id-col :id))
  (query-1a (format nil \"SELECT * FROM ~A WHERE ~A = $1\" table (%kw->col id-col)) id))

(defun insert! (table kv)
  (multiple-value-bind (sql params) (%build-insert-sql table kv)
    (first (apply #'query-a sql params))))  ;; RETURNING *

(defun update! (table id kv &key (id-col :id))
  (multiple-value-bind (sql params) (%build-update-sql table id id-col kv)
    (first (apply #'query-a sql params))))

(defun delete! (table id &key (id-col :id))
  (multiple-value-bind (n _)
      (exec (format nil \"DELETE FROM ~A WHERE ~A = $1\" table (%kw->col id-col)) id)
    (declare (ignore _))
    n))

(defun insert-user! (email plain-password &key (role \"user\"))
  (multiple-value-bind (salt iters dk)
      (lumen.core.auth:hash-password plain-password)
    (let* ((id (lumen.utils:gen-uuid-string))
           (u (%mk-user id email role salt iters dk)))
      (setf (gethash (string-downcase email) *users*) u)
      u)))

(defun find-user-by-email (email)
  (gethash (string-downcase email) *users*))
;; Tu peux ajouter une petite CLI dev qui appelle insert-user! pour créer un user test.
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 46 (face font-lock-type-face fontified t) 46 50 (fontified t) 50 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 58 (face font-lock-builtin-face fontified t) 58 59 (fontified t) 59 70 (face font-lock-builtin-face fontified t) 70 75 (fontified t) 75 87 (face font-lock-builtin-face fontified t) 87 88 (fontified t) 88 102 (face font-lock-builtin-face fontified t) 102 103 (fontified t) 103 111 (face font-lock-builtin-face fontified t) 111 112 (fontified t) 112 121 (face font-lock-builtin-face fontified t) 121 122 (fontified t) 122 127 (face font-lock-builtin-face fontified t) 127 128 (fontified t) 128 131 (face font-lock-builtin-face fontified t) 131 136 (fontified t) 136 148 (face font-lock-builtin-face fontified t) 148 149 (fontified t) 149 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 174 (face font-lock-builtin-face fontified t) 174 175 (fontified t) 175 184 (face font-lock-builtin-face fontified t) 184 185 (fontified t) 185 195 (face font-lock-builtin-face fontified t) 195 196 (fontified t) 196 208 (face font-lock-builtin-face fontified t) 208 212 (fontified t) 212 225 (face font-lock-builtin-face fontified t) 225 226 (fontified t) 226 238 (face font-lock-builtin-face fontified t) 238 239 (fontified t) 239 251 (face font-lock-builtin-face fontified t) 251 252 (fontified t) 252 262 (face font-lock-builtin-face fontified t) 262 263 (fontified t) 263 271 (face font-lock-builtin-face fontified t) 271 272 (fontified t) 272 281 (face font-lock-builtin-face fontified t) 281 286 (fontified t) 286 298 (face font-lock-builtin-face fontified t) 298 299 (fontified t) 299 311 (face font-lock-builtin-face fontified t) 311 312 (fontified t) 312 315 (face font-lock-builtin-face fontified t) 315 316 (fontified t) 316 320 (face font-lock-builtin-face fontified t) 320 321 (fontified t) 321 334 (face font-lock-builtin-face fontified t) 334 335 (fontified t) 335 349 (face font-lock-builtin-face fontified t) 349 350 (fontified t) 350 366 (face font-lock-builtin-face fontified t) 366 369 (fontified t) 369 386 (face font-lock-builtin-face fontified t) 386 387 (fontified t) 387 403 (face font-lock-builtin-face fontified t) 403 408 (fontified t) 408 420 (face font-lock-builtin-face fontified t) 420 421 (fontified t) 421 437 (face font-lock-builtin-face fontified t) 437 438 (fontified t) 438 452 (face font-lock-builtin-face fontified t) 452 457 (fontified t) 457 469 (face font-lock-builtin-face fontified t) 469 470 (fontified t) 470 486 (face font-lock-builtin-face fontified t) 486 487 (fontified t) 487 504 (face font-lock-builtin-face fontified t) 504 509 (fontified t) 509 516 (face font-lock-builtin-face fontified t) 516 517 (fontified t) 517 525 (face font-lock-builtin-face fontified t) 525 526 (fontified t) 526 545 (face font-lock-builtin-face fontified t) 545 546 (fontified t) 546 559 (face font-lock-builtin-face fontified t) 559 564 (fontified t) 564 575 (face font-lock-builtin-face fontified t) 575 576 (fontified t) 576 584 (face font-lock-builtin-face fontified t) 584 585 (fontified t) 585 593 (face font-lock-builtin-face fontified t) 593 594 (fontified t) 594 602 (face font-lock-builtin-face fontified t) 602 603 (fontified t) 603 611 (face font-lock-builtin-face fontified t) 611 616 (fontified t) 616 626 (face font-lock-keyword-face fontified t) 626 627 (fontified t) 627 643 (face font-lock-builtin-face fontified t) 643 647 (fontified t) 647 659 (face font-lock-keyword-face fontified t) 659 660 (fontified t) 660 667 (face font-lock-variable-name-face fontified t) 667 685 (fontified t) 685 690 (face font-lock-builtin-face fontified t) 690 701 (fontified t) 701 723 (face font-lock-comment-face fontified t) 723 725 (fontified t) 725 730 (face font-lock-keyword-face fontified t) 730 731 (fontified t) 731 739 (face font-lock-function-name-face fontified t) 739 775 (fontified t) 775 778 (face font-lock-builtin-face fontified t) 778 787 (fontified t) 787 793 (face font-lock-builtin-face fontified t) 793 805 (fontified t) 805 810 (face font-lock-builtin-face fontified t) 810 825 (fontified t) 825 833 (face font-lock-builtin-face fontified t) 833 844 (fontified t) 844 853 (face font-lock-builtin-face fontified t) 853 865 (fontified t) 865 873 (face font-lock-builtin-face fontified t) 873 886 (fontified t) 886 897 (face font-lock-builtin-face fontified t) 897 926 (fontified t) 926 930 (face font-lock-comment-delimiter-face fontified t) 930 963 (face font-lock-comment-face fontified t) 963 964 (fontified t) 964 969 (face font-lock-keyword-face fontified t) 969 970 (fontified t) 970 978 (face font-lock-function-name-face fontified t) 978 985 (fontified t) 985 1068 (face font-lock-doc-face fontified t) 1068 1108 (fontified t) 1108 1113 (face font-lock-keyword-face fontified t) 1113 1114 (fontified t) 1114 1131 (face font-lock-function-name-face fontified t) 1131 1146 (fontified t) 1146 1150 (face font-lock-keyword-face fontified t) 1150 1167 (fontified t) 1167 1173 (face font-lock-keyword-face fontified t) 1173 1254 (fontified t) 1254 1258 (face font-lock-keyword-face fontified t) 1258 1297 (fontified t) 1297 1302 (face font-lock-string-face fontified t) 1302 1334 (fontified t) 1334 1393 (face font-lock-string-face fontified t) 1393 1500 (fontified t) 1500 1505 (fontified t) 1505 1507 (fontified t) 1507 1512 (face font-lock-keyword-face fontified t) 1512 1513 (fontified t) 1513 1530 (face font-lock-function-name-face fontified t) 1530 1555 (fontified t) 1555 1559 (face font-lock-keyword-face fontified t) 1559 1571 (fontified t) 1571 1575 (face font-lock-keyword-face fontified t) 1575 1675 (fontified t) 1675 1685 (face font-lock-string-face fontified t) 1685 1730 (fontified t) 1730 1783 (face font-lock-string-face fontified t) 1783 1941 (fontified t) 1941 1946 (face font-lock-keyword-face fontified t) 1946 1947 (fontified t) 1947 1959 (face font-lock-function-name-face fontified t) 1959 1982 (fontified t) 1982 2044 (face font-lock-doc-face fontified t) 2044 2048 (fontified t) 2048 2050 (face font-lock-keyword-face fontified t) 2050 2078 (fontified t) 2078 2080 (face font-lock-string-face fontified t) 2080 2105 (fontified t) 2105 2109 (face font-lock-keyword-face fontified t) 2109 2187 (fontified t) 2187 2193 (face font-lock-keyword-face fontified t) 2193 2232 (fontified t) 2232 2242 (face font-lock-string-face fontified t) 2242 2350 (fontified t) 2350 2372 (face font-lock-string-face fontified t) 2372 2446 (fontified t) 2446 2447 (fontified t) 2447 2452 (face font-lock-keyword-face fontified t) 2452 2453 (fontified t) 2453 2460 (face font-lock-function-name-face fontified t) 2460 2468 (fontified t) 2468 2472 (face font-lock-type-face fontified t) 2472 2516 (fontified t) 2516 2596 (face font-lock-doc-face fontified t) 2596 2600 (fontified t) 2600 2604 (face font-lock-keyword-face fontified t) 2604 2613 (fontified t) 2613 2615 (face font-lock-keyword-face fontified t) 2615 2631 (fontified t) 2631 2634 (face font-lock-string-face fontified t) 2634 2647 (fontified t) 2647 2658 (face font-lock-string-face fontified t) 2658 2715 (fontified t) 2715 2734 (face font-lock-string-face fontified t) 2734 2794 (fontified t) 2794 2813 (face font-lock-keyword-face fontified t) 2813 2941 (fontified t) 2941 2945 (face font-lock-keyword-face fontified t) 2945 2983 (fontified t) 2983 2999 (face font-lock-string-face fontified t) 2999 3005 (fontified t) 3005 3029 (fontified t) 3029 3038 (face font-lock-keyword-face fontified t) 3038 3048 (fontified t) 3048 3133 (fontified t) 3133 3151 (face font-lock-keyword-face fontified t) 3151 3157 (fontified t) 3157 3166 (face font-lock-type-face fontified t) 3166 3231 (fontified t) 3231 3238 (face font-lock-string-face fontified t) 3238 3290 (fontified t) 3290 3292 (face font-lock-string-face fontified t) 3292 3307 (fontified t) 3307 3311 (face font-lock-keyword-face fontified t) 3311 3341 (fontified t) 3341 3354 (face font-lock-string-face fontified t) 3354 3373 (fontified t) 3373 3377 (face font-lock-keyword-face fontified t) 3377 3407 (fontified t) 3407 3421 (face font-lock-string-face fontified t) 3421 3473 (fontified t) 3473 3478 (face font-lock-keyword-face fontified t) 3478 3479 (fontified t) 3479 3489 (face font-lock-function-name-face fontified t) 3489 3500 (fontified t) 3500 3504 (face font-lock-type-face fontified t) 3504 3513 (fontified t) 3513 3516 (face font-lock-builtin-face fontified t) 3516 3543 (fontified t) 3543 3575 (face font-lock-string-face fontified t) 3575 3608 (fontified t) 3608 3613 (face font-lock-keyword-face fontified t) 3613 3614 (fontified t) 3614 3621 (face font-lock-function-name-face fontified t) 3621 3636 (fontified t) 3636 3655 (face font-lock-keyword-face fontified t) 3655 3742 (fontified t) 3742 3745 (face font-lock-comment-delimiter-face fontified t) 3745 3757 (face font-lock-comment-face fontified t) 3757 3759 (fontified t) 3759 3764 (face font-lock-keyword-face fontified t) 3764 3765 (fontified t) 3765 3772 (face font-lock-function-name-face fontified t) 3772 3786 (fontified t) 3786 3790 (face font-lock-type-face fontified t) 3790 3799 (fontified t) 3799 3802 (face font-lock-builtin-face fontified t) 3802 3808 (fontified t) 3808 3827 (face font-lock-keyword-face fontified t) 3827 3925 (fontified t) 3925 3930 (face font-lock-keyword-face fontified t) 3930 3931 (fontified t) 3931 3938 (face font-lock-function-name-face fontified t) 3938 3949 (fontified t) 3949 3953 (face font-lock-type-face fontified t) 3953 3962 (fontified t) 3962 3965 (face font-lock-builtin-face fontified t) 3965 3971 (fontified t) 3971 3990 (face font-lock-keyword-face fontified t) 3990 4021 (fontified t) 4021 4051 (face font-lock-string-face fontified t) 4051 4086 (fontified t) 4086 4093 (face font-lock-keyword-face fontified t) 4093 4116 (fontified t) 4116 4121 (face font-lock-keyword-face fontified t) 4121 4122 (fontified t) 4122 4134 (face font-lock-function-name-face fontified t) 4134 4157 (fontified t) 4157 4161 (face font-lock-type-face fontified t) 4161 4168 (fontified t) 4168 4174 (face font-lock-string-face fontified t) 4174 4180 (fontified t) 4180 4199 (face font-lock-keyword-face fontified t) 4199 4274 (fontified t) 4274 4278 (face font-lock-keyword-face fontified t) 4278 4440 (fontified t) 4440 4445 (face font-lock-keyword-face fontified t) 4445 4446 (fontified t) 4446 4464 (face font-lock-function-name-face fontified t) 4464 4518 (fontified t) 4518 4521 (face font-lock-comment-delimiter-face fontified t) 4521 4548 (face font-lock-comment-face fontified t) 4548 4606 (face font-lock-comment-face fontified t)) . 1) (undo-tree-id11 . -575) (undo-tree-id12 . -4606) (t 26802 45297 0 0)) nil (26802 58571 821731 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10848 . 10849) (nil fontified nil 1 . 10849) (1 . 10849)) nil (26802 58571 821727 0) 0 nil])
([nil nil ((#("user" 0 4 (face font-lock-builtin-face fontified t)) . -43) (undo-tree-id10 . -4) 47) nil (26802 58571 821725 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -42) (undo-tree-id8 . -1) (undo-tree-id9 . -1) 43) nil (26802 58571 821723 0) 0 nil])
([nil nil ((#(";;;; lumen/data/repo.lisp" 0 5 (face font-lock-comment-delimiter-face fontified t) 5 25 (face font-lock-comment-face fontified t)) . 1)) nil (26802 58571 821720 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1)) nil (26802 58571 821719 0) 0 nil])
([nil nil ((17 . 18)) nil (26802 58571 821718 0) 0 nil])
([nil nil ((311 . 312)) nil (26802 58571 821717 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.repo
  (:use :cl)
  (:import-from :lumen.data.db :query-a)
  (:export
   :select* :count* :select-page*
   ;; Constructeurs de clauses (⚠️ masquent les opérateurs CL homonymes)
   := :in :and :or :search :> :< :>= :<= :!=
   ;; Defaults
   :*default-order-whitelist*))

(in-package :lumen.data.repo)

;;; ---------------------------------------------------------------------------
;;; Defaults
;;; ---------------------------------------------------------------------------
(defparameter *default-order-whitelist*
  '(:id :created_at :updated_at :name :email))

;;; ---------------------------------------------------------------------------
;;; Constructeurs de clauses
;;; ---------------------------------------------------------------------------
(defun = (&rest args)   (cons '= args))
(defun in (&rest args)  (cons 'in args))
(defun and (&rest args) (cons 'and args))
(defun or  (&rest args) (cons 'or  args))
(defun search (&rest args) (cons 'search args))
(defun > (&rest args) (cons '> args))
(defun < (&rest args) (cons '< args))
(defun >= (&rest args) (cons '>= args))
(defun <= (&rest args) (cons '<= args))
(defun != (&rest args) (cons '!= args))

;;; ---------------------------------------------------------------------------
;;; Validation / helpers SQL
;;; ---------------------------------------------------------------------------
(defun %ident-p (x)
  \"Autorise symbol/keyword convertibles en ident SQL simple (lowercase, _).\"
  (and (or (symbolp x) (keywordp x) (stringp x))
       (let* ((s (string-downcase (etypecase x
                                    (string x)
                                    (symbol (symbol-name x))))))
         (and (> (length s) 0)
              (char<= #\\a (aref s 0) #\\z)
              (every (lambda (ch)
                       (or (char<= #\\a ch #\\z)
                           (char<= #\\0 ch #\\9)
                           (char= ch #\\_)))
                     s)))))

(defun %ident (x)
  (unless (%ident-p x)
    (error \"Identifiant SQL invalide: ~S\" x))
  (string-downcase (etypecase x
                     (string x)
                     (symbol (symbol-name x)))))

(defun %table-sql (table)
  (%ident table))

(defun %column-sql (col)
  (%ident col))

(defun %comma-join (strings)
  (with-output-to-string (s)
    (loop for (a . rest) on strings do
          (princ a s)
          (when rest (princ \", \" s)))))

;;; ---------------------------------------------------------------------------
;;; Param builder ($1, $2, …)
;;; ---------------------------------------------------------------------------
(defun %make-param-emitter ()
  \"Retourne deux closures: (emit value) -> \\\"$N\\\" et (params) -> liste.\"
  (let ((n 0)
        (ps '()))
    (values
     (lambda (value)
       (incf n)
       (push value ps)
       (format nil \"$~D\" n))
     (lambda () (nreverse ps)))))

;;; ---------------------------------------------------------------------------
;;; WHERE builder
;;; ---------------------------------------------------------------------------
(defun %build-where (filters fts-config emit)
  \"Retourne deux valeurs: sql, params-list.\"
  (labels
      ((rec (f)
         (cond
           ((null f) \"\")
           ((and (consp f) (symbolp (car f)))
            (let ((op (car f)))
              (ecase op
                ((= > < >= <= !=)
                 (destructuring-bind (field value) (cdr f)
                   (let ((lhs (%column-sql field))
                         (ph  (funcall emit value)))
                     (ecase op
                       (=  (format nil \"~a = ~a\" lhs ph))
                       (>  (format nil \"~a > ~a\" lhs ph))
                       (<  (format nil \"~a < ~a\" lhs ph))
                       (>= (format nil \"~a >= ~a\" lhs ph))
                       (<= (format nil \"~a <= ~a\" lhs ph))
                       (!= (format nil \"~a <> ~a\" lhs ph))))))
                (in
                 (destructuring-bind (field values) (cdr f)
                   (let ((lhs (%column-sql field)))
                     (if (or (null values) (endp values))
                         \"false\" ; IN () → faux
                         (let* ((placeholders (mapcar (lambda (v) (funcall emit v)) values))
                                (phs (%comma-join placeholders)))
                           (format nil \"~a in (~a)\" lhs phs))))))
                (and
                 (let* ((parts (mapcar #'rec (cdr f)))
                        (nn (remove \"\" parts :test #'string=)))
                   (cond ((null nn) \"\")
                         ((= 1 (length nn)) (first nn))
                         (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                (or
                 (let* ((parts (mapcar #'rec (cdr f)))
                        (nn (remove \"\" parts :test #'string=)))
                   (cond ((null nn) \"\")
                         ((= 1 (length nn)) (first nn))
                         (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                (search
                 ;; fts-config supporte deux modes:
                 ;;  - (:fields '(:col1 :col2 ...)) -> ILIKE sur chaque champ
                 ;;  - (:tsvector :col :language \"simple\") -> plainto_tsquery(lang, $N) contre col
                 (destructuring-bind (&key q) (cdr f)
                   (let ((query (or q (second f)))) ; tolère (search :q \"txt\") ou (search \"txt\")
                     (cond
                       ((and fts-config (getf fts-config :tsvector))
                        (let* ((lang (or (getf fts-config :language) \"simple\"))
                               (tscol (%column-sql (getf fts-config :tsvector)))
                               (ph (funcall emit query)))
                          (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                  (prin1-to-string lang) tscol
                                  (prin1-to-string lang) ph)))
                       (t
                        (let* ((fields (or (getf fts-config :fields) '()))
                               (like (lambda (col)
                                       (let ((ph (funcall emit (format nil \"%~a%\" query))))
                                         (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                               (parts (mapcar like fields)))
                          (cond
                            ((null parts) \"false\")
                            ((= 1 (length parts)) (first parts))
                            (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))
           (t (error \"Clause de filtre invalide: ~S\" f)))))
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (declare (ignore emit)) ; on utilise emit-f local
      (let ((sql (rec filters)))
        (values sql (funcall params-f))))))

;;; ---------------------------------------------------------------------------
;;; ORDER builder (avec whitelist)
;;; ---------------------------------------------------------------------------
(defun %build-order (order whitelist)
  (let ((wl (or whitelist '())))
    (labels ((allowed? (sym) (member (intern (string-upcase (%ident sym)) :keyword)
                                     wl :test #'eql)))
      (let ((parts
              (loop for spec in (or order '())
                    for (col dir) = spec
                    do (unless (allowed? col)
                         (error \"ORDER BY interdit pour la colonne ~S (hors whitelist)\" col))
                    collect (format nil \"~a ~a\"
                                    (%column-sql col)
                                    (string-upcase (if (eq dir :desc) \"DESC\" \"ASC\"))))))
        (if (null parts) \"\"
            (%comma-join parts))))))

;;; ---------------------------------------------------------------------------
;;; SELECT list
;;; ---------------------------------------------------------------------------
(defun %build-select (select)
  (cond
    ((or (null select) (eq select :*)) \"*\")
    (t (let ((cols (mapcar #'%column-sql select)))
         (%comma-join cols)))))

;;; ---------------------------------------------------------------------------
;;; API
;;; ---------------------------------------------------------------------------
(defun select* (table &key filters order select limit offset (order-whitelist '()) (fts-config nil))
  \"Retourne (list d'alists) pour la table. Tous les paramètres sont optionnels.\"
  (multiple-value-bind (emit params) (%make-param-emitter)
    (declare (ignore emit)) ; on utilise celui du WHERE ci-dessous
    (multiple-value-bind (where-sql where-params)
        (%build-where filters fts-config (lambda (v) (declare (ignore v)) nil))
      (let* ((select-sql (%build-select select))
             (order-sql  (%build-order order (or order-whitelist *default-order-whitelist*)))
             (sql (with-output-to-string (s)
                    (format s \"select ~a from ~a\" select-sql (%table-sql table))
                    (when (and where-sql (> (length where-sql) 0))
                      (format s \" where ~a\" where-sql))
                    (when (and order-sql (> (length order-sql) 0))
                      (format s \" order by ~a\" order-sql))
                    (when limit  (format s \" limit ~d\" (max 0 (truncate limit))))
                    (when offset (format s \" offset ~d\" (max 0 (truncate offset)))))))
        (multiple-value-bind (rows _n)
            (apply #'query-a sql where-params)
          (declare (ignore _n))
          rows)))))

(defun count* (table &key filters (fts-config nil))
  \"Retourne le nombre total correspondant aux filtres.\"
  (multiple-value-bind (where-sql where-params)
      (%build-where filters fts-config (lambda (v) (declare (ignore v)) nil))
    (let* ((sql (with-output-to-string (s)
                  (format s \"select count(*) as cnt from ~a\" (%table-sql table))
                  (when (and where-sql (> (length where-sql) 0))
                    (format s \" where ~a\" where-sql)))))
      (multiple-value-bind (rows _n)
          (apply #'query-a sql where-params)
        (declare (ignore _n))
        (let ((row (first rows)))
          (or (and row (parse-integer (princ-to-string (cdr (assoc :cnt row))))) 0))))))

(defun select-page* (table &key filters order select page page-size
                           (order-whitelist '()) (fts-config nil))
  \"Retourne plist :items :total :page :page-size.\"
  (let* ((p (max 1 (or page 1)))
         (ps (max 1 (or page-size 20)))
         (off (* (1- p) ps))
         (items (select* table :filters filters :order order :select select
                         :limit ps :offset off
                         :order-whitelist order-whitelist :fts-config fts-config))
         (total (count* table :filters filters :fts-config fts-config)))
    (list :items items :total total :page p :page-size ps)))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 18 (fontified t) 18 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 46 (face font-lock-type-face fontified t) 46 50 (fontified t) 50 54 (face font-lock-builtin-face fontified t) 54 55 (fontified t) 55 58 (face font-lock-builtin-face fontified t) 58 63 (fontified t) 63 75 (face font-lock-builtin-face fontified t) 75 76 (fontified t) 76 90 (face font-lock-builtin-face fontified t) 90 91 (fontified t) 91 99 (face font-lock-builtin-face fontified t) 99 104 (fontified t) 104 111 (face font-lock-builtin-face fontified t) 111 115 (fontified t) 115 123 (face font-lock-builtin-face fontified t) 123 124 (fontified t) 124 131 (face font-lock-builtin-face fontified t) 131 132 (fontified t) 132 145 (face font-lock-builtin-face fontified t) 145 149 (fontified t) 149 152 (face font-lock-comment-delimiter-face fontified t) 152 219 (face font-lock-comment-face fontified t) 219 222 (fontified t) 222 224 (face font-lock-builtin-face fontified t) 224 225 (fontified t) 225 228 (face font-lock-builtin-face fontified t) 228 229 (fontified t) 229 233 (face font-lock-builtin-face fontified t) 233 234 (fontified t) 234 237 (face font-lock-builtin-face fontified t) 237 238 (fontified t) 238 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 248 (face font-lock-builtin-face fontified t) 248 249 (fontified t) 249 251 (face font-lock-builtin-face fontified t) 251 252 (fontified t) 252 255 (face font-lock-builtin-face fontified t) 255 256 (fontified t) 256 259 (face font-lock-builtin-face fontified t) 259 260 (fontified t) 260 263 (face font-lock-builtin-face fontified t) 263 267 (fontified t) 267 270 (face font-lock-comment-delimiter-face fontified t) 270 279 (face font-lock-comment-face fontified t) 279 282 (fontified t) 282 308 (face font-lock-builtin-face fontified t) 308 312 (fontified t) 312 313 (fontified t) 313 323 (face font-lock-keyword-face fontified t) 323 324 (fontified t) 324 340 (face font-lock-builtin-face fontified t) 340 343 (fontified t) 343 347 (face font-lock-comment-delimiter-face fontified t) 347 423 (face font-lock-comment-face fontified t) 423 427 (face font-lock-comment-delimiter-face fontified t) 427 436 (face font-lock-comment-face fontified t) 436 440 (face font-lock-comment-delimiter-face fontified t) 440 516 (face font-lock-comment-face fontified t) 516 517 (fontified t) 517 529 (face font-lock-keyword-face fontified t) 529 530 (fontified t) 530 555 (face font-lock-variable-name-face fontified t) 555 560 (fontified t) 560 563 (face font-lock-builtin-face fontified t) 563 564 (fontified t) 564 575 (face font-lock-builtin-face fontified t) 575 576 (fontified t) 576 587 (face font-lock-builtin-face fontified t) 587 588 (fontified t) 588 593 (face font-lock-builtin-face fontified t) 593 594 (fontified t) 594 600 (face font-lock-builtin-face fontified t) 600 604 (fontified t) 604 608 (face font-lock-comment-delimiter-face fontified t) 608 684 (face font-lock-comment-face fontified t) 684 688 (face font-lock-comment-delimiter-face fontified t) 688 713 (face font-lock-comment-face fontified t) 713 717 (face font-lock-comment-delimiter-face fontified t) 717 793 (face font-lock-comment-face fontified t) 793 794 (fontified t) 794 799 (face font-lock-keyword-face fontified t) 799 800 (fontified t) 800 801 (face font-lock-function-name-face fontified t) 801 803 (fontified t) 803 808 (face font-lock-type-face fontified t) 808 834 (fontified t) 834 839 (face font-lock-keyword-face fontified t) 839 840 (fontified t) 840 842 (face font-lock-function-name-face fontified t) 842 844 (fontified t) 844 849 (face font-lock-type-face fontified t) 849 875 (fontified t) 875 880 (face font-lock-keyword-face fontified t) 880 881 (fontified t) 881 884 (face font-lock-function-name-face fontified t) 884 886 (fontified t) 886 891 (face font-lock-type-face fontified t) 891 917 (fontified t) 917 922 (face font-lock-keyword-face fontified t) 922 923 (fontified t) 923 925 (face font-lock-function-name-face fontified t) 925 928 (fontified t) 928 933 (face font-lock-type-face fontified t) 933 959 (fontified t) 959 964 (face font-lock-keyword-face fontified t) 964 965 (fontified t) 965 971 (face font-lock-function-name-face fontified t) 971 973 (fontified t) 973 978 (face font-lock-type-face fontified t) 978 1007 (fontified t) 1007 1012 (face font-lock-keyword-face fontified t) 1012 1013 (fontified t) 1013 1014 (face font-lock-function-name-face fontified t) 1014 1016 (fontified t) 1016 1021 (face font-lock-type-face fontified t) 1021 1045 (fontified t) 1045 1050 (face font-lock-keyword-face fontified t) 1050 1051 (fontified t) 1051 1052 (face font-lock-function-name-face fontified t) 1052 1054 (fontified t) 1054 1059 (face font-lock-type-face fontified t) 1059 1083 (fontified t) 1083 1088 (face font-lock-keyword-face fontified t) 1088 1089 (fontified t) 1089 1091 (face font-lock-function-name-face fontified t) 1091 1093 (fontified t) 1093 1098 (face font-lock-type-face fontified t) 1098 1123 (fontified t) 1123 1128 (face font-lock-keyword-face fontified t) 1128 1129 (fontified t) 1129 1131 (face font-lock-function-name-face fontified t) 1131 1133 (fontified t) 1133 1138 (face font-lock-type-face fontified t) 1138 1163 (fontified t) 1163 1168 (face font-lock-keyword-face fontified t) 1168 1169 (fontified t) 1169 1171 (face font-lock-function-name-face fontified t) 1171 1173 (fontified t) 1173 1178 (face font-lock-type-face fontified t) 1178 1203 (fontified t) 1203 1207 (face font-lock-comment-delimiter-face fontified t) 1207 1283 (face font-lock-comment-face fontified t) 1283 1287 (face font-lock-comment-delimiter-face fontified t) 1287 1312 (face font-lock-comment-face fontified t) 1312 1316 (face font-lock-comment-delimiter-face fontified t) 1316 1392 (face font-lock-comment-face fontified t) 1392 1393 (fontified t) 1393 1398 (face font-lock-keyword-face fontified t) 1398 1399 (fontified t) 1399 1407 (face font-lock-function-name-face fontified t) 1407 1414 (fontified t) 1414 1471 (face font-lock-doc-face fontified t) 1471 1488 (face font-lock-doc-face fontified t) 1488 1489 (fontified t) 1489 1519 (fontified t) 1519 1538 (fontified t) 1538 1546 (fontified t) 1546 1550 (face font-lock-keyword-face fontified t) 1550 1573 (fontified t) 1573 1582 (face font-lock-keyword-face fontified t) 1582 1632 (fontified t) 1632 1779 (fontified t) 1779 1792 (fontified t) 1792 1798 (face font-lock-keyword-face fontified t) 1798 1804 (fontified t) 1804 1812 (fontified t) 1812 1851 (fontified t) 1851 1971 (fontified t) 1971 1972 (fontified t) 1972 1977 (face font-lock-keyword-face fontified t) 1977 1978 (fontified t) 1978 1984 (face font-lock-function-name-face fontified t) 1984 1992 (fontified t) 1992 1998 (face font-lock-keyword-face fontified t) 1998 2017 (fontified t) 2017 2022 (face font-lock-warning-face fontified t) 2022 2023 (fontified t) 2023 2053 (face font-lock-string-face fontified t) 2053 2078 (fontified t) 2078 2087 (face font-lock-keyword-face fontified t) 2087 2122 (fontified t) 2122 2171 (fontified t) 2171 2173 (fontified t) 2173 2178 (face font-lock-keyword-face fontified t) 2178 2179 (fontified t) 2179 2189 (face font-lock-function-name-face fontified t) 2189 2218 (fontified t) 2218 2223 (face font-lock-keyword-face fontified t) 2223 2224 (fontified t) 2224 2235 (face font-lock-function-name-face fontified t) 2235 2260 (fontified t) 2260 2265 (face font-lock-keyword-face fontified t) 2265 2266 (fontified t) 2266 2277 (face font-lock-function-name-face fontified t) 2277 2291 (fontified t) 2291 2312 (face font-lock-keyword-face fontified t) 2312 2322 (fontified t) 2322 2326 (face font-lock-keyword-face fontified t) 2326 2389 (fontified t) 2389 2393 (face font-lock-keyword-face fontified t) 2393 2406 (fontified t) 2406 2410 (face font-lock-string-face fontified t) 2410 2419 (fontified t) 2419 2423 (face font-lock-comment-delimiter-face fontified t) 2423 2499 (face font-lock-comment-face fontified t) 2499 2503 (face font-lock-comment-delimiter-face fontified t) 2503 2529 (face font-lock-comment-face fontified t) 2529 2533 (face font-lock-comment-delimiter-face fontified t) 2533 2609 (face font-lock-comment-face fontified t) 2609 2610 (fontified t) 2610 2615 (face font-lock-keyword-face fontified t) 2615 2616 (fontified t) 2616 2635 (face font-lock-function-name-face fontified t) 2635 2641 (fontified t) 2641 2711 (face font-lock-doc-face fontified t) 2711 2715 (fontified t) 2715 2718 (face font-lock-keyword-face fontified t) 2718 2762 (fontified t) 2762 2768 (face font-lock-keyword-face fontified t) 2768 2835 (fontified t) 2835 2840 (face font-lock-string-face fontified t) 2840 2851 (fontified t) 2851 2857 (face font-lock-keyword-face fontified t) 2857 2879 (fontified t) 2879 2880 (fontified t) 2880 2884 (face font-lock-comment-delimiter-face fontified t) 2884 2960 (face font-lock-comment-face fontified t) 2960 2964 (face font-lock-comment-delimiter-face fontified t) 2964 2978 (face font-lock-comment-face fontified t) 2978 2982 (face font-lock-comment-delimiter-face fontified t) 2982 3058 (face font-lock-comment-face fontified t) 3058 3059 (fontified t) 3059 3064 (face font-lock-keyword-face fontified t) 3064 3065 (fontified t) 3065 3077 (face font-lock-function-name-face fontified t) 3077 3106 (fontified t) 3106 3148 (face font-lock-doc-face fontified t) 3148 3152 (fontified t) 3152 3158 (face font-lock-keyword-face fontified t) 3158 3185 (fontified t) 3185 3189 (face font-lock-keyword-face fontified t) 3189 3211 (fontified t) 3211 3213 (face font-lock-string-face fontified t) 3213 3274 (fontified t) 3274 3277 (face font-lock-keyword-face fontified t) 3277 3308 (fontified t) 3308 3313 (face font-lock-keyword-face fontified t) 3313 3351 (fontified t) 3351 3369 (fontified t) 3369 3387 (face font-lock-keyword-face fontified t) 3387 3430 (fontified t) 3430 3433 (face font-lock-keyword-face fontified t) 3433 3536 (fontified t) 3536 3541 (face font-lock-keyword-face fontified t) 3541 3584 (fontified t) 3584 3593 (face font-lock-string-face fontified t) 3593 3642 (fontified t) 3642 3651 (face font-lock-string-face fontified t) 3651 3700 (fontified t) 3700 3709 (face font-lock-string-face fontified t) 3709 3758 (fontified t) 3758 3768 (face font-lock-string-face fontified t) 3768 3817 (fontified t) 3817 3827 (face font-lock-string-face fontified t) 3827 3876 (fontified t) 3876 3886 (face font-lock-string-face fontified t) 3886 3938 (fontified t) 3938 3956 (face font-lock-keyword-face fontified t) 3956 4000 (fontified t) 4000 4003 (face font-lock-keyword-face fontified t) 4003 4054 (fontified t) 4054 4056 (face font-lock-keyword-face fontified t) 4056 4115 (fontified t) 4115 4122 (face font-lock-string-face fontified t) 4122 4123 (fontified t) 4123 4138 (face font-lock-comment-face fontified t) 4138 4164 (fontified t) 4164 4168 (face font-lock-keyword-face fontified t) 4168 4193 (fontified t) 4193 4199 (face font-lock-keyword-face fontified t) 4199 4336 (fontified t) 4336 4348 (face font-lock-string-face fontified t) 4348 4402 (fontified t) 4402 4406 (face font-lock-keyword-face fontified t) 4406 4475 (fontified t) 4475 4477 (face font-lock-string-face fontified t) 4477 4484 (fontified t) 4484 4489 (face font-lock-builtin-face fontified t) 4489 4523 (fontified t) 4523 4527 (face font-lock-keyword-face fontified t) 4527 4539 (fontified t) 4539 4541 (face font-lock-string-face fontified t) 4541 4639 (fontified t) 4639 4656 (face font-lock-string-face fontified t) 4656 4703 (fontified t) 4703 4707 (face font-lock-keyword-face fontified t) 4707 4776 (fontified t) 4776 4778 (face font-lock-string-face fontified t) 4778 4785 (fontified t) 4785 4790 (face font-lock-builtin-face fontified t) 4790 4824 (fontified t) 4824 4828 (face font-lock-keyword-face fontified t) 4828 4840 (fontified t) 4840 4842 (face font-lock-string-face fontified t) 4842 4851 (fontified t) 4851 4900 (fontified t) 4900 4940 (fontified t) 4940 4956 (face font-lock-string-face fontified t) 4956 5006 (fontified t) 5006 5009 (face font-lock-comment-delimiter-face fontified t) 5009 5041 (face font-lock-comment-face fontified t) 5041 5058 (fontified t) 5058 5062 (face font-lock-comment-delimiter-face fontified t) 5062 5119 (face font-lock-comment-face fontified t) 5119 5136 (fontified t) 5136 5140 (face font-lock-comment-delimiter-face fontified t) 5140 5218 (face font-lock-comment-face fontified t) 5218 5236 (fontified t) 5236 5254 (face font-lock-keyword-face fontified t) 5254 5256 (fontified t) 5256 5260 (face font-lock-type-face fontified t) 5260 5292 (fontified t) 5292 5295 (face font-lock-keyword-face fontified t) 5295 5324 (fontified t) 5324 5369 (face font-lock-comment-face fontified t) 5369 5391 (fontified t) 5391 5395 (face font-lock-keyword-face fontified t) 5395 5453 (fontified t) 5453 5462 (face font-lock-builtin-face fontified t) 5462 5490 (fontified t) 5490 5494 (face font-lock-keyword-face fontified t) 5494 5523 (fontified t) 5523 5532 (face font-lock-builtin-face fontified t) 5532 5534 (fontified t) 5534 5542 (face font-lock-string-face fontified t) 5542 5613 (fontified t) 5613 5622 (face font-lock-builtin-face fontified t) 5622 5722 (fontified t) 5722 5783 (face font-lock-string-face fontified t) 5783 5961 (fontified t) 5961 5965 (face font-lock-keyword-face fontified t) 5965 5996 (fontified t) 5996 6003 (face font-lock-builtin-face fontified t) 6003 6049 (fontified t) 6049 6055 (face font-lock-keyword-face fontified t) 6055 6102 (fontified t) 6102 6105 (face font-lock-keyword-face fontified t) 6105 6137 (fontified t) 6137 6143 (face font-lock-string-face fontified t) 6143 6207 (fontified t) 6207 6220 (face font-lock-string-face fontified t) 6220 6334 (fontified t) 6334 6338 (face font-lock-keyword-face fontified t) 6338 6381 (fontified t) 6381 6388 (face font-lock-string-face fontified t) 6388 6400 (fontified t) 6400 6455 (fontified t) 6455 6498 (fontified t) 6498 6514 (face font-lock-string-face fontified t) 6514 6548 (fontified t) 6548 6553 (face font-lock-warning-face fontified t) 6553 6554 (fontified t) 6554 6585 (face font-lock-string-face fontified t) 6585 6593 (fontified t) 6593 6598 (fontified t) 6598 6617 (face font-lock-keyword-face fontified t) 6617 6665 (fontified t) 6665 6672 (face font-lock-keyword-face fontified t) 6672 6688 (fontified t) 6688 6714 (face font-lock-comment-face fontified t) 6714 6721 (fontified t) 6721 6724 (face font-lock-keyword-face fontified t) 6724 6792 (fontified t) 6792 6796 (face font-lock-comment-delimiter-face fontified t) 6796 6872 (face font-lock-comment-face fontified t) 6872 6876 (face font-lock-comment-delimiter-face fontified t) 6876 6907 (face font-lock-comment-face fontified t) 6907 6911 (face font-lock-comment-delimiter-face fontified t) 6911 6987 (face font-lock-comment-face fontified t) 6987 6988 (fontified t) 6988 6993 (face font-lock-keyword-face fontified t) 6993 6994 (fontified t) 6994 7006 (face font-lock-function-name-face fontified t) 7006 7028 (fontified t) 7028 7031 (face font-lock-keyword-face fontified t) 7031 7063 (fontified t) 7063 7069 (face font-lock-keyword-face fontified t) 7069 7132 (fontified t) 7132 7140 (face font-lock-builtin-face fontified t) 7140 7182 (fontified t) 7182 7187 (face font-lock-builtin-face fontified t) 7187 7204 (fontified t) 7204 7207 (face font-lock-keyword-face fontified t) 7207 7231 (fontified t) 7231 7235 (face font-lock-keyword-face fontified t) 7235 7328 (fontified t) 7328 7334 (face font-lock-keyword-face fontified t) 7334 7376 (fontified t) 7376 7381 (face font-lock-warning-face fontified t) 7381 7382 (fontified t) 7382 7437 (face font-lock-string-face fontified t) 7437 7484 (fontified t) 7484 7491 (face font-lock-string-face fontified t) 7491 7598 (fontified t) 7598 7600 (face font-lock-keyword-face fontified t) 7600 7609 (fontified t) 7609 7614 (face font-lock-builtin-face fontified t) 7614 7616 (fontified t) 7616 7622 (face font-lock-string-face fontified t) 7622 7623 (fontified t) 7623 7628 (face font-lock-string-face fontified t) 7628 7644 (fontified t) 7644 7646 (face font-lock-keyword-face fontified t) 7646 7660 (fontified t) 7660 7662 (face font-lock-string-face fontified t) 7662 7701 (fontified t) 7701 7705 (face font-lock-comment-delimiter-face fontified t) 7705 7781 (face font-lock-comment-face fontified t) 7781 7785 (face font-lock-comment-delimiter-face fontified t) 7785 7797 (face font-lock-comment-face fontified t) 7797 7801 (face font-lock-comment-delimiter-face fontified t) 7801 7877 (face font-lock-comment-face fontified t) 7877 7878 (fontified t) 7878 7883 (face font-lock-keyword-face fontified t) 7883 7884 (fontified t) 7884 7897 (face font-lock-function-name-face fontified t) 7897 7910 (fontified t) 7910 7914 (face font-lock-keyword-face fontified t) 7914 7949 (fontified t) 7949 7951 (face font-lock-builtin-face fontified t) 7951 7954 (fontified t) 7954 7955 (face font-lock-string-face fontified t) 7955 7957 (face font-lock-string-face fontified t) 7957 7959 (fontified t) 7959 7967 (fontified t) 7967 7970 (face font-lock-keyword-face fontified t) 7970 8043 (fontified t) 8043 8047 (face font-lock-comment-delimiter-face fontified t) 8047 8123 (face font-lock-comment-face fontified t) 8123 8127 (face font-lock-comment-delimiter-face fontified t) 8127 8131 (face font-lock-comment-face fontified t) 8131 8135 (face font-lock-comment-delimiter-face fontified t) 8135 8211 (face font-lock-comment-face fontified t) 8211 8212 (fontified t) 8212 8217 (face font-lock-keyword-face fontified t) 8217 8218 (fontified t) 8218 8225 (face font-lock-function-name-face fontified t) 8225 8233 (fontified t) 8233 8237 (face font-lock-type-face fontified t) 8237 8314 (fontified t) 8314 8392 (face font-lock-doc-face fontified t) 8392 8396 (fontified t) 8396 8415 (face font-lock-keyword-face fontified t) 8415 8457 (fontified t) 8457 8464 (face font-lock-keyword-face fontified t) 8464 8480 (fontified t) 8480 8519 (face font-lock-comment-face fontified t) 8519 8524 (fontified t) 8524 8543 (face font-lock-keyword-face fontified t) 8543 8611 (fontified t) 8611 8617 (face font-lock-keyword-face fontified t) 8617 8623 (fontified t) 8623 8630 (face font-lock-keyword-face fontified t) 8630 8656 (fontified t) 8656 8660 (face font-lock-keyword-face fontified t) 8660 8811 (fontified t) 8811 8832 (face font-lock-keyword-face fontified t) 8832 8867 (fontified t) 8867 8886 (face font-lock-string-face fontified t) 8886 8939 (fontified t) 8939 8943 (face font-lock-keyword-face fontified t) 8943 9017 (fontified t) 9017 9028 (face font-lock-string-face fontified t) 9028 9062 (fontified t) 9062 9066 (face font-lock-keyword-face fontified t) 9066 9140 (fontified t) 9140 9154 (face font-lock-string-face fontified t) 9154 9188 (fontified t) 9188 9192 (face font-lock-keyword-face fontified t) 9192 9210 (fontified t) 9210 9221 (face font-lock-string-face fontified t) 9221 9270 (fontified t) 9270 9274 (face font-lock-keyword-face fontified t) 9274 9292 (fontified t) 9292 9304 (face font-lock-string-face fontified t) 9304 9345 (fontified t) 9345 9364 (face font-lock-keyword-face fontified t) 9364 9375 (fontified t) 9375 9433 (fontified t) 9433 9440 (face font-lock-keyword-face fontified t) 9440 9459 (fontified t) 9459 9474 (fontified t) 9474 9475 (fontified t) 9475 9476 (fontified t) 9476 9481 (face font-lock-keyword-face fontified t) 9481 9482 (fontified t) 9482 9488 (face font-lock-function-name-face fontified t) 9488 9496 (fontified t) 9496 9500 (face font-lock-type-face fontified t) 9500 9529 (fontified t) 9529 9582 (face font-lock-doc-face fontified t) 9582 9586 (fontified t) 9586 9605 (face font-lock-keyword-face fontified t) 9605 9671 (fontified t) 9671 9677 (face font-lock-keyword-face fontified t) 9677 9683 (fontified t) 9683 9690 (face font-lock-keyword-face fontified t) 9690 9714 (fontified t) 9714 9718 (face font-lock-keyword-face fontified t) 9718 9726 (fontified t) 9726 9747 (face font-lock-keyword-face fontified t) 9747 9780 (fontified t) 9780 9812 (face font-lock-string-face fontified t) 9812 9852 (fontified t) 9852 9856 (face font-lock-keyword-face fontified t) 9856 9898 (fontified t) 9898 9928 (fontified t) 9928 9939 (face font-lock-string-face fontified t) 9939 9955 (fontified t) 9955 9962 (fontified t) 9962 9981 (face font-lock-keyword-face fontified t) 9981 10046 (fontified t) 10046 10053 (face font-lock-keyword-face fontified t) 10053 10076 (fontified t) 10076 10079 (face font-lock-keyword-face fontified t) 10079 10168 (fontified t) 10168 10172 (face font-lock-builtin-face fontified t) 10172 10192 (fontified t) 10192 10197 (face font-lock-keyword-face fontified t) 10197 10198 (fontified t) 10198 10210 (face font-lock-function-name-face fontified t) 10210 10218 (fontified t) 10218 10222 (face font-lock-type-face fontified t) 10222 10328 (fontified t) 10328 10376 (face font-lock-doc-face fontified t) 10376 10380 (fontified t) 10380 10384 (face font-lock-keyword-face fontified t) 10384 10510 (fontified t) 10510 10518 (face font-lock-builtin-face fontified t) 10518 10527 (fontified t) 10527 10533 (face font-lock-builtin-face fontified t) 10533 10540 (fontified t) 10540 10547 (face font-lock-builtin-face fontified t) 10547 10580 (fontified t) 10580 10586 (face font-lock-builtin-face fontified t) 10586 10590 (fontified t) 10590 10597 (face font-lock-builtin-face fontified t) 10597 10627 (fontified t) 10627 10643 (face font-lock-builtin-face fontified t) 10643 10660 (fontified t) 10660 10671 (face font-lock-builtin-face fontified t) 10671 10715 (fontified t) 10715 10723 (face font-lock-builtin-face fontified t) 10723 10732 (fontified t) 10732 10743 (face font-lock-builtin-face fontified t) 10743 10768 (fontified t) 10768 10774 (face font-lock-builtin-face fontified t) 10774 10781 (fontified t) 10781 10787 (face font-lock-builtin-face fontified t) 10787 10794 (fontified t) 10794 10799 (face font-lock-builtin-face fontified t) 10799 10802 (fontified t) 10802 10812 (face font-lock-builtin-face fontified t) 10812 10818 (fontified t) 10818 10819 (fontified t rear-nonsticky t)) . 1) (undo-tree-id3 . -4965) (undo-tree-id4 . -10819) (undo-tree-id5 . -3077) (undo-tree-id6 . -3077) (undo-tree-id7 . -2418)) nil (26802 58571 821716 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10806 . 10807) (nil fontified nil 1 . 10807) (1 . 10807)) nil (26802 58571 821706 0) 0 nil])
([nil nil ((#(";;;; lumen/data/repo.lisp" 0 5 (face font-lock-comment-delimiter-face fontified t) 5 25 (face font-lock-comment-face fontified t)) . 1)) nil (26802 58571 821705 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1)) nil (26802 58571 821704 0) 0 nil])
([nil nil ((#("user" 0 4 (face font-lock-builtin-face fontified t)) . -17) (undo-tree-id2 . -4) 21) nil (26802 58571 821703 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -16) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 17) nil (26802 58571 821698 0) 0 nil])
([nil nil ((17 . 18)) nil (26802 58571 821674 0) 0 nil])
([nil nil ((306 . 307)) nil (26802 58571 821668 0) 0 nil])
([nil nil ((100 . 101) (t 26802 58571 0 0)) nil (26803 30583 735273 0) 0 nil])
([nil nil ((101 . 106)) nil (26803 30583 735272 0) 0 nil])
([nil nil ((10783 . 10785)) nil (26803 30583 735272 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14688 . 14689) (nil fontified nil 10785 . 14689) (10785 . 14689)) nil (26803 30583 735271 0) 0 nil])
([nil nil ((14657 . 14663)) nil (26803 30583 735270 0) 0 nil])
([nil nil ((#("?" 0 1 (fontified t)) . -14662) (undo-tree-id0 . -1) 14663) nil (26803 30583 735269 0) 0 nil])
([nil nil ((14662 . 14671)) nil (26803 30583 735254 0) 0 nil])
([nil nil ((14704 . 14705) (t 26803 30583 0 0)) nil (26803 31779 619927 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20374 . 20375) (nil fontified nil 14705 . 20375) (14705 . 20375)) nil (26803 31779 619926 0) 0 nil])
([nil nil ((310 . 311)) nil (26803 31779 619926 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -310) (undo-tree-id1 . -1) 311) nil (26803 31779 619925 0) 0 nil])
([nil nil ((310 . 314)) nil (26803 31779 619917 0) 0 nil])
([nil nil ((314 . 316)) nil (26803 31779 619917 0) 0 nil])
([nil nil ((316 . 317)) nil (26803 31779 619916 0) 0 nil])
([nil nil ((317 . 326)) nil (26803 31779 619916 0) 0 nil])
([nil nil ((326 . 330)) nil (26803 31779 619916 0) 0 nil])
([nil nil ((330 . 331)) nil (26803 31779 619915 0) 0 nil])
([nil nil ((331 . 338)) nil (26803 31779 619915 0) 0 nil])
([nil nil ((338 . 339)) nil (26803 31779 619915 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 357 . 358) (nil fontified nil 339 . 358) (339 . 358)) nil (26803 31779 619914 0) 0 nil])
([nil nil ((339 . 340)) nil (26803 31779 619913 0) 0 nil])
([nil nil ((20424 . 20425)) nil (26803 31779 619912 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24668 . 24669) (nil fontified nil 20425 . 24669) (20425 . 24669)) nil (26803 31779 619909 0) 0 nil])
([nil nil ((359 . 360) (t 26803 31779 0 0)) nil (26803 35188 557245 0) 0 nil])
([nil nil ((360 . 361)) nil (26803 35188 557244 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 384 . 385) (nil fontified nil 361 . 385) (361 . 385)) nil (26803 35188 557240 0) 0 nil])
([nil nil ((3321 . 3322) (t 26803 35188 0 0)) nil (26804 42627 313453 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7859 . 7860) (nil fontified nil 3322 . 7860) (3322 . 7860)) nil (26804 42627 313452 0) 0 nil])
([nil nil ((#("
(defun %build-where (filters fts-config)
  \"Retourne deux valeurs: sql, params-list.
- filters : forme normalisée (voir contrat)
- fts-config :
  * (:fields '(:col1 :col2 ...))  → ILIKE sur chaque champ (OR)
  * (:tsvector :col [:language \\\"simple\\\"]) → FTS plainto_tsquery(lang,$N)\"
  (multiple-value-bind (emit-f params-f) (%make-param-emitter)
    (labels
        ((rec (f)
           (cond
             ((null f) \"\")
             ((and (consp f) (symbolp (car f)))
              (let ((op (car f)))
                (ecase op
                  ((= > < >= <= !=)
                   (destructuring-bind (field value) (cdr f)
                     (let ((lhs (%column-sql field))
                           (ph  (funcall emit-f value)))
                       (ecase op
                         (=  (format nil \"~a = ~a\" lhs ph))
                         (>  (format nil \"~a > ~a\" lhs ph))
                         (<  (format nil \"~a < ~a\" lhs ph))
                         (>= (format nil \"~a >= ~a\" lhs ph))
                         (<= (format nil \"~a <= ~a\" lhs ph))
                         (!= (format nil \"~a <> ~a\" lhs ph))))))
                  (in
                   (destructuring-bind (field values) (cdr f)
                     (let ((lhs (%column-sql field)))
                       (if (or (null values) (endp values))
                           \"false\" ; IN () → faux
                           (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                  (phs (%comma-join placeholders)))
                             (format nil \"~a in (~a)\" lhs phs))))))
                  (and
                   (let* ((parts (mapcar #'rec (cdr f)))
                          (nn (remove \"\" parts :test #'string=)))
                     (cond ((null nn) \"\")
                           ((= 1 (length nn)) (first nn))
                           (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                  (or
                   (let* ((parts (mapcar #'rec (cdr f)))
                          (nn (remove \"\" parts :test #'string=)))
                     (cond ((null nn) \"\")
                           ((= 1 (length nn)) (first nn))
                           (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                  (search
                   ;; supporte (search :q \"txt\") et (search \"txt\")
                   (destructuring-bind (&key q) (if (consp (cdr f)) (cdr f) (list :q (second f)))
                     (let ((query q))
                       (cond
                         ((and fts-config (getf fts-config :tsvector))
                          (let* ((lang (or (getf fts-config :language) \"simple\"))
                                 (tscol (%column-sql (getf fts-config :tsvector)))
                                 (ph (funcall emit-f query)))
                            (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                    (prin1-to-string lang) tscol
                                    (prin1-to-string lang) ph)))
                         (t
                          (let* ((fields (or (getf fts-config :fields) '()))
                                 (like (lambda (col)
                                         (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                           (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                 (parts (mapcar like fields)))
                            (cond
                              ((null parts) \"false\")
                              ((= 1 (length parts)) (first parts))
                              (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))
             (t (error \"Clause de filtre invalide: ~S\" f)))))
      (let ((sql (rec filters)))
        (values sql (funcall params-f))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 44 (fontified t) 44 284 (face font-lock-doc-face fontified t) 284 288 (fontified t) 288 307 (face font-lock-keyword-face fontified t) 307 353 (fontified t) 353 359 (face font-lock-keyword-face fontified t) 359 390 (fontified t) 390 394 (face font-lock-keyword-face fontified t) 394 418 (fontified t) 418 420 (face font-lock-string-face fontified t) 420 485 (fontified t) 485 488 (face font-lock-keyword-face fontified t) 488 521 (fontified t) 521 526 (face font-lock-keyword-face fontified t) 526 586 (fontified t) 586 604 (face font-lock-keyword-face fontified t) 604 649 (fontified t) 649 652 (face font-lock-keyword-face fontified t) 652 761 (fontified t) 761 766 (face font-lock-keyword-face fontified t) 766 811 (fontified t) 811 820 (face font-lock-string-face fontified t) 820 871 (fontified t) 871 880 (face font-lock-string-face fontified t) 880 931 (fontified t) 931 940 (face font-lock-string-face fontified t) 940 991 (fontified t) 991 1001 (face font-lock-string-face fontified t) 1001 1052 (fontified t) 1052 1062 (face font-lock-string-face fontified t) 1062 1113 (fontified t) 1113 1123 (face font-lock-string-face fontified t) 1123 1179 (fontified t) 1179 1197 (face font-lock-keyword-face fontified t) 1197 1221 (fontified t) 1221 1243 (fontified t) 1243 1246 (face font-lock-keyword-face fontified t) 1246 1299 (fontified t) 1299 1301 (face font-lock-keyword-face fontified t) 1301 1362 (fontified t) 1362 1369 (face font-lock-string-face fontified t) 1369 1370 (fontified t) 1370 1385 (face font-lock-comment-face fontified t) 1385 1413 (fontified t) 1413 1417 (face font-lock-keyword-face fontified t) 1417 1442 (fontified t) 1442 1448 (face font-lock-keyword-face fontified t) 1448 1501 (fontified t) 1501 1528 (fontified t) 1528 1550 (fontified t) 1550 1591 (fontified t) 1591 1603 (face font-lock-string-face fontified t) 1603 1661 (fontified t) 1661 1665 (face font-lock-keyword-face fontified t) 1665 1736 (fontified t) 1736 1738 (face font-lock-string-face fontified t) 1738 1745 (fontified t) 1745 1750 (face font-lock-builtin-face fontified t) 1750 1786 (fontified t) 1786 1790 (face font-lock-keyword-face fontified t) 1790 1802 (fontified t) 1802 1804 (face font-lock-string-face fontified t) 1804 1906 (fontified t) 1906 1923 (face font-lock-string-face fontified t) 1923 1974 (fontified t) 1974 1978 (face font-lock-keyword-face fontified t) 1978 2049 (fontified t) 2049 2051 (face font-lock-string-face fontified t) 2051 2058 (fontified t) 2058 2063 (face font-lock-builtin-face fontified t) 2063 2099 (fontified t) 2099 2103 (face font-lock-keyword-face fontified t) 2103 2115 (fontified t) 2115 2117 (face font-lock-string-face fontified t) 2117 2219 (fontified t) 2219 2235 (face font-lock-string-face fontified t) 2235 2289 (fontified t) 2289 2292 (face font-lock-comment-delimiter-face fontified t) 2292 2337 (face font-lock-comment-face fontified t) 2337 2357 (fontified t) 2357 2375 (face font-lock-keyword-face fontified t) 2375 2377 (fontified t) 2377 2381 (face font-lock-type-face fontified t) 2381 2386 (fontified t) 2386 2388 (face font-lock-keyword-face fontified t) 2388 2419 (fontified t) 2419 2421 (face font-lock-builtin-face fontified t) 2421 2457 (fontified t) 2457 2460 (face font-lock-keyword-face fontified t) 2460 2497 (fontified t) 2497 2501 (face font-lock-keyword-face fontified t) 2501 2561 (fontified t) 2561 2570 (face font-lock-builtin-face fontified t) 2570 2600 (fontified t) 2600 2604 (face font-lock-keyword-face fontified t) 2604 2633 (fontified t) 2633 2642 (face font-lock-builtin-face fontified t) 2642 2644 (fontified t) 2644 2652 (face font-lock-string-face fontified t) 2652 2725 (fontified t) 2725 2734 (face font-lock-builtin-face fontified t) 2734 2840 (fontified t) 2840 2901 (face font-lock-string-face fontified t) 2901 3028 (fontified t) 3028 3032 (fontified t) 3032 3050 (fontified t) 3050 3060 (fontified t) 3060 3087 (fontified t) 3087 3091 (face font-lock-keyword-face fontified t) 3091 3122 (fontified t) 3122 3129 (face font-lock-builtin-face fontified t) 3129 3177 (fontified t) 3177 3183 (face font-lock-keyword-face fontified t) 3183 3232 (fontified t) 3232 3235 (face font-lock-keyword-face fontified t) 3235 3269 (fontified t) 3269 3275 (face font-lock-string-face fontified t) 3275 3341 (fontified t) 3341 3354 (face font-lock-string-face fontified t) 3354 3472 (fontified t) 3472 3476 (face font-lock-keyword-face fontified t) 3476 3521 (fontified t) 3521 3528 (face font-lock-string-face fontified t) 3528 3642 (fontified t) 3642 3658 (face font-lock-string-face fontified t) 3658 3677 (fontified t) 3677 3694 (fontified t) 3694 3699 (face font-lock-warning-face fontified t) 3699 3700 (fontified t) 3700 3731 (face font-lock-string-face fontified t) 3731 3746 (fontified t) 3746 3749 (face font-lock-keyword-face fontified t) 3749 3816 (fontified t)) . -7860) (undo-tree-id0 . -3815) (undo-tree-id1 . -3816) (undo-tree-id2 . -1011) (undo-tree-id3 . -14) (undo-tree-id4 . -8) (undo-tree-id5 . -20) (undo-tree-id6 . -1) (undo-tree-id7 . -1158) (undo-tree-id8 . -3815) (undo-tree-id9 . -1550) (undo-tree-id10 . -3060) (undo-tree-id11 . -3816) (undo-tree-id12 . -3816) (undo-tree-id13 . -3816) (undo-tree-id14 . -3816) (undo-tree-id15 . -3816) 11676) nil (26804 42627 313449 0) 0 nil])
([nil nil ((7859 . 7860) (t 26804 42627 0 0)) nil (26804 42661 786060 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -7859) (undo-tree-id16 . -1) (undo-tree-id17 . -1) 7860 (t 26804 42661 0 0)) nil (26804 42926 564741 0) 0 nil])
([nil nil ((7776 . 7777)) nil (26804 42926 564721 0) 0 nil])
([nil nil ((4166 . 4169) (t 26804 42926 0 0)) nil (26804 43197 477672 0) 0 nil])
([nil nil ((4169 . 4175)) nil (26804 43197 477671 0) 0 nil])
([nil nil ((4175 . 4176)) nil (26804 43197 477671 0) 0 nil])
([nil nil ((4176 . 4181)) nil (26804 43197 477671 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -4180) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) 4181) nil (26804 43197 477670 0) 0 nil])
([nil nil ((4337 . 4342)) nil (26804 43197 477665 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4352 . 4353) (nil fontified nil 4352 . 4353) (nil fontified nil 4349 . 4352) (nil fontified nil 4342 . 4349) (4342 . 4353)) nil (26804 43197 477665 0) 0 nil])
([nil nil ((#("X" 0 1 (face font-lock-string-face fontified t)) . -4350) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) 4351) nil (26804 43197 477663 0) 0 nil])
([nil nil ((4350 . 4351)) nil (26804 43197 477645 0) 0 nil])
([nil nil ((4353 . 4358) (t 26804 43197 0 0)) nil (26804 43283 17839 0) 0 nil])
([nil nil ((4358 . 4364)) nil (26804 43283 17838 0) 0 nil])
([nil nil ((4364 . 4365)) nil (26804 43283 17838 0) 0 nil])
([nil nil ((4365 . 4368)) nil (26804 43283 17838 0) 0 nil])
([nil nil ((5606 . 5614)) nil (26804 43283 17837 0) 0 nil])
([nil nil ((5614 . 5616)) nil (26804 43283 17837 0) 0 nil])
([nil nil ((5616 . 5617)) nil (26804 43283 17836 0) 0 nil])
([nil nil ((5617 . 5618)) nil (26804 43283 17836 0) 0 nil])
([nil nil ((5618 . 5619)) nil (26804 43283 17836 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -5618) (undo-tree-id32 . -1) 5619) nil (26804 43283 17835 0) 0 nil])
([nil nil ((5618 . 5623)) nil (26804 43283 17834 0) 0 nil])
([nil nil ((5623 . 5624)) nil (26804 43283 17833 0) 0 nil])
([nil nil ((5624 . 5630)) nil (26804 43283 17833 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -5629) (undo-tree-id31 . -1) 5630) nil (26804 43283 17828 0) 0 nil])
([nil nil ((5629 . 5631)) nil (26804 43283 17819 0) 0 nil])
([nil nil ((5699 . 5709)) nil (26804 43283 17818 0) 0 nil])
([nil nil ((5709 . 5715)) nil (26804 43283 17818 0) 0 nil])
([nil nil ((5715 . 5716)) nil (26804 43283 17818 0) 0 nil])
([nil nil ((5716 . 5719)) nil (26804 43283 17817 0) 0 nil])
([nil nil ((5699 . 5709)) nil (26804 43283 17816 0) 0 nil])
([nil nil ((5709 . 5715)) nil (26804 43283 17816 0) 0 nil])
([nil nil ((5715 . 5716)) nil (26804 43283 17815 0) 0 nil])
([nil nil ((5716 . 5719)) nil (26804 43283 17814 0) 0 nil])
([nil nil ((5719 . 5720)) nil (26804 43283 17810 0) 0 nil])
([nil nil ((4611 . 4616) (t 26804 43283 0 0)) nil (26804 43463 733094 0) 0 nil])
([nil nil ((4616 . 4622)) nil (26804 43463 733093 0) 0 nil])
([nil nil ((4622 . 4623)) nil (26804 43463 733093 0) 0 nil])
([nil nil ((4623 . 4628)) nil (26804 43463 733092 0) 0 nil])
([nil nil ((#("L" 0 1 (face font-lock-string-face fontified t)) . -4626) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (#("\"" 0 1 (face font-lock-string-face fontified t)) . -4627) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) 4628) nil (26804 43463 733090 0) 0 nil])
([nil nil ((4626 . 4629)) nil (26804 43463 733072 0) 0 nil])
([nil nil ((7942 . 7946) (t 26804 43463 0 0)) nil (26804 43527 840022 0) 0 nil])
([nil nil ((7946 . 7952)) nil (26804 43527 840021 0) 0 nil])
([nil nil ((7952 . 7953)) nil (26804 43527 840021 0) 0 nil])
([nil nil ((7953 . 7955)) nil (26804 43527 840020 0) 0 nil])
([nil nil ((#("X" 0 1 (face font-lock-string-face fontified t)) . -7954) (undo-tree-id45 . -1) 7955) nil (26804 43527 840020 0) 0 nil])
([nil nil ((7954 . 7960)) nil (26804 43527 840019 0) 0 nil])
([nil nil ((7960 . 7964)) nil (26804 43527 840018 0) 0 nil])
([nil nil ((7964 . 7965)) nil (26804 43527 840018 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -7964) (undo-tree-id44 . -1) 7965) nil (26804 43527 840017 0) 0 nil])
([nil nil ((7964 . 7965)) nil (26804 43527 840016 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -7964) (undo-tree-id43 . -1) 7965) nil (26804 43527 840014 0) 0 nil])
([nil nil ((7964 . 7970)) nil (26804 43527 840004 0) 0 nil])
([nil nil ((7970 . 7971)) nil (26804 43527 840004 0) 0 nil])
([nil nil ((7971 . 7972)) nil (26804 43527 840003 0) 0 nil])
([nil nil ((7972 . 7975)) nil (26804 43527 839998 0) 0 nil])
([nil nil ((4629 . 4634) (t 26804 43527 0 0)) nil (26804 43579 963628 0) 0 nil])
([nil nil ((4634 . 4640)) nil (26804 43579 963628 0) 0 nil])
([nil nil ((4640 . 4641)) nil (26804 43579 963627 0) 0 nil])
([nil nil ((4641 . 4645)) nil (26804 43579 963627 0) 0 nil])
([nil nil ((#("k" 0 1 (fontified t)) . -4641) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (#("s" 0 1 (fontified t)) . -4642) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (#("h" 0 1 (fontified t)) . -4643) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (#(")" 0 1 (fontified t)) . -4644) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) 4645) nil (26804 43579 963626 0) 0 nil])
([nil nil ((4641 . 4644)) nil (26804 43579 963613 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -4642) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (#("h" 0 1 (fontified t)) . -4643) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) 4644) nil (26804 43579 963613 0) 0 nil])
([nil nil ((4642 . 4644)) nil (26804 43579 963608 0) 0 nil])
([nil nil ((#("j" 0 1 (fontified t)) . -4642) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (#("s" 0 1 (fontified t)) . -4643) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) 4644) nil (26804 43579 963606 0) 0 nil])
([nil nil ((4642 . 4645)) nil (26804 43579 963585 0) 0 nil])
([nil nil ((4645 . 4650)) nil (26804 43579 963584 0) 0 nil])
([nil nil ((4650 . 4651)) nil (26804 43579 963584 0) 0 nil])
([nil nil ((4651 . 4656)) nil (26804 43579 963583 0) 0 nil])
([nil nil ((4656 . 4657)) nil (26804 43579 963582 0) 0 nil])
([nil nil ((4657 . 4660)) nil (26804 43579 963579 0) 0 nil])
([nil nil ((4660 . 4665) (t 26804 43579 0 0)) nil (26804 43632 562539 0) 0 nil])
([nil nil ((4665 . 4671)) nil (26804 43632 562539 0) 0 nil])
([nil nil ((4671 . 4672)) nil (26804 43632 562537 0) 0 nil])
([nil nil ((4672 . 4675)) nil (26804 43632 562534 0) 0 nil])
([nil nil ((7887 . 7888) (t 26804 43632 0 0)) nil (26804 43699 47817 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -7952) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) 7953) nil (26804 43699 47814 0) 0 nil])
([nil nil ((11930 . 11932) (t 26804 43699 0 0)) nil (26804 50240 183082 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12660 . 12661) (nil fontified nil 11932 . 12661) (11932 . 12661)) nil (26804 50240 183081 0) 0 nil])
([nil nil ((9458 . 9459)) nil (26804 50240 183080 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10412 . 10413) (nil fontified nil 9459 . 10413) (9459 . 10413)) nil (26804 50240 183080 0) 0 nil])
([nil nil ((13713 . 13714)) nil (26804 50240 183079 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17393 . 17394) (nil fontified nil 13714 . 17394) (13714 . 17394)) nil (26804 50240 183079 0) 0 nil])
([nil nil ((#("
(defun upsert* (table row-alist
               &key conflict-columns update-columns returning
                    touch-updated-col (touch-db-fn \"CURRENT_TIMESTAMP\"))
  \"INSERT ... ON CONFLICT (...) DO UPDATE ...
Arguments:
  TABLE              — ident SQL sûr.
  ROW-ALIST          — alist (:col . value) → colonnes à insérer.
  CONFLICT-COLUMNS   — liste de colonnes (obligatoire).
  UPDATE-COLUMNS     — NIL=auto (ROW-ALIST \\\\ CONFLICT-COLUMNS) | :none | liste.
  RETURNING          — NIL | T (=*) | liste de colonnes.
  TOUCH-UPDATED-COL  — si non NIL, ajoute `col = <touch-db-fn>` si absent d'UPDATE.
  TOUCH-DB-FN        — littéral SQL (par défaut CURRENT_TIMESTAMP).\"
  (unless (and conflict-columns (listp conflict-columns) (plusp (length conflict-columns)))
    (error \"upsert*: :conflict-columns requis et non vide\"))

  ;; Normaliser/valider
  (let* ((table-sql (%ident table))
         (cols-raw (%alist-keys-preserving-order row-alist))
         (vals-raw (%alist-values-preserving-order row-alist))
         (cols (mapcar #'%ident cols-raw))
         (conflict-cols (mapcar #'%ident conflict-columns))
         (conflict-set (%kw-set conflict-columns))
         (update-list
           (cond
             ((eq update-columns :none) :none)
             ((null update-columns)
              ;; toutes les colonnes de l'insert hors colonnes de conflit
              (remove-if (lambda (ckw) (member ckw conflict-set :test #'eq))
                         (%kw-set cols-raw)))
             (t
              (%kw-set update-columns))))
         (do-update-p (not (eq update-list :none))))

    ;; Build INSERT columns + placeholders
    (multiple-value-bind (emit params-f) (%make-param-emitter)
      (let* ((placeholders (mapcar (lambda (v) (funcall emit v)) vals-raw))
             (insert-cols-sql (%comma-join cols))
             (values-sql     (%comma-join placeholders))
             ;; ON CONFLICT target
             (conflict-sql   (format nil \"(~{~a~^, ~})\" conflict-cols))
             ;; DO UPDATE SET part
             (set-parts
               (when do-update-p
                 (let* ((upd-cols-sql
                          (mapcar (lambda (ckw)
                                    (let ((c (%ident ckw)))
                                      (format nil \"~a = EXCLUDED.~a\" c c)))
                                  update-list))
                        (touch-part
                          (when (and touch-updated-col
                                     (not (member (intern (string-upcase (%ident touch-updated-col)) :keyword)
                                                  update-list :test #'eq)))
                            (format nil \"~a = ~a\" (%ident touch-updated-col) touch-db-fn))))
                   (remove \"\" (append upd-cols-sql (list touch-part)) :test #'string=))))
             (on-conflict-sql
               (if do-update-p
                   (format nil \"on conflict ~a do update set ~{~a~^, ~}\" conflict-sql set-parts)
                   (format nil \"on conflict ~a do nothing\" conflict-sql)))
             (returning-sql
               (cond
                 ((eq returning t) \" returning *\")
                 ((and (listp returning) (every #'identity returning))
                  (format nil \" returning ~{~a~^, ~}\"
                          (mapcar #'%ident returning)))
                 ((null returning) \"\")
                 (t \" returning *\")))
             (sql (format nil
                          \"insert into ~a (~a) values (~a) ~a~a\"
                          table-sql insert-cols-sql values-sql on-conflict-sql returning-sql)))
        ;; Exécuter
        (apply #'lumen.data.db:exec sql (funcall params-f))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 11 (face font-lock-function-name-face fontified t) 11 15 (face font-lock-function-name-face fontified t) 15 48 (fontified t) 48 52 (face font-lock-type-face fontified t) 52 146 (fontified t) 146 165 (face font-lock-string-face fontified t) 165 170 (fontified t) 170 512 (face font-lock-doc-face fontified t) 512 523 (face font-lock-doc-face fontified t) 523 675 (face font-lock-doc-face fontified t) 675 679 (fontified t) 679 685 (face font-lock-keyword-face fontified t) 685 773 (fontified t) 773 778 (face font-lock-warning-face fontified t) 778 779 (fontified t) 779 826 (face font-lock-string-face fontified t) 826 832 (fontified t) 832 835 (face font-lock-comment-delimiter-face fontified t) 835 854 (face font-lock-comment-face fontified t) 854 857 (fontified t) 857 861 (face font-lock-keyword-face fontified t) 861 1093 (fontified t) 1093 1117 (fontified t) 1117 1202 (fontified t) 1202 1206 (face font-lock-keyword-face fontified t) 1206 1240 (fontified t) 1240 1245 (face font-lock-builtin-face fontified t) 1245 1247 (fontified t) 1247 1252 (face font-lock-builtin-face fontified t) 1252 1304 (fontified t) 1304 1307 (face font-lock-comment-delimiter-face fontified t) 1307 1364 (face font-lock-comment-face fontified t) 1364 1390 (fontified t) 1390 1396 (face font-lock-keyword-face fontified t) 1396 1404 (fontified t) 1404 1428 (fontified t) 1428 1433 (face font-lock-builtin-face fontified t) 1433 1441 (fontified t) 1441 1499 (fontified t) 1499 1500 (fontified t) 1500 1503 (fontified t) 1503 1511 (fontified t) 1511 1545 (fontified t) 1545 1555 (fontified t) 1555 1566 (face font-lock-keyword-face fontified t) 1566 1588 (fontified t) 1588 1593 (face font-lock-builtin-face fontified t) 1593 1603 (fontified t) 1603 1606 (face font-lock-comment-delimiter-face fontified t) 1606 1642 (face font-lock-comment-face fontified t) 1642 1647 (fontified t) 1647 1666 (face font-lock-keyword-face fontified t) 1666 1712 (fontified t) 1712 1716 (face font-lock-keyword-face fontified t) 1716 1741 (fontified t) 1741 1747 (face font-lock-keyword-face fontified t) 1747 1818 (fontified t) 1818 1901 (fontified t) 1901 1904 (face font-lock-comment-delimiter-face fontified t) 1904 1923 (face font-lock-comment-face fontified t) 1923 1964 (fontified t) 1964 1978 (face font-lock-string-face fontified t) 1978 2008 (fontified t) 2008 2011 (face font-lock-comment-delimiter-face fontified t) 2011 2030 (face font-lock-comment-face fontified t) 2030 2070 (fontified t) 2070 2074 (face font-lock-keyword-face fontified t) 2074 2105 (fontified t) 2105 2109 (face font-lock-keyword-face fontified t) 2109 2160 (fontified t) 2160 2166 (face font-lock-keyword-face fontified t) 2166 2210 (fontified t) 2210 2213 (face font-lock-keyword-face fontified t) 2213 2283 (fontified t) 2283 2301 (face font-lock-string-face fontified t) 2301 2420 (fontified t) 2420 2424 (face font-lock-keyword-face fontified t) 2424 2549 (fontified t) 2549 2557 (face font-lock-builtin-face fontified t) 2557 2621 (fontified t) 2621 2626 (face font-lock-builtin-face fontified t) 2626 2675 (fontified t) 2675 2684 (face font-lock-string-face fontified t) 2684 2755 (fontified t) 2755 2757 (face font-lock-string-face fontified t) 2757 2798 (fontified t) 2798 2803 (face font-lock-builtin-face fontified t) 2803 2864 (fontified t) 2864 2866 (face font-lock-keyword-face fontified t) 2866 2910 (fontified t) 2910 2941 (face font-lock-string-face fontified t) 2941 2951 (face font-lock-string-face fontified t) 2951 2976 (fontified t) 2976 3003 (fontified t) 3003 3007 (fontified t) 3007 3034 (face font-lock-string-face fontified t) 3034 3051 (fontified t) 3051 3095 (fontified t) 3095 3099 (face font-lock-keyword-face fontified t) 3099 3135 (fontified t) 3135 3149 (face font-lock-string-face fontified t) 3149 3252 (fontified t) 3252 3275 (face font-lock-string-face fontified t) 3275 3318 (fontified t) 3318 3332 (fontified t) 3332 3367 (fontified t) 3367 3369 (face font-lock-string-face fontified t) 3369 3391 (fontified t) 3391 3405 (face font-lock-string-face fontified t) 3405 3465 (fontified t) 3465 3503 (face font-lock-string-face fontified t) 3503 3608 (fontified t) 3608 3611 (face font-lock-comment-delimiter-face fontified t) 3611 3620 (face font-lock-comment-face fontified t) 3620 3684 (fontified t)) . -17394) (undo-tree-id127 . -3684) (undo-tree-id128 . -1599) 21078) nil (26804 50240 183078 0) 0 nil])
([nil nil ((19614 . 19616)) nil (26804 50240 183076 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20600 . 20601) (nil fontified nil 19616 . 20601) (19616 . 20601)) nil (26804 50240 183076 0) 0 nil])
([nil nil ((#("
(defun %keyset-where (key-cols dir after emit-f)
  \"Construit la condition WHERE additionnelle de keyset:
- Clé simple: COL > $n (ASC) / COL < $n (DESC)
- Clé composite (toutes mêmes dirs): (c1,c2,...) OP ROW($n1,$n2,...)
Retourne (values sql-fragment params-already-pushed-p).\"
  (when after
    (let* ((op (if (eq dir :desc) \"<\" \">\"))
           (after-list (if (listp after) after (list after))))
      (unless (= (length after-list) (length key-cols))
        (error \"select-page-keyset*: :after cardinalité ~D ne correspond pas à :key ~D\"
               (length after-list) (length key-cols)))
      (if (= 1 (length key-cols))
          (let* ((col (first key-cols))
                 (ph  (funcall emit-f (first after-list))))
            (values (format nil \"~a ~a ~a\" col op ph) t))
          ;; composite
          (let* ((phs (mapcar (lambda (v) (funcall emit-f v)) after-list))
                 (cols-sql (format nil \"(~{~a~^, ~})\" key-cols))
                 (row-sql  (format nil \"ROW(~{~a~^, ~})\" phs)))
            (values (format nil \"~a ~a ~a\" cols-sql op row-sql) t))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 21 (face font-lock-function-name-face fontified t) 21 52 (fontified t) 52 279 (face font-lock-doc-face fontified t) 279 283 (fontified t) 283 287 (face font-lock-keyword-face fontified t) 287 299 (fontified t) 299 303 (face font-lock-keyword-face fontified t) 303 310 (fontified t) 310 312 (face font-lock-keyword-face fontified t) 312 321 (fontified t) 321 326 (face font-lock-builtin-face fontified t) 326 328 (fontified t) 328 331 (face font-lock-string-face fontified t) 331 332 (fontified t) 332 335 (face font-lock-string-face fontified t) 335 362 (fontified t) 362 364 (face font-lock-keyword-face fontified t) 364 370 (fontified t) 370 371 (fontified t) 371 401 (fontified t) 401 408 (fontified t) 408 414 (face font-lock-keyword-face fontified t) 414 457 (fontified t) 457 466 (fontified t) 466 471 (face font-lock-warning-face fontified t) 471 472 (fontified t) 472 544 (face font-lock-string-face fontified t) 544 607 (fontified t) 607 609 (face font-lock-keyword-face fontified t) 609 645 (fontified t) 645 649 (face font-lock-keyword-face fontified t) 649 766 (fontified t) 766 776 (face font-lock-string-face fontified t) 776 802 (fontified t) 802 805 (face font-lock-comment-delimiter-face fontified t) 805 815 (face font-lock-comment-face fontified t) 815 826 (fontified t) 826 830 (face font-lock-keyword-face fontified t) 830 846 (fontified t) 846 852 (face font-lock-keyword-face fontified t) 852 929 (fontified t) 929 943 (face font-lock-string-face fontified t) 943 994 (fontified t) 994 1011 (face font-lock-string-face fontified t) 1011 1019 (fontified t) 1019 1051 (fontified t) 1051 1061 (face font-lock-string-face fontified t) 1061 1090 (fontified t)) . -18524) (undo-tree-id126 . -1090) 19614) nil (26804 50240 183075 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 18524)) nil (26804 50240 183073 0) 0 nil])
([nil nil ((19509 . 19511)) nil (26804 50240 183073 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22254 . 22255) (nil fontified nil 19511 . 22255) (19511 . 22255)) nil (26804 50240 183072 0) 0 nil])
([nil nil ((#("


(defun select-page-keyset* (table
                            &key filters order key after limit
                                 (order-whitelist '()) (fts-config nil))
  \"Keyset pagination: retourne plist :items :next-cursor :limit.
- TABLE  : table
- FILTERS: forme repo (même contrat que select*)
- ORDER  : ex. '((:created_at :desc)) ou '((:created_at :asc) (:id :asc))
- KEY    : :col ou '(:col1 :col2) (doit correspondre aux colonnes d'ORDER)
- AFTER  : valeur curseur (simple) ou liste (composite) — dernière ligne de la page précédente
- LIMIT  : nombre d'éléments à récupérer (>=1)\"
  (let* ((lim (max 1 (or limit 20)))
         ;; Normalise ORDER et KEY
         (key-cols (%normalize-key key)))
    (multiple-value-bind (order-cols dir) (%order-columns-and-dir order)
      ;; Check: key-cols ⊆ order-cols et même ordre
      (unless (equal key-cols order-cols)
        (error \"select-page-keyset*: :key (~{~a~^, ~}) doit correspondre exactement aux colonnes d':order (~{~a~^, ~})\"
               key-cols order-cols))
      ;; Construire WHERE (filters AND keyset)
      (multiple-value-bind (emit-f params-f) (%make-param-emitter)
        (multiple-value-bind (where-sql-base where-params)
            (%build-where filters fts-config)
          ;; intégrer les params de base
          (dolist (p where-params) (funcall emit-f p))
          ;; construire le prédicat keyset (si AFTER fourni)
          (multiple-value-bind (ks-where pushed?) (%keyset-where key-cols dir after emit-f)
            (let* ((select-sql (%build-select :*))
                   ;; Vérification ORDER whitelist avec builder existant (il lèvera au besoin)
                   (order-sql (%build-order order (or order-whitelist *default-order-whitelist*)))
                   (sql (with-output-to-string (s)
                          (format s \"select ~a from ~a\" select-sql (%table-sql table))
                          (cond
                            ((and where-sql-base ks-where (> (length where-sql-base) 0) (> (length ks-where) 0))
                             (format s \" where (~a) and (~a)\" where-sql-base ks-where))
                            ((and where-sql-base (> (length where-sql-base) 0))
                             (format s \" where ~a\" where-sql-base))
                            ((and ks-where (> (length ks-where) 0))
                             (format s \" where ~a\" ks-where)))
                          (when (and order-sql (> (length order-sql) 0))
                            (format s \" order by ~a\" order-sql))
                          (format s \" limit ~d\" lim))))
              ;; Exécution
              (multiple-value-bind (rows _n)
                  (apply #'query-a sql (funcall params-f))
                (declare (ignore _n))
                ;; next-cursor = valeurs de la dernière ligne pour les colonnes key
                (let* ((last (car (last rows)))
                       (next-cursor (when last
                                      (let ((vals (mapcar (lambda (c)
                                                            (cdr (assoc (intern (string-upcase c) :keyword) last)))
                                                          key-cols)))
                                        (if (= 1 (length vals))
                                            (first vals)
                                            vals)))))
                  (list :items rows :next-cursor next-cursor :limit lim))))))))))
" 0 1 (fontified t rear-nonsticky t) 1 2 (fontified t) 2 3 (fontified t) 3 4 (fontified t) 4 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 29 (face font-lock-function-name-face fontified t) 29 65 (fontified t) 65 69 (face font-lock-type-face fontified t) 69 121 (fontified t) 121 173 (fontified t) 173 175 (fontified t) 175 302 (face font-lock-doc-face fontified t) 302 515 (face font-lock-doc-face fontified t) 515 516 (face font-lock-doc-face fontified t) 516 548 (face font-lock-doc-face fontified t) 548 595 (face font-lock-doc-face fontified t) 595 599 (fontified t) 599 603 (face font-lock-keyword-face fontified t) 603 642 (fontified t) 642 645 (face font-lock-comment-delimiter-face fontified t) 645 668 (face font-lock-comment-face fontified t) 668 715 (fontified t) 715 734 (face font-lock-keyword-face fontified t) 734 789 (fontified t) 789 792 (face font-lock-comment-delimiter-face fontified t) 792 812 (face font-lock-comment-face fontified t) 812 835 (face font-lock-comment-face fontified t) 835 842 (fontified t) 842 848 (face font-lock-keyword-face fontified t) 848 886 (fontified t) 886 891 (face font-lock-warning-face fontified t) 891 892 (fontified t) 892 996 (face font-lock-string-face fontified t) 996 1040 (fontified t) 1040 1043 (face font-lock-comment-delimiter-face fontified t) 1043 1081 (face font-lock-comment-face fontified t) 1081 1088 (fontified t) 1088 1107 (face font-lock-keyword-face fontified t) 1107 1157 (fontified t) 1157 1176 (face font-lock-keyword-face fontified t) 1176 1263 (fontified t) 1263 1266 (face font-lock-comment-delimiter-face fontified t) 1266 1294 (face font-lock-comment-face fontified t) 1294 1305 (fontified t) 1305 1311 (face font-lock-keyword-face fontified t) 1311 1359 (fontified t) 1359 1362 (face font-lock-comment-delimiter-face fontified t) 1362 1410 (face font-lock-comment-face fontified t) 1410 1421 (fontified t) 1421 1429 (face font-lock-keyword-face fontified t) 1429 1440 (face font-lock-keyword-face fontified t) 1440 1500 (fontified t) 1500 1501 (fontified t) 1501 1502 (fontified t) 1502 1515 (fontified t) 1515 1519 (face font-lock-keyword-face fontified t) 1519 1548 (fontified t) 1548 1550 (face font-lock-builtin-face fontified t) 1550 1572 (fontified t) 1572 1575 (face font-lock-comment-delimiter-face fontified t) 1575 1648 (face font-lock-comment-face fontified t) 1648 1673 (fontified t) 1673 1747 (fontified t) 1747 1772 (fontified t) 1772 1793 (face font-lock-keyword-face fontified t) 1793 1802 (fontified t) 1802 1834 (fontified t) 1834 1853 (face font-lock-string-face fontified t) 1853 1885 (fontified t) 1885 1912 (fontified t) 1912 1916 (face font-lock-keyword-face fontified t) 1916 2048 (fontified t) 2048 2069 (fontified t) 2069 2091 (face font-lock-string-face fontified t) 2091 2118 (fontified t) 2118 2237 (fontified t) 2237 2248 (face font-lock-string-face fontified t) 2248 2373 (fontified t) 2373 2384 (face font-lock-string-face fontified t) 2384 2424 (fontified t) 2424 2428 (face font-lock-keyword-face fontified t) 2428 2508 (fontified t) 2508 2522 (face font-lock-string-face fontified t) 2522 2571 (fontified t) 2571 2582 (face font-lock-string-face fontified t) 2582 2605 (fontified t) 2605 2608 (face font-lock-comment-delimiter-face fontified t) 2608 2618 (face font-lock-comment-face fontified t) 2618 2633 (fontified t) 2633 2652 (face font-lock-keyword-face fontified t) 2652 2739 (fontified t) 2739 2746 (face font-lock-keyword-face fontified t) 2746 2776 (fontified t) 2776 2779 (face font-lock-comment-delimiter-face fontified t) 2779 2844 (face font-lock-comment-face fontified t) 2844 2861 (fontified t) 2861 2865 (face font-lock-keyword-face fontified t) 2865 2929 (fontified t) 2929 2933 (face font-lock-keyword-face fontified t) 2933 2978 (fontified t) 2978 2981 (face font-lock-keyword-face fontified t) 2981 2998 (fontified t) 2998 3002 (face font-lock-keyword-face fontified t) 3002 3004 (face font-lock-keyword-face fontified t) 3004 3009 (fontified t) 3009 3107 (fontified t) 3107 3115 (face font-lock-builtin-face fontified t) 3115 3236 (fontified t) 3236 3238 (face font-lock-keyword-face fontified t) 3238 3247 (fontified t) 3247 3259 (fontified t) 3259 3394 (fontified t) 3394 3400 (face font-lock-builtin-face fontified t) 3400 3406 (fontified t) 3406 3418 (face font-lock-builtin-face fontified t) 3418 3431 (fontified t) 3431 3437 (face font-lock-builtin-face fontified t) 3437 3452 (fontified t)) . -22255) (undo-tree-id124 . -3452) (undo-tree-id125 . -997) 25707) nil (26804 50240 183071 0) 0 nil])
([nil nil ((23402 . 23404)) nil (26804 50240 183069 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26050 . 26051) (nil fontified nil 23404 . 26051) (23404 . 26051)) nil (26804 50240 183068 0) 0 nil])
([nil nil ((#("

(defun select-page-keyset-prev* (table
                                 &key filters order key before limit
                                      (order-whitelist '()) (fts-config nil))
  \"Keyset pagination (page précédente) : retourne plist :items :prev-cursor :limit.
- TABLE  : table
- FILTERS: comme select*
- ORDER  : ex. '((:created_at :desc)) ou '((:created_at :asc) (:id :asc))
- KEY    : :col ou '(:col1 :col2) — doit correspondre exactement aux colonnes d'ORDER
- BEFORE : valeur curseur (simple ou liste) — *première* ligne de la page courante
- LIMIT  : nombre d'éléments (>=1)\"
  (let* ((lim (max 1 (or limit 20)))
         (key-cols (%normalize-key key)))
    (multiple-value-bind (order-cols dir) (%order-columns-and-dir order)
      (unless (equal key-cols order-cols)
        (error \"select-page-keyset-prev*: :key (~{~a~^, ~}) doit correspondre à :order (~{~a~^, ~})\"
               key-cols order-cols))
      (multiple-value-bind (emit-f params-f) (%make-param-emitter)
        (multiple-value-bind (where-sql-base where-params)
            (%build-where filters fts-config)
          ;; intégrer params de base
          (dolist (p where-params) (funcall emit-f p))
          ;; WHERE inverse (avant)
          (multiple-value-bind (ks-where pushed?) (%keyset-where-before key-cols dir before emit-f)
            (declare (ignore pushed?))
            (let* ((select-sql (%build-select :*))
                   (order-sql (%build-order order (or order-whitelist *default-order-whitelist*)))
                   (sql (with-output-to-string (s)
                          (format s \"select ~a from ~a\" select-sql (%table-sql table))
                          (cond
                            ((and where-sql-base ks-where (> (length where-sql-base) 0) (> (length ks-where) 0))
                             (format s \" where (~a) and (~a)\" where-sql-base ks-where))
                            ((and where-sql-base (> (length where-sql-base) 0))
                             (format s \" where ~a\" where-sql-base))
                            ((and ks-where (> (length ks-where) 0))
                             (format s \" where ~a\" ks-where)))
                          (when (and order-sql (> (length order-sql) 0))
                            (format s \" order by ~a\" order-sql))
                          (format s \" limit ~d\" lim))))
              (multiple-value-bind (rows _n)
                  (apply #'query-a sql (funcall params-f))
                (declare (ignore _n))
                ;; prev-cursor = valeurs de la *première* ligne (bord supérieur)
                (let* ((first (first rows))
                       (prev-cursor (when first
                                      (let ((vals (mapcar (lambda (c)
                                                            (cdr (assoc (intern (string-upcase c) :keyword) first)))
                                                          key-cols)))
                                        (if (= 1 (length vals)) (first vals) vals)))))
                  (list :items rows :prev-cursor prev-cursor :limit lim))))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 33 (face font-lock-function-name-face fontified t) 33 74 (fontified t) 74 78 (face font-lock-type-face fontified t) 78 160 (fontified t) 160 188 (fontified t) 188 190 (fontified t) 190 313 (face font-lock-doc-face fontified t) 313 353 (face font-lock-doc-face fontified t) 353 354 (face font-lock-doc-face fontified t) 354 388 (face font-lock-doc-face fontified t) 388 592 (face font-lock-doc-face fontified t) 592 596 (fontified t) 596 600 (face font-lock-keyword-face fontified t) 600 677 (fontified t) 677 696 (face font-lock-keyword-face fontified t) 696 752 (fontified t) 752 758 (face font-lock-keyword-face fontified t) 758 796 (fontified t) 796 801 (face font-lock-warning-face fontified t) 801 802 (fontified t) 802 887 (face font-lock-string-face fontified t) 887 932 (fontified t) 932 951 (face font-lock-keyword-face fontified t) 951 1001 (fontified t) 1001 1020 (face font-lock-keyword-face fontified t) 1020 1107 (fontified t) 1107 1110 (face font-lock-comment-delimiter-face fontified t) 1110 1134 (face font-lock-comment-face fontified t) 1134 1145 (fontified t) 1145 1151 (face font-lock-keyword-face fontified t) 1151 1199 (fontified t) 1199 1202 (face font-lock-comment-delimiter-face fontified t) 1202 1224 (face font-lock-comment-face fontified t) 1224 1235 (fontified t) 1235 1254 (face font-lock-keyword-face fontified t) 1254 1337 (fontified t) 1337 1344 (face font-lock-keyword-face fontified t) 1344 1376 (fontified t) 1376 1380 (face font-lock-keyword-face fontified t) 1380 1409 (fontified t) 1409 1411 (face font-lock-builtin-face fontified t) 1411 1501 (fontified t) 1501 1513 (fontified t) 1513 1538 (fontified t) 1538 1559 (face font-lock-keyword-face fontified t) 1559 1600 (fontified t) 1600 1619 (face font-lock-string-face fontified t) 1619 1678 (fontified t) 1678 1682 (face font-lock-keyword-face fontified t) 1682 1688 (fontified t) 1688 1796 (fontified t) 1796 1813 (fontified t) 1813 1835 (fontified t) 1835 1857 (face font-lock-string-face fontified t) 1857 1884 (fontified t) 1884 1888 (fontified t) 1888 1964 (fontified t) 1964 2003 (fontified t) 2003 2014 (face font-lock-string-face fontified t) 2014 2139 (fontified t) 2139 2150 (face font-lock-string-face fontified t) 2150 2190 (fontified t) 2190 2194 (face font-lock-keyword-face fontified t) 2194 2274 (fontified t) 2274 2288 (face font-lock-string-face fontified t) 2288 2337 (fontified t) 2337 2348 (face font-lock-string-face fontified t) 2348 2372 (fontified t) 2372 2391 (face font-lock-keyword-face fontified t) 2391 2478 (fontified t) 2478 2485 (face font-lock-keyword-face fontified t) 2485 2515 (fontified t) 2515 2518 (face font-lock-comment-delimiter-face fontified t) 2518 2580 (face font-lock-comment-face fontified t) 2580 2597 (fontified t) 2597 2601 (face font-lock-keyword-face fontified t) 2601 2661 (fontified t) 2661 2665 (face font-lock-keyword-face fontified t) 2665 2711 (fontified t) 2711 2714 (face font-lock-keyword-face fontified t) 2714 2731 (fontified t) 2731 2737 (face font-lock-keyword-face fontified t) 2737 2840 (fontified t) 2840 2848 (face font-lock-builtin-face fontified t) 2848 2970 (fontified t) 2970 2972 (face font-lock-keyword-face fontified t) 2972 3013 (fontified t) 3013 3016 (fontified t) 3016 3040 (fontified t) 3040 3046 (face font-lock-builtin-face fontified t) 3046 3052 (fontified t) 3052 3064 (face font-lock-builtin-face fontified t) 3064 3077 (fontified t) 3077 3083 (face font-lock-builtin-face fontified t) 3083 3098 (fontified t)) . -26051) (undo-tree-id114 . -1051) (undo-tree-id115 . -3098) (undo-tree-id116 . -3098) (undo-tree-id117 . -3098) (undo-tree-id118 . -1097) (undo-tree-id119 . -2) (undo-tree-id120 . -1513) (undo-tree-id121 . -2) (undo-tree-id122 . -3016) (undo-tree-id123 . -3098) 29149) nil (26804 50240 183065 0) 0 nil])
([nil nil ((2666 . 2668) (t 26804 50240 0 0)) nil (26804 50404 902324 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2755 . 2756) (nil fontified nil 2668 . 2756) (2668 . 2756)) nil (26804 50404 902320 0) 0 nil])
([nil nil ((18613 . 18615) (t 26804 50404 0 0)) nil (26804 53157 965790 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19371 . 19372) (nil fontified nil 18615 . 19372) (18615 . 19372)) nil (26804 53157 965789 0) 0 nil])
([nil nil ((19372 . 19373)) nil (26804 53157 965788 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20423 . 20424) (nil fontified nil 19373 . 20424) (19373 . 20424)) nil (26804 53157 965788 0) 0 nil])
([nil nil ((#("

(defun %keyset-where (key-cols dir after emit-f)
  \"WHERE pour la page suivante (AFTER).
- ASC  : tuple(cols)  >  ROW(vals)
- DESC : tuple(cols)  <  ROW(vals)
Mono-colonne: même logique sans tuple.\"
  (when after
    (let* ((vals (if (listp after) after (list after))))
      (unless (= (length vals) (length key-cols))
        (error \"select-page-keyset*: :after cardinalité ~D ≠ :key ~D\"
               (length vals) (length key-cols)))
      (let ((op (if (eq dir :desc) \"<\" \">\")))
        (if (= 1 (length key-cols))
            (let* ((col (first key-cols))
                   (ph  (funcall emit-f (first vals))))
              (values (format nil \"~a ~a ~a\" (%ident col) op ph) t))
            (let* ((phs (mapcar (lambda (v) (funcall emit-f v)) vals))
                   (cols-sql (format nil \"(~{~a~^, ~})\" (mapcar #'%ident key-cols)))
                   (row-sql  (format nil \"ROW(~{~a~^, ~})\" phs)))
              (values (format nil \"~a ~a ~a\" cols-sql op row-sql) t)))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-function-name-face fontified t) 22 53 (fontified t) 53 200 (face font-lock-doc-face fontified t) 200 204 (fontified t) 204 208 (face font-lock-keyword-face fontified t) 208 220 (fontified t) 220 224 (face font-lock-keyword-face fontified t) 224 233 (fontified t) 233 235 (face font-lock-keyword-face fontified t) 235 279 (fontified t) 279 285 (face font-lock-keyword-face fontified t) 285 331 (fontified t) 331 336 (face font-lock-warning-face fontified t) 336 337 (fontified t) 337 391 (face font-lock-string-face fontified t) 391 448 (fontified t) 448 451 (face font-lock-keyword-face fontified t) 451 458 (fontified t) 458 460 (face font-lock-keyword-face fontified t) 460 469 (fontified t) 469 474 (face font-lock-builtin-face fontified t) 474 476 (fontified t) 476 479 (face font-lock-string-face fontified t) 479 480 (fontified t) 480 483 (face font-lock-string-face fontified t) 483 496 (fontified t) 496 498 (face font-lock-keyword-face fontified t) 498 536 (fontified t) 536 540 (face font-lock-keyword-face fontified t) 540 655 (fontified t) 655 665 (face font-lock-string-face fontified t) 665 690 (fontified t) 690 703 (fontified t) 703 707 (face font-lock-keyword-face fontified t) 707 723 (fontified t) 723 729 (face font-lock-keyword-face fontified t) 729 802 (fontified t) 802 816 (face font-lock-string-face fontified t) 816 887 (fontified t) 887 904 (face font-lock-string-face fontified t) 904 912 (fontified t) 912 946 (fontified t) 946 956 (face font-lock-string-face fontified t) 956 987 (fontified t)) . -20424) (undo-tree-id131 . -987) 21411) nil (26804 53157 965787 0) 0 nil])
([nil nil ((23363 . 23365)) nil (26804 53157 965785 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -23364) (undo-tree-id130 . -1) 23365) nil (26804 53157 965784 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24397 . 24398) (nil fontified nil 23364 . 24398) (23364 . 24398)) nil (26804 53157 965781 0) 0 nil])
([nil nil ((#("
(defun %keyset-where-before (key-cols dir before emit-f)
  \"WHERE pour la page précédente (inverse de :after) :
- ASC  : COL < $cursor
- DESC : COL > $cursor
Composite : (c1,c2,...) OP ROW($n1,$n2,...)\"
  (when before
    (let* ((op (if (eq dir :desc) \">\" \"<\"))
           (vals (if (listp before) before (list before))))
      (unless (= (length vals) (length key-cols))
        (error \"select-page-keyset-prev*: :before cardinalité ~D ≠ :key ~D\"
               (length vals) (length key-cols)))
      (if (= 1 (length key-cols))
          (let* ((col (first key-cols))
                 (ph  (funcall emit-f (first vals))))
            (values (format nil \"~a ~a ~a\" col op ph) t))
          (let* ((phs (mapcar (lambda (v) (funcall emit-f v)) vals))
                 (cols-sql (format nil \"(~{~a~^, ~})\" key-cols))
                 (row-sql  (format nil \"ROW(~{~a~^, ~})\" phs)))
            (values (format nil \"~a ~a ~a\" cols-sql op row-sql) t))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 28 (face font-lock-function-name-face fontified t) 28 60 (fontified t) 60 203 (face font-lock-doc-face fontified t) 203 207 (fontified t) 207 211 (face font-lock-keyword-face fontified t) 211 224 (fontified t) 224 228 (face font-lock-keyword-face fontified t) 228 235 (fontified t) 235 237 (face font-lock-keyword-face fontified t) 237 246 (fontified t) 246 251 (face font-lock-builtin-face fontified t) 251 253 (fontified t) 253 256 (face font-lock-string-face fontified t) 256 257 (fontified t) 257 260 (face font-lock-string-face fontified t) 260 281 (fontified t) 281 283 (face font-lock-keyword-face fontified t) 283 323 (fontified t) 323 330 (fontified t) 330 336 (face font-lock-keyword-face fontified t) 336 382 (fontified t) 382 387 (face font-lock-warning-face fontified t) 387 388 (fontified t) 388 448 (face font-lock-string-face fontified t) 448 498 (fontified t) 498 505 (fontified t) 505 507 (face font-lock-keyword-face fontified t) 507 543 (fontified t) 543 547 (face font-lock-keyword-face fontified t) 547 616 (fontified t) 616 626 (fontified t) 626 658 (fontified t) 658 668 (face font-lock-string-face fontified t) 668 695 (fontified t) 695 699 (face font-lock-keyword-face fontified t) 699 715 (fontified t) 715 721 (face font-lock-keyword-face fontified t) 721 792 (fontified t) 792 806 (face font-lock-string-face fontified t) 806 857 (fontified t) 857 863 (face font-lock-string-face fontified t) 863 874 (face font-lock-string-face fontified t) 874 882 (fontified t) 882 914 (fontified t) 914 924 (face font-lock-string-face fontified t) 924 954 (fontified t)) . -24398) (undo-tree-id129 . -954) 25352) nil (26804 53157 965778 0) 0 nil])
([nil nil ((#("
		(print \"X\")" 0 1 (fontified t) 1 9 (fontified t) 9 10 (fontified t) 10 13 (face font-lock-string-face fontified t) 13 14 (fontified t)) . 4256) (undo-tree-id166 . -14) (t 26804 53157 0 0)) nil (26804 54122 267258 0) 0 nil])
([nil nil ((#("
		  (print \"Y\")
		  (print op)" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 15 (face font-lock-string-face fontified t) 15 16 (fontified t rear-nonsticky t) 16 17 (fontified t) 17 31 (fontified t)) . 4413) (undo-tree-id165 . -31)) nil (26804 54122 267257 0) 0 nil])
([nil nil ((#("
			 (print \"HUM\")
			 (print lhs)
			 (print ph)
			 (print op)" 0 1 (fontified t) 1 12 (fontified t) 12 17 (face font-lock-string-face fontified t) 17 19 (fontified t) 19 35 (fontified t) 35 50 (fontified t) 50 64 (fontified t)) . 4656) (undo-tree-id163 . -64) (undo-tree-id164 . -64)) nil (26804 54122 267255 0) 0 nil])
([nil nil ((#("
			    (x (print parts))" 0 1 (fontified t) 1 5 (fontified t) 5 11 (fontified t) 11 25 (fontified t)) . 5651) (undo-tree-id150 . -25) (undo-tree-id151 . -17) (undo-tree-id152 . -17) (undo-tree-id153 . -17) (undo-tree-id154 . -17) (undo-tree-id155 . -17) (undo-tree-id156 . -17) (undo-tree-id157 . -17) (undo-tree-id158 . -17) (undo-tree-id159 . -25) (undo-tree-id160 . -25) (undo-tree-id161 . -25) (undo-tree-id162 . -25)) nil (26804 54122 267253 0) 0 nil])
([nil nil ((#("
		       (print \"Z\")
		       (print nn)" 0 1 (fontified t) 1 17 (fontified t) 17 20 (face font-lock-string-face fontified t) 20 21 (fontified t) 21 22 (fontified t) 22 41 (fontified t)) . 5719) (undo-tree-id145 . -41) (undo-tree-id146 . -41) (undo-tree-id147 . -41) (undo-tree-id148 . -41) (undo-tree-id149 . -41)) nil (26804 54122 267245 0) 0 nil])
([nil nil ((#("
	  (print \"TEST\")
	  (print sql)" 0 1 (fontified t) 1 11 (fontified t) 11 17 (face font-lock-string-face fontified t) 17 19 (fontified t) 19 33 (fontified t)) . 7903) (undo-tree-id132 . -33) (undo-tree-id133 . -10) (undo-tree-id134 . -10) (undo-tree-id135 . -10) (undo-tree-id136 . -10) (undo-tree-id137 . -10) (undo-tree-id138 . -10) (undo-tree-id139 . -10) (undo-tree-id140 . -10) (undo-tree-id141 . -33) (undo-tree-id142 . -33) (undo-tree-id143 . -33) (undo-tree-id144 . -33)) nil (26804 54122 267239 0) 0 nil])
([nil nil ((47 . 53) (t 26804 54122 0 0)) nil (26806 46357 532233 0) 0 nil])
([nil nil ((423 . 425)) nil (26806 46357 532231 0) 0 nil])
([nil nil ((425 . 429)) nil (26806 46357 532228 0) 0 nil])
([nil nil ((#("
(defun %join-non-nil (items &key (sep \", \"))
  \"Concatène les strings non-NIL dans ITEMS avec SEP.\"
  (let ((xs (remove nil items)))
    (cond ((null xs) \"\")
          (t (with-output-to-string (out)
               (loop for i from 0
                     for x in xs
                     do (progn
                          (when (> i 0) (princ sep out))
                          (princ x out))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 21 (face font-lock-function-name-face fontified t) 21 29 (fontified t) 29 33 (face font-lock-type-face fontified t) 33 39 (fontified t) 39 43 (face font-lock-string-face fontified t) 43 48 (fontified t) 48 100 (face font-lock-doc-face fontified t) 100 104 (fontified t) 104 107 (face font-lock-keyword-face fontified t) 107 139 (fontified t) 139 143 (face font-lock-keyword-face fontified t) 143 155 (fontified t) 155 157 (face font-lock-string-face fontified t) 157 173 (fontified t) 173 194 (face font-lock-keyword-face fontified t) 194 217 (fontified t) 217 221 (face font-lock-keyword-face fontified t) 221 293 (fontified t) 293 298 (face font-lock-keyword-face fontified t) 298 326 (fontified t) 326 330 (face font-lock-keyword-face fontified t) 330 402 (fontified t)) . 12780) (undo-tree-id22 . -1) (undo-tree-id23 . -21) (undo-tree-id24 . -21) (undo-tree-id25 . -21) (undo-tree-id26 . -21) (undo-tree-id27 . -21) (undo-tree-id28 . -21) (undo-tree-id29 . -21) (undo-tree-id30 . -402) (undo-tree-id31 . -402) (undo-tree-id32 . -402) (undo-tree-id33 . -402) (undo-tree-id34 . -402) (undo-tree-id35 . -402) (t 26806 46357 0 0)) nil (26812 45683 594037 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -12779) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 12780) nil (26812 45683 594024 0) 0 nil])
([nil nil ((7962 . 7964) (t 26812 45683 0 0)) nil (26946 51928 770486 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12970 . 12971) (nil fontified nil 7964 . 12971) (7964 . 12971)) nil (26946 51928 770481 0) 0 nil])
([nil nil ((12971 . 12972) (t 26946 51928 0 0)) nil (26946 51982 561761 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12971) (undo-tree-id0 . -1) 12972) nil (26946 51982 561759 0) 0 nil])
([nil nil ((12457 . 12458)) nil (26946 51982 561740 0) 0 nil])
([nil nil ((3423 . 3424) (t 26946 51982 0 0)) nil (26948 7788 329381 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9294 . 9295) (nil fontified nil 3424 . 9295) (3424 . 9295)) nil (26948 7788 329380 0) 0 nil])
([nil nil ((#("
(defun %build-where (filters fts-config)
  \"Retourne deux valeurs: sql, params-list.
- filters : forme normalisée (voir contrat). On accepte aussi une liste de
  clauses au niveau racine ((= :a 1) (> :b 2) ...) qui sera interprétée comme (AND ...).
- fts-config :
  * (:fields '(:col1 :col2 ...))  → ILIKE sur chaque champ (OR)
  * (:tsvector :col [:language \\\"simple\\\"]) → FTS plainto_tsquery(lang,$N)\"
  (labels ((%filter-form-p (f) (and (consp f) (symbolp (car f)))))
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; rien
               ((null f) \"\")

               ;; si f est une liste de CLAUSES au niveau racine => (and ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; forme (OP ...)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\" ; IN () → faux
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    (search
                     ;; supporte (search :q \"txt\") et (search \"txt\")
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))
               (t (error \"Clause de filtre invalide: ~S\" f)))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))

(defun %build-where (filters fts-config)
  \"Construit la clause WHERE SQL.
   Accepte:
   - Forme standard: ((= :a 1) (search :q 'foo'))
   - Forme Alist (Query params): ((\\\"target_type\\\" . \\\"folder\\\"))\"
  (labels ((%filter-form-p (f) (and (consp f) (symbolp (car f)))))
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; 1. Rien
               ((null f) \"\")

               ;; 2. Liste de CLAUSES standards => (AND ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (not (stringp (car f))) ;; <-- Sécurité
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; 3. [NOUVEAU] Liste d'ALIST (Query Params) => ((\"k\" . \"v\") ...)
               ;; Si c'est une liste de cons dont les clés sont des strings
               ((and (consp f)
                     (consp (car f))
                     (stringp (caar f)))
                (rec (cons 'and f)))

               ;; 4. Forme OP standard (SYMBOL ...) ex: (= :col val)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\"
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    (search
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))

               ;; 5. [NOUVEAU] Forme ALIST seule (\"key\" . \"val\") -> (= :key \"val\")
               ;; Transforme la paire brute en expression S-expression standard et on récure
               ((and (consp f) (stringp (car f)))
                (rec (list '= 
                           (intern (string-upcase (car f)) :keyword) 
                           (cdr f))))

               (t (error \"Clause de filtre invalide: ~S\" f)))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 44 (fontified t) 44 404 (face font-lock-doc-face fontified t) 404 408 (fontified t) 408 414 (face font-lock-keyword-face fontified t) 414 477 (fontified t) 477 496 (face font-lock-keyword-face fontified t) 496 544 (fontified t) 544 550 (face font-lock-keyword-face fontified t) 550 585 (fontified t) 585 589 (face font-lock-keyword-face fontified t) 589 605 (fontified t) 605 608 (face font-lock-comment-delimiter-face fontified t) 608 613 (face font-lock-comment-face fontified t) 613 638 (fontified t) 638 640 (face font-lock-string-face fontified t) 640 658 (fontified t) 658 661 (face font-lock-comment-delimiter-face fontified t) 661 721 (face font-lock-comment-face fontified t) 721 899 (fontified t) 899 902 (face font-lock-comment-delimiter-face fontified t) 902 917 (face font-lock-comment-face fontified t) 917 984 (fontified t) 984 987 (face font-lock-keyword-face fontified t) 987 1022 (fontified t) 1022 1027 (face font-lock-keyword-face fontified t) 1027 1091 (fontified t) 1091 1109 (face font-lock-keyword-face fontified t) 1109 1156 (fontified t) 1156 1159 (face font-lock-keyword-face fontified t) 1159 1272 (fontified t) 1272 1277 (face font-lock-keyword-face fontified t) 1277 1324 (fontified t) 1324 1333 (face font-lock-string-face fontified t) 1333 1386 (fontified t) 1386 1395 (face font-lock-string-face fontified t) 1395 1448 (fontified t) 1448 1457 (face font-lock-string-face fontified t) 1457 1501 (fontified t) 1501 1510 (fontified t) 1510 1520 (face font-lock-string-face fontified t) 1520 1530 (fontified t) 1530 1573 (fontified t) 1573 1583 (face font-lock-string-face fontified t) 1583 1636 (fontified t) 1636 1646 (face font-lock-string-face fontified t) 1646 1706 (fontified t) 1706 1724 (face font-lock-keyword-face fontified t) 1724 1772 (fontified t) 1772 1775 (face font-lock-keyword-face fontified t) 1775 1830 (fontified t) 1830 1832 (face font-lock-keyword-face fontified t) 1832 1895 (fontified t) 1895 1902 (face font-lock-string-face fontified t) 1902 1903 (fontified t) 1903 1918 (face font-lock-comment-face fontified t) 1918 1948 (fontified t) 1948 1952 (face font-lock-keyword-face fontified t) 1952 1977 (fontified t) 1977 1983 (face font-lock-keyword-face fontified t) 1983 2130 (fontified t) 2130 2142 (face font-lock-string-face fontified t) 2142 2204 (fontified t) 2204 2208 (face font-lock-keyword-face fontified t) 2208 2281 (fontified t) 2281 2283 (face font-lock-string-face fontified t) 2283 2290 (fontified t) 2290 2295 (face font-lock-builtin-face fontified t) 2295 2333 (fontified t) 2333 2337 (face font-lock-keyword-face fontified t) 2337 2349 (fontified t) 2349 2351 (face font-lock-string-face fontified t) 2351 2457 (fontified t) 2457 2474 (face font-lock-string-face fontified t) 2474 2529 (fontified t) 2529 2533 (face font-lock-keyword-face fontified t) 2533 2606 (fontified t) 2606 2608 (face font-lock-string-face fontified t) 2608 2615 (fontified t) 2615 2620 (face font-lock-builtin-face fontified t) 2620 2658 (fontified t) 2658 2662 (face font-lock-keyword-face fontified t) 2662 2674 (fontified t) 2674 2676 (face font-lock-string-face fontified t) 2676 2782 (fontified t) 2782 2798 (face font-lock-string-face fontified t) 2798 2856 (fontified t) 2856 2859 (face font-lock-comment-delimiter-face fontified t) 2859 2904 (face font-lock-comment-face fontified t) 2904 2926 (fontified t) 2926 2944 (face font-lock-keyword-face fontified t) 2944 2946 (fontified t) 2946 2950 (face font-lock-type-face fontified t) 2950 2980 (fontified t) 2980 2982 (face font-lock-keyword-face fontified t) 2982 3030 (fontified t) 3030 3062 (fontified t) 3062 3097 (fontified t) 3097 3099 (face font-lock-builtin-face fontified t) 3099 3137 (fontified t) 3137 3140 (face font-lock-keyword-face fontified t) 3140 3179 (fontified t) 3179 3183 (face font-lock-keyword-face fontified t) 3183 3245 (fontified t) 3245 3254 (face font-lock-builtin-face fontified t) 3254 3286 (fontified t) 3286 3290 (face font-lock-keyword-face fontified t) 3290 3319 (fontified t) 3319 3328 (face font-lock-builtin-face fontified t) 3328 3330 (fontified t) 3330 3338 (face font-lock-string-face fontified t) 3338 3413 (fontified t) 3413 3422 (face font-lock-builtin-face fontified t) 3422 3532 (fontified t) 3532 3593 (face font-lock-string-face fontified t) 3593 3787 (fontified t) 3787 3791 (face font-lock-keyword-face fontified t) 3791 3822 (fontified t) 3822 3829 (face font-lock-builtin-face fontified t) 3829 3879 (fontified t) 3879 3885 (face font-lock-keyword-face fontified t) 3885 3936 (fontified t) 3936 3939 (face font-lock-keyword-face fontified t) 3939 3973 (fontified t) 3973 3979 (face font-lock-string-face fontified t) 3979 4047 (fontified t) 4047 4060 (face font-lock-string-face fontified t) 4060 4182 (fontified t) 4182 4186 (face font-lock-keyword-face fontified t) 4186 4233 (fontified t) 4233 4240 (face font-lock-string-face fontified t) 4240 4358 (fontified t) 4358 4374 (face font-lock-string-face fontified t) 4374 4412 (fontified t) 4412 4417 (face font-lock-warning-face fontified t) 4417 4418 (fontified t) 4418 4449 (face font-lock-string-face fontified t) 4449 4466 (fontified t) 4466 4470 (face font-lock-keyword-face fontified t) 4470 4493 (fontified t) 4493 4540 (fontified t) 4540 4541 (fontified t) 4541 4542 (fontified t) 4542 4547 (face font-lock-keyword-face fontified t) 4547 4548 (fontified t) 4548 4560 (face font-lock-function-name-face fontified t) 4560 4562 (fontified t) 4562 4582 (fontified t) 4582 4584 (fontified t) 4584 4744 (face font-lock-doc-face fontified t) 4744 4748 (fontified t) 4748 4754 (face font-lock-keyword-face fontified t) 4754 4817 (fontified t) 4817 4836 (face font-lock-keyword-face fontified t) 4836 4884 (fontified t) 4884 4890 (face font-lock-keyword-face fontified t) 4890 4925 (fontified t) 4925 4929 (face font-lock-keyword-face fontified t) 4929 4945 (fontified t) 4945 4948 (face font-lock-comment-delimiter-face fontified t) 4948 4956 (face font-lock-comment-face fontified t) 4956 4981 (fontified t) 4981 4983 (face font-lock-string-face fontified t) 4983 5001 (fontified t) 5001 5004 (face font-lock-comment-delimiter-face fontified t) 5004 5047 (face font-lock-comment-face fontified t) 5047 5168 (fontified t) 5168 5171 (face font-lock-comment-delimiter-face fontified t) 5171 5184 (face font-lock-comment-face fontified t) 5184 5286 (fontified t) 5286 5289 (face font-lock-comment-delimiter-face fontified t) 5289 5352 (face font-lock-comment-face fontified t) 5352 5367 (fontified t) 5367 5370 (face font-lock-comment-delimiter-face fontified t) 5370 5428 (face font-lock-comment-face fontified t) 5428 5590 (fontified t) 5590 5593 (face font-lock-comment-delimiter-face fontified t) 5593 5644 (face font-lock-comment-face fontified t) 5644 5711 (fontified t) 5711 5714 (face font-lock-keyword-face fontified t) 5714 5749 (fontified t) 5749 5754 (face font-lock-keyword-face fontified t) 5754 5818 (fontified t) 5818 5836 (face font-lock-keyword-face fontified t) 5836 5883 (fontified t) 5883 5886 (face font-lock-keyword-face fontified t) 5886 5999 (fontified t) 5999 6004 (face font-lock-keyword-face fontified t) 6004 6041 (fontified t) 6041 6051 (fontified t) 6051 6060 (face font-lock-string-face fontified t) 6060 6070 (fontified t) 6070 6082 (fontified t) 6082 6113 (fontified t) 6113 6122 (face font-lock-string-face fontified t) 6122 6132 (fontified t) 6132 6175 (fontified t) 6175 6184 (face font-lock-string-face fontified t) 6184 6237 (fontified t) 6237 6247 (face font-lock-string-face fontified t) 6247 6300 (fontified t) 6300 6310 (face font-lock-string-face fontified t) 6310 6363 (fontified t) 6363 6373 (face font-lock-string-face fontified t) 6373 6433 (fontified t) 6433 6451 (face font-lock-keyword-face fontified t) 6451 6499 (fontified t) 6499 6502 (face font-lock-keyword-face fontified t) 6502 6557 (fontified t) 6557 6559 (face font-lock-keyword-face fontified t) 6559 6622 (fontified t) 6622 6629 (face font-lock-string-face fontified t) 6629 6660 (fontified t) 6660 6664 (face font-lock-keyword-face fontified t) 6664 6689 (fontified t) 6689 6695 (face font-lock-keyword-face fontified t) 6695 6842 (fontified t) 6842 6854 (face font-lock-string-face fontified t) 6854 6916 (fontified t) 6916 6920 (face font-lock-keyword-face fontified t) 6920 6993 (fontified t) 6993 6995 (face font-lock-string-face fontified t) 6995 7002 (fontified t) 7002 7007 (face font-lock-builtin-face fontified t) 7007 7045 (fontified t) 7045 7049 (face font-lock-keyword-face fontified t) 7049 7061 (fontified t) 7061 7063 (face font-lock-string-face fontified t) 7063 7169 (fontified t) 7169 7186 (face font-lock-string-face fontified t) 7186 7241 (fontified t) 7241 7245 (face font-lock-keyword-face fontified t) 7245 7318 (fontified t) 7318 7320 (face font-lock-string-face fontified t) 7320 7327 (fontified t) 7327 7332 (face font-lock-builtin-face fontified t) 7332 7370 (fontified t) 7370 7374 (face font-lock-keyword-face fontified t) 7374 7386 (fontified t) 7386 7388 (face font-lock-string-face fontified t) 7388 7494 (fontified t) 7494 7510 (face font-lock-string-face fontified t) 7510 7569 (fontified t) 7569 7587 (face font-lock-keyword-face fontified t) 7587 7589 (fontified t) 7589 7593 (face font-lock-type-face fontified t) 7593 7623 (fontified t) 7623 7625 (face font-lock-keyword-face fontified t) 7625 7632 (fontified t) 7632 7668 (fontified t) 7668 7740 (fontified t) 7740 7742 (face font-lock-builtin-face fontified t) 7742 7780 (fontified t) 7780 7783 (face font-lock-keyword-face fontified t) 7783 7822 (fontified t) 7822 7826 (face font-lock-keyword-face fontified t) 7826 7888 (fontified t) 7888 7897 (face font-lock-builtin-face fontified t) 7897 7929 (fontified t) 7929 7933 (face font-lock-keyword-face fontified t) 7933 7962 (fontified t) 7962 7971 (face font-lock-builtin-face fontified t) 7971 7973 (fontified t) 7973 7981 (face font-lock-string-face fontified t) 7981 8056 (fontified t) 8056 8065 (face font-lock-builtin-face fontified t) 8065 8175 (fontified t) 8175 8236 (face font-lock-string-face fontified t) 8236 8430 (fontified t) 8430 8434 (face font-lock-keyword-face fontified t) 8434 8465 (fontified t) 8465 8472 (face font-lock-builtin-face fontified t) 8472 8522 (fontified t) 8522 8528 (face font-lock-keyword-face fontified t) 8528 8579 (fontified t) 8579 8582 (face font-lock-keyword-face fontified t) 8582 8616 (fontified t) 8616 8622 (face font-lock-string-face fontified t) 8622 8690 (fontified t) 8690 8703 (face font-lock-string-face fontified t) 8703 8825 (fontified t) 8825 8829 (face font-lock-keyword-face fontified t) 8829 8876 (fontified t) 8876 8883 (face font-lock-string-face fontified t) 8883 8954 (fontified t) 8954 9001 (fontified t) 9001 9017 (face font-lock-string-face fontified t) 9017 9036 (fontified t) 9036 9052 (fontified t) 9052 9055 (face font-lock-comment-delimiter-face fontified t) 9055 9120 (face font-lock-comment-face fontified t) 9120 9135 (fontified t) 9135 9138 (face font-lock-comment-delimiter-face fontified t) 9138 9168 (face font-lock-comment-face fontified t) 9168 9213 (face font-lock-comment-face fontified t) 9213 9353 (fontified t) 9353 9361 (face font-lock-builtin-face fontified t) 9361 9422 (fontified t) 9422 9427 (face font-lock-warning-face fontified t) 9427 9428 (fontified t) 9428 9459 (face font-lock-string-face fontified t) 9459 9476 (fontified t) 9476 9480 (face font-lock-keyword-face fontified t) 9480 9503 (fontified t) 9503 9548 (fontified t) 9548 9549 (fontified t rear-nonsticky t)) . 9295) (undo-tree-id1 . -9549) (undo-tree-id2 . -737) (undo-tree-id3 . -1732) (undo-tree-id4 . -4539) (undo-tree-id5 . -1) (undo-tree-id6 . -9549) (undo-tree-id7 . -9034) (undo-tree-id8 . -9549) (undo-tree-id9 . -6123) (undo-tree-id10 . -4541) (undo-tree-id11 . -9549) (undo-tree-id12 . -9549)) nil (26948 7788 329376 0) 0 nil])
([nil nil ((9212 . 9213) (t 26948 7788 0 0)) nil (26948 7887 66559 0) 0 nil])
([nil nil ((9296 . 9297)) nil (26948 7887 66558 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9296) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 9297) nil (26948 7887 66554 0) 0 nil])
([nil nil ((#("(defun %build-where (filters fts-config)
  \"Construit la clause WHERE SQL.
   Accepte:
   - Forme standard: ((= :a 1) (search :q 'foo'))
   - Forme Alist (Query params): ((\\\"target_type\\\" . \\\"folder\\\") (\\\"q[is_active]\\\" . \\\"true\\\"))\"
  (labels ((%filter-form-p (f) (and (consp f) (symbolp (car f)))))
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; 1. Rien
               ((null f) \"\")

               ;; 2. Liste de CLAUSES standards => (AND ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (not (stringp (car f)))
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; 3. Liste d'ALIST (Query Params) => ((\"k\" . \"v\") ...)
               ((and (consp f)
                     (consp (car f))
                     (stringp (caar f)))
                (rec (cons 'and f)))

               ;; 4. Forme OP standard (SYMBOL ...)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\"
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    (search
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts)))))))))))

               ;; 5. [CORRIGÉ] Forme ALIST seule (\"key\" . \"val\") -> (= :key \"val\")
               ;; Gère le nettoyage de \"q[col]\" -> :col
               ((and (consp f) (stringp (car f)))
                (let* ((raw-key (car f))
                       (len (length raw-key))
                       ;; Détection du pattern q[...]
                       (col-name (if (and (> len 3)
                                          (string= (subseq raw-key 0 2) \"q[\")
                                          (char= (char raw-key (1- len)) #\\]))
                                     ;; On extrait l'intérieur : q[is_active] -> is_active
                                     (subseq raw-key 2 (1- len))
                                     ;; Sinon on garde tel quel (ex: target_id)
                                     raw-key)))
                  
                  ;; On ignore les paramètres complexes non gérés (ex: order[...], limit)
                  ;; pour éviter de créer des colonnes invalides.
                  (unless (or (search \"order[\" raw-key)
                              (search \"limit\" raw-key)
                              (search \"page\" raw-key))
                    (rec (list '= 
                               (intern (string-upcase col-name) :keyword) 
                               (cdr f))))))

               (t (error \"Clause de filtre invalide: ~S\" f))))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 19 (face font-lock-function-name-face fontified t) 19 43 (fontified t) 43 233 (face font-lock-doc-face fontified t) 233 237 (fontified t) 237 243 (face font-lock-keyword-face fontified t) 243 306 (fontified t) 306 325 (face font-lock-keyword-face fontified t) 325 373 (fontified t) 373 379 (face font-lock-keyword-face fontified t) 379 414 (fontified t) 414 418 (face font-lock-keyword-face fontified t) 418 434 (fontified t) 434 437 (face font-lock-comment-delimiter-face fontified t) 437 445 (face font-lock-comment-face fontified t) 445 470 (fontified t) 470 472 (face font-lock-string-face fontified t) 472 490 (fontified t) 490 493 (face font-lock-comment-delimiter-face fontified t) 493 536 (face font-lock-comment-face fontified t) 536 759 (fontified t) 759 762 (face font-lock-comment-delimiter-face fontified t) 762 815 (face font-lock-comment-face fontified t) 815 977 (fontified t) 977 980 (face font-lock-comment-delimiter-face fontified t) 980 1014 (face font-lock-comment-face fontified t) 1014 1081 (fontified t) 1081 1084 (face font-lock-keyword-face fontified t) 1084 1119 (fontified t) 1119 1124 (face font-lock-keyword-face fontified t) 1124 1188 (fontified t) 1188 1206 (face font-lock-keyword-face fontified t) 1206 1253 (fontified t) 1253 1256 (face font-lock-keyword-face fontified t) 1256 1369 (fontified t) 1369 1374 (face font-lock-keyword-face fontified t) 1374 1421 (fontified t) 1421 1430 (face font-lock-string-face fontified t) 1430 1483 (fontified t) 1483 1492 (face font-lock-string-face fontified t) 1492 1500 (fontified t) 1500 1502 (fontified t) 1502 1545 (fontified t) 1545 1554 (face font-lock-string-face fontified t) 1554 1607 (fontified t) 1607 1617 (face font-lock-string-face fontified t) 1617 1670 (fontified t) 1670 1680 (face font-lock-string-face fontified t) 1680 1733 (fontified t) 1733 1743 (face font-lock-string-face fontified t) 1743 1803 (fontified t) 1803 1821 (face font-lock-keyword-face fontified t) 1821 1869 (fontified t) 1869 1872 (face font-lock-keyword-face fontified t) 1872 1927 (fontified t) 1927 1929 (face font-lock-keyword-face fontified t) 1929 1992 (fontified t) 1992 1999 (face font-lock-string-face fontified t) 1999 2030 (fontified t) 2030 2034 (face font-lock-keyword-face fontified t) 2034 2059 (fontified t) 2059 2065 (face font-lock-keyword-face fontified t) 2065 2212 (fontified t) 2212 2224 (face font-lock-string-face fontified t) 2224 2286 (fontified t) 2286 2290 (face font-lock-keyword-face fontified t) 2290 2363 (fontified t) 2363 2365 (face font-lock-string-face fontified t) 2365 2372 (fontified t) 2372 2377 (face font-lock-builtin-face fontified t) 2377 2415 (fontified t) 2415 2419 (face font-lock-keyword-face fontified t) 2419 2431 (fontified t) 2431 2433 (face font-lock-string-face fontified t) 2433 2539 (fontified t) 2539 2556 (face font-lock-string-face fontified t) 2556 2611 (fontified t) 2611 2615 (face font-lock-keyword-face fontified t) 2615 2688 (fontified t) 2688 2690 (face font-lock-string-face fontified t) 2690 2697 (fontified t) 2697 2702 (face font-lock-builtin-face fontified t) 2702 2740 (fontified t) 2740 2744 (face font-lock-keyword-face fontified t) 2744 2756 (fontified t) 2756 2758 (face font-lock-string-face fontified t) 2758 2864 (fontified t) 2864 2880 (face font-lock-string-face fontified t) 2880 2939 (fontified t) 2939 2957 (face font-lock-keyword-face fontified t) 2957 2959 (fontified t) 2959 2963 (face font-lock-type-face fontified t) 2963 2993 (fontified t) 2993 2995 (face font-lock-keyword-face fontified t) 2995 3110 (fontified t) 3110 3112 (face font-lock-builtin-face fontified t) 3112 3150 (fontified t) 3150 3153 (face font-lock-keyword-face fontified t) 3153 3192 (fontified t) 3192 3196 (face font-lock-keyword-face fontified t) 3196 3258 (fontified t) 3258 3267 (face font-lock-builtin-face fontified t) 3267 3299 (fontified t) 3299 3303 (face font-lock-keyword-face fontified t) 3303 3332 (fontified t) 3332 3341 (face font-lock-builtin-face fontified t) 3341 3343 (fontified t) 3343 3351 (face font-lock-string-face fontified t) 3351 3426 (fontified t) 3426 3435 (face font-lock-builtin-face fontified t) 3435 3545 (fontified t) 3545 3606 (face font-lock-string-face fontified t) 3606 3800 (fontified t) 3800 3804 (face font-lock-keyword-face fontified t) 3804 3835 (fontified t) 3835 3842 (face font-lock-builtin-face fontified t) 3842 3892 (fontified t) 3892 3898 (face font-lock-keyword-face fontified t) 3898 3949 (fontified t) 3949 3952 (face font-lock-keyword-face fontified t) 3952 3986 (fontified t) 3986 3992 (face font-lock-string-face fontified t) 3992 4060 (fontified t) 4060 4073 (face font-lock-string-face fontified t) 4073 4195 (fontified t) 4195 4199 (face font-lock-keyword-face fontified t) 4199 4246 (fontified t) 4246 4253 (face font-lock-string-face fontified t) 4253 4371 (fontified t) 4371 4387 (face font-lock-string-face fontified t) 4387 4421 (fontified t) 4421 4424 (face font-lock-comment-delimiter-face fontified t) 4424 4489 (face font-lock-comment-face fontified t) 4489 4504 (fontified t) 4504 4507 (face font-lock-comment-delimiter-face fontified t) 4507 4545 (face font-lock-comment-face fontified t) 4545 4612 (fontified t) 4612 4616 (face font-lock-keyword-face fontified t) 4616 4705 (fontified t) 4705 4708 (face font-lock-comment-delimiter-face fontified t) 4708 4736 (face font-lock-comment-face fontified t) 4736 4770 (fontified t) 4770 4772 (face font-lock-keyword-face fontified t) 4772 4860 (fontified t) 4860 4864 (face font-lock-string-face fontified t) 4864 4982 (fontified t) 4982 4985 (face font-lock-comment-delimiter-face fontified t) 4985 5036 (face font-lock-comment-face fontified t) 5036 5138 (fontified t) 5138 5141 (face font-lock-comment-delimiter-face fontified t) 5141 5181 (face font-lock-comment-face fontified t) 5181 5266 (fontified t) 5266 5269 (face font-lock-comment-delimiter-face fontified t) 5269 5338 (face font-lock-comment-face fontified t) 5338 5356 (fontified t) 5356 5359 (face font-lock-comment-delimiter-face fontified t) 5359 5404 (face font-lock-comment-face fontified t) 5404 5423 (fontified t) 5423 5429 (face font-lock-keyword-face fontified t) 5429 5442 (fontified t) 5442 5450 (face font-lock-string-face fontified t) 5450 5498 (fontified t) 5498 5505 (face font-lock-string-face fontified t) 5505 5553 (fontified t) 5553 5559 (face font-lock-string-face fontified t) 5559 5669 (fontified t) 5669 5677 (face font-lock-builtin-face fontified t) 5677 5725 (fontified t) 5725 5744 (fontified t) 5744 5749 (face font-lock-warning-face fontified t) 5749 5750 (fontified t) 5750 5781 (face font-lock-string-face fontified t) 5781 5790 (fontified t) 5790 5799 (fontified t) 5799 5803 (face font-lock-keyword-face fontified t) 5803 5826 (fontified t) 5826 5871 (fontified t) 5871 5872 (fontified t rear-nonsticky t)) . -3424) (undo-tree-id24 . -5872) (undo-tree-id25 . -371) (undo-tree-id26 . -372) (undo-tree-id27 . -390) (undo-tree-id28 . -5788) (undo-tree-id29 . -5872) (undo-tree-id30 . -390) (undo-tree-id31 . -390) (undo-tree-id32 . -137) (undo-tree-id33 . -5872) (undo-tree-id34 . -5872) (undo-tree-id35 . -5036) (undo-tree-id36 . -4636) (undo-tree-id37 . -390) (undo-tree-id38 . -5872) (undo-tree-id39 . -5036) (undo-tree-id40 . -5872) (undo-tree-id41 . -4788) (undo-tree-id42 . -4682) (undo-tree-id43 . -4636) (undo-tree-id44 . -5779) (undo-tree-id45 . -5826) (undo-tree-id46 . -5872) (undo-tree-id47 . -5872) 9296 (t 26948 7887 0 0)) nil (26948 7931 32481 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9294 . 9295) (nil fontified nil 3424 . 9295) (3424 . 9295)) nil (26948 7931 32465 0) 0 nil])
([nil nil ((9295 . 9296)) nil (26948 7931 32464 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9295) (undo-tree-id22 . -1) (undo-tree-id23 . -1) 9296) nil (26948 7931 32462 0) 0 nil])
([nil nil ((9295 . 9296)) nil (26948 7931 32449 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9295) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) 9296 (t 26948 7931 0 0)) nil (26948 7943 393632 0) 0 nil])
([nil nil ((9212 . 9213)) nil (26948 7943 393613 0) 0 nil])
([nil nil ((7828 . 7829) (t 26948 7943 0 0)) nil (26948 8001 833721 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9213) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) 9214) nil (26948 8001 833717 0) 0 nil])
([nil nil ((3423 . 3424) (t 26948 8001 0 0)) nil (26948 8314 860961 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9147 . 9148) (nil fontified nil 3424 . 9148) (3424 . 9148)) nil (26948 8314 860961 0) 0 nil])
([nil nil ((9148 . 9149)) nil (26948 8314 860960 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9148) (undo-tree-id109 . -1) 9149) nil (26948 8314 860959 0) 0 nil])
([nil nil ((9065 . 9066)) nil (26948 8314 860957 0) 0 nil])
([nil nil ((#("
(defun %build-where (filters fts-config)
  \"Construit la clause WHERE SQL.
   Accepte:
   - Forme standard: ((= :a 1) (search :q 'foo'))
   - Forme Alist (Query params): ((\\\"target_type\\\" . \\\"folder\\\") (\\\"q[is_active]\\\" . \\\"true\\\"))\"
  (labels ((%filter-form-p (f) (and (consp f) (symbolp (car f)))))
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; 1. Rien
               ((null f) \"\")

               ;; 2. Liste de CLAUSES standards => (AND ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (not (stringp (car f)))
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; 3. Liste d'ALIST (Query Params) => ((\"k\" . \"v\") ...)
               ((and (consp f)
                     (consp (car f))
                     (stringp (caar f)))
                (rec (cons 'and f)))

               ;; 4. Forme OP standard (SYMBOL ...)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\"
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove \"\" parts :test #'string=)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    (search
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))

               ;; 5. [CORRIGÉ] Forme ALIST seule (\"key\" . \"val\") -> (= :key \"val\")
               ;; Gère le nettoyage de \"q[col]\" -> :col
               ((and (consp f) (stringp (car f)))
                (let* ((raw-key (car f))
                       (len (length raw-key))
                       ;; Détection du pattern q[...]
                       (col-name (if (and (> len 3)
                                          (string= (subseq raw-key 0 2) \"q[\")
                                          (char= (char raw-key (1- len)) #\\]))
                                     ;; On extrait l'intérieur : q[is_active] -> is_active
                                     (subseq raw-key 2 (1- len))
                                     ;; Sinon on garde tel quel (ex: target_id)
                                     raw-key)))
                  
                  ;; On ignore les paramètres complexes non gérés (ex: order[...], limit)
                  ;; pour éviter de créer des colonnes invalides.
                  (unless (or (search \"order[\" raw-key)
                              (search \"limit\" raw-key)
                              (search \"page\" raw-key))
                    (rec (list '= 
                               (intern (string-upcase col-name) :keyword) 
                               (cdr f))))))

               (t (error \"Clause de filtre invalide: ~S\" f)))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 44 (fontified t) 44 234 (face font-lock-doc-face fontified t) 234 238 (fontified t) 238 244 (face font-lock-keyword-face fontified t) 244 307 (fontified t) 307 326 (face font-lock-keyword-face fontified t) 326 374 (fontified t) 374 380 (face font-lock-keyword-face fontified t) 380 415 (fontified t) 415 419 (face font-lock-keyword-face fontified t) 419 435 (fontified t) 435 438 (face font-lock-comment-delimiter-face fontified t) 438 446 (face font-lock-comment-face fontified t) 446 471 (fontified t) 471 473 (face font-lock-string-face fontified t) 473 491 (fontified t) 491 494 (face font-lock-comment-delimiter-face fontified t) 494 537 (face font-lock-comment-face fontified t) 537 760 (fontified t) 760 763 (face font-lock-comment-delimiter-face fontified t) 763 816 (face font-lock-comment-face fontified t) 816 978 (fontified t) 978 981 (face font-lock-comment-delimiter-face fontified t) 981 1015 (face font-lock-comment-face fontified t) 1015 1082 (fontified t) 1082 1085 (face font-lock-keyword-face fontified t) 1085 1120 (fontified t) 1120 1125 (face font-lock-keyword-face fontified t) 1125 1189 (fontified t) 1189 1207 (face font-lock-keyword-face fontified t) 1207 1254 (fontified t) 1254 1257 (face font-lock-keyword-face fontified t) 1257 1370 (fontified t) 1370 1375 (face font-lock-keyword-face fontified t) 1375 1418 (fontified t) 1418 1422 (fontified t) 1422 1431 (face font-lock-string-face fontified t) 1431 1441 (fontified t) 1441 1484 (fontified t) 1484 1493 (face font-lock-string-face fontified t) 1493 1501 (fontified t) 1501 1503 (fontified t) 1503 1546 (fontified t) 1546 1555 (face font-lock-string-face fontified t) 1555 1608 (fontified t) 1608 1618 (face font-lock-string-face fontified t) 1618 1671 (fontified t) 1671 1681 (face font-lock-string-face fontified t) 1681 1734 (fontified t) 1734 1744 (face font-lock-string-face fontified t) 1744 1804 (fontified t) 1804 1822 (face font-lock-keyword-face fontified t) 1822 1870 (fontified t) 1870 1873 (face font-lock-keyword-face fontified t) 1873 1928 (fontified t) 1928 1930 (face font-lock-keyword-face fontified t) 1930 1993 (fontified t) 1993 2000 (face font-lock-string-face fontified t) 2000 2031 (fontified t) 2031 2035 (face font-lock-keyword-face fontified t) 2035 2060 (fontified t) 2060 2066 (face font-lock-keyword-face fontified t) 2066 2213 (fontified t) 2213 2225 (face font-lock-string-face fontified t) 2225 2287 (fontified t) 2287 2291 (face font-lock-keyword-face fontified t) 2291 2364 (fontified t) 2364 2366 (face font-lock-string-face fontified t) 2366 2373 (fontified t) 2373 2378 (face font-lock-builtin-face fontified t) 2378 2416 (fontified t) 2416 2420 (face font-lock-keyword-face fontified t) 2420 2432 (fontified t) 2432 2434 (face font-lock-string-face fontified t) 2434 2540 (fontified t) 2540 2557 (face font-lock-string-face fontified t) 2557 2612 (fontified t) 2612 2616 (face font-lock-keyword-face fontified t) 2616 2689 (fontified t) 2689 2691 (face font-lock-string-face fontified t) 2691 2698 (fontified t) 2698 2703 (face font-lock-builtin-face fontified t) 2703 2741 (fontified t) 2741 2745 (face font-lock-keyword-face fontified t) 2745 2757 (fontified t) 2757 2759 (face font-lock-string-face fontified t) 2759 2865 (fontified t) 2865 2881 (face font-lock-string-face fontified t) 2881 2940 (fontified t) 2940 2941 (face font-lock-keyword-face fontified t) 2941 2958 (face font-lock-keyword-face fontified t) 2958 2960 (fontified t) 2960 2964 (face font-lock-type-face fontified t) 2964 2968 (fontified t) 2968 2994 (fontified t) 2994 2996 (face font-lock-keyword-face fontified t) 2996 3111 (fontified t) 3111 3113 (face font-lock-builtin-face fontified t) 3113 3151 (fontified t) 3151 3154 (face font-lock-keyword-face fontified t) 3154 3193 (fontified t) 3193 3197 (face font-lock-keyword-face fontified t) 3197 3259 (fontified t) 3259 3268 (face font-lock-builtin-face fontified t) 3268 3300 (fontified t) 3300 3304 (face font-lock-keyword-face fontified t) 3304 3333 (fontified t) 3333 3342 (face font-lock-builtin-face fontified t) 3342 3344 (fontified t) 3344 3352 (face font-lock-string-face fontified t) 3352 3427 (fontified t) 3427 3436 (face font-lock-builtin-face fontified t) 3436 3546 (fontified t) 3546 3607 (face font-lock-string-face fontified t) 3607 3801 (fontified t) 3801 3805 (face font-lock-keyword-face fontified t) 3805 3836 (fontified t) 3836 3843 (face font-lock-builtin-face fontified t) 3843 3893 (fontified t) 3893 3899 (face font-lock-keyword-face fontified t) 3899 3950 (fontified t) 3950 3953 (face font-lock-keyword-face fontified t) 3953 3987 (fontified t) 3987 3993 (face font-lock-string-face fontified t) 3993 4061 (fontified t) 4061 4074 (face font-lock-string-face fontified t) 4074 4196 (fontified t) 4196 4200 (face font-lock-keyword-face fontified t) 4200 4247 (fontified t) 4247 4254 (face font-lock-string-face fontified t) 4254 4325 (fontified t) 4325 4372 (fontified t) 4372 4388 (face font-lock-string-face fontified t) 4388 4407 (fontified t) 4407 4423 (fontified t) 4423 4426 (face font-lock-comment-delimiter-face fontified t) 4426 4468 (face font-lock-comment-face fontified t) 4468 4491 (face font-lock-comment-face fontified t) 4491 4506 (fontified t) 4506 4509 (face font-lock-comment-delimiter-face fontified t) 4509 4547 (face font-lock-comment-face fontified t) 4547 4614 (fontified t) 4614 4618 (face font-lock-keyword-face fontified t) 4618 4707 (fontified t) 4707 4710 (face font-lock-comment-delimiter-face fontified t) 4710 4738 (face font-lock-comment-face fontified t) 4738 4772 (fontified t) 4772 4774 (face font-lock-keyword-face fontified t) 4774 4862 (fontified t) 4862 4866 (face font-lock-string-face fontified t) 4866 4984 (fontified t) 4984 4987 (face font-lock-comment-delimiter-face fontified t) 4987 5038 (face font-lock-comment-face fontified t) 5038 5140 (fontified t) 5140 5143 (face font-lock-comment-delimiter-face fontified t) 5143 5183 (face font-lock-comment-face fontified t) 5183 5268 (fontified t) 5268 5271 (face font-lock-comment-delimiter-face fontified t) 5271 5340 (face font-lock-comment-face fontified t) 5340 5358 (fontified t) 5358 5361 (face font-lock-comment-delimiter-face fontified t) 5361 5406 (face font-lock-comment-face fontified t) 5406 5425 (fontified t) 5425 5431 (face font-lock-keyword-face fontified t) 5431 5444 (fontified t) 5444 5452 (face font-lock-string-face fontified t) 5452 5500 (fontified t) 5500 5507 (face font-lock-string-face fontified t) 5507 5555 (fontified t) 5555 5561 (face font-lock-string-face fontified t) 5561 5671 (fontified t) 5671 5679 (face font-lock-builtin-face fontified t) 5679 5727 (fontified t) 5727 5746 (fontified t) 5746 5751 (face font-lock-warning-face fontified t) 5751 5752 (fontified t) 5752 5783 (face font-lock-string-face fontified t) 5783 5791 (fontified t) 5791 5800 (fontified t) 5800 5804 (face font-lock-keyword-face fontified t) 5804 5827 (fontified t) 5827 5872 (fontified t) 5872 5873 (fontified t rear-nonsticky t)) . -9149) (undo-tree-id78 . -5873) (undo-tree-id79 . -5826) (undo-tree-id80 . -5790) (undo-tree-id81 . -474) (undo-tree-id82 . -1028) (undo-tree-id83 . -961) (undo-tree-id84 . -743) (undo-tree-id85 . -1) (undo-tree-id86 . -1030) (undo-tree-id87 . -1030) (undo-tree-id88 . -88) (undo-tree-id89 . -5790) (undo-tree-id90 . -5790) (undo-tree-id91 . -4100) (undo-tree-id92 . -4256) (undo-tree-id93 . -658) (undo-tree-id94 . -5873) (undo-tree-id95 . -4100) (undo-tree-id96 . -5790) (undo-tree-id97 . -4406) (undo-tree-id98 . -1) (undo-tree-id99 . -1441) (undo-tree-id100 . -1) (undo-tree-id101 . -2968) (undo-tree-id102 . -2388) (undo-tree-id103 . -3335) (undo-tree-id104 . -1) (undo-tree-id105 . -4491) (undo-tree-id106 . -4389) (undo-tree-id107 . -5314) (undo-tree-id108 . -5827) 15022) nil (26948 8314 860952 0) 0 nil])
([nil nil ((9149 . 9150) (t 26948 8314 0 0)) nil (26948 8346 123449 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9149) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) 9150) nil (26948 8346 123448 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9065) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) 9066) nil (26948 8346 123444 0) 0 nil])
([nil nil ((7913 . 7914)) nil (26948 8346 123424 0) 0 nil])
([nil nil ((9149 . 9151) (t 26948 8346 0 0)) nil (26950 37670 941238 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15903 . 15904) (nil fontified nil 9151 . 15904) (9151 . 15904)) nil (26950 37670 941233 0) 0 nil])
([nil nil ((15904 . 15905) (t 26950 37670 0 0)) nil (26950 37673 179896 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -15904) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) 15905) nil (26950 37673 179892 0) 0 nil])
([nil nil ((#("(let* ((real-col (subseq col-name 3)) ;; \"in_id\" -> \"id\"
                            (keyword  (intern (string-upcase real-col) :keyword))
                            (values   (split-csv raw-val))) ;; \"1,2\" -> (\"1\" \"2\")
                       ;; On appelle récursivement avec la structure (in :id (\"1\" \"2\"))
                       (rec (list 'in keyword values)))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 38 (fontified t) 38 41 (face font-lock-comment-delimiter-face fontified t) 41 57 (face font-lock-comment-face fontified t) 57 128 (fontified t) 128 136 (face font-lock-builtin-face fontified t) 136 199 (fontified t) 199 202 (face font-lock-comment-delimiter-face fontified t) 202 221 (face font-lock-comment-face fontified t) 221 244 (fontified t) 244 247 (face font-lock-comment-delimiter-face fontified t) 247 309 (face font-lock-comment-face fontified t) 309 364 (fontified t)) . -15122) (undo-tree-id142 . -364) (undo-tree-id143 . -363) (undo-tree-id144 . -363) (undo-tree-id145 . -363) (undo-tree-id146 . -363) (undo-tree-id147 . -364) (undo-tree-id148 . -364) (undo-tree-id149 . -364) (undo-tree-id150 . -364) (undo-tree-id151 . -309) (undo-tree-id152 . -364) (undo-tree-id153 . -364) 15486 (t 26950 37673 0 0)) nil (26950 38153 760352 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16094 . 16095) (nil fontified nil 15122 . 16095) (15122 . 16095)) nil (26950 38153 760345 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -16094) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) 16095) nil (26950 38153 760341 0) 0 nil])
([nil nil ((19759 . 19766) (t 26950 38153 0 0)) nil (26953 12224 194085 0) 0 nil])
([nil nil ((19766 . 19767)) nil (26953 12224 194084 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -19766) (undo-tree-id232 . -1) 19767) nil (26953 12224 194084 0) 0 nil])
([nil nil ((19766 . 19772)) nil (26953 12224 194082 0) 0 nil])
([nil nil ((19772 . 19773)) nil (26953 12224 194081 0) 0 nil])
([nil nil ((19773 . 19774)) nil (26953 12224 194081 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -19767) (undo-tree-id225 . -1) (#("r" 0 1 (fontified t)) . -19768) (undo-tree-id226 . -1) (#("i" 0 1 (fontified t)) . -19769) (undo-tree-id227 . -1) (#("n" 0 1 (fontified t)) . -19770) (undo-tree-id228 . -1) (#("t" 0 1 (fontified t)) . -19771) (undo-tree-id229 . -1) (#(" " 0 1 (fontified t)) . -19772) (undo-tree-id230 . -1) (#("'" 0 1 (fontified t)) . -19773) (undo-tree-id231 . -1) 19774) nil (26953 12224 194079 0) 0 nil])
([nil nil ((19767 . 19773)) nil (26953 12224 194072 0) 0 nil])
([nil nil ((19773 . 19774)) nil (26953 12224 194071 0) 0 nil])
([nil nil ((19774 . 19775)) nil (26953 12224 194070 0) 0 nil])
([nil nil ((19775 . 19776)) nil (26953 12224 194070 0) 0 nil])
([nil nil ((19776 . 19778)) nil (26953 12224 194069 0) 0 nil])
([nil nil ((19778 . 19781)) nil (26953 12224 194068 0) 0 nil])
([nil nil ((19781 . 19782)) nil (26953 12224 194068 0) 0 nil])
([nil nil ((19782 . 19785)) nil (26953 12224 194067 0) 0 nil])
([nil nil ((#("E" 0 1 (face font-lock-string-face fontified t)) . -19783) (undo-tree-id223 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -19784) (undo-tree-id224 . -1) 19785) nil (26953 12224 194066 0) 0 nil])
([nil nil ((19783 . 19789)) nil (26953 12224 194062 0) 0 nil])
([nil nil ((19789 . 19790)) nil (26953 12224 194061 0) 0 nil])
([nil nil ((19790 . 19791)) nil (26953 12224 194061 0) 0 nil])
([nil nil ((19791 . 19792)) nil (26953 12224 194060 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -19789) (undo-tree-id220 . -1) (#("|" 0 1 (face font-lock-string-face fontified t)) . -19790) (undo-tree-id221 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -19791) (undo-tree-id222 . -1) 19792) nil (26953 12224 194058 0) 0 nil])
([nil nil ((19779 . 19782)) nil (26953 12224 194055 0) 0 nil])
([nil nil ((19782 . 19783)) nil (26953 12224 194054 0) 0 nil])
([nil nil ((19793 . 19794)) nil (26953 12224 194054 0) 0 nil])
([nil nil ((19794 . 19795)) nil (26953 12224 194053 0) 0 nil])
([nil nil ((19795 . 19796)) nil (26953 12224 194052 0) 0 nil])
([nil nil ((19796 . 19800)) nil (26953 12224 194051 0) 0 nil])
([nil nil ((19800 . 19801)) nil (26953 12224 194050 0) 0 nil])
([nil nil ((19801 . 19806)) nil (26953 12224 194049 0) 0 nil])
([nil nil ((#("%" 0 1 (face font-lock-string-face fontified t)) . -19805) (undo-tree-id219 . -1) 19806) nil (26953 12224 194048 0) 0 nil])
([nil nil ((19805 . 19807)) nil (26953 12224 194046 0) 0 nil])
([nil nil ((19805 . 19810)) nil (26953 12224 194045 0) 0 nil])
([nil nil ((#("Q" 0 1 (face font-lock-string-face fontified t)) . -19805) (undo-tree-id214 . -1) (#("U" 0 1 (face font-lock-string-face fontified t)) . -19806) (undo-tree-id215 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -19807) (undo-tree-id216 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -19808) (undo-tree-id217 . -1) (#("Y" 0 1 (face font-lock-string-face fontified t)) . -19809) (undo-tree-id218 . -1) 19810) nil (26953 12224 194043 0) 0 nil])
([nil nil ((19805 . 19811)) nil (26953 12224 194037 0) 0 nil])
([nil nil ((19805 . 19811)) nil (26953 12224 194036 0) 0 nil])
([nil nil ((19817 . 19818)) nil (26953 12224 194036 0) 0 nil])
([nil nil ((19818 . 19819)) nil (26953 12224 194035 0) 0 nil])
([nil nil ((19819 . 19822)) nil (26953 12224 194034 0) 0 nil])
([nil nil ((19823 . 19834)) nil (26953 12224 194029 0) 0 nil])
([nil nil ((19835 . 19836)) nil (26953 12224 194028 0) 0 nil])
([nil nil ((19836 . 19837)) nil (26953 12224 194027 0) 0 nil])
([nil nil ((19837 . 19839)) nil (26953 12224 194026 0) 0 nil])
([nil nil ((19839 . 19840)) nil (26953 12224 194025 0) 0 nil])
([nil nil ((19840 . 19841)) nil (26953 12224 194024 0) 0 nil])
([nil nil ((19841 . 19847)) nil (26953 12224 194023 0) 0 nil])
([nil nil ((19841 . 19850) (#("where-" 0 6 (fontified t)) . -19841) (undo-tree-id203 . -6) (undo-tree-id204 . -3) (undo-tree-id205 . -3) (undo-tree-id206 . -5) (undo-tree-id207 . -5) (undo-tree-id208 . -6) (undo-tree-id209 . -6) (undo-tree-id210 . -6) (undo-tree-id211 . -6) (undo-tree-id212 . -6) (undo-tree-id213 . -6) 19847) nil (26953 12224 194020 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -19847) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (#("q" 0 1 (fontified t)) . -19848) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (#("l" 0 1 (fontified t)) . -19849) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) 19850) nil (26953 12224 194006 0) 0 nil])
([nil nil ((19847 . 19849)) nil (26953 12224 193983 0) 0 nil])
([nil nil ((19841 . 19853) (#("where-pa" 0 8 (fontified t)) . -19841) (undo-tree-id165 . -8) (undo-tree-id166 . -6) (undo-tree-id167 . -6) (undo-tree-id168 . -6) (undo-tree-id169 . -6) (undo-tree-id170 . -6) (undo-tree-id171 . -6) (undo-tree-id172 . -6) (undo-tree-id173 . -6) (undo-tree-id174 . -6) (undo-tree-id175 . -6) (undo-tree-id176 . -6) (undo-tree-id177 . -6) (undo-tree-id178 . -6) (undo-tree-id179 . -6) (undo-tree-id180 . -6) (undo-tree-id181 . -6) (undo-tree-id182 . -7) (undo-tree-id183 . -7) (undo-tree-id184 . -8) (undo-tree-id185 . -8) 19849) nil (26953 12224 193979 0) 0 nil])
([nil nil ((19853 . 19854)) nil (26953 12224 193942 0) 0 nil])
([nil nil ((19837 . 19844) (#(" " 0 1 (fontified nil)) . 19836) (undo-tree-id154 . -1) (undo-tree-id155 . -1) (undo-tree-id156 . -1) (undo-tree-id157 . -1) (undo-tree-id158 . -1) (undo-tree-id159 . -1) (undo-tree-id160 . -1) (undo-tree-id161 . -1) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (undo-tree-id164 . -1) (19837 . 19838)) nil (26953 12224 193936 0) 0 nil])
([nil nil ((35099 . 35101) (t 26953 12224 0 0)) nil (26979 32684 663142 0) 0 nil])
([nil nil ((nil fontified nil 37903 . 37904) (nil fontified nil 37854 . 37903) (nil fontified nil 37824 . 37854) (nil fontified nil 37724 . 37824) (nil fontified nil 37720 . 37724) (nil fontified nil 37716 . 37720) (nil fontified nil 37636 . 37716) (nil fontified nil 37606 . 37636) (nil fontified nil 37597 . 37606) (nil fontified nil 37596 . 37597) (nil fontified nil 37591 . 37596) (nil fontified nil 37555 . 37591) (nil fontified nil 37542 . 37555) (nil fontified nil 37533 . 37542) (nil fontified nil 37512 . 37533) (nil fontified nil 37404 . 37512) (nil fontified nil 37400 . 37404) (nil fontified nil 37396 . 37400) (nil fontified nil 37315 . 37396) (nil fontified nil 37294 . 37315) (nil fontified nil 37282 . 37294) (nil fontified nil 37281 . 37282) (nil fontified nil 37276 . 37281) (nil fontified nil 37275 . 37276) (nil fontified nil 37274 . 37275) (nil fontified nil 37248 . 37274) (nil fontified nil 37245 . 37248) (nil fontified nil 37222 . 37245) (nil fontified nil 37220 . 37222) (nil fontified nil 37187 . 37220) (nil fontified nil 37185 . 37187) (nil fontified nil 37180 . 37185) (nil fontified nil 37136 . 37180) (nil fontified nil 37133 . 37136) (nil fontified nil 37060 . 37133) (nil fontified nil 37021 . 37060) (nil fontified nil 36957 . 37021) (nil fontified nil 36953 . 36957) (nil fontified nil 36949 . 36953) (nil fontified nil 36928 . 36949) (nil fontified nil 36910 . 36928) (nil fontified nil 36904 . 36910) (nil fontified nil 36896 . 36904) (nil fontified nil 36892 . 36896) (nil fontified nil 36877 . 36892) (nil fontified nil 36868 . 36877) (nil fontified nil 36867 . 36868) (nil fontified nil 36862 . 36867) (nil fontified nil 36786 . 36862) (nil fontified nil 36780 . 36786) (nil fontified nil 36767 . 36780) (nil fontified nil 36715 . 36767) (nil fontified nil 36707 . 36715) (nil fontified nil 36704 . 36707) (nil fontified nil 36700 . 36704) (nil fontified nil 36686 . 36700) (nil fontified nil 36685 . 36686) (nil fontified nil 36657 . 36685) (nil fontified nil 36656 . 36657) (nil fontified nil 36647 . 36656) (nil fontified nil 36602 . 36647) (nil fontified nil 36586 . 36602) (nil fontified nil 36528 . 36586) (nil fontified nil 36464 . 36528) (nil fontified nil 36460 . 36464) (nil fontified nil 36456 . 36460) (nil fontified nil 36315 . 36456) (nil fontified nil 36310 . 36315) (nil fontified nil 36293 . 36310) (nil fontified nil 36245 . 36293) (nil fontified nil 36239 . 36245) (nil fontified nil 36231 . 36239) (nil fontified nil 36227 . 36231) (nil fontified nil 36212 . 36227) (nil fontified nil 36204 . 36212) (nil fontified nil 36203 . 36204) (nil fontified nil 36198 . 36203) (nil fontified nil 36197 . 36198) (nil fontified nil 36136 . 36197) (nil fontified nil 36132 . 36136) (nil fontified nil 36033 . 36132) (nil fontified nil 36031 . 36033) (nil fontified nil 36026 . 36031) (nil fontified nil 35990 . 36026) (nil fontified nil 35890 . 35990) (nil fontified nil 35886 . 35890) (nil fontified nil 35882 . 35886) (nil fontified nil 35775 . 35882) (nil fontified nil 35770 . 35775) (nil fontified nil 35767 . 35770) (nil fontified nil 35760 . 35767) (nil fontified nil 35756 . 35760) (nil fontified nil 35729 . 35756) (nil fontified nil 35722 . 35729) (nil fontified nil 35721 . 35722) (nil fontified nil 35716 . 35721) (nil fontified nil 35715 . 35716) (nil fontified nil 35659 . 35715) (nil fontified nil 35624 . 35659) (nil fontified nil 35621 . 35624) (nil fontified nil 35610 . 35621) (nil fontified nil 35606 . 35610) (nil fontified nil 35509 . 35606) (nil fontified nil 35468 . 35509) (nil fontified nil 35360 . 35468) (nil fontified nil 35356 . 35360) (nil fontified nil 35352 . 35356) (nil fontified nil 35267 . 35352) (nil fontified nil 35262 . 35267) (nil fontified nil 35259 . 35262) (nil fontified nil 35252 . 35259) (nil fontified nil 35248 . 35252) (nil fontified nil 35230 . 35248) (nil fontified nil 35222 . 35230) (nil fontified nil 35221 . 35222) (nil fontified nil 35216 . 35221) (nil fontified nil 35215 . 35216) (nil fontified nil 35214 . 35215) (nil fontified nil 35189 . 35214) (nil fontified nil 35186 . 35189) (nil fontified nil 35185 . 35186) (nil fontified nil 35184 . 35185) (nil fontified nil 35183 . 35184) (nil fontified nil 35181 . 35183) (nil fontified nil 35180 . 35181) (nil fontified nil 35178 . 35180) (nil fontified nil 35177 . 35178) (nil fontified nil 35175 . 35177) (nil fontified nil 35174 . 35175) (nil fontified nil 35172 . 35174) (nil fontified nil 35171 . 35172) (nil fontified nil 35169 . 35171) (nil fontified nil 35168 . 35169) (nil fontified nil 35166 . 35168) (nil fontified nil 35165 . 35166) (nil fontified nil 35163 . 35165) (nil fontified nil 35162 . 35163) (nil fontified nil 35160 . 35162) (nil fontified nil 35157 . 35160) (nil fontified nil 35156 . 35157) (nil fontified nil 35155 . 35156) (nil fontified nil 35132 . 35155) (nil fontified nil 35129 . 35132) (nil fontified nil 35128 . 35129) (nil fontified nil 35127 . 35128) (nil fontified nil 35125 . 35127) (nil fontified nil 35124 . 35125) (nil fontified nil 35122 . 35124) (nil fontified nil 35121 . 35122) (nil fontified nil 35119 . 35121) (nil fontified nil 35118 . 35119) (nil fontified nil 35116 . 35118) (nil fontified nil 35115 . 35116) (nil fontified nil 35113 . 35115) (nil fontified nil 35112 . 35113) (nil fontified nil 35110 . 35112) (nil fontified nil 35109 . 35110) (nil fontified nil 35107 . 35109) (nil fontified nil 35106 . 35107) (nil fontified nil 35104 . 35106) (nil fontified nil 35101 . 35104) (35101 . 37904)) nil (26979 32684 663138 0) 0 nil])
([nil nil ((1649 . 1650)) nil (26979 32684 663127 0) 0 nil])
([nil nil ((nil fontified nil 2027 . 2028) (nil fontified nil 1985 . 2027) (nil fontified nil 1955 . 1985) (nil fontified nil 1940 . 1955) (nil fontified nil 1930 . 1940) (nil fontified nil 1929 . 1930) (nil fontified nil 1924 . 1929) (nil fontified nil 1859 . 1924) (nil fontified nil 1808 . 1859) (nil fontified nil 1793 . 1808) (nil fontified nil 1782 . 1793) (nil fontified nil 1781 . 1782) (nil fontified nil 1776 . 1781) (nil fontified nil 1731 . 1776) (nil fontified nil 1674 . 1731) (nil fontified nil 1667 . 1674) (nil fontified nil 1657 . 1667) (nil fontified nil 1656 . 1657) (nil fontified nil 1651 . 1656) (nil fontified nil 1650 . 1651) (1650 . 2028)) nil (26979 32684 663126 0) 0 nil])
([nil nil ((2028 . 2029)) nil (26979 32684 663124 0) 0 nil])
([nil nil ((113 . 116)) nil (26979 32684 663124 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 337 . 338) (nil fontified nil 337 . 338) (nil fontified nil 318 . 337) (nil fontified nil 317 . 318) (nil fontified nil 300 . 317) (nil fontified nil 299 . 300) (nil fontified nil 284 . 299) (nil fontified nil 283 . 284) (nil fontified nil 268 . 283) (nil fontified nil 267 . 268) (nil fontified nil 252 . 267) (nil fontified nil 248 . 252) (nil fontified nil 247 . 248) (nil fontified nil 246 . 247) (nil fontified nil 228 . 246) (nil fontified nil 227 . 228) (nil fontified nil 214 . 227) (nil fontified nil 213 . 214) (nil fontified nil 195 . 213) (nil fontified nil 194 . 195) (nil fontified nil 182 . 194) (nil fontified nil 181 . 182) (nil fontified nil 167 . 181) (nil fontified nil 166 . 167) (nil fontified nil 150 . 166) (nil fontified nil 146 . 150) (nil fontified nil 145 . 146) (nil fontified nil 130 . 145) (nil fontified nil 129 . 130) (nil fontified nil 117 . 129) (nil fontified nil 116 . 117) (116 . 338)) nil (26979 32684 803458 0) 0 nil])
([nil nil ((66 . 69)) nil (26979 32709 819095 0) 0 nil] [nil nil ((#(":entity-update!" 0 15 (face font-lock-builtin-face fontified t)) . -268) (undo-tree-id2 . -15) 283) ((268 . 283)) (26979 32684 663183 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 153 . 154) (nil fontified nil 153 . 154) (nil fontified nil 145 . 153) (nil fontified nil 144 . 145) (nil fontified nil 143 . 144) (nil fontified nil 131 . 143) (nil fontified nil 130 . 131) (nil fontified nil 129 . 130) (nil fontified nil 119 . 129) (nil fontified nil 118 . 119) (nil fontified nil 107 . 118) (nil fontified nil 106 . 107) (nil fontified nil 96 . 106) (nil fontified nil 95 . 96) (nil fontified nil 83 . 95) (nil fontified nil 82 . 83) (nil fontified nil 70 . 82) (nil fontified nil 69 . 70) (69 . 154)) nil (26979 32709 819093 0) 0 nil])
([nil nil ((#(":entity-insert!" 0 15 (face font-lock-builtin-face fontified t)) . -252) (undo-tree-id0 . -15) (undo-tree-id1 . -6) 267) ((252 . 267)) (26979 32684 663115 0) 0 nil])
([nil nil ((38597 . 38598) 154) nil (26979 32709 819088 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 193 . 194) (nil fontified nil 186 . 194) (186 . 194) (t 26979 32709 0 0)) nil (26979 32807 532528 0) 0 nil])
([nil nil ((194 . 195)) nil (26979 32807 532527 0) 0 nil])
([nil nil ((193 . 194)) nil (26979 32807 673682 0) 0 nil])
([nil nil ((714 . 718)) nil (26979 32818 870444 0) 0 nil] [nil nil ((714 . 718)) ((#("
   " 0 1 (fontified t) 1 4 (fontified t)) . 714) (undo-tree-id6 . -4) (undo-tree-id7 . -4) (undo-tree-id8 . -4) (undo-tree-id9 . -4) (undo-tree-id10 . -1) (undo-tree-id11 . -1)) (26979 32807 532595 0) 0 nil])
([nil nil ((nil fontified nil 781 . 782) (nil fontified nil 772 . 781) (nil fontified nil 771 . 772) (nil fontified nil 758 . 771) (nil fontified nil 757 . 758) (nil fontified nil 747 . 757) (nil fontified nil 746 . 747) (nil fontified nil 737 . 746) (nil fontified nil 736 . 737) (nil fontified nil 728 . 736) (nil fontified nil 727 . 728) (nil fontified nil 718 . 727) (718 . 782)) nil (26979 32818 870440 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 801 . 802) (nil fontified nil 718 . 802) (718 . 802)) ((#(":find-one
    :find-by
    :find-all
    :count-all
    :delete-by-id
    :delete-by" 0 9 (face font-lock-builtin-face fontified nil) 9 14 (fontified nil) 14 22 (face font-lock-builtin-face fontified nil) 22 27 (fontified nil) 27 36 (face font-lock-builtin-face fontified nil) 36 41 (fontified nil) 41 51 (face font-lock-builtin-face fontified nil) 51 56 (fontified nil) 56 69 (face font-lock-builtin-face fontified nil) 69 70 (fontified nil) 70 74 (fontified nil) 74 83 (face font-lock-builtin-face fontified nil) 83 84 (face font-lock-builtin-face rear-nonsticky nil fontified nil)) . 718) (undo-tree-id3 . -9) (undo-tree-id4 . -9) (undo-tree-id5 . -9) (nil fontified t 787 . 788) (nil fontified t 774 . 787) (nil fontified t 769 . 774) (nil fontified t 759 . 769) (nil fontified t 754 . 759) (nil fontified t 745 . 754) (nil fontified t 740 . 745) (nil fontified t 732 . 740) (nil fontified t 727 . 732) (nil fontified t 718 . 727) (nil rear-nonsticky t 801 . 802)) (26979 32807 532521 0) 0 nil])
([nil nil ((#("(defun %build-where (filters fts-config)
  \"Construit la clause WHERE SQL. Version corrigée pour ignorer proprement les params système.\"
  (labels ((%filter-form-p (f) (and (consp f) (symbolp (car f)))))
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; 1. Rien
               ((null f) \"\")

               ;; 2. Liste de CLAUSES standards => (AND ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (not (stringp (car f)))
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; 3. Liste d'ALIST (Query Params) => ((\"k\" . \"v\") ...)
               ((and (consp f)
                     (consp (car f))
                     (stringp (caar f)))
                (rec (cons 'and f)))

               ;; 4. Forme OP standard (SYMBOL ...)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\"
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    
                    ;; CORRECTION SUR AND / OR : On filtre les NIL et les chaînes vides
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove-if (lambda (x) (or (null x) (string= x \"\"))) parts)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove-if (lambda (x) (or (null x) (string= x \"\"))) parts)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    
                    (search
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))

               ;; 5. [CORRIGÉ] Forme ALIST seule (\"key\" . \"val\") -> (= :key \"val\")
               ((and (consp f) (stringp (car f)))
                (let* ((raw-key (car f))
                       (len (length raw-key))
                       (col-name (if (and (> len 3)
                                          (string= (subseq raw-key 0 2) \"q[\")
                                          (char= (char raw-key (1- len)) #\\]))
                                     (subseq raw-key 2 (1- len))
                                     raw-key)))
                  
                  ;; Si c'est un paramètre système (order[...], page, limit...)
                  (if (or (search \"order[\" raw-key)
                          (search \"limit\" raw-key)
                          (search \"page\" raw-key)
                          (search \"page_size\" raw-key))
                      \"\" ;; <--- IMPORTANT : Retourner chaîne vide, pas NIL
                      (rec (list '= 
                                 (intern (string-upcase col-name) :keyword) 
                                 (cdr f))))))

               (t (error \"Clause de filtre invalide: ~S\" f)))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 19 (face font-lock-function-name-face fontified t) 19 43 (fontified t) 43 136 (face font-lock-doc-face fontified t) 136 140 (fontified t) 140 146 (face font-lock-keyword-face fontified t) 146 209 (fontified t) 209 228 (face font-lock-keyword-face fontified t) 228 276 (fontified t) 276 282 (face font-lock-keyword-face fontified t) 282 317 (fontified t) 317 321 (face font-lock-keyword-face fontified t) 321 337 (fontified t) 337 340 (face font-lock-comment-delimiter-face fontified t) 340 348 (face font-lock-comment-face fontified t) 348 373 (fontified t) 373 375 (face font-lock-string-face fontified t) 375 393 (fontified t) 393 396 (face font-lock-comment-delimiter-face fontified t) 396 439 (face font-lock-comment-face fontified t) 439 662 (fontified t) 662 665 (face font-lock-comment-delimiter-face fontified t) 665 718 (face font-lock-comment-face fontified t) 718 880 (fontified t) 880 883 (face font-lock-comment-delimiter-face fontified t) 883 917 (face font-lock-comment-face fontified t) 917 938 (fontified t) 938 967 (fontified t) 967 984 (fontified t) 984 987 (face font-lock-keyword-face fontified t) 987 1022 (fontified t) 1022 1027 (face font-lock-keyword-face fontified t) 1027 1091 (fontified t) 1091 1109 (face font-lock-keyword-face fontified t) 1109 1156 (fontified t) 1156 1159 (face font-lock-keyword-face fontified t) 1159 1272 (fontified t) 1272 1277 (face font-lock-keyword-face fontified t) 1277 1324 (fontified t) 1324 1333 (face font-lock-string-face fontified t) 1333 1386 (fontified t) 1386 1395 (face font-lock-string-face fontified t) 1395 1448 (fontified t) 1448 1457 (face font-lock-string-face fontified t) 1457 1510 (fontified t) 1510 1520 (face font-lock-string-face fontified t) 1520 1573 (fontified t) 1573 1583 (face font-lock-string-face fontified t) 1583 1636 (fontified t) 1636 1646 (face font-lock-string-face fontified t) 1646 1706 (fontified t) 1706 1724 (face font-lock-keyword-face fontified t) 1724 1772 (fontified t) 1772 1775 (face font-lock-keyword-face fontified t) 1775 1830 (fontified t) 1830 1832 (face font-lock-keyword-face fontified t) 1832 1895 (fontified t) 1895 1902 (face font-lock-string-face fontified t) 1902 1933 (fontified t) 1933 1937 (face font-lock-keyword-face fontified t) 1937 1962 (fontified t) 1962 1968 (face font-lock-keyword-face fontified t) 1968 2115 (fontified t) 2115 2127 (face font-lock-string-face fontified t) 2127 2183 (fontified t) 2183 2186 (face font-lock-comment-delimiter-face fontified t) 2186 2251 (face font-lock-comment-face fontified t) 2251 2298 (fontified t) 2298 2302 (face font-lock-keyword-face fontified t) 2302 2379 (fontified t) 2379 2385 (face font-lock-keyword-face fontified t) 2385 2414 (fontified t) 2414 2416 (face font-lock-string-face fontified t) 2416 2453 (fontified t) 2453 2457 (face font-lock-keyword-face fontified t) 2457 2467 (fontified t) 2467 2469 (fontified t) 2469 2471 (face font-lock-string-face fontified t) 2471 2473 (fontified t) 2473 2577 (fontified t) 2577 2594 (face font-lock-string-face fontified t) 2594 2649 (fontified t) 2649 2653 (face font-lock-keyword-face fontified t) 2653 2730 (fontified t) 2730 2736 (face font-lock-keyword-face fontified t) 2736 2765 (fontified t) 2765 2767 (face font-lock-string-face fontified t) 2767 2804 (fontified t) 2804 2808 (face font-lock-keyword-face fontified t) 2808 2820 (fontified t) 2820 2822 (face font-lock-string-face fontified t) 2822 2928 (fontified t) 2928 2944 (face font-lock-string-face fontified t) 2944 3024 (fontified t) 3024 3042 (face font-lock-keyword-face fontified t) 3042 3044 (fontified t) 3044 3048 (face font-lock-type-face fontified t) 3048 3078 (fontified t) 3078 3080 (face font-lock-keyword-face fontified t) 3080 3195 (fontified t) 3195 3197 (face font-lock-builtin-face fontified t) 3197 3235 (fontified t) 3235 3238 (face font-lock-keyword-face fontified t) 3238 3277 (fontified t) 3277 3281 (face font-lock-keyword-face fontified t) 3281 3343 (fontified t) 3343 3352 (face font-lock-builtin-face fontified t) 3352 3384 (fontified t) 3384 3388 (face font-lock-keyword-face fontified t) 3388 3417 (fontified t) 3417 3426 (face font-lock-builtin-face fontified t) 3426 3428 (fontified t) 3428 3436 (face font-lock-string-face fontified t) 3436 3511 (fontified t) 3511 3520 (face font-lock-builtin-face fontified t) 3520 3630 (fontified t) 3630 3691 (face font-lock-string-face fontified t) 3691 3885 (fontified t) 3885 3889 (face font-lock-keyword-face fontified t) 3889 3920 (fontified t) 3920 3927 (face font-lock-builtin-face fontified t) 3927 3973 (fontified t) 3973 3977 (fontified t) 3977 3983 (face font-lock-keyword-face fontified t) 3983 3990 (fontified t) 3990 4034 (fontified t) 4034 4037 (face font-lock-keyword-face fontified t) 4037 4071 (fontified t) 4071 4077 (face font-lock-string-face fontified t) 4077 4145 (fontified t) 4145 4158 (face font-lock-string-face fontified t) 4158 4280 (fontified t) 4280 4284 (face font-lock-keyword-face fontified t) 4284 4331 (fontified t) 4331 4338 (face font-lock-string-face fontified t) 4338 4456 (fontified t) 4456 4472 (face font-lock-string-face fontified t) 4472 4507 (fontified t) 4507 4510 (face font-lock-comment-delimiter-face fontified t) 4510 4575 (face font-lock-comment-face fontified t) 4575 4642 (fontified t) 4642 4646 (face font-lock-keyword-face fontified t) 4646 4746 (fontified t) 4746 4748 (face font-lock-keyword-face fontified t) 4748 4836 (fontified t) 4836 4840 (face font-lock-string-face fontified t) 4840 5071 (fontified t) 5071 5074 (face font-lock-comment-delimiter-face fontified t) 5074 5133 (face font-lock-comment-face fontified t) 5133 5152 (fontified t) 5152 5154 (face font-lock-keyword-face fontified t) 5154 5167 (fontified t) 5167 5175 (face font-lock-string-face fontified t) 5175 5219 (fontified t) 5219 5226 (face font-lock-string-face fontified t) 5226 5270 (fontified t) 5270 5276 (face font-lock-string-face fontified t) 5276 5320 (fontified t) 5320 5331 (face font-lock-string-face fontified t) 5331 5364 (fontified t) 5364 5366 (face font-lock-string-face fontified t) 5366 5367 (fontified t) 5367 5370 (face font-lock-comment-delimiter-face fontified t) 5370 5418 (face font-lock-comment-face fontified t) 5418 5490 (fontified t) 5490 5521 (fontified t) 5521 5529 (face font-lock-builtin-face fontified t) 5529 5532 (fontified t) 5532 5598 (fontified t) 5598 5603 (face font-lock-warning-face fontified t) 5603 5604 (fontified t) 5604 5635 (face font-lock-string-face fontified t) 5635 5652 (fontified t) 5652 5656 (face font-lock-keyword-face fontified t) 5656 5726 (fontified t)) . 4195) (undo-tree-id0 . -5726) (t 26979 32818 0 0)) nil (26984 5862 629741 0) 0 nil])
nil
([nil nil ((#("
" 0 1 (fontified t)) . 4195)) nil (26984 5862 629726 0) 0 nil])
([nil nil ((11556 . 11558)) nil (26984 5862 629725 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20368 . 20369) (nil fontified nil 11558 . 20369) (11558 . 20369)) nil (26984 5862 629722 0) 0 nil])
([nil nil ((#("
(defun %build-where (filters fts-config)
  \"Construit la clause WHERE SQL. Supporte q[col][op]=val.\"
  
  (labels ((split-csv (str)
             (loop for start = 0 then (1+ end)
                   for end = (position #\\, str :start start)
                   collect (subseq str start end)
                   while end))
           
           (%filter-form-p (f) (and (consp f) (symbolp (car f))))

           ;; [NOUVEAU] Convertit l'opérateur string en symbole Lisp
           (parse-operator (op-str)
             (cond
               ((string= op-str \">\") '>)
               ((string= op-str \"<\") '<)
               ((string= op-str \">=\") '>=)
               ((string= op-str \"<=\") '<=)
               ((or (string= op-str \"!=\") (string= op-str \"<>\")) '!=)
               ((string-equal op-str \"like\") 'like)
               ((string-equal op-str \"ilike\") 'ilike)
               (t '=)))) ;; Défaut

    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; 1. Rien
               ((null f) \"\")

               ;; 2. Liste de CLAUSES standards => (AND ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (not (stringp (car f)))
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; 3. Liste d'ALIST (Query Params)
               ((and (consp f)
                     (consp (car f))
                     (stringp (caar f)))
                (rec (cons 'and f)))

               ;; 4. Forme OP standard (SYMBOL ...)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    
                    ;; [NOUVEAU] Ajout du support LIKE / ILIKE pour les filtres avancés
                    ((like ilike)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value))
                             (sql-op (if (eq op 'like) \"LIKE\" \"ILIKE\")))
                         (format nil \"~a ~a ~a\" lhs sql-op ph))))

                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\"
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    
                    ;; Logique AND / OR
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove-if (lambda (x) (or (null x) (string= x \"\"))) parts)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove-if (lambda (x) (or (null x) (string= x \"\"))) parts)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    
                    ;; Full Text Search
                    (search
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))

               ;; 5. Forme ALIST seule (\"key\" . \"val\") -> Transformation intelligente
               ((and (consp f) (stringp (car f)))
                (let* ((raw-key (car f))
                       (raw-val (cdr f)))
                  
                  (cond
                    ;; A. Ignorer les paramètres système
                    ((or (search \"order[\" raw-key)
                         (search \"limit\" raw-key)
                         (search \"page\" raw-key)
                         (search \"page_size\" raw-key))
                     \"\")
                    
                    ;; B. Gestion de \"in_column\"
                    ((and (> (length raw-key) 3)
                          (string= (subseq raw-key 0 3) \"in_\"))
                     (let* ((real-col (subseq raw-key 3))
                            (keyword  (intern (string-upcase real-col) :keyword))
                            (all-vals (split-csv raw-val))
                            (clean-vals (remove-if (lambda (x)
                                                     (or (string= x \"\")
                                                         (string-equal x \"null\")
                                                         (string-equal x \"nil\")))
                                                   all-vals)))
                       (if clean-vals
                           (rec (list 'in keyword clean-vals))
                           \"false\")))

                    ;; C. [CORRECTION] Gestion générique q[col][op] et q[col]
                    (t
                     (let ((col-name nil)
                           (operator '=))
                       
                       ;; Logique de parsing des crochets
                       (cond
                         ;; Pattern: q[col][op]
                         ((and (> (length raw-key) 2)
                               (string= (subseq raw-key 0 2) \"q[\"))
                          (let* ((end-col (position #\\] raw-key))
                                 (start-op (when end-col (position #\\[ raw-key :start end-col)))
                                 (end-op   (when start-op (position #\\] raw-key :start start-op))))
                            
                            (if (and end-col start-op end-op)
                                ;; On a trouvé [col] et [op]
                                (setf col-name (subseq raw-key 2 end-col)
                                      operator (parse-operator (subseq raw-key (1+ start-op) end-op)))
                                ;; On a juste trouvé [col], op est défaut (=)
                                (setf col-name (subseq raw-key 2 (1- (length raw-key)))))))
                         
                         ;; Pattern: col_name (sans q[])
                         (t
                          (setf col-name raw-key)))

                       ;; Génération récursive
                       (rec (list operator 
                                  (intern (string-upcase col-name) :keyword) 
                                  raw-val)))))))

               (t (error \"Clause de filtre invalide: ~S\" f)))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 44 (fontified t) 44 101 (face font-lock-doc-face fontified t) 101 108 (fontified t) 108 114 (face font-lock-keyword-face fontified t) 114 147 (fontified t) 147 151 (face font-lock-keyword-face fontified t) 151 227 (fontified t) 227 233 (face font-lock-builtin-face fontified t) 233 412 (fontified t) 412 415 (face font-lock-comment-delimiter-face fontified t) 415 470 (face font-lock-comment-face fontified t) 470 520 (fontified t) 520 524 (face font-lock-keyword-face fontified t) 524 557 (fontified t) 557 560 (face font-lock-string-face fontified t) 560 598 (fontified t) 598 601 (face font-lock-string-face fontified t) 601 639 (fontified t) 639 643 (face font-lock-string-face fontified t) 643 682 (fontified t) 682 686 (face font-lock-string-face fontified t) 686 729 (fontified t) 729 733 (face font-lock-string-face fontified t) 733 751 (fontified t) 751 755 (face font-lock-string-face fontified t) 755 800 (fontified t) 800 806 (face font-lock-string-face fontified t) 806 852 (fontified t) 852 859 (face font-lock-string-face fontified t) 859 894 (fontified t) 894 897 (face font-lock-comment-delimiter-face fontified t) 897 904 (face font-lock-comment-face fontified t) 904 910 (fontified t) 910 929 (face font-lock-keyword-face fontified t) 929 977 (fontified t) 977 983 (face font-lock-keyword-face fontified t) 983 1018 (fontified t) 1018 1022 (face font-lock-keyword-face fontified t) 1022 1038 (fontified t) 1038 1041 (face font-lock-comment-delimiter-face fontified t) 1041 1049 (face font-lock-comment-face fontified t) 1049 1074 (fontified t) 1074 1076 (face font-lock-string-face fontified t) 1076 1094 (fontified t) 1094 1097 (face font-lock-comment-delimiter-face fontified t) 1097 1140 (face font-lock-comment-face fontified t) 1140 1363 (fontified t) 1363 1366 (face font-lock-comment-delimiter-face fontified t) 1366 1398 (face font-lock-comment-face fontified t) 1398 1501 (fontified t) 1501 1507 (fontified t) 1507 1560 (fontified t) 1560 1563 (face font-lock-comment-delimiter-face fontified t) 1563 1597 (face font-lock-comment-face fontified t) 1597 1664 (fontified t) 1664 1667 (face font-lock-keyword-face fontified t) 1667 1702 (fontified t) 1702 1707 (face font-lock-keyword-face fontified t) 1707 1771 (fontified t) 1771 1789 (face font-lock-keyword-face fontified t) 1789 1836 (fontified t) 1836 1839 (face font-lock-keyword-face fontified t) 1839 1952 (fontified t) 1952 1957 (face font-lock-keyword-face fontified t) 1957 2004 (fontified t) 2004 2013 (face font-lock-string-face fontified t) 2013 2066 (fontified t) 2066 2075 (face font-lock-string-face fontified t) 2075 2128 (fontified t) 2128 2137 (face font-lock-string-face fontified t) 2137 2190 (fontified t) 2190 2200 (face font-lock-string-face fontified t) 2200 2253 (fontified t) 2253 2263 (face font-lock-string-face fontified t) 2263 2316 (fontified t) 2316 2326 (face font-lock-string-face fontified t) 2326 2381 (fontified t) 2381 2384 (face font-lock-comment-delimiter-face fontified t) 2384 2449 (face font-lock-comment-face fontified t) 2449 2505 (fontified t) 2505 2523 (face font-lock-keyword-face fontified t) 2523 2570 (fontified t) 2570 2573 (face font-lock-keyword-face fontified t) 2573 2697 (fontified t) 2697 2699 (face font-lock-keyword-face fontified t) 2699 2714 (fontified t) 2714 2720 (face font-lock-string-face fontified t) 2720 2721 (fontified t) 2721 2728 (face font-lock-string-face fontified t) 2728 2769 (fontified t) 2769 2779 (face font-lock-string-face fontified t) 2779 2845 (fontified t) 2845 2863 (face font-lock-keyword-face fontified t) 2863 2911 (fontified t) 2911 2914 (face font-lock-keyword-face fontified t) 2914 2969 (fontified t) 2969 2971 (face font-lock-keyword-face fontified t) 2971 3034 (fontified t) 3034 3041 (face font-lock-string-face fontified t) 3041 3072 (fontified t) 3072 3076 (face font-lock-keyword-face fontified t) 3076 3101 (fontified t) 3101 3107 (face font-lock-keyword-face fontified t) 3107 3254 (fontified t) 3254 3266 (face font-lock-string-face fontified t) 3266 3322 (fontified t) 3322 3325 (face font-lock-comment-delimiter-face fontified t) 3325 3342 (face font-lock-comment-face fontified t) 3342 3389 (fontified t) 3389 3393 (face font-lock-keyword-face fontified t) 3393 3470 (fontified t) 3470 3476 (face font-lock-keyword-face fontified t) 3476 3505 (fontified t) 3505 3507 (face font-lock-string-face fontified t) 3507 3544 (fontified t) 3544 3548 (face font-lock-keyword-face fontified t) 3548 3560 (fontified t) 3560 3562 (face font-lock-string-face fontified t) 3562 3668 (fontified t) 3668 3685 (face font-lock-string-face fontified t) 3685 3740 (fontified t) 3740 3744 (face font-lock-keyword-face fontified t) 3744 3821 (fontified t) 3821 3827 (face font-lock-keyword-face fontified t) 3827 3856 (fontified t) 3856 3858 (face font-lock-string-face fontified t) 3858 3895 (fontified t) 3895 3899 (face font-lock-keyword-face fontified t) 3899 3911 (fontified t) 3911 3913 (face font-lock-string-face fontified t) 3913 4019 (fontified t) 4019 4035 (face font-lock-string-face fontified t) 4035 4085 (fontified t) 4085 4088 (face font-lock-comment-delimiter-face fontified t) 4088 4105 (face font-lock-comment-face fontified t) 4105 4155 (fontified t) 4155 4173 (face font-lock-keyword-face fontified t) 4173 4175 (fontified t) 4175 4179 (face font-lock-type-face fontified t) 4179 4209 (fontified t) 4209 4211 (face font-lock-keyword-face fontified t) 4211 4326 (fontified t) 4326 4328 (face font-lock-builtin-face fontified t) 4328 4366 (fontified t) 4366 4369 (face font-lock-keyword-face fontified t) 4369 4408 (fontified t) 4408 4412 (face font-lock-keyword-face fontified t) 4412 4474 (fontified t) 4474 4483 (face font-lock-builtin-face fontified t) 4483 4515 (fontified t) 4515 4519 (face font-lock-keyword-face fontified t) 4519 4548 (fontified t) 4548 4557 (face font-lock-builtin-face fontified t) 4557 4559 (fontified t) 4559 4567 (face font-lock-string-face fontified t) 4567 4642 (fontified t) 4642 4651 (face font-lock-builtin-face fontified t) 4651 4761 (fontified t) 4761 4822 (face font-lock-string-face fontified t) 4822 5016 (fontified t) 5016 5020 (face font-lock-keyword-face fontified t) 5020 5051 (fontified t) 5051 5058 (face font-lock-builtin-face fontified t) 5058 5108 (fontified t) 5108 5114 (face font-lock-keyword-face fontified t) 5114 5165 (fontified t) 5165 5168 (face font-lock-keyword-face fontified t) 5168 5202 (fontified t) 5202 5208 (face font-lock-string-face fontified t) 5208 5276 (fontified t) 5276 5289 (face font-lock-string-face fontified t) 5289 5411 (fontified t) 5411 5415 (face font-lock-keyword-face fontified t) 5415 5462 (fontified t) 5462 5469 (face font-lock-string-face fontified t) 5469 5587 (fontified t) 5587 5603 (face font-lock-string-face fontified t) 5603 5638 (fontified t) 5638 5641 (face font-lock-comment-delimiter-face fontified t) 5641 5709 (face font-lock-comment-face fontified t) 5709 5776 (fontified t) 5776 5780 (face font-lock-keyword-face fontified t) 5780 5880 (fontified t) 5880 5884 (face font-lock-keyword-face fontified t) 5884 5905 (fontified t) 5905 5908 (face font-lock-comment-delimiter-face fontified t) 5908 5942 (face font-lock-comment-face fontified t) 5942 5975 (fontified t) 5975 5983 (face font-lock-string-face fontified t) 5983 6026 (fontified t) 6026 6033 (face font-lock-string-face fontified t) 6033 6076 (fontified t) 6076 6082 (face font-lock-string-face fontified t) 6082 6125 (fontified t) 6125 6136 (face font-lock-string-face fontified t) 6136 6168 (fontified t) 6168 6170 (face font-lock-string-face fontified t) 6170 6213 (fontified t) 6213 6216 (face font-lock-comment-delimiter-face fontified t) 6216 6242 (face font-lock-comment-face fontified t) 6242 6347 (fontified t) 6347 6352 (face font-lock-string-face fontified t) 6352 6377 (fontified t) 6377 6381 (face font-lock-keyword-face fontified t) 6381 6484 (fontified t) 6484 6492 (face font-lock-builtin-face fontified t) 6492 6606 (fontified t) 6606 6612 (face font-lock-keyword-face fontified t) 6612 6685 (fontified t) 6685 6687 (face font-lock-string-face fontified t) 6687 6762 (fontified t) 6762 6768 (face font-lock-string-face fontified t) 6768 6843 (fontified t) 6843 6848 (face font-lock-string-face fontified t) 6848 6939 (fontified t) 6939 6941 (face font-lock-keyword-face fontified t) 6941 7043 (fontified t) 7043 7050 (face font-lock-string-face fontified t) 7050 7075 (fontified t) 7075 7078 (face font-lock-comment-delimiter-face fontified t) 7078 7133 (face font-lock-comment-face fontified t) 7133 7178 (fontified t) 7178 7181 (face font-lock-keyword-face fontified t) 7181 7287 (fontified t) 7287 7290 (face font-lock-comment-delimiter-face fontified t) 7290 7322 (face font-lock-comment-face fontified t) 7322 7346 (fontified t) 7346 7350 (face font-lock-keyword-face fontified t) 7350 7376 (fontified t) 7376 7379 (face font-lock-comment-delimiter-face fontified t) 7379 7399 (face font-lock-comment-face fontified t) 7399 7514 (fontified t) 7514 7518 (face font-lock-string-face fontified t) 7518 7548 (fontified t) 7548 7552 (face font-lock-keyword-face fontified t) 7552 7631 (fontified t) 7631 7635 (face font-lock-keyword-face fontified t) 7635 7666 (fontified t) 7666 7672 (face font-lock-builtin-face fontified t) 7672 7728 (fontified t) 7728 7732 (face font-lock-keyword-face fontified t) 7732 7764 (fontified t) 7764 7770 (face font-lock-builtin-face fontified t) 7770 7842 (fontified t) 7842 7844 (face font-lock-keyword-face fontified t) 7844 7907 (fontified t) 7907 7910 (face font-lock-comment-delimiter-face fontified t) 7910 7936 (face font-lock-comment-face fontified t) 7936 8145 (fontified t) 8145 8148 (face font-lock-comment-delimiter-face fontified t) 8148 8191 (face font-lock-comment-face fontified t) 8191 8334 (fontified t) 8334 8337 (face font-lock-comment-delimiter-face fontified t) 8337 8366 (face font-lock-comment-face fontified t) 8366 8470 (fontified t) 8470 8473 (face font-lock-comment-delimiter-face fontified t) 8473 8494 (face font-lock-comment-face fontified t) 8494 8605 (fontified t) 8605 8613 (face font-lock-builtin-face fontified t) 8613 8685 (fontified t) 8685 8690 (face font-lock-warning-face fontified t) 8690 8691 (fontified t) 8691 8722 (face font-lock-string-face fontified t) 8722 8739 (fontified t) 8739 8743 (face font-lock-keyword-face fontified t) 8743 8811 (fontified t) 8811 8812 (rear-nonsticky t fontified t)) . 11557) (undo-tree-id2 . -8812) (undo-tree-id3 . -8812) (undo-tree-id4 . -1) (undo-tree-id5 . -8812) (t 26984 5862 0 0)) nil (26984 6257 696238 0) 0 nil])
([nil nil ((11557 . 11558)) nil (26984 6257 696234 0) 0 nil])
([nil nil ((#("*" 0 1 (fontified t)) . -11557) (undo-tree-id1 . -1) 11558) nil (26984 6257 696233 0) 0 nil])
([nil nil ((11557 . 11558)) nil (26984 6257 696222 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19619 . 19620) (nil fontified nil 11558 . 19620) (11558 . 19620)) nil (26984 6257 696218 0) 0 nil])
([nil nil ((11674 . 11676) (#("  " 0 2 (fontified nil)) . 11673) (undo-tree-id6 . -2) (undo-tree-id7 . -2) (undo-tree-id8 . -2) (undo-tree-id9 . -2) (undo-tree-id10 . -2) (11672 . 11676) (t 26984 6257 0 0)) nil (26984 6534 704598 0) 0 nil])
([nil nil ((11676 . 11682)) nil (26984 6534 704582 0) 0 nil])
([nil nil ((11682 . 11683)) nil (26984 6534 704580 0) 0 nil])
([nil nil ((11683 . 11691)) nil (26984 6534 704576 0) 0 nil])
([nil nil ((#("!=" 0 2 (fontified t)) . -13802) (undo-tree-id23 . -2) 13804 (t 26984 6534 0 0)) nil (26984 8167 968539 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13802 . 13803) (nil fontified nil 13802 . 13803) (13802 . 13803)) nil (26984 8167 968537 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13803 . 13804) (nil fontified nil 13803 . 13804) (13803 . 13804)) nil (26984 8167 968535 0) 0 nil])
([nil nil ((#("
(defun %build-where (filters fts-config)
  \"Construit la clause WHERE SQL. Intègre nativement les filtres 'in_xxx'.\"
  
  ;; Petite fonction locale pour découper \"a,b,c\" -> (\"a\" \"b\" \"c\")
  (labels ((split-csv (str)
             (loop for start = 0 then (1+ end)
                   for end = (position #\\, str :start start)
                   collect (subseq str start end)
                   while end))
           
           (%filter-form-p (f) (and (consp f) (symbolp (car f)))))
    
    (multiple-value-bind (emit-f params-f) (%make-param-emitter)
      (labels
          ((rec (f)
             (cond
               ;; 1. Rien
               ((null f) \"\")

               ;; 2. Liste de CLAUSES standards => (AND ...)
               ((and (consp f)
                     (not (symbolp (car f)))
                     (not (stringp (car f)))
                     (every #'%filter-form-p f))
                (rec (cons 'and f)))

               ;; 3. Liste d'ALIST (Query Params) => ((\"k\" . \"v\") ...)
               ((and (consp f)
                     (consp (car f))
                     (stringp (caar f)))
                (rec (cons 'and f)))

               ;; 4. Forme OP standard (SYMBOL ...)
               ((and (consp f) (symbolp (car f)))
                (let ((op (car f)))
                  (ecase op
                    ((= > < >= <= !=)
                     (destructuring-bind (field value) (cdr f)
                       (let ((lhs (%column-sql field))
                             (ph  (funcall emit-f value)))
                         (ecase op
                           (=  (format nil \"~a = ~a\" lhs ph))
                           (>  (format nil \"~a > ~a\" lhs ph))
                           (<  (format nil \"~a < ~a\" lhs ph))
                           (>= (format nil \"~a >= ~a\" lhs ph))
                           (<= (format nil \"~a <= ~a\" lhs ph))
                           (!= (format nil \"~a <> ~a\" lhs ph))))))
                    (in
                     (destructuring-bind (field values) (cdr f)
                       (let ((lhs (%column-sql field)))
                         (if (or (null values) (endp values))
                             \"false\"
                             (let* ((placeholders (mapcar (lambda (v) (funcall emit-f v)) values))
                                    (phs (%comma-join placeholders)))
                               (format nil \"~a in (~a)\" lhs phs))))))
                    
                    ;; Logique AND / OR
                    (and
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove-if (lambda (x) (or (null x) (string= x \"\"))) parts)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ AND ~})\" nn)))))
                    (or
                     (let* ((parts (mapcar #'rec (cdr f)))
                            (nn (remove-if (lambda (x) (or (null x) (string= x \"\"))) parts)))
                       (cond ((null nn) \"\")
                             ((= 1 (length nn)) (first nn))
                             (t (format nil \"(~{~a~^ OR ~})\" nn)))))
                    
                    ;; Full Text Search
                    (search
                     (destructuring-bind (&key q)
                         (if (and (consp (cdr f)) (keywordp (cadr f)))
                             (cdr f)
                             (list :q (second f)))
                       (let ((query q))
                         (cond
                           ((and fts-config (getf fts-config :tsvector))
                            (let* ((lang (or (getf fts-config :language) \"simple\"))
                                   (tscol (%column-sql (getf fts-config :tsvector)))
                                   (ph (funcall emit-f query)))
                              (format nil \"to_tsvector(~a, coalesce(~a,'')) @@ plainto_tsquery(~a, ~a)\"
                                      (prin1-to-string lang) tscol
                                      (prin1-to-string lang) ph)))
                           (t
                            (let* ((fields (or (getf fts-config :fields) '()))
                                   (like (lambda (col)
                                           (let ((ph (funcall emit-f (format nil \"%~a%\" query))))
                                             (format nil \"~a ILIKE ~a\" (%column-sql col) ph))))
                                   (parts (mapcar like fields)))
                              (cond
                                ((null parts) \"false\")
                                ((= 1 (length parts)) (first parts))
                                (t (format nil \"(~{~a~^ OR ~})\" parts))))))))))))

               ;; 5. Forme ALIST seule (\"key\" . \"val\") -> Transformation intelligente
               ((and (consp f) (stringp (car f)))
                (let* ((raw-key (car f))
                       (raw-val (cdr f))
                       (len (length raw-key))
                       ;; Nettoyage de \"q[xxx]\" ou \"xxx\"
                       (col-name (if (and (> len 3)
                                          (string= (subseq raw-key 0 2) \"q[\")
                                          (char= (char raw-key (1- len)) #\\]))
                                     (subseq raw-key 2 (1- len))
                                     raw-key)))
                  
                  (cond
                    ;; A. Ignorer les paramètres système
                    ((or (search \"order[\" raw-key)
                         (search \"limit\" raw-key)
                         (search \"page\" raw-key)
                         (search \"page_size\" raw-key))
                     \"\")
                    
                    ;; B. [NOUVEAU] Gestion de \"in_column\" -> IN (a,b,c)
                    ((and (> (length col-name) 3)
                          (string= (subseq col-name 0 3) \"in_\"))
                     (let* ((real-col (subseq col-name 3))
                            (keyword  (intern (string-upcase real-col) :keyword))
                            (all-vals (split-csv raw-val))
                            ;; FILTRE : On retire \"null\", \"nil\" et les chaînes vides
                            (clean-vals (remove-if (lambda (x)
                                                     (or (string= x \"\")
                                                         (string-equal x \"null\")
                                                         (string-equal x \"nil\")))
                                                   all-vals)))
                       
                       ;; Si après nettoyage il reste des valeurs, on génère le IN
                       (if clean-vals
                           (rec (list 'in keyword clean-vals))
                           ;; Sinon (ex: \"null,null\"), on retourne FALSE (car ID IN () est impossible)
                           \"false\")))
                    
                    ;; C. Défaut : Égalité standard (= :col \"val\")
                    (t
                     (rec (list '= 
                                (intern (string-upcase col-name) :keyword) 
                                raw-val))))))

               (t (error \"Clause de filtre invalide: ~S\" f)))))
        (let* ((sql (rec filters)))
          (values sql (funcall params-f)))))))
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 20 (face font-lock-function-name-face fontified t) 20 42 (fontified t) 42 44 (fontified t) 44 117 (face font-lock-doc-face fontified t) 117 123 (fontified t) 123 126 (face font-lock-comment-delimiter-face fontified t) 126 188 (face font-lock-comment-face fontified t) 188 191 (fontified t) 191 197 (face font-lock-keyword-face fontified t) 197 230 (fontified t) 230 234 (face font-lock-keyword-face fontified t) 234 310 (fontified t) 310 316 (face font-lock-builtin-face fontified t) 316 494 (fontified t) 494 513 (face font-lock-keyword-face fontified t) 513 561 (fontified t) 561 567 (face font-lock-keyword-face fontified t) 567 602 (fontified t) 602 606 (face font-lock-keyword-face fontified t) 606 622 (fontified t) 622 625 (face font-lock-comment-delimiter-face fontified t) 625 633 (face font-lock-comment-face fontified t) 633 658 (fontified t) 658 660 (face font-lock-string-face fontified t) 660 678 (fontified t) 678 681 (face font-lock-comment-delimiter-face fontified t) 681 724 (face font-lock-comment-face fontified t) 724 947 (fontified t) 947 950 (face font-lock-comment-delimiter-face fontified t) 950 1003 (face font-lock-comment-face fontified t) 1003 1165 (fontified t) 1165 1168 (face font-lock-comment-delimiter-face fontified t) 1168 1202 (face font-lock-comment-face fontified t) 1202 1269 (fontified t) 1269 1272 (face font-lock-keyword-face fontified t) 1272 1306 (fontified t) 1306 1307 (fontified t) 1307 1312 (face font-lock-keyword-face fontified t) 1312 1316 (fontified t) 1316 1376 (fontified t) 1376 1394 (face font-lock-keyword-face fontified t) 1394 1441 (fontified t) 1441 1444 (face font-lock-keyword-face fontified t) 1444 1542 (fontified t) 1542 1557 (fontified t) 1557 1562 (face font-lock-keyword-face fontified t) 1562 1566 (fontified t) 1566 1609 (fontified t) 1609 1618 (face font-lock-string-face fontified t) 1618 1671 (fontified t) 1671 1680 (face font-lock-string-face fontified t) 1680 1733 (fontified t) 1733 1742 (face font-lock-string-face fontified t) 1742 1795 (fontified t) 1795 1805 (face font-lock-string-face fontified t) 1805 1858 (fontified t) 1858 1868 (face font-lock-string-face fontified t) 1868 1921 (fontified t) 1921 1931 (face font-lock-string-face fontified t) 1931 1991 (fontified t) 1991 2009 (face font-lock-keyword-face fontified t) 2009 2057 (fontified t) 2057 2060 (face font-lock-keyword-face fontified t) 2060 2115 (fontified t) 2115 2117 (face font-lock-keyword-face fontified t) 2117 2180 (fontified t) 2180 2187 (face font-lock-string-face fontified t) 2187 2218 (fontified t) 2218 2222 (face font-lock-keyword-face fontified t) 2222 2247 (fontified t) 2247 2253 (face font-lock-keyword-face fontified t) 2253 2400 (fontified t) 2400 2412 (face font-lock-string-face fontified t) 2412 2468 (fontified t) 2468 2471 (face font-lock-comment-delimiter-face fontified t) 2471 2488 (face font-lock-comment-face fontified t) 2488 2535 (fontified t) 2535 2539 (face font-lock-keyword-face fontified t) 2539 2616 (fontified t) 2616 2622 (face font-lock-keyword-face fontified t) 2622 2651 (fontified t) 2651 2653 (face font-lock-string-face fontified t) 2653 2690 (fontified t) 2690 2694 (face font-lock-keyword-face fontified t) 2694 2706 (fontified t) 2706 2708 (face font-lock-string-face fontified t) 2708 2814 (fontified t) 2814 2816 (face font-lock-string-face fontified t) 2816 2831 (face font-lock-string-face fontified t) 2831 2840 (fontified t) 2840 2886 (fontified t) 2886 2890 (face font-lock-keyword-face fontified t) 2890 2967 (fontified t) 2967 2973 (face font-lock-keyword-face fontified t) 2973 3002 (fontified t) 3002 3004 (face font-lock-string-face fontified t) 3004 3041 (fontified t) 3041 3045 (face font-lock-keyword-face fontified t) 3045 3057 (fontified t) 3057 3059 (face font-lock-string-face fontified t) 3059 3066 (fontified t) 3066 3121 (fontified t) 3121 3165 (fontified t) 3165 3181 (face font-lock-string-face fontified t) 3181 3231 (fontified t) 3231 3234 (face font-lock-comment-delimiter-face fontified t) 3234 3251 (face font-lock-comment-face fontified t) 3251 3301 (fontified t) 3301 3319 (face font-lock-keyword-face fontified t) 3319 3321 (fontified t) 3321 3325 (face font-lock-type-face fontified t) 3325 3355 (fontified t) 3355 3357 (face font-lock-keyword-face fontified t) 3357 3472 (fontified t) 3472 3474 (face font-lock-builtin-face fontified t) 3474 3512 (fontified t) 3512 3515 (face font-lock-keyword-face fontified t) 3515 3554 (fontified t) 3554 3558 (face font-lock-keyword-face fontified t) 3558 3620 (fontified t) 3620 3629 (face font-lock-builtin-face fontified t) 3629 3661 (fontified t) 3661 3665 (face font-lock-keyword-face fontified t) 3665 3694 (fontified t) 3694 3703 (face font-lock-builtin-face fontified t) 3703 3705 (fontified t) 3705 3713 (face font-lock-string-face fontified t) 3713 3788 (fontified t) 3788 3797 (face font-lock-builtin-face fontified t) 3797 3907 (fontified t) 3907 3968 (face font-lock-string-face fontified t) 3968 4162 (fontified t) 4162 4166 (face font-lock-keyword-face fontified t) 4166 4197 (fontified t) 4197 4204 (face font-lock-builtin-face fontified t) 4204 4254 (fontified t) 4254 4260 (face font-lock-keyword-face fontified t) 4260 4311 (fontified t) 4311 4314 (face font-lock-keyword-face fontified t) 4314 4340 (fontified t) 4340 4348 (fontified t) 4348 4354 (face font-lock-string-face fontified t) 4354 4365 (fontified t) 4365 4422 (fontified t) 4422 4435 (face font-lock-string-face fontified t) 4435 4557 (fontified t) 4557 4561 (face font-lock-keyword-face fontified t) 4561 4608 (fontified t) 4608 4615 (face font-lock-string-face fontified t) 4615 4621 (fontified t) 4621 4686 (fontified t) 4686 4733 (fontified t) 4733 4749 (face font-lock-string-face fontified t) 4749 4784 (fontified t) 4784 4787 (face font-lock-comment-delimiter-face fontified t) 4787 4855 (face font-lock-comment-face fontified t) 4855 4922 (fontified t) 4922 4926 (face font-lock-keyword-face fontified t) 4926 5056 (fontified t) 5056 5059 (face font-lock-comment-delimiter-face fontified t) 5059 5090 (face font-lock-comment-face fontified t) 5090 5124 (fontified t) 5124 5126 (face font-lock-keyword-face fontified t) 5126 5214 (fontified t) 5214 5218 (face font-lock-string-face fontified t) 5218 5450 (fontified t) 5450 5454 (face font-lock-keyword-face fontified t) 5454 5475 (fontified t) 5475 5478 (face font-lock-comment-delimiter-face fontified t) 5478 5512 (face font-lock-comment-face fontified t) 5512 5545 (fontified t) 5545 5553 (face font-lock-string-face fontified t) 5553 5596 (fontified t) 5596 5603 (face font-lock-string-face fontified t) 5603 5646 (fontified t) 5646 5652 (face font-lock-string-face fontified t) 5652 5695 (fontified t) 5695 5706 (face font-lock-string-face fontified t) 5706 5738 (fontified t) 5738 5740 (face font-lock-string-face fontified t) 5740 5783 (fontified t) 5783 5786 (face font-lock-comment-delimiter-face fontified t) 5786 5836 (face font-lock-comment-face fontified t) 5836 5865 (fontified t) 5865 5886 (fontified t) 5886 5943 (fontified t) 5943 5948 (face font-lock-string-face fontified t) 5948 5973 (fontified t) 5973 5977 (face font-lock-keyword-face fontified t) 5977 6081 (fontified t) 6081 6089 (face font-lock-builtin-face fontified t) 6089 6179 (fontified t) 6179 6182 (face font-lock-comment-delimiter-face fontified t) 6182 6186 (face font-lock-comment-face fontified t) 6186 6236 (face font-lock-comment-face fontified t) 6236 6288 (fontified t) 6288 6294 (face font-lock-keyword-face fontified t) 6294 6367 (fontified t) 6367 6369 (face font-lock-string-face fontified t) 6369 6444 (fontified t) 6444 6450 (face font-lock-string-face fontified t) 6450 6525 (fontified t) 6525 6530 (face font-lock-string-face fontified t) 6530 6644 (fontified t) 6644 6647 (face font-lock-comment-delimiter-face fontified t) 6647 6704 (face font-lock-comment-face fontified t) 6704 6728 (fontified t) 6728 6730 (face font-lock-keyword-face fontified t) 6730 6832 (fontified t) 6832 6835 (face font-lock-comment-delimiter-face fontified t) 6835 6908 (face font-lock-comment-face fontified t) 6908 6935 (fontified t) 6935 6942 (face font-lock-string-face fontified t) 6942 6987 (fontified t) 6987 6990 (face font-lock-comment-delimiter-face fontified t) 6990 7034 (face font-lock-comment-face fontified t) 7034 7158 (fontified t) 7158 7166 (face font-lock-builtin-face fontified t) 7166 7235 (fontified t) 7235 7240 (face font-lock-warning-face fontified t) 7240 7241 (fontified t) 7241 7272 (face font-lock-string-face fontified t) 7272 7289 (fontified t) 7289 7293 (face font-lock-keyword-face fontified t) 7293 7316 (fontified t) 7316 7363 (fontified t)) . 4194) (undo-tree-id11 . -7363) (undo-tree-id12 . -1737) (undo-tree-id13 . -1675) (undo-tree-id14 . -533) (undo-tree-id15 . -552) (undo-tree-id16 . -1) (undo-tree-id17 . -1452) (undo-tree-id18 . -7362) (undo-tree-id19 . -7363) (undo-tree-id20 . -7363) (undo-tree-id21 . -7315) (undo-tree-id22 . -7363)) nil (26984 8228 39784 0) 0 nil])
([nil nil ((#("<" 0 1 (fontified t rear-nonsticky t)) . -6439) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (#(">" 0 1 (fontified t rear-nonsticky t)) . -6440) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) 6441 (t 26984 8167 0 0)) nil (26984 8243 916009 0) 0 nil] [nil nil ((4236 . 4237) (t 26984 8167 0 0)) ((#("q" 0 1 (fontified t)) . 4236)) (26984 8227 986273 0) 0 nil])
([nil nil ((6439 . 6441)) nil (26984 8243 915955 0) 0 nil])
nil
([nil nil ((#("

  (print filters)" 0 1 (fontified t) 1 2 (fontified t) 2 19 (fontified t)) . 4309) (undo-tree-id51 . -19) (undo-tree-id52 . -1) (undo-tree-id53 . -19) (undo-tree-id54 . -19) (undo-tree-id55 . -19) (undo-tree-id56 . -19) (undo-tree-id57 . -19) (t 26984 8243 0 0)) nil (26984 8347 592524 0) 0 nil])
([nil nil ((32409 . 32414) (t 26984 8347 0 0)) nil (26985 56306 837101 0) 0 nil])
([nil nil ((32414 . 32415)) nil (26985 56306 837100 0) 0 nil])
([nil nil ((32415 . 32417)) nil (26985 56306 837096 0) 0 nil])
([nil current ((nil rear-nonsticky nil 32852 . 32853) (nil fontified nil 32845 . 32853) (32845 . 32853) (t 26985 56306 0 0)) nil (26986 14196 709633 0) 0 nil])
nil
