(undo-tree-save-format-version . 1)
"a2b4ad842f5c0632943f1131ca860b546728eb33"
[nil nil nil nil (26803 14922 171603 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 15493 . 15494) (nil fontified nil 1 . 15494) (1 . 15494) (t . -1)) nil (26803 14922 171602 0) 0 nil])
([nil nil ((5498 . 5500)) nil (26803 14922 171601 0) 0 nil])
([nil nil ((5579 . 5580)) nil (26803 14922 171601 0) 0 nil])
([nil nil ((5662 . 5664)) nil (26803 14922 171600 0) 0 nil])
([nil nil ((5743 . 5744)) nil (26803 14922 171600 0) 0 nil])
([nil nil ((5826 . 5828)) nil (26803 14922 171599 0) 0 nil])
([nil nil ((5906 . 5908)) nil (26803 14922 171599 0) 0 nil])
([nil nil ((5513 . 5515)) nil (26803 14922 171598 0) 0 nil])
([nil nil ((5679 . 5681)) nil (26803 14922 171598 0) 0 nil])
([nil nil ((5845 . 5847)) nil (26803 14922 171597 0) 0 nil])
([nil nil ((5927 . 5929)) nil (26803 14922 171593 0) 0 nil])
([nil nil ((1 . 15494) (#(";;;; lumen/data/dao.lisp
(in-package :cl-user)
(defpackage :lumen.data.dao
  (:use :cl)
  (:import-from :lumen.data.db :query-1a :exec)
  (:export
   ;; Macro & API
   :defentity
   :row->entity :entity-insert! :entity-update! :entity-delete!
   :validate-entity!
   ;; Hooks (méthodes spécialisables)
   :before-validate :after-validate
   :before-insert :after-insert
   :before-update :after-update
   :before-delete :after-delete
   ;; Introspection
   :entity-metadata :entity-fields :entity-table :entity-primary-key
   ;; Conditions
   :entity-validation-error))
(in-package :lumen.data.dao)

;;; ----------------------------------------------------------------------------
;;; Registry & metadata
;;; ----------------------------------------------------------------------------
(defvar *entity-registry* (make-hash-table :test 'eq))
;; metadata plist par classe :
;;  :table <string>  :primary-key <keyword>  :fields (<field-spec> ...)
;;  :defaults <alist> (colkw . value)
;;
;; field-spec = plist :
;;   :col <keyword> :slot <symbol> :type <symbol|keyword>
;;   :required? <bool> :validator <fn|symbol|nil> :default <val>
;;   ; props UI pour auto-form
;;   :label <string> :input-type <keyword> :placeholder <string> :help <string>
;;   :choices <list of (value . label)> :min <num> :max <num> :step <num>
;;   :pattern <string> :attrs <alist> :readonly? <bool> :disabled? <bool> :hidden? <bool>
;;   :ui-group <string> :ui-order <number>

(defun entity-metadata (class-symbol)
  (or (gethash class-symbol *entity-registry*)
      (error \"Aucune entité enregistrée pour ~S\" class-symbol)))

(defun entity-fields (class-symbol)
  (getf (entity-metadata class-symbol) :fields))

(defun entity-table (class-symbol)
  (getf (entity-metadata class-symbol) :table))

(defun entity-primary-key (class-symbol)
  (getf (entity-metadata class-symbol) :primary-key))

;;; ----------------------------------------------------------------------------
;;; Utilities
;;; ----------------------------------------------------------------------------
(defun %ident-p (x)
  (and (or (symbolp x) (keywordp x) (stringp x))
       (let* ((s (string-downcase (etypecase x
                                    (string x)
                                    (symbol (symbol-name x))))))
         (and (> (length s) 0)
              (char<= #\\a (aref s 0) #\\z)
              (every (lambda (ch)
                       (or (char<= #\\a ch #\\z)
                           (char<= #\\0 ch #\\9)
                           (char= ch #\\_)))
                     s)))))

(defun %ident (x)
  (unless (%ident-p x) (error \"Identifiant SQL invalide: ~S\" x))
  (string-downcase (etypecase x
                     (string x)
                     (symbol (symbol-name x)))))

(defun %kw (x)
  (if (keywordp x) x
      (intern (string-upcase (%ident x)) :keyword)))

(defun %make-param-emitter ()
  (let ((n 0) (ps '()))
    (values
     (lambda (v) (incf n) (push v ps) (format nil \"$~D\" n))
     (lambda () (nreverse ps)))))

(defun %slot-value (obj slot)
  (slot-value obj slot))

(defun %set-slot (obj slot value)
  (setf (slot-value obj slot) value))

(defun %field-by-col (fields colkw)
  (find colkw fields :key (lambda (f) (getf f :col)) :test #'eq))

(defun %all-field-cols (fields)
  (mapcar (lambda (f) (getf f :col)) fields))

;;; ----------------------------------------------------------------------------
;;; Validations
;;; ----------------------------------------------------------------------------
(define-condition entity-validation-error (error)
  ((entity :initarg :entity :reader entity-validation-entity)
   (errors :initarg :errors :reader entity-validation-errors))
  (:report (lambda (c s)
             (format s \"Validation failed: ~{~a~^, ~}\"
                     (mapcar #'princ-to-string (entity-validation-errors c))))))

(defgeneric before-validate (entity) (:method (e) (declare (ignore e)) nil))
(defgeneric after-validate  (entity) (:method (e) (declare (ignore e)) nil))

(defun %run-validator (fun value entity field-spec)
  (cond
    ((null fun) t)
    ((functionp fun) (funcall fun value entity field-spec))
    ((and (symbolp fun) (fboundp fun))
     (funcall (symbol-function fun) value entity field-spec))
    (t (error \"Validator invalide: ~S\" fun))))

(defun validate-entity! (entity)
  \"Vérifie required? et validator ; lève entity-validation-error si échecs.\"
  (before-validate entity)
  (let* ((class (class-of entity))
         (cname (class-name class))
         (md (entity-metadata cname))
         (fields (getf md :fields))
         (errors '()))
    (dolist (f fields)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (label (or (getf f :label) (symbol-name slot)))
             (required? (getf f :required?))
             (validator (getf f :validator))
             (val (%slot-value entity slot)))
        (when (and required? (null val))
          (push (format nil \"~a (~a) requis\" label col) errors))
        (when (and val validator (not (%run-validator validator val entity f)))
          (push (format nil \"Validation échouée pour ~a (~a)\" label col) errors))))
    (when errors
      (error 'entity-validation-error :entity entity :errors (nreverse errors))))
  (after-validate entity)
  entity)

;;; ----------------------------------------------------------------------------
;;; Hooks CRUD (par défaut no-op)
;;; ----------------------------------------------------------------------------
(defgeneric before-insert (entity)      (:method (e)   (declare (ignore e)) nil))
(defgeneric after-insert  (entity new)  (:method (e n) (declare (ignore e n)) nil))
(defgeneric before-update (entity)      (:method (e)   (declare (ignore e)) nil))
(defgeneric after-update  (entity new)  (:method (e n) (declare (ignore e n)) nil))
(defgeneric before-delete (entity)      (:method (e)   (declare (ignore e)) nil))
(defgeneric after-delete  (entity)      (:method (e)   (declare (ignore e)) nil))

;;; ----------------------------------------------------------------------------
;;; Mapping row -> entity
;;; ----------------------------------------------------------------------------
(defgeneric row->entity (class row-alist))
(defmethod row->entity ((class symbol) row)
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (inst (make-instance class)))
    (dolist (f fields inst)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (val  (cdr (assoc col row))))
        (%set-slot inst slot val)))))

;;; ----------------------------------------------------------------------------
;;; CRUD
;;; ----------------------------------------------------------------------------
(defgeneric entity-insert! (entity &key returning))
(defgeneric entity-update! (entity &key returning))
(defgeneric entity-delete! (entity))

(defmethod entity-insert! ((entity standard-object) &key (returning t))
  ;; defaults + validation + INSERT ... RETURNING
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields))
         (defaults (or (getf md :defaults) '())))
    ;; Appliquer defaults si slot nul
    (dolist (f fields)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (current (%slot-value entity slot))
             (defv (cdr (assoc col defaults))))
        (when (and (null current) defv)
          (%set-slot entity slot defv))))
    ;; Validate
    (validate-entity! entity)
    ;; Construire INSERT (exclude pk si NULL et séquence auto)
    (let ((cols '()) (phs '()))
      (multiple-value-bind (emit params-f) (%make-param-emitter)
        (dolist (f fields)
          (let* ((col (getf f :col))
                 (slot (getf f :slot))
                 (val (%slot-value entity slot)))
            (when (or (not (eq col pk)) (not (null val))) ; inclure pk si non-nil
              (push (%ident col) cols)
              (push (funcall emit val) phs))))
        (let* ((cols* (nreverse cols))
               (phs*  (nreverse phs))
               (returning-sql (cond
                                ((eq returning t) \" returning *\")
                                ((and (listp returning) (every #'keywordp returning))
                                 (format nil \" returning ~{~a~^, ~}\"
                                         (mapcar #'%ident returning)))
                                ((null returning) \"\")
                                (t \" returning *\")))
               (sql (format nil \"insert into ~a (~{~a~^, ~}) values (~{~a~^, ~})~a\"
                            table cols* phs* returning-sql)))
          (multiple-value-bind (affected ret)
              (apply #'exec sql (funcall params-f))
            (declare (ignore affected))
            (let ((row (or ret
                           (and (not (null returning))
                                ;; si RETURNING demandé mais pas renvoyé par exec (fallback)
                                (apply #'query-1a sql (funcall params-f))))))
              (let ((new (if row (row->entity class row) entity)))
                (after-insert entity new)
                new)))))))

(defmethod entity-update! ((entity standard-object) &key (returning t))
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields)))
    ;; Validate avant update
    (validate-entity! entity)
    (let ((assigns '()) where)
      (multiple-value-bind (emit params-f) (%make-param-emitter)
        ;; SET col = $n pour toutes les colonnes sauf PK
        (dolist (f fields)
          (let* ((col (getf f :col))
                 (slot (getf f :slot))
                 (val (%slot-value entity slot)))
            (if (eq col pk)
                (setf where (format nil \"~a = ~a\" (%ident col) (funcall emit val)))
                (progn
                  (push (format nil \"~a = ~a\" (%ident col) (funcall emit val)) assigns)))))
        (unless where (error \"Primary key manquante (~a) pour UPDATE\" pk))
        (let* ((assigns* (nreverse assigns))
               (set-sql (if (null assigns*) \"/* no-op */\" (%comma-join assigns*)))
               (returning-sql (cond
                                ((eq returning t) \" returning *\")
                                ((and (listp returning) (every #'keywordp returning))
                                 (format nil \" returning ~{~a~^, ~}\"
                                         (mapcar #'%ident returning)))
                                ((null returning) \"\")
                                (t \" returning *\")))
               (sql (format nil \"update ~a set ~a where ~a~a\"
                            table set-sql where returning-sql)))
          (before-update entity)
          (multiple-value-bind (affected ret)
              (apply #'exec sql (funcall params-f))
            (declare (ignore affected))
            (let ((row (or ret
                           (and (not (null returning))
                                (apply #'query-1a sql (funcall params-f))))))
              (let ((new (if row (row->entity class row) entity)))
                (after-update entity new)
                new)))))))

(defmethod entity-delete! ((entity standard-object))
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields))
         (pk-slot (getf (or (%field-by-col fields pk)
                            (error \"PK ~a introuvable dans ~a\" pk class))
                        :slot))
         (pk-val (%slot-value entity pk-slot)))
    (unless pk-val (error \"Impossible de supprimer: PK ~a est NIL\" pk))
    (before-delete entity)
    (multiple-value-bind (emit params-f) (%make-param-emitter)
      (let* ((where (format nil \"~a = ~a\" (%ident pk) (funcall emit pk-val)))
             (sql (format nil \"delete from ~a where ~a\" table where)))
        (multiple-value-bind (n _ret)
            (apply #'exec sql (funcall params-f))
          (declare (ignore _ret))
          (after-delete entity)
          n)))))

;;; ----------------------------------------------------------------------------
;;; Macro defentity
;;; ----------------------------------------------------------------------------
(defmacro defentity (name &key table fields primary-key defaults)
  \"Déclare une entité CLOS + enregistre metadata pour CRUD/validation/UI.
FIELDS est une liste de formes:
  (:col <kw> :type <sym|kw> [:required? t] [:validator fn]
         [:default v] [:label \\\"...\\\"] [:input-type :text|...]
         [:placeholder \\\"...\\\"] [:help \\\"...\\\"] [:choices ((v . l) ...)]
         [:min n] [:max n] [:step n] [:pattern \\\"^\\\"] [:attrs ((k . v) ...)]
         [:readonly? t] [:disabled? t] [:hidden? t]
         [:ui-group \\\"...\\\"] [:ui-order n])\"
  (let* ((cls name)
         (tbl (if table (string-downcase (etypecase table
                                           (string table)
                                           (symbol (symbol-name table))))
                    (string-downcase (symbol-name name))))
         (pk  (or primary-key :id))
         ;; normaliser fields : ajouter :slot si manquant
         (norm-fields
           (mapcar
            (lambda (f)
              (destructuring-bind (&key col type required? validator default
                                         label input-type placeholder help choices
                                         min max step pattern attrs
                                         readonly? disabled? hidden?
                                         ui-group ui-order slot)
                  f
                (let* ((colkw (%kw (or col (error \"Champ sans :col dans ~a\" name))))
                       (slot-name (or slot (intern (string-downcase (symbol-name colkw))))))
                  (list :col colkw :slot slot-name :type type
                        :required? required? :validator validator :default default
                        :label label :input-type input-type :placeholder placeholder :help help
                        :choices choices :min min :max max :step step :pattern pattern :attrs attrs
                        :readonly? readonly? :disabled? disabled? :hidden? hidden?
                        :ui-group ui-group :ui-order ui-order))))
            fields))
         (slots
           (mapcar (lambda (f)
                     (let ((s (getf f :slot)))
                       `(,s :initarg ,(intern (concatenate 'string \":\" (string-upcase (symbol-name s))))
                            :accessor ,(intern (concatenate 'string (string-downcase (symbol-name cls)) \"-\" (string-downcase (symbol-name s))))
                            :initform nil)))
                   norm-fields))
         (defaults-alist
           (loop for f in norm-fields
                 for col = (getf f :col)
                 for def = (getf f :default)
                 when (and (getf f :default) t)
                 collect (cons col def))))
    `(progn
       (defclass ,cls () ,slots)
       ;; enregistrer metadata
       (setf (gethash ',cls *entity-registry*)
             (list :table ,tbl
                   :primary-key ,(%kw pk)
                   :fields ',norm-fields
                   :defaults ',(or defaults defaults-alist)))
       ',cls)))
" 0 5 (face font-lock-comment-delimiter-face fontified t) 5 25 (face font-lock-comment-face fontified t) 25 26 (fontified t) 26 36 (face font-lock-keyword-face fontified t) 36 37 (fontified t) 37 45 (face font-lock-builtin-face fontified t) 45 48 (fontified t) 48 58 (face font-lock-keyword-face fontified t) 58 59 (fontified t) 59 74 (face font-lock-type-face fontified t) 74 78 (fontified t) 78 82 (face font-lock-builtin-face fontified t) 82 83 (fontified t) 83 86 (face font-lock-builtin-face fontified t) 86 91 (fontified t) 91 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 118 (face font-lock-builtin-face fontified t) 118 119 (fontified t) 119 128 (face font-lock-builtin-face fontified t) 128 129 (fontified t) 129 134 (face font-lock-builtin-face fontified t) 134 139 (fontified t) 139 146 (face font-lock-builtin-face fontified t) 146 150 (fontified t) 150 153 (face font-lock-comment-delimiter-face fontified t) 153 165 (face font-lock-comment-face fontified t) 165 168 (fontified t) 168 178 (face font-lock-builtin-face fontified t) 178 182 (fontified t) 182 194 (face font-lock-builtin-face fontified t) 194 195 (fontified t) 195 210 (face font-lock-builtin-face fontified t) 210 211 (fontified t) 211 226 (face font-lock-builtin-face fontified t) 226 227 (fontified t) 227 242 (face font-lock-builtin-face fontified t) 242 246 (fontified t) 246 263 (face font-lock-builtin-face fontified t) 263 267 (fontified t) 267 270 (face font-lock-comment-delimiter-face fontified t) 270 302 (face font-lock-comment-face fontified t) 302 305 (fontified t) 305 321 (face font-lock-builtin-face fontified t) 321 322 (fontified t) 322 337 (face font-lock-builtin-face fontified t) 337 341 (fontified t) 341 355 (face font-lock-builtin-face fontified t) 355 356 (fontified t) 356 369 (face font-lock-builtin-face fontified t) 369 373 (fontified t) 373 387 (face font-lock-builtin-face fontified t) 387 388 (fontified t) 388 401 (face font-lock-builtin-face fontified t) 401 405 (fontified t) 405 419 (face font-lock-builtin-face fontified t) 419 420 (fontified t) 420 433 (face font-lock-builtin-face fontified t) 433 437 (fontified t) 437 440 (face font-lock-comment-delimiter-face fontified t) 440 454 (face font-lock-comment-face fontified t) 454 457 (fontified t) 457 473 (face font-lock-builtin-face fontified t) 473 474 (fontified t) 474 488 (face font-lock-builtin-face fontified t) 488 489 (fontified t) 489 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 522 (face font-lock-builtin-face fontified t) 522 526 (fontified t) 526 529 (face font-lock-comment-delimiter-face fontified t) 529 540 (face font-lock-comment-face fontified t) 540 543 (fontified t) 543 567 (face font-lock-builtin-face fontified t) 567 571 (fontified t) 571 581 (face font-lock-keyword-face fontified t) 581 582 (fontified t) 582 597 (face font-lock-builtin-face fontified t) 597 600 (fontified t) 600 604 (face font-lock-comment-delimiter-face fontified t) 604 681 (face font-lock-comment-face fontified t) 681 685 (face font-lock-comment-delimiter-face fontified t) 685 705 (face font-lock-comment-face fontified t) 705 709 (face font-lock-comment-delimiter-face fontified t) 709 786 (face font-lock-comment-face fontified t) 786 787 (fontified t) 787 793 (face font-lock-keyword-face fontified t) 793 794 (fontified t) 794 811 (face font-lock-variable-name-face fontified t) 811 829 (fontified t) 829 834 (face font-lock-builtin-face fontified t) 834 841 (fontified t) 841 844 (face font-lock-comment-delimiter-face fontified t) 844 872 (face font-lock-comment-face fontified t) 872 876 (face font-lock-comment-delimiter-face fontified t) 876 944 (face font-lock-comment-face fontified t) 944 948 (face font-lock-comment-delimiter-face fontified t) 948 982 (face font-lock-comment-face fontified t) 982 984 (face font-lock-comment-delimiter-face fontified t) 984 985 (face font-lock-comment-face fontified t) 985 988 (face font-lock-comment-delimiter-face fontified t) 988 1009 (face font-lock-comment-face fontified t) 1009 1014 (face font-lock-comment-delimiter-face fontified t) 1014 1067 (face font-lock-comment-face fontified t) 1067 1072 (face font-lock-comment-delimiter-face fontified t) 1072 1132 (face font-lock-comment-face fontified t) 1132 1137 (face font-lock-comment-delimiter-face fontified t) 1137 1163 (face font-lock-comment-face fontified t) 1163 1168 (face font-lock-comment-delimiter-face fontified t) 1168 1243 (face font-lock-comment-face fontified t) 1243 1248 (face font-lock-comment-delimiter-face fontified t) 1248 1317 (face font-lock-comment-face fontified t) 1317 1322 (face font-lock-comment-delimiter-face fontified t) 1322 1407 (face font-lock-comment-face fontified t) 1407 1412 (face font-lock-comment-delimiter-face fontified t) 1412 1450 (face font-lock-comment-face fontified t) 1450 1452 (fontified t) 1452 1457 (face font-lock-keyword-face fontified t) 1457 1458 (fontified t) 1458 1473 (face font-lock-function-name-face fontified t) 1473 1500 (fontified t) 1500 1536 (fontified t) 1536 15511 (fontified nil)) . 1) (t 26803 14922 0 0)) nil (26803 18837 329741 0) 0 nil])
([nil nil ((#(";;;; lumen/data/dao.lisp" 0 5 (face font-lock-comment-delimiter-face fontified t) 5 24 (face font-lock-comment-face fontified t)) . 1)) nil (26803 18837 329740 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1)) nil (26803 18837 329740 0) 0 nil])
([nil nil ((22 . 23)) nil (26803 18837 329740 0) 0 nil])
([nil nil ((#("user" 0 4 (face font-lock-builtin-face fontified t)) . -17) (undo-tree-id2 . -4) 21) nil (26803 18837 329739 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . -16) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 17) nil (26803 18837 329738 0) 0 nil])
([nil nil ((541 . 542)) nil (26803 18837 329724 0) 0 nil])
([nil nil ((15111 . 15113) (#("    " 0 4 (fontified t)) . -13692) (#("    " 0 4 (fontified t)) . -13628) (#("    " 0 4 (fontified t)) . -13549) (#("  " 0 2 (fontified t)) . -13237) 12468) nil (26803 18837 329723 0) 0 nil])
([nil nil ((9216 . 9217)) nil (26803 18837 329722 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8767 . 8768) (nil fontified nil 8755 . 8768) (8755 . 8768)) nil (26803 18837 329722 0) 0 nil])
([nil nil ((8768 . 8769)) nil (26803 18837 329722 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10988 . 10989) (nil fontified nil 10976 . 10989) (10976 . 10989)) nil (26803 18837 329721 0) 0 nil])
([nil nil ((10989 . 10990)) nil (26803 18837 329721 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12214 . 12215) (nil fontified nil 12202 . 12215) (12202 . 12215)) nil (26803 18837 329720 0) 0 nil])
([nil nil ((12215 . 12216)) nil (26803 18837 329720 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9070 . 9071) (nil fontified nil 9058 . 9071) (9058 . 9071)) nil (26803 18837 329719 0) 0 nil])
([nil nil ((9071 . 9072)) nil (26803 18837 329780 0) 0 nil])
([nil nil ((9085 . 9096) (#(" " 0 1 (fontified nil)) . 9084) (undo-tree-id8 . -1) (9085 . 9086)) nil (26803 18855 969451 0) 0 nil] [nil nil ((9086 . 9100)) ((#("
								     " 0 14 (fontified t)) . 9086) (undo-tree-id3 . -14) (undo-tree-id4 . -1)) (26803 18837 329715 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11223 . 11224) (nil fontified nil 11211 . 11224) (11211 . 11224)) nil (26803 18855 969450 0) 0 nil])
nil
([nil nil ((11224 . 11225)) nil (26803 18855 969449 0) 0 nil])
([nil nil ((11238 . 11249) (#(" " 0 1 (fontified nil)) . 11237) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (11238 . 11239)) nil (26803 18855 969446 0) 0 nil])
([nil nil ((3276 . 3278) (t 26803 18855 0 0)) nil (26803 19850 931735 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3553 . 3554) (nil fontified nil 3278 . 3554) (3278 . 3554)) nil (26803 19850 931734 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -3553) (undo-tree-id9 . -1) 3554) nil (26803 19851 328685 0) 0 nil])
([nil nil ((15805 . 15811)) nil (26803 20052 415144 0) 0 nil] [nil nil ((15804 . 15812)) ((#("
				   " 0 1 (fontified t) 1 8 (fontified t)) . 15804) (undo-tree-id11 . -8) (undo-tree-id12 . -8) (undo-tree-id13 . -8) (undo-tree-id14 . -1) (undo-tree-id15 . -8) (undo-tree-id16 . -1) (undo-tree-id17 . -8) (undo-tree-id18 . -8) (undo-tree-id19 . -8)) (26803 19850 931771 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15834 . 15835) (nil fontified nil 15811 . 15835) (15811 . 15835)) nil (26803 20052 415143 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15835 . 15836) (nil fontified nil 15812 . 15836) (15812 . 15836)) ((#(":timestamps ',timestamps" 0 11 (face font-lock-builtin-face fontified nil) 11 23 (fontified nil) 23 24 (rear-nonsticky nil fontified nil)) . 15812) (undo-tree-id10 . -24) (nil rear-nonsticky t 15835 . 15836)) (26803 19850 931721 0) 0 nil])
([nil nil ((7908 . 7911) (#(" " 0 1 (fontified nil)) . 7907) (undo-tree-id33 . -1) (7908 . 7909)) nil (26803 20052 415143 0) 0 nil])
nil
([nil nil ((7920 . 7924)) nil (26803 20052 415141 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7947 . 7948) (nil fontified nil 7924 . 7948) (7924 . 7948)) nil (26803 20052 415141 0) 0 nil])
([nil nil ((7895 . 7896)) nil (26803 20052 415140 0) 0 nil])
([nil nil ((8167 . 8171)) nil (26803 20052 415140 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8281 . 8282) (nil fontified nil 8171 . 8282) (8171 . 8282)) nil (26803 20052 415197 0) 0 nil])
([nil nil ((8283 . 8284)) nil (26803 20796 340029 0) 0 nil] [nil nil ((#(")" 0 1 (fontified t)) . -8450) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) 8451) ((8450 . 8451)) (26803 20052 415136 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 8220)) nil (26803 20796 340028 0) 0 nil])
nil
([nil nil ((8221 . 8224) (#("             " 0 13 (fontified nil)) . 8221) (8220 . 8221)) nil (26803 20796 340028 0) 0 nil])
([nil nil ((8274 . 8280)) nil (26803 20796 340027 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8679 . 8680) (nil fontified nil 8280 . 8680) (8280 . 8680)) nil (26803 20796 340027 0) 0 nil])
([nil nil ((8680 . 8682)) nil (26803 20796 340026 0) 0 nil])
([nil nil ((8682 . 8684)) nil (26803 20796 340026 0) 0 nil])
([nil nil ((#("      " 0 6 (face font-lock-comment-face fontified nil)) . -8814) (8852 . 8853)) nil (26803 20796 340025 0) 0 nil])
([nil nil ((8847 . 8849)) nil (26803 20796 340025 0) 0 nil])
([nil nil ((8849 . 8850)) nil (26803 20796 340024 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 8849)) nil (26803 20796 340023 0) 0 nil])
([nil nil ((10431 . 10432)) nil (26803 20796 340023 0) 0 nil])
([nil nil ((10448 . 10452) (#(" " 0 1 (fontified nil)) . 10448) (10447 . 10448)) nil (26803 20796 340022 0) 0 nil])
([nil nil ((10457 . 10462)) nil (26803 20796 340022 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10485 . 10486) (nil fontified nil 10462 . 10486) (10462 . 10486)) nil (26803 20796 340021 0) 0 nil])
([nil nil ((10609 . 10611)) nil (26803 20796 340021 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10653 . 10654) (nil fontified nil 10611 . 10654) (10611 . 10654)) nil (26803 20796 340020 0) 0 nil])
([nil nil ((10806 . 10810)) nil (26803 20796 340020 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10891 . 10892) (nil fontified nil 10810 . 10892) (10810 . 10892)) nil (26803 20799 399034 0) 0 nil])
([nil nil ((#("(if (eq col pk)
                (setf where (format nil \"~a = ~a\" (%ident col) (funcall emit val)))
                (progn
                  (push (format nil \"~a = ~a\" (%ident col) (funcall emit val)) assigns)))))" 0 1 (fontified t) 1 3 (face font-lock-keyword-face fontified t) 3 56 (fontified t) 56 65 (face font-lock-string-face fontified t) 65 117 (fontified t) 117 122 (face font-lock-keyword-face fontified t) 122 159 (fontified t) 159 168 (face font-lock-string-face fontified t) 168 212 (fontified t) 212 214 (fontified t)) . -10906) (undo-tree-id65 . -214) 11120) nil (26803 24726 740111 0) 0 nil] [nil nil ((#("(if (eq col pk)
                (setf where (format nil \"~a = ~a\" (%ident col) (funcall emit val)))
                (progn
                  (push (format nil \"~a = ~a\" (%ident col) (funcall emit val)) assigns)))" 0 1 (fontified t) 1 3 (face font-lock-keyword-face fontified t) 3 56 (fontified t) 56 65 (face font-lock-string-face fontified t) 65 117 (fontified t) 117 122 (face font-lock-keyword-face fontified t) 122 159 (fontified t) 159 168 (face font-lock-string-face fontified t) 168 212 (fontified t)) . -10906) (undo-tree-id34 . -212) (undo-tree-id35 . -212) (undo-tree-id36 . -212) (undo-tree-id37 . -212) (undo-tree-id38 . -123) (undo-tree-id39 . -212) (undo-tree-id40 . -212) (undo-tree-id41 . -212) (undo-tree-id42 . -212) 11118) ((10906 . 11118)) (26803 20796 340083 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11440 . 11441) (nil fontified nil 10906 . 11441) (10906 . 11441)) nil (26803 24726 740109 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11440 . 11441) (nil fontified nil 10906 . 11441) (10906 . 11441)) ((#("(cond
          (is-pk
           (setf where (format nil \"~a = ~a\" (%ident col) (funcall emit val))))
          (is-updated
           (if (null val)
               ;; Forcer updated à NOW au niveau SQL (sans param)
               (push (format nil \"~a = CURRENT_TIMESTAMP\" (%ident col)) assigns)
               ;; sinon paramétrer la valeur fournie
               (push (format nil \"~a = ~a\" (%ident col) (funcall emit val)) assigns)))
          (t
           (push (format nil \"~a = ~a\" (%ident col) (funcall emit val)) assigns)))))" 0 1 (fontified nil) 1 5 (face font-lock-keyword-face fontified nil) 5 58 (fontified nil) 58 67 (face font-lock-string-face fontified nil) 67 137 (fontified nil) 137 139 (face font-lock-keyword-face fontified nil) 139 166 (fontified nil) 166 169 (face font-lock-comment-delimiter-face fontified nil) 169 217 (face font-lock-comment-face fontified nil) 217 250 (fontified nil) 250 274 (face font-lock-string-face fontified nil) 274 313 (fontified nil) 313 316 (face font-lock-comment-delimiter-face fontified nil) 316 351 (face font-lock-comment-face fontified nil) 351 384 (fontified nil) 384 393 (face font-lock-string-face fontified nil) 393 451 (fontified nil) 451 480 (fontified nil) 480 489 (face font-lock-string-face fontified nil) 489 534 (fontified nil) 534 535 (rear-nonsticky nil fontified nil)) . 10906) (undo-tree-id43 . -451) (nil fontified t 11299 . 11357) (nil fontified t 11290 . 11299) (nil fontified t 11257 . 11290) (nil fontified t 11222 . 11257) (nil fontified t 11219 . 11222) (nil fontified t 11180 . 11219) (nil fontified t 11156 . 11180) (nil fontified t 11123 . 11156) (nil fontified t 11075 . 11123) (nil fontified t 11072 . 11075) (nil fontified t 11045 . 11072) (nil fontified t 11043 . 11045) (nil fontified t 10973 . 11043) (nil fontified t 10964 . 10973) (nil fontified t 10911 . 10964) (nil fontified t 10907 . 10911) (nil fontified t 10906 . 10907) (nil rear-nonsticky t 11440 . 11441)) (26803 20796 340002 0) 0 nil])
([nil nil ((12716 . 12717)) nil (26803 24726 740108 0) 0 nil])
nil
([nil nil ((8883 . 8884) (8880 . 8882) (8837 . 8839) (#("      " 0 6 (face font-lock-comment-face fontified t)) . -8813) (8802 . 8804) (#("    " 0 4 (face font-lock-comment-face fontified t)) . -8733) (8683 . 8687) (8643 . 8647) (8625 . 8629) (8606 . 8610) (8577 . 8578) (#("  " 0 2 (fontified nil)) . 8577) (8545 . 8549) (8526 . 8530) (8497 . 8498) (#("  " 0 2 (fontified nil)) . 8497) (8465 . 8469) (8445 . 8449) (8392 . 8396) (8311 . 8315) (7926 . 7927) (7912 . 7913) 7086) nil (26803 24726 740107 0) 0 nil])
([nil nil ((11375 . 11379) (11357 . 11361) (11270 . 11275) (#("               " 0 15 (fontified t)) . 11270) (11227 . 11232) (#("               " 0 15 (fontified t)) . 11227) (11156 . 11161) (#("               " 0 15 (fontified t)) . 11156) (11100 . 11105) (#("               " 0 15 (fontified t)) . 11100) (11081 . 11085) (11054 . 11058) (10971 . 10975) (10949 . 10953) (10867 . 10870) (#("             " 0 13 (fontified t)) . 10867) 10117) nil (26803 24726 740104 0) 0 nil])
([nil nil ((3553 . 3555)) nil (26803 24726 740103 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3886 . 3887) (nil fontified nil 3555 . 3887) (3555 . 3887)) nil (26803 24726 740103 0) 0 nil])
([nil nil ((#("
(defun %timestamps-of (metadata)
  \"Retourne plist :created <kw> :updated <kw>. NIL si non configuré.\"
  (let ((ts (getf metadata :timestamps)))
    (when ts
      (list :created (or (getf ts :created) :created_at)
            :updated (or (getf ts :updated) :updated_at)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 22 (face font-lock-function-name-face fontified t) 22 36 (fontified t) 36 103 (face font-lock-doc-face fontified t) 103 107 (fontified t) 107 110 (face font-lock-keyword-face fontified t) 110 131 (fontified t) 131 142 (face font-lock-builtin-face fontified t) 142 151 (fontified t) 151 155 (face font-lock-keyword-face fontified t) 155 171 (fontified t) 171 179 (face font-lock-builtin-face fontified t) 179 193 (fontified t) 193 201 (face font-lock-builtin-face fontified t) 201 203 (fontified t) 203 214 (face font-lock-builtin-face fontified t) 214 216 (fontified t) 216 228 (fontified t) 228 236 (face font-lock-builtin-face fontified t) 236 250 (fontified t) 250 258 (face font-lock-builtin-face fontified t) 258 260 (fontified t) 260 271 (face font-lock-builtin-face fontified t) 271 277 (fontified t)) . 3277) (undo-tree-id63 . -277) (undo-tree-id64 . -276)) nil (26803 24726 740102 0) 0 nil])
([nil nil ((#("(let* ((cols '())
	   (phs '())
	   (ts (%timestamps-of md)))
      (multiple-value-bind (emit params-f) (%make-param-emitter)
        (dolist (f fields)
          (let* ((col (getf f :col))
                 (slot (getf f :slot))
                 (val (%slot-value entity slot))
		 (is-created (and ts (eq col (getf ts :created))))
		 (is-updated (and ts (eq col (getf ts :updated)))))
	    ;; Stratégie INSERT:
            ;; - Si created/updated sont NIL, on NE les inclut PAS → DEFAULT DB.
            ;; - Sinon on les paramètre normalement.
            (cond
              ((and is-created (null val)) ; skip → DEFAULT
               nil)
              ((and is-updated (null val)) ; skip → DEFAULT
               nil)
              (t
               (push (%ident col) cols)
               (push (funcall emit val) phs)))))
	#|
        (when (or (not (eq col pk)) (not (null val))) ; inclure pk si non-nil ;
        (push (%ident col) cols)	;
        (push (funcall emit val) phs)))) ;
	|#
        (let* ((cols* (nreverse cols))
               (phs*  (nreverse phs))
               (returning-sql (cond
                                ((eq returning t) \" returning *\")
                                ((and (listp returning) (every #'keywordp returning))
                                 (format nil \" returning ~{~a~^, ~}\"
                                         (mapcar #'%ident returning)))
                                ((null returning) \"\")
                                (t \" returning *\")))
               (sql (format nil \"insert into ~a (~{~a~^, ~}) values (~{~a~^, ~})~a\"
                            table cols* phs* returning-sql)))
          (multiple-value-bind (affected ret)
              (apply #'lumen.data.db:exec sql (funcall params-f))
            (declare (ignore affected))
            (let ((row (or ret
                           (and (not (null returning))
                                ;; si RETURNING demandé mais pas renvoyé par exec (fallback)
                                (apply #'lumen.data.db:query-1a sql
				       (funcall params-f))))))
              (let ((new (if row (row->entity class row) entity)))
                (after-insert entity new)
                new))))))))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 18 (fontified t) 18 32 (fontified t) 32 36 (fontified t) 36 59 (fontified t) 59 60 (fontified t rear-nonsticky t) 60 62 (fontified t) 62 69 (fontified t) 69 88 (face font-lock-keyword-face fontified t) 88 136 (fontified t) 136 142 (face font-lock-keyword-face fontified t) 142 165 (fontified t) 165 169 (face font-lock-keyword-face fontified t) 169 184 (fontified t) 184 188 (face font-lock-builtin-face fontified t) 188 222 (fontified t) 222 227 (face font-lock-builtin-face fontified t) 227 230 (fontified t) 230 237 (fontified t) 237 279 (fontified t) 279 282 (fontified t) 282 319 (fontified t) 319 327 (face font-lock-builtin-face fontified t) 327 332 (fontified t) 332 335 (fontified t) 335 372 (fontified t) 372 380 (face font-lock-builtin-face fontified t) 380 382 (fontified t) 382 383 (fontified t rear-nonsticky t) 383 386 (fontified t) 386 391 (fontified t) 391 394 (face font-lock-comment-delimiter-face fontified t) 394 412 (face font-lock-comment-face fontified t) 412 424 (fontified t) 424 427 (face font-lock-comment-delimiter-face fontified t) 427 493 (face font-lock-comment-face fontified t) 493 505 (fontified t) 505 508 (face font-lock-comment-delimiter-face fontified t) 508 546 (face font-lock-comment-face fontified t) 546 559 (fontified t) 559 563 (face font-lock-keyword-face fontified t) 563 564 (fontified t) 564 607 (fontified t) 607 624 (face font-lock-comment-face fontified t) 624 644 (fontified t) 644 687 (fontified t) 687 704 (face font-lock-comment-face fontified t) 704 724 (fontified t) 724 741 (fontified t) 741 781 (fontified t) 781 828 (fontified t) 828 829 (fontified t rear-nonsticky t) 829 830 (fontified t) 830 831 (fontified t) 831 833 (face font-lock-comment-face fontified t) 833 834 (face font-lock-comment-face fontified t) 834 843 (face font-lock-comment-face fontified t) 843 847 (face font-lock-comment-face fontified t) 847 888 (face font-lock-comment-face fontified t) 888 911 (face font-lock-comment-face fontified t) 911 912 (face font-lock-comment-face fontified t) 912 913 (face font-lock-comment-face fontified t) 913 914 (face font-lock-comment-face fontified t) 914 947 (face font-lock-comment-face fontified t) 947 948 (face font-lock-comment-face fontified t) 948 949 (face font-lock-comment-face fontified t) 949 988 (face font-lock-comment-face fontified t) 988 989 (face font-lock-comment-face fontified t) 989 990 (face font-lock-comment-face fontified t) 990 991 (face font-lock-comment-face fontified t) 991 993 (face font-lock-comment-face fontified t) 993 995 (face font-lock-comment-delimiter-face fontified t) 995 996 (fontified t) 996 1005 (fontified t) 1005 1009 (face font-lock-keyword-face fontified t) 1009 1104 (fontified t) 1104 1108 (face font-lock-keyword-face fontified t) 1108 1159 (fontified t) 1159 1173 (face font-lock-string-face fontified t) 1173 1187 (fontified t) 1187 1261 (fontified t) 1261 1306 (fontified t) 1306 1329 (face font-lock-string-face fontified t) 1329 1403 (fontified t) 1403 1451 (fontified t) 1451 1453 (face font-lock-string-face fontified t) 1453 1455 (fontified t) 1455 1490 (fontified t) 1490 1504 (face font-lock-string-face fontified t) 1504 1540 (fontified t) 1540 1591 (face font-lock-string-face fontified t) 1591 1665 (fontified t) 1665 1684 (face font-lock-keyword-face fontified t) 1684 1700 (fontified t) 1700 1723 (fontified t) 1723 1735 (fontified t) 1735 1736 (fontified t rear-nonsticky t) 1736 1737 (fontified t) 1737 1766 (fontified t) 1766 1779 (fontified t) 1779 1786 (face font-lock-keyword-face fontified t) 1786 1819 (fontified t) 1819 1822 (face font-lock-keyword-face fontified t) 1822 1924 (fontified t) 1924 1927 (face font-lock-comment-delimiter-face fontified t) 1927 1985 (face font-lock-comment-face fontified t) 1985 2026 (fontified t) 2026 2038 (fontified t) 2038 2039 (fontified t rear-nonsticky t) 2039 2040 (fontified t) 2040 2068 (fontified t) 2068 2088 (fontified t) 2088 2103 (fontified t) 2103 2106 (face font-lock-keyword-face fontified t) 2106 2110 (fontified t) 2110 2114 (fontified t) 2114 2116 (face font-lock-keyword-face fontified t) 2116 2155 (fontified t) 2155 2197 (fontified t) 2197 2224 (fontified t)) . -7948) (undo-tree-id60 . -834) (undo-tree-id61 . -2224) (undo-tree-id62 . -1109) 10172) nil (26803 24726 740100 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10455 . 10456) (nil fontified nil 7948 . 10456) (7948 . 10456)) nil (26803 24726 740098 0) 0 nil])
([nil nil ((10456 . 10458)) nil (26803 24726 740098 0) 0 nil])
([nil nil ((10285 . 10287) (#("            " 0 12 (fontified t)) . 10285) (10257 . 10259) (#("            " 0 12 (fontified t)) . 10257) (10200 . 10204) (10140 . 10144) (#("                            " 0 28 (fontified t)) . 10140) (10106 . 10112) (#("                       " 0 23 (fontified t)) . 10106) (10083 . 10087) (10043 . 10047) (9993 . 9997) (9944 . 9947) (#("      " 0 6 (fontified t)) . 9944) (9900 . 9904) (9811 . 9815) (9775 . 9779) (#("                            " 0 28 (fontified t)) . 9775) (9749 . 9753) (#("                            " 0 28 (fontified t)) . 9749) (9678 . 9683) (#("                             " 0 29 (fontified t)) . 9678) (9620 . 9624) (#("                            " 0 28 (fontified t)) . 9620) (9582 . 9586) (#("                            " 0 28 (fontified t)) . 9582) (9557 . 9561) (9405 . 9409) (9337 . 9341) (9247 . 9251) (9208 . 9212) (9165 . 9166) (#("    " 0 4 (fontified t)) . 9165) (9126 . 9130) (9086 . 9090) (9068 . 9072) (8986 . 8990) (8953 . 8957) (8913 . 8917) (8869 . 8873) (8836 . 8840) (8796 . 8800) (8752 . 8756) (8671 . 8675) (8625 . 8628) (#("             " 0 13 (fontified t)) . 8625) (8597 . 8600) (#("             " 0 13 (fontified t)) . 8597) (8583 . 8587) (8555 . 8559) (8481 . 8485) (8461 . 8465) (8399 . 8402) (#("             " 0 13 (fontified t)) . 8399) (8346 . 8349) (#("             " 0 13 (fontified t)) . 8346) (8310 . 8313) (#("             " 0 13 (fontified t)) . 8310) (8285 . 8288) (#("             " 0 13 (fontified t)) . 8285) (8254 . 8257) (#("      " 0 6 (fontified t)) . 8254) (8234 . 8235) (#("    " 0 4 (fontified t)) . 8234) (8171 . 8175) (8153 . 8157) (#("       " 0 7 (fontified t)) . 8153) (8138 . 8142) (#("       " 0 7 (fontified t)) . 8138) (8070 . 8074) (#("       " 0 7 (fontified t)) . 8070) (8025 . 8029) (#("       " 0 7 (fontified t)) . 8025) (7980 . 7984) (#("       " 0 7 (fontified t)) . 7980) 7143) nil (26803 24726 740095 0) 0 nil])
([nil nil ((10706 . 10711)) nil (26803 24726 740089 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10768 . 10769) (nil fontified nil 10711 . 10769) (10711 . 10769)) nil (26803 24726 740089 0) 0 nil])
([nil nil ((#("(push (format nil \"~a = CURRENT_TIMESTAMP\" (%ident col)) assigns)" 0 18 (fontified t) 18 42 (face font-lock-string-face fontified t) 42 65 (fontified t)) . -11407) (undo-tree-id59 . -65) 11472) nil (26803 24726 740088 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11462 . 11463) (nil fontified nil 11407 . 11463) (11407 . 11463)) nil (26803 24726 740087 0) 0 nil])
([nil nil ((#("(push (format nil \"~a = ~a\" (%ident col) (funcall emit val)) assigns)" 0 18 (fontified t) 18 27 (face font-lock-string-face fontified t) 27 69 (fontified t)) . -11512) (undo-tree-id58 . -69) 11581) nil (26803 24726 740086 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11581 . 11582) (nil fontified nil 11512 . 11582) (11512 . 11582)) nil (26803 24726 740085 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -11583) (undo-tree-id57 . -1) 11584) nil (26803 24726 740084 0) 0 nil])
([nil nil ((17134 . 17135)) nil (26803 24726 740083 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19040 . 19041) (nil fontified nil 17135 . 19041) (17135 . 19041)) nil (26803 24726 740083 0) 0 nil])
([nil nil ((19041 . 19042)) nil (26803 24726 740082 0) 0 nil])
([nil nil ((19042 . 19045)) nil (26803 24726 740082 0) 0 nil])
([nil nil ((19045 . 19046)) nil (26803 24726 740082 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19107 . 19108) (nil fontified nil 19046 . 19108) (19046 . 19108)) nil (26803 24726 740081 0) 0 nil])
([nil nil ((19108 . 19109)) nil (26803 24726 740081 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19771 . 19772) (nil fontified nil 19109 . 19772) (19109 . 19772)) nil (26803 24726 740080 0) 0 nil])
([nil nil ((19772 . 19773)) nil (26803 24726 740080 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20400 . 20401) (nil fontified nil 19773 . 20401) (19773 . 20401)) nil (26803 24726 740079 0) 0 nil])
([nil nil ((19772 . 19773)) nil (26803 24726 740079 0) 0 nil])
([nil nil ((19773 . 19776)) nil (26803 24726 740078 0) 0 nil])
([nil nil ((19776 . 19777)) nil (26803 24726 740078 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19845 . 19846) (nil fontified nil 19777 . 19846) (19777 . 19846)) nil (26803 24726 740077 0) 0 nil])
([nil nil ((#("si tu utilises" 0 14 (face font-lock-comment-face fontified t)) . -19812) (undo-tree-id56 . -14) 19826) nil (26803 24726 740077 0) 0 nil])
([nil nil ((19812 . 19816)) nil (26803 24726 740076 0) 0 nil])
([nil nil ((6828 . 6830)) nil (26803 24726 740075 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7237 . 7238) (nil fontified nil 6830 . 7238) (6830 . 7238)) nil (26803 24726 740075 0) 0 nil])
([nil nil ((6493 . 6494)) nil (26803 24726 740074 0) 0 nil])
([nil nil ((6494 . 6496)) nil (26803 24726 740074 0) 0 nil])
([nil nil ((6832 . 6834)) nil (26803 24726 740073 0) 0 nil])
([nil nil ((6834 . 6835)) nil (26803 24726 740073 0) 0 nil])
([nil nil ((8725 . 8729)) nil (26803 24726 740073 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8749 . 8750) (nil fontified nil 8729 . 8750) (8729 . 8750)) nil (26803 24726 740072 0) 0 nil])
([nil nil ((#("val" 0 3 (fontified t)) . -9089) (undo-tree-id55 . -3) 9092) nil (26803 24726 740071 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9107 . 9108) (nil fontified nil 9089 . 9108) (9089 . 9108)) nil (26803 24726 740068 0) 0 nil])
([nil nil ((#("val" 0 3 (fontified t)) . -9607) (undo-tree-id54 . -3) 9610) nil (26803 24726 740067 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9625 . 9626) (nil fontified nil 9607 . 9626) (9607 . 9626)) nil (26803 24726 740066 0) 0 nil])
([nil nil ((11562 . 11566)) nil (26803 24726 740066 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11586 . 11587) (nil fontified nil 11566 . 11587) (11566 . 11587)) nil (26803 24726 740065 0) 0 nil])
([nil nil ((#("val" 0 3 (fontified t)) . -11780) (undo-tree-id53 . -3) 11783) nil (26803 24726 740065 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11798 . 11799) (nil fontified nil 11780 . 11799) (11780 . 11799)) nil (26803 24726 740064 0) 0 nil])
([nil nil ((11766 . 11773) (#(" " 0 1 (fontified nil)) . 11765) (undo-tree-id52 . -1) (11766 . 11767)) nil (26803 24726 740063 0) 0 nil])
([nil nil ((#("val" 0 3 (fontified t)) . -12088) (undo-tree-id51 . -3) 12091) nil (26803 24726 740062 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12106 . 12107) (nil fontified nil 12088 . 12107) (12088 . 12107)) nil (26803 24726 740061 0) 0 nil])
([nil nil ((12074 . 12079) (#(" " 0 1 (fontified nil)) . 12073) (undo-tree-id50 . -1) (12074 . 12075)) nil (26803 24726 740060 0) 0 nil])
([nil nil ((#("val" 0 3 (fontified t)) . -12213) (undo-tree-id49 . -3) 12216) nil (26803 24726 740059 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12231 . 12232) (nil fontified nil 12213 . 12232) (12213 . 12232)) nil (26803 24726 740058 0) 0 nil])
([nil nil ((12213 . 12222) (#(" " 0 1 (fontified nil)) . 12212) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (12213 . 12214)) nil (26803 24726 740057 0) 0 nil])
([nil nil ((12115 . 12119) (#(" " 0 1 (fontified nil)) . 12114) (undo-tree-id46 . -1) (12115 . 12116)) nil (26803 24726 740055 0) 0 nil])
([nil nil ((12248 . 12255) (#(" " 0 1 (fontified nil)) . 12248) (12247 . 12248)) nil (26803 24726 740054 0) 0 nil])
([nil nil ((20350 . 20351)) nil (26803 24726 740053 0) 0 nil])
([nil nil ((20351 . 20372)) nil (26803 24726 740053 0) 0 nil])
([nil nil ((20372 . 20393)) nil (26803 24726 740052 0) 0 nil])
([nil nil ((20393 . 20412)) nil (26803 24726 740052 0) 0 nil])
([nil nil ((20476 . 20477)) nil (26803 24726 740051 0) 0 nil])
([nil nil ((20477 . 20479)) nil (26803 24726 740051 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -20478) (undo-tree-id45 . -1) 20479) nil (26803 24726 740050 0) 0 nil])
([nil nil ((20478 . 20479)) nil (26803 24726 740049 0) 0 nil])
([nil nil ((20479 . 20500)) nil (26803 24726 740048 0) 0 nil])
([nil nil ((20500 . 20521)) nil (26803 24726 740048 0) 0 nil])
([nil nil ((20521 . 20539)) nil (26803 24726 740048 0) 0 nil])
([nil nil ((#("#+local-time (setf *ts-encode*
                   (lambda (lt) (local-time:format-timestring nil lt :format local-time:+iso-8601-format+))
                   *ts-decode*
                   (lambda (s) (etypecase s
                                 (string (local-time:parse-timestring s))
                                 (t s))))
#+yason (setf *json-encode* (lambda (x) (with-output-to-string (s) (yason:encode x s)))
          *json-decode* (lambda (s) (yason:parse s)))
;; réenregistrer:
(def-type-codec :jsonb :encode *json-encode* :decode *json-decode*)
(def-type-codec :timestamptz :encode *ts-encode* :decode *ts-decode*)
" 0 329 (face slime-reader-conditional-face fontified t) 329 330 (fontified t) 330 471 (face slime-reader-conditional-face fontified t) 471 472 (fontified t) 472 475 (face font-lock-comment-delimiter-face fontified t) 475 490 (face font-lock-comment-face fontified t) 490 506 (fontified t) 506 512 (face font-lock-builtin-face fontified t) 512 513 (fontified t) 513 520 (face font-lock-builtin-face fontified t) 520 535 (fontified t) 535 542 (face font-lock-builtin-face fontified t) 542 574 (fontified t) 574 586 (face font-lock-builtin-face fontified t) 586 587 (fontified t) 587 594 (face font-lock-builtin-face fontified t) 594 607 (fontified t) 607 614 (face font-lock-builtin-face fontified t) 614 627 (fontified t) 627 628 (fontified t rear-nonsticky t)) . -20540) (undo-tree-id44 . -628) 21168) nil (26803 24726 740046 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21576 . 21577) (nil fontified nil 20540 . 21577) (20540 . 21577)) nil (26803 24726 740034 0) 0 nil])
([nil nil ((3610 . 3612) (t 26803 24726 0 0)) nil (26803 25238 397879 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4197 . 4198) (nil fontified nil 3612 . 4198) (3612 . 4198)) nil (26803 25238 397879 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -4197) (undo-tree-id68 . -1) 4198) nil (26803 25238 397878 0) 0 nil])
([nil nil ((15282 . 15283)) nil (26803 25238 397877 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15370 . 15371) (nil fontified nil 15283 . 15371) (15283 . 15371)) nil (26803 25238 397876 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17580 . 17581) (nil fontified nil 17407 . 17581) (17407 . 17581)) nil (26803 25238 397876 0) 0 nil])
([nil nil ((17974 . 17975)) nil (26803 25238 397875 0) 0 nil])
([nil nil ((17974 . 17976) (#("  " 0 2 (fontified nil)) . -17959) (17975 . 17976)) nil (26803 25238 397875 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18385 . 18386) (nil fontified nil 17976 . 18386) (17976 . 18386)) nil (26803 25238 397874 0) 0 nil])
([nil nil ((18959 . 18966) (#("       " 0 7 (fontified nil)) . 18958) (undo-tree-id67 . -7) (18957 . 18966)) nil (26803 25238 397873 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19238 . 19239) (nil fontified nil 18966 . 19239) (18966 . 19239)) nil (26803 25238 397871 0) 0 nil])
([nil nil ((19223 . 19226) (#("   " 0 3 (fontified t)) . 19223) (19193 . 19196) (#("          " 0 10 (fontified t)) . 19193) (19167 . 19170) (#("          " 0 10 (fontified t)) . 19167) (19112 . 19119) (#("       " 0 7 (fontified t)) . 19112) (19073 . 19078) (#("     " 0 5 (fontified t)) . 19073) (19057 . 19060) (#("   " 0 3 (fontified t)) . 19057) (19040 . 19047) (18379 . 18382) (18342 . 18345) (18274 . 18277) (18147 . 18150) (18090 . 18093) (18049 . 18052) (18023 . 18025) (#("      " 0 6 (fontified t)) . 18023) (17951 . 17954) (17916 . 17917) (17771 . 17772) (17658 . 17661) (#("                       " 0 17 (fontified t) 17 23 (fontified t)) . 17658) (17631 . 17632) (17587 . 17590) (17443 . 17446) (17424 . 17427) 15372) nil (26803 25238 397869 0) 0 nil])
([nil nil ((14130 . 14132)) nil (26803 25238 397867 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17841 . 17842) (nil fontified nil 14132 . 17842) (14132 . 17842)) nil (26803 25238 397866 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -17841) (undo-tree-id66 . -1) 17842) nil (26803 25238 397865 0) 0 nil])
([nil nil ((11359 . 11360)) nil (26803 25238 397856 0) 0 nil])
([nil nil ((11360 . 11362)) nil (26803 25238 397855 0) 0 nil])
([nil nil ((14134 . 14136)) nil (26803 25238 397854 0) 0 nil])
([nil nil ((14136 . 14137)) nil (26803 25238 397851 0) 0 nil])
([nil nil ((4197 . 4199) (t 26803 25238 0 0)) nil (26803 25395 172915 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5041 . 5042) (nil fontified nil 4199 . 5042) (4199 . 5042)) nil (26803 25395 172915 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -5041) (undo-tree-id74 . -1) 5042) nil (26803 25395 172914 0) 0 nil])
([nil nil ((4197 . 4199)) nil (26803 25395 172913 0) 0 nil])
([nil nil ((4199 . 4207)) nil (26803 25395 172912 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-comment-face fontified t)) . -4202) (undo-tree-id69 . -1) (#(")" 0 1 (face font-lock-comment-face fontified t)) . -4203) (undo-tree-id70 . -1) (#(")" 0 1 (face font-lock-comment-face fontified t)) . -4204) (undo-tree-id71 . -1) (#(")" 0 1 (face font-lock-comment-face fontified t)) . -4205) (undo-tree-id72 . -1) (#(")" 0 1 (face font-lock-comment-face fontified t)) . -4206) (undo-tree-id73 . -1) 4207) nil (26803 25395 172911 0) 0 nil])
([nil nil ((4202 . 4217)) nil (26803 25395 172899 0) 0 nil])
([nil nil ((4217 . 4218)) nil (26803 25395 172899 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4249 . 4250) (nil fontified nil 4218 . 4250) (4218 . 4250)) nil (26803 25395 172897 0) 0 nil])
([nil nil ((4031 . 4032)) nil (26803 25395 172894 0) 0 nil])
([nil nil ((1839 . 1841) (t 26803 25395 0 0)) nil (26803 30583 789755 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2765 . 2766) (nil fontified nil 1841 . 2766) (1841 . 2766)) nil (26803 30583 789754 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -2765) (undo-tree-id76 . -1) 2766) nil (26803 30583 789753 0) 0 nil])
([nil nil ((2227 . 2228)) nil (26803 30583 789750 0) 0 nil])
([nil nil ((#("b" 0 1 (face font-lock-doc-face fontified t)) . -2227) (undo-tree-id75 . -1) 2228) nil (26803 30583 789747 0) 0 nil])
([nil nil ((19671 . 19672) (t 26803 30583 0 0)) nil (26803 30606 949914 0) 0 nil])
([nil nil ((#("      " 0 6 (fontified t)) . -16779) 15962 (t 26803 30606 0 0)) nil (26803 30613 463021 0) 0 nil])
([nil nil ((20972 . 20973) (t 26803 30613 0 0)) nil (26803 33324 42224 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20995 . 20996) (nil fontified nil 20973 . 20996) (20973 . 20996)) nil (26803 33324 42223 0) 0 nil])
([nil nil ((20973 . 20980) (#(" " 0 1 (fontified nil)) . 20972) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (20973 . 20974)) nil (26803 33324 42222 0) 0 nil])
([nil nil ((24531 . 24537)) nil (26803 33324 42221 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24590 . 24591) (nil fontified nil 24537 . 24591) (24537 . 24591)) nil (26803 33324 42220 0) 0 nil])
([nil nil ((#("
#|
(defmethod entity-update! ((entity standard-object) &key (returning t))
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields)))
    ;; Validate avant update
    (validate-entity! entity)
    (let* ((assigns '())
	   where
	   (ts (%timestamps-of md))
	   (ts-fn (or (and ts (getf ts :db-fn)) \"CURRENT_TIMESTAMP\")))
      (multiple-value-bind (emit params-f) (%make-param-emitter)
        ;; SET col = $n pour toutes les colonnes sauf PK
	;; mais updated = CURRENT_TIMESTAMP si NIL.
        (dolist (f fields)
          (let* ((col (getf f :col))
                 (slot (getf f :slot))
                 (val (%slot-value entity slot))
		 (ty   (getf f :type))
		 (is-pk (eq col pk))
		 (is-updated (and ts (eq col (getf ts :updated)))))
            (cond
              (is-pk
               (setf where (format nil \"~a = ~a\" (%ident col)
				   (funcall emit (coerce-out val ty)))))
              (is-updated
               (if (null val)
		   ;; Forcer updated à NOW au niveau SQL (sans param)
		   (push (format nil \"~a = ~a\" (%ident col) ts-fn) assigns)
		   ;; sinon paramétrer la valeur fournie
		   (push (format nil \"~a = ~a\" (%ident col)
				 (funcall emit (coerce-out val ty)))
			 assigns)))
              (t
               (push (format nil \"~a = ~a\" (%ident col) (funcall emit
								 (coerce-out val ty)))
		     assigns)))))
        (unless where (error \"Primary key manquante (~a) pour UPDATE\" pk))
        (let* ((assigns* (nreverse assigns))
               (set-sql (if (null assigns*) \"/* no-op */\" (%comma-join assigns*)))
               (returning-sql (cond
                                ((eq returning t) \" returning *\")
                                ((and (listp returning) (every #'keywordp returning))
                                 (format nil \" returning ~{~a~^, ~}\"
                                         (mapcar #'%ident returning)))
                                ((null returning) \"\")
                                (t \" returning *\")))
               (sql (format nil \"update ~a set ~a where ~a~a\"
                            table set-sql where returning-sql)))
          (before-update entity)
          (multiple-value-bind (affected ret)
              (apply #'lumen.data.db:exec sql (funcall params-f))
            (declare (ignore affected))
            (let ((row (or ret
                           (and (not (null returning))
                                (apply #'lumen.data.db:query-1a sql
				       (funcall params-f))))))
              (let ((new (if row (row->entity class row) entity)))
                (after-update entity new)
                new))))))))
|#

(defmethod entity-update! ((entity standard-object) &key (returning t) (patch nil))
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields)))
    ;; Validations avant update (toujours)
    (validate-entity! entity)
    (let ((assigns '()) where)
      (multiple-value-bind (emit params-f) (%make-param-emitter)
        (let* ((ts (%timestamps-of md))
               (ts-updated (and ts (getf ts :updated)))
               (ts-fn (or (and ts (getf ts :db-fn)) \"CURRENT_TIMESTAMP\"))
               ;; slots à considérer : si patch => dirty uniquement ; sinon tous
               (candidate-slots
                 (if patch (dirty-slots entity)
                     (mapcar (lambda (f) (getf f :slot)) fields))))
          (dolist (f fields)
            (let* ((col (getf f :col))
                   (slot (getf f :slot))
                   (ty   (getf f :type))
                   (val  (%slot-value entity slot))
                   (is-pk (eq col pk))
                   (is-up (and ts-updated (eq col ts-updated)))
                   (selected (member slot candidate-slots :test #'eq)))
              (cond
                ;; WHERE pk
                (is-pk
                 (setf where (format nil \"~a = ~a\" (%ident col) (funcall emit (coerce-out val ty)))))
                ;; Si patch : ignorer les slots non “dirty”
                ((and patch (not selected))
                 ;; mais on peut forcer updated plus bas
                 nil)
                ;; updated_at
                (is-up
                 (if (null val)
                     (push (format nil \"~a = ~a\" (%ident col) ts-fn) assigns)
                     (push (format nil \"~a = ~a\" (%ident col) (funcall emit (coerce-out val ty))) assigns)))
                ;; slot normal
                (t
                 (push (format nil \"~a = ~a\" (%ident col) (funcall emit (coerce-out val ty))) assigns)))))
          ;; En mode patch, si aucun assign sélectionné, mais on veut *toucher* updated_at: ajoute-le
          (when (and patch ts-updated (null (remove-if (lambda (x) (declare (ignore x)) nil) assigns)))
            (push (format nil \"~a = ~a\" (%ident ts-updated) ts-fn) assigns)))
        (unless where (error \"Primary key manquante (~a) pour UPDATE\" pk))
        (let* ((assigns* (nreverse assigns))
               (set-sql (if (null assigns*) \"/* no-op */\" (%comma-join assigns*)))
               (returning-sql (cond
                                ((eq returning t) \" returning *\")
                                ((and (listp returning) (every #'keywordp returning))
                                 (format nil \" returning ~{~a~^, ~}\"
                                         (mapcar #'%ident returning)))
                                ((null returning) \"\")
                                (t \" returning *\")))
               (sql (format nil \"update ~a set ~a where ~a~a\"
                            table set-sql where returning-sql)))
          (before-update entity)
          (multiple-value-bind (affected ret)
              (apply #'exec sql (funcall params-f))
            (declare (ignore affected))
            ;; l’UPDATE peut être “no-op” (SET /* no-op */), mais reste valide
            (let ((row (or ret (and (not (null returning)) (apply #'query-1a sql (funcall params-f))))))
              ;; l’entité résultante
              (let ((new (if row (row->entity class row) entity)))
                ;; clear dirty (on vient d’appliquer la vérité DB)
                (clear-dirty new)
                (after-update entity new)
                new))))))))" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 4 (face font-lock-comment-face fontified t) 4 5 (face font-lock-comment-face fontified t) 5 14 (face font-lock-comment-face fontified t) 14 15 (face font-lock-comment-face fontified t) 15 29 (face font-lock-comment-face fontified t) 29 56 (face font-lock-comment-face fontified t) 56 60 (face font-lock-comment-face fontified t) 60 79 (face font-lock-comment-face fontified t) 79 83 (face font-lock-comment-face fontified t) 83 106 (face font-lock-comment-face fontified t) 106 124 (face font-lock-comment-face fontified t) 124 195 (face font-lock-comment-face fontified t) 195 201 (face font-lock-comment-face fontified t) 201 231 (face font-lock-comment-face fontified t) 231 243 (face font-lock-comment-face fontified t) 243 245 (face font-lock-comment-face fontified t) 245 248 (face font-lock-comment-face fontified t) 248 274 (face font-lock-comment-face fontified t) 274 277 (face font-lock-comment-face fontified t) 277 284 (face font-lock-comment-face fontified t) 284 288 (face font-lock-comment-face fontified t) 288 292 (face font-lock-comment-face fontified t) 292 295 (face font-lock-comment-face fontified t) 295 317 (face font-lock-comment-face fontified t) 317 347 (face font-lock-comment-face fontified t) 347 352 (face font-lock-comment-face fontified t) 352 356 (face font-lock-comment-face fontified t) 356 369 (face font-lock-comment-face fontified t) 369 372 (face font-lock-comment-face fontified t) 372 382 (face font-lock-comment-face fontified t) 382 386 (face font-lock-comment-face fontified t) 386 401 (face font-lock-comment-face fontified t) 401 409 (face font-lock-comment-face fontified t) 409 410 (face font-lock-comment-face fontified t rear-nonsticky t) 410 411 (face font-lock-comment-face fontified t) 411 415 (face font-lock-comment-face fontified t) 415 443 (face font-lock-comment-face fontified t) 443 449 (face font-lock-comment-face fontified t) 449 452 (face font-lock-comment-face fontified t) 452 471 (face font-lock-comment-face fontified t) 471 472 (face font-lock-comment-face fontified t) 472 473 (face font-lock-comment-face fontified t rear-nonsticky t) 473 475 (face font-lock-comment-face fontified t) 475 482 (face font-lock-comment-face fontified t) 482 501 (face font-lock-comment-face fontified t) 501 527 (face font-lock-comment-face fontified t) 527 540 (face font-lock-comment-face fontified t) 540 548 (fontified t face font-lock-comment-face) 548 551 (fontified t face font-lock-comment-face) 551 597 (fontified t face font-lock-comment-face) 597 598 (fontified t face font-lock-comment-face) 598 601 (fontified t face font-lock-comment-face) 601 640 (fontified t face font-lock-comment-face) 640 641 (fontified t face font-lock-comment-face rear-nonsticky t) 641 642 (fontified t face font-lock-comment-face) 642 651 (fontified t face font-lock-comment-face) 651 657 (fontified t face font-lock-comment-face) 657 680 (fontified t face font-lock-comment-face) 680 684 (fontified t face font-lock-comment-face) 684 699 (fontified t face font-lock-comment-face) 699 703 (fontified t face font-lock-comment-face) 703 721 (fontified t face font-lock-comment-face) 721 737 (fontified t face font-lock-comment-face) 737 742 (fontified t face font-lock-comment-face) 742 745 (fontified t face font-lock-comment-face) 745 794 (fontified t face font-lock-comment-face) 794 797 (fontified t face font-lock-comment-face) 797 811 (fontified t face font-lock-comment-face) 811 816 (fontified t face font-lock-comment-face) 816 817 (fontified t face font-lock-comment-face) 817 818 (fontified t face font-lock-comment-face rear-nonsticky t) 818 819 (fontified t face font-lock-comment-face) 819 821 (fontified t face font-lock-comment-face) 821 822 (fontified t face font-lock-comment-face) 822 842 (fontified t face font-lock-comment-face) 842 845 (fontified t face font-lock-comment-face) 845 882 (fontified t face font-lock-comment-face) 882 890 (fontified t face font-lock-comment-face) 890 893 (fontified t face font-lock-comment-face) 893 894 (fontified t face font-lock-comment-face rear-nonsticky t) 894 896 (fontified t face font-lock-comment-face) 896 908 (fontified t face font-lock-comment-face) 908 909 (fontified t face font-lock-comment-face) 909 913 (fontified t face font-lock-comment-face) 913 914 (fontified t face font-lock-comment-face) 914 935 (fontified t face font-lock-comment-face) 935 974 (fontified t face font-lock-comment-face) 974 983 (fontified t face font-lock-comment-face) 983 1018 (fontified t face font-lock-comment-face) 1018 1036 (fontified t face font-lock-comment-face) 1036 1037 (fontified t face font-lock-comment-face rear-nonsticky t) 1037 1042 (fontified t face font-lock-comment-face) 1042 1068 (fontified t face font-lock-comment-face) 1068 1084 (fontified t face font-lock-comment-face) 1084 1086 (fontified t face font-lock-comment-face) 1086 1103 (fontified t face font-lock-comment-face) 1103 1106 (fontified t face font-lock-comment-face) 1106 1154 (fontified t face font-lock-comment-face) 1154 1159 (fontified t face font-lock-comment-face) 1159 1177 (fontified t face font-lock-comment-face) 1177 1186 (fontified t face font-lock-comment-face) 1186 1214 (fontified t face font-lock-comment-face) 1214 1215 (fontified t face font-lock-comment-face rear-nonsticky t) 1215 1216 (fontified t face font-lock-comment-face) 1216 1221 (fontified t face font-lock-comment-face) 1221 1224 (fontified t face font-lock-comment-face) 1224 1259 (fontified t face font-lock-comment-face) 1259 1264 (fontified t face font-lock-comment-face) 1264 1282 (fontified t face font-lock-comment-face) 1282 1291 (fontified t face font-lock-comment-face) 1291 1305 (fontified t face font-lock-comment-face) 1305 1324 (fontified t face font-lock-comment-face) 1324 1342 (fontified t face font-lock-comment-face) 1342 1343 (fontified t face font-lock-comment-face rear-nonsticky t) 1343 1350 (fontified t face font-lock-comment-face) 1350 1358 (fontified t face font-lock-comment-face) 1358 1359 (fontified t face font-lock-comment-face rear-nonsticky t) 1359 1360 (fontified t face font-lock-comment-face) 1360 1361 (fontified t face font-lock-comment-face) 1361 1378 (fontified t face font-lock-comment-face) 1378 1411 (fontified t face font-lock-comment-face) 1411 1420 (fontified t face font-lock-comment-face) 1420 1448 (fontified t face font-lock-comment-face) 1448 1457 (fontified t face font-lock-comment-face) 1457 1475 (fontified t face font-lock-comment-face) 1475 1476 (fontified t face font-lock-comment-face rear-nonsticky t) 1476 1486 (fontified t face font-lock-comment-face) 1486 1497 (fontified t face font-lock-comment-face) 1497 1498 (fontified t face font-lock-comment-face rear-nonsticky t) 1498 1499 (fontified t face font-lock-comment-face) 1499 1504 (fontified t face font-lock-comment-face) 1504 1508 (fontified t face font-lock-comment-face) 1508 1514 (fontified t face font-lock-comment-face) 1514 1522 (fontified t face font-lock-comment-face) 1522 1527 (fontified t face font-lock-comment-face) 1527 1528 (fontified t face font-lock-comment-face) 1528 1568 (fontified t face font-lock-comment-face) 1568 1574 (fontified t face font-lock-comment-face) 1574 1583 (fontified t face font-lock-comment-face) 1583 1587 (fontified t face font-lock-comment-face) 1587 1624 (fontified t face font-lock-comment-face) 1624 1644 (fontified t face font-lock-comment-face) 1644 1646 (fontified t face font-lock-comment-face) 1646 1662 (fontified t face font-lock-comment-face) 1662 1663 (fontified t face font-lock-comment-face) 1663 1676 (fontified t face font-lock-comment-face) 1676 1688 (fontified t face font-lock-comment-face) 1688 1702 (fontified t face font-lock-comment-face) 1702 1729 (fontified t face font-lock-comment-face) 1729 1733 (fontified t face font-lock-comment-face) 1733 1737 (fontified t face font-lock-comment-face) 1737 1738 (fontified t face font-lock-comment-face) 1738 1788 (fontified t face font-lock-comment-face) 1788 1802 (fontified t face font-lock-comment-face) 1802 1911 (fontified t face font-lock-comment-face) 1911 1921 (fontified t face font-lock-comment-face) 1921 1935 (fontified t face font-lock-comment-face) 1935 1958 (fontified t face font-lock-comment-face) 1958 1959 (fontified t face font-lock-comment-face) 1959 1977 (face font-lock-comment-face fontified t) 1977 1985 (face font-lock-comment-face fontified t) 1985 2030 (face font-lock-comment-face fontified t) 2030 2071 (face font-lock-comment-face fontified t) 2071 2080 (face font-lock-comment-face fontified t) 2080 2082 (face font-lock-comment-face fontified t) 2082 2084 (face font-lock-comment-face fontified t) 2084 2119 (face font-lock-comment-face fontified t) 2119 2133 (face font-lock-comment-face fontified t) 2133 2169 (face font-lock-comment-face fontified t) 2169 2198 (face font-lock-comment-face fontified t) 2198 2308 (face font-lock-comment-face fontified t) 2308 2327 (face font-lock-comment-face fontified t) 2327 2343 (face font-lock-comment-face fontified t) 2343 2346 (face font-lock-comment-face fontified t) 2346 2366 (face font-lock-comment-face fontified t) 2366 2378 (face font-lock-comment-face fontified t) 2378 2379 (face font-lock-comment-face fontified t rear-nonsticky t) 2379 2380 (face font-lock-comment-face fontified t) 2380 2399 (face font-lock-comment-face fontified t) 2399 2409 (face font-lock-comment-face fontified t) 2409 2422 (face font-lock-comment-face fontified t) 2422 2429 (face font-lock-comment-face fontified t) 2429 2462 (face font-lock-comment-face fontified t) 2462 2465 (face font-lock-comment-face fontified t) 2465 2497 (face font-lock-comment-face fontified t) 2497 2518 (face font-lock-comment-face fontified t) 2518 2535 (face font-lock-comment-face fontified t) 2535 2576 (face font-lock-comment-face fontified t) 2576 2588 (face font-lock-comment-face fontified t) 2588 2589 (face font-lock-comment-face fontified t rear-nonsticky t) 2589 2590 (face font-lock-comment-face fontified t) 2590 2599 (face font-lock-comment-face fontified t) 2599 2603 (face font-lock-comment-face fontified t) 2603 2619 (face font-lock-comment-face fontified t) 2619 2638 (face font-lock-comment-face fontified t) 2638 2653 (face font-lock-comment-face fontified t) 2653 2656 (face font-lock-comment-face fontified t) 2656 2664 (face font-lock-comment-face fontified t) 2664 2666 (face font-lock-comment-face fontified t) 2666 2747 (face font-lock-comment-face fontified t) 2747 2761 (face font-lock-comment-face fontified t) 2761 2767 (face font-lock-comment-face fontified t) 2767 2772 (face font-lock-comment-face fontified t) 2772 2773 (face font-lock-comment-face fontified t) 2773 2775 (face font-lock-comment-face fontified t) 2775 2777 (face font-lock-comment-delimiter-face fontified t) 2777 2778 (fontified t) 2778 2779 (fontified t) 2779 2780 (fontified t) 2780 2789 (face font-lock-keyword-face fontified t) 2789 2790 (fontified t) 2790 2804 (face font-lock-function-name-face fontified t) 2804 2831 (fontified t) 2831 2835 (face font-lock-type-face fontified t) 2835 2866 (fontified t) 2866 2870 (face font-lock-keyword-face fontified t) 2870 2982 (fontified t) 2982 2988 (face font-lock-builtin-face fontified t) 2988 3018 (fontified t) 3018 3030 (face font-lock-builtin-face fontified t) 3030 3032 (fontified t) 3032 3035 (face font-lock-builtin-face fontified t) 3035 3064 (fontified t) 3064 3071 (face font-lock-builtin-face fontified t) 3071 3079 (fontified t) 3079 3082 (face font-lock-comment-delimiter-face fontified t) 3082 3118 (face font-lock-comment-face fontified t) 3118 3153 (fontified t) 3153 3156 (face font-lock-keyword-face fontified t) 3156 3186 (fontified t) 3186 3205 (face font-lock-keyword-face fontified t) 3205 3244 (fontified t) 3244 3253 (fontified t) 3253 3257 (face font-lock-keyword-face fontified t) 3257 3328 (fontified t) 3328 3336 (face font-lock-builtin-face fontified t) 3336 3383 (fontified t) 3383 3389 (face font-lock-builtin-face fontified t) 3389 3392 (fontified t) 3392 3411 (face font-lock-string-face fontified t) 3411 3429 (fontified t) 3429 3432 (face font-lock-comment-delimiter-face fontified t) 3432 3495 (face font-lock-comment-face fontified t) 3495 3545 (fontified t) 3545 3547 (face font-lock-keyword-face fontified t) 3547 3575 (fontified t) 3575 3605 (fontified t) 3605 3611 (face font-lock-keyword-face fontified t) 3611 3624 (fontified t) 3624 3629 (face font-lock-builtin-face fontified t) 3629 3643 (fontified t) 3643 3654 (fontified t) 3654 3660 (face font-lock-keyword-face fontified t) 3660 3685 (fontified t) 3685 3689 (face font-lock-keyword-face fontified t) 3689 3704 (fontified t) 3704 3708 (face font-lock-builtin-face fontified t) 3708 3744 (fontified t) 3744 3749 (face font-lock-builtin-face fontified t) 3749 3785 (fontified t) 3785 3790 (face font-lock-builtin-face fontified t) 3790 4006 (fontified t) 4006 4011 (face font-lock-builtin-face fontified t) 4011 4035 (fontified t) 4035 4039 (face font-lock-keyword-face fontified t) 4039 4056 (fontified t) 4056 4059 (face font-lock-comment-delimiter-face fontified t) 4059 4068 (face font-lock-comment-face fontified t) 4068 4132 (fontified t) 4132 4141 (face font-lock-string-face fontified t) 4141 4209 (fontified t) 4209 4212 (face font-lock-comment-delimiter-face fontified t) 4212 4253 (face font-lock-comment-face fontified t) 4253 4271 (fontified t) 4271 4273 (fontified t) 4273 4297 (fontified t) 4297 4314 (fontified t) 4314 4317 (face font-lock-comment-delimiter-face fontified t) 4317 4354 (face font-lock-comment-face fontified t) 4354 4392 (fontified t) 4392 4395 (face font-lock-comment-delimiter-face fontified t) 4395 4406 (face font-lock-comment-face fontified t) 4406 4447 (fontified t) 4447 4449 (face font-lock-keyword-face fontified t) 4449 4500 (fontified t) 4500 4509 (face font-lock-string-face fontified t) 4509 4578 (fontified t) 4578 4587 (face font-lock-string-face fontified t) 4587 4664 (fontified t) 4664 4667 (face font-lock-comment-delimiter-face fontified t) 4667 4679 (face font-lock-comment-face fontified t) 4679 4733 (fontified t) 4733 4742 (face font-lock-string-face fontified t) 4742 4815 (fontified t) 4815 4818 (face font-lock-comment-delimiter-face fontified t) 4818 4907 (face font-lock-comment-face fontified t) 4907 4918 (fontified t) 4918 4922 (face font-lock-keyword-face fontified t) 4922 4963 (fontified t) 4963 4969 (face font-lock-keyword-face fontified t) 4969 4975 (fontified t) 4975 4982 (face font-lock-keyword-face fontified t) 4982 5041 (fontified t) 5041 5050 (face font-lock-string-face fontified t) 5050 5075 (fontified t) 5075 5089 (fontified t) 5089 5098 (fontified t) 5098 5104 (face font-lock-keyword-face fontified t) 5104 5112 (fontified t) 5112 5117 (face font-lock-warning-face fontified t) 5117 5118 (fontified t) 5118 5158 (face font-lock-string-face fontified t) 5158 5173 (fontified t) 5173 5177 (face font-lock-keyword-face fontified t) 5177 5234 (fontified t) 5234 5236 (face font-lock-keyword-face fontified t) 5236 5253 (fontified t) 5253 5266 (face font-lock-string-face fontified t) 5266 5323 (fontified t) 5323 5327 (face font-lock-keyword-face fontified t) 5327 5378 (fontified t) 5378 5392 (face font-lock-string-face fontified t) 5392 5525 (fontified t) 5525 5548 (face font-lock-string-face fontified t) 5548 5670 (fontified t) 5670 5672 (face font-lock-string-face fontified t) 5672 5709 (fontified t) 5709 5723 (face font-lock-string-face fontified t) 5723 5759 (fontified t) 5759 5788 (face font-lock-string-face fontified t) 5788 5797 (fontified t) 5797 5854 (fontified t) 5854 5898 (fontified t) 5898 5917 (face font-lock-keyword-face fontified t) 5917 5998 (fontified t) 5998 6005 (face font-lock-keyword-face fontified t) 6005 6037 (fontified t) 6037 6040 (face font-lock-comment-delimiter-face fontified t) 6040 6104 (face font-lock-comment-face fontified t) 6104 6117 (fontified t) 6117 6120 (face font-lock-keyword-face fontified t) 6120 6223 (fontified t) 6223 6226 (face font-lock-comment-delimiter-face fontified t) 6226 6246 (face font-lock-comment-face fontified t) 6246 6261 (fontified t) 6261 6264 (face font-lock-keyword-face fontified t) 6264 6272 (fontified t) 6272 6274 (face font-lock-keyword-face fontified t) 6274 6329 (fontified t) 6329 6332 (face font-lock-comment-delimiter-face fontified t) 6332 6380 (face font-lock-comment-face fontified t) 6380 6456 (fontified t) 6456 6483 (fontified t)) . 13183) (undo-tree-id82 . -6483) (undo-tree-id83 . -2779) (undo-tree-id84 . -161) (undo-tree-id85 . -6483)) nil (26803 33324 42219 0) 0 nil])
([nil nil ((13183 . 13184)) nil (26803 33324 42216 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18435 . 18436) (nil fontified nil 13184 . 18436) (13184 . 18436)) nil (26803 33324 42216 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -18435) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) 18436) nil (26803 33324 42215 0) 0 nil])
([nil nil ((18435 . 18436)) nil (26803 33324 42212 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -18435) (undo-tree-id77 . -1) (undo-tree-id78 . -1) 18436) nil (26803 33324 42209 0) 0 nil])
([nil nil ((539 . 543) (t 26803 33324 0 0)) nil (26803 37847 665826 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 564 . 565) (nil fontified nil 543 . 565) (543 . 565)) nil (26803 37847 665824 0) 0 nil])
([nil nil ((543 . 544)) nil (26803 37847 665821 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17835 . 17836) (nil fontified nil 17835 . 17836) (nil fontified nil 17834 . 17835) (nil fontified nil 17822 . 17834) (17822 . 17836) (t 26803 37847 0 0)) nil (26803 38323 407316 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12930 . 12931) (nil fontified nil 12930 . 12931) (nil fontified nil 12929 . 12930) (nil fontified nil 12917 . 12929) (12917 . 12931)) nil (26803 38323 407315 0) 0 nil])
([nil nil ((#("(defmacro with-statement-timeout ((ms) &body body)
  \"Exécute BODY avec SET LOCAL statement_timeout = MS (dans une transaction),
si MS est non-NIL et > 0. N’affecte que la transaction courante.\"
  `(ensure-connection
     (if (and ,ms (> ,ms 0))
         (postmodern:with-transaction ()
           ;; SET LOCAL ne persiste que le temps de cette transaction
           (postmodern:query
             (format nil \"set local statement_timeout = ~d\" (truncate ,ms)))
           ,@body)
         (progn ,@body))))" 0 1 (fontified t) 1 9 (fontified t face font-lock-keyword-face) 9 10 (fontified t) 10 32 (fontified t face font-lock-function-name-face) 32 39 (fontified t) 39 44 (fontified t face font-lock-type-face) 44 53 (fontified t) 53 194 (fontified t face font-lock-doc-face) 194 217 (fontified t) 217 223 (fontified t) 223 225 (face font-lock-keyword-face fontified t) 225 256 (fontified t) 256 283 (face font-lock-keyword-face fontified t) 283 298 (fontified t) 298 301 (face font-lock-comment-delimiter-face fontified t) 301 357 (face font-lock-comment-face fontified t) 357 411 (fontified t) 411 445 (face font-lock-string-face fontified t) 445 482 (fontified t) 482 492 (fontified t) 492 497 (face font-lock-keyword-face fontified t) 497 508 (fontified t)) . 2284) (undo-tree-id99 . -287) (undo-tree-id100 . -32) (undo-tree-id101 . -508) 2792) nil (26803 38323 407311 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2282) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (#("
" 0 1 (fontified t)) . -2283) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) 2284) nil (26804 5666 140534 0) 0 nil])
([nil nil ((#(":with-statement-timeout" 0 1 (face font-lock-builtin-face fontified t) 1 22 (face font-lock-builtin-face fontified t) 22 23 (face font-lock-builtin-face rear-nonsticky t fontified t)) . 543) (undo-tree-id13 . -23)) ((543 . 566) (t 26803 38323 0 0)) (26804 5673 173626 0) 0 nil])
([nil nil ((21433 . 21434) (t 26803 38323 0 0)) ((#(" " 0 1 (fontified t)) . 21433) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id10 . -1) (undo-tree-id12 . -1)) (26804 5677 682993 0) 0 nil])
([nil nil ((23177 . 23178)) nil (26804 7747 45376 0) 0 nil] [nil nil ((nil rear-nonsticky nil 21455 . 21456) (nil fontified nil 21434 . 21456) (21434 . 21456)) ((#(" :allocation :instance" 0 1 (fontified nil) 1 12 (face font-lock-builtin-face fontified nil) 12 13 (fontified nil) 13 21 (face font-lock-builtin-face fontified nil) 21 22 (face font-lock-builtin-face rear-nonsticky nil fontified nil)) . 21434) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (nil rear-nonsticky t 21455 . 21456)) (26804 5664 945052 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28142 . 28143) (nil fontified nil 23178 . 28143) (23178 . 28143)) nil (26804 7747 45376 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -21434) (undo-tree-id1 . -1) 21435) ((21434 . 21435)) (26804 5664 727111 0) 0 nil])
([nil nil ((#("(defmacro defentity (name &key table fields primary-key defaults
			    timestamps lock-version)
  \"Déclare une entité CLOS + enregistre metadata pour CRUD/validation/UI.
FIELDS est une liste de formes:
  (:col <kw> :type <sym|kw> [:required? t] [:validator fn]
         [:default v] [:label \\\"...\\\"] [:input-type :text|...]
         [:placeholder \\\"...\\\"] [:help \\\"...\\\"] [:choices ((v . l) ...)]
         [:min n] [:max n] [:step n] [:pattern \\\"^\\\"] [:attrs ((k . v) ...)]
         [:readonly? t] [:disabled? t] [:hidden? t]
         [:ui-group \\\"...\\\"] [:ui-order n])\"
  (let* ((cls name)
         (tbl (if table (string-downcase (etypecase table
                                           (string table)
                                           (symbol (symbol-name table))))
                  (string-downcase (symbol-name name))))
         (pk  (or primary-key :id))
         ;; normaliser fields : ajouter :slot si manquant
         (norm-fields
           (mapcar
            (lambda (f)
              (destructuring-bind (&key col type required? validator default
                                     label input-type placeholder help choices
                                     min max step pattern attrs
                                     readonly? disabled? hidden?
                                     ui-group ui-order slot)
		  f
                (let* ((colkw (%kw (or col (error \"Champ sans :col dans ~a\" name))))
                       (slot-name (or slot (intern (string-downcase (symbol-name colkw))))))
                  (list :col colkw :slot slot-name :type type
                        :required? required? :validator validator :default default
                        :label label :input-type input-type :placeholder placeholder :help help
                        :choices choices :min min :max max :step step :pattern pattern :attrs attrs
                        :readonly? readonly? :disabled? disabled? :hidden? hidden?
                        :ui-group ui-group :ui-order ui-order))))
            fields))
         (slots
           (append
            (list
             `(,+dirty-slot-name+ :initform (%make-dirty-set) :reader ,(intern (format nil \"~a-%%DIRTY\" (string-downcase (symbol-name name)))) ))
            (mapcar (lambda (f)
                      (let ((s (getf f :slot)))
			`(,s :initarg ,(intern (concatenate 'string \":\" (string-upcase (symbol-name s))))
                             :accessor ,(intern (concatenate 'string (string-downcase (symbol-name cls)) \"-\" (string-downcase (symbol-name s))))
                             :initform nil)))
                    norm-fields)))
	 ;; noms d'accessors pour générer les :after setters
	 (accessor-specs
           (mapcar (lambda (f)
                     (let* ((slot (getf f :slot))
                            (acc  (intern (concatenate 'string (string-downcase (symbol-name name))
                                                       \"-\" (string-downcase (symbol-name slot))))))
                       (list slot acc)))
                   norm-fields))
         (defaults-alist
           (loop for f in norm-fields
                 for col = (getf f :col)
                 for def = (getf f :default)
                 when (and (getf f :default) t)
                   collect (cons col def))))
    `(progn
       (defclass ,cls () ,slots)
       ;; enregistrer metadata
       (setf (gethash ',cls *entity-registry*)
             (list :table ,tbl
                   :primary-key ,(%kw pk)
                   :fields ',norm-fields
                   :defaults ',(or defaults defaults-alist)
		   :timestamps ',timestamps
		   :lock-version ',(when lock-version (%kw lock-version))))

       ;; Pour chaque slot, ajouter un after method sur (setf accessor)
       ,@(mapcar
	  (lambda (sa)
	    (destructuring-bind (slot acc) sa
	      `(defmethod (setf ,acc) :after (new (obj ,cls))
		 (declare (ignore new))
		 (mark-dirty obj ',slot))))
	  accessor-specs)
       ',cls)))
" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 19 (face font-lock-function-name-face fontified t) 19 26 (fontified t) 26 30 (face font-lock-type-face fontified t) 30 99 (fontified t) 99 571 (face font-lock-doc-face fontified t) 571 575 (fontified t) 575 579 (face font-lock-keyword-face fontified t) 579 607 (fontified t) 607 609 (face font-lock-keyword-face fontified t) 609 634 (fontified t) 634 643 (face font-lock-keyword-face fontified t) 643 869 (fontified t) 869 872 (face font-lock-builtin-face fontified t) 872 884 (fontified t) 884 887 (face font-lock-comment-delimiter-face fontified t) 887 933 (face font-lock-comment-face fontified t) 933 987 (fontified t) 987 993 (face font-lock-keyword-face fontified t) 993 1013 (fontified t) 1013 1031 (face font-lock-keyword-face fontified t) 1031 1033 (fontified t) 1033 1037 (face font-lock-type-face fontified t) 1037 1325 (fontified t) 1325 1344 (fontified t) 1344 1367 (fontified t) 1367 1371 (face font-lock-keyword-face fontified t) 1371 1394 (fontified t) 1394 1399 (face font-lock-warning-face fontified t) 1399 1400 (fontified t) 1400 1425 (face font-lock-string-face fontified t) 1425 1552 (fontified t) 1552 1556 (face font-lock-builtin-face fontified t) 1556 1563 (fontified t) 1563 1568 (face font-lock-builtin-face fontified t) 1568 1579 (fontified t) 1579 1584 (face font-lock-builtin-face fontified t) 1584 1614 (fontified t) 1614 1624 (face font-lock-builtin-face fontified t) 1624 1635 (fontified t) 1635 1645 (face font-lock-builtin-face fontified t) 1645 1656 (fontified t) 1656 1664 (face font-lock-builtin-face fontified t) 1664 1697 (fontified t) 1697 1703 (face font-lock-builtin-face fontified t) 1703 1710 (fontified t) 1710 1721 (face font-lock-builtin-face fontified t) 1721 1733 (fontified t) 1733 1745 (face font-lock-builtin-face fontified t) 1745 1758 (fontified t) 1758 1763 (face font-lock-builtin-face fontified t) 1763 1793 (fontified t) 1793 1801 (face font-lock-builtin-face fontified t) 1801 1810 (fontified t) 1810 1814 (face font-lock-builtin-face fontified t) 1814 1819 (fontified t) 1819 1823 (face font-lock-builtin-face fontified t) 1823 1828 (fontified t) 1828 1833 (face font-lock-builtin-face fontified t) 1833 1839 (fontified t) 1839 1847 (face font-lock-builtin-face fontified t) 1847 1856 (fontified t) 1856 1862 (face font-lock-builtin-face fontified t) 1862 1893 (fontified t) 1893 1903 (face font-lock-builtin-face fontified t) 1903 1914 (fontified t) 1914 1924 (face font-lock-builtin-face fontified t) 1924 1935 (fontified t) 1935 1943 (face font-lock-builtin-face fontified t) 1943 1976 (fontified t) 1976 1985 (face font-lock-builtin-face fontified t) 1985 1995 (fontified t) 1995 2004 (face font-lock-builtin-face fontified t) 2004 2092 (fontified t) 2092 2126 (fontified t) 2126 2135 (face font-lock-builtin-face fontified t) 2135 2154 (fontified t) 2154 2161 (face font-lock-builtin-face fontified t) 2161 2183 (fontified t) 2183 2195 (face font-lock-string-face fontified t) 2195 2234 (fontified t) 2234 2235 (fontified t) 2235 2238 (fontified t) 2238 2259 (fontified t) 2259 2265 (face font-lock-keyword-face fontified t) 2265 2270 (fontified t) 2270 2293 (fontified t) 2293 2296 (face font-lock-keyword-face fontified t) 2296 2301 (fontified t) 2301 2309 (fontified t) 2309 2314 (face font-lock-builtin-face fontified t) 2314 2317 (fontified t) 2317 2318 (fontified t) 2318 2326 (fontified t) 2326 2334 (face font-lock-builtin-face fontified t) 2334 2365 (fontified t) 2365 2368 (face font-lock-string-face fontified t) 2368 2432 (fontified t) 2432 2441 (face font-lock-builtin-face fontified t) 2441 2508 (fontified t) 2508 2511 (face font-lock-string-face fontified t) 2511 2577 (fontified t) 2577 2586 (face font-lock-builtin-face fontified t) 2586 2631 (fontified t) 2631 2634 (face font-lock-comment-delimiter-face fontified t) 2634 2683 (face font-lock-comment-face fontified t) 2683 2721 (fontified t) 2721 2727 (face font-lock-keyword-face fontified t) 2727 2754 (fontified t) 2754 2758 (face font-lock-keyword-face fontified t) 2758 2774 (fontified t) 2774 2779 (face font-lock-builtin-face fontified t) 2779 2845 (fontified t) 2845 2882 (fontified t) 2882 2937 (fontified t) 2937 2940 (face font-lock-string-face fontified t) 2940 3093 (fontified t) 3093 3097 (face font-lock-keyword-face fontified t) 3097 3154 (fontified t) 3154 3158 (face font-lock-builtin-face fontified t) 3158 3195 (fontified t) 3195 3203 (face font-lock-builtin-face fontified t) 3203 3240 (fontified t) 3240 3248 (face font-lock-builtin-face fontified t) 3248 3304 (fontified t) 3304 3309 (face font-lock-keyword-face fontified t) 3309 3318 (fontified t) 3318 3326 (face font-lock-keyword-face fontified t) 3326 3350 (fontified t) 3350 3353 (face font-lock-comment-delimiter-face fontified t) 3353 3374 (face font-lock-comment-face fontified t) 3374 3440 (fontified t) 3440 3446 (face font-lock-builtin-face fontified t) 3446 3471 (fontified t) 3471 3483 (face font-lock-builtin-face fontified t) 3483 3513 (fontified t) 3513 3520 (face font-lock-builtin-face fontified t) 3520 3554 (fontified t) 3554 3563 (face font-lock-builtin-face fontified t) 3563 3600 (fontified t) 3600 3611 (face font-lock-builtin-face fontified t) 3611 3630 (fontified t) 3630 3643 (face font-lock-builtin-face fontified t) 3643 3647 (fontified t) 3647 3651 (face font-lock-keyword-face fontified t) 3651 3695 (fontified t) 3695 3698 (face font-lock-comment-delimiter-face fontified t) 3698 3734 (face font-lock-comment-face fontified t) 3734 3738 (face font-lock-comment-face fontified t) 3738 3760 (face font-lock-comment-face fontified t) 3760 3781 (fontified t) 3781 3786 (face font-lock-keyword-face fontified t) 3786 3787 (face font-lock-keyword-face fontified t) 3787 3793 (fontified t) 3793 3799 (fontified t) 3799 3817 (face font-lock-keyword-face fontified t) 3817 3818 (fontified t) 3818 3832 (fontified t) 3832 3841 (fontified t) 3841 3850 (face font-lock-keyword-face fontified t) 3850 3863 (fontified t) 3863 3869 (face font-lock-builtin-face fontified t) 3869 3891 (fontified t) 3891 3898 (face font-lock-keyword-face fontified t) 3898 3978 (fontified t)) . -19199) (undo-tree-id32 . -3978) (undo-tree-id33 . -2982) (undo-tree-id34 . -236) (undo-tree-id35 . -2232) (undo-tree-id36 . -2234) (undo-tree-id37 . -2235) (undo-tree-id38 . -2296) (undo-tree-id39 . -2134) (undo-tree-id40 . -2816) (undo-tree-id41 . -2237) (undo-tree-id42 . -2301) (undo-tree-id43 . -3977) (undo-tree-id44 . -3978) 23177) nil (26804 7747 45374 0) 0 nil])
([nil nil ((#("(getf f :slot)))" 0 8 (fontified t) 8 13 (face font-lock-builtin-face fontified t) 13 16 (fontified t)) . -21521) (undo-tree-id0 . -16) 21537) ((21521 . 21537)) (26804 5664 531272 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -19198) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) 19199) nil (26804 7747 45363 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21554 . 21555) (nil fontified nil 21521 . 21555) (21521 . 21555)) ((#("(or (getf f :slot) (getf f :col)))" 0 12 (fontified nil) 12 17 (face font-lock-builtin-face fontified nil) 17 27 (fontified nil) 27 31 (face font-lock-builtin-face fontified nil) 31 33 (fontified nil) 33 34 (rear-nonsticky nil fontified nil)) . 21521) (nil rear-nonsticky t 21554 . 21555)) (26804 5664 262445 0) 0 nil])
([nil nil ((9463 . 9464) (t 26804 7747 0 0)) nil (26804 8341 316052 0) 0 nil])
([nil nil ((21516 . 21517)) ((#("*" 0 1 (face font-lock-keyword-face fontified t)) . 21516)) (26804 5664 262349 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13911 . 13912) (nil fontified nil 9464 . 13912) (9464 . 13912)) nil (26804 8341 316051 0) 0 nil])
nil
([nil nil ((#("
(defmethod entity-insert! ((entity standard-object) &key (returning t))
  ;; defaults + validation + INSERT ... RETURNING
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields))
         (defaults (or (getf md :defaults) '())))
    ;; Appliquer defaults si slot nul
    (dolist (f fields)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (current (%slot-value entity slot))
             (defv (cdr (assoc col defaults))))
        (when (and (null current) defv)
          (%set-slot entity slot defv))))
    ;; Validate
    (validate-entity! entity)
    ;; Construire INSERT (exclude pk si NULL et séquence auto)
    (let* ((ts (%timestamps-of md))
	   (ts-created (and ts (getf ts :created)))
	   (ts-updated (and ts (getf ts :updated)))
	   (ts-fn      (or (and ts (getf ts :db-fn)) \"CURRENT_TIMESTAMP\"))
	   (cols '())
	   (vals '()))
      (multiple-value-bind (emit params-f) (%make-param-emitter)
	(dolist (f fields)
	  (let* ((col  (getf f :col))
		 (slot (getf f :slot))
		 (ty   (getf f :type))
		 (val  (%slot-value entity slot))
		 (is-created (and ts-created (eq col ts-created)))
		 (is-updated (and ts-updated (eq col ts-updated))))
            (cond
              ;; PK: incluse seulement si non-NIL (comportement existant)
              ((eq col pk)
               (when val
		 (push (%ident col) cols)
		 (push (funcall emit (coerce-out val ty)) vals)))
              ;; Timestamps: si NIL → injecter littéral SQL ts-fn (pas de param)
              ((and is-created (null val))
               (push (%ident col) cols)
               (push ts-fn vals))
              ((and is-updated (null val))
               (push (%ident col) cols)
               (push ts-fn vals))
              ;; Autres colonnes ou timestamps explicitement fournis → paramétrés
              (t
               (push (%ident col) cols)
               (push (funcall emit (coerce-out val ty)) vals)))))
	(let* ((cols* (nreverse cols))
               (vals* (nreverse vals))
               ;; ATTENTION : vals* contient un mélange de \"$N\" et de littéraux SQL ts-fn
               (values-sql (with-output-to-string (s)
                             (loop for (v . more) on vals* do
                               (princ v s)
                               (when more (princ \", \" s)))))
               (returning-sql (cond
				((eq returning t) \" returning *\")
				((and (listp returning) (every #'keywordp returning))
				 (format nil \" returning ~{~a~^, ~}\" (mapcar #'%ident returning)))
				((null returning) \"\")
				(t \" returning *\")))
               (sql (format nil \"insert into ~a (~{~a~^, ~}) values (~a)~a\"
                            table cols* values-sql returning-sql)))
	  (multiple-value-bind (affected ret)
              (apply #'lumen.data.db:exec sql (funcall params-f))
            (declare (ignore affected))
            (let ((row (or ret
			   (and (not (null returning))
				(apply #'query-1a sql (funcall params-f))))))
              (let ((new (if row (row->entity class row) entity)))
		(after-insert entity new)
		new))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 26 (face font-lock-function-name-face fontified t) 26 53 (fontified t) 53 57 (face font-lock-type-face fontified t) 57 75 (fontified t) 75 78 (face font-lock-comment-delimiter-face fontified t) 78 123 (face font-lock-comment-face fontified t) 123 126 (fontified t) 126 130 (face font-lock-keyword-face fontified t) 130 242 (fontified t) 242 248 (face font-lock-builtin-face fontified t) 248 278 (fontified t) 278 290 (face font-lock-builtin-face fontified t) 290 292 (fontified t) 292 295 (face font-lock-builtin-face fontified t) 295 324 (fontified t) 324 331 (face font-lock-builtin-face fontified t) 331 366 (fontified t) 366 375 (face font-lock-builtin-face fontified t) 375 388 (fontified t) 388 391 (face font-lock-comment-delimiter-face fontified t) 391 422 (face font-lock-comment-face fontified t) 422 427 (fontified t) 427 433 (face font-lock-keyword-face fontified t) 433 452 (fontified t) 452 456 (face font-lock-keyword-face fontified t) 456 472 (fontified t) 472 477 (face font-lock-builtin-face fontified t) 477 507 (fontified t) 507 511 (face font-lock-builtin-face fontified t) 511 620 (fontified t) 620 624 (face font-lock-keyword-face fontified t) 624 697 (fontified t) 697 700 (face font-lock-comment-delimiter-face fontified t) 700 709 (face font-lock-comment-face fontified t) 709 743 (fontified t) 743 746 (face font-lock-comment-delimiter-face fontified t) 746 802 (face font-lock-comment-face fontified t) 802 807 (fontified t) 807 811 (face font-lock-keyword-face fontified t) 811 871 (fontified t) 871 879 (face font-lock-builtin-face fontified t) 879 916 (fontified t) 916 924 (face font-lock-builtin-face fontified t) 924 965 (fontified t) 965 971 (face font-lock-builtin-face fontified t) 971 974 (fontified t) 974 993 (face font-lock-string-face fontified t) 993 1034 (fontified t) 1034 1053 (face font-lock-keyword-face fontified t) 1053 1094 (fontified t) 1094 1100 (face font-lock-keyword-face fontified t) 1100 1116 (fontified t) 1116 1120 (face font-lock-keyword-face fontified t) 1120 1136 (fontified t) 1136 1140 (face font-lock-builtin-face fontified t) 1140 1160 (fontified t) 1160 1165 (face font-lock-builtin-face fontified t) 1165 1185 (fontified t) 1185 1190 (face font-lock-builtin-face fontified t) 1190 1349 (fontified t) 1349 1353 (face font-lock-keyword-face fontified t) 1353 1368 (fontified t) 1368 1371 (face font-lock-comment-delimiter-face fontified t) 1371 1428 (face font-lock-comment-face fontified t) 1428 1471 (fontified t) 1471 1475 (face font-lock-keyword-face fontified t) 1475 1501 (fontified t) 1501 1508 (fontified t) 1508 1574 (fontified t) 1574 1577 (face font-lock-comment-delimiter-face fontified t) 1577 1641 (face font-lock-comment-face fontified t) 1641 1889 (fontified t) 1889 1892 (face font-lock-comment-delimiter-face fontified t) 1892 1957 (face font-lock-comment-face fontified t) 1957 2082 (fontified t) 2082 2086 (face font-lock-keyword-face fontified t) 2086 2166 (fontified t) 2166 2169 (face font-lock-comment-delimiter-face fontified t) 2169 2241 (face font-lock-comment-face fontified t) 2241 2269 (fontified t) 2269 2290 (face font-lock-keyword-face fontified t) 2290 2325 (fontified t) 2325 2329 (face font-lock-keyword-face fontified t) 2329 2432 (fontified t) 2432 2436 (face font-lock-keyword-face fontified t) 2436 2449 (fontified t) 2449 2453 (face font-lock-string-face fontified t) 2453 2492 (fontified t) 2492 2496 (face font-lock-keyword-face fontified t) 2496 2519 (fontified t) 2519 2533 (face font-lock-string-face fontified t) 2533 2610 (fontified t) 2610 2633 (face font-lock-string-face fontified t) 2633 2686 (fontified t) 2686 2688 (face font-lock-string-face fontified t) 2688 2697 (fontified t) 2697 2711 (face font-lock-string-face fontified t) 2711 2747 (fontified t) 2747 2790 (face font-lock-string-face fontified t) 2790 2859 (fontified t) 2859 2863 (fontified t) 2863 2882 (face font-lock-keyword-face fontified t) 2882 2977 (fontified t) 2977 2984 (face font-lock-keyword-face fontified t) 2984 3008 (fontified t) 3008 3017 (fontified t) 3017 3020 (face font-lock-keyword-face fontified t) 3020 3035 (fontified t) 3035 3134 (fontified t) 3134 3137 (face font-lock-keyword-face fontified t) 3137 3145 (fontified t) 3145 3147 (face font-lock-keyword-face fontified t) 3147 3227 (fontified t)) . -13912) (undo-tree-id45 . -3227) (undo-tree-id46 . -2151) (undo-tree-id47 . -1) (undo-tree-id48 . -1508) (undo-tree-id49 . -1454) (undo-tree-id50 . -1) (undo-tree-id51 . -3035) (undo-tree-id52 . -2240) (undo-tree-id53 . -2384) (undo-tree-id54 . -2384) (undo-tree-id55 . -2427) (undo-tree-id56 . -2427) (undo-tree-id57 . -3041) (undo-tree-id58 . -3214) 17139) nil (26804 8341 316048 0) 0 nil])
([nil nil ((13205 . 13211) (t 26804 8341 0 0)) nil (26804 10114 487481 0) 0 nil])
([nil nil ((13211 . 13212)) nil (26804 10114 487478 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -13211) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) 13212 (t 26804 10114 0 0)) nil (26804 10116 466004 0) 0 nil])
([nil nil ((20425 . 20427) (t 26804 10116 0 0)) nil (26804 10718 638706 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25724 . 25725) (nil fontified nil 20427 . 25725) (20427 . 25725)) nil (26804 10718 638706 0) 0 nil])
([nil nil ((#("
(defmacro defentity (name &key table fields primary-key defaults
                          timestamps lock-version)
  \"Déclare une entité CLOS + enregistre metadata pour CRUD/validation/UI.
FIELDS est une liste de formes:
  (:col <kw> :type <sym|kw> [:required? t] [:validator fn]
         [:default v] [:label \\\"...\\\"] [:input-type :text|...]
         [:placeholder \\\"...\\\"] [:help \\\"...\\\"] [:choices ((v . l) ...)]
         [:min n] [:max n] [:step n] [:pattern \\\"^\\\"] [:attrs ((k . v) ...)]
         [:readonly? t] [:disabled? t] [:hidden? t]
         [:ui-group \\\"...\\\"] [:ui-order n])\"
  (let* ((cls name)
         ;; Table SQL : string en minuscules (ex. :users → \"users\")
         (tbl (if table
                  (string-downcase (etypecase table
                                     (string table)
                                     (symbol (symbol-name table))))
                  (string-downcase (symbol-name name))))
         (pk  (or primary-key :id))
         ;; Normaliser FIELDS : toujours poser :slot ; :col en keyword canonique
         (norm-fields
           (mapcar
            (lambda (f)
              (destructuring-bind (&key col type required? validator default
                                        label input-type placeholder help choices
                                        min max step pattern attrs
                                        readonly? disabled? hidden?
                                        ui-group ui-order slot)
                  f
                (let* ((colkw (%kw (or col (error \"Champ sans :col dans ~a\" name))))
                       ;; slot = symbole du package courant, minuscule (ex. :EMAIL → symbol 'email)
                       (slot-name (or slot (intern (string-downcase (symbol-name colkw))))))
                  (list :col colkw :slot slot-name :type type
                        :required? required? :validator validator :default default
                        :label label :input-type input-type :placeholder placeholder :help help
                        :choices choices :min min :max max :step step :pattern pattern :attrs attrs
                        :readonly? readonly? :disabled? disabled? :hidden? hidden?
                        :ui-group ui-group :ui-order ui-order))))
            fields))
         ;; Spécification des slots CLOS
         (slots
           (append
            ;; Slot interne pour dirty-tracking
            (list
             `(,+dirty-slot-name+
               :initform (%make-dirty-set)
               :reader ,(intern (format nil \"~a-%%DIRTY\"
                                        (string-downcase (symbol-name name))))))
            ;; Slots utilisateurs
            (mapcar
             (lambda (f)
               (let* ((s     (getf f :slot))
                      ;; *** FIX ICI *** : initarg = vrai KEYWORD (ex. :EMAIL)
                      (initarg (intern (string-upcase (symbol-name s)) :keyword))
                      (acc   (intern (concatenate 'string
                                                  (string-downcase (symbol-name cls))
                                                  \"-\"
                                                  (string-downcase (symbol-name s))))))
                 `(,s :initarg ,initarg
                      :accessor ,acc
                      :initform nil)))
             norm-fields)))
         ;; couples (slot . accessor) pour générer les :after (dirty)
         (accessor-specs
           (mapcar (lambda (f)
                     (let* ((slot (getf f :slot))
                            (acc  (intern (concatenate 'string
                                                       (string-downcase (symbol-name name))
                                                       \"-\"
                                                       (string-downcase (symbol-name slot))))))
                       (list slot acc)))
                   norm-fields))
         ;; Defaults: alist (:col . default)
         (defaults-alist
           (loop for f in norm-fields
                 for col = (getf f :col)
                 for def = (getf f :default)
                 when def collect (cons col def))))
    `(progn
       ;; Déclaration de la classe
       (defclass ,cls () ,slots)

       ;; Enregistrer les métadonnées
       (setf (gethash ',cls *entity-registry*)
             (list :table ,tbl
                   :primary-key ,(%kw pk)
                   :fields ',norm-fields
                   :defaults ',(or defaults defaults-alist)
                   :timestamps ',timestamps
                   :lock-version ',(when lock-version (%kw lock-version))))

       ;; After-method sur chaque (setf accessor) pour dirty-tracking
       ,@(mapcar
          (lambda (sa)
            (destructuring-bind (slot acc) sa
              `(defmethod (setf ,acc) :after (new (obj ,cls))
                 (declare (ignore new))
                 (mark-dirty obj ',slot))))
          accessor-specs)

       ',cls)))" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 20 (face font-lock-function-name-face fontified t) 20 27 (fontified t) 27 31 (face font-lock-type-face fontified t) 31 119 (fontified t) 119 443 (face font-lock-doc-face fontified t) 443 495 (face font-lock-doc-face fontified t) 495 591 (face font-lock-doc-face fontified t) 591 595 (fontified t) 595 599 (face font-lock-keyword-face fontified t) 599 621 (fontified t) 621 624 (face font-lock-comment-delimiter-face fontified t) 624 680 (face font-lock-comment-face fontified t) 680 695 (fontified t) 695 697 (face font-lock-keyword-face fontified t) 697 740 (fontified t) 740 749 (face font-lock-keyword-face fontified t) 749 963 (fontified t) 963 966 (face font-lock-builtin-face fontified t) 966 978 (fontified t) 978 981 (face font-lock-comment-delimiter-face fontified t) 981 1050 (face font-lock-comment-face fontified t) 1050 1104 (fontified t) 1104 1110 (face font-lock-keyword-face fontified t) 1110 1130 (fontified t) 1130 1148 (face font-lock-keyword-face fontified t) 1148 1150 (fontified t) 1150 1154 (face font-lock-type-face fontified t) 1154 1499 (fontified t) 1499 1501 (fontified t) 1501 1510 (fontified t) 1510 1514 (face font-lock-keyword-face fontified t) 1514 1537 (fontified t) 1537 1542 (face font-lock-warning-face fontified t) 1542 1543 (fontified t) 1543 1568 (face font-lock-string-face fontified t) 1568 1578 (fontified t) 1578 1601 (fontified t) 1601 1604 (face font-lock-comment-delimiter-face fontified t) 1604 1678 (face font-lock-comment-face fontified t) 1678 1795 (fontified t) 1795 1799 (face font-lock-builtin-face fontified t) 1799 1806 (fontified t) 1806 1811 (face font-lock-builtin-face fontified t) 1811 1822 (fontified t) 1822 1827 (face font-lock-builtin-face fontified t) 1827 1857 (fontified t) 1857 1867 (face font-lock-builtin-face fontified t) 1867 1878 (fontified t) 1878 1888 (face font-lock-builtin-face fontified t) 1888 1899 (fontified t) 1899 1907 (face font-lock-builtin-face fontified t) 1907 1940 (fontified t) 1940 1946 (face font-lock-builtin-face fontified t) 1946 1953 (fontified t) 1953 1964 (face font-lock-builtin-face fontified t) 1964 1976 (fontified t) 1976 1988 (face font-lock-builtin-face fontified t) 1988 1995 (fontified t) 1995 2001 (fontified t) 2001 2006 (face font-lock-builtin-face fontified t) 2006 2012 (fontified t) 2012 2036 (fontified t) 2036 2044 (face font-lock-builtin-face fontified t) 2044 2053 (fontified t) 2053 2057 (face font-lock-builtin-face fontified t) 2057 2062 (fontified t) 2062 2066 (face font-lock-builtin-face fontified t) 2066 2071 (fontified t) 2071 2076 (face font-lock-builtin-face fontified t) 2076 2082 (fontified t) 2082 2090 (face font-lock-builtin-face fontified t) 2090 2099 (fontified t) 2099 2105 (face font-lock-builtin-face fontified t) 2105 2136 (fontified t) 2136 2146 (face font-lock-builtin-face fontified t) 2146 2157 (fontified t) 2157 2167 (face font-lock-builtin-face fontified t) 2167 2178 (fontified t) 2178 2186 (face font-lock-builtin-face fontified t) 2186 2219 (fontified t) 2219 2228 (face font-lock-builtin-face fontified t) 2228 2238 (fontified t) 2238 2247 (face font-lock-builtin-face fontified t) 2247 2291 (fontified t) 2291 2294 (face font-lock-comment-delimiter-face fontified t) 2294 2323 (face font-lock-comment-face fontified t) 2323 2370 (fontified t) 2370 2373 (face font-lock-comment-delimiter-face fontified t) 2373 2406 (face font-lock-comment-face fontified t) 2406 2473 (fontified t) 2473 2482 (face font-lock-builtin-face fontified t) 2482 2516 (fontified t) 2516 2523 (face font-lock-builtin-face fontified t) 2523 2545 (fontified t) 2545 2557 (face font-lock-string-face fontified t) 2557 2651 (fontified t) 2651 2654 (face font-lock-comment-delimiter-face fontified t) 2654 2673 (face font-lock-comment-face fontified t) 2673 2707 (fontified t) 2707 2713 (face font-lock-keyword-face fontified t) 2713 2734 (fontified t) 2734 2738 (face font-lock-keyword-face fontified t) 2738 2755 (fontified t) 2755 2760 (face font-lock-builtin-face fontified t) 2760 2785 (fontified t) 2785 2788 (face font-lock-comment-delimiter-face fontified t) 2788 2842 (face font-lock-comment-face fontified t) 2842 2913 (fontified t) 2913 2921 (face font-lock-builtin-face fontified t) 2921 3078 (fontified t) 3078 3118 (fontified t) 3118 3121 (face font-lock-string-face fontified t) 3121 3122 (fontified t) 3122 3232 (fontified t) 3232 3240 (face font-lock-builtin-face fontified t) 3240 3272 (fontified t) 3272 3281 (face font-lock-builtin-face fontified t) 3281 3309 (fontified t) 3309 3318 (face font-lock-builtin-face fontified t) 3318 3363 (fontified t) 3363 3366 (face font-lock-comment-delimiter-face fontified t) 3366 3424 (face font-lock-comment-face fontified t) 3424 3469 (fontified t) 3469 3475 (face font-lock-keyword-face fontified t) 3475 3502 (fontified t) 3502 3506 (face font-lock-keyword-face fontified t) 3506 3522 (fontified t) 3522 3527 (face font-lock-builtin-face fontified t) 3527 3740 (fontified t) 3740 3743 (face font-lock-string-face fontified t) 3743 3923 (fontified t) 3923 3926 (face font-lock-comment-delimiter-face fontified t) 3926 3959 (face font-lock-comment-face fontified t) 3959 3996 (fontified t) 3996 4000 (face font-lock-keyword-face fontified t) 4000 4057 (fontified t) 4057 4061 (face font-lock-builtin-face fontified t) 4061 4098 (fontified t) 4098 4106 (face font-lock-builtin-face fontified t) 4106 4166 (fontified t) 4166 4171 (face font-lock-keyword-face fontified t) 4171 4179 (fontified t) 4179 4182 (face font-lock-comment-delimiter-face fontified t) 4182 4207 (face font-lock-comment-face fontified t) 4207 4215 (fontified t) 4215 4223 (face font-lock-keyword-face fontified t) 4223 4248 (fontified t) 4248 4251 (face font-lock-comment-delimiter-face fontified t) 4251 4279 (face font-lock-comment-face fontified t) 4279 4345 (fontified t) 4345 4351 (face font-lock-builtin-face fontified t) 4351 4376 (fontified t) 4376 4388 (face font-lock-builtin-face fontified t) 4388 4418 (fontified t) 4418 4425 (face font-lock-builtin-face fontified t) 4425 4459 (fontified t) 4459 4468 (face font-lock-builtin-face fontified t) 4468 4519 (fontified t) 4519 4530 (face font-lock-builtin-face fontified t) 4530 4563 (fontified t) 4563 4576 (face font-lock-builtin-face fontified t) 4576 4580 (fontified t) 4580 4584 (face font-lock-keyword-face fontified t) 4584 4622 (fontified t) 4622 4628 (fontified t) 4628 4631 (face font-lock-comment-delimiter-face fontified t) 4631 4691 (face font-lock-comment-face fontified t) 4691 4719 (fontified t) 4719 4725 (face font-lock-keyword-face fontified t) 4725 4744 (fontified t) 4744 4762 (face font-lock-keyword-face fontified t) 4762 4793 (fontified t) 4793 4802 (face font-lock-keyword-face fontified t) 4802 4815 (fontified t) 4815 4821 (face font-lock-builtin-face fontified t) 4821 4857 (fontified t) 4857 4864 (face font-lock-keyword-face fontified t) 4864 4965 (fontified t)) . -25726) (undo-tree-id63 . -1) (undo-tree-id64 . -1114) (undo-tree-id65 . -4965) (undo-tree-id66 . -4279) (undo-tree-id67 . -1) (undo-tree-id68 . -1578) (undo-tree-id69 . -1770) (undo-tree-id70 . -1) (undo-tree-id71 . -3122) (undo-tree-id72 . -2558) (undo-tree-id73 . -3530) (undo-tree-id74 . -1) (undo-tree-id75 . -4691) (undo-tree-id76 . -4326) (undo-tree-id77 . -4950) (undo-tree-id78 . -4965) (undo-tree-id79 . -4965) 30691) nil (26804 10718 638704 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t rear-nonsticky t)) . 25726) (undo-tree-id62 . -1)) nil (26804 10718 638691 0) 0 nil])
([nil nil ((20425 . 20427) (t 26804 10718 0 0)) nil (26804 11495 294207 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 25805 . 25806) (nil fontified nil 20427 . 25806) (20427 . 25806)) nil (26804 11495 294206 0) 0 nil])
([nil nil ((#("

(defmacro defentity (name &key table fields primary-key defaults
                          timestamps lock-version)
  \"Déclare une entité CLOS + enregistre metadata pour CRUD/validation/UI.
FIELDS est une liste de formes:
  (:col <kw> :type <sym|kw> [:required? t] [:validator fn]
         [:default v] [:label \\\"...\\\"] [:input-type :text|...]
         [:placeholder \\\"...\\\"] [:help \\\"...\\\"] [:choices ((v . l) ...)]
         [:min n] [:max n] [:step n] [:pattern \\\"^\\\"] [:attrs ((k . v) ...)]
         [:readonly? t] [:disabled? t] [:hidden? t]
         [:ui-group \\\"...\\\"] [:ui-order n])\"
  (let* ((cls name)
         ;; Table SQL : string en minuscules (ex. :users → \"users\")
         (tbl (if table
                  (string-downcase (etypecase table
                                     (string table)
                                     (symbol (symbol-name table))))
                  (string-downcase (symbol-name name))))
         (pk  (or primary-key :id))
         ;; Normaliser FIELDS : poser :slot; :col en keyword canonique
         ;; IMPORTANT: slots en **UPPERCASE** (non échappés) pour éviter |id| vs ID
         (norm-fields
           (mapcar
            (lambda (f)
              (destructuring-bind (&key col type required? validator default
                                        label input-type placeholder help choices
                                        min max step pattern attrs
                                        readonly? disabled? hidden?
                                        ui-group ui-order slot)
                  f
                (let* ((colkw (%kw (or col (error \"Champ sans :col dans ~a\" name))))
                       ;; slot-name: symbole UPPERCASE (unescaped) dans le package courant
                       (slot-name (or slot
                                      (intern (string-upcase (symbol-name colkw)) *package*))))
                  (list :col colkw :slot slot-name :type type
                        :required? required? :validator validator :default default
                        :label label :input-type input-type :placeholder placeholder :help help
                        :choices choices :min min :max max :step step :pattern pattern :attrs attrs
                        :readonly? readonly? :disabled? disabled? :hidden? hidden?
                        :ui-group ui-group :ui-order ui-order))))
            fields))
         ;; Spécification des slots CLOS
         (slots
           (append
            ;; Slot interne pour dirty-tracking
            (list
             `(,+dirty-slot-name+
               :initform (%make-dirty-set)
               :reader ,(intern (format nil \"~a-%%DIRTY\"
                                        (string-downcase (symbol-name name))) *package*)))
            ;; Slots utilisateurs
            (mapcar
             (lambda (f)
               (let* ((s       (getf f :slot))               ; déjà UPPERCASE ici
                      ;; initarg = KEYWORD correspondant au slot (ex. :ID, :EMAIL)
                      (initarg (intern (symbol-name s) :keyword))
                      ;; accessor: nom lisible en minuscules avec préfixe <class>-
                      (acc    (intern (concatenate 'string
                                                   (string-downcase (symbol-name cls))
                                                   \"-\"
                                                   (string-downcase (symbol-name s)))
                                      *package*)))
                 `(,s :initarg ,initarg
                      :accessor ,acc
                      :initform nil)))
             norm-fields)))
         ;; couples (slot . accessor) pour générer les :after (dirty)
         (accessor-specs
           (mapcar (lambda (f)
                     (let* ((slot (getf f :slot))
                            (acc  (intern (concatenate 'string
                                                       (string-downcase (symbol-name name))
                                                       \"-\"
                                                       (string-downcase (symbol-name slot)))
                                          *package*)))
                       (list slot acc)))
                   norm-fields))
         ;; Defaults: alist (:col . default)
         (defaults-alist
           (loop for f in norm-fields
                 for col = (getf f :col)
                 for def = (getf f :default)
                 when def collect (cons col def))))
    `(progn
       ;; Déclaration de la classe
       (defclass ,cls () ,slots)

       ;; Enregistrer les métadonnées
       (setf (gethash ',cls *entity-registry*)
             (list :table ,tbl
                   :primary-key ,(%kw pk)
                   :fields ',norm-fields
                   :defaults ',(or defaults defaults-alist)
                   :timestamps ',timestamps
                   :lock-version ',(when lock-version (%kw lock-version))))

       ;; After-method sur chaque (setf accessor) pour dirty-tracking
       ,@(mapcar
          (lambda (sa)
            (destructuring-bind (slot acc) sa
              `(defmethod (setf ,acc) :after (new (obj ,cls))
                 (declare (ignore new))
                 (mark-dirty obj ',slot))))
          accessor-specs)

       ',cls)))

" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 21 (face font-lock-function-name-face fontified t) 21 28 (fontified t) 28 32 (face font-lock-type-face fontified t) 32 120 (fontified t) 120 592 (face font-lock-doc-face fontified t) 592 596 (fontified t) 596 600 (face font-lock-keyword-face fontified t) 600 622 (fontified t) 622 625 (face font-lock-comment-delimiter-face fontified t) 625 681 (face font-lock-comment-face fontified t) 681 696 (fontified t) 696 698 (face font-lock-keyword-face fontified t) 698 741 (fontified t) 741 750 (face font-lock-keyword-face fontified t) 750 964 (fontified t) 964 967 (face font-lock-builtin-face fontified t) 967 979 (fontified t) 979 982 (face font-lock-comment-delimiter-face fontified t) 982 1041 (face font-lock-comment-face fontified t) 1041 1050 (fontified t) 1050 1053 (face font-lock-comment-delimiter-face fontified t) 1053 1125 (face font-lock-comment-face fontified t) 1125 1179 (fontified t) 1179 1185 (face font-lock-keyword-face fontified t) 1185 1205 (fontified t) 1205 1223 (face font-lock-keyword-face fontified t) 1223 1225 (fontified t) 1225 1229 (face font-lock-type-face fontified t) 1229 1500 (fontified t) 1500 1502 (fontified t) 1502 1548 (fontified t) 1548 1585 (fontified t) 1585 1589 (face font-lock-keyword-face fontified t) 1589 1612 (fontified t) 1612 1617 (face font-lock-warning-face fontified t) 1617 1618 (fontified t) 1618 1643 (face font-lock-string-face fontified t) 1643 1676 (fontified t) 1676 1679 (face font-lock-comment-delimiter-face fontified t) 1679 1744 (face font-lock-comment-face fontified t) 1744 1907 (fontified t) 1907 1911 (face font-lock-builtin-face fontified t) 1911 1918 (fontified t) 1918 1923 (face font-lock-builtin-face fontified t) 1923 1934 (fontified t) 1934 1939 (face font-lock-builtin-face fontified t) 1939 1969 (fontified t) 1969 1979 (face font-lock-builtin-face fontified t) 1979 1990 (fontified t) 1990 2000 (face font-lock-builtin-face fontified t) 2000 2011 (fontified t) 2011 2019 (face font-lock-builtin-face fontified t) 2019 2052 (fontified t) 2052 2058 (face font-lock-builtin-face fontified t) 2058 2065 (fontified t) 2065 2076 (face font-lock-builtin-face fontified t) 2076 2088 (fontified t) 2088 2100 (face font-lock-builtin-face fontified t) 2100 2113 (fontified t) 2113 2118 (face font-lock-builtin-face fontified t) 2118 2148 (fontified t) 2148 2156 (face font-lock-builtin-face fontified t) 2156 2165 (fontified t) 2165 2169 (face font-lock-builtin-face fontified t) 2169 2174 (fontified t) 2174 2178 (face font-lock-builtin-face fontified t) 2178 2183 (fontified t) 2183 2188 (face font-lock-builtin-face fontified t) 2188 2194 (fontified t) 2194 2202 (face font-lock-builtin-face fontified t) 2202 2211 (fontified t) 2211 2217 (face font-lock-builtin-face fontified t) 2217 2248 (fontified t) 2248 2258 (face font-lock-builtin-face fontified t) 2258 2269 (fontified t) 2269 2279 (face font-lock-builtin-face fontified t) 2279 2290 (fontified t) 2290 2298 (face font-lock-builtin-face fontified t) 2298 2331 (fontified t) 2331 2340 (face font-lock-builtin-face fontified t) 2340 2350 (fontified t) 2350 2359 (face font-lock-builtin-face fontified t) 2359 2403 (fontified t) 2403 2406 (face font-lock-comment-delimiter-face fontified t) 2406 2435 (face font-lock-comment-face fontified t) 2435 2482 (fontified t) 2482 2485 (face font-lock-comment-delimiter-face fontified t) 2485 2518 (face font-lock-comment-face fontified t) 2518 2585 (fontified t) 2585 2594 (face font-lock-builtin-face fontified t) 2594 2628 (fontified t) 2628 2635 (face font-lock-builtin-face fontified t) 2635 2657 (fontified t) 2657 2669 (face font-lock-string-face fontified t) 2669 2748 (fontified t) 2748 2760 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t) 2760 2773 (fontified t) 2773 2776 (face font-lock-comment-delimiter-face fontified t) 2776 2795 (face font-lock-comment-face fontified t) 2795 2829 (fontified t) 2829 2835 (face font-lock-keyword-face fontified t) 2835 2856 (fontified t) 2856 2860 (face font-lock-keyword-face fontified t) 2860 2879 (fontified t) 2879 2884 (face font-lock-builtin-face fontified t) 2884 2901 (fontified t) 2901 2922 (face font-lock-comment-face fontified t) 2922 2944 (fontified t) 2944 2947 (face font-lock-comment-delimiter-face fontified t) 2947 3005 (face font-lock-comment-face fontified t) 3005 3048 (fontified t) 3048 3060 (fontified t) 3060 3068 (face font-lock-builtin-face fontified t) 3068 3071 (fontified t) 3071 3093 (fontified t) 3093 3096 (face font-lock-comment-delimiter-face fontified t) 3096 3154 (face font-lock-comment-face fontified t) 3154 3351 (fontified t) 3351 3354 (face font-lock-string-face fontified t) 3354 3514 (fontified t) 3514 3522 (face font-lock-builtin-face fontified t) 3522 3554 (fontified t) 3554 3563 (face font-lock-builtin-face fontified t) 3563 3591 (fontified t) 3591 3600 (face font-lock-builtin-face fontified t) 3600 3645 (fontified t) 3645 3648 (face font-lock-comment-delimiter-face fontified t) 3648 3706 (face font-lock-comment-face fontified t) 3706 3751 (fontified t) 3751 3757 (face font-lock-keyword-face fontified t) 3757 3784 (fontified t) 3784 3788 (face font-lock-keyword-face fontified t) 3788 3804 (fontified t) 3804 3809 (face font-lock-builtin-face fontified t) 3809 4022 (fontified t) 4022 4025 (face font-lock-string-face fontified t) 4025 4257 (fontified t) 4257 4260 (face font-lock-comment-delimiter-face fontified t) 4260 4293 (face font-lock-comment-face fontified t) 4293 4330 (fontified t) 4330 4334 (face font-lock-keyword-face fontified t) 4334 4391 (fontified t) 4391 4395 (face font-lock-builtin-face fontified t) 4395 4432 (fontified t) 4432 4440 (face font-lock-builtin-face fontified t) 4440 4500 (fontified t) 4500 4505 (face font-lock-keyword-face fontified t) 4505 4513 (fontified t) 4513 4516 (face font-lock-comment-delimiter-face fontified t) 4516 4541 (face font-lock-comment-face fontified t) 4541 4549 (fontified t) 4549 4557 (face font-lock-keyword-face fontified t) 4557 4571 (fontified t) 4571 4574 (fontified t) 4574 4582 (fontified t) 4582 4585 (face font-lock-comment-delimiter-face fontified t) 4585 4613 (face font-lock-comment-face fontified t) 4613 4679 (fontified t) 4679 4685 (face font-lock-builtin-face fontified t) 4685 4710 (fontified t) 4710 4722 (face font-lock-builtin-face fontified t) 4722 4752 (fontified t) 4752 4759 (face font-lock-builtin-face fontified t) 4759 4793 (fontified t) 4793 4802 (face font-lock-builtin-face fontified t) 4802 4853 (fontified t) 4853 4864 (face font-lock-builtin-face fontified t) 4864 4897 (fontified t) 4897 4910 (face font-lock-builtin-face fontified t) 4910 4914 (fontified t) 4914 4918 (face font-lock-keyword-face fontified t) 4918 4962 (fontified t) 4962 4965 (face font-lock-comment-delimiter-face fontified t) 4965 5025 (face font-lock-comment-face fontified t) 5025 5053 (fontified t) 5053 5059 (face font-lock-keyword-face fontified t) 5059 5078 (fontified t) 5078 5096 (face font-lock-keyword-face fontified t) 5096 5127 (fontified t) 5127 5136 (face font-lock-keyword-face fontified t) 5136 5149 (fontified t) 5149 5155 (face font-lock-builtin-face fontified t) 5155 5191 (fontified t) 5191 5198 (face font-lock-keyword-face fontified t) 5198 5299 (fontified t) 5299 5300 (fontified t rear-nonsticky t) 5300 5301 (fontified t)) . -25806) (undo-tree-id83 . -5301) (undo-tree-id84 . -5301) (undo-tree-id85 . -4293) 31107) nil (26804 11495 294206 0) 0 nil])
([nil nil ((22335 . 22346) (#(" " 0 1 (fontified nil)) . 22335) (22334 . 22335)) nil (26804 11495 294203 0) 0 nil])
([nil nil ((22584 . 22587) (#(" " 0 1 (fontified nil)) . 22584) (22583 . 22584)) nil (26804 11495 294203 0) 0 nil])
([nil nil ((#("
                       " 0 1 (fontified t) 1 24 (fontified t)) . -22597) (undo-tree-id82 . -24) 22621) nil (26804 11495 294202 0) 0 nil])
([nil nil ((22644 . 22647) (#(" " 0 1 (fontified nil)) . 22644) (22643 . 22644)) nil (26804 11495 294200 0) 0 nil])
([nil nil ((#("
                       " 0 1 (fontified t) 1 24 (fontified t)) . -22676) (undo-tree-id81 . -24) 22700) nil (26804 11495 294199 0) 0 nil])
([nil nil ((22698 . 22701) (#(" " 0 1 (fontified nil)) . 22697) (undo-tree-id80 . -1) (22698 . 22699)) nil (26804 11495 294195 0) 0 nil])
([nil nil ((25734 . 25735) (t 26804 11495 0 0)) nil (26804 11525 775484 0) 0 nil])
([nil nil ((#("d" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -25734) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) 25735) nil (26804 11525 775480 0) 0 nil])
([nil nil ((21170 . 21173) (t 26804 11525 0 0)) nil (26804 11567 352524 0) 0 nil])
([nil nil ((21173 . 21175)) nil (26804 11567 352524 0) 0 nil])
([nil nil ((21175 . 21176)) nil (26804 11567 352523 0) 0 nil])
([nil nil ((21176 . 21183)) nil (26804 11567 352523 0) 0 nil])
([nil nil ((21183 . 21184)) nil (26804 11567 352522 0) 0 nil])
([nil nil ((21184 . 21185)) nil (26804 11567 352522 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -21184) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) 21185) nil (26804 11567 352521 0) 0 nil])
([nil nil ((21184 . 21189)) nil (26804 11567 352518 0) 0 nil])
([nil nil ((#("A" 0 1 (face font-lock-string-face fontified t)) . -21187) (undo-tree-id96 . -1) (#("P" 0 1 (face font-lock-string-face fontified t)) . -21188) (undo-tree-id97 . -1) 21189) nil (26804 11567 352517 0) 0 nil])
([nil nil ((21187 . 21191)) nil (26804 11567 352515 0) 0 nil])
([nil nil ((21191 . 21192)) nil (26804 11567 352515 0) 0 nil])
([nil nil ((#("p" 0 1 (face font-lock-string-face fontified t)) . -21187) (undo-tree-id91 . -1) (#("k" 0 1 (face font-lock-string-face fontified t)) . -21188) (undo-tree-id92 . -1) (#("G" 0 1 (face font-lock-string-face fontified t)) . -21189) (undo-tree-id93 . -1) (#(":" 0 1 (face font-lock-string-face fontified t)) . -21190) (undo-tree-id94 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -21191) (undo-tree-id95 . -1) 21192) nil (26804 11567 352513 0) 0 nil])
([nil nil ((21187 . 21191)) nil (26804 11567 352498 0) 0 nil])
([nil nil ((21191 . 21192)) nil (26804 11567 352498 0) 0 nil])
([nil nil ((21192 . 21197)) nil (26804 11567 352497 0) 0 nil])
([nil nil ((21197 . 21198)) nil (26804 11567 352496 0) 0 nil])
([nil nil ((21198 . 21203)) nil (26804 11567 352492 0) 0 nil])
([nil nil ((21184 . 21185) (t 26804 11567 0 0)) nil (26804 11583 928045 0) 0 nil])
([nil nil ((21185 . 21186)) nil (26804 11583 928041 0) 0 nil])
([nil nil ((11110 . 11117) (t 26804 11583 0 0)) nil (26804 12445 83 0) 0 nil])
([nil nil ((11117 . 11123)) nil (26804 12445 83 0) 0 nil])
([nil nil ((11123 . 11124)) nil (26804 12445 82 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -11118) (undo-tree-id142 . -1) (#("r" 0 1 (fontified t)) . -11119) (undo-tree-id143 . -1) (#("i" 0 1 (fontified t)) . -11120) (undo-tree-id144 . -1) (#("n" 0 1 (fontified t)) . -11121) (undo-tree-id145 . -1) (#("t" 0 1 (fontified t)) . -11122) (undo-tree-id146 . -1) (#(" " 0 1 (fontified t)) . -11123) (undo-tree-id147 . -1) 11124) nil (26804 12445 81 0) 0 nil])
([nil nil ((11118 . 11124)) nil (26804 12445 77 0) 0 nil])
([nil nil ((11124 . 11125)) nil (26804 12445 77 0) 0 nil])
([nil nil ((11125 . 11126)) nil (26804 12445 77 0) 0 nil])
([nil nil ((11126 . 11127)) nil (26804 12445 76 0) 0 nil])
([nil nil ((11127 . 11130)) nil (26804 12445 76 0) 0 nil])
([nil nil ((11130 . 11131)) nil (26804 12445 75 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -11130) (undo-tree-id141 . -1) 11131) nil (26804 12445 75 0) 0 nil])
([nil nil ((11130 . 11135)) nil (26804 12445 74 0) 0 nil])
([nil nil ((#("t" 0 1 (face font-lock-string-face fontified t)) . -11133) (undo-tree-id139 . -1) (#("e" 0 1 (face font-lock-string-face fontified t)) . -11134) (undo-tree-id140 . -1) 11135) nil (26804 12445 73 0) 0 nil])
([nil nil ((11133 . 11137)) nil (26804 12445 72 0) 0 nil])
([nil nil ((11137 . 11138)) nil (26804 12445 71 0) 0 nil])
([nil nil ((11138 . 11141)) nil (26804 12445 71 0) 0 nil])
([nil nil ((#("a" 0 1 (face font-lock-string-face fontified t)) . -11133) (undo-tree-id131 . -1) (#("t" 0 1 (face font-lock-string-face fontified t)) . -11134) (undo-tree-id132 . -1) (#("e" 0 1 (face font-lock-string-face fontified t)) . -11135) (undo-tree-id133 . -1) (#("D" 0 1 (face font-lock-string-face fontified t)) . -11136) (undo-tree-id134 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -11137) (undo-tree-id135 . -1) (#("C" 0 1 (face font-lock-string-face fontified t)) . -11138) (undo-tree-id136 . -1) (#("O" 0 1 (face font-lock-string-face fontified t)) . -11139) (undo-tree-id137 . -1) (#("l" 0 1 (face font-lock-string-face fontified t)) . -11140) (undo-tree-id138 . -1) 11141) nil (26804 12445 70 0) 0 nil])
([nil nil ((11133 . 11138)) nil (26804 12445 64 0) 0 nil])
([nil nil ((11138 . 11139)) nil (26804 12445 64 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -11135) (undo-tree-id127 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -11136) (undo-tree-id128 . -1) (#("D" 0 1 (face font-lock-string-face fontified t)) . -11137) (undo-tree-id129 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -11138) (undo-tree-id130 . -1) 11139) nil (26804 12445 63 0) 0 nil])
([nil nil ((11135 . 11137)) nil (26804 12445 58 0) 0 nil])
([nil nil ((11137 . 11138)) nil (26804 12445 58 0) 0 nil])
([nil nil ((11138 . 11142)) nil (26804 12445 58 0) 0 nil])
([nil nil ((11142 . 11143)) nil (26804 12445 57 0) 0 nil])
([nil nil ((11143 . 11148)) nil (26804 12445 57 0) 0 nil])
([nil nil ((11148 . 11149)) nil (26804 12445 56 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11159 . 11160) (nil fontified nil 11149 . 11160) (11149 . 11160)) nil (26804 12445 56 0) 0 nil])
([nil nil ((11160 . 11161)) nil (26804 12445 55 0) 0 nil])
([nil nil ((11161 . 11168)) nil (26804 12445 55 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11211 . 11212) (nil fontified nil 11211 . 11212) (nil fontified nil 11210 . 11211) (nil fontified nil 11200 . 11210) (nil fontified nil 11199 . 11200) (nil fontified nil 11178 . 11199) (nil fontified nil 11168 . 11178) (11168 . 11212)) nil (26804 12445 54 0) 0 nil])
([nil nil ((#("CREATED" 0 7 (face font-lock-string-face fontified t)) . -11181) (undo-tree-id117 . -7) (undo-tree-id118 . -5) (undo-tree-id119 . -5) (undo-tree-id120 . -5) (undo-tree-id121 . -5) (undo-tree-id122 . -5) (undo-tree-id123 . -7) (undo-tree-id124 . -7) (undo-tree-id125 . -7) (undo-tree-id126 . -7) 11188) nil (26804 12445 52 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11187 . 11188) (nil fontified nil 11181 . 11188) (11181 . 11188)) nil (26804 12445 46 0) 0 nil])
([nil nil ((11181 . 11188) (#("updated" 0 6 (face font-lock-string-face fontified t) 6 7 (face font-lock-string-face rear-nonsticky t fontified t)) . 11181)) nil (26804 12445 45 0) 0 nil])
([nil nil ((#("created" 0 7 (fontified t)) . -11200) (undo-tree-id103 . -7) (undo-tree-id104 . -3) (undo-tree-id105 . -3) (undo-tree-id106 . -3) (undo-tree-id107 . -3) (undo-tree-id108 . -3) (undo-tree-id109 . -7) (undo-tree-id110 . -7) (undo-tree-id111 . -7) (undo-tree-id112 . -7) (undo-tree-id113 . -7) (undo-tree-id114 . -7) (undo-tree-id115 . -7) (undo-tree-id116 . -7) 11207) nil (26804 12445 43 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11206 . 11207) (nil fontified nil 11200 . 11207) (11200 . 11207)) nil (26804 12445 22 0) 0 nil])
([nil nil ((9807 . 9812) (t 26804 12445 0 0)) nil (26804 12644 16143 0) 0 nil])
([nil nil ((9812 . 9818)) nil (26804 12644 16142 0) 0 nil])
([nil nil ((9818 . 9819)) nil (26804 12644 16142 0) 0 nil])
([nil nil ((9819 . 9822)) nil (26804 12644 16142 0) 0 nil])
([nil nil ((9822 . 9827)) nil (26804 12644 16141 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9836 . 9837) (nil fontified nil 9827 . 9837) (9827 . 9837)) nil (26804 12644 16141 0) 0 nil])
([nil nil ((#("ts" 0 2 (fontified t)) . -9834) (undo-tree-id162 . -2) (undo-tree-id163 . -2) (undo-tree-id164 . -2) (undo-tree-id165 . -2) (undo-tree-id166 . -2) 9836) nil (26804 12644 16140 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9851 . 9852) (nil fontified nil 9851 . 9852) (nil fontified nil 9843 . 9851) (nil fontified nil 9834 . 9843) (9834 . 9852)) nil (26804 12644 16137 0) 0 nil])
([nil nil ((9853 . 9858)) nil (26804 12644 16136 0) 0 nil])
([nil nil ((nil fontified nil 9883 . 9884) (nil fontified nil 9882 . 9883) (nil fontified nil 9874 . 9882) (nil fontified nil 9865 . 9874) (nil fontified nil 9858 . 9865) (9858 . 9884)) nil (26804 12644 16135 0) 0 nil])
([nil nil ((#("created" 0 7 (face font-lock-builtin-face fontified t)) . -9875) (undo-tree-id148 . -7) (undo-tree-id149 . -4) (undo-tree-id150 . -4) (undo-tree-id151 . -4) (undo-tree-id152 . -4) (undo-tree-id153 . -4) (undo-tree-id154 . -7) (undo-tree-id155 . -7) (undo-tree-id156 . -7) (undo-tree-id157 . -7) (undo-tree-id158 . -7) (undo-tree-id159 . -7) (undo-tree-id160 . -7) (undo-tree-id161 . -7) 9882) nil (26804 12644 16133 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9881 . 9882) (nil fontified nil 9875 . 9882) (9875 . 9882)) nil (26804 12644 16113 0) 0 nil])
([nil nil ((9807 . 9812) (t 26804 12644 0 0)) nil (26804 12709 857602 0) 0 nil])
([nil nil ((9812 . 9816)) nil (26804 12709 857601 0) 0 nil])
([nil nil ((9816 . 9818)) nil (26804 12709 857601 0) 0 nil])
([nil nil ((9818 . 9819)) nil (26804 12709 857600 0) 0 nil])
([nil nil ((9819 . 9828)) nil (26804 12709 857600 0) 0 nil])
([nil nil ((9905 . 9910)) nil (26804 12709 857599 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9925 . 9926) (nil fontified nil 9925 . 9926) (nil fontified nil 9917 . 9925) (nil fontified nil 9910 . 9917) (9910 . 9926)) nil (26804 12709 857599 0) 0 nil])
([nil nil ((9924 . 9925)) nil (26804 12709 857597 0) 0 nil])
([nil nil ((9925 . 9926)) nil (26804 12709 857594 0) 0 nil])
([nil nil ((9617 . 9618) (t 26804 12709 0 0)) nil (26804 13390 645941 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10586 . 10587) (nil fontified nil 9618 . 10587) (9618 . 10587)) nil (26804 13390 645940 0) 0 nil])
([nil nil ((#("(print \"VBBBBE\")
    (print ts)
    (print (getf ts :created))
    (print (getf ts :updated))
    (print \"VBBBBE 1\")" 0 7 (fontified t) 7 15 (face font-lock-string-face fontified t) 15 16 (fontified t) 16 17 (fontified t) 17 32 (fontified t) 32 36 (fontified t) 36 43 (fontified t) 43 52 (fontified t) 52 60 (face font-lock-builtin-face fontified t) 60 61 (fontified t rear-nonsticky t) 61 62 (fontified t rear-nonsticky t) 62 63 (fontified t) 63 67 (fontified t) 67 74 (fontified t) 74 83 (fontified t) 83 84 (face font-lock-builtin-face fontified t) 84 90 (face font-lock-builtin-face fontified t) 90 91 (face font-lock-builtin-face fontified t rear-nonsticky t) 91 92 (fontified t rear-nonsticky t) 92 93 (fontified t rear-nonsticky t) 93 94 (fontified t) 94 98 (fontified t) 98 105 (fontified t) 105 115 (face font-lock-string-face fontified t) 115 116 (fontified t rear-nonsticky t)) . 10782) (undo-tree-id179 . -116) 10898) nil (26804 13390 645940 0) 0 nil])
([nil nil ((10438 . 10443)) nil (26804 13390 645938 0) 0 nil])
([nil nil ((nil fontified nil 10558 . 10559) (nil fontified nil 10548 . 10558) (nil fontified nil 10541 . 10548) (nil fontified nil 10537 . 10541) (nil fontified nil 10536 . 10537) (nil fontified nil 10535 . 10536) (nil fontified nil 10534 . 10535) (nil fontified nil 10533 . 10534) (nil fontified nil 10527 . 10533) (nil fontified nil 10526 . 10527) (nil fontified nil 10517 . 10526) (nil fontified nil 10510 . 10517) (nil fontified nil 10506 . 10510) (nil fontified nil 10505 . 10506) (nil fontified nil 10504 . 10505) (nil fontified nil 10503 . 10504) (nil fontified nil 10495 . 10503) (nil fontified nil 10486 . 10495) (nil fontified nil 10479 . 10486) (nil fontified nil 10475 . 10479) (nil fontified nil 10460 . 10475) (nil fontified nil 10459 . 10460) (nil fontified nil 10458 . 10459) (nil fontified nil 10450 . 10458) (nil fontified nil 10443 . 10450) (10443 . 10559)) nil (26804 13390 645937 0) 0 nil])
([nil nil ((#("

(defun %timestamp-spec-of (md)
  \"Extrait la spec timestamps depuis metadata (:timestamps '(:created :created_at :updated :updated_at :db-fn \\\"now()\\\"))\"
  (let ((ts (getf md :timestamps)))
    
    (values (and ts (getf ts :created))
            (and ts (getf ts :updated))
            (or   (and ts (getf ts :db-fn)) \"CURRENT_TIMESTAMP\"))))" 0 1 (fontified t rear-nonsticky t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 27 (face font-lock-function-name-face fontified t) 27 35 (fontified t) 35 155 (face font-lock-doc-face fontified t) 155 156 (fontified t) 156 159 (fontified t) 159 162 (face font-lock-keyword-face fontified t) 162 177 (fontified t) 177 188 (face font-lock-builtin-face fontified t) 188 192 (fontified t) 192 196 (fontified t) 196 197 (fontified t) 197 226 (fontified t) 226 234 (face font-lock-builtin-face fontified t) 234 266 (fontified t) 266 274 (face font-lock-builtin-face fontified t) 274 312 (fontified t) 312 318 (face font-lock-builtin-face fontified t) 318 321 (fontified t) 321 340 (face font-lock-string-face fontified t) 340 344 (fontified t)) . 10707) (undo-tree-id178 . -344)) nil (26804 13390 645935 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -26232) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) (undo-tree-id172 . -1) (undo-tree-id173 . -1) (undo-tree-id174 . -1) (undo-tree-id175 . -1) (undo-tree-id176 . -1) (undo-tree-id177 . -1) 26233) nil (26804 13390 645931 0) 0 nil])
([nil nil ((10061 . 10062) (t 26804 13390 0 0)) nil (26804 13420 717455 0) 0 nil])
([nil nil ((#("à" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -10061) (undo-tree-id180 . -1) (undo-tree-id181 . -1) (undo-tree-id182 . -1) (undo-tree-id183 . -1) (undo-tree-id184 . -1) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (undo-tree-id188 . -1) 10062) nil (26804 13420 717453 0) 0 nil])
([nil nil ((10061 . 10062)) nil (26804 13420 717435 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -4671) (undo-tree-id195 . -1) 4672 (t 26804 13420 0 0)) nil (26804 13536 572843 0) 0 nil])
([nil nil ((4030 . 4032)) nil (26804 13536 572841 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4790 . 4791) (nil fontified nil 4032 . 4791) (4032 . 4791)) nil (26804 13537 56617 0) 0 nil])
([nil nil ((#("(defgeneric row->entity (class row-alist))
#|
(defmethod row->entity ((class symbol) row)
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (inst (make-instance class)))
    (dolist (f fields inst)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (val  (cdr (assoc col row))))
        (%set-slot inst slot val)))))
|#" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 23 (face font-lock-function-name-face fontified t) 23 43 (fontified t) 43 45 (face font-lock-comment-delimiter-face fontified t) 45 254 (face font-lock-comment-face fontified t) 254 266 (face font-lock-comment-face fontified t) 266 381 (face font-lock-comment-face fontified t) 381 383 (face font-lock-comment-delimiter-face fontified t)) . -9116) (undo-tree-id205 . -383) (undo-tree-id206 . -43) (undo-tree-id207 . -266) (undo-tree-id208 . -42) (undo-tree-id209 . -42) (undo-tree-id210 . -42) (undo-tree-id211 . -42) (undo-tree-id212 . -42) (undo-tree-id213 . -381) (undo-tree-id214 . -383) (undo-tree-id215 . -383) 9499) nil (26804 13557 990394 0) 0 nil] [nil nil ((#("(defgeneric row->entity (class row-alist))
#|
(defmethod row->entity ((class symbol) row)
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (inst (make-instance class)))
    (dolist (f fields inst)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (val  (cdr (assoc col row))))
        (%set-slot inst slot val)))))
|#

(defmethod row->entity ((class symbol) row)
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (inst (make-instance class)))
    (dolist (f fields inst)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (ty   (getf f :type))
             (dbv  (cdr (assoc col row)))
             (val  (coerce-in dbv ty)))
        (%set-slot inst slot val)))))" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 23 (face font-lock-function-name-face fontified t) 23 43 (fontified t) 43 45 (face font-lock-comment-delimiter-face fontified t) 45 254 (face font-lock-comment-face fontified t) 254 266 (face font-lock-comment-face fontified t) 266 381 (face font-lock-comment-face fontified t) 381 383 (face font-lock-comment-delimiter-face fontified t) 383 385 (fontified t) 385 386 (fontified t) 386 395 (face font-lock-keyword-face fontified t) 395 396 (fontified t) 396 407 (face font-lock-function-name-face fontified t) 407 432 (fontified t) 432 436 (face font-lock-keyword-face fontified t) 436 493 (fontified t) 493 500 (face font-lock-builtin-face fontified t) 500 547 (fontified t) 547 553 (face font-lock-keyword-face fontified t) 553 577 (fontified t) 577 581 (face font-lock-keyword-face fontified t) 581 597 (fontified t) 597 602 (face font-lock-builtin-face fontified t) 602 632 (fontified t) 632 636 (face font-lock-builtin-face fontified t) 636 666 (fontified t) 666 671 (face font-lock-builtin-face fontified t) 671 756 (fontified t) 756 793 (fontified t)) . -9116) (undo-tree-id189 . -793) (undo-tree-id190 . -43) (undo-tree-id191 . -266) (undo-tree-id192 . -756) (undo-tree-id193 . -793) (undo-tree-id194 . -793) 9909) ((9116 . 9909)) (26804 13536 572908 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10066 . 10067) (nil fontified nil 9116 . 10067) (9116 . 10067)) nil (26804 13557 990387 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10066 . 10067) (nil fontified nil 9116 . 10067) (9116 . 10067)) ((#(";; --- row->entity -----------------------------------------------------

(defgeneric row->entity (class row-alist))

(defmethod row->entity ((class symbol) (row-alist list))
  \"Construit une instance de CLASS en populant tous les slots à partir d'un alist de ligne.
Lookup des colonnes insensible à la casse (CREATED_AT ≡ created_at).\"
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (obj (make-instance class)))
    (dolist (f fields obj)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (ty   (getf f :type)))
        (multiple-value-bind (v present?) (%alist-find-ci row-alist col)
          ;; On renseigne le slot si la colonne est présente (même si v = NIL / SQL NULL)
          (when present?
            (setf (slot-value obj slot) (%coerce-in-safe v ty))))))
    obj))

(defmethod row->entity ((class standard-class) row-alist)
  (row->entity (class-name class) row-alist))" 0 3 (face font-lock-comment-delimiter-face fontified nil) 3 73 (face font-lock-comment-face fontified nil) 73 75 (fontified nil) 75 85 (face font-lock-keyword-face fontified nil) 85 86 (fontified nil) 86 97 (face font-lock-function-name-face fontified nil) 97 119 (fontified nil) 119 128 (face font-lock-keyword-face fontified nil) 128 129 (fontified nil) 129 140 (face font-lock-function-name-face fontified nil) 140 177 (fontified nil) 177 336 (face font-lock-doc-face fontified nil) 336 340 (fontified nil) 340 344 (face font-lock-keyword-face fontified nil) 344 401 (fontified nil) 401 408 (face font-lock-builtin-face fontified nil) 408 454 (fontified nil) 454 460 (face font-lock-keyword-face fontified nil) 460 483 (fontified nil) 483 487 (face font-lock-keyword-face fontified nil) 487 503 (fontified nil) 503 508 (face font-lock-builtin-face fontified nil) 508 538 (fontified nil) 538 542 (face font-lock-builtin-face fontified nil) 542 572 (fontified nil) 572 577 (face font-lock-builtin-face fontified nil) 577 590 (fontified nil) 590 609 (face font-lock-keyword-face fontified nil) 609 664 (fontified nil) 664 667 (face font-lock-comment-delimiter-face fontified nil) 667 744 (face font-lock-comment-face fontified nil) 744 755 (fontified nil) 755 759 (face font-lock-keyword-face fontified nil) 759 849 (fontified nil) 849 858 (face font-lock-keyword-face fontified nil) 858 859 (fontified nil) 859 870 (face font-lock-function-name-face fontified nil) 870 906 (fontified nil) 906 950 (fontified nil) 950 951 (rear-nonsticky nil fontified nil)) . 9116) (undo-tree-id196 . -951) (undo-tree-id197 . -906) (nil fontified t 9986 . 10022) (nil fontified t 9975 . 9986) (nil fontified t 9974 . 9975) (nil fontified t 9965 . 9974) (nil fontified t 9875 . 9965) (nil fontified t 9871 . 9875) (nil fontified t 9860 . 9871) (nil fontified t 9783 . 9860) (nil fontified t 9780 . 9783) (nil fontified t 9725 . 9780) (nil fontified t 9706 . 9725) (nil fontified t 9693 . 9706) (nil fontified t 9688 . 9693) (nil fontified t 9658 . 9688) (nil fontified t 9654 . 9658) (nil fontified t 9624 . 9654) (nil fontified t 9619 . 9624) (nil fontified t 9603 . 9619) (nil fontified t 9599 . 9603) (nil fontified t 9576 . 9599) (nil fontified t 9570 . 9576) (nil fontified t 9524 . 9570) (nil fontified t 9517 . 9524) (nil fontified t 9460 . 9517) (nil fontified t 9456 . 9460) (nil fontified t 9452 . 9456) (nil fontified t 9293 . 9452) (nil fontified t 9256 . 9293) (nil fontified t 9245 . 9256) (nil fontified t 9244 . 9245) (nil fontified t 9235 . 9244) (nil fontified t 9213 . 9235) (nil fontified t 9202 . 9213) (nil fontified t 9201 . 9202) (nil fontified t 9191 . 9201) (nil fontified t 9189 . 9191) (nil fontified t 9119 . 9189) (nil fontified t 9116 . 9119) (nil rear-nonsticky t 10066 . 10067)) (26804 13536 572823 0) 0 nil])
([nil nil ((#("

(defmethod row->entity ((class symbol) row)
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (inst (make-instance class)))
    (dolist (f fields inst)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (ty   (getf f :type))
             (dbv  (cdr (assoc col row)))
             (val  (coerce-in dbv ty)))
        (%set-slot inst slot val)))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 12 (face font-lock-keyword-face fontified t) 12 13 (fontified t) 13 24 (face font-lock-function-name-face fontified t) 24 49 (fontified t) 49 53 (face font-lock-keyword-face fontified t) 53 110 (fontified t) 110 117 (face font-lock-builtin-face fontified t) 117 164 (fontified t) 164 170 (face font-lock-keyword-face fontified t) 170 194 (fontified t) 194 198 (face font-lock-keyword-face fontified t) 198 214 (fontified t) 214 219 (face font-lock-builtin-face fontified t) 219 249 (fontified t) 249 253 (face font-lock-builtin-face fontified t) 253 283 (fontified t) 283 288 (face font-lock-builtin-face fontified t) 288 373 (fontified t) 373 410 (fontified t)) . 10067) (undo-tree-id198 . -410) (undo-tree-id199 . -410) (undo-tree-id200 . -410) (undo-tree-id201 . -410) (undo-tree-id202 . -410) (undo-tree-id203 . -410) (undo-tree-id204 . -410)) nil (26804 13557 990384 0) 0 nil])
nil
([nil nil ((13677 . 13683) (t 26804 13557 0 0)) nil (26804 13808 910461 0) 0 nil])
([nil nil ((13683 . 13688)) nil (26804 13808 910460 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -13687) (undo-tree-id235 . -1) 13688) nil (26804 13808 910460 0) 0 nil])
([nil nil ((13687 . 13689)) nil (26804 13808 910459 0) 0 nil])
([nil nil ((13689 . 13690)) nil (26804 13808 910458 0) 0 nil])
([nil nil ((13690 . 13692)) nil (26804 13808 910458 0) 0 nil])
([nil nil ((#("y" 0 1 (fontified t)) . -13690) (undo-tree-id233 . -1) (#("s" 0 1 (fontified t)) . -13691) (undo-tree-id234 . -1) 13692) nil (26804 13808 910457 0) 0 nil])
([nil nil ((13690 . 13696)) nil (26804 13808 910455 0) 0 nil])
([nil nil ((13696 . 13702)) nil (26804 13808 910455 0) 0 nil])
([nil nil ((13702 . 13708)) nil (26804 13808 910454 0) 0 nil])
([nil nil ((13708 . 13709)) nil (26804 13808 910454 0) 0 nil])
([nil nil ((13709 . 13716)) nil (26804 13808 910453 0) 0 nil])
([nil nil ((13709 . 13719) (#("values-" 0 7 (fontified t)) . -13709) (undo-tree-id216 . -7) (undo-tree-id217 . -2) (undo-tree-id218 . -2) (undo-tree-id219 . -3) (undo-tree-id220 . -3) (undo-tree-id221 . -5) (undo-tree-id222 . -5) (undo-tree-id223 . -6) (undo-tree-id224 . -6) (undo-tree-id225 . -7) (undo-tree-id226 . -7) (undo-tree-id227 . -7) (undo-tree-id228 . -7) (undo-tree-id229 . -7) (undo-tree-id230 . -7) (undo-tree-id231 . -7) (undo-tree-id232 . -7) 13716) nil (26804 13808 910452 0) 0 nil])
([nil nil ((13720 . 13721)) nil (26804 13808 910430 0) 0 nil])
([nil nil ((22242 . 22243) (t 26804 13808 0 0)) nil (26804 14525 79077 0) 0 nil])
([nil nil ((22243 . 22245)) nil (26804 14525 79076 0) 0 nil])
([nil nil ((27631 . 27633)) nil (26804 14525 79076 0) 0 nil])
([nil nil ((27633 . 27634)) nil (26804 14525 79074 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33979 . 33980) (nil fontified nil 27634 . 33980) (27634 . 33980)) nil (26804 14525 79070 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -22242) (undo-tree-id242 . -1) (#("#" 0 1 (fontified t)) . -22243) (undo-tree-id243 . -1) (#("|" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -22244) (undo-tree-id244 . -1) 22245 (t 26804 14525 0 0)) nil (26804 14967 400431 0) 0 nil])
([nil nil ((#("|" 0 1 (fontified t)) . -27628) (undo-tree-id240 . -1) (#("#" 0 1 (fontified t)) . -27629) (undo-tree-id241 . -1) 27630) nil (26804 14967 400428 0) 0 nil])
([nil nil ((#("
(defmacro defentity (name &key table fields primary-key defaults
                          timestamps lock-version)
  \"Déclare une entité CLOS + enregistre metadata pour CRUD/validation/UI.
FIELDS est une liste de formes:
  (:col <kw> :type <sym|kw> [:required? t] [:validator fn]
         [:default v] [:label \\\"...\\\"] [:input-type :text|...]
         [:placeholder \\\"...\\\"] [:help \\\"...\\\"] [:choices ((v . l) ...)]
         [:min n] [:max n] [:step n] [:pattern \\\"^\\\"] [:attrs ((k . v) ...)]
         [:readonly? t] [:disabled? t] [:hidden? t]
         [:ui-group \\\"...\\\"] [:ui-order n])\"
  (let* ((cls name)
         (pkg  (or (symbol-package name) *package*))
         ;; Table SQL (string)
         (tbl (if table
                  (string-downcase (etypecase table
                                     (string table)
                                     (symbol (symbol-name table))))
                  (string-downcase (symbol-name name))))
         (pk  (or primary-key :id))

         ;; --- normaliser FIELDS fournis ---
         (norm-fields
           (mapcar
            (lambda (f)
              (destructuring-bind (&key col type required? validator default
                                        label input-type placeholder help choices
                                        min max step pattern attrs
                                        readonly? disabled? hidden?
                                        ui-group ui-order slot)
                  f
                (let* ((colkw (%kw (or col (error \"Champ sans :col dans ~a\" name))))
                       ;; slots en UPPERCASE, internés dans le package appelant
                       (slot-name (or slot (intern (string-upcase (symbol-name colkw)) pkg))))
                  (list :col colkw :slot slot-name :type type
                        :required? required? :validator validator :default default
                        :label label :input-type input-type :placeholder placeholder :help help
                        :choices choices :min min :max max :step step :pattern pattern :attrs attrs
                        :readonly? readonly? :disabled? disabled? :hidden? hidden?
                        :ui-group ui-group :ui-order ui-order))))
            fields))

         ;; --- lire timestamps et injecter les champs si absents ---
         (ts   (let ((raw timestamps))
                 (cond ((and (consp raw) (eq (first raw) 'quote)) (second raw))
                       (t raw))))
         (ts-created (and ts (getf ts :created)))
         (ts-updated (and ts (getf ts :updated)))
         (ts-dbfn   (or (and ts (getf ts :db-fn)) \"CURRENT_TIMESTAMP\"))

         (ensure-ts-field
          (lambda (nf col-kw)
            (if (null col-kw)
                nf
                (let* ((present (find col-kw nf :key (lambda (x) (getf x :col)) :test #'eq)))
                  (if present
                      nf
                      ;; injecter un champ read-only/hidden par défaut
                      (let* ((slot-name (intern (string-upcase (symbol-name col-kw)) pkg))
                             (newf (list :col col-kw :slot slot-name
                                         :type :timestamptz
                                         :label (string-capitalize (string col-kw))
                                         :readonly? t :hidden? t :ui-order most-positive-fixnum)))
                        (append nf (list newf))))))))

         (norm-fields*
          (let ((nf norm-fields))
            (setf nf (funcall ensure-ts-field nf ts-created))
            (setf nf (funcall ensure-ts-field nf ts-updated))
            nf))

         ;; --- slots CLOS ---
         (slots
           (append
            ;; dirty tracking
            (list
             `(,+dirty-slot-name+
               :initform (%make-dirty-set)
               :reader ,(intern (format nil \"~a-%%DIRTY\"
                                        (string-downcase (symbol-name name)))
                                pkg)))
            ;; slots issus des fields (y compris timestamps injectés)
            (mapcar
             (lambda (f)
               (let* ((s       (getf f :slot))             ; interné dans PKG
                      (initarg (intern (symbol-name s) :keyword))
                      (acc    (intern (concatenate 'string
                                                   (string-downcase (symbol-name cls))
                                                   \"-\"
                                                   (string-downcase (symbol-name s)))
                                      pkg)))
                 `(,s :initarg ,initarg
                      :accessor ,acc
                      :initform nil)))
             norm-fields*)))

         ;; accessors pour after-method (dirty)
         (accessor-specs
           (mapcar (lambda (f)
                     (let* ((slot (getf f :slot))
                            (acc  (intern (concatenate 'string
                                                       (string-downcase (symbol-name name))
                                                       \"-\"
                                                       (string-downcase (symbol-name slot)))
                                          pkg)))
                       (list slot acc)))
                   norm-fields*))

         ;; defaults alist
         (defaults-alist
           (loop for f in norm-fields*
                 for col = (getf f :col)
                 for def = (getf f :default)
                 when def collect (cons col def))))

    `(progn
       ;; Classe
       (defclass ,cls () ,slots)

       ;; Metadata
       (setf (gethash ',cls *entity-registry*)
             (list :table ,tbl
                   :primary-key ,(%kw pk)
                   :fields ',norm-fields*
                   :defaults ',(or defaults defaults-alist)
                   :timestamps ,(and ts (list :created ts-created :updated ts-updated :db-fn ts-dbfn))
                   :lock-version ',(when lock-version (%kw lock-version))))

       ;; Dirty tracking sur (setf accessor)
       ,@(mapcar
          (lambda (sa)
            (destructuring-bind (slot acc) sa
              `(defmethod (setf ,acc) :after (new (obj ,cls))
                 (declare (ignore new))
                 (mark-dirty obj ',slot))))
          accessor-specs)

       ',cls)))
" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 20 (face font-lock-function-name-face fontified t) 20 27 (fontified t) 27 31 (face font-lock-type-face fontified t) 31 119 (fontified t) 119 226 (face font-lock-doc-face fontified t) 226 230 (face font-lock-doc-face fontified t) 230 236 (face font-lock-doc-face fontified t) 236 241 (face font-lock-doc-face fontified t) 241 316 (face font-lock-doc-face fontified t) 316 334 (face font-lock-doc-face fontified t) 334 339 (face font-lock-doc-face fontified t) 339 345 (face font-lock-doc-face fontified t) 345 591 (face font-lock-doc-face fontified t) 591 595 (fontified t) 595 599 (face font-lock-keyword-face fontified t) 599 674 (fontified t) 674 677 (face font-lock-comment-delimiter-face fontified t) 677 696 (face font-lock-comment-face fontified t) 696 711 (fontified t) 711 713 (face font-lock-keyword-face fontified t) 713 756 (fontified t) 756 765 (face font-lock-keyword-face fontified t) 765 979 (fontified t) 979 982 (face font-lock-builtin-face fontified t) 982 995 (fontified t) 995 998 (face font-lock-comment-delimiter-face fontified t) 998 1032 (face font-lock-comment-face fontified t) 1032 1086 (fontified t) 1086 1092 (face font-lock-keyword-face fontified t) 1092 1112 (fontified t) 1112 1130 (face font-lock-keyword-face fontified t) 1130 1132 (fontified t) 1132 1136 (face font-lock-type-face fontified t) 1136 1492 (fontified t) 1492 1496 (face font-lock-keyword-face fontified t) 1496 1499 (fontified t) 1499 1501 (fontified t) 1501 1519 (fontified t) 1519 1524 (face font-lock-warning-face fontified t) 1524 1525 (fontified t) 1525 1537 (face font-lock-string-face fontified t) 1537 1541 (face font-lock-string-face fontified t) 1541 1550 (face font-lock-string-face fontified t) 1550 1560 (fontified t) 1560 1583 (fontified t) 1583 1586 (face font-lock-comment-delimiter-face fontified t) 1586 1640 (face font-lock-comment-face fontified t) 1640 1759 (fontified t) 1759 1763 (face font-lock-builtin-face fontified t) 1763 1770 (fontified t) 1770 1775 (face font-lock-builtin-face fontified t) 1775 1786 (fontified t) 1786 1791 (face font-lock-builtin-face fontified t) 1791 1821 (fontified t) 1821 1831 (face font-lock-builtin-face fontified t) 1831 1842 (fontified t) 1842 1852 (face font-lock-builtin-face fontified t) 1852 1863 (fontified t) 1863 1871 (face font-lock-builtin-face fontified t) 1871 1904 (fontified t) 1904 1910 (face font-lock-builtin-face fontified t) 1910 1917 (fontified t) 1917 1928 (face font-lock-builtin-face fontified t) 1928 1940 (fontified t) 1940 1952 (face font-lock-builtin-face fontified t) 1952 1965 (fontified t) 1965 1970 (face font-lock-builtin-face fontified t) 1970 2000 (fontified t) 2000 2008 (face font-lock-builtin-face fontified t) 2008 2017 (fontified t) 2017 2021 (face font-lock-builtin-face fontified t) 2021 2026 (fontified t) 2026 2030 (face font-lock-builtin-face fontified t) 2030 2035 (fontified t) 2035 2040 (face font-lock-builtin-face fontified t) 2040 2046 (fontified t) 2046 2054 (face font-lock-builtin-face fontified t) 2054 2063 (fontified t) 2063 2069 (face font-lock-builtin-face fontified t) 2069 2100 (fontified t) 2100 2110 (face font-lock-builtin-face fontified t) 2110 2121 (fontified t) 2121 2131 (face font-lock-builtin-face fontified t) 2131 2142 (fontified t) 2142 2150 (face font-lock-builtin-face fontified t) 2150 2183 (fontified t) 2183 2192 (face font-lock-builtin-face fontified t) 2192 2202 (fontified t) 2202 2211 (face font-lock-builtin-face fontified t) 2211 2256 (fontified t) 2256 2259 (face font-lock-comment-delimiter-face fontified t) 2259 2317 (face font-lock-comment-face fontified t) 2317 2333 (fontified t) 2333 2336 (face font-lock-keyword-face fontified t) 2336 2374 (fontified t) 2374 2378 (face font-lock-keyword-face fontified t) 2378 2508 (fontified t) 2508 2516 (face font-lock-builtin-face fontified t) 2516 2558 (fontified t) 2558 2566 (face font-lock-builtin-face fontified t) 2566 2611 (fontified t) 2611 2617 (face font-lock-builtin-face fontified t) 2617 2620 (fontified t) 2620 2639 (face font-lock-string-face fontified t) 2639 2680 (fontified t) 2680 2686 (face font-lock-keyword-face fontified t) 2686 2712 (fontified t) 2712 2714 (face font-lock-keyword-face fontified t) 2714 2765 (fontified t) 2765 2769 (face font-lock-keyword-face fontified t) 2769 2796 (fontified t) 2796 2800 (face font-lock-builtin-face fontified t) 2800 2802 (fontified t) 2802 2808 (face font-lock-keyword-face fontified t) 2808 2821 (fontified t) 2821 2825 (face font-lock-builtin-face fontified t) 2825 2828 (fontified t) 2828 2833 (face font-lock-builtin-face fontified t) 2833 2861 (fontified t) 2861 2863 (face font-lock-keyword-face fontified t) 2863 2919 (fontified t) 2919 2922 (face font-lock-comment-delimiter-face fontified t) 2922 2968 (face font-lock-comment-face fontified t) 2968 2991 (fontified t) 2991 2995 (face font-lock-keyword-face fontified t) 2995 3060 (fontified t) 3060 3100 (fontified t) 3100 3104 (face font-lock-builtin-face fontified t) 3104 3112 (fontified t) 3112 3117 (face font-lock-builtin-face fontified t) 3117 3128 (fontified t) 3128 3169 (fontified t) 3169 3174 (face font-lock-builtin-face fontified t) 3174 3175 (fontified t) 3175 3187 (face font-lock-builtin-face fontified t) 3187 3229 (fontified t) 3229 3235 (face font-lock-builtin-face fontified t) 3235 3313 (fontified t) 3313 3323 (face font-lock-builtin-face fontified t) 3323 3326 (fontified t) 3326 3334 (face font-lock-builtin-face fontified t) 3334 3337 (fontified t) 3337 3346 (face font-lock-builtin-face fontified t) 3346 3460 (fontified t) 3460 3463 (face font-lock-keyword-face fontified t) 3463 3634 (fontified t) 3634 3637 (face font-lock-comment-delimiter-face fontified t) 3637 3656 (face font-lock-comment-face fontified t) 3656 3703 (fontified t) 3703 3706 (face font-lock-comment-delimiter-face fontified t) 3706 3721 (face font-lock-comment-face fontified t) 3721 3788 (fontified t) 3788 3797 (face font-lock-builtin-face fontified t) 3797 3831 (fontified t) 3831 3838 (face font-lock-builtin-face fontified t) 3838 3860 (fontified t) 3860 3872 (face font-lock-string-face fontified t) 3872 4002 (fontified t) 4002 4005 (face font-lock-comment-delimiter-face fontified t) 4005 4060 (face font-lock-comment-face fontified t) 4060 4094 (fontified t) 4094 4100 (face font-lock-keyword-face fontified t) 4100 4121 (fontified t) 4121 4125 (face font-lock-keyword-face fontified t) 4125 4144 (fontified t) 4144 4149 (face font-lock-builtin-face fontified t) 4149 4164 (fontified t) 4164 4183 (face font-lock-comment-face fontified t) 4183 4238 (fontified t) 4238 4246 (face font-lock-builtin-face fontified t) 4246 4446 (fontified t) 4446 4449 (face font-lock-string-face fontified t) 4449 4603 (fontified t) 4603 4611 (face font-lock-builtin-face fontified t) 4611 4628 (fontified t) 4628 4643 (fontified t) 4643 4652 (face font-lock-builtin-face fontified t) 4652 4658 (fontified t) 4658 4680 (fontified t) 4680 4689 (face font-lock-builtin-face fontified t) 4689 4736 (fontified t) 4736 4739 (face font-lock-comment-delimiter-face fontified t) 4739 4775 (face font-lock-comment-face fontified t) 4775 4820 (fontified t) 4820 4826 (face font-lock-keyword-face fontified t) 4826 4853 (fontified t) 4853 4857 (face font-lock-keyword-face fontified t) 4857 4873 (fontified t) 4873 4878 (face font-lock-builtin-face fontified t) 4878 5091 (fontified t) 5091 5094 (face font-lock-string-face fontified t) 5094 5322 (fontified t) 5322 5325 (face font-lock-comment-delimiter-face fontified t) 5325 5340 (face font-lock-comment-face fontified t) 5340 5377 (fontified t) 5377 5381 (face font-lock-keyword-face fontified t) 5381 5439 (fontified t) 5439 5443 (face font-lock-builtin-face fontified t) 5443 5480 (fontified t) 5480 5488 (face font-lock-builtin-face fontified t) 5488 5549 (fontified t) 5549 5554 (face font-lock-keyword-face fontified t) 5554 5562 (fontified t) 5562 5565 (face font-lock-comment-delimiter-face fontified t) 5565 5572 (face font-lock-comment-face fontified t) 5572 5580 (fontified t) 5580 5588 (face font-lock-keyword-face fontified t) 5588 5613 (fontified t) 5613 5616 (face font-lock-comment-delimiter-face fontified t) 5616 5625 (face font-lock-comment-face fontified t) 5625 5691 (fontified t) 5691 5697 (face font-lock-builtin-face fontified t) 5697 5722 (fontified t) 5722 5734 (face font-lock-builtin-face fontified t) 5734 5764 (fontified t) 5764 5771 (face font-lock-builtin-face fontified t) 5771 5806 (fontified t) 5806 5815 (face font-lock-builtin-face fontified t) 5815 5866 (fontified t) 5866 5877 (face font-lock-builtin-face fontified t) 5877 5893 (fontified t) 5893 5901 (face font-lock-builtin-face fontified t) 5901 5913 (fontified t) 5913 5921 (face font-lock-builtin-face fontified t) 5921 5933 (fontified t) 5933 5939 (face font-lock-builtin-face fontified t) 5939 5969 (fontified t) 5969 5982 (face font-lock-builtin-face fontified t) 5982 5986 (fontified t) 5986 5990 (face font-lock-keyword-face fontified t) 5990 6034 (fontified t) 6034 6037 (face font-lock-comment-delimiter-face fontified t) 6037 6072 (face font-lock-comment-face fontified t) 6072 6100 (fontified t) 6100 6106 (face font-lock-keyword-face fontified t) 6106 6125 (fontified t) 6125 6143 (face font-lock-keyword-face fontified t) 6143 6158 (fontified t) 6158 6174 (fontified t) 6174 6183 (face font-lock-keyword-face fontified t) 6183 6196 (fontified t) 6196 6202 (face font-lock-builtin-face fontified t) 6202 6238 (fontified t) 6238 6245 (face font-lock-keyword-face fontified t) 6245 6346 (fontified t) 6346 6347 (fontified t rear-nonsticky t)) . -27628) (undo-tree-id237 . -6347) (undo-tree-id238 . -6347) (undo-tree-id239 . -5555) 33975) nil (26804 14967 400426 0) 0 nil])
([nil nil ((10067 . 10069)) nil (26804 14967 400423 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10606 . 10607) (nil fontified nil 10069 . 10607) (10069 . 10607)) nil (26804 14967 400422 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -10606) (undo-tree-id236 . -1) 10607) nil (26804 14967 400421 0) 0 nil])
([nil nil ((539 . 543)) nil (26804 14967 400411 0) 0 nil])
([nil nil ((543 . 544)) nil (26804 14967 400410 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 561 . 562) (nil fontified nil 544 . 562) (544 . 562)) nil (26804 14967 400407 0) 0 nil])
([nil nil ((10485 . 10490) (t 26804 14967 0 0)) nil (26804 15176 824120 0) 0 nil])
([nil nil ((10490 . 10497)) nil (26804 15176 824119 0) 0 nil])
([nil nil ((10497 . 10498)) nil (26804 15176 824119 0) 0 nil])
([nil nil ((10498 . 10499)) nil (26804 15176 824118 0) 0 nil])
([nil nil ((10499 . 10500)) nil (26804 15176 824118 0) 0 nil])
([nil nil ((10500 . 10501)) nil (26804 15176 824117 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -10500) (undo-tree-id256 . -1) 10501) nil (26804 15176 824117 0) 0 nil])
([nil nil ((10500 . 10503)) nil (26804 15176 824116 0) 0 nil])
([nil nil ((10503 . 10504)) nil (26804 15176 824115 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -10503) (undo-tree-id255 . -1) 10504) nil (26804 15176 824115 0) 0 nil])
([nil nil ((10503 . 10507)) nil (26804 15176 824114 0) 0 nil])
([nil nil ((10507 . 10508)) nil (26804 15176 824113 0) 0 nil])
([nil nil ((10508 . 10513)) nil (26804 15176 824113 0) 0 nil])
([nil nil ((10513 . 10514)) nil (26804 15176 824112 0) 0 nil])
([nil nil ((10514 . 10518)) nil (26804 15176 824112 0) 0 nil])
([nil nil ((10518 . 10523)) nil (26804 15176 824111 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10550 . 10551) (nil fontified nil 10546 . 10551) (nil fontified nil 10533 . 10546) (nil fontified nil 10523 . 10533) (10523 . 10551)) nil (26804 15176 824111 0) 0 nil])
([nil nil ((#("PKG" 0 3 (face font-lock-string-face fontified t)) . -10536) (undo-tree-id254 . -3) 10539) nil (26804 15176 824110 0) 0 nil])
([nil nil ((10536 . 10538)) nil (26804 15176 824109 0) 0 nil])
([nil nil ((#("pkg" 0 3 (fontified t)) . -10546) (undo-tree-id253 . -3) 10549) nil (26804 15176 824108 0) 0 nil])
([nil nil ((10546 . 10548)) nil (26804 15176 824107 0) 0 nil])
([nil nil ((10549 . 10554)) nil (26804 15176 824107 0) 0 nil])
([nil nil ((10554 . 10559)) nil (26804 15176 824106 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -10557) (undo-tree-id245 . -1) (undo-tree-id246 . -1) (undo-tree-id247 . -1) (undo-tree-id248 . -1) (undo-tree-id249 . -1) (#("n" 0 1 (fontified t)) . -10558) (undo-tree-id250 . -1) (undo-tree-id251 . -1) (undo-tree-id252 . -1) 10559) nil (26804 15176 824105 0) 0 nil])
([nil nil ((10557 . 10560)) nil (26804 15176 824091 0) 0 nil])
([nil nil ((10560 . 10561)) nil (26804 15176 824091 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10580 . 10581) (nil fontified nil 10561 . 10581) (10561 . 10581)) nil (26804 15176 824089 0) 0 nil])
([nil nil ((10581 . 10582)) nil (26804 15176 824085 0) 0 nil])
([nil nil ((4814 . 4816) (t 26804 15176 0 0)) nil (26804 16996 450797 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5127 . 5128) (nil fontified nil 4816 . 5128) (4816 . 5128)) nil (26804 16996 450796 0) 0 nil])
([nil nil ((#("
(defun %coerce-in-safe (value ty)
  \"Appelle COERCE-IN si tu l'as défini; sinon identique.\"
  (if (fboundp 'coerce-in)
      (funcall 'coerce-in value ty)
      value))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 23 (face font-lock-function-name-face fontified t) 23 37 (fontified t) 37 92 (face font-lock-doc-face fontified t) 92 96 (fontified t) 96 98 (face font-lock-keyword-face fontified t) 98 156 (fontified t) 156 168 (fontified t) 168 169 (fontified t rear-nonsticky t) 169 170 (fontified t)) . 4645) (undo-tree-id257 . -170)) nil (26804 16996 450792 0) 0 nil])
([nil nil ((16526 . 16533) (t 26804 16996 0 0)) nil (26804 18518 705445 0) 0 nil])
([nil nil ((16533 . 16534)) nil (26804 18518 705444 0) 0 nil])
([nil nil ((16534 . 16542)) nil (26804 18518 705444 0) 0 nil])
([nil nil ((16542 . 16543)) nil (26804 18518 705443 0) 0 nil])
([nil nil ((16547 . 16548)) nil (26804 18518 705439 0) 0 nil])
([nil nil ((#("
      (format t \"~&CREATED COL: ~A~%\" created-col)
      (format t \"~&UPDATED COL: ~A~%\" updated-col)" 0 1 (face font-lock-comment-face fontified t) 1 17 (fontified t) 17 38 (face font-lock-string-face fontified t) 38 39 (fontified t) 39 49 (fontified t) 49 50 (fontified t rear-nonsticky t) 50 52 (fontified t) 52 58 (fontified t) 58 68 (fontified t) 68 71 (face font-lock-string-face fontified t) 71 77 (face font-lock-string-face fontified t) 77 78 (face font-lock-string-face fontified t rear-nonsticky t) 78 89 (face font-lock-string-face fontified t) 89 90 (fontified t) 90 96 (fontified t) 96 97 (fontified t rear-nonsticky t) 97 100 (fontified t) 100 101 (fontified t rear-nonsticky t) 101 102 (fontified t rear-nonsticky t)) . 13584) (undo-tree-id263 . -102) (undo-tree-id264 . -102) (undo-tree-id265 . -102) (undo-tree-id266 . -102) (undo-tree-id267 . -102) (t 26804 18518 0 0)) nil (26804 18636 888772 0) 0 nil])
([nil nil ((#("
    (print \"VBBBBE\")
    (print ts)
    (print (getf ts :created))
    (print (getf ts :updated))
    (print \"VBBBBE 1\")" 0 1 (fontified t) 1 5 (fontified t) 5 8 (fontified t) 8 12 (fontified t) 12 20 (face font-lock-string-face fontified t) 20 21 (fontified t) 21 22 (fontified t) 22 37 (fontified t) 37 41 (fontified t) 41 48 (fontified t) 48 57 (fontified t) 57 61 (face font-lock-builtin-face fontified t) 61 65 (face font-lock-builtin-face fontified t) 65 66 (fontified t rear-nonsticky t) 66 67 (fontified t rear-nonsticky t) 67 68 (fontified t) 68 72 (fontified t) 72 79 (fontified t) 79 88 (fontified t) 88 89 (face font-lock-builtin-face fontified t) 89 95 (face font-lock-builtin-face fontified t) 95 96 (face font-lock-builtin-face fontified t rear-nonsticky t) 96 97 (fontified t rear-nonsticky t) 97 98 (fontified t rear-nonsticky t) 98 99 (fontified t) 99 103 (fontified t) 103 110 (fontified t) 110 120 (face font-lock-string-face fontified t) 120 121 (fontified t rear-nonsticky t)) . 12160) (undo-tree-id258 . -121) (undo-tree-id259 . -121) (undo-tree-id260 . -121) (undo-tree-id261 . -121) (undo-tree-id262 . -121)) nil (26804 18636 888766 0) 0 nil])
([nil nil ((10726 . 10731) (t 26804 18636 0 0)) nil (26804 19058 677570 0) 0 nil])
([nil nil ((10731 . 10737)) nil (26804 19058 677570 0) 0 nil])
([nil nil ((10737 . 10738)) nil (26804 19058 677569 0) 0 nil])
([nil nil ((10738 . 10747)) nil (26804 19058 677569 0) 0 nil])
([nil nil ((#("X" 0 1 (face font-lock-string-face fontified t)) . -10739) (undo-tree-id268 . -1) (#("X" 0 1 (face font-lock-string-face fontified t)) . -10740) (undo-tree-id269 . -1) (#("X" 0 1 (face font-lock-string-face fontified t)) . -10741) (undo-tree-id270 . -1) (#("X" 0 1 (face font-lock-string-face fontified t)) . -10742) (undo-tree-id271 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -10743) (undo-tree-id272 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -10744) (undo-tree-id273 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -10745) (undo-tree-id274 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -10746) (undo-tree-id275 . -1) 10747) nil (26804 19058 677567 0) 0 nil])
([nil nil ((10739 . 10745)) nil (26804 19058 677551 0) 0 nil])
([nil nil ((10745 . 10747)) nil (26804 19058 677547 0) 0 nil])
([nil nil ((#("
    (format t \"~&PKG: ~A~%\" pkg)
    (format t \"~&UP: ~A~%\" up)" 0 1 (fontified t) 1 15 (fontified t) 15 28 (face font-lock-string-face fontified t) 28 34 (fontified t) 34 38 (fontified t) 38 48 (fontified t) 48 60 (face font-lock-string-face fontified t) 60 63 (fontified t) 63 64 (fontified t rear-nonsticky t)) . 10629) (undo-tree-id280 . -64) (t 26804 19058 0 0)) nil (26804 19868 311111 0) 0 nil])
([nil nil ((#("
    (princ (find-symbol up pkg))
    (print \"BBBcCC\")" 0 1 (fontified t) 1 9 (fontified t) 9 12 (fontified t) 12 31 (fontified t) 31 32 (fontified t rear-nonsticky t) 32 34 (fontified t) 34 45 (fontified t) 45 53 (face font-lock-string-face fontified t) 53 54 (fontified t)) . 10629) (undo-tree-id278 . -54) (undo-tree-id279 . -54)) nil (26804 19895 246815 0) 0 nil])
([nil nil ((#("
		   (print ts-fn)
		   (print values-sql)" 0 1 (fontified t) 1 12 (fontified t) 12 20 (fontified t) 20 32 (fontified t) 32 42 (fontified t) 42 43 (fontified t)) . 14160) (undo-tree-id281 . -43) (undo-tree-id282 . -42) (undo-tree-id283 . -42) (undo-tree-id284 . -42) (undo-tree-id285 . -42) (undo-tree-id286 . -42) (undo-tree-id287 . -43) (undo-tree-id288 . -43) (undo-tree-id289 . -43) (undo-tree-id290 . -43) (undo-tree-id291 . -43) (undo-tree-id292 . -43) (undo-tree-id293 . -43) (undo-tree-id294 . -43)) nil (26804 19906 953966 0) 0 nil] [nil nil ((#("
		   (print ts-fn)
		   (print values-sql))" 0 1 (fontified t) 1 12 (fontified t) 12 20 (fontified t) 20 32 (fontified t) 32 42 (fontified t) 42 44 (fontified t)) . 14160) (undo-tree-id276 . -44)) ((14160 . 14204) (t 26804 19868 0 0)) (26804 19868 311103 0) 0 nil])
([nil nil ((4644 . 4646) (t 26804 19906 0 0)) nil (26804 30097 242770 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 5152 . 5153) (nil fontified nil 4646 . 5153) (4646 . 5153)) nil (26804 30097 242769 0) 0 nil])
([nil nil ((#("

(defun %key-upname (k)
  (etypecase k
    (symbol (string-upcase (symbol-name k)))
    (string (string-upcase k))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 20 (face font-lock-function-name-face fontified t) 20 28 (fontified t) 28 37 (face font-lock-keyword-face fontified t) 37 117 (fontified t)) . 4644) (undo-tree-id298 . -117)) nil (26804 30097 242769 0) 0 nil])
([nil nil ((#("

(defun %alist-find-ci (alist key)
  \"Retourne (values v present-p) en comparant la colonne à KEY (insensible à la casse).
ALIST peut contenir des clés symboles (keywords/symbols) ou strings.\"
  (let ((target (%key-upname key)))
    (loop for (k . v) in alist
          when (string= (%key-upname k) target)
            do (return (values v t))
          finally (return (values nil nil)))))" 0 1 (fontified t) 1 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 23 (face font-lock-function-name-face fontified t) 23 38 (fontified t) 38 193 (face font-lock-doc-face fontified t) 193 197 (fontified t) 197 200 (face font-lock-keyword-face fontified t) 200 235 (fontified t) 235 239 (face font-lock-keyword-face fontified t) 239 325 (fontified t) 325 331 (face font-lock-keyword-face fontified t) 331 365 (fontified t) 365 371 (face font-lock-keyword-face fontified t) 371 391 (fontified t) 391 392 (fontified t rear-nonsticky t)) . 4644) (undo-tree-id297 . -392)) nil (26804 30097 242767 0) 0 nil])
([nil nil ((4958 . 4960)) nil (26804 30097 242766 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5242 . 5243) (nil fontified nil 4960 . 5243) (4960 . 5243)) nil (26804 30097 242765 0) 0 nil])
([nil nil ((#("

(defun %coerce-in-safe (value ty)
  \"Si un coerce-in est défini et renvoie NIL, on garde la valeur d'origine (non-NIL).\"
  (if (fboundp 'coerce-in)
      (let ((cv (ignore-errors (funcall 'coerce-in value ty))))
        (if (and (null cv) (not (null value))) value cv))
      value))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 24 (face font-lock-function-name-face fontified t) 24 38 (fontified t) 38 122 (face font-lock-doc-face fontified t) 122 126 (fontified t) 126 128 (face font-lock-keyword-face fontified t) 128 157 (fontified t) 157 160 (face font-lock-keyword-face fontified t) 160 167 (fontified t) 167 180 (face font-lock-keyword-face fontified t) 180 223 (fontified t) 223 225 (face font-lock-keyword-face fontified t) 225 284 (fontified t) 284 285 (rear-nonsticky t fontified t)) . 4958) (undo-tree-id296 . -285)) nil (26804 30097 242764 0) 0 nil])
([nil nil ((10129 . 10131)) nil (26804 30097 242762 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10940 . 10941) (nil fontified nil 10131 . 10941) (10131 . 10941)) nil (26804 30097 242761 0) 0 nil])
([nil nil ((10838 . 10842)) nil (26804 30097 242760 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10920 . 10921) (nil fontified nil 10845 . 10921) (nil fontified nil 10842 . 10845) (10842 . 10921)) nil (26804 30097 242759 0) 0 nil])
([nil nil ((#("
(defmethod row->entity ((class symbol) (row-alist list))
  \"Construit une instance de CLASS en populant tous les slots à partir d'un alist de ligne.
Lookup des colonnes insensible à la casse (CREATED_AT ≡ created_at).\"
  (let* ((md (entity-metadata class))
         (fields (getf md :fields))
         (obj (make-instance class)))
    (dolist (f fields obj)
      (let* ((slot (getf f :slot))
             (col  (getf f :col))
             (ty   (getf f :type)))
        (multiple-value-bind (v present?) (%alist-find-ci row-alist col)
          ;; On renseigne le slot si la colonne est présente (même si v = NIL / SQL NULL)
          (when present?
            (setf (slot-value obj slot) (%coerce-in-safe v ty))))))
    obj))" 0 1 (fontified t) 1 2 (fontified t) 2 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 23 (face font-lock-function-name-face fontified t) 23 60 (fontified t) 60 137 (face font-lock-doc-face fontified t) 137 150 (face font-lock-doc-face fontified t) 150 219 (face font-lock-doc-face fontified t) 219 223 (fontified t) 223 227 (face font-lock-keyword-face fontified t) 227 284 (fontified t) 284 291 (face font-lock-builtin-face fontified t) 291 337 (fontified t) 337 343 (face font-lock-keyword-face fontified t) 343 366 (fontified t) 366 370 (face font-lock-keyword-face fontified t) 370 386 (fontified t) 386 391 (face font-lock-builtin-face fontified t) 391 421 (fontified t) 421 425 (face font-lock-builtin-face fontified t) 425 455 (fontified t) 455 460 (face font-lock-builtin-face fontified t) 460 473 (fontified t) 473 491 (face font-lock-keyword-face fontified t) 491 492 (face font-lock-keyword-face fontified t) 492 537 (fontified t) 537 547 (fontified t) 547 550 (face font-lock-comment-delimiter-face fontified t) 550 627 (face font-lock-comment-face fontified t) 627 638 (fontified t) 638 642 (face font-lock-keyword-face fontified t) 642 720 (fontified t) 720 729 (fontified t)) . -9400) (undo-tree-id295 . -729) 10129) nil (26804 30097 242757 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 9400)) nil (26804 30097 242745 0) 0 nil])
([nil nil ((4445 . 4448) (t 26804 30097 0 0)) nil (26804 30151 599166 0) 0 nil])
([nil nil ((4448 . 4455)) nil (26804 30151 599166 0) 0 nil])
([nil nil ((4455 . 4456)) nil (26804 30151 912419 0) 0 nil])
([nil nil ((4456 . 4457)) nil (26804 30179 78047 0) 0 nil] [nil nil ((4456 . 4462)) ((#("\"ALIST" 0 6 (face font-lock-string-face fontified t)) . 4456)) (26804 30151 599212 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -4456) (undo-tree-id301 . -1) 4457) nil (26804 30179 78046 0) 0 nil])
([nil nil ((4445 . 4446)) ((#("~" 0 1 (fontified t)) . 4445) (undo-tree-id299 . -1)) (26804 30151 599160 0) 0 nil])
([nil nil ((4456 . 4457)) nil (26804 30179 78044 0) 0 nil])
nil
([nil nil ((4457 . 4458)) nil (26804 30179 78044 0) 0 nil])
([nil nil ((4458 . 4467)) nil (26804 30179 78043 0) 0 nil])
([nil nil ((4467 . 4468)) nil (26804 30179 78043 0) 0 nil])
([nil nil ((4468 . 4472)) nil (26804 30179 78042 0) 0 nil])
([nil nil ((4472 . 4473)) nil (26804 30179 78042 0) 0 nil])
([nil nil ((4473 . 4474)) nil (26804 30179 78041 0) 0 nil])
([nil nil ((4474 . 4480)) nil (26804 30179 78041 0) 0 nil])
([nil nil ((4461 . 4465)) nil (26804 30179 78040 0) 0 nil])
([nil nil ((4465 . 4466)) nil (26804 30179 78040 0) 0 nil])
([nil nil ((4466 . 4468)) nil (26804 30179 78040 0) 0 nil])
([nil nil ((4468 . 4470)) nil (26804 30179 78039 0) 0 nil])
([nil nil ((4483 . 4484)) nil (26804 30179 78038 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -4483) (undo-tree-id300 . -1) 4484) nil (26804 30179 78037 0) 0 nil])
([nil nil ((4483 . 4486)) nil (26804 30179 78027 0) 0 nil])
([nil nil ((4486 . 4487)) nil (26804 30179 78023 0) 0 nil])
([nil nil ((#("(defun %alist-find-ci (alist key)
  \"Retourne (values value present-p) en comparant la colonne à KEY (insensible à la casse).
ALIST peut avoir des clés symboles (keywords) ou strings.\"
  (format t \"~&KEY: ~A~%ALIST: ~A~%\" key alist)
  (let ((target (%key-upname key)))
    (loop for (k . v) in alist
          when (string= (%key-upname k) target)
            do (return (values v t))
          finally (return (values nil nil)))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 21 (face font-lock-function-name-face fontified t) 21 36 (fontified t) 36 126 (face font-lock-doc-face fontified t) 126 184 (face font-lock-doc-face fontified t) 184 185 (fontified t) 185 197 (fontified t) 197 221 (face font-lock-string-face fontified t) 221 232 (fontified t) 232 233 (fontified t) 233 236 (fontified t) 236 239 (face font-lock-keyword-face fontified t) 239 274 (fontified t) 274 278 (face font-lock-keyword-face fontified t) 278 364 (fontified t) 364 370 (face font-lock-keyword-face fontified t) 370 385 (fontified t) 385 404 (fontified t) 404 410 (face font-lock-keyword-face fontified t) 410 431 (fontified t)) . -4261) (undo-tree-id313 . -431) (undo-tree-id314 . -431) 4692 (t 26804 30179 0 0)) nil (26804 30822 26686 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5044 . 5045) (nil fontified nil 4261 . 5045) (4261 . 5045)) nil (26804 30822 26684 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -4339) (undo-tree-id312 . -1) 4340) nil (26804 30822 26684 0) 0 nil])
([nil nil ((#("(defun %key-upname (k)
  \"Nom logique (UPCASE) d'une clé symbol/string pour comparaison insensible à la casse.\"
  (etypecase k
    (symbol (string-upcase (symbol-name k)))
    (string (string-upcase k))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 18 (face font-lock-function-name-face fontified t) 18 25 (fontified t) 25 111 (face font-lock-doc-face fontified t) 111 115 (fontified t) 115 124 (face font-lock-keyword-face fontified t) 124 204 (fontified t)) . 4055) (undo-tree-id311 . -204) 4259) nil (26804 30822 26682 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -4053) (undo-tree-id307 . -1) (undo-tree-id308 . -1) (#("
" 0 1 (fontified t)) . -4054) (undo-tree-id309 . -1) (undo-tree-id310 . -1) 4055) nil (26804 30822 26681 0) 0 nil])
([nil nil ((4133 . 4134)) nil (26804 30822 26678 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified nil)) . 4134) (undo-tree-id306 . -1) (4133 . 4134) (#("-" 0 1 (face font-lock-comment-face fontified nil)) . 4132) (4133 . 4134) 4134) nil (26804 30822 26677 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -4133) (undo-tree-id305 . -1) 4134) nil (26804 30822 26675 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4336 . 4337) (nil fontified nil 4257 . 4337) (nil fontified nil 4248 . 4257) (nil fontified nil 4244 . 4248) (nil fontified nil 4158 . 4244) (nil fontified nil 4151 . 4158) (nil fontified nil 4140 . 4151) (nil fontified nil 4139 . 4140) (nil fontified nil 4134 . 4139) (nil fontified nil 4133 . 4134) (4133 . 4337)) nil (26804 30822 26673 0) 0 nil])
([nil nil ((4337 . 4338)) nil (26804 30822 26671 0) 0 nil])
([nil nil ((#("
(defun %key-upname (k)
  \"Nom logique (UPCASE) d'une clé symbol/string pour comparaison insensible à la casse.\"
  (etypecase k
    (symbol (string-upcase (symbol-name k)))
    (string (string-upcase k))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 19 (face font-lock-function-name-face fontified t) 19 26 (fontified t) 26 112 (face font-lock-doc-face fontified t) 112 116 (fontified t) 116 125 (face font-lock-keyword-face fontified t) 125 173 (fontified t) 173 204 (fontified t) 204 205 (rear-nonsticky t fontified t)) . -4132) (undo-tree-id302 . -205) (undo-tree-id303 . -1) (undo-tree-id304 . -8) 4337) nil (26804 30822 26669 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 4132)) nil (26804 30822 26654 0) 0 nil])
([nil nil ((4053 . 4055) (t 26804 30822 0 0)) nil (26804 31129 190372 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4212 . 4213) (nil fontified nil 4055 . 4213) (4055 . 4213)) nil (26804 31129 190368 0) 0 nil])
([nil nil ((23217 . 23218) (t 26804 31129 0 0)) nil (26804 35079 360754 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23264 . 23265) (nil fontified nil 23218 . 23265) (23218 . 23265)) nil (26804 35079 360754 0) 0 nil])
([nil nil ((23265 . 23267)) nil (26804 35079 360753 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24100 . 24101) (nil fontified nil 23267 . 24101) (23267 . 24101)) nil (26804 35079 360752 0) 0 nil])
([nil nil ((26947 . 26954)) nil (26804 35079 360752 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27147 . 27148) (nil fontified nil 26954 . 27148) (26954 . 27148)) nil (26804 35079 360751 0) 0 nil])
([nil nil ((5899 . 5901)) nil (26804 35079 360751 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6369 . 6370) (nil fontified nil 5901 . 6370) (5901 . 6370)) nil (26804 35079 360750 0) 0 nil])
([nil nil ((5733 . 5734)) nil (26804 35079 360749 0) 0 nil])
([nil nil ((5734 . 5736)) nil (26804 35079 360748 0) 0 nil])
([nil nil ((5903 . 5905)) nil (26804 35079 360748 0) 0 nil])
([nil nil ((5905 . 5906)) nil (26804 35079 542038 0) 0 nil])
([nil nil ((11114 . 11119)) ((#("
    " 0 1 (fontified t) 1 5 (fontified t)) . 11114) (undo-tree-id316 . -5) (undo-tree-id317 . -5) (undo-tree-id318 . -1) (undo-tree-id319 . -5) (undo-tree-id320 . -1) (undo-tree-id321 . -5)) (26804 35089 305529 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11140 . 11141) (11119 . 11141)) ((#("(snapshot-entity! obj)" 0 21 (fontified nil) 21 22 (rear-nonsticky nil fontified nil)) . 11119) (undo-tree-id315 . -22) (nil rear-nonsticky t 11140 . 11141)) (26804 35092 586065 0) 0 nil])
([nil nil ((17126 . 17129)) nil (26804 35230 980137 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17150 . 17151) (nil fontified nil 17129 . 17151) (17129 . 17151)) nil (26804 35230 980137 0) 0 nil])
([nil nil ((22431 . 22436)) nil (26804 35230 980135 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22457 . 22458) (nil fontified nil 22436 . 22458) (22436 . 22458)) nil (26804 35230 980132 0) 0 nil])
([nil nil ((7787 . 7789) (t 26804 35230 0 0)) nil (26804 35870 638727 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8117 . 8118) (nil fontified nil 7789 . 8118) (7789 . 8118)) nil (26804 35870 638723 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -8117) (undo-tree-id322 . -1) (undo-tree-id323 . -1) (undo-tree-id324 . -1) (undo-tree-id325 . -1) 8118 (t 26804 35870 0 0)) nil (26804 35871 757183 0) 0 nil])
([nil nil ((539 . 540) (t 26804 35871 0 0)) nil (26804 35952 248100 0) 0 nil])
([nil nil ((540 . 541)) nil (26804 35952 248099 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 563 . 564) (nil fontified nil 541 . 564) (541 . 564)) nil (26804 35952 248095 0) 0 nil])
([nil nil ((12150 . 12153) (t 26804 35952 0 0)) nil (26805 40333 886764 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12922 . 12923) (nil fontified nil 12153 . 12923) (12153 . 12923)) nil (26805 40333 886763 0) 0 nil])
([nil nil ((#("%" 0 1 (fontified t)) . -12792) (undo-tree-id339 . -1) 12793) nil (26805 40333 886763 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . 12799) (#("u" 0 1 (fontified t)) . 12799) (#("o" 0 1 (fontified t)) . 12799)) nil (26805 40333 886761 0) 0 nil])
([nil nil ((12799 . 12801)) nil (26805 40333 886761 0) 0 nil])
([nil nil ((#("val" 0 3 (fontified t)) . 12817) (undo-tree-id338 . -3) 12820) nil (26805 40333 886760 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -12816) (undo-tree-id336 . -1) (undo-tree-id337 . -1) 12817) nil (26805 40333 886759 0) 0 nil])
([nil nil ((12802 . 12803)) nil (26805 40333 886757 0) 0 nil])
([nil nil ((#("y" 0 1 (fontified t)) . -12802) (undo-tree-id335 . -1) 12803) nil (26805 40333 886757 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12804 . 12805) (nil fontified nil 12802 . 12805) (12802 . 12805)) nil (26805 40333 886756 0) 0 nil])
([nil nil ((12805 . 12806)) nil (26805 40333 886755 0) 0 nil])
([nil nil ((#("%" 0 1 (fontified t)) . -12464) (undo-tree-id334 . -1) 12465) nil (26805 40333 886755 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12714 . 12715) (nil fontified nil 12152 . 12715) (12152 . 12715)) nil (26805 40333 886754 0) 0 nil])
([nil nil ((12715 . 12716)) nil (26805 40333 886753 0) 0 nil])
([nil nil ((12151 . 12152)) nil (26805 40333 886753 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12223 . 12224) (nil fontified nil 12155 . 12224) (nil fontified nil 12152 . 12155) (12152 . 12224)) nil (26805 40333 886752 0) 0 nil])
([nil nil ((#("->" 0 2 (face font-lock-comment-face fontified t)) . 12162) (undo-tree-id333 . -2) 12164) nil (26805 40333 886751 0) 0 nil])
([nil nil ((#("r" 0 1 (face font-lock-comment-face fontified t)) . -12159) (undo-tree-id327 . -1) (undo-tree-id328 . -1) (#("o" 0 1 (face font-lock-comment-face fontified t)) . -12160) (undo-tree-id329 . -1) (undo-tree-id330 . -1) (#("w" 0 1 (face font-lock-comment-face fontified t)) . -12161) (undo-tree-id331 . -1) (undo-tree-id332 . -1) 12162) nil (26805 40333 886749 0) 0 nil])
([nil nil ((12165 . 12166)) nil (26805 40333 886738 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12167 . 12168) (nil fontified nil 12166 . 12168) (12166 . 12168)) nil (26805 40333 886737 0) 0 nil])
([nil nil ((12168 . 12169)) nil (26805 40333 886737 0) 0 nil])
([nil nil ((12169 . 12172)) nil (26805 40333 886736 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-comment-face fontified t)) . -12171) (undo-tree-id326 . -1) 12172) nil (26805 40333 886735 0) 0 nil])
([nil nil ((12171 . 12174)) nil (26805 40333 886727 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 183 . 184) (nil fontified nil 167 . 184) (167 . 184)) nil (26805 40333 886726 0) 0 nil])
([nil nil ((184 . 185)) nil (26805 40333 886725 0) 0 nil])
([nil nil ((167 . 168)) nil (26805 40333 886721 0) 0 nil])
([nil nil ((8910 . 8915) (t 26805 40333 0 0)) nil (26808 27497 810490 0) 0 nil])
([nil nil ((8915 . 8921)) nil (26808 27497 810489 0) 0 nil])
([nil nil ((8921 . 8922)) nil (26808 27497 810488 0) 0 nil])
([nil nil ((8922 . 8929)) nil (26808 27497 810484 0) 0 nil])
([nil nil ((8915 . 8917) (t 26808 27497 0 0)) nil (26809 23763 52349 0) 0 nil])
([nil nil ((9490 . 9495)) nil (26809 23763 52348 0) 0 nil])
([nil nil ((9495 . 9501)) nil (26809 23763 52348 0) 0 nil])
([nil nil ((9501 . 9502)) nil (26809 23763 52347 0) 0 nil])
([nil nil ((9502 . 9513)) nil (26809 23763 52347 0) 0 nil])
([nil nil ((9513 . 9514)) nil (26809 23763 52347 0) 0 nil])
([nil nil ((9514 . 9520)) nil (26809 23763 52346 0) 0 nil])
([nil nil ((9520 . 9521)) nil (26809 23763 52346 0) 0 nil])
([nil nil ((9521 . 9525)) nil (26809 23763 52345 0) 0 nil])
([nil nil ((9503 . 9509)) nil (26809 23763 52344 0) 0 nil])
([nil nil ((9509 . 9510)) nil (26809 23763 52340 0) 0 nil])
([nil nil ((18454 . 18460) (t 26809 23763 0 0)) nil (26809 24127 672201 0) 0 nil])
([nil nil ((18460 . 18466)) nil (26809 24127 672200 0) 0 nil])
([nil nil ((18466 . 18467)) nil (26809 24127 672199 0) 0 nil])
([nil nil ((18467 . 18471)) nil (26809 24127 672196 0) 0 nil])
([nil nil ((2262 . 2265) (t 26809 24127 0 0)) nil (26809 36947 160072 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -2262) (undo-tree-id0 . -1) (#("a" 0 1 (fontified t)) . -2263) (undo-tree-id1 . -1) (#("c" 0 1 (fontified t)) . -2264) (undo-tree-id2 . -1) 2265) nil (26809 36947 160068 0) 0 nil])
([nil nil ((4814 . 4817) (t 26809 36947 0 0)) nil (26809 37096 860828 0) 0 nil])
([nil nil ((4817 . 4823)) nil (26809 37096 860827 0) 0 nil])
([nil nil ((4823 . 4824)) nil (26809 37096 860827 0) 0 nil])
([nil nil ((4824 . 4828)) nil (26809 37096 860826 0) 0 nil])
([nil nil ((4867 . 4872)) nil (26809 37096 860876 0) 0 nil])
([nil nil ((4872 . 4878)) nil (26809 37198 30316 0) 0 nil] [nil nil ((nil rear-nonsticky nil 4885 . 4886) (nil fontified nil 4872 . 4886) (4872 . 4886)) ((#("%alist-find-ci" 0 13 (fontified nil) 13 14 (rear-nonsticky nil fontified nil)) . 4872) (undo-tree-id3 . -14) (nil rear-nonsticky t 4885 . 4886)) (26809 37096 860822 0) 0 nil])
([nil nil ((4878 . 4879)) nil (26809 37198 30315 0) 0 nil])
nil
([nil nil ((4879 . 4886)) nil (26809 37198 30315 0) 0 nil])
([nil nil ((4886 . 4891)) nil (26809 37198 30314 0) 0 nil])
([nil nil ((4891 . 4897)) nil (26809 37198 30314 0) 0 nil])
([nil nil ((4897 . 4898)) nil (26809 37198 30314 0) 0 nil])
([nil nil ((#("(print " 0 7 (fontified t)) . 4891)) nil (26809 37198 30313 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5018 . 5019) (nil fontified nil 5012 . 5019) (5012 . 5019)) nil (26809 37198 30313 0) 0 nil])
([nil nil ((5019 . 5022) (#(" " 0 1 (rear-nonsticky t fontified nil)) . 5018) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (5019 . 5020)) nil (26809 37198 30311 0) 0 nil])
([nil nil ((5018 . 5019)) nil (26809 37198 30296 0) 0 nil])
([nil nil ((5019 . 5020)) nil (26809 37198 30296 0) 0 nil])
([nil nil ((5020 . 5022)) nil (26809 37198 30295 0) 0 nil])
([nil nil ((5026 . 5027)) nil (26809 37198 30294 0) 0 nil])
([nil nil ((5047 . 5048)) nil (26809 37198 30291 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . 5012) (t 26809 37198 0 0)) nil (26809 37260 928748 0) 0 nil])
([nil nil ((5012 . 5017)) nil (26809 37260 928747 0) 0 nil])
([nil nil ((5017 . 5018)) nil (26809 37260 928747 0) 0 nil])
([nil nil ((5018 . 5019)) nil (26809 37260 928746 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -5018) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) 5019) nil (26809 37260 928745 0) 0 nil])
([nil nil ((5018 . 5019)) nil (26809 37260 928732 0) 0 nil])
([nil nil ((11230 . 11235) (t 26809 37260 0 0)) nil (26809 37732 470302 0) 0 nil])
([nil nil ((11235 . 11241)) nil (26809 37732 470301 0) 0 nil])
([nil nil ((11241 . 11242)) nil (26809 37732 470300 0) 0 nil])
([nil nil ((11242 . 11248)) nil (26809 37732 470300 0) 0 nil])
([nil nil ((#("l" 0 1 (fontified t)) . -11244) (undo-tree-id12 . -1) (#("e" 0 1 (fontified t)) . -11245) (undo-tree-id13 . -1) (#("d" 0 1 (fontified t)) . -11246) (undo-tree-id14 . -1) (#("s" 0 1 (fontified t)) . -11247) (undo-tree-id15 . -1) 11248) nil (26809 37732 470298 0) 0 nil])
([nil nil ((11244 . 11249)) nil (26809 37732 470284 0) 0 nil])
([nil nil ((#("
    (print target)" 0 1 (fontified t) 1 19 (fontified t)) . 4867) (undo-tree-id23 . -19) (t 26809 37732 0 0)) nil (26809 39796 696609 0) 0 nil])
([nil nil ((#("
  (print key)" 0 1 (fontified t) 1 14 (fontified t)) . 4814) (undo-tree-id22 . -14)) nil (26809 39796 696608 0) 0 nil])
([nil nil ((#("(progn (print ks)
		 " 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 8 (fontified t) 8 17 (fontified t) 17 18 (fontified t) 18 21 (fontified t)) . -4978) (undo-tree-id21 . -21) 4999) nil (26809 39796 696607 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -4999) (undo-tree-id20 . -1) 5000) nil (26809 39796 696606 0) 0 nil])
([nil nil ((11180 . 11182)) nil (26809 39796 696604 0) 0 nil])
([nil nil ((11484 . 11488)) nil (26809 39796 696604 0) 0 nil])
([nil nil ((11488 . 11494)) nil (26809 39796 696604 0) 0 nil])
([nil nil ((11494 . 11495)) nil (26809 39796 696603 0) 0 nil])
([nil nil ((11495 . 11497)) nil (26809 39796 696603 0) 0 nil])
([nil nil ((11497 . 11501)) nil (26809 39796 696602 0) 0 nil])
([nil nil ((11501 . 11502)) nil (26809 39796 696602 0) 0 nil])
([nil nil ((11502 . 11503)) nil (26809 39796 696602 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -11502) (undo-tree-id19 . -1) 11503) nil (26809 39796 696601 0) 0 nil])
([nil nil ((11502 . 11507)) nil (26809 39796 696600 0) 0 nil])
([nil nil ((11507 . 11508)) nil (26809 39796 696600 0) 0 nil])
([nil nil ((11508 . 11510)) nil (26809 39796 696600 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -11509) (undo-tree-id18 . -1) 11510) nil (26809 39796 696599 0) 0 nil])
([nil nil ((11509 . 11510)) nil (26809 39796 696598 0) 0 nil])
([nil nil ((11510 . 11514)) nil (26809 39796 696597 0) 0 nil])
([nil nil ((11514 . 11520)) nil (26809 39796 696597 0) 0 nil])
([nil nil ((11520 . 11521)) nil (26809 39796 696597 0) 0 nil])
([nil nil ((11521 . 11529)) nil (26809 39796 696596 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -11528) (undo-tree-id17 . -1) 11529) nil (26809 39796 696596 0) 0 nil])
([nil nil ((11528 . 11529)) nil (26809 39796 696594 0) 0 nil])
([nil nil ((#("/" 0 1 (fontified t)) . -11528) (undo-tree-id16 . -1) 11529) nil (26809 39796 696593 0) 0 nil])
([nil nil ((11528 . 11530)) nil (26809 39796 696584 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . 11521)) nil (26809 39796 696583 0) 0 nil])
([nil nil ((11521 . 11522)) nil (26809 39796 696579 0) 0 nil])
([nil nil ((#("f" 0 1 (fontified t)) . -11495) (undo-tree-id24 . -1) 11496 (t 26809 39796 0 0)) nil (26809 40143 568347 0) 0 nil])
([nil nil ((11495 . 11498)) nil (26809 40143 568336 0) 0 nil])
([nil nil ((23835 . 23842) (#("	      " 0 7 (fontified nil)) . 23834) (undo-tree-id38 . -7) (23833 . 23842) (t 26809 40143 0 0)) nil (26809 41399 685112 0) 0 nil])
([nil nil ((23842 . 23848)) nil (26809 41399 685111 0) 0 nil])
([nil nil ((23848 . 23849)) nil (26809 41399 685111 0) 0 nil])
([nil nil ((23849 . 23870)) nil (26809 41399 685110 0) 0 nil])
([nil nil ((23870 . 23882)) nil (26809 41399 685110 0) 0 nil])
([nil nil ((23882 . 23890)) nil (26809 41399 685109 0) 0 nil])
([nil nil ((23890 . 23896)) nil (26809 41399 685109 0) 0 nil])
([nil nil ((23896 . 23897)) nil (26809 41399 685109 0) 0 nil])
([nil nil ((23897 . 23906)) nil (26809 41399 685108 0) 0 nil])
([nil nil ((#("=" 0 1 (fontified t)) . -23905) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) 23906) nil (26809 41399 685108 0) 0 nil])
([nil nil ((23905 . 23906)) nil (26809 41399 685103 0) 0 nil])
([nil nil ((23906 . 23914)) nil (26809 41399 685103 0) 0 nil])
([nil nil ((23914 . 23919)) nil (26809 41399 685102 0) 0 nil])
([nil nil ((23919 . 23920)) nil (26809 41399 685102 0) 0 nil])
([nil nil ((23920 . 23921)) nil (26809 41399 685102 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -23919) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (#("t" 0 1 (fontified t)) . -23920) (undo-tree-id30 . -1) 23921) nil (26809 41399 685100 0) 0 nil])
([nil nil ((23919 . 23920)) nil (26809 41399 685085 0) 0 nil])
([nil nil ((23920 . 23921)) nil (26809 41399 685084 0) 0 nil])
([nil nil ((23921 . 23925)) nil (26809 41399 685080 0) 0 nil])
([nil nil ((24552 . 24559) (t 26809 41399 0 0)) nil (26809 42858 499861 0) 0 nil])
([nil nil ((24559 . 24560)) nil (26809 42858 499860 0) 0 nil])
([nil nil ((24560 . 24568)) nil (26809 42858 499859 0) 0 nil])
([nil nil ((24568 . 24569)) nil (26809 42858 499859 0) 0 nil])
([nil nil ((24581 . 24582)) nil (26809 42858 499855 0) 0 nil])
([nil nil ((#("
	      (print \"BBBBBBBBBBBBBBBBBBBBBBBBBBBBBB\")
	      (print affected)
	      (print ret)" 0 1 (fontified t) 1 15 (fontified t) 15 47 (face font-lock-string-face fontified t) 47 49 (fontified t) 49 73 (fontified t) 73 91 (fontified t)) . 23834) (undo-tree-id39 . -91) (t 26809 42858 0 0)) nil (26810 38823 34659 0) 0 nil])
([nil nil ((#("

(defun %make-dirty-set () (make-hash-table :test 'eq))" 0 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 24 (face font-lock-function-name-face fontified t) 24 45 (fontified t) 45 50 (face font-lock-builtin-face fontified t) 50 56 (fontified t)) . 25779) (undo-tree-id0 . -56) (undo-tree-id1 . -9) (undo-tree-id2 . -2) (undo-tree-id3 . -24) (undo-tree-id4 . -24) (undo-tree-id5 . -24) (undo-tree-id6 . -24) (undo-tree-id7 . -56) (undo-tree-id8 . -56) (undo-tree-id9 . -56) (undo-tree-id10 . -56) (undo-tree-id11 . -56) (t 26810 38823 0 0)) nil (26812 45652 788479 0) 0 nil])
([nil nil ((#("
              (declare (ignore affected))" 0 16 (fontified t) 16 23 (face font-lock-keyword-face fontified t) 23 42 (fontified t)) . 18661) (undo-tree-id14 . -42) (t 26812 45652 0 0)) nil (26812 51560 305150 0) 0 nil])
([nil nil ((15976 . 15978)) nil (26812 51560 305147 0) 0 nil])
([nil nil ((16060 . 16063)) nil (26812 51560 305147 0) 0 nil])
([nil nil ((16028 . 16030)) nil (26812 51560 305145 0) 0 nil])
([nil nil ((#("
	 (x (format t \"~&PKG: ~A~%\" pkg))" 0 1 (fontified t) 1 16 (fontified t) 16 29 (face font-lock-string-face fontified t) 29 35 (fontified t)) . 27269) (undo-tree-id12 . -35) (undo-tree-id13 . -35)) nil (26812 51560 305140 0) 0 nil])
([nil nil ((#("(defmacro defentity (name &key table fields primary-key defaults
                          timestamps lock-version)
  \"Déclare une entité CLOS + enregistre metadata pour CRUD/validation/UI.
FIELDS est une liste de formes:
  (:col <kw> :type <sym|kw> [:required? t] [:validator fn]
         [:default v] [:label \\\"...\\\"] [:input-type :text|...]
         [:placeholder \\\"...\\\"] [:help \\\"...\\\"] [:choices ((v . l) ...)]
         [:min n] [:max n] [:step n] [:pattern \\\"^\\\"] [:attrs ((k . v) ...)]
         [:readonly? t] [:disabled? t] [:hidden? t]
         [:ui-group \\\"...\\\"] [:ui-order n])\"
  (let* ((cls name)
         ;; package d'accueil de la classe (là où seront créés slots/accessors)
         (pkg  (or (symbol-package name) *package*))
         ;; Table SQL : string en minuscules (ex. :users → \"users\")
         (tbl (if table
                  (string-downcase (etypecase table
                                     (string table)
                                     (symbol (symbol-name table))))
                  (string-downcase (symbol-name name))))
         (pk  (or primary-key :id))
         ;; Normaliser FIELDS : poser :slot ; :col en keyword canonique
         ;; IMPORTANT: slots seront INTERNÉS dans PKG en UPPERCASE (non échappés)
         (norm-fields
           (mapcar
            (lambda (f)
              (destructuring-bind (&key col type required? validator default
                                        label input-type placeholder help choices
                                        min max step pattern attrs
                                        readonly? disabled? hidden?
                                        ui-group ui-order slot)
                  f
                (let* ((colkw (%kw (or col (error \"Champ sans :col dans ~a\" name))))
                       (slot-name (or slot
                                      (intern (string-upcase (symbol-name colkw))
					      pkg))))
                  (list :col colkw :slot slot-name :type type
                        :required? required? :validator validator :default default
                        :label label :input-type input-type :placeholder placeholder
			:help help :choices choices :min min :max max :step step
			:pattern pattern :attrs attrs :readonly? readonly?
			:disabled? disabled? :hidden? hidden?
                        :ui-group ui-group :ui-order ui-order))))
            fields))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 19 (face font-lock-function-name-face fontified t) 19 26 (fontified t) 26 30 (face font-lock-type-face fontified t) 30 118 (fontified t) 118 499 (face font-lock-doc-face fontified t) 499 546 (face font-lock-doc-face fontified t) 546 590 (face font-lock-doc-face fontified t) 590 594 (fontified t) 594 598 (face font-lock-keyword-face fontified t) 598 620 (fontified t) 620 623 (face font-lock-comment-delimiter-face fontified t) 623 691 (face font-lock-comment-face fontified t) 691 753 (fontified t) 753 756 (face font-lock-comment-delimiter-face fontified t) 756 812 (face font-lock-comment-face fontified t) 812 827 (fontified t) 827 829 (face font-lock-keyword-face fontified t) 829 872 (fontified t) 872 881 (face font-lock-keyword-face fontified t) 881 1095 (fontified t) 1095 1098 (face font-lock-builtin-face fontified t) 1098 1110 (fontified t) 1110 1113 (face font-lock-comment-delimiter-face fontified t) 1113 1173 (face font-lock-comment-face fontified t) 1173 1182 (fontified t) 1182 1185 (face font-lock-comment-delimiter-face fontified t) 1185 1255 (face font-lock-comment-face fontified t) 1255 1309 (fontified t) 1309 1315 (face font-lock-keyword-face fontified t) 1315 1335 (fontified t) 1335 1353 (face font-lock-keyword-face fontified t) 1353 1355 (fontified t) 1355 1359 (face font-lock-type-face fontified t) 1359 1715 (fontified t) 1715 1719 (face font-lock-keyword-face fontified t) 1719 1742 (fontified t) 1742 1747 (face font-lock-warning-face fontified t) 1747 1748 (fontified t) 1748 1773 (face font-lock-string-face fontified t) 1773 1951 (fontified t) 1951 1955 (face font-lock-builtin-face fontified t) 1955 1962 (fontified t) 1962 1967 (face font-lock-builtin-face fontified t) 1967 1978 (fontified t) 1978 1983 (face font-lock-builtin-face fontified t) 1983 2013 (fontified t) 2013 2023 (face font-lock-builtin-face fontified t) 2023 2034 (fontified t) 2034 2044 (face font-lock-builtin-face fontified t) 2044 2046 (fontified t) 2046 2055 (fontified t) 2055 2063 (face font-lock-builtin-face fontified t) 2063 2072 (fontified t) 2072 2096 (fontified t) 2096 2102 (face font-lock-builtin-face fontified t) 2102 2109 (fontified t) 2109 2120 (face font-lock-builtin-face fontified t) 2120 2132 (fontified t) 2132 2144 (face font-lock-builtin-face fontified t) 2144 2160 (fontified t) 2160 2165 (face font-lock-builtin-face fontified t) 2165 2171 (fontified t) 2171 2179 (face font-lock-builtin-face fontified t) 2179 2188 (fontified t) 2188 2192 (face font-lock-builtin-face fontified t) 2192 2197 (fontified t) 2197 2201 (face font-lock-builtin-face fontified t) 2201 2206 (fontified t) 2206 2211 (face font-lock-builtin-face fontified t) 2211 2220 (fontified t) 2220 2228 (face font-lock-builtin-face fontified t) 2228 2237 (fontified t) 2237 2243 (face font-lock-builtin-face fontified t) 2243 2250 (fontified t) 2250 2260 (face font-lock-builtin-face fontified t) 2260 2274 (fontified t) 2274 2284 (face font-lock-builtin-face fontified t) 2284 2295 (fontified t) 2295 2303 (face font-lock-builtin-face fontified t) 2303 2336 (fontified t) 2336 2345 (face font-lock-builtin-face fontified t) 2345 2355 (fontified t) 2355 2364 (face font-lock-builtin-face fontified t) 2364 2398 (fontified t)) . 26526) (undo-tree-id2 . -2398) (undo-tree-id3 . -1214) (undo-tree-id4 . -1214) (t 26812 51560 0 0)) nil (26818 2164 808792 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28921 . 28922) (nil fontified nil 26526 . 28922) (26526 . 28922)) nil (26818 2164 808790 0) 0 nil])
([nil nil ((#("`(progn
       ;; Déclaration de la classe
       (defclass ,cls () ,slots)

       ;; Enregistrer les métadonnées
       (setf (gethash ',cls *entity-registry*)
             (list :table ,tbl
                   :primary-key ,(%kw pk)
                   :fields ',norm-fields
                   :defaults ',(or defaults defaults-alist)
                   :timestamps ,timestamps
                   :lock-version ',(when lock-version (%kw lock-version))))

       ;; After-method sur chaque (setf accessor) pour dirty-tracking
       ,@(mapcar
          (lambda (sa)
            (destructuring-bind (slot acc) sa
              `(defmethod (setf ,acc) :after (new (obj ,cls))
                 (declare (ignore new))
                 (mark-dirty obj ',slot))))
          accessor-specs)

       ',cls)))" 0 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 15 (fontified t) 15 18 (face font-lock-comment-delimiter-face fontified t) 18 43 (face font-lock-comment-face fontified t) 43 51 (fontified t) 51 59 (face font-lock-keyword-face fontified t) 59 84 (fontified t) 84 87 (face font-lock-comment-delimiter-face fontified t) 87 115 (face font-lock-comment-face fontified t) 115 181 (fontified t) 181 187 (face font-lock-builtin-face fontified t) 187 212 (fontified t) 212 224 (face font-lock-builtin-face fontified t) 224 254 (fontified t) 254 261 (face font-lock-builtin-face fontified t) 261 295 (fontified t) 295 304 (face font-lock-builtin-face fontified t) 304 355 (fontified t) 355 366 (face font-lock-builtin-face fontified t) 366 369 (fontified t) 369 379 (fontified t) 379 398 (fontified t) 398 411 (face font-lock-builtin-face fontified t) 411 415 (fontified t) 415 419 (face font-lock-keyword-face fontified t) 419 463 (fontified t) 463 466 (face font-lock-comment-delimiter-face fontified t) 466 526 (face font-lock-comment-face fontified t) 526 554 (fontified t) 554 560 (face font-lock-keyword-face fontified t) 560 579 (fontified t) 579 597 (face font-lock-keyword-face fontified t) 597 628 (fontified t) 628 637 (face font-lock-keyword-face fontified t) 637 650 (fontified t) 650 656 (face font-lock-builtin-face fontified t) 656 692 (fontified t) 692 699 (face font-lock-keyword-face fontified t) 699 714 (fontified t) 714 800 (fontified t)) . -31274) (undo-tree-id1 . -800) 32074) nil (26818 2164 808789 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 33965 . 33966) (nil fontified nil 31274 . 33966) (31274 . 33966)) nil (26818 2164 808787 0) 0 nil])
([nil nil ((33966 . 33967)) nil (26818 2164 808787 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -33966) (undo-tree-id0 . -1) 33967) nil (26818 2164 808785 0) 0 nil])
([nil nil ((29541 . 29542) (#("               " 0 15 (fontified t)) . 29541) (29403 . 29409) (#("                        " 0 24 (fontified t)) . 29403) (29358 . 29365) (#("                                " 0 32 (fontified t)) . 29358) (29303 . 29311) (#("     " 0 5 (fontified t)) . 29303) (29281 . 29289) (#("     " 0 5 (fontified t)) . 29281) (28805 . 28806) (#("                             " 0 29 (fontified t)) . 28805) (27991 . 27997) (#("          " 0 10 (fontified nil)) . 27991) (#("       " 0 7 (fontified t)) . -27973) (27933 . 27941) (#("                          " 0 26 (fontified nil)) . 27933) (#("     " 0 5 (fontified t)) . -27931) (#("     " 0 5 (fontified t)) . -27887) (#("     " 0 5 (fontified t)) . -27838) (#("     " 0 5 (fontified t)) . -27790) (#("     " 0 5 (fontified t)) . -27727) (#("  " 0 2 (fontified t)) . -27663) (27147 . 27148) (#("  " 0 2 (fontified t)) . 27147) (26617 . 26619) 26526) nil (26818 2164 808764 0) 0 nil])
([nil nil ((34735 . 34737) (t 26818 2164 0 0)) nil (26819 8031 696921 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37371 . 37372) (nil fontified nil 34737 . 37372) (34737 . 37372)) nil (26819 8031 696920 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 37372)) nil (26819 8031 696919 0) 0 nil])
([nil nil ((37372 . 37373)) nil (26819 8031 696918 0) 0 nil])
([nil nil ((37373 . 37375)) nil (26819 8031 696918 0) 0 nil])
([nil nil ((38379 . 38381)) nil (26819 8031 696917 0) 0 nil])
([nil nil ((38381 . 38382)) nil (26819 8031 696913 0) 0 nil])
([nil nil ((35692 . 35695) (t 26819 8031 0 0)) nil (26819 8273 698876 0) 0 nil])
([nil nil ((35695 . 35701)) nil (26819 8273 698876 0) 0 nil])
([nil nil ((35701 . 35702)) nil (26819 8273 698875 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 35712 . 35713) (nil fontified nil 35702 . 35713) (35702 . 35713)) nil (26819 8273 698875 0) 0 nil])
([nil nil ((35713 . 35714)) nil (26819 8273 698874 0) 0 nil])
([nil nil ((35714 . 35717)) nil (26819 8273 698873 0) 0 nil])
([nil nil ((35717 . 35723)) nil (26819 8273 698873 0) 0 nil])
([nil nil ((35723 . 35724)) nil (26819 8273 698872 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 35739 . 35740) (nil fontified nil 35724 . 35740) (35724 . 35740)) nil (26819 8273 698872 0) 0 nil])
([nil nil ((35740 . 35741)) nil (26819 8273 698871 0) 0 nil])
([nil nil ((35741 . 35744)) nil (26819 8273 698870 0) 0 nil])
([nil nil ((35744 . 35750)) nil (26819 8273 698870 0) 0 nil])
([nil nil ((35750 . 35751)) nil (26819 8273 698869 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 35766 . 35767) (nil fontified nil 35751 . 35767) (35751 . 35767)) nil (26819 8273 698868 0) 0 nil])
([nil nil ((35767 . 35768)) nil (26819 8273 698864 0) 0 nil])
([nil nil ((#("
	  (print col)
	  (print v)
	  (print present?)" 0 1 (face font-lock-comment-face fontified t) 1 48 (fontified t)) . 11484) (undo-tree-id1 . -48) (t 26819 8273 0 0)) nil (26822 36089 857215 0) 0 nil])
([nil nil ((18493 . 18495)) nil (26822 36089 857212 0) 0 nil])
([nil nil ((#("
  (print (null type))
  (print (sql-null-p val))
  (print (->sql-null val))" 0 9 (fontified t) 9 76 (fontified t)) . 35646) (undo-tree-id0 . -76)) nil (26822 36089 857209 0) 0 nil])
([nil nil ((#("
#|
(defun coerce-out (val type)
  \"Lisp -> SQL param (encode).\"
  (cond
    ((null type) val)
    ((array-type-p type)
     (let* ((elem (array-elem-type type))
            (elem-enc (getf (find-type-codec elem) :encode)))
       (cond
         ((null val) nil)
         ((vectorp val) (map 'vector elem-enc val))
         ((listp val)   (mapcar elem-enc val))
         (t val))))
    (t
     (let ((enc (getf (find-type-codec type) :encode)))
       (funcall enc val)))))

(defun coerce-in (val type)
  \"DB -> Lisp (decode).\"
  (cond
    ((null type) val)
    ((array-type-p type)
     (let* ((elem (array-elem-type type))
            (elem-dec (getf (find-type-codec elem) :decode)))
       (cond
         ((null val) nil)
         ;; cl-postgres retourne souvent des vecteurs pour les arrays
         ((vectorp val) (map 'vector elem-dec val))
         ((listp val)   (mapcar elem-dec val))
         (t val))))
    (t
     (let ((dec (getf (find-type-codec type) :decode)))
       (funcall dec val)))))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 849 (face font-lock-comment-face fontified t) 849 895 (face font-lock-comment-face fontified t) 895 1007 (face font-lock-comment-face fontified t) 1007 1009 (face font-lock-comment-delimiter-face fontified t) 1009 1010 (fontified t)) . 37326) (undo-tree-id0 . -1010) (undo-tree-id1 . -1010) (undo-tree-id2 . -1010) (t 26822 36089 0 0)) nil (26946 52942 362678 0) 0 nil])
([nil nil ((35324 . 35327) (t 26946 52942 0 0)) nil (26946 54708 986743 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 35346 . 35347) (nil fontified nil 35327 . 35347) (35327 . 35347)) nil (26946 54708 986742 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -35572) (undo-tree-id6 . -1) (undo-tree-id7 . -1) 35573) nil (26946 54708 986742 0) 0 nil])
([nil nil ((#("(defun coerce-out (val type)
  \"Lisp -> SQL param (encode). Force NIL vers le sentinelle NULL.\"
  (cond
    ;; 1) Type inconnu → juste convertir NIL en NULL
    ((null type)
     (if (sql-null-p val) (->sql-null val) val))

    ;; 2) TABLEAUX
    ((array-type-p type)
     (let* ((elem (array-elem-type type))
            (elem-enc (getf (find-type-codec elem) :encode)))
       (cond
         ;; NIL (pas d'array) => NULL SQL (et non false)
         ((sql-null-p val) (->sql-null val))
         ;; vecteur → map élémentaire
         ((vectorp val) (map 'vector (lambda (x) (if (sql-null-p x) (->sql-null x) (funcall elem-enc x))) val))
         ;; liste → map élémentaire
         ((listp val)   (mapcar (lambda (x) (if (sql-null-p x) (->sql-null x) (funcall elem-enc x))) val))
         ;; autre → passer tel quel
         (t val))))

    ;; 3) SCALAIRES
    (t
     (if (sql-null-p val)
         (->sql-null val)
         (let ((enc (getf (find-type-codec type) :encode)))
           (funcall enc val))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 17 (face font-lock-function-name-face fontified t) 17 31 (fontified t) 31 95 (face font-lock-doc-face fontified t) 95 99 (fontified t) 99 103 (face font-lock-keyword-face fontified t) 103 108 (fontified t) 108 111 (face font-lock-comment-delimiter-face fontified t) 111 157 (face font-lock-comment-face fontified t) 157 180 (fontified t) 180 182 (face font-lock-keyword-face fontified t) 182 228 (fontified t) 228 231 (face font-lock-comment-delimiter-face fontified t) 231 243 (face font-lock-comment-face fontified t) 243 274 (fontified t) 274 278 (face font-lock-keyword-face fontified t) 278 361 (fontified t) 361 368 (face font-lock-builtin-face fontified t) 368 380 (fontified t) 380 384 (face font-lock-keyword-face fontified t) 384 394 (fontified t) 394 397 (face font-lock-comment-delimiter-face fontified t) 397 442 (face font-lock-comment-face fontified t) 442 496 (fontified t) 496 499 (face font-lock-comment-delimiter-face fontified t) 499 525 (face font-lock-comment-face fontified t) 525 563 (fontified t) 563 569 (face font-lock-keyword-face fontified t) 569 575 (fontified t) 575 577 (face font-lock-keyword-face fontified t) 577 646 (fontified t) 646 649 (face font-lock-comment-delimiter-face fontified t) 649 673 (face font-lock-comment-face fontified t) 673 706 (fontified t) 706 712 (face font-lock-keyword-face fontified t) 712 718 (fontified t) 718 720 (face font-lock-keyword-face fontified t) 720 789 (fontified t) 789 792 (face font-lock-comment-delimiter-face fontified t) 792 816 (face font-lock-comment-face fontified t) 816 841 (fontified t) 841 844 (face font-lock-comment-delimiter-face fontified t) 844 857 (face font-lock-comment-face fontified t) 857 870 (fontified t) 870 872 (face font-lock-keyword-face fontified t) 872 926 (fontified t) 926 929 (face font-lock-keyword-face fontified t) 929 965 (fontified t) 965 972 (face font-lock-builtin-face fontified t) 972 1009 (fontified t)) . 35573) (undo-tree-id5 . -1009)) nil (26946 54708 986740 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 36650 . 36651) (nil fontified nil 35573 . 36651) (35573 . 36651)) nil (26946 54708 986739 0) 0 nil])
([nil nil ((#("(defun coerce-in (val type)
  \"DB -> Lisp (decode). Convertit NULL driver → NIL.\"
  (cond
    ;; 1) Type inconnu
    ((null type)
     (if (sql-null-p val) nil val))

    ;; 2) TABLEAUX
    ((array-type-p type)
     (let* ((elem (array-elem-type type))
            (elem-dec (getf (find-type-codec elem) :decode)))
       (cond
         ((sql-null-p val) nil) ; NULL SQL → NIL Lisp
         ((vectorp val) (map 'vector (lambda (x) (if (sql-null-p x) nil (funcall elem-dec x))) val))
         ((listp val)   (mapcar     (lambda (x) (if (sql-null-p x) nil (funcall elem-dec x))) val))
         (t val))))

    ;; 3) SCALAIRES
    (t
     (if (sql-null-p val)
         nil
         (let ((dec (getf (find-type-codec type) :decode)))
           (funcall dec val))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 16 (face font-lock-function-name-face fontified t) 16 30 (fontified t) 30 81 (face font-lock-doc-face fontified t) 81 85 (fontified t) 85 89 (face font-lock-keyword-face fontified t) 89 94 (fontified t) 94 97 (face font-lock-comment-delimiter-face fontified t) 97 102 (face font-lock-comment-face fontified t) 102 113 (face font-lock-comment-face fontified t) 113 136 (fontified t) 136 138 (face font-lock-keyword-face fontified t) 138 171 (fontified t) 171 174 (face font-lock-comment-delimiter-face fontified t) 174 186 (face font-lock-comment-face fontified t) 186 217 (fontified t) 217 221 (face font-lock-keyword-face fontified t) 221 263 (fontified t) 263 304 (fontified t) 304 311 (face font-lock-builtin-face fontified t) 311 315 (fontified t) 315 323 (fontified t) 323 327 (face font-lock-keyword-face fontified t) 327 360 (fontified t) 360 382 (face font-lock-comment-face fontified t) 382 417 (fontified t) 417 420 (fontified t) 420 426 (face font-lock-keyword-face fontified t) 426 432 (fontified t) 432 434 (face font-lock-keyword-face fontified t) 434 483 (fontified t) 483 489 (fontified t) 489 520 (fontified t) 520 526 (face font-lock-keyword-face fontified t) 526 532 (fontified t) 532 534 (face font-lock-keyword-face fontified t) 534 583 (fontified t) 583 608 (fontified t) 608 611 (face font-lock-comment-delimiter-face fontified t) 611 624 (face font-lock-comment-face fontified t) 624 637 (fontified t) 637 639 (face font-lock-keyword-face fontified t) 639 680 (fontified t) 680 683 (face font-lock-keyword-face fontified t) 683 719 (fontified t) 719 726 (face font-lock-builtin-face fontified t) 726 763 (fontified t)) . 36653) (undo-tree-id4 . -763)) nil (26946 54708 986738 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37580 . 37581) (nil fontified nil 36653 . 37581) (36653 . 37581)) nil (26946 54708 986736 0) 0 nil])
([nil nil ((37582 . 37583)) nil (26946 54708 986736 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37773 . 37774) (nil fontified nil 37583 . 37774) (37583 . 37774)) nil (26946 54708 986735 0) 0 nil])
([nil nil ((37774 . 37775)) nil (26946 54708 986734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37926 . 37927) (nil fontified nil 37775 . 37927) (37775 . 37927)) nil (26946 54708 986734 0) 0 nil])
([nil nil ((37927 . 37928)) nil (26946 54708 986733 0) 0 nil])
([nil nil ((#("
;;; Enregistrements par défaut (ne nécessitent aucune lib externe)" 0 1 (fontified t) 1 5 (face font-lock-comment-delimiter-face fontified t) 5 67 (face font-lock-comment-face fontified t)) . 37928) (undo-tree-id3 . -67)) nil (26946 54708 986732 0) 0 nil])
([nil nil ((37932 . 37934)) nil (26946 54708 986723 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-comment-face fontified t)) . 37934)) nil (26946 54708 986723 0) 0 nil])
([nil nil ((37934 . 37935)) nil (26946 54708 986722 0) 0 nil])
([nil nil ((37935 . 37939) (#("uuid" 0 4 (face font-lock-comment-face fontified t)) . 37935)) nil (26946 54708 986721 0) 0 nil])
([nil nil ((38039 . 38041)) nil (26946 54708 986720 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38557 . 38558) (nil fontified nil 38041 . 38558) (38041 . 38558)) nil (26946 54708 986716 0) 0 nil])
([nil nil ((28755 . 28756) (t 26946 54708 0 0)) nil (26949 25024 700496 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28777 . 28778) (nil fontified nil 28756 . 28778) (28756 . 28778)) nil (26949 25024 700492 0) 0 nil])
([nil nil ((nil fontified nil 27897 . 27898) (nil fontified nil 27888 . 27897) (27888 . 27898) (t 26949 25024 0 0)) nil (26949 25329 514011 0) 0 nil])
([nil nil ((#("     ;; <— AJOUTÉ" 0 5 (fontified t) 5 8 (face font-lock-comment-delimiter-face fontified t) 8 17 (face font-lock-comment-face fontified t)) . -27900) (undo-tree-id8 . -17) 27917) nil (26949 25329 514010 0) 0 nil])
([nil nil ((#("		" 0 2 (fontified t)) . 27898)) nil (26949 25329 513996 0) 0 nil])
([nil nil ((#("	     ;; <— AJOUTÉ (robustesse)" 0 6 (fontified t) 6 9 (face font-lock-comment-delimiter-face fontified t) 9 31 (face font-lock-comment-face fontified t)) . 27936)) nil (26949 25329 513991 0) 0 nil])
([nil nil ((#(";; <— AJOUTÉ" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 12 (face font-lock-comment-face fontified t)) . -28743) (undo-tree-id21 . -12) (undo-tree-id22 . -12) (undo-tree-id23 . -12) 28755 (t 26949 25329 0 0)) nil (26949 25381 948718 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -28742) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) 28743) nil (26949 25381 948713 0) 0 nil])
([nil nil ((27898 . 27899) (t 26949 25381 0 0)) nil (26950 32041 317048 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27905 . 27906) (nil fontified nil 27899 . 27906) (27899 . 27906)) nil (26950 32041 317047 0) 0 nil])
([nil nil ((28746 . 28747)) nil (26950 32041 317046 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28762 . 28763) (nil fontified nil 28747 . 28763) (28747 . 28763)) nil (26950 32041 317042 0) 0 nil])
([nil nil ((27906 . 27907) (t 26950 32041 0 0)) nil (26950 37362 24908 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 27916 . 27917) (nil fontified nil 27907 . 27917) (27907 . 27917)) nil (26950 37362 24907 0) 0 nil])
([nil nil ((28774 . 28775)) nil (26950 37362 24906 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 28796 . 28797) (nil fontified nil 28775 . 28797) (28775 . 28797)) nil (26950 37362 24905 0) 0 nil])
([nil nil ((#("
                        " 0 1 (fontified t) 1 25 (fontified t)) . -28703) (undo-tree-id26 . -25) 28728) nil (26950 37362 24904 0) 0 nil])
([nil nil ((28703 . 28704)) nil (26950 37362 24901 0) 0 nil])
([nil nil ((28711 . 28714) (#(" " 0 1 (fontified nil)) . 28710) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (28711 . 28712)) nil (26950 37362 24897 0) 0 nil])
([nil nil ((23636 . 23642) (t 26950 37362 0 0)) nil (26975 58204 267765 0) 0 nil])
([nil nil ((23642 . 23648)) nil (26975 58204 267764 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -23642) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (#("p" 0 1 (fontified t)) . -23643) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (#("r" 0 1 (fontified t)) . -23644) (undo-tree-id43 . -1) (#("i" 0 1 (fontified t)) . -23645) (undo-tree-id44 . -1) (#("n" 0 1 (fontified t)) . -23646) (undo-tree-id45 . -1) (#("t" 0 1 (fontified t)) . -23647) (undo-tree-id46 . -1) 23648) nil (26975 58204 267763 0) 0 nil])
([nil nil ((nil fontified nil 23696 . 23697) (nil fontified nil 23652 . 23696) (nil fontified nil 23642 . 23652) (23642 . 23697)) nil (26975 58204 267754 0) 0 nil])
([nil nil ((#("REPO-PERSIT:PATCH:" 0 18 (face font-lock-string-face fontified t)) . -23655) (undo-tree-id30 . -18) (undo-tree-id31 . -18) (undo-tree-id32 . -18) 23673) nil (26975 58204 267752 0) 0 nil])
([nil nil ((#("VALIDATION" 0 10 (face font-lock-string-face fontified t)) . -23662) (undo-tree-id20 . -10) (undo-tree-id21 . -7) (undo-tree-id22 . -7) (undo-tree-id23 . -7) (undo-tree-id24 . -7) (undo-tree-id25 . -7) (undo-tree-id26 . -10) (undo-tree-id27 . -10) (undo-tree-id28 . -10) (undo-tree-id29 . -10) 23672) nil (26975 58204 267750 0) 0 nil])
([nil nil ((23662 . 23669)) nil (26975 58204 267742 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -23661) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) 23662) nil (26975 58204 267741 0) 0 nil])
([nil nil ((23661 . 23662)) nil (26975 58204 267729 0) 0 nil])
([nil nil ((23668 . 23669)) nil (26975 58204 267729 0) 0 nil])
([nil nil ((23671 . 23673)) nil (26975 58204 267728 0) 0 nil])
([nil nil ((#("F" 0 1 (face font-lock-string-face fontified t)) . -23672) (undo-tree-id4 . -1) 23673) nil (26975 58204 267728 0) 0 nil])
([nil nil ((23672 . 23677)) nil (26975 58204 267726 0) 0 nil])
([nil nil ((23677 . 23678)) nil (26975 58204 267726 0) 0 nil])
([nil nil ((#("I" 0 1 (face font-lock-string-face fontified t)) . -23674) (undo-tree-id0 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -23675) (undo-tree-id1 . -1) (#("E" 0 1 (face font-lock-string-face fontified t)) . -23676) (undo-tree-id2 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -23677) (undo-tree-id3 . -1) 23678) nil (26975 58204 267724 0) 0 nil])
([nil nil ((23674 . 23677)) nil (26975 58204 267707 0) 0 nil])
([nil nil ((23677 . 23678)) nil (26975 58204 267706 0) 0 nil])
([nil nil ((23678 . 23684)) nil (26975 58204 267705 0) 0 nil])
([nil nil ((23684 . 23685)) nil (26975 58204 267701 0) 0 nil])
([nil nil ((23039 . 23044) (#(" " 0 1 (fontified nil)) . 23038) (undo-tree-id47 . -1) (23039 . 23040) (t 26975 58204 0 0)) nil (26975 59626 278615 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 23049)) nil (26975 59626 278605 0) 0 nil])
([nil nil ((#("             " 0 13 (fontified nil)) . -23071) (23049 . 23050)) nil (26975 59626 278605 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 23104)) nil (26975 59626 278604 0) 0 nil])
([nil nil ((#("             " 0 13 (fontified nil)) . -23126) (23104 . 23105)) nil (26975 59626 278604 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 23179)) nil (26975 59626 278603 0) 0 nil])
([nil nil ((#("             " 0 13 (fontified nil)) . -23202) (23179 . 23180)) nil (26975 59626 278603 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#("
" 0 1 (fontified t)) . 23237)) nil (26975 59626 278602 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237)) nil (26975 59626 278600 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237) (#(" " 0 1 (fontified t)) . 23237)) nil (26975 59626 278596 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 23267)) nil (26975 59626 278594 0) 0 nil])
([nil nil ((#("             " 0 13 (fontified nil)) . -23289) (23267 . 23268)) nil (26975 59626 278594 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 23310)) nil (26975 59626 278593 0) 0 nil])
([nil nil ((#("             " 0 13 (fontified nil)) . -23332) (23310 . 23311)) nil (26975 59626 278588 0) 0 nil])
([nil nil ((23071 . 23073)) nil (26975 59626 278587 0) 0 nil])
([nil nil ((23312 . 23320)) nil (26975 59626 278586 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23330 . 23331) (nil fontified nil 23320 . 23331) (23320 . 23331)) nil (26975 59626 278585 0) 0 nil])
([nil nil ((23358 . 23367) (#("returning" 0 9 (face font-lock-string-face fontified t)) . 23358)) nil (26975 59626 278583 0) 0 nil])
([nil nil ((23269 . 23277)) nil (26975 59626 278581 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23291 . 23292) (nil fontified nil 23277 . 23292) (23277 . 23292)) nil (26975 59626 278580 0) 0 nil])
([nil nil ((23106 . 23114)) nil (26975 59626 278580 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23376 . 23377) (nil fontified nil 23114 . 23377) (23114 . 23377)) nil (26975 59626 278579 0) 0 nil])
([nil nil ((23377 . 23382)) nil (26975 59626 278578 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23431 . 23432) (nil fontified nil 23382 . 23432) (23382 . 23432)) nil (26975 59626 278577 0) 0 nil])
([nil nil ((23376 . 23379) (23306 . 23309) (23239 . 23242) (23198 . 23201) (#("      " 0 6 (fontified t)) . -19934) (19435 . 19436) (#("          " 0 10 (fontified t)) . 19435) 19099) nil (26975 59626 278572 0) 0 nil])
([nil nil ((22914 . 22918) (t 26975 59626 0 0)) nil (26975 59926 841801 0) 0 nil])
([nil nil ((22918 . 22923)) nil (26975 59926 841801 0) 0 nil])
([nil nil ((#("a" 0 1 (fontified t)) . -22922) (undo-tree-id53 . -1) 22923) nil (26975 59926 841800 0) 0 nil])
([nil nil ((22922 . 22925)) nil (26975 59926 841799 0) 0 nil])
([nil nil ((22925 . 22926)) nil (26975 59926 841798 0) 0 nil])
([nil nil ((22926 . 22927)) nil (26975 59926 841798 0) 0 nil])
([nil nil ((22927 . 22928)) nil (26975 59926 841798 0) 0 nil])
([nil nil ((22928 . 22929)) nil (26975 59926 841797 0) 0 nil])
([nil nil ((#("é" 0 1 (fontified t)) . -22928) (undo-tree-id52 . -1) 22929) nil (26975 59926 841796 0) 0 nil])
([nil nil ((22928 . 22931)) nil (26975 59926 841795 0) 0 nil])
([nil nil ((22931 . 22952)) nil (26975 59926 841795 0) 0 nil])
([nil nil ((22952 . 22954)) nil (26975 59926 841794 0) 0 nil])
([nil nil ((22954 . 22955)) nil (26975 59926 841794 0) 0 nil])
([nil nil ((22955 . 22957)) nil (26975 59926 841793 0) 0 nil])
([nil nil ((22957 . 22958)) nil (26975 59926 841793 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -22957) (undo-tree-id51 . -1) 22958) nil (26975 59926 841792 0) 0 nil])
([nil nil ((22957 . 22961)) nil (26975 59926 841791 0) 0 nil])
([nil nil ((#("%" 0 1 (face font-lock-string-face fontified t)) . -22959) (undo-tree-id49 . -1) (#("%" 0 1 (face font-lock-string-face fontified t)) . -22960) (undo-tree-id50 . -1) 22961) nil (26975 59926 841790 0) 0 nil])
([nil nil ((22959 . 22960)) nil (26975 59926 841787 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -22959) (undo-tree-id48 . -1) 22960) nil (26975 59926 841786 0) 0 nil])
([nil nil ((22959 . 22960)) nil (26975 59926 841777 0) 0 nil])
([nil nil ((22960 . 22961)) nil (26975 59926 841776 0) 0 nil])
([nil nil ((22961 . 22968)) nil (26975 59926 841775 0) 0 nil])
([nil nil ((22968 . 22969)) nil (26975 59926 841771 0) 0 nil])
([nil nil ((18950 . 18953) (t 26975 59926 0 0)) nil (26978 33761 969090 0) 0 nil])
([nil nil ((18953 . 18959)) nil (26978 33761 969089 0) 0 nil])
([nil nil ((18959 . 18960)) nil (26978 33761 969088 0) 0 nil])
([nil nil ((18960 . 18964)) nil (26978 33761 969087 0) 0 nil])
([nil nil ((18964 . 18967)) nil (26978 33761 969086 0) 0 nil])
([nil nil ((18967 . 18968)) nil (26978 33761 969086 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -18967) (undo-tree-id3 . -1) 18968) nil (26978 33761 969085 0) 0 nil])
([nil nil ((18967 . 18973)) nil (26978 33761 969083 0) 0 nil])
([nil nil ((18973 . 18974)) nil (26978 33761 969082 0) 0 nil])
([nil nil ((18974 . 18978)) nil (26978 33761 969081 0) 0 nil])
([nil nil ((18950 . 18953)) nil (26978 33761 969080 0) 0 nil])
([nil nil ((18953 . 18959)) nil (26978 33761 969080 0) 0 nil])
([nil nil ((18959 . 18960)) nil (26978 33761 969079 0) 0 nil])
([nil nil ((18960 . 18963)) nil (26978 33761 969078 0) 0 nil])
([nil nil ((#("P" 0 1 (face font-lock-string-face fontified t)) . -18961) (undo-tree-id1 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -18962) (undo-tree-id2 . -1) 18963) nil (26978 33761 969077 0) 0 nil])
([nil nil ((18961 . 18967)) nil (26978 33761 969071 0) 0 nil])
([nil nil ((18981 . 18984)) nil (26978 33761 969070 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18997 . 18998) (nil fontified nil 18997 . 18998) (nil fontified nil 18991 . 18997) (nil fontified nil 18984 . 18991) (18984 . 18998)) nil (26978 33761 969069 0) 0 nil])
([nil nil ((#("ROW" 0 3 (face font-lock-string-face fontified t)) . -18992) (undo-tree-id0 . -3) 18995) nil (26978 33761 969065 0) 0 nil])
([nil nil ((18992 . 18995)) nil (26978 33761 969042 0) 0 nil])
([nil nil ((18882 . 18890) (t 26978 33761 0 0)) nil (26978 33921 768104 0) 0 nil])
([nil nil ((18890 . 18892)) nil (26978 33921 768104 0) 0 nil])
([nil nil ((18892 . 18893)) nil (26978 33921 768103 0) 0 nil])
([nil nil ((18893 . 18899)) nil (26978 33921 768102 0) 0 nil])
([nil nil ((18899 . 18900)) nil (26978 33921 768102 0) 0 nil])
([nil nil ((18900 . 18901)) nil (26978 33921 768101 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -18900) (undo-tree-id4 . -1) 18901) nil (26978 33921 768099 0) 0 nil])
([nil nil ((18900 . 18905)) nil (26978 33921 768077 0) 0 nil])
([nil nil ((18696 . 18704)) nil (26978 33921 768076 0) 0 nil])
([nil nil ((18704 . 18710)) nil (26978 33921 768075 0) 0 nil])
([nil nil ((18710 . 18711)) nil (26978 33921 768073 0) 0 nil])
([nil nil ((18711 . 18721)) nil (26978 33921 768067 0) 0 nil])
([nil nil ((18752 . 18758) (t 26978 33921 0 0)) nil (26978 34230 949082 0) 0 nil])
([nil nil ((18758 . 18759)) nil (26978 34230 949081 0) 0 nil])
([nil nil ((18762 . 18763)) nil (26978 34230 949077 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 24568 . 24569) (nil fontified nil 24562 . 24569) (24562 . 24569) (t 26978 34230 0 0)) nil (26978 35416 941613 0) 0 nil])
([nil nil ((24572 . 24573)) nil (26978 35416 941609 0) 0 nil])
([nil nil ((#("
	      (print \"OKBBBBB\")" 0 1 (face font-lock-comment-face fontified t) 1 15 (fontified t) 15 24 (face font-lock-string-face fontified t) 24 25 (fontified t)) . 18696) (undo-tree-id16 . -25) (t 26978 35416 0 0)) nil (26984 57201 297672 0) 0 nil])
([nil nil ((#("
		     (x (print row))" 0 23 (fontified t)) . 18890) (undo-tree-id15 . -23)) nil (26984 57201 297671 0) 0 nil])
([nil nil ((#("
		(print \"ROW:\")
		(print row)
		(print \"NEW:\")
		(print new)" 0 10 (fontified t) 10 16 (face font-lock-string-face fontified t) 16 41 (fontified t) 41 47 (face font-lock-string-face fontified t) 47 62 (fontified t)) . 18958) (undo-tree-id14 . -62)) nil (26984 57201 297670 0) 0 nil])
([nil nil ((15494 . 15496)) nil (26984 57201 297669 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15771 . 15772) (nil fontified nil 15496 . 15772) (15496 . 15772)) nil (26984 57201 297669 0) 0 nil])
([nil nil ((16902 . 16908)) nil (26984 57201 297668 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17001 . 17002) (nil fontified nil 16908 . 17002) (16908 . 17002)) nil (26984 57201 297668 0) 0 nil])
([nil nil ((#("MODIF: " 0 7 (face font-lock-comment-face fontified t)) . -16911) (undo-tree-id13 . -7) 16918) nil (26984 57201 297667 0) 0 nil])
([nil nil ((16995 . 16996)) nil (26984 57201 297666 0) 0 nil])
([nil nil ((16996 . 17004)) nil (26984 57201 297666 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17222 . 17223) (nil fontified nil 17004 . 17223) (17004 . 17223)) nil (26984 57201 297665 0) 0 nil])
([nil nil ((#("
                   (slot (getf f :slot))" 0 1 (face font-lock-comment-face fontified t) 1 34 (fontified t) 34 39 (face font-lock-builtin-face fontified t) 39 41 (fontified t)) . -16768) (undo-tree-id12 . -41) 16809) nil (26984 57201 297665 0) 0 nil])
([nil nil ((#("
                   (val  (%slot-value entity slot))" 0 1 (fontified t) 1 52 (fontified t)) . -16809) (undo-tree-id11 . -52) 16861) nil (26984 57201 297664 0) 0 nil])
([nil nil ((#("
                   (force? (%force-insert-col-p col created-col updated-col val)))" 0 1 (face font-lock-comment-face fontified t) 1 83 (fontified t)) . 17225) (undo-tree-id10 . -83)) nil (26984 57201 297662 0) 0 nil])
([nil nil ((#(";; ne PAS insérer : PK/lock-version/etc. si VAL = NIL (laisser DEFAULT SQL)" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 75 (face font-lock-comment-face fontified t)) . 17150) (undo-tree-id9 . -75) 17225) nil (26984 57201 297661 0) 0 nil])
([nil nil ((17043 . 17053)) nil (26984 57201 297660 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17127 . 17128) (nil fontified nil 17056 . 17128) (nil fontified nil 17053 . 17056) (17053 . 17128)) nil (26984 57201 297660 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 17215)) nil (26984 57201 297659 0) 0 nil])
([nil nil ((#("                   " 0 19 (fontified t)) . 17215) (undo-tree-id8 . -19)) nil (26984 57201 297659 0) 0 nil])
([nil nil ((19518 . 19519)) nil (26984 57201 297658 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -19518) (undo-tree-id7 . -1) 19519) nil (26984 57201 297657 0) 0 nil])
([nil nil ((19518 . 19520)) nil (26984 57201 297656 0) 0 nil])
([nil nil ((22141 . 22147)) nil (26984 57201 297656 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22240 . 22241) (nil fontified nil 22147 . 22241) (22147 . 22241)) nil (26984 57201 297655 0) 0 nil])
([nil nil ((22242 . 22250)) nil (26984 57201 297654 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22267 . 22268) (nil fontified nil 22250 . 22268) (22250 . 22268)) nil (26984 57201 297653 0) 0 nil])
([nil nil ((22250 . 22252)) nil (26984 57201 297652 0) 0 nil])
([nil nil ((17714 . 17716)) nil (26984 57201 297652 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -19520) (undo-tree-id5 . -1) (#(")" 0 1 (fontified t)) . -19521) (undo-tree-id6 . -1) 19522) nil (26984 57201 297651 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -22250) (undo-tree-id3 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -22251) (undo-tree-id4 . -1) 22252) nil (26984 57201 297648 0) 0 nil])
([nil nil ((23174 . 23175)) nil (26984 57201 297646 0) 0 nil])
([nil nil ((23162 . 23171) (#(" " 0 1 (fontified nil)) . 23161) (undo-tree-id2 . -1) (23162 . 23163)) nil (26984 57201 297645 0) 0 nil])
([nil nil ((22976 . 22982) (#(" " 0 1 (fontified nil)) . 22975) (undo-tree-id1 . -1) (22976 . 22977)) nil (26984 57201 297641 0) 0 nil])
([nil nil ((25357 . 25358)) nil (26984 57201 297639 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -25357) (undo-tree-id0 . -1) 25358) nil (26984 57201 297635 0) 0 nil])
([nil nil ((19305 . 19313) (t 26984 57201 0 0)) nil (26990 32041 337553 0) 0 nil])
([nil nil ((19313 . 19315)) nil (26990 32041 337552 0) 0 nil])
([nil nil ((19315 . 19316)) nil (26990 32041 337552 0) 0 nil])
([nil nil ((19316 . 19322)) nil (26990 32041 337551 0) 0 nil])
([nil nil ((19322 . 19323)) nil (26990 32041 337551 0) 0 nil])
([nil nil ((19323 . 19339)) nil (26990 32041 337550 0) 0 nil])
([nil nil ((19339 . 19347)) nil (26990 32041 337550 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 19339)) nil (26990 32041 337549 0) 0 nil])
([nil nil ((19339 . 19340)) nil (26990 32041 337549 0) 0 nil])
([nil nil ((19347 . 19349)) nil (26990 32041 337549 0) 0 nil])
([nil nil ((19349 . 19350)) nil (26990 32041 337548 0) 0 nil])
([nil nil ((19350 . 19356)) nil (26990 32041 337548 0) 0 nil])
([nil nil ((19356 . 19357)) nil (26990 32041 337547 0) 0 nil])
([nil nil ((19357 . 19362)) nil (26990 32041 337547 0) 0 nil])
([nil nil ((19430 . 19433)) nil (26990 32041 337546 0) 0 nil])
([nil nil ((19433 . 19439)) nil (26990 32041 337546 0) 0 nil])
([nil nil ((19439 . 19440)) nil (26990 32041 337545 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19453 . 19454) (nil fontified nil 19440 . 19454) (19440 . 19454)) nil (26990 32041 337544 0) 0 nil])
([nil nil ((19454 . 19455)) nil (26990 32041 337540 0) 0 nil])
([nil nil ((37926 . 37932) (t 26990 32041 0 0)) nil (26990 32449 679808 0) 0 nil])
([nil nil ((37932 . 37938)) nil (26990 32449 679807 0) 0 nil])
([nil nil ((37938 . 37939)) nil (26990 32449 679807 0) 0 nil])
([nil nil ((37939 . 37940)) nil (26990 32449 679807 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -37939) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) 37940) nil (26990 32449 679806 0) 0 nil])
([nil nil ((37939 . 37945)) nil (26990 32449 679802 0) 0 nil])
([nil nil ((37945 . 37946)) nil (26990 32449 679802 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37957 . 37958) (nil fontified nil 37946 . 37958) (37946 . 37958)) nil (26990 32449 679801 0) 0 nil])
([nil nil ((37958 . 37960)) nil (26990 32449 679801 0) 0 nil])
([nil nil ((38519 . 38525)) nil (26990 32449 679800 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38552 . 38553) (nil fontified nil 38552 . 38553) (nil fontified nil 38551 . 38552) (nil fontified nil 38550 . 38551) (nil fontified nil 38539 . 38550) (nil fontified nil 38532 . 38539) (nil fontified nil 38525 . 38532) (38525 . 38553)) nil (26990 32449 679800 0) 0 nil])
([nil nil ((#("array-type-p" 0 11 (face font-lock-string-face fontified t) 11 12 (face font-lock-string-face fontified t rear-nonsticky t)) . -38539) (undo-tree-id10 . -12) (undo-tree-id11 . -12) (undo-tree-id12 . -12) 38551) nil (26990 32449 679798 0) 0 nil])
([nil nil ((38539 . 38545)) nil (26990 32449 679796 0) 0 nil])
([nil nil ((37819 . 37825)) nil (26990 32449 679795 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37852 . 37853) (nil fontified nil 37852 . 37853) (nil fontified nil 37851 . 37852) (nil fontified nil 37850 . 37851) (nil fontified nil 37839 . 37850) (nil fontified nil 37832 . 37839) (nil fontified nil 37825 . 37832) (37825 . 37853)) nil (26990 32449 679794 0) 0 nil])
([nil nil ((#("array-type-p" 0 11 (face font-lock-string-face fontified t) 11 12 (face font-lock-string-face fontified t rear-nonsticky t)) . -37839) (undo-tree-id0 . -12) (undo-tree-id1 . -5) (undo-tree-id2 . -5) (undo-tree-id3 . -5) (undo-tree-id4 . -5) (undo-tree-id5 . -5) (undo-tree-id6 . -12) (undo-tree-id7 . -12) (undo-tree-id8 . -12) (undo-tree-id9 . -12) 37851) nil (26990 32449 679792 0) 0 nil])
([nil nil ((37839 . 37843)) nil (26990 32449 679765 0) 0 nil])
([nil nil ((#("
         ;;(pk     (or (getf md :primary-key) :id))
         ;;(lv-col (getf md :lock-version))" 0 10 (fontified t) 10 12 (face font-lock-comment-delimiter-face fontified t) 12 53 (face font-lock-comment-face fontified t) 53 62 (fontified t) 62 64 (face font-lock-comment-delimiter-face fontified t) 64 96 (face font-lock-comment-face fontified t)) . 16196) (undo-tree-id22 . -96) (t 26990 32449 0 0)) nil (26990 35619 481122 0) 0 nil])
([nil nil ((38576 . 38581)) nil (26990 35619 481121 0) 0 nil])
([nil nil ((38581 . 38587)) nil (26990 35619 481120 0) 0 nil])
([nil nil ((38587 . 38588)) nil (26990 35619 481120 0) 0 nil])
([nil nil ((38588 . 38591)) nil (26990 35619 481119 0) 0 nil])
([nil nil ((38576 . 38581)) nil (26990 35619 481119 0) 0 nil])
([nil nil ((38581 . 38587)) nil (26990 35619 481118 0) 0 nil])
([nil nil ((38587 . 38588)) nil (26990 35619 481118 0) 0 nil])
([nil nil ((38588 . 38593)) nil (26990 35619 481118 0) 0 nil])
([nil nil ((38608 . 38609)) nil (26990 35619 481117 0) 0 nil])
([nil nil ((38609 . 38614)) nil (26990 35619 481113 0) 0 nil])
([nil nil ((38614 . 38620)) nil (26990 35619 481113 0) 0 nil])
([nil nil ((38620 . 38621)) nil (26990 35619 481112 0) 0 nil])
([nil nil ((38621 . 38626)) nil (26990 35619 481111 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -38625) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 38626) nil (26990 35619 481107 0) 0 nil])
([nil nil ((13669 . 13671) (t 26990 35619 0 0)) nil (26990 40069 721420 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14781 . 14782) (nil fontified nil 13671 . 14782) (13671 . 14782)) nil (26990 40069 721419 0) 0 nil])
([nil nil ((#("CORRECTION : On prend la valeur brute du slot (déjà Lisp), sans rappeler coerce-in" 0 82 (face font-lock-doc-face fontified t)) . -13817) (undo-tree-id24 . -82) 13899) nil (26990 40069 721418 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13896 . 13897) (nil fontified nil 13817 . 13897) (13817 . 13897)) nil (26990 40069 721415 0) 0 nil])
([nil nil ((#("." 0 1 (face font-lock-doc-face rear-nonsticky t fontified t)) . -13896) (undo-tree-id23 . -1) 13897) nil (26990 40069 721413 0) 0 nil])
([nil nil ((12901 . 12902)) nil (26990 40069 721400 0) 0 nil])
([nil nil ((12902 . 12904)) nil (26990 40069 721399 0) 0 nil])
([nil nil ((13673 . 13675)) nil (26990 40069 721398 0) 0 nil])
([nil nil ((13675 . 13676)) nil (26990 40069 721479 0) 0 nil])
([nil nil ((37687 . 37688)) nil (26990 40280 810996 0) 0 nil] [nil nil ((37687 . 37688)) ((#(" " 0 1 (face font-lock-doc-face fontified t)) . 37687)) (26990 40069 721391 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37707 . 37708) (nil fontified nil 37688 . 37708) (37688 . 37708)) nil (26990 40280 810995 0) 0 nil])
nil
([nil nil ((#(" " 0 1 (face font-lock-doc-face fontified t)) . -37687) (undo-tree-id36 . -1) (undo-tree-id37 . -1) 37688) nil (26990 40280 810994 0) 0 nil])
([nil nil ((#("(" 0 1 (face font-lock-doc-face fontified t)) . -37687) (undo-tree-id35 . -1) 37688) nil (26990 40280 810991 0) 0 nil])
([nil nil ((37687 . 37688)) nil (26990 40280 810989 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-doc-face rear-nonsticky t fontified t)) . 37706)) nil (26990 40280 810988 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-doc-face fontified t)) . -37687) (undo-tree-id34 . -1) 37688) nil (26990 40280 810987 0) 0 nil])
([nil nil ((37687 . 37688)) nil (26990 40280 810985 0) 0 nil])
([nil nil ((37688 . 37689)) nil (26990 40280 810984 0) 0 nil])
([nil nil ((37744 . 37745)) nil (26990 40280 810984 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37828 . 37829) (nil fontified nil 37745 . 37829) (37745 . 37829)) nil (26990 40280 810983 0) 0 nil])
([nil nil ((37829 . 37830)) nil (26990 40280 810982 0) 0 nil])
([nil nil ((37830 . 37831)) nil (26990 40280 810982 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 37854 . 37855) (nil fontified nil 37831 . 37855) (37831 . 37855)) nil (26990 40280 810981 0) 0 nil])
([nil nil ((38890 . 38891)) nil (26990 40280 810980 0) 0 nil])
([nil nil ((38891 . 38892)) nil (26990 40280 810980 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 38907 . 38908) (nil fontified nil 38892 . 38908) (38892 . 38908)) nil (26990 40280 810979 0) 0 nil])
([nil nil ((38939 . 38940)) nil (26990 40280 810978 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 39007 . 39008) (nil fontified nil 38940 . 39008) (38940 . 39008)) nil (26990 40280 810977 0) 0 nil])
([nil nil ((39008 . 39009)) nil (26990 40280 810977 0) 0 nil])
([nil nil ((39009 . 39010)) nil (26990 40280 810976 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 39033 . 39034) (nil fontified nil 39010 . 39034) (39010 . 39034)) nil (26990 40280 810975 0) 0 nil])
([nil nil ((39034 . 39035)) nil (26990 40280 810974 0) 0 nil])
([nil nil ((13903 . 13904)) nil (26990 40280 810973 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14024 . 14025) (nil fontified nil 13904 . 14025) (13904 . 14025)) nil (26990 40280 810972 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-doc-face fontified t)) . -13926) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (#(";" 0 1 (face font-lock-doc-face fontified t)) . -13927) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (#(" " 0 1 (face font-lock-doc-face fontified t)) . -13928) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) 13929) nil (26990 40280 810967 0) 0 nil])
([nil nil ((38958 . 38960) (t 26990 40280 0 0)) nil (26991 13718 265535 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 40315 . 40316) (nil fontified nil 38960 . 40316) (38960 . 40316)) nil (26991 13718 265534 0) 0 nil])
([nil nil ((#("\"Lisp -> SQL param (encode). Force NIL vers le sentinelle NULL, sauf pour les tableaux vides.\"" 0 94 (face font-lock-doc-face fontified t)) . -38991) (undo-tree-id46 . -94) 39085) nil (26991 13718 265533 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 39185 . 39186) (nil fontified nil 39185 . 39186) (nil fontified nil 39184 . 39185) (nil fontified nil 39161 . 39184) (nil fontified nil 39159 . 39161) (nil fontified nil 39158 . 39159) (nil fontified nil 39075 . 39158) (nil fontified nil 39063 . 39075) (nil fontified nil 39037 . 39063) (nil fontified nil 39019 . 39037) (nil fontified nil 38991 . 39019) (38991 . 39186)) nil (26991 13718 265531 0) 0 nil])
([nil nil ((37748 . 37749)) nil (26991 13718 265530 0) 0 nil])
([nil nil ((37749 . 37751)) nil (26991 13718 265529 0) 0 nil])
([nil nil ((38962 . 38964)) nil (26991 13718 265529 0) 0 nil])
([nil nil ((38964 . 38965)) nil (26991 13718 265528 0) 0 nil])
([nil nil ((#("
	   (print type)
	   (print dec)
	   (print val)" 0 1 (fontified t) 1 18 (fontified t) 18 34 (fontified t) 34 49 (fontified t)) . 41521) (undo-tree-id45 . -49)) nil (26991 13718 265528 0) 0 nil])
([nil nil ((#("
     (print \"TYPE: SCALAR\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 26 (face font-lock-string-face fontified t) 26 27 (face font-lock-string-face fontified t) 27 28 (fontified t rear-nonsticky t)) . 41394) (undo-tree-id44 . -28)) nil (26991 13718 265527 0) 0 nil])
([nil nil ((#("
     (print \"TYPE: array-type-p\")" 0 1 (fontified t) 1 13 (fontified t) 13 20 (face font-lock-string-face fontified t) 20 31 (face font-lock-string-face fontified t) 31 32 (face font-lock-string-face fontified t rear-nonsticky t) 32 33 (face font-lock-string-face fontified t) 33 34 (fontified t)) . 40801) (undo-tree-id43 . -34)) nil (26991 13718 265525 0) 0 nil])
([nil nil ((#("
     (print \"TYPE: NULL\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 24 (face font-lock-string-face fontified t) 24 25 (face font-lock-string-face fontified t) 25 26 (fontified t rear-nonsticky t)) . 40668) (undo-tree-id42 . -26)) nil (26991 13718 265524 0) 0 nil])
([nil nil ((26578 . 26580)) nil (26991 13718 265524 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 31756 . 31757) (nil fontified nil 26580 . 31757) (26580 . 31757)) nil (26991 13718 265523 0) 0 nil])
([nil nil ((20742 . 20743)) nil (26991 13718 265522 0) 0 nil])
([nil nil ((20743 . 20745)) nil (26991 13718 265522 0) 0 nil])
([nil nil ((26582 . 26583)) nil (26991 13718 265521 0) 0 nil])
([nil nil ((#("#" 0 1 (face font-lock-comment-face fontified t)) . -26582) (undo-tree-id41 . -1) 26583) nil (26991 13718 265521 0) 0 nil])
([nil nil ((26582 . 26584)) nil (26991 13718 265519 0) 0 nil])
([nil nil ((26584 . 26585)) nil (26991 13718 265519 0) 0 nil])
([nil nil ((#("
		(print \"ROWWWWWWWWWW\")" 0 1 (fontified t) 1 10 (fontified t) 10 23 (face font-lock-string-face fontified t) 23 24 (face font-lock-string-face fontified t rear-nonsticky t) 24 25 (fontified t)) . 20569) (undo-tree-id40 . -25)) nil (26991 13718 265518 0) 0 nil])
([nil nil ((#("
		     (x (print \"ROWWWWWWWWWW\"))
		     (x (print row))" 0 1 (fontified t) 1 13 (fontified t) 13 18 (fontified t) 18 32 (face font-lock-string-face fontified t) 32 35 (fontified t) 35 57 (fontified t)) . 20444) (undo-tree-id38 . -57) (undo-tree-id39 . -57)) nil (26991 13718 265514 0) 0 nil])
([nil nil ((27009 . 27013) (#("    " 0 4 (fontified nil)) . 27008) (undo-tree-id20 . -4) (27007 . 27013) (t 26991 13718 0 0)) nil (26991 28438 114667 0) 0 nil])
([nil nil ((27013 . 27018)) nil (26991 28438 114666 0) 0 nil])
([nil nil ((27018 . 27019)) nil (26991 28438 114665 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -27017) (undo-tree-id18 . -1) (#(" " 0 1 (fontified t)) . -27018) (undo-tree-id19 . -1) 27019) nil (26991 28438 114665 0) 0 nil])
([nil nil ((27017 . 27019)) nil (26991 28438 114663 0) 0 nil])
([nil nil ((27019 . 27020)) nil (26991 28438 114663 0) 0 nil])
([nil nil ((27020 . 27023)) nil (26991 28438 114662 0) 0 nil])
([nil nil ((27023 . 27028)) nil (26991 28438 114662 0) 0 nil])
([nil nil ((27028 . 27029)) nil (26991 28438 114662 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -27028) (undo-tree-id17 . -1) 27029) nil (26991 28438 114661 0) 0 nil])
([nil nil ((27028 . 27034)) nil (26991 28438 114660 0) 0 nil])
([nil nil ((27034 . 27035)) nil (26991 28438 114659 0) 0 nil])
([nil nil ((27035 . 27041)) nil (26991 28438 114659 0) 0 nil])
([nil nil ((27041 . 27046)) nil (26991 28438 114659 0) 0 nil])
([nil nil ((27046 . 27047)) nil (26991 28438 114658 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -27046) (undo-tree-id16 . -1) 27047) nil (26991 28438 114657 0) 0 nil])
([nil nil ((27046 . 27052)) nil (26991 28438 114656 0) 0 nil])
([nil nil ((27052 . 27053)) nil (26991 28438 114656 0) 0 nil])
([nil nil ((27053 . 27056)) nil (26991 28438 114656 0) 0 nil])
([nil nil ((27056 . 27061)) nil (26991 28438 114655 0) 0 nil])
([nil nil ((27061 . 27062)) nil (26991 28438 114655 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -27061) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) 27062) nil (26991 28438 114654 0) 0 nil])
([nil nil ((27061 . 27067)) nil (26991 28438 114651 0) 0 nil])
([nil nil ((27067 . 27068)) nil (26991 28438 114651 0) 0 nil])
([nil nil ((27068 . 27069)) nil (26991 28438 114650 0) 0 nil])
([nil nil ((27069 . 27074)) nil (26991 28438 114650 0) 0 nil])
([nil nil ((27068 . 27078) (#("ts-upd" 0 6 (fontified t)) . -27068) (undo-tree-id0 . -6) (undo-tree-id1 . -2) (undo-tree-id2 . -2) (undo-tree-id3 . -3) (undo-tree-id4 . -3) (undo-tree-id5 . -4) (undo-tree-id6 . -4) (undo-tree-id7 . -5) (undo-tree-id8 . -5) (undo-tree-id9 . -6) (undo-tree-id10 . -6) 27074) nil (26991 28438 114648 0) 0 nil])
([nil nil ((27078 . 27079)) nil (26991 28438 114624 0) 0 nil])
([nil nil ((27009 . 27013) (#("    " 0 4 (fontified nil)) . 27008) (27008 . 27012) (27008 . 27009) (t 26991 28438 0 0)) nil (26991 28447 192861 0) 0 nil])
([nil nil ((27013 . 27019)) nil (26991 28447 192860 0) 0 nil])
([nil nil ((27019 . 27020)) nil (26991 28447 192860 0) 0 nil])
([nil nil ((27020 . 27023)) nil (26991 28447 192860 0) 0 nil])
([nil nil ((27023 . 27024)) nil (26991 28447 192859 0) 0 nil])
([nil nil ((27024 . 27032)) nil (26991 28447 192858 0) 0 nil])
([nil nil ((27032 . 27040)) nil (26991 28447 192854 0) 0 nil])
([nil nil ((20176 . 20184) (t 26991 28447 0 0)) nil (26991 35127 670599 0) 0 nil])
([nil nil ((20184 . 20190)) nil (26991 35127 670599 0) 0 nil])
([nil nil ((20190 . 20191)) nil (26991 35127 670598 0) 0 nil])
([nil nil ((20191 . 20192)) nil (26991 35127 670598 0) 0 nil])
([nil nil ((#("é" 0 1 (fontified t)) . -20191) (undo-tree-id0 . -1) 20192) nil (26991 35127 670596 0) 0 nil])
([nil nil ((20191 . 20207)) nil (26991 35127 670581 0) 0 nil])
([nil nil ((20475 . 20483) (t 26991 35127 0 0)) nil (26991 35205 99174 0) 0 nil])
([nil nil ((20483 . 20485)) nil (26991 35205 99174 0) 0 nil])
([nil nil ((20485 . 20486)) nil (26991 35205 99173 0) 0 nil])
([nil nil ((20486 . 20489)) nil (26991 35205 99173 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -20488) (undo-tree-id1 . -1) 20489) nil (26991 35205 99172 0) 0 nil])
([nil nil ((20488 . 20492)) nil (26991 35205 99163 0) 0 nil])
([nil nil ((20492 . 20493)) nil (26991 35205 99162 0) 0 nil])
([nil nil ((20493 . 20503)) nil (26991 35205 99161 0) 0 nil])
([nil nil ((20503 . 20504)) nil (26991 35205 99157 0) 0 nil])
([nil nil ((20207 . 20215) (t 26991 35205 0 0)) nil (26991 35612 805046 0) 0 nil])
([nil nil ((20215 . 20221)) nil (26991 35612 805045 0) 0 nil])
([nil nil ((20221 . 20222)) nil (26991 35612 805044 0) 0 nil])
([nil nil ((20222 . 20226)) nil (26991 35612 805040 0) 0 nil])
([nil nil ((#(";; slot %%dirty pour suivre les modifications
(defparameter +dirty-slot-name+ '%%dirty)
(defparameter +original-slot-name+ '%%original)" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 46 (face font-lock-comment-face fontified t) 46 47 (fontified t) 47 59 (face font-lock-keyword-face fontified t) 59 60 (fontified t) 60 77 (face font-lock-variable-name-face fontified t) 77 88 (fontified t) 88 89 (fontified t) 89 101 (face font-lock-keyword-face fontified t) 101 102 (fontified t) 102 122 (face font-lock-variable-name-face fontified t) 122 135 (fontified t)) . 33017) (undo-tree-id9 . -135) 33152 (t 26993 53276 0 0)) nil (26997 987 365000 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -33016) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 33017) nil (26997 987 364999 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 33016)) nil (26997 987 364996 0) 0 nil])
([nil nil ((#("|
(defmethod entity-update! ((entity standard-object) &key (returning t) (patch nil))
  (let* ((class (class-name (class-of entity)))
         (md (entity-metadata class))
         (table (%ident (getf md :table)))
         (pk (or (getf md :primary-key) :id))
         (fields (getf md :fields))
         (lv-col (getf md :lock-version)) ; keyword ou NIL
         (ts (%timestamps-of md))
         (ts-updated (and ts (getf ts :updated)))
         (ts-fn (or (and ts (getf ts :db-fn)) \"CURRENT_TIMESTAMP\")))
    ;; Validations avant update (toujours)
    (validate-entity! entity)
    (let ((assigns '()) where)
      (multiple-value-bind (emit params-f) (%make-param-emitter)
        ;; Déterminer l’ensemble des slots “à considérer”
        (let* ((candidate-slots
                 (if patch (dirty-slots entity)
                     (mapcar (lambda (f) (getf f :slot)) fields)))
               ;; Récupérer slot/ty de PK & lock-version s'ils existent
               (pk-slot (getf (or (%field-by-col fields pk)
                                  (error \"PK ~a introuvable pour ~a\" pk class))
                              :slot))
               (pk-ty   (getf (or (%field-by-col fields pk)) :type))
               (lv-slot (and lv-col (getf (or (%field-by-col fields lv-col)) :slot)))
               (lv-ty   (and lv-col (getf (or (%field-by-col fields lv-col)) :type)))
               (lv-val  (and lv-slot (%slot-value entity lv-slot))))
          ;; WHERE: PK obligatoire
          (let ((pk-val (%slot-value entity pk-slot)))
            (unless pk-val (error \"Primary key manquante (~a) pour UPDATE\" pk))
            (setf where (format nil \"~a = ~a\" (%ident pk)
                                (funcall emit (coerce-out pk-val pk-ty)))))
          ;; WHERE: lock-version si configuré
          (when lv-col
            (unless lv-val
              (error \"Optimistic locking activé mais slot ~a est NIL\" lv-col))
            (setf where (format nil \"~a AND ~a = ~a\"
                                where
                                (%ident lv-col)
                                (funcall emit (coerce-out lv-val lv-ty)))))
          ;; SET: construire la liste d'assignations
          (dolist (f fields)
            (let* ((col (getf f :col))
                   (slot (getf f :slot))
                   (ty   (getf f :type))
                   (val  (%slot-value entity slot))
                   (is-pk (eq col pk))
                   (is-lv (and lv-col (eq col lv-col)))
                   (is-up (and ts-updated (eq col ts-updated)))
                   (selected (member slot candidate-slots :test #'eq))
		   ;; MODIF: On ignore les colonnes virtuelles
                   (is-virtual (%virtual-col-p f)))
	      (unless is-virtual
              (cond
                ;; Ne pas SET la PK
                (is-pk nil)
                ;; lock-version: on force \"col = col + 1\" (littéral SQL), jamais paramétré
                (is-lv (push (format nil \"~a = ~a + 1\" (%ident col) (%ident col)) assigns))
                ;; PATCH: ignorer les slots non dirty
                ((and patch (not selected)) nil)
                ;; updated_at: si NIL → forcer ts-fn, sinon paramétrer
                (is-up
                 (if (null val)
                     (push (format nil \"~a = ~a\" (%ident col) ts-fn) assigns)
                     (push (format nil \"~a = ~a\" (%ident col)
                                   (funcall emit (coerce-out val ty)))
			   assigns)))
                ;; slot normal
                (t
                 (push (format nil \"~a = ~a\" (%ident col)
                               (funcall emit (coerce-out val ty)))
		       assigns))))))
          ;; En mode patch, si aucun assign sélectionné, on peut quand même toucher updated_at
          (when (and patch ts-updated (null assigns))
            (push (format nil \"~a = ~a\" (%ident ts-updated) ts-fn) assigns))
          ;; S'assurer qu'il y a au moins un SET (sinon no-op)
	  (format t \"~&ENTITY-UPDATE!:ASSIGNS: ~A~%\" assigns)
          (let* ((assigns* (if assigns (nreverse assigns) '(\"/* no-op */\")))
                 (returning-sql
		   (cond
                     ;;((eq returning t) \" returning *\")
		     ;; Cas 1 : On veut tout retourner -> On liste explicitement les colonnes connues
                     ((eq returning t) 
                      (format nil \" RETURNING ~{~a~^, ~}\" 
                              (mapcar #'%ident (mapcar (lambda (f) (getf f :col)) fields))))
		     ;; Cas 2 : Liste explicite demandée par l'appelant
                     ((and (listp returning) (every #'keywordp returning))
                      (format nil \" returning ~{~a~^, ~}\" (mapcar #'%ident returning)))
		     ;; Cas 3 : Rien
                     ((null returning) \"\")
		     ;; Fallback
                     (t \" RETURNING *\")))
                 (sql (format nil \"update ~a set ~a where ~a~a\"
                              table (%comma-join assigns*) where returning-sql)))
            (before-update entity)
	    (format t \"~&ENTITY-UPDATE!: BEFORE UPDATE OK~%\")
            (multiple-value-bind (affected ret)
                (apply #'lumen.data.db:exec sql (funcall params-f))

              ;; Verrou optimiste: si 0 lignes affectées → conflit
              (when (and lv-col (= (or affected 0) 0))
                (error 'concurrent-update-error :entity entity :where where))
              ;; Si on a RETURNING, mapper la ligne ; sinon renvoyer l'entité modifiée
              (let ((row (or (first ret) (and (not (null returning))
                                      (apply #'query-1a sql (funcall params-f))))))
                (let ((new (if row (row->entity class row) entity)))
                  (clear-dirty new)
		  (snapshot-entity! new)
                  (after-update entity new)
                  (values affected new))))))))))
|#
" 0 1 (face font-lock-comment-delimiter-face fontified t) 1 5789 (face font-lock-comment-face fontified t) 5789 5838 (face font-lock-comment-face fontified t) 5838 5840 (face font-lock-comment-delimiter-face fontified t) 5840 5841 (fontified t)) . 20741) (undo-tree-id6 . -5841)) nil (26997 987 364995 0) 0 nil])
([nil nil ((#("#" 0 1 (fontified t)) . -20740) (undo-tree-id4 . -1) (undo-tree-id5 . -1) 20741) nil (26997 987 364993 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 20740)) nil (26997 987 364991 0) 0 nil])
([nil nil ((#("
#|
(defun entity->row-alist (entity &key (include-nulls nil))
  \"Convertit une instance CLOS d’entité en alist au format « row » (clés colonnes).
Les clés sont normalisées au style Postmodern (:CREATED-AT, :LOCK-VERSION, ...).\"
  (let* ((cls   (class-of entity))
         (cname (class-name cls))
         (md    (entity-metadata cname))
         (fields (getf md :fields)))
    (loop for f in fields
          for col  = (getf f :col)
          for slot = (getf f :slot)
          for key  = (%col->alist-key col)
          for have = (slot-boundp entity slot)
          for val  = (and have (slot-value entity slot))
          for out  = (coerce-in val (getf f :type))
          when (or include-nulls (and have (not (null out))))
            collect (cons key out))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 734 (face font-lock-comment-face fontified t) 734 772 (face font-lock-comment-face fontified t) 772 774 (face font-lock-comment-delimiter-face fontified t)) . 12901) (undo-tree-id3 . -774)) nil (26997 987 364990 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 12901)) nil (26997 987 364989 0) 0 nil])
([nil nil ((#("
#|
(defun dirty-slots (entity)
  (let ((h (slot-value entity '%%dirty)) (acc '()))
    (maphash (lambda (k v) (declare (ignore v)) (push k acc)) h)
    (nreverse acc)))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 170 (face font-lock-comment-face fontified t) 170 172 (face font-lock-comment-delimiter-face fontified t)) . 5782) (undo-tree-id0 . -172) (undo-tree-id1 . -172) (undo-tree-id2 . -172)) nil (26997 987 364988 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 5782)) nil (26997 987 364974 0) 0 nil])
([nil nil ((643 . 644)) nil (26997 987 364973 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 778 . 779) (nil fontified nil 766 . 779) (nil fontified nil 746 . 766) (nil fontified nil 745 . 746) (nil fontified nil 733 . 745) (nil fontified nil 732 . 733) (nil fontified nil 721 . 732) (nil fontified nil 704 . 721) (nil fontified nil 703 . 704) (nil fontified nil 691 . 703) (nil fontified nil 690 . 691) (nil fontified nil 647 . 690) (nil fontified nil 644 . 647) (644 . 779)) nil (26997 987 364972 0) 0 nil])
([nil current ((779 . 780)) nil (26997 987 364968 0) 0 nil])
nil
