(in-package :cl)

(defpackage :lumen.data.mws
  (:use :cl :alexandria)
  (:import-from :lumen.core.http :request :response :resp-body :resp-status
   :resp-headers :respond-500 :respond-404 :req-query :ctx-get :ctx-set!)
  (:import-from :lumen.utils :-> :->> :str-prefix-p :ensure-header :parse-http-date
		:format-http-date)
  (:import-from :lumen.core.middleware :define-middleware)
  
  (:export :tenant-from-host :my-compose :*app* :logger :json-only :query-parser
	   :parse-query-string-to-alist :*debug* :set-app! :*pipeline-signature*
	   :named :->mw :static :cors :cors-auto :static-many
	   :form-parser :multipart-parser
	   ;; Erreur Handlers
   :*error-handler* :error-wrapper
   ;; Cookies
   :request-id :set-cookie! :cookie :cookies-parser
   ;; ETag
   :etag
   ;; Compression
   :compression
   :last-modified-conditional
   ;; Session
	   :session
   :csrf
	   :auth-jwt
   :https-redirect
	   :auth-required :roles-allowed :rate-limit
	   :request-timeout :max-body-size :access-log-json
	   :tenant-from-host))

(in-package :lumen.data.mws)

(define-middleware tenant-from-host (req next)
  (let* ((host (cdr (assoc "host" (lumen.core.http:req-headers req) :test #'string-equal)))
         ;; mappe host -> UUID (ou via SELECT sur tenants(code))
         (tid  (crd.backend.repo:tenant-id-for-host host)))  ;; retourne une string UUID
    (when tid
      (lumen.core.http:ctx-set! req :tenant-id tid)
      ;; optionnel: aussi le code si tu veux
      (lumen.core.http:ctx-set! req :tenant-code (crd.backend.repo:tenant-code-by-id tid))))
  (funcall next req))