(undo-tree-save-format-version . 1)
"3f86922edd77caedafc50e1fd56372839810ec5d"
[nil nil nil nil (26790 8105 766715 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 230 . 231) (nil fontified nil 1 . 231) (1 . 231) (t . -1)) nil (26790 8105 766715 0) 0 nil])
([nil nil ((17 . 18)) nil (26790 8105 766714 0) 0 nil])
([nil nil ((46 . 48) (#(" " 0 1 (fontified nil)) . 45) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (46 . 47)) nil (26790 8105 766713 0) 0 nil])
([nil nil ((59 . 61) (#(" " 0 1 (fontified nil)) . 58) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (59 . 60)) nil (26790 8105 766711 0) 0 nil])
([nil nil ((98 . 99)) nil (26790 8105 766709 0) 0 nil])
([nil nil ((129 . 130)) nil (26790 8105 766708 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -128) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (#("
" 0 1 (fontified t)) . -129) (undo-tree-id4 . -1) 130) nil (26790 8105 766707 0) 0 nil])
([nil nil ((177 . 179) (154 . 156) 129) nil (26790 8105 766705 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -181) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 182) nil (26790 8105 766704 0) 0 nil])
([nil nil ((223 . 225) 183) nil (26790 8105 766692 0) 0 nil])
([nil nil ((241 . 242)) nil (26790 8105 766688 0) 0 nil])
([nil nil ((1 . 4893) (#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:export :connect :with-transaction))

(in-package :lumen.data.db)

(defun connect (&rest _)
  (declare (ignore _))
  t)

(defmacro with-transaction (&body body)
  `(progn ,@body))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 68 (face font-lock-builtin-face fontified t) 68 69 (fontified t) 69 77 (face font-lock-builtin-face fontified t) 77 78 (fontified t) 78 95 (face font-lock-builtin-face fontified t) 95 100 (fontified t) 100 110 (face font-lock-keyword-face fontified t) 110 111 (fontified t) 111 125 (face font-lock-builtin-face fontified t) 125 129 (fontified t) 129 134 (face font-lock-keyword-face fontified t) 134 135 (fontified t) 135 142 (face font-lock-function-name-face fontified t) 142 144 (fontified t) 144 149 (face font-lock-type-face fontified t) 149 156 (fontified t) 156 163 (face font-lock-keyword-face fontified t) 163 183 (fontified t) 183 191 (face font-lock-keyword-face fontified t) 191 192 (fontified t) 192 208 (face font-lock-function-name-face fontified t) 208 210 (fontified t) 210 215 (face font-lock-type-face fontified t) 215 226 (fontified t) 226 231 (face font-lock-keyword-face fontified t) 231 241 (fontified t)) . 1) (t 26790 8105 0 0)) nil (26802 3641 146559 0) 0 nil])
([nil nil ((#("(defun query-a (sql &rest params)
  \"Retourne une liste d'ALIST (clés keyword).\"
  (with-db
    (multiple-value-bind (rows _)
        (apply #'postmodern:query sql (append params (list *default-format*)))
      (declare (ignore _))
      (mapcar #'%plist->alist rows)))) ;; *default-format* = :plists → keys en keywords :contentReference[oaicite:4]{index=4}

(defun query-1a (sql &rest params)
  (first (apply #'query-a sql params)))

(defun exec (sql &rest params)
  \"Exécute (INSERT/UPDATE/DELETE). Retourne le nombre de lignes affectées (2e valeur).\"
  (with-db (apply #'postmodern:execute sql params))) ;; :contentReference[oaicite:5]{index=5}" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (face font-lock-function-name-face fontified t) 14 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 36 (fontified t) 36 80 (face font-lock-doc-face fontified t) 80 84 (fontified t) 84 91 (face font-lock-keyword-face fontified t) 91 97 (fontified t) 97 116 (face font-lock-keyword-face fontified t) 116 212 (fontified t) 212 219 (face font-lock-keyword-face fontified t) 219 271 (fontified t) 271 274 (face font-lock-comment-delimiter-face fontified t) 274 317 (face font-lock-comment-face fontified t) 317 358 (face font-lock-comment-face fontified t) 358 360 (fontified t) 360 365 (face font-lock-keyword-face fontified t) 365 366 (fontified t) 366 374 (face font-lock-function-name-face fontified t) 374 380 (fontified t) 380 385 (face font-lock-type-face fontified t) 385 436 (fontified t) 436 441 (face font-lock-keyword-face fontified t) 441 442 (fontified t) 442 446 (face font-lock-function-name-face fontified t) 446 452 (fontified t) 452 457 (face font-lock-type-face fontified t) 457 468 (fontified t) 468 553 (face font-lock-doc-face fontified t) 553 557 (fontified t) 557 564 (face font-lock-keyword-face fontified t) 564 607 (fontified t) 607 610 (face font-lock-comment-delimiter-face fontified t) 610 647 (face font-lock-comment-face fontified t)) . 4245) (undo-tree-id0 . -647) (undo-tree-id1 . -647) (undo-tree-id2 . -647) (undo-tree-id3 . -647) (undo-tree-id4 . -647) (undo-tree-id5 . -647) (t 26802 3641 0 0)) nil (26802 4011 22478 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5018 . 5019) (nil fontified nil 4245 . 5019) (4245 . 5019)) nil (26802 4011 22458 0) 0 nil])
([nil nil ((#("(defun query-a (sql &rest params)
  \"Liste d'alists (clés keywords) pour une requête dynamique.\"
  (with-db
    (let ((fn (postmodern:prepare sql *default-format*))) ; *default-format* = :plists
      (let ((rows (apply fn params)))
        (mapcar #'%plist->alist rows)))))                  ; plists -> alists

(defun query-1a (sql &rest params)
  (first (apply #'query-a sql params)))

(defun exec (sql &rest params)
  \"INSERT/UPDATE/DELETE → nombre de lignes affectées.\"
  (with-db
    (let ((fn (postmodern:prepare sql :none)))            ; :none = ignorer les valeurs
      ;; avec :none, le **compteur** est renvoyé en 2e MV (comme `query`) ;
      ;; `execute` (la macro) le renvoie en 1er MV, mais ici on passe par `prepare`.
      (nth-value 1 (apply fn params)))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (face font-lock-function-name-face fontified t) 14 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 36 (fontified t) 36 96 (face font-lock-doc-face fontified t) 96 100 (fontified t) 100 107 (face font-lock-keyword-face fontified t) 107 113 (fontified t) 113 116 (face font-lock-keyword-face fontified t) 116 166 (fontified t) 166 195 (face font-lock-comment-face fontified t) 195 202 (fontified t) 202 205 (face font-lock-keyword-face fontified t) 205 292 (fontified t) 292 311 (face font-lock-comment-face fontified t) 311 313 (fontified t) 313 318 (face font-lock-keyword-face fontified t) 318 319 (fontified t) 319 327 (face font-lock-function-name-face fontified t) 327 333 (fontified t) 333 338 (face font-lock-type-face fontified t) 338 389 (fontified t) 389 394 (face font-lock-keyword-face fontified t) 394 395 (fontified t) 395 399 (face font-lock-function-name-face fontified t) 399 405 (fontified t) 405 410 (face font-lock-type-face fontified t) 410 421 (fontified t) 421 473 (face font-lock-doc-face fontified t) 473 477 (fontified t) 477 484 (face font-lock-keyword-face fontified t) 484 490 (fontified t) 490 493 (face font-lock-keyword-face fontified t) 493 523 (fontified t) 523 528 (face font-lock-builtin-face fontified t) 528 543 (fontified t) 543 573 (face font-lock-comment-face fontified t) 573 579 (fontified t) 579 582 (face font-lock-comment-delimiter-face fontified t) 582 649 (face font-lock-comment-face fontified t) 649 655 (fontified t) 655 658 (face font-lock-comment-delimiter-face fontified t) 658 734 (face font-lock-comment-face fontified t) 734 773 (fontified t) 773 774 (rear-nonsticky t fontified t) 774 775 (fontified t)) . 4245) (undo-tree-id6 . -141) (undo-tree-id7 . -775) (undo-tree-id8 . -141) (undo-tree-id9 . -142) (undo-tree-id10 . -257) (undo-tree-id11 . -141) (undo-tree-id12 . -141) (undo-tree-id13 . -142) (undo-tree-id14 . -142) (undo-tree-id15 . -142) (undo-tree-id16 . -142) (undo-tree-id17 . -142) (undo-tree-id18 . -142) (undo-tree-id19 . -142) (undo-tree-id20 . -142) (undo-tree-id21 . -775) (undo-tree-id22 . -775) (undo-tree-id23 . -775) (undo-tree-id24 . -775) (undo-tree-id25 . -775) (t 26802 4011 0 0)) nil (26802 4524 940098 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4903 . 4904) (nil fontified nil 4245 . 4904) (4245 . 4904)) nil (26802 4524 940073 0) 0 nil])
([nil nil ((4904 . 4905)) nil (26802 4524 940069 0) 0 nil])
([nil nil ((#("(defpackage :lumen.data.db
  (:use :cl :alexandria)
  (:import-from :cl-ppcre :register-groups-bind)
  (:import-from :lumen.core.config :cfg-get :cfg-get-int :cfg-get-bool :cfg-get-list)
  (:import-from :lumen.utils :alist-get)
  (:nicknames :lumen.db)
  (:export
   :start! :stop!
   :with-db :tx
   :query-a :query-1a :exec
   :connect-spec
   :*default-format*))

(in-package :lumen.data.db)

;; ---------- État ----------
(defparameter *connect-spec* nil)     ;; ex: '(\"db\" \"user\" \"pass\" \"host\" :port 5432 :pooled-p t :use-ssl :require)
(defparameter *default-format* :plists) ;; :plists => colonnes en keywords; on convertit ensuite en alist
(defparameter *app-name* \"lumen\")

(defun connect-spec () *connect-spec*)

;; ---------- Utils ----------
(defun %percent-decode (s)
  \"Décodage %xx minimal (UTF-8 safe tant que s est ASCII).\"
  (with-output-to-string (o)
    (loop for i from 0 below (length s)
          for c = (char s i)
          do (cond
               ((and (char= c #\\%)
                     (<= (+ i 2) (1- (length s))))
                (let* ((h1 (char s (1+ i)))
                       (h2 (char s (+ i 2)))
                       (b (parse-integer (string h1 h2) :radix 16 :junk-allowed t)))
                  (when b (write-char (code-char b) o))
                  (incf i 2)))
               (t (write-char c o))))))

(defun %parse-pg-url (url)
  \"postgres://user:pass@host:port/db?sslmode=require&application_name=...\"
  (register-groups-bind (user pass host port db qs)
      (\"^postgres(?:ql)?://([^:@/]+)(?::([^@/]*))?@([^/:?#]+)(?::([0-9]+))?/([^?]+)(?:\\\\?(.*))?$\" url)
    (let* ((user (%percent-decode user))
           (pass (%percent-decode (or pass \"\")))
           (host host)
           (port (if port (parse-integer port) 5432))
           (db   (%percent-decode db))
           (pairs (when qs (mapcar (lambda (kv)
                                     (let* ((p (uiop:split-string kv :separator \"=\"))
                                            (k (string-downcase (first p)))
                                            (v (and (second p) (%percent-decode (second p)))))
                                       (cons k v)))
                                   (uiop:split-string qs :separator \"&\"))))
           (sslmode (cdr (assoc \"sslmode\" pairs :test #'string=)))
           (appname (or (cdr (assoc \"application_name\" pairs :test #'string=)) *app-name*))
           (ssl (ecase (intern (string-upcase (or sslmode \"disable\")) :keyword)
                  (:DISABLE :no) (:ALLOW :try) (:PREFER :try) (:REQUIRE :require)
                  (:VERIFY-CA :yes) (:VERIFY-FULL :full))))
      (list db user pass host :port port :pooled-p t :use-ssl ssl :application-name appname))))

(defun %plist->alist (pl)
  (loop for (k v) on pl by #'cddr collect (cons k v)))

(defun %ensure-spec (&key url host db user pass (port 5432) ssl app-name)
  (cond
    (url (%parse-pg-url url))
    ((and host db user)
     (let ((ssl (or ssl :no)))
       (list db user (or pass \"\") host :port port :pooled-p t :use-ssl ssl
             :application-name (or app-name *app-name*))))
    (t (error \"DB config incomplète. Fournis :url ou (host db user ...).\"))))

;; ---------- API ----------
(defun start! (&key url host db user pass (port nil) (pool-size nil) (ssl nil) (app-name \"lumen\"))
  \"Initialise le pool Postgres (Postmodern) avec une connexion de test.\"
  (setf postmodern:*max-pool-size* pool-size) ;; NIL = pas de limite. :contentReference[oaicite:1]{index=1}
  (setf *connect-spec* (%ensure-spec :url url :host host :db db :user user :pass pass
                                     :port (or port 5432) :ssl ssl :app-name app-name))
  ;; Smoke test: SELECT 1
  (postmodern:with-connection *connect-spec*
    (postmodern:query \"select 1\"))
  t)

(defun stop! ()
  \"Vide le pool.\"
  (postmodern:clear-connection-pool) ;; :contentReference[oaicite:2]{index=2}
  (setf *connect-spec* nil)
  t)

(defmacro with-db (&body body)
  \"Lie postmodern:*database* via le pool (sûr en threads).\"
  `(postmodern:with-connection *connect-spec*
     ,@body))

(defmacro tx (&body body)
  \"Transaction (commit/rollback auto).\"
  `(postmodern:with-transaction () ,@body)) ;; :contentReference[oaicite:3]{index=3}

(defun query-a (sql &rest params)
  \"SELECT → liste d'alists (clés keyword).\"
  (with-db
    ;; prepare est une macro → format LITTÉRAL ici
    (let ((fn (postmodern:prepare sql :plists)))
      (let ((rows (apply fn params)))
        (mapcar #'%plist->alist rows)))))

(defun query-1a (sql &rest params)
  (first (apply #'query-a sql params)))

(defun exec (sql &rest params)
  \"INSERT/UPDATE/DELETE → nombre de lignes affectées (comme `execute`).\"
  (with-db
    ;; `execute` est une macro → on construit la forme et on l'évalue.
    ;; Les `params` restent des *valeurs* séparées (placeholders $1,$2,...)
    (eval (list* 'postmodern:execute sql params))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 26 (face font-lock-type-face fontified t) 26 30 (fontified t) 30 34 (face font-lock-builtin-face fontified t) 34 35 (fontified t) 35 38 (face font-lock-builtin-face fontified t) 38 39 (fontified t) 39 50 (face font-lock-builtin-face fontified t) 50 55 (fontified t) 55 67 (face font-lock-builtin-face fontified t) 67 68 (fontified t) 68 77 (face font-lock-builtin-face fontified t) 77 78 (fontified t) 78 99 (face font-lock-builtin-face fontified t) 99 104 (fontified t) 104 116 (face font-lock-builtin-face fontified t) 116 117 (fontified t) 117 135 (face font-lock-builtin-face fontified t) 135 136 (fontified t) 136 144 (face font-lock-builtin-face fontified t) 144 145 (fontified t) 145 157 (face font-lock-builtin-face fontified t) 157 158 (fontified t) 158 171 (face font-lock-builtin-face fontified t) 171 172 (fontified t) 172 185 (face font-lock-builtin-face fontified t) 185 190 (fontified t) 190 202 (face font-lock-builtin-face fontified t) 202 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 226 (face font-lock-builtin-face fontified t) 226 231 (fontified t) 231 241 (face font-lock-builtin-face fontified t) 241 242 (fontified t) 242 251 (face font-lock-builtin-face fontified t) 251 256 (fontified t) 256 263 (face font-lock-builtin-face fontified t) 263 267 (fontified t) 267 274 (face font-lock-builtin-face fontified t) 274 275 (fontified t) 275 281 (face font-lock-builtin-face fontified t) 281 285 (fontified t) 285 293 (face font-lock-builtin-face fontified t) 293 294 (fontified t) 294 297 (face font-lock-builtin-face fontified t) 297 301 (fontified t) 301 309 (face font-lock-builtin-face fontified t) 309 310 (fontified t) 310 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 325 (face font-lock-builtin-face fontified t) 325 329 (fontified t) 329 342 (face font-lock-builtin-face fontified t) 342 346 (fontified t) 346 363 (face font-lock-builtin-face fontified t) 363 368 (fontified t) 368 378 (face font-lock-keyword-face fontified t) 378 379 (fontified t) 379 393 (face font-lock-builtin-face fontified t) 393 396 (fontified t) 396 399 (face font-lock-comment-delimiter-face fontified t) 399 426 (face font-lock-comment-face fontified t) 426 427 (fontified t) 427 439 (face font-lock-keyword-face fontified t) 439 440 (fontified t) 440 454 (face font-lock-variable-name-face fontified t) 454 464 (fontified t) 464 467 (face font-lock-comment-delimiter-face fontified t) 467 541 (face font-lock-comment-face fontified t) 541 542 (fontified t) 542 554 (face font-lock-keyword-face fontified t) 554 555 (fontified t) 555 571 (face font-lock-variable-name-face fontified t) 571 572 (fontified t) 572 579 (face font-lock-builtin-face fontified t) 579 581 (fontified t) 581 584 (face font-lock-comment-delimiter-face fontified t) 584 647 (face font-lock-comment-face fontified t) 647 648 (fontified t) 648 660 (face font-lock-keyword-face fontified t) 660 661 (fontified t) 661 671 (face font-lock-variable-name-face fontified t) 671 672 (fontified t) 672 679 (face font-lock-string-face fontified t) 679 683 (fontified t) 683 688 (face font-lock-keyword-face fontified t) 688 689 (fontified t) 689 701 (face font-lock-function-name-face fontified t) 701 722 (fontified t) 722 725 (face font-lock-comment-delimiter-face fontified t) 725 753 (face font-lock-comment-face fontified t) 753 754 (fontified t) 754 759 (face font-lock-keyword-face fontified t) 759 760 (fontified t) 760 775 (face font-lock-function-name-face fontified t) 775 782 (fontified t) 782 839 (face font-lock-doc-face fontified t) 839 843 (fontified t) 843 864 (face font-lock-keyword-face fontified t) 864 874 (fontified t) 874 878 (face font-lock-keyword-face fontified t) 878 952 (fontified t) 952 956 (face font-lock-keyword-face fontified t) 956 1060 (fontified t) 1060 1064 (face font-lock-keyword-face fontified t) 1064 1188 (fontified t) 1188 1194 (face font-lock-builtin-face fontified t) 1194 1198 (fontified t) 1198 1211 (face font-lock-builtin-face fontified t) 1211 1236 (fontified t) 1236 1240 (face font-lock-keyword-face fontified t) 1240 1345 (fontified t) 1345 1346 (fontified t) 1346 1351 (face font-lock-keyword-face fontified t) 1351 1352 (fontified t) 1352 1365 (face font-lock-function-name-face fontified t) 1365 1374 (fontified t) 1374 1446 (face font-lock-doc-face fontified t) 1446 1482 (fontified t) 1482 1499 (fontified t) 1499 1506 (fontified t) 1506 1528 (face font-lock-string-face fontified t) 1528 1529 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1529 1541 (face font-lock-string-face fontified t) 1541 1542 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1542 1552 (face font-lock-string-face fontified t) 1552 1553 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1553 1577 (face font-lock-string-face fontified t) 1577 1578 (face (font-lock-negation-char-face font-lock-string-face) fontified t) 1578 1596 (face font-lock-string-face fontified t) 1596 1607 (fontified t) 1607 1611 (face font-lock-keyword-face fontified t) 1611 1686 (fontified t) 1686 1688 (face font-lock-string-face fontified t) 1688 1733 (fontified t) 1733 1735 (face font-lock-keyword-face fontified t) 1735 1827 (fontified t) 1827 1831 (face font-lock-keyword-face fontified t) 1831 1844 (fontified t) 1844 1850 (face font-lock-keyword-face fontified t) 1850 1894 (fontified t) 1894 1898 (face font-lock-keyword-face fontified t) 1898 1925 (fontified t) 1925 1935 (face font-lock-builtin-face fontified t) 1935 1936 (fontified t) 1936 1939 (face font-lock-string-face fontified t) 1939 2222 (fontified t) 2222 2232 (face font-lock-builtin-face fontified t) 2232 2233 (fontified t) 2233 2236 (face font-lock-string-face fontified t) 2236 2273 (fontified t) 2273 2282 (face font-lock-string-face fontified t) 2282 2289 (fontified t) 2289 2294 (face font-lock-builtin-face fontified t) 2294 2344 (fontified t) 2344 2362 (face font-lock-string-face fontified t) 2362 2369 (fontified t) 2369 2374 (face font-lock-builtin-face fontified t) 2374 2417 (fontified t) 2417 2422 (face font-lock-keyword-face fontified t) 2422 2458 (fontified t) 2458 2467 (face font-lock-string-face fontified t) 2467 2470 (fontified t) 2470 2478 (face font-lock-builtin-face fontified t) 2478 2499 (fontified t) 2499 2507 (face font-lock-builtin-face fontified t) 2507 2508 (fontified t) 2508 2511 (face font-lock-builtin-face fontified t) 2511 2514 (fontified t) 2514 2520 (face font-lock-builtin-face fontified t) 2520 2521 (fontified t) 2521 2525 (face font-lock-builtin-face fontified t) 2525 2528 (fontified t) 2528 2535 (face font-lock-builtin-face fontified t) 2535 2536 (fontified t) 2536 2540 (face font-lock-builtin-face fontified t) 2540 2543 (fontified t) 2543 2551 (face font-lock-builtin-face fontified t) 2551 2552 (fontified t) 2552 2560 (face font-lock-builtin-face fontified t) 2560 2581 (fontified t) 2581 2591 (face font-lock-builtin-face fontified t) 2591 2592 (fontified t) 2592 2596 (face font-lock-builtin-face fontified t) 2596 2599 (fontified t) 2599 2611 (face font-lock-builtin-face fontified t) 2611 2612 (fontified t) 2612 2617 (face font-lock-builtin-face fontified t) 2617 2652 (fontified t) 2652 2657 (face font-lock-builtin-face fontified t) 2657 2663 (fontified t) 2663 2672 (face font-lock-builtin-face fontified t) 2672 2675 (fontified t) 2675 2683 (face font-lock-builtin-face fontified t) 2683 2688 (fontified t) 2688 2705 (face font-lock-builtin-face fontified t) 2705 2720 (fontified t) 2720 2725 (face font-lock-keyword-face fontified t) 2725 2726 (fontified t) 2726 2739 (face font-lock-function-name-face fontified t) 2739 2748 (fontified t) 2748 2752 (face font-lock-keyword-face fontified t) 2752 2801 (fontified t) 2801 2802 (fontified t) 2802 2807 (face font-lock-keyword-face fontified t) 2807 2808 (fontified t) 2808 2820 (face font-lock-function-name-face fontified t) 2820 2822 (fontified t) 2822 2826 (face font-lock-type-face fontified t) 2826 2878 (fontified t) 2878 2882 (face font-lock-keyword-face fontified t) 2882 2943 (fontified t) 2943 2946 (face font-lock-keyword-face fontified t) 2946 2961 (fontified t) 2961 2964 (face font-lock-builtin-face fontified t) 2964 2998 (fontified t) 2998 2999 (face font-lock-string-face fontified t) 2999 3000 (face font-lock-string-face fontified t) 3000 3007 (fontified t) 3007 3012 (face font-lock-builtin-face fontified t) 3012 3018 (fontified t) 3018 3027 (face font-lock-builtin-face fontified t) 3027 3030 (fontified t) 3030 3038 (face font-lock-builtin-face fontified t) 3038 3043 (fontified t) 3043 3056 (fontified t) 3056 3073 (face font-lock-builtin-face fontified t) 3073 3110 (fontified t) 3110 3115 (face font-lock-warning-face fontified t) 3115 3116 (fontified t) 3116 3175 (face font-lock-string-face fontified t) 3175 3181 (fontified t) 3181 3184 (face font-lock-comment-delimiter-face fontified t) 3184 3210 (face font-lock-comment-face fontified t) 3210 3211 (fontified t) 3211 3216 (face font-lock-keyword-face fontified t) 3216 3217 (fontified t) 3217 3223 (face font-lock-function-name-face fontified t) 3223 3225 (fontified t) 3225 3229 (face font-lock-type-face fontified t) 3229 3299 (fontified t) 3299 3306 (face font-lock-string-face fontified t) 3306 3311 (fontified t) 3311 3381 (face font-lock-doc-face fontified t) 3381 3428 (fontified t) 3428 3431 (face font-lock-comment-delimiter-face fontified t) 3431 3490 (face font-lock-comment-face fontified t) 3490 3527 (fontified t) 3527 3531 (face font-lock-builtin-face fontified t) 3531 3536 (fontified t) 3536 3541 (face font-lock-builtin-face fontified t) 3541 3547 (fontified t) 3547 3550 (face font-lock-builtin-face fontified t) 3550 3554 (fontified t) 3554 3559 (face font-lock-builtin-face fontified t) 3559 3565 (fontified t) 3565 3570 (face font-lock-builtin-face fontified t) 3570 3613 (fontified t) 3613 3618 (face font-lock-builtin-face fontified t) 3618 3634 (fontified t) 3634 3638 (face font-lock-builtin-face fontified t) 3638 3643 (fontified t) 3643 3652 (face font-lock-builtin-face fontified t) 3652 3666 (fontified t) 3666 3669 (face font-lock-comment-delimiter-face fontified t) 3669 3690 (face font-lock-comment-face fontified t) 3690 3693 (fontified t) 3693 3719 (face font-lock-keyword-face fontified t) 3719 3757 (fontified t) 3757 3767 (face font-lock-string-face fontified t) 3767 3777 (fontified t) 3777 3782 (face font-lock-keyword-face fontified t) 3782 3783 (fontified t) 3783 3788 (face font-lock-function-name-face fontified t) 3788 3794 (fontified t) 3794 3809 (face font-lock-doc-face fontified t) 3809 3847 (fontified t) 3847 3850 (face font-lock-comment-delimiter-face fontified t) 3850 3888 (face font-lock-comment-face fontified t) 3888 3923 (fontified t) 3923 3931 (face font-lock-keyword-face fontified t) 3931 3932 (fontified t) 3932 3939 (face font-lock-function-name-face fontified t) 3939 3941 (fontified t) 3941 3946 (face font-lock-type-face fontified t) 3946 3955 (fontified t) 3955 4012 (face font-lock-doc-face fontified t) 4012 4017 (fontified t) 4017 4043 (face font-lock-keyword-face fontified t) 4043 4075 (fontified t) 4075 4083 (face font-lock-keyword-face fontified t) 4083 4084 (fontified t) 4084 4086 (face font-lock-function-name-face fontified t) 4086 4088 (fontified t) 4088 4093 (face font-lock-type-face fontified t) 4093 4102 (fontified t) 4102 4139 (face font-lock-doc-face fontified t) 4139 4144 (fontified t) 4144 4171 (face font-lock-keyword-face fontified t) 4171 4184 (fontified t) 4184 4187 (face font-lock-comment-delimiter-face fontified t) 4187 4225 (face font-lock-comment-face fontified t) 4225 4227 (fontified t) 4227 4232 (face font-lock-keyword-face fontified t) 4232 4233 (fontified t) 4233 4240 (face font-lock-function-name-face fontified t) 4240 4246 (fontified t) 4246 4251 (face font-lock-type-face fontified t) 4251 4262 (fontified t) 4262 4303 (face font-lock-doc-face fontified t) 4303 4307 (fontified t) 4307 4314 (face font-lock-keyword-face fontified t) 4314 4319 (fontified t) 4319 4322 (face font-lock-comment-delimiter-face fontified t) 4322 4366 (face font-lock-comment-face fontified t) 4366 4371 (fontified t) 4371 4374 (face font-lock-keyword-face fontified t) 4374 4404 (fontified t) 4404 4411 (face font-lock-builtin-face fontified t) 4411 4422 (fontified t) 4422 4425 (face font-lock-keyword-face fontified t) 4425 4497 (fontified t) 4497 4502 (face font-lock-keyword-face fontified t) 4502 4503 (fontified t) 4503 4511 (face font-lock-function-name-face fontified t) 4511 4517 (fontified t) 4517 4522 (face font-lock-type-face fontified t) 4522 4543 (fontified t) 4543 4571 (fontified t) 4571 4573 (fontified t) 4573 4578 (face font-lock-keyword-face fontified t) 4578 4579 (fontified t) 4579 4583 (face font-lock-function-name-face fontified t) 4583 4589 (fontified t) 4589 4594 (face font-lock-type-face fontified t) 4594 4605 (fontified t) 4605 4675 (face font-lock-doc-face fontified t) 4675 4679 (fontified t) 4679 4686 (face font-lock-keyword-face fontified t) 4686 4691 (fontified t) 4691 4694 (face font-lock-comment-delimiter-face fontified t) 4694 4758 (face font-lock-comment-face fontified t) 4758 4762 (fontified t) 4762 4765 (face font-lock-comment-delimiter-face fontified t) 4765 4834 (face font-lock-comment-face fontified t) 4834 4886 (fontified t)) . -19) (undo-tree-id7 . -4886) (undo-tree-id8 . -4225) 4905 (t 26802 4524 0 0)) nil (26802 47621 849678 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1731 . 1732) (nil fontified nil 19 . 1732) (19 . 1732)) nil (26802 47807 705323 0) 0 nil] [nil nil ((nil rear-nonsticky nil 1582 . 1583) (nil fontified nil 19 . 1583) (19 . 1583)) ((#("(defpackage :lumen.data.db
(error \"DB start! failed\"))))
#-postmodern
(setf *started* t))


(defun stop! ()
\"Close toplevel connection. Idempotent.\"
#+postmodern (ignore-errors (postmodern:disconnect-toplevel))
(setf *started* nil)
t)


;; ----------------------------------------------------------------------------
;; Transactions
;; ----------------------------------------------------------------------------
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) (retries 0)) &body body)
\"Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts.\"
(declare (ignore isolation read-only retries))
#+postmodern
`(postmodern:with-transaction () ,@body)
#-postmodern
`(progn ,@body))


;; ----------------------------------------------------------------------------
;; Internal helpers
;; ----------------------------------------------------------------------------
(defun %rows->alists (rows)
\"Best-effort conversion to alists. If ROWS already look like alists, return as-is.\"
(if (and rows (consp (first rows)) (keywordp (caar rows)))
rows
;; Fallback – leave as-is (caller may adapt). Improve with column metadata if needed.
rows))


(defun %now-ms ()
(round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))


;; ----------------------------------------------------------------------------
;; Query wrappers
;; ----------------------------------------------------------------------------" 0 1 (fontified nil) 1 11 (face font-lock-keyword-face fontified nil) 11 12 (fontified nil) 12 26 (face font-lock-type-face fontified nil) 26 28 (fontified nil) 28 33 (face font-lock-warning-face fontified nil) 33 34 (fontified nil) 34 52 (face font-lock-string-face fontified nil) 52 92 (fontified nil) 92 93 (fontified nil) 93 98 (face font-lock-keyword-face fontified nil) 98 99 (fontified nil) 99 104 (face font-lock-function-name-face fontified nil) 104 108 (fontified nil) 108 148 (face font-lock-doc-face fontified nil) 148 149 (fontified nil) 149 210 (face slime-reader-conditional-face fontified nil) 210 232 (fontified nil) 232 234 (fontified nil) 234 235 (fontified nil) 235 236 (fontified nil) 236 237 (fontified nil) 237 240 (face font-lock-comment-delimiter-face fontified nil) 240 317 (face font-lock-comment-face fontified nil) 317 320 (face font-lock-comment-delimiter-face fontified nil) 320 333 (face font-lock-comment-face fontified nil) 333 336 (face font-lock-comment-delimiter-face fontified nil) 336 413 (face font-lock-comment-face fontified nil) 413 414 (fontified nil) 414 422 (face font-lock-keyword-face fontified nil) 422 423 (fontified nil) 423 430 (face font-lock-function-name-face fontified nil) 430 433 (fontified nil) 433 437 (face font-lock-type-face fontified nil) 437 449 (fontified nil) 449 464 (face font-lock-builtin-face fontified nil) 464 495 (fontified nil) 495 500 (face font-lock-type-face fontified nil) 500 507 (fontified nil) 507 702 (face font-lock-doc-face fontified nil) 702 704 (fontified nil) 704 711 (face font-lock-keyword-face fontified nil) 711 750 (fontified nil) 750 803 (face slime-reader-conditional-face fontified nil) 803 817 (fontified nil) 817 819 (fontified nil) 819 824 (face font-lock-keyword-face fontified nil) 824 833 (fontified nil) 833 834 (fontified nil) 834 835 (fontified nil) 835 836 (fontified nil) 836 839 (face font-lock-comment-delimiter-face fontified nil) 839 916 (face font-lock-comment-face fontified nil) 916 919 (face font-lock-comment-delimiter-face fontified nil) 919 936 (face font-lock-comment-face fontified nil) 936 939 (face font-lock-comment-delimiter-face fontified nil) 939 1016 (face font-lock-comment-face fontified nil) 1016 1017 (fontified nil) 1017 1022 (face font-lock-keyword-face fontified nil) 1022 1023 (fontified nil) 1023 1036 (face font-lock-function-name-face fontified nil) 1036 1044 (fontified nil) 1044 1127 (face font-lock-doc-face fontified nil) 1127 1129 (fontified nil) 1129 1131 (face font-lock-keyword-face fontified nil) 1131 1192 (fontified nil) 1192 1195 (face font-lock-comment-delimiter-face fontified nil) 1195 1278 (face font-lock-comment-face fontified nil) 1278 1288 (fontified nil) 1288 1293 (face font-lock-keyword-face fontified nil) 1293 1294 (fontified nil) 1294 1301 (face font-lock-function-name-face fontified nil) 1301 1385 (fontified nil) 1385 1386 (fontified nil) 1386 1387 (fontified nil) 1387 1390 (face font-lock-comment-delimiter-face fontified nil) 1390 1467 (face font-lock-comment-face fontified nil) 1467 1470 (face font-lock-comment-delimiter-face fontified nil) 1470 1485 (face font-lock-comment-face fontified nil) 1485 1488 (face font-lock-comment-delimiter-face fontified nil) 1488 1500 (face font-lock-comment-face fontified nil) 1500 1563 (face font-lock-comment-face fontified nil) 1563 1564 (face font-lock-comment-face fontified nil rear-nonsticky nil)) . 19) (undo-tree-id9 . -1386) (undo-tree-id10 . -804) (undo-tree-id11 . -1386) (undo-tree-id12 . -834) (undo-tree-id13 . -235) (undo-tree-id14 . -235) (undo-tree-id15 . -360) (undo-tree-id16 . -360) (undo-tree-id17 . -149) (undo-tree-id18 . -151) (undo-tree-id19 . -92) (undo-tree-id20 . -232) (undo-tree-id21 . -750) (undo-tree-id22 . -752) (undo-tree-id23 . -750) (undo-tree-id24 . -752) (undo-tree-id25 . -413) (undo-tree-id26 . -817) (undo-tree-id27 . -1386) (undo-tree-id28 . -1386) (nil fontified t 1489 . 1504) (nil fontified t 1486 . 1489) (nil fontified t 1409 . 1486) (nil fontified t 1406 . 1409) (nil fontified t 1405 . 1406) (nil fontified t 1404 . 1405) (nil fontified t 1320 . 1404) (nil fontified t 1313 . 1320) (nil fontified t 1312 . 1313) (nil fontified t 1307 . 1312) (nil fontified t 1297 . 1307) (nil fontified t 1214 . 1297) (nil fontified t 1211 . 1214) (nil fontified t 1150 . 1211) (nil fontified t 1148 . 1150) (nil fontified t 1146 . 1148) (nil fontified t 1063 . 1146) (nil fontified t 1055 . 1063) (nil fontified t 1042 . 1055) (nil fontified t 1041 . 1042) (nil fontified t 1036 . 1041) (nil fontified t 1035 . 1036) (nil fontified t 958 . 1035) (nil fontified t 955 . 958) (nil fontified t 938 . 955) (nil fontified t 935 . 938) (nil fontified t 858 . 935) (nil fontified t 855 . 858) (nil fontified t 854 . 855) (nil fontified t 853 . 854) (nil fontified t 852 . 853) (nil fontified t 843 . 852) (nil fontified t 838 . 843) (nil fontified t 836 . 838) (nil fontified t 822 . 836) (nil fontified t 769 . 822) (nil fontified t 730 . 769) (nil fontified t 723 . 730) (nil fontified t 721 . 723) (nil fontified t 526 . 721) (nil fontified t 519 . 526) (nil fontified t 514 . 519) (nil fontified t 483 . 514) (nil fontified t 468 . 483) (nil fontified t 456 . 468) (nil fontified t 452 . 456) (nil fontified t 449 . 452) (nil fontified t 442 . 449) (nil fontified t 441 . 442) (nil fontified t 433 . 441) (nil fontified t 432 . 433) (nil fontified t 355 . 432) (nil fontified t 352 . 355) (nil fontified t 339 . 352) (nil fontified t 336 . 339) (nil fontified t 259 . 336) (nil fontified t 256 . 259) (nil fontified t 255 . 256) (nil fontified t 254 . 255) (nil fontified t 253 . 254) (nil fontified t 251 . 253) (nil fontified t 229 . 251) (nil fontified t 168 . 229) (nil fontified t 167 . 168) (nil fontified t 127 . 167) (nil fontified t 123 . 127) (nil fontified t 118 . 123) (nil fontified t 117 . 118) (nil fontified t 112 . 117) (nil fontified t 111 . 112) (nil fontified t 71 . 111) (nil fontified t 53 . 71) (nil fontified t 52 . 53) (nil fontified t 47 . 52) (nil fontified t 45 . 47) (nil fontified t 31 . 45) (nil fontified t 30 . 31) (nil fontified t 20 . 30) (nil fontified t 19 . 20) (nil rear-nonsticky t 1582 . 1583)) (26802 47621 320709 0) 0 nil])
([nil nil ((1536 . 1538) (1521 . 1523) (1490 . 1491) (1468 . 1469) (1446 . 1447) (1433 . 1439) (1410 . 1413) (1331 . 1334) (1295 . 1298) (1287 . 1288) (1269 . 1273) (1202 . 1204) (1167 . 1169) (1128 . 1130) (1082 . 1084) (1049 . 1051) (1020 . 1022) (982 . 984) (967 . 969) (934 . 936) (799 . 801) 757) nil (26802 47807 705322 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1404) (undo-tree-id5 . -1) (undo-tree-id6 . -1) 1405) ((1404 . 1405)) (26802 47620 738293 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -579) (undo-tree-id38 . -1) (undo-tree-id39 . -1) 580) nil (26802 47807 705319 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -852) (undo-tree-id3 . -1) (undo-tree-id4 . -1) 853) ((852 . 853)) (26802 47620 200269 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -354) (undo-tree-id36 . -1) (undo-tree-id37 . -1) 355) nil (26802 47807 705318 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -253) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 254) ((253 . 254)) (26802 47620 200201 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -1555) (undo-tree-id34 . -1) (undo-tree-id35 . -1) 1556) nil (26802 47807 705316 0) 0 nil])
nil
([nil nil ((#("(defun stop! ()
\"Close toplevel connection. Idempotent.\"
#+postmodern (ignore-errors (postmodern:disconnect-toplevel))
(setf *started* nil)" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 12 (face font-lock-function-name-face fontified t) 12 16 (fontified t) 16 56 (face font-lock-doc-face fontified t) 56 57 (fontified t) 57 118 (face slime-reader-conditional-face fontified t) 118 139 (fontified t)) . -1557) (undo-tree-id33 . -139) 1696) nil (26802 47807 705314 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1698 . 1699) (nil fontified nil 1557 . 1699) (1557 . 1699)) nil (26802 47807 705313 0) 0 nil])
([nil nil ((1697 . 1699) (1699 . 1700)) nil (26802 47807 705313 0) 0 nil])
([nil nil ((1680 . 1682) (1616 . 1618) (1573 . 1575) 1557) nil (26802 47807 705312 0) 0 nil])
([nil nil ((1707 . 1709)) nil (26802 47807 705312 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2855 . 2856) (nil fontified nil 1709 . 2856) (1709 . 2856)) nil (26802 47807 705311 0) 0 nil])
([nil nil ((#("

;; ----------------------------------------------------------------------------" 0 1 (fontified t) 1 2 (fontified t) 2 5 (face font-lock-comment-delimiter-face fontified t) 5 80 (face font-lock-comment-face fontified t) 80 81 (face font-lock-comment-face fontified t rear-nonsticky t)) . -2856) (undo-tree-id32 . -81) 2937) nil (26802 47807 705310 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2306) (undo-tree-id30 . -1) (undo-tree-id31 . -1) 2307) nil (26802 47807 705309 0) 0 nil])
([nil nil ((2299 . 2301) (2284 . 2286) (2241 . 2243) (2226 . 2228) (2177 . 2179) (1979 . 1981) 1885) nil (26802 47807 705307 0) 0 nil])
([nil nil ((2777 . 2783) (2685 . 2691) (2674 . 2680) (2613 . 2615) (2527 . 2529) 2499) nil (26802 47807 705306 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -2789) (undo-tree-id29 . -1) 2790) nil (26802 47807 705304 0) 0 nil])
([nil nil ((2891 . 2892) (2809 . 2811) (2888 . 2889)) nil (26802 47807 705295 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3068 . 3069) (nil fontified nil 2892 . 3069) (2892 . 3069)) nil (26802 47807 705294 0) 0 nil])
([nil nil ((3069 . 3070)) nil (26802 47807 705294 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3694 . 3695) (nil fontified nil 3070 . 3695) (3070 . 3695)) nil (26802 47807 705293 0) 0 nil])
([nil nil ((3695 . 3696)) nil (26802 47807 705293 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4021 . 4022) (nil fontified nil 3696 . 4022) (3696 . 4022)) nil (26802 47807 705292 0) 0 nil])
([nil nil ((4022 . 4023)) nil (26802 47807 705291 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4763 . 4764) (nil fontified nil 4023 . 4764) (4023 . 4764)) nil (26802 47807 705288 0) 0 nil])
([nil nil ((277 . 279) (218 . 220) (162 . 164) (106 . 108) (59 . 61) (46 . 48) 19 (t 26802 47807 0 0)) nil (26802 48424 517843 0) 0 nil])
([nil nil ((338 . 339)) nil (26802 48424 517842 0) 0 nil])
([nil nil ((58 . 61)) nil (26802 48424 517842 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 95 . 96) (nil fontified nil 95 . 96) (nil fontified nil 87 . 95) (nil fontified nil 86 . 87) (nil fontified nil 75 . 86) (nil fontified nil 74 . 75) (nil fontified nil 62 . 74) (nil fontified nil 61 . 62) (61 . 96)) nil (26802 48424 517841 0) 0 nil])
([nil nil ((#("prepare" 0 7 (face font-lock-builtin-face fontified t)) . -88) (undo-tree-id40 . -7) 95) nil (26802 48424 517840 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 106 . 107) (nil fontified nil 88 . 107) (88 . 107)) nil (26802 48424 517830 0) 0 nil])
([nil nil ((107 . 108)) nil (26802 48424 517829 0) 0 nil])
([nil nil ((87 . 88)) nil (26802 48424 517829 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 103 . 104) (nil fontified nil 88 . 104) (88 . 104)) nil (26802 48424 517828 0) 0 nil])
([nil nil ((104 . 105)) nil (26802 48424 517827 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 141 . 142) (nil fontified nil 126 . 142) (126 . 142)) nil (26802 48424 517826 0) 0 nil])
([nil nil ((126 . 127)) nil (26802 48424 517822 0) 0 nil])
([nil nil ((246 . 247) (t 26802 48424 0 0)) nil (26802 51659 125808 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 301 . 302) (nil fontified nil 279 . 302) (nil fontified nil 268 . 279) (nil fontified nil 267 . 268) (nil fontified nil 247 . 267) (247 . 302)) nil (26802 51659 125807 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 267)) nil (26802 51659 125806 0) 0 nil])
([nil nil ((#("        " 0 8 (fontified nil)) . -271) (267 . 268)) nil (26802 51659 125806 0) 0 nil])
([nil nil ((87 . 90) (#(" " 0 1 (fontified nil)) . 86) (undo-tree-id45 . -1) (87 . 88)) nil (26802 51659 125805 0) 0 nil])
([nil nil ((183 . 186) (#(" " 0 1 (fontified nil)) . 182) (undo-tree-id44 . -1) (183 . 184)) nil (26802 51659 125804 0) 0 nil])
([nil nil ((234 . 237) (#(" " 0 1 (fontified nil)) . 233) (undo-tree-id43 . -1) (234 . 235)) nil (26802 51659 125802 0) 0 nil])
([nil nil ((#("
  " 0 1 (fontified t) 1 3 (fontified t)) . -276) (undo-tree-id42 . -3) 279) nil (26802 51659 125801 0) 0 nil])
([nil nil ((416 . 419)) nil (26802 51659 125799 0) 0 nil])
([nil nil ((58 . 61)) nil (26802 51659 125799 0) 0 nil])
([nil nil ((#(":start! :stop! :with-tx :query-a :query-1a :exec" 0 7 (face font-lock-builtin-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-builtin-face fontified t) 14 15 (fontified t) 15 23 (face font-lock-builtin-face fontified t) 23 24 (fontified t) 24 32 (face font-lock-builtin-face fontified t) 32 33 (fontified t) 33 42 (face font-lock-builtin-face fontified t) 42 43 (fontified t) 43 48 (face font-lock-builtin-face fontified t)) . -434) (undo-tree-id41 . -48) 482) nil (26802 51659 125798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 563 . 564) (nil fontified nil 434 . 564) (434 . 564)) nil (26802 51659 125789 0) 0 nil])
([nil nil ((818 . 819)) nil (26802 51659 125858 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 894 . 895) (nil fontified nil 819 . 895) (819 . 895)) nil (26802 54107 576152 0) 0 nil] [nil nil ((nil rear-nonsticky nil 948 . 949) (nil fontified nil 819 . 949) (819 . 949)) ((#(":start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection
           :*connection-mode*" 0 7 (face font-lock-builtin-face fontified nil) 7 8 (fontified nil) 8 14 (face font-lock-builtin-face fontified nil) 14 15 (fontified nil) 15 23 (face font-lock-builtin-face fontified nil) 23 35 (fontified nil) 35 43 (face font-lock-builtin-face fontified nil) 43 44 (fontified nil) 44 53 (face font-lock-builtin-face fontified nil) 53 54 (fontified nil) 54 59 (face font-lock-builtin-face fontified nil) 59 71 (fontified nil) 71 81 (face font-lock-builtin-face fontified nil) 81 82 (fontified nil) 82 100 (face font-lock-builtin-face fontified nil) 100 101 (fontified nil) 101 112 (fontified nil) 112 129 (face font-lock-builtin-face fontified nil) 129 130 (face font-lock-builtin-face rear-nonsticky nil fontified nil)) . 819) (undo-tree-id46 . -130) (undo-tree-id47 . -101) (nil fontified t 919 . 920) (nil fontified t 901 . 919) (nil fontified t 900 . 901) (nil fontified t 890 . 900) (nil fontified t 878 . 890) (nil fontified t 873 . 878) (nil fontified t 872 . 873) (nil fontified t 863 . 872) (nil fontified t 862 . 863) (nil fontified t 854 . 862) (nil fontified t 842 . 854) (nil fontified t 834 . 842) (nil fontified t 833 . 834) (nil fontified t 827 . 833) (nil fontified t 826 . 827) (nil fontified t 819 . 826) (nil rear-nonsticky t 948 . 949)) (26802 51659 125784 0) 0 nil])
([nil nil ((2816 . 2817)) nil (26802 54107 576152 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 3074 . 3075) (nil fontified nil 2817 . 3075) (2817 . 3075)) nil (26802 54107 576151 0) 0 nil])
([nil nil ((3467 . 3469)) nil (26802 54107 576150 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3572 . 3573) (nil fontified nil 3469 . 3573) (3469 . 3573)) nil (26802 54107 576150 0) 0 nil])
([nil nil ((#("(defun start! (&key (config (db-config)))
  \"Initialize Postmodern connection (toplevel) using CONFIG.
CONFIG is the plist returned by lumen.data.config:db-config. Idempotent.\"
  (setf *current-config* config)
  #+postmodern
  (let* ((db (getf config :database))
	 (user (getf config :user))
	 (pass (getf config :password))
	 (host (or (getf config :host) \"localhost\"))
	 (port (or (getf config :port) 5432))
	 (sslmode (getf config :sslmode))
	 (use-ssl (member sslmode '(:require :verify-ca :verify-full))) )
    (handler-case
	(progn
	  (postmodern:disconnect-toplevel)
	  (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl)
	  (setf *started* t))
      (t (c)
	(declare (ignore c))
	(setf *started* nil)
	(error \"DB start! failed\"))))
  #-postmodern
  (setf *started* t))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 13 (face font-lock-function-name-face fontified t) 13 15 (fontified t) 15 19 (face font-lock-type-face fontified t) 19 42 (fontified t) 42 44 (fontified t) 44 103 (face font-lock-doc-face fontified t) 103 176 (face font-lock-doc-face fontified t) 176 177 (fontified t) 177 212 (fontified t) 212 227 (face slime-reader-conditional-face fontified t) 227 265 (face slime-reader-conditional-face fontified t) 265 294 (face slime-reader-conditional-face fontified t) 294 327 (face slime-reader-conditional-face fontified t) 327 357 (face slime-reader-conditional-face fontified t) 357 368 (face slime-reader-conditional-face fontified t) 368 373 (face slime-reader-conditional-face fontified t) 373 412 (face slime-reader-conditional-face fontified t) 412 447 (face slime-reader-conditional-face fontified t) 447 516 (face slime-reader-conditional-face fontified t) 516 531 (face slime-reader-conditional-face fontified t) 531 541 (face slime-reader-conditional-face fontified t) 541 577 (face slime-reader-conditional-face fontified t) 577 648 (face slime-reader-conditional-face fontified t) 648 656 (face slime-reader-conditional-face fontified t) 656 682 (face slime-reader-conditional-face fontified t) 682 690 (face slime-reader-conditional-face fontified t) 690 712 (face slime-reader-conditional-face fontified t) 712 734 (face slime-reader-conditional-face fontified t) 734 741 (face slime-reader-conditional-face fontified t) 741 743 (face slime-reader-conditional-face fontified t) 743 759 (face slime-reader-conditional-face fontified t) 759 763 (face slime-reader-conditional-face fontified t) 763 764 (fontified t) 764 766 (fontified t) 766 779 (fontified t) 779 781 (fontified t) 781 790 (fontified t) 790 791 (fontified t) 791 800 (fontified t)) . -1073) (undo-tree-id90 . -800) 1873) nil (26802 54107 576149 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2414 . 2415) (nil fontified nil 1073 . 2415) (1073 . 2415)) nil (26802 54107 576147 0) 0 nil])
([nil nil ((#("(defun stop! ()
  \"Close toplevel connection. Idempotent.\"
  #+postmodern (ignore-errors (postmodern:disconnect-toplevel))
  (setf *started* nil)
  t)" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 12 (face font-lock-function-name-face fontified t) 12 16 (fontified t) 16 18 (fontified t) 18 58 (face font-lock-doc-face fontified t) 58 61 (fontified t) 61 64 (face slime-reader-conditional-face fontified t) 64 92 (face slime-reader-conditional-face fontified t) 92 122 (face slime-reader-conditional-face fontified t) 122 123 (fontified t) 123 125 (fontified t) 125 145 (fontified t) 145 146 (fontified t) 146 148 (fontified t) 148 149 (fontified t) 149 150 (fontified t rear-nonsticky t)) . -2417) (undo-tree-id89 . -150) 2567) nil (26802 54107 576146 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2592 . 2593) (nil fontified nil 2417 . 2593) (2417 . 2593)) nil (26802 54107 576145 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only retries))
  #+postmodern
  `(postmodern:with-transaction () ,@body)
  #-postmodern
  `(progn ,@body))" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 49 (fontified t) 49 64 (face slime-reader-conditional-face fontified t) 64 104 (face slime-reader-conditional-face fontified t) 104 107 (fontified t) 107 122 (fontified t) 122 124 (fontified t) 124 129 (face font-lock-keyword-face fontified t) 129 138 (fontified t)) . -3065) (undo-tree-id88 . -138) 3203) nil (26802 54107 576144 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3221 . 3222) (nil fontified nil 3065 . 3222) (3065 . 3222)) nil (26802 54107 576143 0) 0 nil])
([nil nil ((3065 . 3066)) nil (26802 54107 576142 0) 0 nil])
([nil nil ((2593 . 2595)) nil (26802 54107 576142 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4138 . 4139) (nil fontified nil 2595 . 4139) (2595 . 4139)) nil (26802 54107 576141 0) 0 nil])
([nil nil ((4139 . 4141)) nil (26802 54107 576141 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4203 . 4204) (nil fontified nil 4141 . 4204) (4141 . 4204)) nil (26802 54107 576140 0) 0 nil])
([nil nil ((#(";; ----------------------------------------------------------------------------
;; Transactions
;; ----------------------------------------------------------------------------" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 55 (face font-lock-comment-face fontified t) 55 80 (face font-lock-comment-face fontified t) 80 83 (face font-lock-comment-delimiter-face fontified t) 83 96 (face font-lock-comment-face fontified t) 96 99 (face font-lock-comment-delimiter-face fontified t) 99 103 (face font-lock-comment-face fontified t) 103 117 (face font-lock-comment-face fontified t) 117 118 (face font-lock-comment-face fontified t) 118 175 (face font-lock-comment-face fontified t)) . 4206) (undo-tree-id87 . -175) 4381) nil (26802 54107 576139 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -4205) (undo-tree-id85 . -1) (undo-tree-id86 . -1) 4206) nil (26802 54107 576138 0) 0 nil])
([nil nil ((2594 . 2595)) nil (26802 54107 576136 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2769 . 2770) (nil fontified nil 2713 . 2770) (nil fontified nil 2712 . 2713) (nil fontified nil 2698 . 2712) (nil fontified nil 2694 . 2698) (nil fontified nil 2691 . 2694) (nil fontified nil 2678 . 2691) (nil fontified nil 2675 . 2678) (nil fontified nil 2650 . 2675) (nil fontified nil 2598 . 2650) (nil fontified nil 2595 . 2598) (2595 . 2770)) nil (26802 54107 576135 0) 0 nil])
([nil nil ((2678 . 2689)) nil (26802 54107 576134 0) 0 nil])
([nil nil ((2689 . 2690)) nil (26802 54107 576133 0) 0 nil])
([nil nil ((2690 . 2691)) nil (26802 54107 576133 0) 0 nil])
([nil nil ((2691 . 2692)) nil (26802 54107 576132 0) 0 nil])
([nil nil ((#("(defun query-a (sql &rest params)
  \"Execute a SELECT-like statement, return (values rows-alist count).\"
  (let ((t0 (get-internal-real-time)))
    (handler-case
        (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
               (rows (apply fn params))
               (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                         internal-time-units-per-second))))
          (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
          (values rows (length rows)))
      (condition (c)
        (lumen.data.errors:translate-db-error c)))))

(defun query-1a (sql &rest params)
  \"Like query-a but expect 0/1 row; return alist or NIL. Uses :alist format.\"
  (handler-case
      (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
             (row (apply fn params)))
        row)
    (condition (c)
      (lumen.data.errors:translate-db-error c))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (face font-lock-function-name-face fontified t) 14 20 (fontified t) 20 25 (face font-lock-type-face fontified t) 25 36 (fontified t) 36 104 (face font-lock-doc-face fontified t) 104 108 (fontified t) 108 111 (face font-lock-keyword-face fontified t) 111 149 (fontified t) 149 161 (face font-lock-keyword-face fontified t) 161 171 (fontified t) 171 175 (face font-lock-keyword-face fontified t) 175 225 (fontified t) 225 232 (face font-lock-builtin-face fontified t) 232 233 (fontified t) 233 240 (face font-lock-builtin-face fontified t) 240 271 (fontified t) 271 283 (fontified t) 283 315 (fontified t) 315 355 (fontified t) 355 380 (fontified t) 380 383 (fontified t) 383 431 (fontified t) 431 537 (fontified t) 537 551 (fontified t) 551 624 (fontified t) 624 625 (fontified t rear-nonsticky t) 625 626 (fontified t) 626 627 (fontified t) 627 632 (face font-lock-keyword-face fontified t) 632 633 (fontified t) 633 641 (face font-lock-function-name-face fontified t) 641 647 (fontified t) 647 652 (face font-lock-type-face fontified t) 652 663 (fontified t) 663 738 (face font-lock-doc-face fontified t) 738 742 (fontified t) 742 754 (face font-lock-keyword-face fontified t) 754 762 (fontified t) 762 766 (face font-lock-keyword-face fontified t) 766 815 (fontified t) 815 822 (face font-lock-builtin-face fontified t) 822 823 (fontified t) 823 829 (face font-lock-builtin-face fontified t) 829 848 (fontified t) 848 870 (fontified t) 870 929 (fontified t) 929 951 (fontified t)) . -5966) (undo-tree-id83 . -105) (undo-tree-id84 . -951) 6917) nil (26802 54107 576131 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6693 . 6694) (nil fontified nil 5966 . 6694) (5966 . 6694)) nil (26802 54107 576130 0) 0 nil])
([nil nil ((#("Returns (values affected returning?).
If the SQL has a RETURNING clause, fetch the single returned row as an alist" 0 114 (face font-lock-doc-face fontified t)) . -6760) (undo-tree-id82 . -114) 6874) nil (26802 54107 576129 0) 0 nil])
([nil nil ((#("." 0 1 (face font-lock-doc-face fontified t)) . 6760)) nil (26802 54107 576128 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-doc-face fontified t)) . -6759) (undo-tree-id80 . -1) (undo-tree-id81 . -1) 6760) nil (26802 54107 576127 0) 0 nil])
([nil nil ((6759 . 6760)) nil (26802 54107 576125 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6879 . 6880) (nil fontified nil 6760 . 6880) (6760 . 6880)) nil (26802 54107 576125 0) 0 nil])
([nil nil ((#("(handler-case
      (let* ((lower (string-downcase sql))
             (has-returning (search \"returning\" lower)))
        (if has-returning
            (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
                   (row (apply fn params)))
              (values (if row 1 0) row))
            (let* ((fn       (lumen.data.prepare:get-prepared-plan sql :format :raw))
                   (affected (or (apply fn params) 0)))
              (values affected nil))))
    (condition (c)
      (lumen.data.errors:translate-db-error c)))" 0 1 (fontified t) 1 13 (face font-lock-keyword-face fontified t) 13 21 (fontified t) 21 25 (face font-lock-keyword-face fontified t) 25 93 (fontified t) 93 102 (face font-lock-string-face fontified t) 102 104 (face font-lock-string-face fontified t) 104 114 (fontified t) 114 123 (fontified t) 123 125 (face font-lock-keyword-face fontified t) 125 153 (fontified t) 153 157 (face font-lock-keyword-face fontified t) 157 183 (fontified t) 183 185 (fontified t) 185 206 (fontified t) 206 213 (face font-lock-builtin-face fontified t) 213 214 (fontified t) 214 220 (face font-lock-builtin-face fontified t) 220 223 (fontified t) 223 266 (fontified t) 266 267 (fontified t) 267 290 (fontified t) 290 292 (face font-lock-keyword-face fontified t) 292 321 (fontified t) 321 325 (face font-lock-keyword-face fontified t) 325 364 (fontified t) 364 379 (fontified t) 379 386 (face font-lock-builtin-face fontified t) 386 387 (fontified t) 387 391 (face font-lock-builtin-face fontified t) 391 394 (fontified t) 394 556 (fontified t)) . -6884) (undo-tree-id78 . -56) (undo-tree-id79 . -556) 7440) nil (26802 54107 576124 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7420 . 7421) (nil fontified nil 6884 . 7421) (6884 . 7421)) nil (26802 54107 576122 0) 0 nil])
([nil nil ((7422 . 7423)) nil (26802 54107 576121 0) 0 nil])
([nil nil ((4848 . 4850)) nil (26802 54107 576121 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6621 . 6622) (nil fontified nil 4850 . 6622) (4850 . 6622)) nil (26802 54107 576120 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -6621) (undo-tree-id77 . -1) 6622) nil (26802 54107 576119 0) 0 nil])
([nil nil ((#("Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts." 0 54 (face font-lock-doc-face fontified t) 54 65 (face font-lock-doc-face fontified t) 65 96 (face font-lock-doc-face fontified t) 96 125 (face font-lock-doc-face fontified t) 125 193 (face font-lock-doc-face fontified t)) . 4493) (undo-tree-id76 . -193) 4686) nil (26802 54107 576118 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4979 . 4980) (nil fontified nil 4912 . 4980) (nil fontified nil 4883 . 4912) (nil fontified nil 4852 . 4883) (nil fontified nil 4841 . 4852) (nil fontified nil 4787 . 4841) (4787 . 4980)) nil (26802 54107 576116 0) 0 nil])
([nil nil ((4980 . 4982)) nil (26802 54107 576115 0) 0 nil])
([nil nil ((#("
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) (retries 0)) &body body)
  \"\"
  (declare (ignore isolation read-only retries))
  #+postmodern
  `(ensure-connection (postmodern:with-transaction () ,@body))
  #-postmodern
  `(progn ,@body))" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 21 (fontified t) 21 25 (face font-lock-type-face fontified t) 25 37 (fontified t) 37 52 (face font-lock-builtin-face fontified t) 52 83 (fontified t) 83 88 (face font-lock-type-face fontified t) 88 95 (fontified t) 95 97 (fontified t) 97 98 (face font-lock-doc-face fontified t) 98 99 (face font-lock-doc-face fontified t) 99 100 (fontified t) 100 103 (fontified t) 103 110 (face font-lock-keyword-face fontified t) 110 149 (fontified t) 149 151 (fontified t) 151 226 (face slime-reader-conditional-face fontified t) 226 242 (fontified t) 242 246 (fontified t) 246 251 (face font-lock-keyword-face fontified t) 251 259 (fontified t) 259 260 (fontified t rear-nonsticky t)) . 4395) (undo-tree-id75 . -260)) nil (26802 54107 576114 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -4394) (undo-tree-id73 . -1) (undo-tree-id74 . -1) 4395) nil (26802 54107 576113 0) 0 nil])
([nil nil ((359 . 360)) nil (26802 54107 576111 0) 0 nil])
([nil nil ((360 . 361)) nil (26802 54107 576111 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 372 . 373) (nil fontified nil 361 . 373) (361 . 373)) nil (26802 54107 576110 0) 0 nil])
([nil nil ((373 . 374)) nil (26802 54107 576109 0) 0 nil])
([nil nil ((374 . 379)) nil (26802 54107 576109 0) 0 nil])
([nil nil ((#("u" 0 1 (fontified t)) . -378) (undo-tree-id72 . -1) 379) nil (26802 54107 576108 0) 0 nil])
([nil nil ((378 . 381)) nil (26802 54107 576107 0) 0 nil])
([nil nil ((374 . 383) (#("retryab" 0 7 (fontified t)) . -374) (undo-tree-id71 . -7) 381) nil (26802 54107 576107 0) 0 nil])
([nil nil ((383 . 384)) nil (26802 54107 576105 0) 0 nil])
([nil nil ((374 . 394) (#("retryable-" 0 10 (fontified t)) . -374) (undo-tree-id70 . -10) 384) nil (26802 54107 576104 0) 0 nil])
([nil nil ((374 . 375)) nil (26802 54107 576103 0) 0 nil])
([nil nil ((#("(let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        ;; pool natif via :pooled-p t
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app
                                          :pooled-p t)
          ,@body))" 0 169 (face slime-reader-conditional-face fontified t) 169 189 (face slime-reader-conditional-face fontified t) 189 200 (face slime-reader-conditional-face fontified t) 200 302 (face slime-reader-conditional-face fontified t) 302 304 (face slime-reader-conditional-face fontified t) 304 379 (face slime-reader-conditional-face fontified t) 379 382 (face slime-reader-conditional-face fontified t) 382 409 (face slime-reader-conditional-face fontified t) 409 588 (face slime-reader-conditional-face fontified t) 588 668 (face slime-reader-conditional-face fontified t) 668 676 (face slime-reader-conditional-face fontified t)) . -3653) (undo-tree-id69 . -676) 4329) nil (26802 54107 576102 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5031 . 5032) (nil fontified nil 3653 . 5032) (3653 . 5032)) nil (26802 54107 576098 0) 0 nil])
([nil nil ((#(")" 0 1 (face slime-reader-conditional-face fontified t)) . -5033) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) 5034) nil (26802 54107 576096 0) 0 nil])
([nil nil ((5033 . 5034)) nil (26802 54107 576082 0) 0 nil])
([nil nil ((5068 . 5069)) nil (26802 54107 576081 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -5068) (undo-tree-id48 . -1) (undo-tree-id49 . -1) 5069) nil (26802 54107 576077 0) 0 nil])
([nil nil ((1 . 9685) (#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection
           :*connection-mode*))

(in-package :lumen.data.db)

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
;; :toplevel | :scoped | :pooled-native
(defvar *connection-mode* :toplevel)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (db-config)))
  \"Initialise selon :connection-mode.
:toplevel → connect-toplevel
:scoped   → rien (ouverture par bloc)
:pooled-native → rien ici (piscine Postmodern via :pooled-p dans with-conn).
Tu peux régler postmodern:*max-pool-size* en amont.\"
  (setf *current-config* config
        *connection-mode* (or (getf config :connection-mode) :toplevel))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    (:scoped (setf *started* t))
    (:pooled-native (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections & Transactions
;; ----------------------------------------------------------------------------
(defmacro with-conn (&body body)
  \"Ouvre une connexion selon *connection-mode* avec les bons paramètres Postmodern.\"
  #+postmodern
  `(ecase *connection-mode*
     (:toplevel
      (progn ,@body))
     (:scoped
      (let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
          ,@body)))
     (:pooled-native
      (let ((deadline (+ (get-internal-real-time)
                    (* cl:internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
       (start (get-internal-real-time)))
   (labels ((acquire-slot ()
              (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                  (if (< (get-internal-real-time) deadline)
                      (acquire-slot)
                      (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
     (acquire-slot)
     (let* ((wait-ms (* 1000.0 (/ (- (get-internal-real-time) start)
                                  cl:internal-time-units-per-second))))
       ;; enregistre métrique (nb slots utilisés = *pool-size* - count du sema)
       (let ((in-use (- *pool-size* (bt:semaphore-count *pool-sema*))))
         (lumen.data.metrics:record-pool-stats in-use wait-ms)))
     (unwind-protect
          (let* ((cfg *current-config*)
                 (db   (getf cfg :database))
                 (user (getf cfg :user))
                 (pass (getf cfg :password))
                 (host (or (getf cfg :host) \"localhost\"))
                 (port (or (getf cfg :port) 5432))
                 (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
            (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl)
              ,@body))
       (bt:signal-semaphore *pool-sema*))))))
  #-postmodern
  `(progn ,@body))

(defmacro ensure-connection (&body body)
  `(with-conn ,@body))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) (retries 0) (sleep-ms 50))
                   &body body)
  \"Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts.

Transaction avec **retries** automatiques sur erreurs retryables (deadlock/serialization/timeout).
Arguments :
  :isolation  — décoratif pour l’instant (hook possible si tu veux paramétrer).
  :read-only  — décoratif / futur.
  :retries    — nombre de tentatives additionnelles (0 = pas de retry).
  :sleep-ms   — temps d’attente entre tentatives (backoff linéaire simple).
Exemple : (with-tx (:retries 3 :sleep-ms 100) ...)\"
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\")))
    `(let ((,g-attempt 0)
           (,g-retries ,retries)
           (,g-sleep ,sleep-ms))
       (loop
         (handler-case
             (return
               (ensure-connection
                 #+postmodern
                 (postmodern:with-transaction () ,@body)
                 #-postmodern
                 (progn ,@body)))
           (condition (c)
             ;; Convertit en condition Lumen sans la signaler, puis évalue la rejouabilité
             (let ((mapped (lumen.data.errors:map-db-error c)))
               (if (and (< ,g-attempt ,g-retries)
                        (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (incf ,g-attempt)
                     ;; Backoff simple (optionnel)
                     (when (plusp ,g-sleep)
                       (sleep (/ (max 0 ,g-sleep) 1000.0)))
                     ;; et on boucle pour retenter
                     (continue))
                   ;; Pas rejouable (ou plus de retries) → signaler l’erreur Lumen
                   (error mapped)))))))))

;; ----------------------------------------------------------------------------
;; Internal helpers
;; ----------------------------------------------------------------------------
;; Postmodern attend :use-ssl = :no | :try | :require | :yes | :full
(defun %sslmode->use-ssl (sslmode)
  (case sslmode
    ((:disable nil) :no)
    ((:allow :prefer) :try)
    (:require :require)
    (:verify-ca :yes)
    (:verify-full :full)
    (t :no)))

(defun %rows->alists (rows)
  \"Best-effort conversion to alists. If ROWS already look like alists, return as-is.\"
  (if (and rows (consp (first rows)) (keywordp (caar rows)))
      rows
      ;; Fallback – leave as-is (caller may adapt). Improve with column metadata if needed.
      rows))

(defun %now-ms ()
  (round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))

(defun %elapsed-ms (t0)
  (* 1000.0 (/ (- (get-internal-real-time) t0) internal-time-units-per-second)))

;; ----------------------------------------------------------------------------
;; Query wrappers
;; ----------------------------------------------------------------------------
(defun query-a (sql &rest params)
  \"SELECT 0..N → (values rows-alist count), format :alists.\"
  (ensure-connection
    (let ((t0 (get-internal-real-time)))
      (handler-case
          (let* ((fn   (get-prepared-plan sql :format :alists))
                 (rows (apply fn params)))
            (record-query-latency sql (%elapsed-ms t0) (length rows))
            (values rows (length rows)))
        (condition (c) (translate-db-error c))))))

(defun query-1a (sql &rest params)
  \"SELECT 0/1 → alist | NIL, format :alist.\"
  (ensure-connection
    (handler-case
        (let* ((fn  (get-prepared-plan sql :format :alist))
               (row (apply fn params)))
          row)
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE.
DML → (values affected returning?).
- sans RETURNING → :raw → entier affecté
- avec RETURNING  → :alist → première ligne\"
  (ensure-connection
    (handler-case
        (let* ((lower (string-downcase sql))
               (has-returning (search \"returning\" lower)))
          (if has-returning
              (let* ((fn  (get-prepared-plan sql :format :alist))
                     (row (apply fn params)))
                (values (if row 1 0) row))
              (let* ((fn       (get-prepared-plan sql :format :raw))
                     (affected (or (apply fn params) 0)))
                (values affected nil))))
      (condition (c) (translate-db-error c)))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 461 (fontified t) 461 468 (face font-lock-builtin-face fontified t) 468 469 (fontified t) 469 476 (face font-lock-builtin-face fontified t) 476 477 (fontified t) 477 483 (face font-lock-builtin-face fontified t) 483 484 (fontified t) 484 492 (face font-lock-builtin-face fontified t) 492 504 (fontified t) 504 512 (face font-lock-builtin-face fontified t) 512 513 (fontified t) 513 522 (face font-lock-builtin-face fontified t) 522 523 (fontified t) 523 528 (face font-lock-builtin-face fontified t) 528 540 (fontified t) 540 550 (face font-lock-builtin-face fontified t) 550 551 (fontified t) 551 569 (face font-lock-builtin-face fontified t) 569 581 (fontified t) 581 599 (face font-lock-builtin-face fontified t) 599 604 (fontified t) 604 614 (face font-lock-keyword-face fontified t) 614 615 (fontified t) 615 629 (face font-lock-builtin-face fontified t) 629 632 (fontified t) 632 635 (face font-lock-comment-delimiter-face fontified t) 635 712 (face font-lock-comment-face fontified t) 712 715 (face font-lock-comment-delimiter-face fontified t) 715 721 (face font-lock-comment-face fontified t) 721 724 (face font-lock-comment-delimiter-face fontified t) 724 801 (face font-lock-comment-face fontified t) 801 802 (fontified t) 802 808 (face font-lock-keyword-face fontified t) 808 809 (fontified t) 809 818 (face font-lock-variable-name-face fontified t) 818 825 (fontified t) 825 831 (face font-lock-keyword-face fontified t) 831 832 (fontified t) 832 848 (face font-lock-variable-name-face fontified t) 848 854 (fontified t) 854 857 (face font-lock-comment-delimiter-face fontified t) 857 894 (face font-lock-comment-face fontified t) 894 895 (fontified t) 895 901 (face font-lock-keyword-face fontified t) 901 902 (fontified t) 902 919 (face font-lock-variable-name-face fontified t) 919 920 (fontified t) 920 929 (face font-lock-builtin-face fontified t) 929 932 (fontified t) 932 935 (face font-lock-comment-delimiter-face fontified t) 935 1012 (face font-lock-comment-face fontified t) 1012 1015 (face font-lock-comment-delimiter-face fontified t) 1015 1028 (face font-lock-comment-face fontified t) 1028 1031 (face font-lock-comment-delimiter-face fontified t) 1031 1108 (face font-lock-comment-face fontified t) 1108 1109 (fontified t) 1109 1114 (face font-lock-keyword-face fontified t) 1114 1115 (fontified t) 1115 1121 (face font-lock-function-name-face fontified t) 1121 1123 (fontified t) 1123 1127 (face font-lock-type-face fontified t) 1127 1152 (fontified t) 1152 1384 (face font-lock-doc-face fontified t) 1384 1460 (fontified t) 1460 1476 (face font-lock-builtin-face fontified t) 1476 1478 (fontified t) 1478 1487 (face font-lock-builtin-face fontified t) 1487 1493 (fontified t) 1493 1498 (face font-lock-keyword-face fontified t) 1498 1500 (fontified t) 1500 1517 (fontified t) 1517 9676 (fontified nil)) . 1) (t 26802 54107 0 0)) nil (26803 28615 29937 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8445 . 8446) (nil fontified nil 8428 . 8446) (8428 . 8446)) nil (26803 28615 29936 0) 0 nil])
([nil nil ((8446 . 8447)) nil (26803 28615 29934 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8560 . 8561) (nil fontified nil 8543 . 8561) (8543 . 8561)) nil (26803 28615 29934 0) 0 nil])
([nil nil ((8561 . 8562)) nil (26803 28615 29933 0) 0 nil])
([nil nil ((#("prepare" 0 6 (fontified t) 6 7 (rear-nonsticky t fontified t)) . -8554) (undo-tree-id30 . -7) (undo-tree-id31 . -3) (undo-tree-id32 . -3) (undo-tree-id33 . -3) (undo-tree-id34 . -3) (undo-tree-id35 . -3) (undo-tree-id36 . -3) (undo-tree-id37 . -7) (undo-tree-id38 . -7) (undo-tree-id39 . -7) (undo-tree-id40 . -7) 8561) nil (26803 28615 29932 0) 0 nil])
([nil nil ((8554 . 8557)) nil (26803 28615 29926 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -8556) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) 8557) nil (26803 28615 29925 0) 0 nil])
([nil nil ((8556 . 8558)) nil (26803 28615 29995 0) 0 nil])
([nil nil ((8558 . 8561)) nil (26803 28654 291365 0) 0 nil] [nil nil ((8543 . 8579) (#("lumen.data.metr" 0 15 (fontified t)) . -8543) (undo-tree-id0 . -15) (undo-tree-id1 . -11) (undo-tree-id2 . -11) (undo-tree-id3 . -11) (undo-tree-id4 . -11) (undo-tree-id5 . -11) (undo-tree-id6 . -11) (undo-tree-id7 . -11) (undo-tree-id8 . -11) (undo-tree-id9 . -11) (undo-tree-id10 . -11) (undo-tree-id11 . -11) (undo-tree-id12 . -11) (undo-tree-id13 . -11) (undo-tree-id14 . -11) (undo-tree-id15 . -11) (undo-tree-id16 . -11) (undo-tree-id17 . -12) (undo-tree-id18 . -12) (undo-tree-id19 . -13) (undo-tree-id20 . -13) (undo-tree-id21 . -13) (undo-tree-id22 . -13) (undo-tree-id23 . -14) (undo-tree-id24 . -14) (undo-tree-id25 . -15) (undo-tree-id26 . -15) 8558) ((8543 . 8558) (#("lumen.data.metrics:record-pool-stats" 0 36 (fontified t)) . 8543) (undo-tree-id41 . -36)) (26803 28615 29919 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8869 . 8870) (nil fontified nil 8852 . 8870) (8852 . 8870)) nil (26803 28654 291365 0) 0 nil])
nil
([nil nil ((8870 . 8871)) nil (26803 28654 291364 0) 0 nil])
([nil nil ((8710 . 8712)) nil (26803 28654 291364 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9938 . 9939) (nil fontified nil 8712 . 9939) (8712 . 9939)) nil (26803 28654 291363 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -9938) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) 9939) nil (26803 28654 585332 0) 0 nil])
([nil nil ((#("get-prepared-plan" 0 17 (fontified t)) . -9301) (undo-tree-id60 . -17) 9318) nil (26803 30583 682064 0) 0 nil] [nil nil ((nil rear-nonsticky nil 10527 . 10528) (nil fontified nil 9301 . 10528) (9301 . 10528)) ((#("(defun query-a (sql &rest params)
  \"Execute a SELECT-like statement, return (values rows-alist count).
Options en fin de params (keywords) :
  :timeout-ms <int>  — timeout Postgres via SET LOCAL statement_timeout (ms).\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (format *error-output*
                      \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                      elapsed-ms sql (if (endp args) nil args)))
            (values rows (length rows))))
      (condition (c)
        (translate-db-error c)))))
" 0 1 (fontified nil) 1 6 (face font-lock-keyword-face fontified nil) 6 7 (fontified nil) 7 14 (face font-lock-function-name-face fontified nil) 14 20 (fontified nil) 20 25 (face font-lock-type-face fontified nil) 25 36 (fontified nil) 36 220 (face font-lock-doc-face fontified nil) 220 224 (fontified nil) 224 228 (face font-lock-keyword-face fontified nil) 228 285 (fontified nil) 285 287 (face font-lock-keyword-face fontified nil) 287 341 (fontified nil) 341 343 (face font-lock-keyword-face fontified nil) 343 408 (fontified nil) 408 419 (face font-lock-builtin-face fontified nil) 419 507 (fontified nil) 507 519 (face font-lock-keyword-face fontified nil) 519 529 (fontified nil) 529 551 (face font-lock-keyword-face fontified nil) 551 576 (fontified nil) 576 580 (face font-lock-keyword-face fontified nil) 580 611 (fontified nil) 611 618 (face font-lock-builtin-face fontified nil) 618 619 (fontified nil) 619 626 (face font-lock-builtin-face fontified nil) 626 900 (fontified nil) 900 904 (face font-lock-keyword-face fontified nil) 904 1018 (fontified nil) 1018 1063 (face font-lock-string-face fontified nil) 1063 1102 (fontified nil) 1102 1104 (face font-lock-keyword-face fontified nil) 1104 1192 (fontified nil) 1192 1226 (fontified nil) 1226 1227 (rear-nonsticky nil fontified nil)) . 9301) (undo-tree-id46 . -269) (undo-tree-id47 . -1227) (undo-tree-id48 . -1227) (undo-tree-id49 . -1227) (nil fontified t 10405 . 10493) (nil fontified t 10403 . 10405) (nil fontified t 10364 . 10403) (nil fontified t 10319 . 10364) (nil fontified t 10205 . 10319) (nil fontified t 10201 . 10205) (nil fontified t 9927 . 10201) (nil fontified t 9920 . 9927) (nil fontified t 9919 . 9920) (nil fontified t 9912 . 9919) (nil fontified t 9881 . 9912) (nil fontified t 9877 . 9881) (nil fontified t 9852 . 9877) (nil fontified t 9830 . 9852) (nil fontified t 9820 . 9830) (nil fontified t 9808 . 9820) (nil fontified t 9720 . 9808) (nil fontified t 9709 . 9720) (nil fontified t 9644 . 9709) (nil fontified t 9642 . 9644) (nil fontified t 9588 . 9642) (nil fontified t 9586 . 9588) (nil fontified t 9529 . 9586) (nil fontified t 9525 . 9529) (nil fontified t 9521 . 9525) (nil fontified t 9337 . 9521) (nil fontified t 9326 . 9337) (nil fontified t 9321 . 9326) (nil fontified t 9315 . 9321) (nil fontified t 9308 . 9315) (nil fontified t 9307 . 9308) (nil fontified t 9302 . 9307) (nil fontified t 9301 . 9302) (nil rear-nonsticky t 10527 . 10528)) (26803 28654 291399 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9336 . 9337) (nil fontified nil 9320 . 9337) (nil fontified nil 9319 . 9320) (nil fontified nil 9318 . 9319) (nil fontified nil 9301 . 9318) (9301 . 9337)) nil (26803 30583 682063 0) 0 nil])
([nil nil ((10528 . 10529)) ((#(":" 0 1 (face font-lock-builtin-face fontified t)) . 10528) (undo-tree-id45 . -1)) (26803 28654 291347 0) 0 nil])
([nil nil ((#("record-query-latency" 0 20 (fontified t)) . -9567) (undo-tree-id59 . -20) 9587) nil (26803 30583 682062 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 9605 . 9606) (nil fontified nil 9586 . 9606) (nil fontified nil 9585 . 9586) (nil fontified nil 9567 . 9585) (9567 . 9606)) nil (26803 30583 682061 0) 0 nil])
([nil nil ((#("
(defun query-a (sql &rest params)
  \"SELECT 0..N → (values rows-alist count), format :alists.\"
  (ensure-connection
    (let ((t0 (get-internal-real-time)))
      (handler-case
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn params)))
            (lumen.data.metrics:record-query-latency sql (%elapsed-ms t0) (length rows))
            (values rows (length rows)))
        (condition (c) (translate-db-error c))))))" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 15 (face font-lock-function-name-face fontified t) 15 21 (fontified t) 21 26 (face font-lock-type-face fontified t) 26 37 (fontified t) 37 95 (face font-lock-doc-face fontified t) 95 122 (fontified t) 122 125 (face font-lock-keyword-face fontified t) 125 165 (fontified t) 165 177 (face font-lock-keyword-face fontified t) 177 178 (fontified t) 178 189 (fontified t) 189 193 (face font-lock-keyword-face fontified t) 193 202 (fontified t) 202 219 (fontified t) 219 220 (rear-nonsticky t fontified t) 220 221 (fontified t) 221 243 (fontified t) 243 250 (face font-lock-builtin-face fontified t) 250 251 (fontified t) 251 258 (face font-lock-builtin-face fontified t) 258 261 (fontified t) 261 304 (fontified t) 304 317 (fontified t) 317 335 (fontified t) 335 336 (fontified t) 336 393 (fontified t) 393 434 (fontified t) 434 484 (fontified t)) . 8226) (undo-tree-id57 . -484) (undo-tree-id58 . -317)) nil (26803 30583 682060 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 8226)) nil (26803 30583 682059 0) 0 nil])
([nil nil ((#("
(defun query-1a (sql &rest params)
  \"SELECT 0/1 → alist | NIL, format :alist.\"
  (ensure-connection
    (handler-case
        (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
               (row (apply fn params)))
          row)
      (condition (c) (translate-db-error c)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 16 (face font-lock-function-name-face fontified t) 16 22 (fontified t) 22 27 (face font-lock-type-face fontified t) 27 38 (fontified t) 38 80 (face font-lock-doc-face fontified t) 80 107 (fontified t) 107 119 (face font-lock-keyword-face fontified t) 119 120 (fontified t) 120 129 (fontified t) 129 133 (face font-lock-keyword-face fontified t) 133 141 (fontified t) 141 158 (fontified t) 158 159 (fontified t rear-nonsticky t) 159 160 (fontified t) 160 182 (fontified t) 182 189 (face font-lock-builtin-face fontified t) 189 190 (fontified t) 190 196 (face font-lock-builtin-face fontified t) 196 199 (fontified t) 199 235 (fontified t) 235 239 (fontified t) 239 301 (fontified t)) . 9492) (undo-tree-id56 . -301)) nil (26803 30583 682058 0) 0 nil])
([nil nil ((9492 . 9493)) nil (26803 30583 682057 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10593 . 10594) (nil fontified nil 9493 . 10594) (9493 . 10594)) nil (26803 30583 682057 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -10593) (undo-tree-id55 . -1) 10594) nil (26803 30583 682056 0) 0 nil])
([nil nil ((11322 . 11324)) nil (26803 30583 682055 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12963 . 12964) (nil fontified nil 11324 . 12964) (11324 . 12964)) nil (26803 30583 682055 0) 0 nil])
([nil nil ((#("(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE.
DML → (values affected returning?).
- sans RETURNING → :raw → entier affecté
- avec RETURNING  → :alist → première ligne\"
  (ensure-connection
    (handler-case
        (let* ((lower (string-downcase sql))
               (has-returning (search \"returning\" lower)))
          (if has-returning
              (let* ((fn  (get-prepared-plan sql :format :alist))
                     (row (apply fn params)))
                (values (if row 1 0) row))
              (let* ((fn       (get-prepared-plan sql :format :raw))
                     (affected (or (apply fn params) 0)))
                (values affected nil))))
      (condition (c) (translate-db-error c)))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 11 (face font-lock-function-name-face fontified t) 11 17 (fontified t) 17 22 (face font-lock-type-face fontified t) 22 33 (fontified t) 33 185 (face font-lock-doc-face fontified t) 185 212 (fontified t) 212 224 (face font-lock-keyword-face fontified t) 224 234 (fontified t) 234 238 (face font-lock-keyword-face fontified t) 238 308 (fontified t) 308 319 (face font-lock-string-face fontified t) 319 340 (fontified t) 340 342 (face font-lock-keyword-face fontified t) 342 372 (fontified t) 372 376 (face font-lock-keyword-face fontified t) 376 406 (fontified t) 406 413 (face font-lock-builtin-face fontified t) 413 414 (fontified t) 414 420 (face font-lock-builtin-face fontified t) 420 494 (fontified t) 494 496 (face font-lock-keyword-face fontified t) 496 527 (fontified t) 527 531 (face font-lock-keyword-face fontified t) 531 566 (fontified t) 566 573 (face font-lock-builtin-face fontified t) 573 574 (fontified t) 574 578 (face font-lock-builtin-face fontified t) 578 599 (fontified t) 599 639 (fontified t) 639 672 (fontified t) 672 680 (fontified t) 680 728 (fontified t)) . -10595) (undo-tree-id54 . -728) 11323) nil (26803 30583 682054 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 10595)) nil (26803 30583 682053 0) 0 nil])
([nil nil ((454 . 455)) nil (26803 30583 682052 0) 0 nil])
([nil nil ((nil fontified nil 472 . 473) (nil fontified nil 455 . 472) (455 . 473)) nil (26803 30583 682052 0) 0 nil])
([nil nil ((#("(format *error-output*
                      \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                      elapsed-ms sql (if (endp args) nil args))" 0 45 (fontified t) 45 90 (face font-lock-string-face fontified t) 90 129 (fontified t) 129 131 (face font-lock-keyword-face fontified t) 131 154 (fontified t)) . -9257) (undo-tree-id53 . -154) 9411) nil (26803 30583 682051 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9346 . 9347) (nil fontified nil 9257 . 9347) (9257 . 9347)) nil (26803 30583 682050 0) 0 nil])
([nil nil ((9295 . 9303) (#("    " 0 4 (fontified t)) . 9295) 8246) nil (26803 30583 682050 0) 0 nil])
([nil nil ((#("(format *error-output*
                      \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                      elapsed-ms sql (if (endp args) nil args))" 0 45 (fontified t) 45 90 (face font-lock-string-face fontified t) 90 129 (fontified t) 129 131 (face font-lock-keyword-face fontified t) 131 154 (fontified t)) . -10323) (undo-tree-id51 . -91) (undo-tree-id52 . -154) 10477) nil (26803 30583 682049 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10411 . 10412) (nil fontified nil 10323 . 10412) (10323 . 10412)) nil (26803 30583 682046 0) 0 nil])
([nil nil ((10361 . 10369) (#("    " 0 4 (fontified t)) . 10361) 9452) nil (26803 30583 682045 0) 0 nil])
([nil nil ((#("(format *error-output*
                        \"~&[SLOW-QUERY ~,1f ms] ~a~@[  params=~s~]~%\"
                        elapsed-ms sql (if (endp args) nil args))" 0 22 (fontified t) 22 23 (fontified t) 23 38 (fontified t) 38 47 (fontified t) 47 92 (face font-lock-string-face fontified t) 92 93 (fontified t) 93 113 (fontified t) 113 133 (fontified t) 133 135 (face font-lock-keyword-face fontified t) 135 144 (fontified t) 144 158 (fontified t)) . -11880) (undo-tree-id50 . -158) 12038) nil (26803 30583 682044 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11968 . 11969) (nil fontified nil 11880 . 11969) (11880 . 11969)) nil (26803 30583 682035 0) 0 nil])
([nil nil ((11918 . 11921) (#("    " 0 4 (fontified t)) . 11918) 10493) nil (26803 30583 682032 0) 0 nil])
([nil nil ((7129 . 7130) (t 26803 30583 0 0)) nil (26803 38323 455220 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7637 . 7638) (nil fontified nil 7627 . 7638) (nil fontified nil 7622 . 7627) (nil fontified nil 7612 . 7622) (nil fontified nil 7575 . 7612) (nil fontified nil 7541 . 7575) (nil fontified nil 7487 . 7541) (nil fontified nil 7431 . 7487) (nil fontified nil 7428 . 7431) (nil fontified nil 7413 . 7428) (nil fontified nil 7386 . 7413) (nil fontified nil 7355 . 7386) (nil fontified nil 7353 . 7355) (nil fontified nil 7347 . 7353) (nil fontified nil 7324 . 7347) (nil fontified nil 7183 . 7324) (nil fontified nil 7174 . 7183) (nil fontified nil 7169 . 7174) (nil fontified nil 7162 . 7169) (nil fontified nil 7140 . 7162) (nil fontified nil 7139 . 7140) (nil fontified nil 7131 . 7139) (nil fontified nil 7130 . 7131) (7130 . 7638)) nil (26803 38323 455218 0) 0 nil])
([nil nil ((619 . 620)) nil (26803 38323 455216 0) 0 nil])
([nil nil ((620 . 621)) nil (26803 38323 455215 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 642 . 643) (nil fontified nil 621 . 643) (621 . 643)) nil (26803 38323 455211 0) 0 nil])
([nil nil ((974 . 976) (t 26803 38323 0 0)) nil (26803 38584 687119 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1197 . 1198) (nil fontified nil 976 . 1198) (976 . 1198)) nil (26803 38584 687115 0) 0 nil])
([nil nil ((642 . 643) (t 26803 38584 0 0)) nil (26803 38614 166247 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -642) (undo-tree-id2 . -1) 643) nil (26803 38614 166246 0) 0 nil])
([nil nil ((643 . 644)) nil (26803 38614 166244 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 673 . 674) (nil fontified nil 644 . 674) (644 . 674)) nil (26803 38614 166244 0) 0 nil])
([nil nil ((644 . 645)) nil (26803 38614 166243 0) 0 nil])
([nil nil ((644 . 648) (#(" " 0 1 (fontified nil)) . 643) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (644 . 645)) nil (26803 38614 166242 0) 0 nil])
([nil nil ((679 . 680)) nil (26803 38614 166226 0) 0 nil])
([nil nil ((680 . 681)) nil (26803 38614 166225 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 695 . 696) (nil fontified nil 681 . 696) (681 . 696)) nil (26803 38614 166221 0) 0 nil])
([nil nil ((2264 . 2271) (t 26803 38614 0 0)) nil (26803 39185 937470 0) 0 nil])
([nil nil ((2271 . 2277)) nil (26803 39185 937469 0) 0 nil])
([nil nil ((2277 . 2278)) nil (26803 39185 937468 0) 0 nil])
([nil nil ((2278 . 2281)) nil (26803 39185 937468 0) 0 nil])
([nil nil ((2281 . 2282)) nil (26803 39185 937466 0) 0 nil])
([nil nil ((2282 . 2290)) nil (26803 39185 937463 0) 0 nil])
([nil nil ((1705 . 1708) (t 26803 39185 0 0)) nil (26803 39277 425307 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1726 . 1727) (nil fontified nil 1726 . 1727) (nil fontified nil 1715 . 1726) (nil fontified nil 1708 . 1715) (1708 . 1727)) nil (26803 39277 425307 0) 0 nil])
([nil nil ((2310 . 2311)) nil (26803 39277 425306 0) 0 nil])
([nil nil ((2311 . 2312)) nil (26803 39277 425305 0) 0 nil])
([nil nil ((2247 . 2255)) nil (26803 39277 425305 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2273 . 2274) (nil fontified nil 2273 . 2274) (nil fontified nil 2262 . 2273) (nil fontified nil 2255 . 2262) (2255 . 2274)) nil (26803 39277 425304 0) 0 nil])
([nil nil ((2272 . 2273)) nil (26803 39277 425303 0) 0 nil])
([nil nil ((2273 . 2274)) nil (26803 39277 425303 0) 0 nil])
([nil nil ((2276 . 2284)) nil (26803 39277 425302 0) 0 nil])
([nil nil ((2284 . 2290)) nil (26803 39277 425302 0) 0 nil])
([nil nil ((2290 . 2291)) nil (26803 39277 425301 0) 0 nil])
([nil nil ((2291 . 2294)) nil (26803 39277 425301 0) 0 nil])
([nil nil ((2294 . 2302)) nil (26803 39277 425300 0) 0 nil])
([nil nil ((2302 . 2308)) nil (26803 39277 425300 0) 0 nil])
([nil nil ((2308 . 2309)) nil (26803 39277 425299 0) 0 nil])
([nil nil ((2309 . 2314)) nil (26803 39277 425295 0) 0 nil])
([nil nil ((1905 . 1906) (t 26803 39277 0 0)) nil (26803 39379 208379 0) 0 nil])
([nil nil ((1906 . 1907)) nil (26803 39379 208378 0) 0 nil])
([nil nil ((1907 . 1913)) nil (26803 39379 208377 0) 0 nil])
([nil nil ((1913 . 1914)) nil (26803 39379 208377 0) 0 nil])
([nil nil ((1914 . 1925)) nil (26803 39379 208376 0) 0 nil])
([nil nil ((1904 . 1905)) nil (26803 39379 208375 0) 0 nil])
([nil nil ((1926 . 1932)) nil (26803 39379 208371 0) 0 nil])
([nil nil ((1832 . 1835) (t 26803 39379 0 0)) nil (26803 39417 937687 0) 0 nil])
([nil nil ((1835 . 1840)) nil (26803 39417 937686 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -1839) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 1840) nil (26803 39417 937686 0) 0 nil])
([nil nil ((1839 . 1841)) nil (26803 39417 937683 0) 0 nil])
([nil nil ((1841 . 1842)) nil (26803 39417 937683 0) 0 nil])
([nil nil ((1842 . 1846)) nil (26803 39417 937682 0) 0 nil])
([nil nil ((1842 . 1858) (#("*cur" 0 4 (fontified t)) . -1842) (undo-tree-id3 . -4) (undo-tree-id4 . -2) (undo-tree-id5 . -2) (undo-tree-id6 . -3) (undo-tree-id7 . -3) (undo-tree-id8 . -4) (undo-tree-id9 . -4) (undo-tree-id10 . -4) (undo-tree-id11 . -4) (undo-tree-id12 . -4) (undo-tree-id13 . -4) 1846) nil (26803 39417 937680 0) 0 nil])
([nil nil ((1858 . 1859)) nil (26803 39417 937656 0) 0 nil])
([nil nil ((1859 . 1862) (t 26803 39417 0 0)) nil (26803 39488 354035 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1885 . 1886) (nil fontified nil 1869 . 1886) (nil fontified nil 1862 . 1869) (1862 . 1886)) nil (26803 39488 354034 0) 0 nil])
([nil nil ((#("*current-config*" 0 16 (fontified t)) . -1869) (undo-tree-id17 . -16) (undo-tree-id18 . -8) (undo-tree-id19 . -8) (undo-tree-id20 . -8) (undo-tree-id21 . -8) (undo-tree-id22 . -8) (undo-tree-id23 . -16) (undo-tree-id24 . -16) (undo-tree-id25 . -16) (undo-tree-id26 . -16) 1885) nil (26803 39488 354032 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1885 . 1886) (nil fontified nil 1869 . 1886) (1869 . 1886)) nil (26803 39488 354014 0) 0 nil])
([nil nil ((1935 . 1937) (t 26803 39488 0 0)) nil (26803 39762 311032 0) 0 nil])
([nil nil ((2848 . 2850)) nil (26803 39762 311031 0) 0 nil])
([nil nil ((2868 . 2870)) nil (26803 39762 311027 0) 0 nil])
([nil nil ((2842 . 2843) (t 26803 39762 0 0)) nil (26803 39816 140790 0) 0 nil])
([nil nil ((2890 . 2891) (t 26803 39816 0 0)) nil (26803 39823 436726 0) 0 nil])
([nil nil ((2842 . 2848)) nil (26803 39823 436722 0) 0 nil])
([nil nil ((#("(x (print \"BSBBSBS\"))
	    " 0 10 (fontified t) 10 19 (face font-lock-string-face fontified t) 19 27 (fontified t)) . -1962) (undo-tree-id31 . -27) 1989 (t 26803 39823 0 0)) nil (26803 39881 874252 0) 0 nil])
([nil nil ((#("
       (print \"IN START! 0\")" 0 1 (fontified t) 1 8 (fontified t) 8 15 (fontified t) 15 16 (face font-lock-string-face fontified t) 16 27 (face font-lock-string-face fontified t) 27 28 (face font-lock-string-face fontified t) 28 29 (fontified t rear-nonsticky t)) . 2304) (undo-tree-id30 . -29)) nil (26803 39881 874251 0) 0 nil])
([nil nil ((#("
	     (print \"IN START! 1\")" 0 1 (fontified t) 1 14 (fontified t) 14 15 (face font-lock-string-face fontified t) 15 26 (face font-lock-string-face fontified t) 26 27 (face font-lock-string-face fontified t) 27 28 (fontified t)) . 2381) (undo-tree-id29 . -28)) nil (26803 39881 874249 0) 0 nil])
([nil nil ((#("
  (print *current-config*)
  (print *connection-mode*)" 0 1 (fontified t) 1 10 (fontified t) 10 28 (fontified t) 28 30 (fontified t) 30 37 (fontified t) 37 53 (fontified t) 53 54 (rear-nonsticky t fontified t) 54 55 (rear-nonsticky t fontified t)) . 1832) (undo-tree-id28 . -55)) nil (26803 39881 874247 0) 0 nil])
([nil nil ((#("
  (print \"IN START!\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 21 (face font-lock-string-face fontified t) 21 22 (rear-nonsticky t fontified t)) . 1705) (undo-tree-id27 . -22)) nil (26803 39881 874243 0) 0 nil])
([nil nil ((6746 . 6750) (t 26803 39881 0 0)) nil (26803 41445 696713 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -1858) (undo-tree-id77 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -1859) (undo-tree-id78 . -1) 1860 (t 26803 41445 0 0)) nil (26803 42151 196747 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -2692) (undo-tree-id75 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -2693) (undo-tree-id76 . -1) 2694) nil (26803 42151 196745 0) 0 nil])
([nil nil ((#(";" 0 1 (face slime-reader-conditional-face fontified t)) . -2710) (undo-tree-id73 . -1) (#(";" 0 1 (face slime-reader-conditional-face fontified t)) . -2711) (undo-tree-id74 . -1) 2712) nil (26803 42151 196743 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -2685) (undo-tree-id72 . -1) 2686) nil (26803 42151 196742 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 2679) (#("
" 0 1 (fontified t)) . 2679)) nil (26803 42151 196740 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . 2679)) nil (26803 42151 196739 0) 0 nil])
([nil nil ((2683 . 2685) (2679 . 2680)) nil (26803 42151 196739 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 2679)) nil (26803 42151 196738 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -2727) (undo-tree-id71 . -1) 2728) nil (26803 42151 196738 0) 0 nil])
([nil nil ((#("     " 0 5 (fontified t)) . -2679) (undo-tree-id70 . -5) 2684) nil (26803 42151 196736 0) 0 nil])
([nil nil ((728 . 729)) nil (26803 42151 196735 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1361 . 1362) (nil fontified nil 729 . 1362) (729 . 1362)) nil (26803 42151 196735 0) 0 nil])
([nil nil ((1362 . 1363)) nil (26803 42151 196734 0) 0 nil])
([nil nil ((6061 . 6063)) nil (26803 42151 196734 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9598 . 9599) (nil fontified nil 6063 . 9599) (6063 . 9599)) nil (26803 42151 196733 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -9598) (undo-tree-id69 . -1) 9599) nil (26803 42151 196732 0) 0 nil])
([nil nil ((9598 . 9599)) nil (26803 42151 196731 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -9598) (undo-tree-id68 . -1) 9599) nil (26803 42151 196730 0) 0 nil])
([nil nil ((#("(defmacro with-conn (&body body)
  \"Ouvre une connexion selon *connection-mode* avec les bons paramètres Postmodern.\"
  #+postmodern
  `(ecase *connection-mode*
     (:toplevel
      (progn ,@body))
     (:scoped
      (let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
          ,@body)))
     (:pooled-native
      (let ((deadline (+ (get-internal-real-time)
                    (* cl:internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
       (start (get-internal-real-time)))
   (labels ((acquire-slot ()
              (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                  (if (< (get-internal-real-time) deadline)
                      (acquire-slot)
                      (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
     (acquire-slot)
     (let* ((wait-ms (* 1000.0 (/ (- (get-internal-real-time) start)
                                  cl:internal-time-units-per-second))))
       ;; enregistre métrique (nb slots utilisés = *pool-size* - count du sema)
       (let ((in-use (- *pool-size* (bt:semaphore-count *pool-sema*))))
         (lumen.data.metrics:record-pool-stats in-use wait-ms)))
     (unwind-protect
          (let* ((cfg *current-config*)
                 (db   (getf cfg :database))
                 (user (getf cfg :user))
                 (pass (getf cfg :password))
                 (host (or (getf cfg :host) \"localhost\"))
                 (port (or (getf cfg :port) 5432))
                 (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
            (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl)
              ,@body))
       (bt:signal-semaphore *pool-sema*))))))
  #-postmodern
  `(progn ,@body))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 13 (face font-lock-function-name-face fontified t) 13 19 (face font-lock-function-name-face fontified t) 19 21 (fontified t) 21 26 (face font-lock-type-face fontified t) 26 33 (fontified t) 33 35 (fontified t) 35 36 (face font-lock-doc-face fontified t) 36 39 (face font-lock-doc-face fontified t) 39 44 (face font-lock-doc-face fontified t) 44 48 (face font-lock-doc-face fontified t) 48 116 (face font-lock-doc-face fontified t) 116 117 (face font-lock-doc-face fontified t) 117 118 (fontified t) 118 120 (fontified t) 120 125 (fontified t) 125 137 (fontified t) 137 142 (face font-lock-keyword-face fontified t) 142 167 (fontified t) 167 170 (face font-lock-builtin-face fontified t) 170 176 (face font-lock-builtin-face fontified t) 176 180 (fontified t) 180 184 (fontified t) 184 189 (face font-lock-keyword-face fontified t) 189 199 (fontified t) 199 205 (fontified t) 205 212 (face font-lock-builtin-face fontified t) 212 220 (fontified t) 220 224 (face font-lock-keyword-face fontified t) 224 278 (fontified t) 278 287 (face font-lock-builtin-face fontified t) 287 319 (fontified t) 319 324 (face font-lock-builtin-face fontified t) 324 356 (fontified t) 356 365 (face font-lock-builtin-face fontified t) 365 401 (fontified t) 401 406 (face font-lock-builtin-face fontified t) 406 408 (fontified t) 408 409 (face font-lock-string-face fontified t) 409 418 (face font-lock-string-face fontified t) 418 419 (face font-lock-string-face fontified t) 419 455 (fontified t) 455 460 (face font-lock-builtin-face fontified t) 460 490 (fontified t) 490 502 (fontified t) 502 519 (face font-lock-builtin-face fontified t) 519 521 (fontified t) 521 522 (face font-lock-string-face fontified t) 522 523 (face font-lock-string-face fontified t) 523 539 (fontified t) 539 541 (fontified t) 541 565 (fontified t) 565 577 (fontified t) 577 585 (face font-lock-builtin-face fontified t) 585 590 (fontified t) 590 597 (fontified t) 597 599 (fontified t) 599 625 (face font-lock-keyword-face fontified t) 625 692 (fontified t) 692 697 (face font-lock-builtin-face fontified t) 697 703 (fontified t) 703 711 (face font-lock-builtin-face fontified t) 711 762 (fontified t) 762 779 (face font-lock-builtin-face fontified t) 779 811 (fontified t) 811 825 (face font-lock-builtin-face fontified t) 825 833 (fontified t) 833 836 (face font-lock-keyword-face fontified t) 836 989 (fontified t) 989 996 (fontified t) 996 997 (fontified t) 997 1000 (fontified t) 1000 1001 (fontified t) 1001 1011 (fontified t) 1011 1015 (fontified t) 1015 1019 (face font-lock-keyword-face fontified t) 1019 1021 (face font-lock-keyword-face fontified t) 1021 1040 (fontified t) 1040 1044 (fontified t) 1044 1077 (fontified t) 1077 1092 (fontified t) 1092 1100 (face font-lock-builtin-face fontified t) 1100 1128 (fontified t) 1128 1147 (fontified t) 1147 1149 (face font-lock-keyword-face fontified t) 1149 1248 (fontified t) 1248 1253 (face font-lock-warning-face fontified t) 1253 1254 (fontified t) 1254 1255 (face font-lock-string-face fontified t) 1255 1283 (face font-lock-string-face fontified t) 1283 1284 (face font-lock-string-face fontified t) 1284 1331 (fontified t) 1331 1335 (face font-lock-keyword-face fontified t) 1335 1473 (fontified t) 1473 1476 (face font-lock-comment-delimiter-face fontified t) 1476 1533 (face font-lock-comment-face fontified t) 1533 1546 (face font-lock-comment-face fontified t) 1546 1554 (fontified t) 1554 1557 (face font-lock-keyword-face fontified t) 1557 1689 (fontified t) 1689 1703 (face font-lock-keyword-face fontified t) 1703 1715 (fontified t) 1715 1719 (face font-lock-keyword-face fontified t) 1719 1777 (fontified t) 1777 1786 (face font-lock-builtin-face fontified t) 1786 1822 (fontified t) 1822 1827 (face font-lock-builtin-face fontified t) 1827 1863 (fontified t) 1863 1872 (face font-lock-builtin-face fontified t) 1872 1912 (fontified t) 1912 1917 (face font-lock-builtin-face fontified t) 1917 1919 (fontified t) 1919 1920 (face font-lock-string-face fontified t) 1920 1929 (face font-lock-string-face fontified t) 1929 1930 (face font-lock-string-face fontified t) 1930 1970 (fontified t) 1970 1975 (face font-lock-builtin-face fontified t) 1975 2039 (fontified t) 2039 2047 (face font-lock-builtin-face fontified t) 2047 2065 (fontified t) 2065 2090 (face font-lock-keyword-face fontified t) 2090 2091 (face font-lock-keyword-face fontified t) 2091 2116 (fontified t) 2116 2121 (face font-lock-builtin-face fontified t) 2121 2127 (fontified t) 2127 2135 (face font-lock-builtin-face fontified t) 2135 2145 (fontified t) 2145 2213 (fontified t) 2213 2214 (fontified t) 2214 2216 (fontified t) 2216 2229 (face slime-reader-conditional-face fontified t) 2229 2233 (face slime-reader-conditional-face fontified t) 2233 2238 (face slime-reader-conditional-face fontified t) 2238 2246 (face slime-reader-conditional-face fontified t) 2246 2247 (fontified t)) . 3814) (undo-tree-id33 . -2247) (undo-tree-id34 . -290) (undo-tree-id35 . -1668) (undo-tree-id36 . -1668) (undo-tree-id37 . -1325) (undo-tree-id38 . -1223) (undo-tree-id39 . -2196) (undo-tree-id40 . -2247) (undo-tree-id41 . -2247) (undo-tree-id42 . -2247) (undo-tree-id43 . -1162) (undo-tree-id44 . -1162) (undo-tree-id45 . -1162) (undo-tree-id46 . -1162) (undo-tree-id47 . -1162) (undo-tree-id48 . -1162) (undo-tree-id49 . -1162) (undo-tree-id50 . -1162) (undo-tree-id51 . -1162) (undo-tree-id52 . -1162) (undo-tree-id53 . -1162) (undo-tree-id54 . -1162) (undo-tree-id55 . -1162) (undo-tree-id56 . -1074) (undo-tree-id57 . -1074) (undo-tree-id58 . -1039) (undo-tree-id59 . -1039) (undo-tree-id60 . -32) (undo-tree-id61 . -32) (undo-tree-id62 . -32) (undo-tree-id63 . -32) (undo-tree-id64 . -31) (undo-tree-id65 . -31) (undo-tree-id66 . -30) (undo-tree-id67 . -30)) nil (26803 42151 196727 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 3814) (undo-tree-id32 . -1) (#("
" 0 1 (fontified t)) . 3814)) nil (26803 42151 196701 0) 0 nil])
([nil nil ((#("
       (print db)
       (print port)" 0 1 (fontified t) 1 4 (fontified t) 4 19 (fontified t) 19 38 (fontified t)) . 2860) (undo-tree-id79 . -38) (t 26803 42151 0 0)) nil (26803 42711 326168 0) 0 nil])
([nil nil ((9866 . 9868) (t 26803 42711 0 0)) nil (26803 43158 797594 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10541 . 10542) (nil fontified nil 9868 . 10542) (9868 . 10542)) nil (26803 43158 797593 0) 0 nil])
([nil nil ((9357 . 9358)) nil (26803 43158 797592 0) 0 nil])
([nil nil ((9358 . 9360)) nil (26803 43158 797592 0) 0 nil])
([nil nil ((9870 . 9872)) nil (26803 43158 797591 0) 0 nil])
([nil nil ((9872 . 9873)) nil (26803 43158 797587 0) 0 nil])
([nil nil ((15481 . 15483) (t 26803 43158 0 0)) nil (26804 17239 535587 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17290 . 17291) (nil fontified nil 15483 . 17291) (15483 . 17291)) nil (26804 17239 965783 0) 0 nil])
([nil nil ((#("
(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
Options :
  :timeout-ms <int>
Si le SQL a une clause RETURNING, renvoie la 1ère ligne en alist.\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                (let* ((fn       (get-prepared-plan sql :format :raw))
                       (n (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
		 sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      (condition (c)
        (translate-db-error c)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 34 (fontified t) 34 199 (face font-lock-doc-face fontified t) 199 203 (fontified t) 203 207 (face font-lock-keyword-face fontified t) 207 264 (fontified t) 264 266 (face font-lock-keyword-face fontified t) 266 320 (fontified t) 320 322 (face font-lock-keyword-face fontified t) 322 387 (fontified t) 387 398 (face font-lock-builtin-face fontified t) 398 486 (fontified t) 486 498 (face font-lock-keyword-face fontified t) 498 508 (fontified t) 508 530 (face font-lock-keyword-face fontified t) 530 555 (fontified t) 555 559 (face font-lock-keyword-face fontified t) 559 631 (fontified t) 631 642 (face font-lock-string-face fontified t) 642 695 (fontified t) 695 697 (face font-lock-keyword-face fontified t) 697 729 (fontified t) 729 733 (face font-lock-keyword-face fontified t) 733 763 (fontified t) 763 770 (face font-lock-builtin-face fontified t) 770 771 (fontified t) 771 777 (face font-lock-builtin-face fontified t) 777 860 (fontified t) 860 862 (face font-lock-keyword-face fontified t) 862 923 (fontified t) 923 927 (face font-lock-keyword-face fontified t) 927 962 (fontified t) 962 969 (face font-lock-builtin-face fontified t) 969 970 (fontified t) 970 974 (face font-lock-builtin-face fontified t) 974 1087 (fontified t) 1087 1090 (face font-lock-keyword-face fontified t) 1090 1245 (fontified t) 1245 1298 (fontified t) 1298 1313 (fontified t) 1313 1317 (face font-lock-keyword-face fontified t) 1317 1444 (fontified t) 1444 1451 (face font-lock-builtin-face fontified t) 1451 1457 (fontified t) 1457 1466 (face font-lock-builtin-face fontified t) 1466 1500 (fontified t) 1500 1512 (fontified t) 1512 1515 (fontified t) 1515 1536 (fontified t) 1536 1570 (fontified t) 1570 1571 (fontified t)) . 13911) (undo-tree-id113 . -1571) (undo-tree-id114 . -814) (undo-tree-id115 . -814)) nil (26804 17666 979222 0) 0 nil] [nil nil ((#("
(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
Options :
  :timeout-ms <int>
Si le SQL a une clause RETURNING, renvoie la 1ère ligne en alist.\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                (let* ((fn       (get-prepared-plan sql :format :raw))
                       (n (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
		 sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      (condition (c)
        (translate-db-error c)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 34 (fontified t) 34 199 (face font-lock-doc-face fontified t) 199 203 (fontified t) 203 207 (face font-lock-keyword-face fontified t) 207 264 (fontified t) 264 266 (face font-lock-keyword-face fontified t) 266 320 (fontified t) 320 322 (face font-lock-keyword-face fontified t) 322 387 (fontified t) 387 398 (face font-lock-builtin-face fontified t) 398 486 (fontified t) 486 498 (face font-lock-keyword-face fontified t) 498 508 (fontified t) 508 530 (face font-lock-keyword-face fontified t) 530 555 (fontified t) 555 559 (face font-lock-keyword-face fontified t) 559 631 (fontified t) 631 642 (face font-lock-string-face fontified t) 642 695 (fontified t) 695 697 (face font-lock-keyword-face fontified t) 697 729 (fontified t) 729 733 (face font-lock-keyword-face fontified t) 733 763 (fontified t) 763 770 (face font-lock-builtin-face fontified t) 770 771 (fontified t) 771 777 (face font-lock-builtin-face fontified t) 777 860 (fontified t) 860 862 (face font-lock-keyword-face fontified t) 862 923 (fontified t) 923 927 (face font-lock-keyword-face fontified t) 927 962 (fontified t) 962 969 (face font-lock-builtin-face fontified t) 969 970 (fontified t) 970 974 (face font-lock-builtin-face fontified t) 974 1087 (fontified t) 1087 1090 (face font-lock-keyword-face fontified t) 1090 1245 (fontified t) 1245 1298 (fontified t) 1298 1313 (fontified t) 1313 1317 (face font-lock-keyword-face fontified t) 1317 1444 (fontified t) 1444 1451 (face font-lock-builtin-face fontified t) 1451 1457 (fontified t) 1457 1466 (face font-lock-builtin-face fontified t) 1466 1512 (fontified t) 1512 1515 (fontified t) 1515 1536 (fontified t) 1536 1570 (fontified t)) . 13911) (undo-tree-id85 . -1570) (undo-tree-id86 . -814) (undo-tree-id87 . -814) (undo-tree-id88 . -814) (undo-tree-id89 . -814) (undo-tree-id90 . -814) (undo-tree-id91 . -814) (undo-tree-id92 . -814) (undo-tree-id93 . -814) (undo-tree-id94 . -814) (undo-tree-id95 . -1570) (undo-tree-id96 . -1570) (undo-tree-id97 . -1570) (undo-tree-id98 . -1570) (undo-tree-id99 . -1570) (undo-tree-id100 . -1) (undo-tree-id101 . -1536) (undo-tree-id102 . -1) (undo-tree-id103 . -1570) (undo-tree-id104 . -1570) (undo-tree-id105 . -1570) (undo-tree-id106 . -1570) (undo-tree-id107 . -31) (undo-tree-id108 . -31) (undo-tree-id109 . -31) (undo-tree-id110 . -31) (undo-tree-id111 . -31) (undo-tree-id112 . -31)) ((13911 . 15481)) (26804 17239 535639 0) 0 nil])
([nil nil ((12993 . 12996) (t 26804 17666 0 0)) nil (26804 36364 865778 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 13911) (undo-tree-id80 . 1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1)) ((13911 . 13912)) (26804 17239 535564 0) 0 nil])
([nil nil ((12996 . 13002)) nil (26804 36364 865777 0) 0 nil])
nil
([nil nil ((13002 . 13003)) nil (26804 36364 865777 0) 0 nil])
([nil nil ((13003 . 13006)) nil (26804 36364 865776 0) 0 nil])
([nil nil ((13006 . 13007)) nil (26804 36364 865776 0) 0 nil])
([nil nil ((13007 . 13012)) nil (26804 36364 865775 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -13011) (undo-tree-id118 . -1) 13012) nil (26804 36364 865774 0) 0 nil])
([nil nil ((13011 . 13012)) nil (26804 36364 865772 0) 0 nil])
([nil nil ((13012 . 13013)) nil (26804 36364 865772 0) 0 nil])
([nil nil ((13013 . 13016)) nil (26804 36364 865771 0) 0 nil])
([nil nil ((#(")" 0 1 (face font-lock-string-face fontified t)) . -13015) (undo-tree-id116 . -1) (undo-tree-id117 . -1) 13016) nil (26804 36364 865769 0) 0 nil])
([nil nil ((13015 . 13017)) nil (26804 36364 865756 0) 0 nil])
([nil nil ((13298 . 13303) (t 26804 36364 0 0)) nil (26804 36385 457598 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13323 . 13324) (nil fontified nil 13323 . 13324) (nil fontified nil 13310 . 13323) (nil fontified nil 13303 . 13310) (13303 . 13324)) nil (26804 36385 457597 0) 0 nil])
([nil nil ((13322 . 13323)) nil (26804 36385 457596 0) 0 nil])
([nil nil ((13323 . 13326)) nil (26804 36385 457592 0) 0 nil])
([nil nil ((13646 . 13652) (t 26804 36385 0 0)) nil (26804 36525 572167 0) 0 nil])
([nil nil ((nil fontified nil 13676 . 13677) (nil fontified nil 13659 . 13676) (nil fontified nil 13652 . 13659) (13652 . 13677)) nil (26804 36525 572166 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13674) (undo-tree-id119 . -1) 13675) nil (26804 36525 572165 0) 0 nil])
([nil nil ((13674 . 13675)) nil (26804 36525 572153 0) 0 nil])
([nil nil ((13740 . 13746) (t 26804 36525 0 0)) nil (26804 36539 263103 0) 0 nil])
([nil nil ((nil fontified nil 13770 . 13771) (nil fontified nil 13753 . 13770) (nil fontified nil 13746 . 13753) (13746 . 13771)) nil (26804 36539 263102 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13768) (undo-tree-id121 . -1) 13769) nil (26804 36539 263101 0) 0 nil])
([nil nil ((13768 . 13769)) nil (26804 36539 263099 0) 0 nil])
([nil nil ((13952 . 13958)) nil (26804 36539 263098 0) 0 nil])
([nil nil ((nil fontified nil 13982 . 13983) (nil fontified nil 13965 . 13982) (nil fontified nil 13958 . 13965) (13958 . 13983)) nil (26804 36539 263098 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -13980) (undo-tree-id120 . -1) 13981) nil (26804 36539 263096 0) 0 nil])
([nil nil ((13980 . 13981)) nil (26804 36539 263082 0) 0 nil])
([nil nil ((13453 . 13457) (t 26804 36539 0 0)) nil (26804 36581 602232 0) 0 nil])
([nil nil ((13457 . 13458)) nil (26804 36581 602231 0) 0 nil])
([nil nil ((13458 . 13459)) nil (26804 36581 602231 0) 0 nil])
([nil nil ((13459 . 13460)) nil (26804 36581 602230 0) 0 nil])
([nil nil ((13460 . 13466)) nil (26804 36581 602230 0) 0 nil])
([nil nil ((13466 . 13467)) nil (26804 36581 602229 0) 0 nil])
([nil nil ((13467 . 13472)) nil (26804 36581 602229 0) 0 nil])
([nil nil ((13511 . 13515)) nil (26804 36581 602228 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 13529 . 13530) (nil fontified nil 13528 . 13530) (nil fontified nil 13525 . 13528) (nil fontified nil 13515 . 13525) (13515 . 13530)) nil (26804 36581 602227 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . 13526)) nil (26804 36581 602225 0) 0 nil])
([nil nil ((13526 . 13527)) nil (26804 36581 602221 0) 0 nil])
([nil nil ((#("
	    (print \"IN QUERY 1A 002\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . -13778) (undo-tree-id146 . -31) 13809 (t 26804 36581 0 0)) nil (26804 40144 624794 0) 0 nil])
([nil nil ((#("
	    (print \"IN QUERY 1A 001\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . 13684) (undo-tree-id145 . -31)) nil (26804 40144 624792 0) 0 nil])
([nil nil ((#("
	    (print \"IN QUERY 1A 003\")" 0 1 (fontified t) 1 6 (fontified t) 6 13 (fontified t) 13 30 (face font-lock-string-face fontified t) 30 31 (fontified t rear-nonsticky t)) . 13928) (undo-tree-id144 . -31)) nil (26804 40144 624790 0) 0 nil])
([nil nil ((#("
		 (x (print \"1\"))" 0 1 (fontified t) 1 4 (fontified t) 4 14 (fontified t) 14 17 (face font-lock-string-face fontified t) 17 18 (fontified t) 18 19 (rear-nonsticky t fontified t)) . 13511) (undo-tree-id140 . -19) (undo-tree-id141 . -4) (undo-tree-id142 . -19) (undo-tree-id143 . -19)) nil (26804 40144 624788 0) 0 nil])
([nil nil ((#("
		 (x (print \"0\"))" 0 1 (fontified t) 1 14 (fontified t) 14 17 (face font-lock-string-face fontified t) 17 19 (fontified t)) . 13453) (undo-tree-id134 . -19) (undo-tree-id135 . -4) (undo-tree-id136 . -19) (undo-tree-id137 . -19) (undo-tree-id138 . -19) (undo-tree-id139 . -19)) nil (26804 40144 624782 0) 0 nil])
([nil nil ((#("
    (print \"IN QUERY 1A 000\")" 0 1 (fontified t) 1 5 (fontified t) 5 12 (fontified t) 12 29 (face font-lock-string-face fontified t) 29 30 (rear-nonsticky t fontified t)) . 13298) (undo-tree-id128 . -30) (undo-tree-id129 . -5) (undo-tree-id130 . -30) (undo-tree-id131 . -30) (undo-tree-id132 . -30) (undo-tree-id133 . -30)) nil (26804 40144 624773 0) 0 nil])
([nil nil ((#("
  (print \"IN QUERY 1A\")" 0 1 (fontified t) 1 10 (fontified t) 10 23 (face font-lock-string-face fontified t) 23 24 (fontified t)) . 12993) (undo-tree-id122 . -24) (undo-tree-id123 . -3) (undo-tree-id124 . -24) (undo-tree-id125 . -24) (undo-tree-id126 . -24) (undo-tree-id127 . -24)) nil (26804 40144 624762 0) 0 nil])
([nil nil ((3584 . 3586) (t 26804 40144 0 0)) nil (26805 50677 424803 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5085 . 5086) (nil fontified nil 3586 . 5086) (3586 . 5086)) nil (26805 50677 424802 0) 0 nil])
([nil nil ((#("Initialise *current-config* et, pour :toplevel uniquement, la connexion globale." 0 80 (face font-lock-doc-face fontified t)) . -3649) (undo-tree-id161 . -80) 3729) nil (26805 50677 424802 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3878 . 3879) (nil fontified nil 3828 . 3879) (nil fontified nil 3649 . 3828) (3649 . 3879)) nil (26805 50677 424801 0) 0 nil])
([nil nil ((#("
(defun start! (&key (config (db-config)))
  \"Initialise selon :connection-mode.
:toplevel → connect-toplevel
:scoped   → rien (ouverture par bloc)
:pooled-native → rien ici (piscine Postmodern via :pooled-p dans with-conn).
Tu peux régler postmodern:*max-pool-size* en amont.\"
  (setf *current-config* config
        *connection-mode* (or (getf config :connection-mode) :toplevel))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    (:scoped (setf *started* t))
    (:pooled-native (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (fontified t) 16 20 (face font-lock-type-face fontified t) 20 45 (fontified t) 45 225 (face font-lock-doc-face fontified t) 225 277 (face font-lock-doc-face fontified t) 277 278 (fontified t) 278 310 (fontified t) 310 350 (fontified t) 350 353 (fontified t) 353 369 (face font-lock-builtin-face fontified t) 369 371 (fontified t) 371 380 (face font-lock-builtin-face fontified t) 380 382 (fontified t) 382 383 (fontified t) 383 386 (fontified t) 386 391 (face font-lock-keyword-face fontified t) 391 415 (fontified t) 415 424 (face font-lock-builtin-face fontified t) 424 425 (fontified t) 425 430 (fontified t) 430 443 (fontified t) 443 449 (fontified t) 449 453 (face font-lock-keyword-face fontified t) 453 455 (fontified t) 455 474 (fontified t) 474 483 (face font-lock-builtin-face fontified t) 483 486 (fontified t) 486 517 (fontified t) 517 522 (face font-lock-builtin-face fontified t) 522 556 (fontified t) 556 565 (face font-lock-builtin-face fontified t) 565 603 (fontified t) 603 608 (face font-lock-builtin-face fontified t) 608 610 (fontified t) 610 611 (face font-lock-string-face fontified t) 611 620 (face font-lock-string-face fontified t) 620 621 (face font-lock-string-face fontified t) 621 659 (fontified t) 659 664 (face font-lock-builtin-face fontified t) 664 708 (fontified t) 708 725 (face font-lock-builtin-face fontified t) 725 727 (fontified t) 727 728 (face font-lock-string-face fontified t) 728 729 (face font-lock-string-face fontified t) 729 732 (fontified t) 732 771 (fontified t) 771 785 (fontified t) 785 793 (face font-lock-builtin-face fontified t) 793 797 (fontified t) 797 798 (fontified t) 798 806 (fontified t) 806 818 (face font-lock-keyword-face fontified t) 818 819 (fontified t) 819 831 (fontified t) 831 836 (face font-lock-keyword-face fontified t) 836 837 (fontified t) 837 985 (fontified t) 985 990 (face font-lock-builtin-face fontified t) 990 996 (fontified t) 996 1004 (face font-lock-builtin-face fontified t) 1004 1055 (fontified t) 1055 1072 (face font-lock-builtin-face fontified t) 1072 1167 (fontified t) 1167 1179 (fontified t) 1179 1184 (face font-lock-warning-face fontified t) 1184 1185 (fontified t) 1185 1186 (face font-lock-string-face fontified t) 1186 1206 (face font-lock-string-face fontified t) 1206 1207 (face font-lock-string-face fontified t) 1207 1213 (fontified t) 1213 1214 (fontified t) 1214 1219 (fontified t) 1219 1232 (face slime-reader-conditional-face fontified t) 1232 1237 (face slime-reader-conditional-face fontified t) 1237 1255 (face slime-reader-conditional-face fontified t) 1255 1256 (fontified t) 1256 1257 (fontified t) 1257 1262 (fontified t) 1262 1269 (face font-lock-builtin-face fontified t) 1269 1289 (fontified t) 1289 1290 (fontified t) 1290 1295 (fontified t) 1295 1309 (face font-lock-builtin-face fontified t) 1309 1324 (fontified t) 1324 1331 (fontified t) 1331 1345 (fontified t) 1345 1346 (fontified t) 1346 1351 (face font-lock-keyword-face fontified t) 1351 1352 (fontified t) 1352 1357 (face font-lock-function-name-face fontified t) 1357 1364 (fontified t) 1364 1368 (face font-lock-keyword-face fontified t) 1368 1384 (fontified t) 1384 1388 (face font-lock-keyword-face fontified t) 1388 1411 (fontified t) 1411 1420 (face font-lock-builtin-face fontified t) 1420 1428 (fontified t) 1428 1442 (fontified t) 1442 1455 (face font-lock-keyword-face fontified t) 1455 1489 (fontified t) 1489 1517 (fontified t) 1517 1522 (fontified t)) . 2063) (undo-tree-id158 . -1522) (undo-tree-id159 . -1110) (undo-tree-id160 . -1110)) nil (26805 50677 424800 0) 0 nil])
([nil nil ((3905 . 3906)) nil (26805 50677 424798 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 8135 . 8136) (nil fontified nil 3906 . 8136) (3906 . 8136)) nil (26805 50677 424797 0) 0 nil])
([nil nil ((8136 . 8138)) nil (26805 50677 424796 0) 0 nil])
([nil nil ((8138 . 8140)) nil (26805 50677 424796 0) 0 nil])
([nil nil ((11677 . 11679)) nil (26805 50677 424796 0) 0 nil])
([nil nil ((11679 . 11680)) nil (26805 50677 424795 0) 0 nil])
([nil nil ((#("or (getf config :connection-mode)" 0 16 (fontified t) 16 32 (face font-lock-builtin-face fontified t) 32 33 (fontified t)) . -2418) (undo-tree-id157 . -33) 2451) nil (26805 50677 424795 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2443 . 2444) (nil fontified nil 2443 . 2444) (nil fontified nil 2435 . 2443) (nil fontified nil 2434 . 2435) (nil fontified nil 2418 . 2434) (2418 . 2444)) nil (26805 50677 424793 0) 0 nil])
([nil nil ((#(" " 0 1 (rear-nonsticky t fontified t)) . -2443) (undo-tree-id156 . -1) 2444) nil (26805 50677 424792 0) 0 nil])
([nil nil ((2443 . 2444)) nil (26805 50677 424791 0) 0 nil])
([nil nil ((2444 . 2452)) nil (26805 50677 424791 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -2451) (undo-tree-id155 . -1) 2452) nil (26805 50677 424790 0) 0 nil])
([nil nil ((2451 . 2456)) nil (26805 50677 424789 0) 0 nil])
([nil nil ((#("X" 0 1 (face font-lock-string-face fontified t)) . -2450) (undo-tree-id149 . -1) (#("C" 0 1 (face font-lock-string-face fontified t)) . -2451) (undo-tree-id150 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -2452) (undo-tree-id151 . -1) (#("I" 0 1 (face font-lock-string-face fontified t)) . -2453) (undo-tree-id152 . -1) (#("O" 0 1 (face font-lock-string-face fontified t)) . -2454) (undo-tree-id153 . -1) (#("N" 0 1 (face font-lock-string-face fontified t)) . -2455) (undo-tree-id154 . -1) 2456) nil (26805 50677 424788 0) 0 nil])
([nil nil ((2450 . 2461)) nil (26805 50677 424783 0) 0 nil])
([nil nil ((2461 . 2462)) nil (26805 50677 424783 0) 0 nil])
([nil nil ((#("v" 0 1 (fontified t)) . -2461) (undo-tree-id148 . -1) 2462) nil (26805 50677 424782 0) 0 nil])
([nil nil ((2461 . 2462)) nil (26805 50677 424780 0) 0 nil])
([nil nil ((2462 . 2467)) nil (26805 50677 424780 0) 0 nil])
([nil nil ((#("u" 0 1 (face font-lock-builtin-face fontified t)) . -2466) (undo-tree-id147 . -1) 2467) nil (26805 50677 424779 0) 0 nil])
([nil nil ((2466 . 2470)) nil (26805 50677 424870 0) 0 nil])
([nil nil ((2462 . 2473) (#(" " 0 1 (fontified nil)) . 2462) (undo-tree-id171 . -1) (2461 . 2462)) nil (26805 52061 374373 0) 0 nil] [nil nil ((2471 . 2482) (#(" " 0 1 (fontified nil)) . 2471) (2470 . 2471)) ((#("
" 0 1 (fontified t)) . 2470) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (2471 . 2472) (#("						     " 0 11 (fontified t)) . 2471) (undo-tree-id164 . -11)) (26805 50677 424764 0) 0 nil])
([nil nil ((2445 . 2448)) nil (26805 52061 374372 0) 0 nil])
nil
([nil nil ((1150 . 1152)) nil (26805 52061 374372 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1227 . 1228) (nil fontified nil 1152 . 1228) (1152 . 1228)) nil (26805 52061 374371 0) 0 nil])
([nil nil ((1440 . 1442)) nil (26805 52061 374371 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1925 . 1926) (nil fontified nil 1442 . 1926) (1442 . 1926)) nil (26805 52061 374370 0) 0 nil])
([nil nil ((#(" &key config" 0 1 (fontified t) 1 5 (face font-lock-type-face fontified t) 5 12 (fontified t)) . -4531) (undo-tree-id170 . -12) 4543) nil (26805 52061 374369 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4573 . 4574) (nil fontified nil 4535 . 4574) (nil fontified nil 4531 . 4535) (4531 . 4574)) nil (26805 52061 374368 0) 0 nil])
([nil nil ((4536 . 4540)) nil (26805 52061 374368 0) 0 nil])
([nil nil ((4540 . 4541)) nil (26805 52061 374367 0) 0 nil])
([nil nil ((#("&key" 0 4 (fontified t)) . -4531) (undo-tree-id169 . -4) 4535) nil (26805 52061 374366 0) 0 nil])
([nil nil ((#("config" 0 6 (fontified t)) . -4538) (undo-tree-id168 . -6) 4544) nil (26805 52061 374365 0) 0 nil])
([nil nil ((4538 . 4541)) nil (26805 52061 374364 0) 0 nil])
([nil nil ((#("(cfg (%resolve-config config))
         " 0 40 (fontified t)) . -4723) (undo-tree-id167 . -40) 4763) nil (26805 52061 374364 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-string-face fontified t)) . -3011) (undo-tree-id166 . -1) 3012) nil (26805 52061 374362 0) 0 nil])
([nil nil ((3011 . 3012)) nil (26805 52061 374360 0) 0 nil])
([nil nil ((#("(or (getf cfg :connection-mode) :toplevel)" 0 6 (fontified t) 6 14 (fontified t) 14 30 (face font-lock-builtin-face fontified t) 30 32 (fontified t) 32 41 (face font-lock-builtin-face fontified t) 41 42 (fontified t)) . -4729) (undo-tree-id165 . -42) 4771) nil (26805 52061 374359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4806 . 4807) (nil fontified nil 4806 . 4807) (nil fontified nil 4797 . 4806) (nil fontified nil 4796 . 4797) (nil fontified nil 4788 . 4796) (nil fontified nil 4777 . 4788) (nil fontified nil 4776 . 4777) (nil fontified nil 4756 . 4776) (nil fontified nil 4747 . 4756) (nil fontified nil 4746 . 4747) (nil fontified nil 4730 . 4746) (nil fontified nil 4729 . 4730) (4729 . 4807)) nil (26805 52061 374349 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4776)) nil (26805 52061 374347 0) 0 nil])
([nil nil ((#("	     " 0 6 (fontified nil)) . -4784) (4784 . 4785) (#("	" 0 1 (fontified nil)) . 4784) (4782 . 4784) (4776 . 4777)) nil (26805 52061 374342 0) 0 nil])
([nil nil ((18135 . 18137) (t 26805 52061 0 0)) nil (26806 8834 336366 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -18135) (undo-tree-id172 . -1) (#("*" 0 1 (fontified t)) . -18136) (undo-tree-id173 . -1) 18137) nil (26806 8834 336360 0) 0 nil])
([nil nil ((#("&body body" 0 5 (face font-lock-type-face fontified t) 5 10 (fontified t)) . -12328) (undo-tree-id3 . -10) 12338 (t 26806 8834 0 0)) nil (26807 3434 899422 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12354 . 12355) (nil fontified nil 12349 . 12355) (nil fontified nil 12344 . 12349) (nil fontified nil 12338 . 12344) (nil fontified nil 12329 . 12338) (nil fontified nil 12328 . 12329) (12328 . 12355)) nil (26807 3434 899420 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -12327) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 12328) nil (26807 3434 899419 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12354) (undo-tree-id0 . -1) 12355) nil (26807 3434 899416 0) 0 nil])
([nil nil ((12369 . 12374)) nil (26807 3434 899402 0) 0 nil])
([nil nil ((12374 . 12375)) nil (26807 3434 899398 0) 0 nil])
([nil nil ((4713 . 4716) (t 26807 3434 0 0)) nil (26807 19464 835363 0) 0 nil])
([nil nil ((4716 . 4722)) nil (26807 19464 835363 0) 0 nil])
([nil nil ((4722 . 4723)) nil (26807 19464 835362 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -4717) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) (undo-tree-id56 . -1) (undo-tree-id57 . -1) (undo-tree-id58 . -1) (undo-tree-id59 . -1) (undo-tree-id60 . -1) (undo-tree-id61 . -1) (undo-tree-id62 . -1) (undo-tree-id63 . -1) (undo-tree-id64 . -1) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (#("r" 0 1 (fontified t)) . -4718) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) (undo-tree-id90 . -1) (undo-tree-id91 . -1) (undo-tree-id92 . -1) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (#("i" 0 1 (fontified t)) . -4719) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) (undo-tree-id140 . -1) (undo-tree-id141 . -1) (undo-tree-id142 . -1) (undo-tree-id143 . -1) (undo-tree-id144 . -1) (undo-tree-id145 . -1) (undo-tree-id146 . -1) (undo-tree-id147 . -1) (undo-tree-id148 . -1) (undo-tree-id149 . -1) (undo-tree-id150 . -1) (undo-tree-id151 . -1) (undo-tree-id152 . -1) (undo-tree-id153 . -1) (undo-tree-id154 . -1) (undo-tree-id155 . -1) (undo-tree-id156 . -1) (undo-tree-id157 . -1) (undo-tree-id158 . -1) (#("n" 0 1 (fontified t)) . -4720) (undo-tree-id159 . -1) (undo-tree-id160 . -1) (undo-tree-id161 . -1) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (undo-tree-id164 . -1) (undo-tree-id165 . -1) (undo-tree-id166 . -1) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) (undo-tree-id172 . -1) (undo-tree-id173 . -1) (undo-tree-id174 . -1) (undo-tree-id175 . -1) (undo-tree-id176 . -1) (undo-tree-id177 . -1) (undo-tree-id178 . -1) (undo-tree-id179 . -1) (undo-tree-id180 . -1) (undo-tree-id181 . -1) (undo-tree-id182 . -1) (undo-tree-id183 . -1) (undo-tree-id184 . -1) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (#("t" 0 1 (fontified t)) . -4721) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) (undo-tree-id207 . -1) (undo-tree-id208 . -1) (#(" " 0 1 (fontified t)) . -4722) (undo-tree-id209 . -1) (undo-tree-id210 . -1) (undo-tree-id211 . -1) (undo-tree-id212 . -1) (undo-tree-id213 . -1) (undo-tree-id214 . -1) (undo-tree-id215 . -1) (undo-tree-id216 . -1) (undo-tree-id217 . -1) (undo-tree-id218 . -1) (undo-tree-id219 . -1) 4723) nil (26807 19464 835356 0) 0 nil])
([nil nil ((4717 . 4723)) nil (26807 19464 835221 0) 0 nil])
([nil nil ((4723 . 4724)) nil (26807 19464 835220 0) 0 nil])
([nil nil ((4724 . 4725)) nil (26807 19464 835220 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-string-face fontified t)) . -4724) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) 4725) nil (26807 19464 835219 0) 0 nil])
([nil nil ((4724 . 4725)) nil (26807 19464 835215 0) 0 nil])
([nil nil ((4725 . 4726)) nil (26807 19464 835214 0) 0 nil])
([nil nil ((4726 . 4731)) nil (26807 19464 835214 0) 0 nil])
([nil nil ((4731 . 4732)) nil (26807 19464 835214 0) 0 nil])
([nil nil ((4732 . 4735)) nil (26807 19464 835213 0) 0 nil])
([nil nil ((#("é" 0 1 (face font-lock-string-face fontified t)) . -4734) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) 4735) nil (26807 19464 835212 0) 0 nil])
([nil nil ((4734 . 4737)) nil (26807 19464 835196 0) 0 nil])
([nil nil ((4737 . 4738)) nil (26807 19464 835195 0) 0 nil])
([nil nil ((4738 . 4740)) nil (26807 19464 835194 0) 0 nil])
([nil nil ((4740 . 4742)) nil (26807 19464 835190 0) 0 nil])
([nil nil ((7556 . 7566) (t 26807 19464 0 0)) nil (26807 19738 711894 0) 0 nil])
([nil nil ((7566 . 7572)) nil (26807 19738 711894 0) 0 nil])
([nil nil ((7572 . 7573)) nil (26807 19738 711893 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7750 . 7751) (nil fontified nil 7748 . 7751) (nil fontified nil 7746 . 7748) (nil fontified nil 7739 . 7746) (nil fontified nil 7673 . 7739) (nil fontified nil 7665 . 7673) (nil fontified nil 7659 . 7665) (nil fontified nil 7654 . 7659) (nil fontified nil 7597 . 7654) (nil fontified nil 7592 . 7597) (nil fontified nil 7573 . 7592) (7573 . 7751)) nil (26807 19738 711891 0) 0 nil])
([nil nil ((7751 . 7752)) nil (26807 19738 711883 0) 0 nil])
([nil nil ((4834 . 4839) (t 26807 19738 0 0)) nil (26807 19783 142673 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4864 . 4865) (nil fontified nil 4860 . 4865) (nil fontified nil 4849 . 4860) (nil fontified nil 4839 . 4849) (4839 . 4865)) nil (26807 19783 142672 0) 0 nil])
([nil nil ((#("CFG" 0 3 (face font-lock-string-face fontified t)) . -4850) (undo-tree-id225 . -3) (undo-tree-id226 . -1) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -3) (undo-tree-id232 . -3) (undo-tree-id233 . -3) (undo-tree-id234 . -3) 4853) nil (26807 19783 142671 0) 0 nil])
([nil nil ((4850 . 4854)) nil (26807 19783 142664 0) 0 nil])
([nil nil ((#("cfg" 0 3 (fontified t)) . -4862) (undo-tree-id220 . -3) (undo-tree-id221 . -3) (undo-tree-id222 . -3) (undo-tree-id223 . -3) (undo-tree-id224 . -3) 4865) nil (26807 19783 142662 0) 0 nil])
([nil nil ((4862 . 4866)) nil (26807 19783 142646 0) 0 nil])
([nil nil ((#("toplevel" 0 8 (face font-lock-builtin-face fontified t)) . -4823) (undo-tree-id255 . -8) (undo-tree-id256 . -2) (undo-tree-id257 . -2) (undo-tree-id258 . -2) (undo-tree-id259 . -2) (undo-tree-id260 . -2) (undo-tree-id261 . -8) (undo-tree-id262 . -8) (undo-tree-id263 . -8) (undo-tree-id264 . -8) (undo-tree-id265 . -8) (undo-tree-id266 . -8) (undo-tree-id267 . -8) (undo-tree-id268 . -8) 4831 (t 26807 19783 0 0)) nil (26807 19811 709542 0) 0 nil])
([nil nil ((4823 . 4832)) nil (26807 19811 709533 0) 0 nil])
([nil nil ((4822 . 4836) (#(":pooled-na" 0 10 (face font-lock-builtin-face fontified t)) . -4822) (undo-tree-id235 . -1) (undo-tree-id236 . -10) (undo-tree-id237 . -1) (undo-tree-id238 . -1) (undo-tree-id239 . -1) (undo-tree-id240 . -1) (undo-tree-id241 . -1) (undo-tree-id242 . -1) (undo-tree-id243 . -1) (undo-tree-id244 . -1) (undo-tree-id245 . -1) (undo-tree-id246 . -1) (undo-tree-id247 . -1) (undo-tree-id248 . -1) (undo-tree-id249 . -1) (undo-tree-id250 . -1) (undo-tree-id251 . -10) (undo-tree-id252 . -10) (undo-tree-id253 . -10) (undo-tree-id254 . -10) 4832) nil (26807 19811 709529 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-string-face fontified t)) . 4788) (t 26807 19811 0 0)) nil (26807 19842 805814 0) 0 nil])
([nil nil ((4788 . 4789)) nil (26807 19842 805810 0) 0 nil])
([nil nil ((4784 . 4785) (t 26807 19842 0 0)) nil (26807 20203 283081 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -4784) (undo-tree-id316 . -1) 4785) nil (26807 20203 283080 0) 0 nil])
([nil nil ((4758 . 4765)) nil (26807 20203 283079 0) 0 nil])
([nil nil ((4765 . 4766)) nil (26807 20203 283078 0) 0 nil])
([nil nil ((4766 . 4776)) nil (26807 20203 283078 0) 0 nil])
([nil nil ((4767 . 4780) (#("string-up" 0 9 (fontified t)) . -4767) (undo-tree-id315 . -9) 4776) nil (26807 20203 283077 0) 0 nil])
([nil nil ((4780 . 4781)) nil (26807 20203 283076 0) 0 nil])
([nil nil ((4828 . 4829)) nil (26807 20203 283076 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -4828) (undo-tree-id314 . -1) 4829) nil (26807 20203 283075 0) 0 nil])
([nil nil ((4828 . 4830)) nil (26807 20203 283074 0) 0 nil])
([nil nil ((4830 . 4840)) nil (26807 20203 283074 0) 0 nil])
([nil nil ((4840 . 4845)) nil (26807 20203 283073 0) 0 nil])
([nil nil ((4840 . 4848) (#(":keyw" 0 5 (face font-lock-builtin-face fontified t)) . -4840) (undo-tree-id313 . -5) 4845) nil (26807 20203 283073 0) 0 nil])
([nil nil ((4848 . 4849)) nil (26807 20203 283071 0) 0 nil])
([nil nil ((#(":default :pooled-native" 0 8 (face font-lock-builtin-face fontified t) 8 9 (fontified t) 9 23 (face font-lock-builtin-face fontified t)) . 4857) (undo-tree-id310 . -23) (undo-tree-id311 . -9) (undo-tree-id312 . -23) 4880) nil (26807 20203 283071 0) 0 nil])
([nil nil ((4758 . 4762) (#(" " 0 1 (fontified nil)) . 4757) (undo-tree-id303 . -1) (undo-tree-id304 . -1) (undo-tree-id305 . -1) (undo-tree-id306 . -1) (undo-tree-id307 . -1) (undo-tree-id308 . -1) (undo-tree-id309 . -1) (4758 . 4759)) nil (26807 20203 283068 0) 0 nil])
([nil nil ((4770 . 4775) (#(" " 0 1 (fontified nil)) . 4769) (undo-tree-id296 . -1) (undo-tree-id297 . -1) (undo-tree-id298 . -1) (undo-tree-id299 . -1) (undo-tree-id300 . -1) (undo-tree-id301 . -1) (undo-tree-id302 . -1) (4770 . 4771)) nil (26807 20203 283063 0) 0 nil])
([nil nil ((4837 . 4838)) nil (26807 20203 283058 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4860 . 4861) (nil fontified nil 4847 . 4861) (nil fontified nil 4846 . 4847) (nil fontified nil 4838 . 4846) (4838 . 4861)) nil (26807 20203 283058 0) 0 nil])
([nil nil ((4790 . 4796) (#(" " 0 1 (fontified nil)) . 4789) (undo-tree-id289 . -1) (undo-tree-id290 . -1) (undo-tree-id291 . -1) (undo-tree-id292 . -1) (undo-tree-id293 . -1) (undo-tree-id294 . -1) (undo-tree-id295 . -1) (4790 . 4791)) nil (26807 20203 283057 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4869) (undo-tree-id283 . -1) (undo-tree-id284 . -1) (undo-tree-id285 . -1) (undo-tree-id286 . -1) (undo-tree-id287 . -1) (undo-tree-id288 . -1)) nil (26807 20203 283052 0) 0 nil])
([nil nil ((#("	       " 0 8 (fontified nil)) . -4875) (4875 . 4876) (#("	" 0 1 (fontified nil)) . 4875) (4871 . 4875) (4869 . 4870)) nil (26807 20203 283046 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 4884) (undo-tree-id279 . -1) (undo-tree-id280 . -1) (undo-tree-id281 . -1) (undo-tree-id282 . -1)) nil (26807 20203 283044 0) 0 nil])
([nil nil ((#("					  )))" 0 7 (fontified t) 7 10 (fontified t)) . 4884) (undo-tree-id269 . -7) (undo-tree-id270 . -7) (undo-tree-id271 . -7) (undo-tree-id272 . -7) (undo-tree-id273 . -7) (undo-tree-id274 . -7) (undo-tree-id275 . -7) (undo-tree-id276 . -7) (undo-tree-id277 . -7) (undo-tree-id278 . -10)) nil (26807 20203 283040 0) 0 nil])
([nil nil ((4884 . 4886)) nil (26807 20203 283018 0) 0 nil])
([nil nil ((7263 . 7266) (t 26807 20203 0 0)) nil (26807 21780 439263 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7332 . 7333) (nil fontified nil 7266 . 7333) (7266 . 7333)) nil (26807 21780 439259 0) 0 nil])
([nil nil ((#("
 " 0 2 (fontified t)) . -7280) (undo-tree-id317 . -2) (undo-tree-id318 . -1) (undo-tree-id319 . -2) (undo-tree-id320 . -2) 7282 (t 26807 21780 0 0)) nil (26807 21786 391697 0) 0 nil])
([nil nil ((#("(ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))" 0 1 (fontified t) 1 14 (face font-lock-keyword-face fontified t) 14 33 (fontified t) 33 63 (face font-lock-string-face fontified t) 63 64 (fontified t) 64 65 (rear-nonsticky t fontified t)) . 7266) (undo-tree-id322 . -14) (undo-tree-id323 . -14) (undo-tree-id324 . -14) (undo-tree-id325 . -14) (undo-tree-id326 . -14) (undo-tree-id327 . -14) (undo-tree-id328 . -14) (undo-tree-id329 . -14) (undo-tree-id330 . -14) (undo-tree-id331 . -65) (t 26807 21786 0 0)) nil (26807 22013 864363 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 7263) (undo-tree-id321 . -1)) nil (26807 22013 864352 0) 0 nil])
([nil nil ((8069 . 8074)) nil (26807 22013 864340 0) 0 nil])
([nil nil ((nil fontified nil 8138 . 8139) (nil fontified nil 8137 . 8138) (nil fontified nil 8107 . 8137) (nil fontified nil 8088 . 8107) (nil fontified nil 8075 . 8088) (nil fontified nil 8074 . 8075) (8074 . 8139)) nil (26807 22013 864335 0) 0 nil])
([nil nil ((#("(print (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t))" 0 88 (fontified t) 88 93 (face font-lock-builtin-face fontified t) 93 99 (fontified t) 99 107 (face font-lock-builtin-face fontified t) 107 173 (fontified t) 173 182 (face font-lock-builtin-face fontified t) 182 186 (fontified t)) . -7653) (undo-tree-id1 . -186) (undo-tree-id2 . -186) (undo-tree-id3 . -186) (undo-tree-id4 . -186) (undo-tree-id5 . -186) (undo-tree-id6 . -116) (undo-tree-id7 . -186) (undo-tree-id8 . -186) 7839 (t 26807 22013 0 0)) nil (26807 59612 899771 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 7643) (undo-tree-id0 . -1)) nil (26807 59612 899760 0) 0 nil])
([nil nil ((#("
  (format t \"CFG: ~A~%\" cfg)" 0 13 (fontified t) 13 24 (face font-lock-string-face fontified t) 24 29 (fontified t)) . 4713) (undo-tree-id12 . -29) (t 26807 59612 0 0)) nil (26808 2978 895881 0) 0 nil])
([nil nil ((#("
    (format t \"MODE: ~A~%\" mode)" 0 15 (fontified t) 15 27 (face font-lock-string-face fontified t) 27 33 (fontified t)) . 4857) (undo-tree-id9 . -33) (undo-tree-id10 . -33) (undo-tree-id11 . -33)) nil (26808 2978 895878 0) 0 nil])
([nil nil ((19250 . 19253) (t 26808 2978 0 0)) nil (26809 24186 21072 0) 0 nil])
([nil nil ((19253 . 19259)) nil (26809 24186 21071 0) 0 nil])
([nil nil ((19259 . 19260)) nil (26809 24186 21069 0) 0 nil])
([nil nil ((19260 . 19267)) nil (26809 24186 21065 0) 0 nil])
([nil nil ((19548 . 19553) (t 26809 24186 0 0)) nil (26809 24326 849968 0) 0 nil])
([nil nil ((19553 . 19558)) nil (26809 24326 849967 0) 0 nil])
([nil nil ((19558 . 19559)) nil (26809 24326 849967 0) 0 nil])
([nil nil ((#("t" 0 1 (fontified t)) . -19557) (undo-tree-id2 . -1) (#(" " 0 1 (fontified t)) . -19558) (undo-tree-id3 . -1) 19559) nil (26809 24326 849966 0) 0 nil])
([nil nil ((19557 . 19559)) nil (26809 24326 849964 0) 0 nil])
([nil nil ((#("," 0 1 (fontified t)) . -19557) (undo-tree-id0 . -1) (#("t" 0 1 (fontified t)) . -19558) (undo-tree-id1 . -1) 19559) nil (26809 24326 849963 0) 0 nil])
([nil nil ((19557 . 19559)) nil (26809 24326 849947 0) 0 nil])
([nil nil ((19559 . 19560)) nil (26809 24326 849946 0) 0 nil])
([nil nil ((19560 . 19565)) nil (26809 24326 849943 0) 0 nil])
([nil nil ((14982 . 14983) (t 26809 24326 0 0)) nil (26809 39534 36731 0) 0 nil])
([nil nil ((14983 . 14985)) nil (26809 39534 36727 0) 0 nil])
([nil nil ((19568 . 19573) (t 26809 39534 0 0)) nil (26809 40885 902436 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19602 . 19603) (nil fontified nil 19596 . 19603) (nil fontified nil 19586 . 19596) (nil fontified nil 19583 . 19586) (nil fontified nil 19578 . 19583) (nil fontified nil 19573 . 19578) (19573 . 19603)) nil (26809 40885 902435 0) 0 nil])
([nil nil ((#("
    (print args)" 0 1 (fontified t) 1 17 (fontified t)) . 19551) (undo-tree-id27 . -17) (undo-tree-id28 . -17) (undo-tree-id29 . -17) (undo-tree-id30 . -17) (undo-tree-id31 . -17) (undo-tree-id32 . -17) (undo-tree-id33 . -17) (undo-tree-id34 . -17) (undo-tree-id35 . -17) (undo-tree-id36 . -17) (undo-tree-id37 . -17) (undo-tree-id38 . -17) (undo-tree-id39 . -17) (undo-tree-id40 . -17) (undo-tree-id41 . -1) (undo-tree-id42 . -17) (undo-tree-id43 . -17) (undo-tree-id44 . -17) (undo-tree-id45 . -17) (undo-tree-id46 . -17)) nil (26809 40885 902434 0) 0 nil])
([nil nil ((#("
  (print params)" 0 17 (fontified t)) . 19253) (undo-tree-id18 . -17) (undo-tree-id19 . -10) (undo-tree-id20 . -10) (undo-tree-id21 . -10) (undo-tree-id22 . -17) (undo-tree-id23 . -17) (undo-tree-id24 . -17) (undo-tree-id25 . -17) (undo-tree-id26 . -17)) nil (26809 40885 902421 0) 0 nil])
([nil nil ((#("p-tid" 0 5 (fontified t)) . -19563) (undo-tree-id3 . -5) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -5) (undo-tree-id11 . -5) (undo-tree-id12 . -5) (undo-tree-id13 . -5) (undo-tree-id14 . -5) (undo-tree-id15 . -5) (undo-tree-id16 . -5) (undo-tree-id17 . -5) 19568) nil (26809 40885 902415 0) 0 nil])
([nil nil ((19563 . 19567)) nil (26809 40885 902405 0) 0 nil])
([nil nil ((#("P TID" 0 2 (face font-lock-string-face fontified t) 2 5 (face font-lock-string-face fontified t)) . -19550) (undo-tree-id0 . -5) (undo-tree-id1 . -5) (undo-tree-id2 . -5) 19555) nil (26809 40885 902404 0) 0 nil])
([nil nil ((19550 . 19554)) nil (26809 40885 902370 0) 0 nil])
([nil nil ((19567 . 19572) (t 26809 40885 0 0)) nil (26809 41012 989342 0) 0 nil])
([nil nil ((19572 . 19577)) nil (26809 41012 989341 0) 0 nil])
([nil nil ((19573 . 19579) (#("form" 0 4 (fontified t)) . -19573) (undo-tree-id59 . -4) 19577) nil (26809 41012 989341 0) 0 nil])
([nil nil ((19579 . 19580)) nil (26809 41012 989339 0) 0 nil])
([nil nil ((19580 . 19581)) nil (26809 41012 989339 0) 0 nil])
([nil nil ((19581 . 19582)) nil (26809 41012 989338 0) 0 nil])
([nil nil ((#("(format y " 0 1 (fontified t) 1 10 (fontified t)) . -19572) (undo-tree-id58 . -10) 19582) nil (26809 41012 989338 0) 0 nil])
([nil nil ((nil fontified nil 19599 . 19600) (nil fontified nil 19594 . 19599) (nil fontified nil 19587 . 19594) (nil fontified nil 19582 . 19587) (nil fontified nil 19577 . 19582) (nil fontified nil 19572 . 19577) (19572 . 19600)) nil (26809 41012 989337 0) 0 nil])
([nil nil ((#("ARGS" 0 4 (face font-lock-string-face fontified t)) . -19583) (undo-tree-id57 . -4) 19587) nil (26809 41012 989336 0) 0 nil])
([nil nil ((19583 . 19586)) nil (26809 41012 989335 0) 0 nil])
([nil nil ((#("args" 0 4 (fontified t)) . -19594) (undo-tree-id50 . -4) (undo-tree-id51 . -4) (undo-tree-id52 . -4) (undo-tree-id53 . -4) (undo-tree-id54 . -4) (undo-tree-id55 . -4) (undo-tree-id56 . -4) 19598) nil (26809 41012 989334 0) 0 nil])
([nil nil ((19594 . 19596)) nil (26809 41012 989329 0) 0 nil])
([nil nil ((#("l" 0 1 (fontified t)) . -19595) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) 19596) nil (26809 41012 989327 0) 0 nil])
([nil nil ((19595 . 19597)) nil (26809 41012 989315 0) 0 nil])
([nil nil ((20390 . 20396) (t 26809 41012 0 0)) nil (26809 41299 993028 0) 0 nil])
([nil nil ((20396 . 20402)) nil (26809 41299 993028 0) 0 nil])
([nil nil ((20402 . 20403)) nil (26809 41299 993027 0) 0 nil])
([nil nil ((20403 . 20408)) nil (26809 41299 993027 0) 0 nil])
([nil nil ((#("V" 0 1 (face font-lock-string-face fontified t)) . -20404) (undo-tree-id60 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -20405) (undo-tree-id61 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -20406) (undo-tree-id62 . -1) (#("V" 0 1 (face font-lock-string-face fontified t)) . -20407) (undo-tree-id63 . -1) 20408) nil (26809 41299 993025 0) 0 nil])
([nil nil ((20404 . 20411)) nil (26809 41299 993011 0) 0 nil])
([nil nil ((#("
	    (print \"NBNVN\")" 0 13 (fontified t) 13 20 (face font-lock-string-face fontified t) 20 21 (fontified t)) . 20390) (undo-tree-id0 . -21) (t 26809 41299 0 0)) nil (26821 52430 879572 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 21279 . 21280) (nil fontified nil 21275 . 21280) (nil fontified nil 21265 . 21275) (nil fontified nil 21244 . 21265) (nil fontified nil 21231 . 21244) (nil fontified nil 21214 . 21231) (nil fontified nil 21209 . 21214) (nil fontified nil 21197 . 21209) (nil fontified nil 21183 . 21197) (nil fontified nil 21175 . 21183) (nil fontified nil 21168 . 21175) (nil fontified nil 21142 . 21168) (nil fontified nil 21119 . 21142) (nil fontified nil 21114 . 21119) (nil fontified nil 20968 . 21114) (nil fontified nil 20959 . 20968) (nil fontified nil 20954 . 20959) (nil fontified nil 20952 . 20954) (nil fontified nil 20939 . 20952) (nil fontified nil 20938 . 20939) (nil fontified nil 20930 . 20938) (nil fontified nil 20929 . 20930) (20929 . 21280) (t 26821 52430 0 0)) nil (26957 4576 998444 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -20927) (undo-tree-id1 . -1) 20928) nil (26957 4576 998439 0) 0 nil])
([nil nil ((589 . 590)) nil (26957 4576 998436 0) 0 nil])
([nil nil ((590 . 596)) nil (26957 4576 998435 0) 0 nil])
([nil nil ((596 . 599)) nil (26957 4576 998435 0) 0 nil])
([nil nil ((590 . 604) (#(":with-rol" 0 9 (face font-lock-builtin-face fontified t)) . -590) (undo-tree-id0 . -9) 599) nil (26957 4576 998432 0) 0 nil])
([nil nil ((21294 . 21295)) nil (26957 4576 998409 0) 0 nil])
([nil nil ((3077 . 3079) (#("  " 0 2 (fontified nil)) . 3076) (undo-tree-id0 . -2) (3075 . 3079) (t 26957 4577 0 0)) nil (26957 39013 54210 0) 0 nil])
([nil nil ((3079 . 3085)) nil (26957 39013 54197 0) 0 nil])
([nil nil ((3085 . 3086)) nil (26957 39013 54196 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3102 . 3103) (nil fontified nil 3086 . 3103) (3086 . 3103)) nil (26957 39013 54195 0) 0 nil])
([nil nil ((3103 . 3104)) nil (26957 39013 54191 0) 0 nil])
([nil nil ((3104 . 3107) (t 26957 39013 0 0)) nil (26957 39104 559293 0) 0 nil])
([nil nil ((3107 . 3113)) nil (26957 39104 559293 0) 0 nil])
([nil nil ((3113 . 3114)) nil (26957 39104 559291 0) 0 nil])
([nil nil ((3114 . 3121)) nil (26957 39104 559288 0) 0 nil])
([nil nil ((2996 . 2999) (t 26957 39104 0 0)) nil (26957 39461 128035 0) 0 nil])
([nil nil ((2999 . 3000)) nil (26957 39461 128035 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3022 . 3023) (nil fontified nil 3022 . 3023) (nil fontified nil 3013 . 3022) (nil fontified nil 3000 . 3013) (3000 . 3023)) nil (26957 39461 128034 0) 0 nil])
([nil nil ((3023 . 3033)) nil (26957 39461 128033 0) 0 nil])
([nil nil ((3112 . 3113)) nil (26957 39461 128033 0) 0 nil])
([nil nil ((#("database" 0 8 (face font-lock-builtin-face fontified t)) . -3014) (undo-tree-id3 . -8) 3022) nil (26957 39461 128032 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -3013) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 3014) nil (26957 39461 128029 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3031 . 3032) (nil fontified nil 3013 . 3032) (3013 . 3032)) nil (26957 39461 128014 0) 0 nil])
([nil nil ((#("
  (print *connection-mode*)
  (print \"OKKK\")" 0 1 (fontified t) 1 10 (fontified t) 10 26 (fontified t) 26 27 (fontified t rear-nonsticky t) 27 29 (fontified t) 29 38 (fontified t) 38 44 (face font-lock-string-face fontified t) 44 45 (fontified t)) . 3124) (undo-tree-id4 . -45) (undo-tree-id5 . -28) (undo-tree-id6 . -10) (undo-tree-id7 . -45) (undo-tree-id8 . -45) (undo-tree-id9 . -45) (undo-tree-id10 . -45) (t 26957 39461 0 0)) nil (26958 8256 484077 0) 0 nil])
([nil nil ((#("
#|
(defmacro with-conn (&body body)
  \"Ouvre une connexion selon *connection-mode* avec les bons paramètres Postmodern.\"
  #+postmodern
  `(ecase *connection-mode*
     (:toplevel
      (progn ,@body))
     (:scoped
      (let* ((cfg *current-config*)
             (db   (getf cfg :database))
             (user (getf cfg :user))
             (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\"))
             (port (or (getf cfg :port) 5432))
             (app  (or (getf cfg :application-name) \"\"))
             (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
        (postmodern:with-connection (list db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
          ,@body)))
     (:pooled-native
      ;; On utilise le sémaphore *pool-sema* pour borner la concurrence,
      ;; mais on *n’inspecte plus* son compte. On expose in-use via *pool-inflight*.
      (let* ((deadline (+ (get-internal-real-time)
                          (* cl:internal-time-units-per-second
                             (/ (max 1 *pool-wait-ms*) 1000.0))))
             (t0 (get-internal-real-time)))
        ;; on entre en file d’attente
        (%pool-incf! '*pool-waiters* 1)
        (unwind-protect
             (progn
               (labels ((acquire-slot ()
                          (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                              (if (< (get-internal-real-time) deadline)
                                  (acquire-slot)
                                  (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                 (acquire-slot))
               ;; slot acquis → sortie d’attente / entrée en vol
               (%pool-incf! '*pool-waiters*  -1)
               (%pool-incf! '*pool-inflight* 1)
               (let* ((t1 (get-internal-real-time))
                      (wait-ms (* 1000.0 (/ (- t1 t0) cl:internal-time-units-per-second))))
                 ;; publier métrique (in-use = connexions tenues)
                 (multiple-value-bind (in-use _waiters) (%pool-snapshot)
                   (declare (ignore _waiters))
                   (ignore-errors
                     (lumen.data.metrics:record-pool-stats in-use wait-ms))))
               ;; exécuter le corps dans une connexion Postmodern poolée
               (let* ((cfg *current-config*)
                      (db   (getf cfg :database))
                      (user (getf cfg :user))
                      (pass (getf cfg :password))
                      (host (or (getf cfg :host) \"localhost\"))
                      (port (or (getf cfg :port) 5432))
                      (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                 (unwind-protect
                      (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl
                                                        ;; NB: on peut passer :pooled-p t ici si tu veux explicitement le pool PM
                                                        )
                        ,@body)
                   ;; sortie : on libère la connexion + met à jour in-flight
                   (%pool-incf! '*pool-inflight* -1)
                   (bt:signal-semaphore *pool-sema*))))
          ;; si une erreur survient AVANT l’acquisition du slot, on décrémente la file d’attente
          (when (> *pool-waiters* 0)
            (%pool-incf! '*pool-waiters* -1))))))
  #-postmodern
  `(progn ,@body))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 1377 (face font-lock-comment-face fontified t) 1377 1475 (face font-lock-comment-face fontified t) 1475 2975 (face font-lock-comment-face fontified t) 2975 3046 (face font-lock-comment-face fontified t) 3046 3244 (fontified t face font-lock-comment-face) 3244 3540 (face font-lock-comment-face fontified t) 3540 3542 (face font-lock-comment-delimiter-face fontified t) 3542 3543 (fontified t)) . -8952) (undo-tree-id16 . -3543) (undo-tree-id17 . -2213) 12495 (t 26958 8256 0 0)) nil (26958 9622 95545 0) 0 nil])
([nil nil ((#("
#|
(defmacro with-statement-timeout ((ms) &body body)
  \"Exécute BODY avec SET LOCAL statement_timeout = MS (dans une transaction),
si MS est non-NIL et > 0. N’affecte que la transaction courante.\"
  `(ensure-connection
     (if (and ,ms (> ,ms 0))
         (postmodern:with-transaction ()
           ;; SET LOCAL ne persiste que le temps de cette transaction
           (postmodern:query
             (format nil \"set local statement_timeout = ~d\" (truncate ,ms)))
           ,@body)ent
         (progn ,@body))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 516 (face font-lock-comment-face fontified t) 516 518 (face font-lock-comment-delimiter-face fontified t)) . -11018) (undo-tree-id15 . -518) 11536) nil (26958 9622 95543 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 11018)) nil (26958 9622 95542 0) 0 nil])
([nil nil ((4710 . 4711)) nil (26958 9622 95541 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4779 . 4780) (nil fontified nil 4711 . 4780) (4711 . 4780)) nil (26958 9622 95541 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-doc-face fontified t)) . 4780)) nil (26958 9622 95540 0) 0 nil])
([nil nil ((4780 . 4781)) nil (26958 9622 95540 0) 0 nil])
([nil nil ((#("(thunk &key (cfg (lumen.data.config:db-config)))" 0 4 (fontified t) 4 7 (fontified t) 7 11 (face font-lock-type-face fontified t) 11 35 (fontified t) 35 36 (fontified t) 36 48 (fontified t)) . -4589) (undo-tree-id14 . -48) 4637) nil (26958 9622 95539 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4658 . 4659) (nil fontified nil 4589 . 4659) (4589 . 4659)) nil (26958 9622 95537 0) 0 nil])
([nil nil ((#("(let* ((mode
	   (intern
	    (string-upcase
	     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))
	    :keyword)))" 0 1 (fontified t) 1 5 (face font-lock-keyword-face fontified t) 5 78 (fontified t) 78 98 (face font-lock-string-face fontified t) 98 99 (fontified t) 99 107 (face font-lock-builtin-face fontified t) 107 108 (fontified t) 108 122 (face font-lock-builtin-face fontified t) 122 130 (fontified t) 130 138 (face font-lock-builtin-face fontified t) 138 141 (fontified t)) . -4872) (undo-tree-id13 . -141) 5013) nil (26958 9622 95537 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5166 . 5167) (nil fontified nil 4872 . 5167) (4872 . 5167)) nil (26958 9622 95535 0) 0 nil])
([nil nil ((4596 . 4605) (#(" " 0 1 (fontified nil)) . 4595) (undo-tree-id12 . -1) (4596 . 4597)) nil (26958 9622 95534 0) 0 nil])
([nil nil ((17537 . 17538)) nil (26958 9622 95532 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17868 . 17869) (nil fontified nil 17538 . 17869) (17538 . 17869)) nil (26958 9622 95532 0) 0 nil])
([nil nil ((17184 . 17185)) nil (26958 9622 95531 0) 0 nil])
([nil nil ((17185 . 17187)) nil (26958 9622 95530 0) 0 nil])
([nil nil ((17540 . 17542)) nil (26958 9622 95530 0) 0 nil])
([nil nil ((#("\"" 0 1 (face font-lock-comment-face fontified t)) . -17541) (undo-tree-id11 . -1) 17542) nil (26958 9622 95529 0) 0 nil])
([nil nil ((17541 . 17542)) nil (26958 9622 95519 0) 0 nil])
([nil nil ((17542 . 17543)) nil (26958 9622 95518 0) 0 nil])
([nil nil ((17875 . 17876)) nil (26958 9622 95515 0) 0 nil])
([nil nil ((2937 . 2940) (t 26958 9622 0 0)) nil (26974 15484 997356 0) 0 nil])
([nil nil ((2940 . 2946)) nil (26974 15484 997356 0) 0 nil])
([nil nil ((2946 . 2947)) nil (26974 15484 997355 0) 0 nil])
([nil nil ((2947 . 2951)) nil (26974 15484 997355 0) 0 nil])
([nil nil ((#("N" 0 1 (fontified t)) . -2949) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (#("N" 0 1 (fontified t)) . -2950) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) 2951) nil (26974 15484 997354 0) 0 nil])
([nil nil ((#("é" 0 1 (fontified t)) . -2947) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (#("I" 0 1 (fontified t)) . -2948) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) 2949) nil (26974 15484 997346 0) 0 nil])
([nil nil ((2947 . 2955)) nil (26974 15484 997336 0) 0 nil])
([nil nil ((#("S" 0 1 (face font-lock-string-face fontified t)) . -2950) (undo-tree-id0 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -2951) (undo-tree-id1 . -1) (#("A" 0 1 (face font-lock-string-face fontified t)) . -2952) (undo-tree-id2 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -2953) (undo-tree-id3 . -1) (#("T" 0 1 (face font-lock-string-face fontified t)) . -2954) (undo-tree-id4 . -1) 2955) nil (26974 15484 997334 0) 0 nil])
([nil nil ((2950 . 2951)) nil (26974 15484 997315 0) 0 nil])
([nil nil ((2951 . 2959)) nil (26974 15484 997314 0) 0 nil])
([nil nil ((2959 . 2962)) nil (26974 15484 997314 0) 0 nil])
([nil nil ((2962 . 2968)) nil (26974 15484 997314 0) 0 nil])
([nil nil ((2968 . 2969)) nil (26974 15484 997313 0) 0 nil])
([nil nil ((2969 . 2974)) nil (26974 15484 997312 0) 0 nil])
([nil nil ((2974 . 2976)) nil (26974 15484 997309 0) 0 nil])
([nil nil ((3160 . 3162) (3136 . 3138) (#("     " 0 5 (fontified nil)) . 3136) (3162 . 3163) (t 26974 15484 0 0)) nil (26974 15854 200219 0) 0 nil])
([nil nil ((3162 . 3167)) nil (26974 15854 200219 0) 0 nil])
([nil nil ((3167 . 3168)) nil (26974 15854 200218 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3182 . 3183) (nil fontified nil 3168 . 3183) (3168 . 3183)) nil (26974 15854 200218 0) 0 nil])
([nil nil ((#("thing" 0 5 (fontified t)) . -3177) (undo-tree-id31 . -5) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -5) (undo-tree-id39 . -5) (undo-tree-id40 . -5) (undo-tree-id41 . -5) 3182) nil (26974 15854 200216 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3193 . 3194) (nil fontified nil 3177 . 3194) (3177 . 3194)) nil (26974 15854 200200 0) 0 nil])
([nil nil ((3195 . 3200)) nil (26974 15854 200268 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3252 . 3253) (nil fontified nil 3252 . 3253) (nil fontified nil 3244 . 3252) (nil fontified nil 3200 . 3244) (3200 . 3253)) nil (26974 15869 981465 0) 0 nil] [nil nil ((nil rear-nonsticky nil 3216 . 3217) (nil fontified nil 3200 . 3217) (3200 . 3217)) ((#("*connection-mode*" 0 16 (fontified nil) 16 17 (rear-nonsticky nil fontified nil)) . 3200) (undo-tree-id42 . -17) (nil rear-nonsticky t 3216 . 3217)) (26974 15854 200195 0) 0 nil])
([nil nil ((3200 . 3205)) nil (26974 15869 981464 0) 0 nil])
nil
([nil nil ((3205 . 3206)) nil (26974 15869 981464 0) 0 nil])
([nil nil ((nil fontified nil 3222 . 3223) (nil fontified nil 3206 . 3222) (3206 . 3223)) nil (26974 15869 981463 0) 0 nil])
([nil nil ((3223 . 3224)) nil (26974 15869 981461 0) 0 nil])
([nil nil ((3277 . 3279)) nil (26974 15869 981458 0) 0 nil])
([nil nil ((#("thing" 0 5 (fontified t)) . -3260) (undo-tree-id43 . -5) (undo-tree-id44 . -5) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) (undo-tree-id49 . -1) (undo-tree-id50 . -5) (undo-tree-id51 . -5) (undo-tree-id52 . -5) (undo-tree-id53 . -5) 3265 (t 26974 15869 0 0)) nil (26974 15889 590799 0) 0 nil])
([nil nil ((nil fontified nil 3276 . 3277) (nil fontified nil 3260 . 3276) (3260 . 3277)) nil (26974 15889 590782 0) 0 nil])
([nil nil ((3291 . 3294) (t 26974 15889 0 0)) nil (26974 16001 578442 0) 0 nil])
([nil nil ((3294 . 3300)) nil (26974 16001 578442 0) 0 nil])
([nil nil ((3300 . 3301)) nil (26974 16001 578441 0) 0 nil])
([nil nil ((nil fontified nil 3317 . 3318) (nil fontified nil 3301 . 3317) (3301 . 3318)) nil (26974 16001 578440 0) 0 nil])
([nil nil ((3318 . 3319)) nil (26974 16001 578436 0) 0 nil])
([nil nil ((#("(symbol-name " 0 13 (fontified t)) . -3247) (undo-tree-id54 . -13) (undo-tree-id55 . -13) (undo-tree-id56 . -13) (undo-tree-id57 . -13) 3260 (t 26974 16001 0 0)) nil (26974 16038 97477 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . 3264)) nil (26974 16038 97461 0) 0 nil])
([nil nil ((15989 . 15994) (t 26974 16038 0 0)) nil (26975 58388 717925 0) 0 nil])
([nil nil ((16027 . 16032)) nil (26975 58388 717924 0) 0 nil])
([nil nil ((15740 . 15743)) nil (26975 58388 717924 0) 0 nil])
([nil nil ((15743 . 15745)) nil (26975 58388 717923 0) 0 nil])
([nil nil ((15745 . 15746)) nil (26975 58388 717923 0) 0 nil])
([nil nil ((15746 . 15752)) nil (26975 58388 717922 0) 0 nil])
([nil nil ((15752 . 15753)) nil (26975 58388 717922 0) 0 nil])
([nil nil ((15753 . 15759)) nil (26975 58388 717921 0) 0 nil])
([nil nil ((15815 . 15818)) nil (26975 58388 717921 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15833 . 15834) (nil fontified nil 15832 . 15834) (nil fontified nil 15828 . 15832) (nil fontified nil 15818 . 15828) (15818 . 15834)) nil (26975 58388 717920 0) 0 nil])
([nil nil ((15885 . 15888)) nil (26975 58388 717920 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15903 . 15904) (nil fontified nil 15902 . 15904) (nil fontified nil 15898 . 15902) (nil fontified nil 15888 . 15898) (15888 . 15904)) nil (26975 58388 717919 0) 0 nil])
([nil nil ((15990 . 15993)) nil (26975 58388 717918 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16008 . 16009) (nil fontified nil 16007 . 16009) (nil fontified nil 16003 . 16007) (nil fontified nil 15993 . 16003) (15993 . 16009)) nil (26975 58388 717918 0) 0 nil])
([nil nil ((15692 . 15695)) nil (26975 58388 717917 0) 0 nil])
([nil nil ((15695 . 15696)) nil (26975 58388 717916 0) 0 nil])
([nil nil ((#("-" 0 1 (fontified t)) . -15695) (undo-tree-id89 . -1) 15696) nil (26975 58388 717916 0) 0 nil])
([nil nil ((15695 . 15696)) nil (26975 58388 717915 0) 0 nil])
([nil nil ((16069 . 16071)) nil (26975 58388 717914 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16110 . 16111) (nil fontified nil 16109 . 16111) (16109 . 16111)) nil (26975 58388 717913 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . -15695) (undo-tree-id78 . -1) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) 15696) nil (26975 58388 717912 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15729 . 15730) (nil fontified nil 15724 . 15730) (nil fontified nil 15705 . 15724) (nil fontified nil 15695 . 15705) (15695 . 15730)) nil (26975 58388 717905 0) 0 nil])
([nil nil ((#("ARGS" 0 4 (face font-lock-string-face fontified t)) . -15713) (undo-tree-id68 . -4) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -4) (undo-tree-id75 . -4) (undo-tree-id76 . -4) (undo-tree-id77 . -4) 15717) nil (26975 58388 717903 0) 0 nil])
([nil nil ((15713 . 15719)) nil (26975 58388 717897 0) 0 nil])
([nil nil ((#("args" 0 4 (fontified t)) . -15727) (undo-tree-id58 . -4) (undo-tree-id59 . -2) (undo-tree-id60 . -2) (undo-tree-id61 . -2) (undo-tree-id62 . -2) (undo-tree-id63 . -2) (undo-tree-id64 . -4) (undo-tree-id65 . -4) (undo-tree-id66 . -4) (undo-tree-id67 . -4) 15731) nil (26975 58388 717895 0) 0 nil])
([nil nil ((15727 . 15733)) nil (26975 58388 717875 0) 0 nil])
([nil nil ((#("(format t \"~&EXEC:SQL: ~A~%\" sql)" 0 10 (fontified t) 10 11 (face font-lock-string-face fontified t) 11 12 (face font-lock-string-face fontified t) 12 13 (face font-lock-string-face fontified t rear-nonsticky t) 13 28 (face font-lock-string-face fontified t) 28 33 (fontified t)) . 16136) (undo-tree-id96 . -11) (t 26975 58388 0 0)) nil (26975 58879 219050 0) 0 nil])
([nil nil ((15734 . 15737)) nil (26975 58879 219049 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15769 . 15770) (nil fontified nil 15765 . 15770) (nil fontified nil 15750 . 15765) (nil fontified nil 15749 . 15750) (nil fontified nil 15748 . 15749) (nil fontified nil 15747 . 15748) (nil fontified nil 15737 . 15747) (15737 . 15770)) nil (26975 58879 219048 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -15831) (undo-tree-id95 . -4) 15835) nil (26975 58879 219047 0) 0 nil])
([nil nil ((15831 . 15833)) nil (26975 58879 219046 0) 0 nil])
([nil nil ((15833 . 15835)) nil (26975 58879 219045 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -15906) (undo-tree-id94 . -4) 15910) nil (26975 58879 219044 0) 0 nil])
([nil nil ((15906 . 15910)) nil (26975 58879 219043 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -15976) (undo-tree-id93 . -4) 15980) nil (26975 58879 219043 0) 0 nil])
([nil nil ((15976 . 15980)) nil (26975 58879 219041 0) 0 nil])
([nil nil ((#("\"OK\"" 0 4 (face font-lock-string-face fontified t)) . -16081) (undo-tree-id90 . -4) (undo-tree-id91 . -4) (undo-tree-id92 . -4) 16085) nil (26975 58879 219039 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16090 . 16091) (nil fontified nil 16081 . 16091) (16081 . 16091)) nil (26975 58879 219024 0) 0 nil])
([nil nil ((17506 . 17508) (t 26975 58879 0 0)) nil (26975 60479 945245 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19901 . 19902) (nil fontified nil 17508 . 19902) (17508 . 19902)) nil (26975 60479 945245 0) 0 nil])
([nil nil ((15493 . 15494)) nil (26975 60479 945244 0) 0 nil])
([nil nil ((15494 . 15496)) nil (26975 60479 945244 0) 0 nil])
([nil nil ((17510 . 17512)) nil (26975 60479 945243 0) 0 nil])
([nil nil ((17512 . 17513)) nil (26975 60479 945243 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -17688) (undo-tree-id109 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -17689) (undo-tree-id110 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -17690) (undo-tree-id111 . -1) 17691) nil (26975 60479 945242 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -18446) (undo-tree-id106 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18447) (undo-tree-id107 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18448) (undo-tree-id108 . -1) 18449) nil (26975 60479 945237 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -18486) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18487) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -18488) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) 18489) nil (26975 60479 945231 0) 0 nil])
([nil nil ((19832 . 19838) (#("      " 0 6 (fontified nil)) . 19831) (undo-tree-id112 . -6) (#("      " 0 6 (fontified nil)) . -19837) (undo-tree-id113 . -6) (19843 . 19844) (t 26975 60479 0 0)) nil (26976 11389 444321 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20011 . 20012) (nil fontified nil 19838 . 20012) (19838 . 20012)) nil (26976 11389 444310 0) 0 nil])
([nil nil ((20012 . 20019)) nil (26976 11389 444305 0) 0 nil])
([nil nil ((10721 . 10726) (t 26976 11389 0 0)) nil (26976 12374 272864 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10943 . 10944) (nil fontified nil 10726 . 10944) (10726 . 10944)) nil (26976 12374 272862 0) 0 nil])
([nil nil ((10944 . 10949)) nil (26976 12374 272859 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\")))
    `(let ((,g-attempt 0)
           (,g-retries ,retries)
           (,g-sleep ,sleep-ms))
       (loop
         (handler-case
             (return
               (ensure-connection
                 #+postmodern
                 (postmodern:with-transaction () ,@body)
                 #-postmodern
                 (progn ,@body)
		 ))
	   ;; Elles sortiront du with-transaction (provoquant un ROLLBACK automatique)
           ;; et seront attrapées par le middleware HTTP plus haut.
           (lumen.core.error:application-error (c)
             (error c))
	   
           (condition (c)
             ;; Convertit en condition Lumen sans la signaler, puis évalue la rejouabilité
             (let ((mapped (lumen.data.errors:map-db-error c)))
               (if (and (< ,g-attempt ,g-retries)
                        (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (incf ,g-attempt)
                     ;; Backoff simple (optionnel)
                     (when (plusp ,g-sleep)
                       (sleep (/ (max 0 ,g-sleep) 1000.0)))
                     ;; et on boucle pour retenter
                     (continue))
                   ;; Pas rejouable (ou plus de retries) → signaler l’erreur Lumen
                   (error mapped)))))))))" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 42 (fontified t) 42 45 (face font-lock-keyword-face fontified t) 45 66 (fontified t) 66 71 (face font-lock-string-face fontified t) 71 101 (fontified t) 101 106 (face font-lock-string-face fontified t) 106 136 (fontified t) 136 143 (face font-lock-string-face fontified t) 143 153 (fontified t) 153 156 (face font-lock-keyword-face fontified t) 156 247 (fontified t) 247 251 (face font-lock-keyword-face fontified t) 251 262 (fontified t) 262 274 (face font-lock-keyword-face fontified t) 274 289 (fontified t) 289 295 (face font-lock-keyword-face fontified t) 295 378 (fontified t) 378 405 (face font-lock-keyword-face fontified t) 405 434 (fontified t) 434 478 (face slime-reader-conditional-face fontified t) 478 489 (fontified t) 489 492 (face font-lock-comment-delimiter-face fontified t) 492 565 (face font-lock-comment-face fontified t) 565 576 (fontified t) 576 579 (face font-lock-comment-delimiter-face fontified t) 579 633 (face font-lock-comment-face fontified t) 633 698 (fontified t) 698 703 (face font-lock-warning-face fontified t) 703 752 (fontified t) 752 755 (face font-lock-comment-delimiter-face fontified t) 755 756 (face font-lock-comment-face fontified t) 756 830 (face font-lock-comment-face fontified t) 830 844 (fontified t) 844 847 (face font-lock-keyword-face fontified t) 847 910 (fontified t) 910 912 (face font-lock-keyword-face fontified t) 912 1037 (fontified t) 1037 1042 (face font-lock-keyword-face fontified t) 1042 1103 (fontified t) 1103 1106 (face font-lock-comment-delimiter-face fontified t) 1106 1133 (face font-lock-comment-face fontified t) 1133 1155 (fontified t) 1155 1159 (face font-lock-keyword-face fontified t) 1159 1258 (fontified t) 1258 1261 (face font-lock-comment-delimiter-face fontified t) 1261 1288 (face font-lock-comment-face fontified t) 1288 1340 (fontified t) 1340 1343 (face font-lock-comment-delimiter-face fontified t) 1343 1404 (face font-lock-comment-face fontified t) 1404 1424 (fontified t) 1424 1429 (face font-lock-warning-face fontified t) 1429 1445 (fontified t)) . -10237) (undo-tree-id6 . -1445) (undo-tree-id7 . -173) (undo-tree-id8 . -434) (undo-tree-id9 . -436) (undo-tree-id10 . -830) (undo-tree-id11 . -109) (undo-tree-id12 . -239) (undo-tree-id13 . -417) (undo-tree-id14 . -417) (undo-tree-id15 . -417) (undo-tree-id16 . -417) (undo-tree-id17 . -417) (undo-tree-id18 . -417) (undo-tree-id19 . -417) (undo-tree-id20 . -417) (undo-tree-id21 . -526) (undo-tree-id22 . -526) (undo-tree-id23 . -526) (undo-tree-id24 . -526) (undo-tree-id25 . -526) (undo-tree-id26 . -1404) 11682 (t 26976 12374 0 0)) nil (26976 14033 337962 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12284 . 12285) (nil fontified nil 10237 . 12285) (10237 . 12285)) nil (26976 14033 337948 0) 0 nil])
([nil nil ((12285 . 12286)) nil (26976 14033 337947 0) 0 nil])
([nil nil ((#(")" 0 1 (rear-nonsticky t fontified t)) . -12284) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (#(")" 0 1 (fontified t)) . -12285) (undo-tree-id4 . -1) (undo-tree-id5 . -1) 12286) nil (26976 14033 337945 0) 0 nil])
([nil nil ((12284 . 12285)) nil (26976 14033 337927 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-result  (gensym \"RES\"))
        (g-retry-token (gensym \"RETRY\")))
    `(let ((,g-attempt 0)
           (,g-retries ,retries)
           (,g-sleep ,sleep-ms))
       (loop
         (let ((,g-result
                 (handler-case
                     ;; On capture les valeurs de retour dans une liste
                     (multiple-value-list
                      (ensure-connection
                        #+postmodern
                        (postmodern:with-transaction () ,@body)
                        #-postmodern
                        (progn ,@body)))

                   ;; 1. Erreur Métier : On la relance IMMEDIATEMENT.
                   ;; Cela sort du LET, sort du LOOP, et remonte au Middleware.
                   (lumen.core.error:application-error (c)
                     (error c))
                   
                   ;; 2. Erreur Technique : On analyse si on doit réessayer
                   (condition (c)
                     (let ((mapped (lumen.data.errors:map-db-error c)))
                       (if (and (< ,g-attempt ,g-retries)
                                (lumen.data.errors:retryable-db-error-p mapped))
                           (progn
                             (incf ,g-attempt)
                             (when (plusp ,g-sleep)
                               (sleep (/ (max 0 ,g-sleep) 1000.0)))
                             ;; On renvoie un token spécial pour dire \"c'est pas fini\"
                             ',g-retry-token)
                           
                           ;; Sinon, c'est une vraie erreur fatale
                           (error mapped)))))))

           ;; C'est ICI que se fait le contrôle de flux, hors du handler-case
           ;; Si le résultat n'est pas le token de retry, on quitte la boucle proprement
           (unless (eq ,g-result ',g-retry-token)
             (return (values-list ,g-result))))))))
" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 42 (fontified t) 42 45 (face font-lock-keyword-face fontified t) 45 66 (fontified t) 66 71 (face font-lock-string-face fontified t) 71 101 (fontified t) 101 106 (face font-lock-string-face fontified t) 106 136 (fontified t) 136 143 (face font-lock-string-face fontified t) 143 173 (fontified t) 173 178 (face font-lock-string-face fontified t) 178 212 (fontified t) 212 219 (face font-lock-string-face fontified t) 219 229 (fontified t) 229 232 (face font-lock-keyword-face fontified t) 232 323 (fontified t) 323 327 (face font-lock-keyword-face fontified t) 327 338 (fontified t) 338 341 (face font-lock-keyword-face fontified t) 341 372 (fontified t) 372 384 (face font-lock-keyword-face fontified t) 384 406 (fontified t) 406 409 (face font-lock-comment-delimiter-face fontified t) 409 457 (face font-lock-comment-face fontified t) 457 602 (fontified t) 602 629 (face font-lock-keyword-face fontified t) 629 665 (fontified t) 665 716 (face slime-reader-conditional-face fontified t) 716 739 (fontified t) 739 742 (face font-lock-comment-delimiter-face fontified t) 742 790 (face font-lock-comment-face fontified t) 790 809 (fontified t) 809 812 (face font-lock-comment-delimiter-face fontified t) 812 870 (face font-lock-comment-face fontified t) 870 951 (fontified t) 951 956 (face font-lock-warning-face fontified t) 956 1000 (fontified t) 1000 1003 (face font-lock-comment-delimiter-face fontified t) 1003 1057 (face font-lock-comment-face fontified t) 1057 1113 (fontified t) 1113 1116 (face font-lock-keyword-face fontified t) 1116 1187 (fontified t) 1187 1189 (face font-lock-keyword-face fontified t) 1189 1330 (fontified t) 1330 1335 (face font-lock-keyword-face fontified t) 1335 1413 (fontified t) 1413 1417 (face font-lock-keyword-face fontified t) 1417 1498 (fontified t) 1498 1503 (fontified t) 1503 1532 (fontified t) 1532 1535 (face font-lock-comment-delimiter-face fontified t) 1535 1590 (face font-lock-comment-face fontified t) 1590 1691 (fontified t) 1691 1694 (face font-lock-comment-delimiter-face fontified t) 1694 1731 (face font-lock-comment-face fontified t) 1731 1759 (fontified t) 1759 1764 (face font-lock-warning-face fontified t) 1764 1791 (fontified t) 1791 1794 (face font-lock-comment-delimiter-face fontified t) 1794 1858 (face font-lock-comment-face fontified t) 1858 1869 (fontified t) 1869 1872 (face font-lock-comment-delimiter-face fontified t) 1872 1947 (face font-lock-comment-face fontified t) 1947 1959 (fontified t) 1959 1965 (face font-lock-keyword-face fontified t) 1965 1997 (fontified t) 1997 2011 (fontified t) 2011 2017 (face font-lock-keyword-face fontified t) 2017 2048 (fontified t) 2048 2049 (fontified t)) . -10237) (undo-tree-id27 . -2048) (undo-tree-id28 . -2049) (undo-tree-id29 . -181) (undo-tree-id30 . -719) (undo-tree-id31 . -719) (undo-tree-id32 . -719) (undo-tree-id33 . -719) (undo-tree-id34 . -1057) (undo-tree-id35 . -1435) (undo-tree-id36 . -1435) (undo-tree-id37 . -1503) (undo-tree-id38 . -1503) (undo-tree-id39 . -2049) 12286 (t 26976 14033 0 0)) nil (26976 36362 307860 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12554 . 12555) (nil fontified nil 10237 . 12555) (10237 . 12555)) nil (26976 36362 307835 0) 0 nil])
([nil nil ((12555 . 12556)) nil (26976 36362 307831 0) 0 nil])
([nil nil ((12555 . 12556) (t 26976 36362 0 0)) nil (26976 36367 834148 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12555) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) 12556) nil (26976 36367 834145 0) 0 nil])
([nil nil ((#("
#|
(defmacro with-rollback (&body body)
  \"Exécute BODY dans UNE connexion Postmodern unique, BEGIN au début, ROLLBACK à la fin.
Toutes les requêtes internes partagent la même *database*.\"
  `(lumen.data.db:with-conn
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect
          (progn ,@body)
       (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 356 (face font-lock-comment-face fontified t) 356 358 (face font-lock-comment-delimiter-face fontified t) 358 359 (fontified t)) . 21177) (undo-tree-id49 . -359) (t 26976 36367 0 0)) nil (26976 37468 303524 0) 0 nil])
([nil nil ((#("
#|
(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
Options :
  :timeout-ms <int>
Si le SQL a une clause RETURNING, renvoie la 1ère ligne en alist.\"
  (format t \"~&EXEC:PARAMS: ~A~%\" params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if #'keywordp params))
	 (x (print kpos))
         (args (if kpos (subseq params 0 kpos) params))
	 (x (print args))
         (opts (if kpos (subseq params kpos) '()))
	 (x (print opts))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
	 (x (print timeout-ms))
         (t0 (get-internal-real-time)))
    (format t \"~&EXEC:ARGS: ~A~%\" args)
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                ;; Chemin RETURNING : une seule exécution, on récupère la 1ère ligne.
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                ;; Chemin sans RETURNING : voie execute (aucun résultat), n = rows affected.
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            ;; métriques
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      (condition (c)
        (translate-db-error c)))))
|#" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 495 (face font-lock-comment-face fontified t) 495 579 (face font-lock-comment-face fontified t) 579 2017 (face font-lock-comment-face fontified t) 2017 2019 (face font-lock-comment-delimiter-face fontified t)) . -16594) (undo-tree-id47 . -2019) (undo-tree-id48 . -707) 18613) nil (26976 37468 303521 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -16593) (undo-tree-id45 . -1) (undo-tree-id46 . -1) 16594) nil (26976 37468 303516 0) 0 nil])
([nil nil ((#("(declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))
        (g-result  (gensym \"RES\"))
        (g-error   (gensym \"ERR\")))
    `(block ,g-block
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         (loop
           (let ((,g-result nil)
                 (,g-error nil))
             
             ;; BLOC 1 : Tentative d'exécution protégée
             (handler-case
                 (setf ,g-result 
                       (multiple-value-list
                        (ensure-connection
                          #+postmodern
                          (postmodern:with-transaction () ,@body)
                          #-postmodern
                          (progn ,@body))))

               ;; Cas A : Erreur Métier -> On capture juste l'objet erreur
               (lumen.core.error:application-error (c)
                 (setf ,g-error c))

               ;; Cas B : Erreur Technique -> On capture et on analyse le retry
               (condition (c)
                 (let ((mapped (lumen.data.errors:map-db-error c)))
                   (if (and (< ,g-attempt ,g-retries)
                            (lumen.data.errors:retryable-db-error-p mapped))
                       ;; C'est un retry -> on ne setf pas g-error, le loop continuera
                       (progn
                         (incf ,g-attempt)
                         (when (plusp ,g-sleep)
                           (sleep (/ (max 0 ,g-sleep) 1000.0))))
                       
                       ;; C'est fatal -> on capture l'erreur mappée
                       (setf ,g-error mapped)))))

             ;; BLOC 2 : Action hors du contexte protégé (Safe Zone)
             (cond
               ;; S'il y a une erreur capturée, on la relance ICI, 
               ;; alors que la stack transactionnelle est déjà propre.
               (,g-error 
                (error ,g-error))
               
               ;; Si on a un résultat, on retourne
               (,g-result 
                (return-from ,g-block (values-list ,g-result)))
               
               ;; Sinon (cas du retry), on laisse la boucle (loop) continuer
               (t nil))))))))" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 42 (fontified t) 42 45 (face font-lock-keyword-face fontified t) 45 66 (fontified t) 66 71 (face font-lock-string-face fontified t) 71 101 (fontified t) 101 106 (face font-lock-string-face fontified t) 106 136 (fontified t) 136 143 (face font-lock-string-face fontified t) 143 173 (fontified t) 173 178 (face font-lock-string-face fontified t) 178 208 (fontified t) 208 213 (face font-lock-string-face fontified t) 213 243 (fontified t) 243 248 (face font-lock-string-face fontified t) 248 258 (fontified t) 258 263 (face font-lock-keyword-face fontified t) 263 281 (fontified t) 281 284 (face font-lock-keyword-face fontified t) 284 381 (fontified t) 381 385 (face font-lock-keyword-face fontified t) 385 398 (fontified t) 398 401 (face font-lock-keyword-face fontified t) 401 479 (fontified t) 479 482 (face font-lock-comment-delimiter-face fontified t) 482 522 (face font-lock-comment-face fontified t) 522 536 (fontified t) 536 548 (face font-lock-keyword-face fontified t) 548 736 (fontified t) 736 756 (face font-lock-keyword-face fontified t) 756 763 (face font-lock-keyword-face fontified t) 763 775 (fontified t) 775 801 (fontified t) 801 854 (face slime-reader-conditional-face fontified t) 854 874 (fontified t) 874 877 (face font-lock-comment-delimiter-face fontified t) 877 934 (face font-lock-comment-face fontified t) 934 1041 (fontified t) 1041 1044 (face font-lock-comment-delimiter-face fontified t) 1044 1106 (face font-lock-comment-face fontified t) 1106 1154 (fontified t) 1154 1157 (face font-lock-keyword-face fontified t) 1157 1224 (fontified t) 1224 1226 (face font-lock-keyword-face fontified t) 1226 1358 (fontified t) 1358 1361 (face font-lock-comment-delimiter-face fontified t) 1361 1422 (face font-lock-comment-face fontified t) 1422 1446 (fontified t) 1446 1451 (face font-lock-keyword-face fontified t) 1451 1521 (fontified t) 1521 1525 (face font-lock-keyword-face fontified t) 1525 1655 (fontified t) 1655 1658 (face font-lock-comment-delimiter-face fontified t) 1658 1700 (face font-lock-comment-face fontified t) 1700 1764 (fontified t) 1764 1767 (face font-lock-comment-delimiter-face fontified t) 1767 1820 (face font-lock-comment-face fontified t) 1820 1834 (fontified t) 1834 1838 (face font-lock-keyword-face fontified t) 1838 1854 (fontified t) 1854 1857 (face font-lock-comment-delimiter-face fontified t) 1857 1907 (face font-lock-comment-face fontified t) 1907 1922 (fontified t) 1922 1925 (face font-lock-comment-delimiter-face fontified t) 1925 1978 (face font-lock-comment-face fontified t) 1978 2021 (fontified t) 2021 2026 (face font-lock-warning-face fontified t) 2026 2069 (fontified t) 2069 2072 (face font-lock-comment-delimiter-face fontified t) 2072 2105 (face font-lock-comment-face fontified t) 2105 2149 (fontified t) 2149 2160 (face font-lock-keyword-face fontified t) 2160 2227 (fontified t) 2227 2230 (face font-lock-comment-delimiter-face fontified t) 2230 2275 (face font-lock-comment-face fontified t) 2275 2289 (face font-lock-comment-face fontified t) 2289 2318 (fontified t)) . -10237) (undo-tree-id2 . -2318) (undo-tree-id3 . -1136) (undo-tree-id4 . -1162) (undo-tree-id5 . -801) (undo-tree-id6 . -803) (undo-tree-id7 . -2289) (undo-tree-id8 . -2053) (undo-tree-id9 . -2289) 12555 (t 26976 37468 0 0)) nil (26976 39101 245139 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12934 . 12935) (nil fontified nil 10237 . 12935) (10237 . 12935)) nil (26976 39101 245132 0) 0 nil])
([nil nil ((12935 . 12936)) nil (26976 39101 245130 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -12935) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 12936) nil (26976 39101 245127 0) 0 nil])
([nil nil ((12935 . 12937) (t 26976 39101 0 0)) nil (26976 39351 828202 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16444 . 16445) (nil fontified nil 12937 . 16445) (12937 . 16445)) nil (26976 39351 828201 0) 0 nil])
([nil nil ((9475 . 9477)) nil (26976 39351 828200 0) 0 nil])
([nil nil ((12938 . 12940)) nil (26976 39351 828199 0) 0 nil])
([nil nil ((12940 . 12941)) nil (26976 39351 828195 0) 0 nil])
([nil nil ((12941 . 12943) (t 26976 39351 0 0)) nil (26976 39794 249591 0) 0 nil])
([nil nil ((16453 . 16455)) nil (26976 39794 249590 0) 0 nil])
([nil nil ((16455 . 16457)) nil (26976 39794 249590 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19466 . 19467) (nil fontified nil 16457 . 19467) (16457 . 19467)) nil (26976 39794 249588 0) 0 nil])
([nil nil ((19467 . 19468)) nil (26976 39794 249584 0) 0 nil])
([nil nil ((#("
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))
        (g-outcome (gensym \"OUT\"))
        (g-payload (gensym \"PAY\")))
    
    `(block ,g-block
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         
         (loop
           (multiple-value-bind (,g-outcome ,g-payload)
               (handler-case
                   ;; EXÉCUTION
                   (values :success 
                           (multiple-value-list
                            (ensure-connection
                              #+postmodern
                              (postmodern:with-transaction () ,@body)
                              #-postmodern
                              (progn ,@body))))

                 ;; Cas A : Business Error (On capture Type + Message)
                 ;; On ne retourne PAS l'objet condition 'c' pour éviter le bug SBCL
                 (lumen.core.error:application-error (c)
                   (values :app-error 
                           (list (type-of c) (princ-to-string c))))

                 ;; Cas B : Erreur DB (On capture l'objet mappé, c'est safe ici)
                 (condition (c)
                   (let ((mapped (lumen.data.errors:map-db-error c)))
                     (if (and (< ,g-attempt ,g-retries)
                              (lumen.data.errors:retryable-db-error-p mapped))
                         (values :retry nil)
                         (values :db-error mapped)))))
             
             ;; SORTIE DE ZONE (Safe Zone)
             (case ,g-outcome
               (:success
                (return-from ,g-block (values-list ,g-payload)))
               
               ;; CLONAGE DE L'ERREUR MÉTIER (Le Fix)
               (:app-error
                (destructuring-bind (err-type err-msg) ,g-payload
                  ;; On nettoie le message car princ-to-string inclut parfois le préfixe du Report
                  ;; ex: \"Business Error: XXX\" -> \"XXX\"
                  (let* ((prefix \"Business Error: \")
                         (clean-msg (if (search prefix err-msg) 
                                        (subseq err-msg (length prefix)) 
                                        err-msg)))
                    ;; On signale une NOUVELLE instance.
                    ;; On suppose que l'erreur accepte :message (ce qui est le cas de business-error)
                    (error (make-condition err-type :message clean-msg)))))
               
               ;; Erreur DB standard
               (:db-error
                (error ,g-payload))
               
               (:retry
                (incf ,g-attempt)
                (when (plusp ,g-sleep)
                  (sleep (/ (max 0 ,g-sleep) 1000.0)))))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 21 (fontified t) 21 25 (face font-lock-type-face fontified t) 25 37 (fontified t) 37 52 (face font-lock-builtin-face fontified t) 52 141 (fontified t) 141 146 (face font-lock-type-face fontified t) 146 156 (fontified t) 156 163 (face font-lock-keyword-face fontified t) 163 197 (fontified t) 197 200 (face font-lock-keyword-face fontified t) 200 221 (fontified t) 221 226 (face font-lock-string-face fontified t) 226 256 (fontified t) 256 261 (face font-lock-string-face fontified t) 261 291 (fontified t) 291 298 (face font-lock-string-face fontified t) 298 328 (fontified t) 328 333 (face font-lock-string-face fontified t) 333 363 (fontified t) 363 368 (face font-lock-string-face fontified t) 368 398 (fontified t) 398 403 (face font-lock-string-face fontified t) 403 418 (fontified t) 418 423 (face font-lock-keyword-face fontified t) 423 441 (fontified t) 441 444 (face font-lock-keyword-face fontified t) 444 551 (fontified t) 551 555 (face font-lock-keyword-face fontified t) 555 568 (fontified t) 568 587 (face font-lock-keyword-face fontified t) 587 628 (fontified t) 628 640 (face font-lock-keyword-face fontified t) 640 660 (fontified t) 660 663 (face font-lock-comment-delimiter-face fontified t) 663 673 (face font-lock-comment-face fontified t) 673 700 (fontified t) 700 708 (face font-lock-builtin-face fontified t) 708 879 (fontified t) 879 906 (face font-lock-keyword-face fontified t) 906 948 (fontified t) 948 1005 (face slime-reader-conditional-face fontified t) 1005 1027 (fontified t) 1027 1030 (face font-lock-comment-delimiter-face fontified t) 1030 1081 (face font-lock-comment-face fontified t) 1081 1098 (fontified t) 1098 1101 (face font-lock-comment-delimiter-face fontified t) 1101 1166 (face font-lock-comment-face fontified t) 1166 1250 (fontified t) 1250 1260 (face font-lock-builtin-face fontified t) 1260 1348 (fontified t) 1348 1351 (face font-lock-comment-delimiter-face fontified t) 1351 1412 (face font-lock-comment-face fontified t) 1412 1464 (fontified t) 1464 1467 (face font-lock-keyword-face fontified t) 1467 1501 (fontified t) 1501 1514 (fontified t) 1514 1536 (fontified t) 1536 1538 (face font-lock-keyword-face fontified t) 1538 1682 (fontified t) 1682 1688 (face font-lock-builtin-face fontified t) 1688 1727 (fontified t) 1727 1736 (face font-lock-builtin-face fontified t) 1736 1776 (fontified t) 1776 1779 (face font-lock-comment-delimiter-face fontified t) 1779 1806 (face font-lock-comment-face fontified t) 1806 1820 (fontified t) 1820 1824 (face font-lock-keyword-face fontified t) 1824 1852 (fontified t) 1852 1860 (face font-lock-builtin-face fontified t) 1860 1878 (fontified t) 1878 1889 (face font-lock-keyword-face fontified t) 1889 1957 (fontified t) 1957 1960 (face font-lock-comment-delimiter-face fontified t) 1960 1996 (face font-lock-comment-face fontified t) 1996 2012 (fontified t) 2012 2022 (face font-lock-builtin-face fontified t) 2022 2040 (fontified t) 2040 2058 (face font-lock-keyword-face fontified t) 2058 2107 (fontified t) 2107 2110 (face font-lock-comment-delimiter-face fontified t) 2110 2188 (face font-lock-comment-face fontified t) 2188 2206 (fontified t) 2206 2209 (face font-lock-comment-delimiter-face fontified t) 2209 2244 (face font-lock-comment-face fontified t) 2244 2263 (fontified t) 2263 2267 (face font-lock-keyword-face fontified t) 2267 2277 (fontified t) 2277 2295 (face font-lock-string-face fontified t) 2295 2334 (fontified t) 2334 2336 (face font-lock-keyword-face fontified t) 2336 2507 (fontified t) 2507 2510 (face font-lock-comment-delimiter-face fontified t) 2510 2544 (face font-lock-comment-face fontified t) 2544 2564 (fontified t) 2564 2567 (face font-lock-comment-delimiter-face fontified t) 2567 2646 (face font-lock-comment-face fontified t) 2646 2667 (fontified t) 2667 2672 (face font-lock-warning-face fontified t) 2672 2698 (fontified t) 2698 2706 (face font-lock-builtin-face fontified t) 2706 2753 (fontified t) 2753 2756 (face font-lock-comment-delimiter-face fontified t) 2756 2775 (face font-lock-comment-face fontified t) 2775 2791 (fontified t) 2791 2800 (face font-lock-builtin-face fontified t) 2800 2818 (fontified t) 2818 2823 (face font-lock-warning-face fontified t) 2823 2869 (fontified t) 2869 2875 (face font-lock-builtin-face fontified t) 2875 2927 (fontified t) 2927 2931 (face font-lock-keyword-face fontified t) 2931 2949 (fontified t) 2949 3010 (fontified t) 3010 3011 (rear-nonsticky t fontified t) 3011 3012 (fontified t)) . -16456) (undo-tree-id0 . -3012) (undo-tree-id1 . -3012) (undo-tree-id2 . -1926) (undo-tree-id3 . -1926) (undo-tree-id4 . -3012) (undo-tree-id5 . -1330) (undo-tree-id6 . -3012) (undo-tree-id7 . -2089) (undo-tree-id8 . -1) (undo-tree-id9 . -3012) 19468 (t 26976 39794 0 0)) nil (26976 40260 68534 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19186 . 19187) (nil fontified nil 16456 . 19187) (16456 . 19187)) nil (26976 40260 68510 0) 0 nil])
([nil nil ((19187 . 19188)) nil (26976 40260 68506 0) 0 nil])
([nil nil ((#("#|
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
		      (retries 0) (sleep-ms 50))
                   &body body)
  \"Execute BODY in a DB transaction. ISOLATION is one of
:READ-COMMITTED :REPEATABLE-READ :SERIALIZABLE. READ-ONLY is advisory.
RETRIES: number of automatic retries on transient deadlock/timeouts.

Transaction avec **retries** automatiques sur erreurs retryables (deadlock/serialization/timeout).
Arguments :
  :isolation  — décoratif pour l’instant (hook possible si tu veux paramétrer).
  :read-only  — décoratif / futur.
  :retries    — nombre de tentatives additionnelles (0 = pas de retry).
  :sleep-ms   — temps d’attente entre tentatives (backoff linéaire simple).
Exemple : (with-tx (:retries 3 :sleep-ms 100) ...)\"
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))     ;; Bloc de sortie global
        (g-outcome (gensym \"OUT\"))     ;; Résultat de l'exécution (:success, :retry, :error)
        (g-payload (gensym \"PAY\")))    ;; Donnée associée (valeurs ou condition)
    
    `(block ,g-block
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         
         ;; BOUCLE DE RETRY
         (loop
           ;; 1. EXÉCUTION PROTÉGÉE
           ;; On capture tout ce qui se passe et on le stocke dans des variables.
           ;; On ne fait AUCUN saut (return/error) ici.
           (multiple-value-bind (,g-outcome ,g-payload)
               (handler-case
                   ;; Essai nominal
                   (values :success 
                           (multiple-value-list
                            (ensure-connection
                              #+postmodern
                              (postmodern:with-transaction () ,@body)
                              #-postmodern
                              (progn ,@body))))
                 
                 ;; Cas A : Erreur Métier (Business/Application Error)
                 ;; On capture l'objet erreur et on marque comme :error (non retryable)
                 (lumen.core.error:application-error (c)
                   (values :error c))
                 
                 ;; Cas B : Erreur Technique (DB Error)
                 (condition (c)
                   (let ((mapped (lumen.data.errors:map-db-error c)))
                     (if (and (< ,g-attempt ,g-retries)
                              (lumen.data.errors:retryable-db-error-p mapped))
                         (values :retry nil) ;; On demande un retry
                         (values :error mapped))))) ;; Erreur fatale
             
             ;; 2. LOGIQUE DE CONTRÔLE (HORS TRANSACTION)
             ;; Ici, la transaction est fermée (commit ou rollback fait).
             ;; La stack est propre. On peut agir.
             (case ,g-outcome
               
               ;; SUCCÈS : On retourne les valeurs stockées
               (:success
                (return-from ,g-block (values-list ,g-payload)))
               
               ;; ERREUR : On relance l'exception (vers le middleware)
               (:error
                (error ,g-payload))
               
               ;; RETRY : On dort et on laisse le (loop) refaire un tour
               (:retry
                (incf ,g-attempt)
                (when (plusp ,g-sleep)
                  (sleep (/ (max 0 ,g-sleep) 1000.0)))))))))))
|#
#|
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  (let ((g-attempt (gensym \"ATT\"))
        (g-retries (gensym \"RET\"))
        (g-sleep   (gensym \"SLEEP\"))
        (g-block   (gensym \"BLK\"))
        (g-outcome (gensym \"OUT\"))
        (g-payload (gensym \"PAY\")))
    
    `(block ,g-block
       (format *terminal-io* \"~&[TX-DEBUG] >>> DÉBUT BLOC with-tx~%\")
       (let ((,g-attempt 0)
             (,g-retries ,retries)
             (,g-sleep ,sleep-ms))
         
         (loop
           (format *terminal-io* \"~&[TX-DEBUG] --- Début LOOP (Essai ~A) ---~%\" ,g-attempt)
           
           (multiple-value-bind (,g-outcome ,g-payload)
               (handler-case
                   (progn
                     (format *terminal-io* \"~&[TX-DEBUG] Avant ensure-connection~%\")
                     (let ((res 
                            (ensure-connection
                              #+postmodern
                              (postmodern:with-transaction ()
                                (format *terminal-io* \"~&[TX-DEBUG] DEDANS Transaction DB. Exécution du BODY...~%\")
                                (let ((r (progn ,@body)))
                                  (format *terminal-io* \"~&[TX-DEBUG] BODY terminé avec SUCCÈS.~%\")
                                  r))
                              #-postmodern
                              (progn ,@body))))
                       
                       (format *terminal-io* \"~&[TX-DEBUG] Transaction COMMITÉE.~%\")
                       (values :success (multiple-value-list res))))

                 ;; Cas A : Business Error
                 (qalm.backend.core.error:business-error (c)
                   (format *terminal-io* \"~&[TX-DEBUG] !!! CATCHED BUSINESS-ERROR: ~A~%\" c)
                   (values :error c))

                 ;; Cas B : Erreur générique (pour voir ce qui tombe vraiment)
                 (error (c)
                   (format *terminal-io* \"~&[TX-DEBUG] !!! CATCHED ERROR (Type: ~S): ~A~%\" (type-of c) c)
                   (let ((mapped (lumen.data.errors:map-db-error c)))
                     (if (and (< ,g-attempt ,g-retries)
                              (lumen.data.errors:retryable-db-error-p mapped))
                         (progn
                           (format *terminal-io* \"~&[TX-DEBUG] -> Retryable~%\")
                           (values :retry nil))
                         (progn
                           (format *terminal-io* \"~&[TX-DEBUG] -> FATAL DB Error~%\")
                           (values :error mapped))))))
             
             ;; ZONE DE SÉCURITÉ
             (format *terminal-io* \"~&[TX-DEBUG] HORS handler-case. Outcome: ~A~%\" ,g-outcome)
             
             (case ,g-outcome
               (:success
                (format *terminal-io* \"~&[TX-DEBUG] <<< RETOUR SUCCÈS~%\")
                (return-from ,g-block (values-list ,g-payload)))
               
               (:error
                (format *terminal-io* \"~&[TX-DEBUG] <<< RELANCE ERREUR (Signal)~%\")
                ;; C'est souvent ICI que le CONTROL-ERROR arrive
                (error ,g-payload))
               
               (:retry
                (format *terminal-io* \"~&[TX-DEBUG] ... Sleeping for retry ...~%\")
                (incf ,g-attempt)
                (when (plusp ,g-sleep)
                  (sleep (/ (max 0 ,g-sleep) 1000.0)))))))))))
|#" 0 2 (face font-lock-comment-delimiter-face fontified t) 2 3 (face font-lock-comment-face fontified t) 3 4 (face font-lock-comment-face fontified t) 4 12 (face font-lock-comment-face fontified t) 12 13 (face font-lock-comment-face fontified t) 13 20 (face font-lock-comment-face fontified t) 20 23 (face font-lock-comment-face fontified t) 23 27 (face font-lock-comment-face fontified t) 27 39 (face font-lock-comment-face fontified t) 39 54 (face font-lock-comment-face fontified t) 54 72 (face font-lock-comment-face fontified t) 72 126 (face font-lock-comment-face fontified t) 126 131 (face font-lock-comment-face fontified t) 131 140 (face font-lock-comment-face fontified t) 140 761 (face font-lock-comment-face fontified t) 761 765 (face font-lock-comment-face fontified t) 765 772 (face font-lock-comment-face fontified t) 772 806 (face font-lock-comment-face fontified t) 806 809 (face font-lock-comment-face fontified t) 809 830 (face font-lock-comment-face fontified t) 830 835 (face font-lock-comment-face fontified t) 835 865 (face font-lock-comment-face fontified t) 865 870 (face font-lock-comment-face fontified t) 870 900 (face font-lock-comment-face fontified t) 900 907 (face font-lock-comment-face fontified t) 907 937 (face font-lock-comment-face fontified t) 937 942 (face font-lock-comment-face fontified t) 942 949 (face font-lock-comment-face fontified t) 949 952 (face font-lock-comment-face fontified t) 952 974 (face font-lock-comment-face fontified t) 974 1001 (face font-lock-comment-face fontified t) 1001 1006 (face font-lock-comment-face fontified t) 1006 1013 (face font-lock-comment-face fontified t) 1013 1016 (face font-lock-comment-face fontified t) 1016 1067 (face font-lock-comment-face fontified t) 1067 1094 (face font-lock-comment-face fontified t) 1094 1099 (face font-lock-comment-face fontified t) 1099 1106 (face font-lock-comment-face fontified t) 1106 1109 (face font-lock-comment-face fontified t) 1109 1148 (face font-lock-comment-face fontified t) 1148 1159 (face font-lock-comment-face fontified t) 1159 1164 (face font-lock-comment-face fontified t) 1164 1182 (face font-lock-comment-face fontified t) 1182 1185 (face font-lock-comment-face fontified t) 1185 1243 (face font-lock-comment-face fontified t) 1243 1272 (face font-lock-comment-face fontified t) 1272 1291 (face font-lock-comment-face fontified t) 1291 1294 (face font-lock-comment-face fontified t) 1294 1310 (face font-lock-comment-face fontified t) 1310 1320 (face font-lock-comment-face fontified t) 1320 1324 (face font-lock-comment-face fontified t) 1324 1336 (face font-lock-comment-face fontified t) 1336 1339 (face font-lock-comment-face fontified t) 1339 1361 (face font-lock-comment-face fontified t) 1361 1372 (face font-lock-comment-face fontified t) 1372 1375 (face font-lock-comment-face fontified t) 1375 1443 (face font-lock-comment-face fontified t) 1443 1454 (face font-lock-comment-face fontified t) 1454 1457 (face font-lock-comment-face fontified t) 1457 1499 (face font-lock-comment-face fontified t) 1499 1511 (face font-lock-comment-face fontified t) 1511 1530 (face font-lock-comment-face fontified t) 1530 1571 (face font-lock-comment-face fontified t) 1571 1572 (face font-lock-comment-face fontified t) 1572 1583 (face font-lock-comment-face fontified t) 1583 1584 (face font-lock-comment-face fontified t) 1584 1603 (face font-lock-comment-face fontified t) 1603 1606 (face font-lock-comment-face fontified t) 1606 1620 (face font-lock-comment-face fontified t) 1620 1647 (face font-lock-comment-face fontified t) 1647 1655 (face font-lock-comment-face fontified t) 1655 1826 (face font-lock-comment-face fontified t) 1826 1853 (face font-lock-comment-face fontified t) 1853 1895 (face font-lock-comment-face fontified t) 1895 1952 (face font-lock-comment-face fontified t) 1952 1991 (face font-lock-comment-face fontified t) 1991 1994 (face font-lock-comment-face fontified t) 1994 2045 (face font-lock-comment-face fontified t) 2045 2062 (face font-lock-comment-face fontified t) 2062 2065 (face font-lock-comment-face fontified t) 2065 2133 (face font-lock-comment-face fontified t) 2133 2217 (face font-lock-comment-face fontified t) 2217 2223 (face font-lock-comment-face fontified t) 2223 2263 (face font-lock-comment-face fontified t) 2263 2266 (face font-lock-comment-face fontified t) 2266 2302 (face font-lock-comment-face fontified t) 2302 2354 (face font-lock-comment-face fontified t) 2354 2357 (face font-lock-comment-face fontified t) 2357 2426 (face font-lock-comment-face fontified t) 2426 2428 (face font-lock-comment-face fontified t) 2428 2572 (face font-lock-comment-face fontified t) 2572 2578 (face font-lock-comment-face fontified t) 2578 2584 (face font-lock-comment-face fontified t) 2584 2587 (face font-lock-comment-face fontified t) 2587 2607 (face font-lock-comment-face fontified t) 2607 2640 (face font-lock-comment-face fontified t) 2640 2646 (face font-lock-comment-face fontified t) 2646 2659 (face font-lock-comment-face fontified t) 2659 2662 (face font-lock-comment-face fontified t) 2662 2676 (face font-lock-comment-face fontified t) 2676 2703 (face font-lock-comment-face fontified t) 2703 2706 (face font-lock-comment-face fontified t) 2706 2748 (face font-lock-comment-face fontified t) 2748 2761 (face font-lock-comment-face fontified t) 2761 2764 (face font-lock-comment-face fontified t) 2764 2772 (face font-lock-comment-face fontified t) 2772 2822 (face font-lock-comment-face fontified t) 2822 2835 (face font-lock-comment-face fontified t) 2835 2838 (face font-lock-comment-face fontified t) 2838 2873 (face font-lock-comment-face fontified t) 2873 2887 (face font-lock-comment-face fontified t) 2887 2891 (face font-lock-comment-face fontified t) 2891 2934 (face font-lock-comment-face fontified t) 2934 2937 (face font-lock-comment-face fontified t) 2937 2979 (face font-lock-comment-face fontified t) 2979 2995 (face font-lock-comment-face fontified t) 2995 3003 (face font-lock-comment-face fontified t) 3003 3021 (face font-lock-comment-face fontified t) 3021 3032 (face font-lock-comment-face fontified t) 3032 3084 (face font-lock-comment-face fontified t) 3084 3085 (face font-lock-comment-face fontified t) 3085 3100 (face font-lock-comment-face fontified t) 3100 3103 (face font-lock-comment-face fontified t) 3103 3156 (face font-lock-comment-face fontified t) 3156 3172 (face font-lock-comment-face fontified t) 3172 3178 (face font-lock-comment-face fontified t) 3178 3196 (face font-lock-comment-face fontified t) 3196 3201 (face font-lock-comment-face fontified t) 3201 3246 (face font-lock-comment-face fontified t) 3246 3249 (face font-lock-comment-face fontified t) 3249 3304 (face font-lock-comment-face fontified t) 3304 3320 (face font-lock-comment-face fontified t) 3320 3326 (face font-lock-comment-face fontified t) 3326 3378 (face font-lock-comment-face fontified t) 3378 3382 (face font-lock-comment-face fontified t) 3382 3400 (face font-lock-comment-face fontified t) 3400 3463 (face font-lock-comment-face fontified t) 3463 3465 (face font-lock-comment-delimiter-face fontified t) 3465 3466 (fontified t) 3466 3468 (face font-lock-comment-delimiter-face fontified t) 3468 3469 (face font-lock-comment-face fontified t) 3469 3470 (face font-lock-comment-face fontified t) 3470 3478 (face font-lock-comment-face fontified t) 3478 3479 (face font-lock-comment-face fontified t) 3479 3486 (face font-lock-comment-face fontified t) 3486 3489 (face font-lock-comment-face fontified t) 3489 3493 (face font-lock-comment-face fontified t) 3493 3505 (face font-lock-comment-face fontified t) 3505 3520 (face font-lock-comment-face fontified t) 3520 3609 (face font-lock-comment-face fontified t) 3609 3614 (face font-lock-comment-face fontified t) 3614 3624 (face font-lock-comment-face fontified t) 3624 3631 (face font-lock-comment-face fontified t) 3631 3665 (face font-lock-comment-face fontified t) 3665 3668 (face font-lock-comment-face fontified t) 3668 3689 (face font-lock-comment-face fontified t) 3689 3694 (face font-lock-comment-face fontified t) 3694 3724 (face font-lock-comment-face fontified t) 3724 3729 (face font-lock-comment-face fontified t) 3729 3759 (face font-lock-comment-face fontified t) 3759 3766 (face font-lock-comment-face fontified t) 3766 3796 (face font-lock-comment-face fontified t) 3796 3801 (face font-lock-comment-face fontified t) 3801 3831 (face font-lock-comment-face fontified t) 3831 3836 (face font-lock-comment-face fontified t) 3836 3866 (face font-lock-comment-face fontified t) 3866 3871 (face font-lock-comment-face fontified t) 3871 3886 (face font-lock-comment-face fontified t) 3886 3891 (face font-lock-comment-face fontified t) 3891 3930 (face font-lock-comment-face fontified t) 3930 3969 (face font-lock-comment-face fontified t) 3969 3979 (face font-lock-comment-face fontified t) 3979 3982 (face font-lock-comment-face fontified t) 3982 4089 (face font-lock-comment-face fontified t) 4089 4093 (face font-lock-comment-face fontified t) 4093 4127 (face font-lock-comment-face fontified t) 4127 4173 (face font-lock-comment-face fontified t) 4173 4210 (face font-lock-comment-face fontified t) 4210 4229 (face font-lock-comment-face fontified t) 4229 4270 (face font-lock-comment-face fontified t) 4270 4282 (face font-lock-comment-face fontified t) 4282 4303 (face font-lock-comment-face fontified t) 4303 4308 (face font-lock-comment-face fontified t) 4308 4352 (face font-lock-comment-face fontified t) 4352 4392 (face font-lock-comment-face fontified t) 4392 4416 (face font-lock-comment-face fontified t) 4416 4419 (face font-lock-comment-face fontified t) 4419 4548 (face font-lock-comment-face fontified t) 4548 4575 (face font-lock-comment-face fontified t) 4575 4590 (face font-lock-comment-face fontified t) 4590 4633 (face font-lock-comment-face fontified t) 4633 4693 (face font-lock-comment-face fontified t) 4693 4695 (face font-lock-comment-face fontified t) 4695 4728 (face font-lock-comment-face fontified t) 4728 4731 (face font-lock-comment-face fontified t) 4731 4737 (face font-lock-comment-face fontified t) 4737 4742 (face font-lock-comment-face fontified t) 4742 4809 (face font-lock-comment-face fontified t) 4809 4851 (face font-lock-comment-face fontified t) 4851 4921 (face font-lock-comment-face fontified t) 4921 4967 (face font-lock-comment-face fontified t) 4967 4969 (face font-lock-comment-face fontified t) 4969 4978 (face font-lock-comment-face fontified t) 4978 4982 (face font-lock-comment-face fontified t) 4982 5051 (face font-lock-comment-face fontified t) 5051 5089 (face font-lock-comment-face fontified t) 5089 5122 (face font-lock-comment-face fontified t) 5122 5130 (face font-lock-comment-face fontified t) 5130 5178 (face font-lock-comment-face fontified t) 5178 5181 (face font-lock-comment-face fontified t) 5181 5204 (face font-lock-comment-face fontified t) 5204 5306 (face font-lock-comment-face fontified t) 5306 5353 (face font-lock-comment-face fontified t) 5353 5384 (face font-lock-comment-face fontified t) 5384 5390 (face font-lock-comment-face fontified t) 5390 5413 (face font-lock-comment-face fontified t) 5413 5416 (face font-lock-comment-face fontified t) 5416 5475 (face font-lock-comment-face fontified t) 5475 5493 (face font-lock-comment-face fontified t) 5493 5498 (face font-lock-comment-face fontified t) 5498 5544 (face font-lock-comment-face fontified t) 5544 5593 (face font-lock-comment-face fontified t) 5593 5629 (face font-lock-comment-face fontified t) 5629 5632 (face font-lock-comment-face fontified t) 5632 5701 (face font-lock-comment-face fontified t) 5701 5703 (face font-lock-comment-face fontified t) 5703 5840 (face font-lock-comment-face fontified t) 5840 5845 (face font-lock-comment-face fontified t) 5845 5895 (face font-lock-comment-face fontified t) 5895 5924 (face font-lock-comment-face fontified t) 5924 5961 (face font-lock-comment-face fontified t) 5961 5967 (face font-lock-comment-face fontified t) 5967 6000 (face font-lock-comment-face fontified t) 6000 6005 (face font-lock-comment-face fontified t) 6005 6055 (face font-lock-comment-face fontified t) 6055 6089 (face font-lock-comment-face fontified t) 6089 6126 (face font-lock-comment-face fontified t) 6126 6132 (face font-lock-comment-face fontified t) 6132 6173 (face font-lock-comment-face fontified t) 6173 6176 (face font-lock-comment-face fontified t) 6176 6193 (face font-lock-comment-face fontified t) 6193 6228 (face font-lock-comment-face fontified t) 6228 6275 (face font-lock-comment-face fontified t) 6275 6316 (face font-lock-comment-face fontified t) 6316 6320 (face font-lock-comment-face fontified t) 6320 6348 (face font-lock-comment-face fontified t) 6348 6356 (face font-lock-comment-face fontified t) 6356 6395 (face font-lock-comment-face fontified t) 6395 6429 (face font-lock-comment-face fontified t) 6429 6448 (face font-lock-comment-face fontified t) 6448 6459 (face font-lock-comment-face fontified t) 6459 6482 (face font-lock-comment-face fontified t) 6482 6496 (face font-lock-comment-face fontified t) 6496 6528 (face font-lock-comment-face fontified t) 6528 6534 (face font-lock-comment-face fontified t) 6534 6573 (face font-lock-comment-face fontified t) 6573 6617 (face font-lock-comment-face fontified t) 6617 6635 (face font-lock-comment-face fontified t) 6635 6638 (face font-lock-comment-face fontified t) 6638 6684 (face font-lock-comment-face fontified t) 6684 6701 (face font-lock-comment-face fontified t) 6701 6706 (face font-lock-comment-face fontified t) 6706 6752 (face font-lock-comment-face fontified t) 6752 6758 (face font-lock-comment-face fontified t) 6758 6797 (face font-lock-comment-face fontified t) 6797 6840 (face font-lock-comment-face fontified t) 6840 6893 (face font-lock-comment-face fontified t) 6893 6897 (face font-lock-comment-face fontified t) 6897 6976 (face font-lock-comment-face fontified t) 6976 6977 (face font-lock-comment-face fontified t rear-nonsticky t) 6977 6978 (face font-lock-comment-face fontified t) 6978 6980 (face font-lock-comment-delimiter-face fontified t)) . 9475) (undo-tree-id10 . -6980) (undo-tree-id11 . -3462) (undo-tree-id12 . -3463) (undo-tree-id13 . -3465) (undo-tree-id14 . -3466) (undo-tree-id15 . -6922) (undo-tree-id16 . -6978) (undo-tree-id17 . -3469) (undo-tree-id18 . -6980) (undo-tree-id19 . -6980) (t 26976 40260 0 0)) nil (26976 40929 188970 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
	   :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock (portables, pas de semaphore-count)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)  ; nb de connexions actuellement “tenues” par with-conn
(defvar *pool-waiters*  0)  ; nb de threads en attente d’un slot

(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size)
                   (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms)
                   (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
;; :toplevel | :scoped | :pooled-native
(defvar *connection-mode* :toplevel)

(defvar *default-statement-timeout-ms* nil
  \"Timeout par défaut (ms) appliqué aux requêtes si fourni. NIL = pas de timeout.\")

(defvar *slow-query-ms* 500.0
  \"Seuil (ms) au-delà duquel on loggue la requête comme lente.\")

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  \"Initialise selon :connection-mode.
:toplevel → connect-toplevel
:scoped   → rien (ouverture par bloc)
:pooled-native → rien ici (piscine Postmodern via :pooled-p dans with-conn).
Tu peux régler postmodern:*max-pool-size* en amont.\"
  (print \"IN START!\")
  (print config)
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
			      (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\"
							 :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (print *connection-mode*)

  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     ;; Pas de connexion globale ; on laisse with-conn piloter. On initialise le pool si besoin.
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections & Transactions
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk
		       &key (cfg (or *current-config* (lumen.data.config:db-config))))
  \"Exécute THUNK dans une connexion Postgres selon CONFIG (ou provider). Priorité à *current-config* (set par start!) sinon config par défaut. Supporte :connection-mode = :toplevel | :scoped | :pooled-native.\"
  (let* ((mode (intern
                (string-upcase
                 ;; On regarde aussi dans la cfg passée en priorité
                 (or (getf cfg :db-connection-mode)
                     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                :keyword)))
    (ecase mode
      (:toplevel
       ;; Connexion globale déjà ouverte par start! ; on exécute directement.
       (funcall thunk))

      (:scoped
       #+postmodern
       (let* ((db   (getf cfg :database))
              (user (getf cfg :user))
              (pass (getf cfg :password))
              (host (or (getf cfg :host) \"localhost\"))
              (port (or (getf cfg :port) 5432))
              (app  (or (getf cfg :application-name) \"\"))
              (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host
                                           :port port :use-ssl use-ssl
                                           :application-name app)
           (funcall thunk)))
       #-postmodern
       (funcall thunk))

      (:pooled-native
       ;; Contrainte de concurrence via sémaphore local
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time)
                           (* internal-time-units-per-second
                              (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         ;; entrer en file d’attente
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema*
                                                     :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline)
                                   (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                ;; slot acquis → MAJ compteurs + métriques d’attente
                (%pool-incf! '*pool-waiters*  -1)
                (%pool-incf! '*pool-inflight* 1)
                (let* ((t1 (get-internal-real-time))
                       (wait-ms (* 1000.0 (/ (- t1 t0) internal-time-units-per-second))))
                  (multiple-value-bind (in-use _waiters) (%pool-snapshot)
                    (declare (ignore _waiters))
                    (ignore-errors
                      (lumen.data.metrics:record-pool-stats in-use wait-ms))))
                ;; ouvrir une connexion poolée Postmodern pour le corps
                #+postmodern		
                (let* ((db   (getf cfg :database))
                       (user (getf cfg :user))
                       (pass (getf cfg :password))
                       (host (or (getf cfg :host) \"localhost\"))
                       (port (or (getf cfg :port) 5432))
                       (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect		       
                       (postmodern:with-connection (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t)
			 (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    ;; libération du slot
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect
                     (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1)
                  (bt:signal-semaphore *pool-sema*)))
           ;; si erreur avant slot → on enlève l’attente
           (when (> *pool-waiters* 0)
             (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  \"Usage:
  (with-conn               ...body...)          ; config via provider (ENV)
  (with-conn (:config cfg) ...body...)          ; surcharge ponctuelle\"
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      ;; Pas d'opts : `opts` est en fait la 1ère forme du body (compat)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;; Ajoutez cette fonction AVANT la macro with-tx
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Logique d'exécution transactionnelle avec retries.
   Isole le contexte pour éviter les erreurs de pile (CONTROL-ERROR).\"
  (let ((attempt 0))
    (loop
      (multiple-value-bind (outcome payload)
          (handler-case
              ;; Essai d'exécution
              (values :success
                      (multiple-value-list
                       (ensure-connection
                         #+postmodern
                         (postmodern:with-transaction ()
                           (funcall thunk))
                         #-postmodern
                         (funcall thunk))))
            
            ;; 1. Erreur Métier : On capture UNIQUEMENT le message (String)
            ;; Cela détruit tout lien avec l'objet condition problématique.
            (lumen.core.error:application-error (c)
              (values :app-error (princ-to-string c)))
            
            ;; 2. Erreur DB : On capture l'objet mappé
            (condition (c)
              (let ((mapped (lumen.data.errors:map-db-error c)))
                (if (and (< attempt retries)
                         (lumen.data.errors:retryable-db-error-p mapped))
                    (values :retry nil)
                    (values :db-error mapped)))))
        
        ;; ANALYSE DU RÉSULTAT (Hors du contexte protégé)
        (ecase outcome
          (:success
           (return (values-list payload))) ;; Retour simple du LOOP (safe)
          
          (:retry
           (incf attempt)
           (when (plusp sleep-ms)
             (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
          
          (:app-error
           ;; On recrée une erreur vierge ici
           ;; Note: On utilise find-symbol pour ne pas dépendre de QALM à la compilation
           (let* ((sym (or (find-symbol \"BUSINESS-ERROR\" \"QALM.BACKEND.CORE.ERROR\")
                           'lumen.core.error:application-error))
                  (msg payload)
                  ;; Nettoyage du préfixe si présent
                  (clean-msg (if (search \"Business Error: \" msg)
                                 (subseq msg 16)
                                 msg)))
             (error (make-instance sym :message clean-msg))))
          
          (:db-error
           (error payload)))))))

;; Redéfinition de la macro pour utiliser le helper
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  ;; On enveloppe le body dans une lambda et on passe au helper
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  \"Applique SET LOCAL statement_timeout = MS à l’intérieur d’une transaction existante.
Ne crée pas de transaction : à utiliser sous with-conn + BEGIN, ou quand un bloc
ouvrira de toute façon une transaction (ex: via ton code applicatif).\"
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn
           ;; SET LOCAL n’a d’effet que dans une transaction *déjà* ouverte.
           ;; Dans les tests, on est sous with-rollback (BEGIN/ROLLBACK).
           (ignore-errors
             (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
           ,@body)
         (progn ,@body))))
;; ----------------------------------------------------------------------------
;; Internal helpers
;; ----------------------------------------------------------------------------
;; Postmodern attend :use-ssl = :no | :try | :require | :yes | :full
(defun %sslmode->use-ssl (sslmode)
  (case sslmode
    ((:disable nil) :no)
    ((:allow :prefer) :try)
    (:require :require)
    (:verify-ca :yes)
    (:verify-full :full)
    (t :no)))

(defun %rows->alists (rows)
  \"Best-effort conversion to alists. If ROWS already look like alists, return as-is.\"
  (if (and rows (consp (first rows)) (keywordp (caar rows)))
      rows
      ;; Fallback – leave as-is (caller may adapt). Improve with column metadata if needed.
      rows))

(defun %now-ms ()
  (round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))

(defun %elapsed-ms (t0)
  (* 1000.0 (/ (- (get-internal-real-time) t0) internal-time-units-per-second)))

;; ----------------------------------------------------------------------------
;; Query wrappers
;; ----------------------------------------------------------------------------
(defun query-a (sql &rest params)
  \"Execute a SELECT-like statement, return (values rows-alist count).
Options en fin de params (keywords) :
  :timeout-ms <int>  — timeout Postgres via SET LOCAL statement_timeout (ms).\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
	       sql elapsed-ms :params args :rows (length rows)))
            (values rows (length rows))))
      (condition (c)
        (translate-db-error c)))))

(defun query-1a (sql &rest params)
  \"Like query-a but expect 0/1 row; return alist or NIL.
Options :
  :timeout-ms <int>\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn  (get-prepared-plan sql :format :alist))
                 (row (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (if row 1 0))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
	       sql elapsed-ms :params args :rows (if row 1 0)))
            row))
      (condition (c)
        (translate-db-error c)))))

(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
   Gère correctement les arguments :NULL dans les paramètres SQL.\"
  
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  
  (let* (;; On cherche le début des options (:timeout-ms, etc.)
         ;; CORRECTION : On ignore :NULL et :DEFAULT qui sont des valeurs SQL, pas des options.
         (kpos (position-if (lambda (x)
                              (and (keywordp x)
                                   (not (member x '(:null :default) :test #'eq))))
                            params))
         
         ;; Séparation propre Arguments SQL / Options Lumen
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         
         ;; Extraction des options
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (format t \"~&EXEC:OPTS: ~A~%\" opts)
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            
            (if has-returning
                ;; RETURNING -> On veut le résultat (alist)
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                
                ;; Pas de RETURNING -> On veut juste le nombre de lignes affectées
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            
            ;; Métriques (Optionnel)
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            
            (values affected ret)))

      ;; Si c'est une erreur applicative, on la re-signale telle quelle
      ;; sans l'emballer dans une db-error.
      (lumen.core.error:application-error (c)
        (error c))
      
      (condition (c)
        (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  \"Exécute BODY dans une transaction qui sera annulée.
   Accepte des options comme (:config my-config).\"
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect
          (progn ,@body)
       (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 454 (fontified t) 454 472 (face font-lock-builtin-face fontified t) 472 480 (fontified t) 480 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 495 (face font-lock-builtin-face fontified t) 495 496 (fontified t) 496 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 511 (face font-lock-builtin-face fontified t) 511 523 (fontified t) 523 531 (face font-lock-builtin-face fontified t) 531 532 (fontified t) 532 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 547 (face font-lock-builtin-face fontified t) 547 559 (fontified t) 559 569 (face font-lock-builtin-face fontified t) 569 570 (fontified t) 570 588 (face font-lock-builtin-face fontified t) 588 589 (fontified t) 589 603 (face font-lock-builtin-face fontified t) 603 615 (fontified t) 615 633 (face font-lock-builtin-face fontified t) 633 634 (fontified t) 634 657 (face font-lock-builtin-face fontified t) 657 662 (fontified t) 662 693 (face font-lock-builtin-face fontified t) 693 694 (fontified t) 694 710 (face font-lock-builtin-face fontified t) 710 715 (fontified t) 715 725 (face font-lock-keyword-face fontified t) 725 726 (fontified t) 726 740 (face font-lock-builtin-face fontified t) 740 743 (fontified t) 743 748 (face font-lock-comment-delimiter-face fontified t) 748 823 (face font-lock-comment-face fontified t) 823 828 (face font-lock-comment-delimiter-face fontified t) 828 885 (face font-lock-comment-face fontified t) 885 890 (face font-lock-comment-delimiter-face fontified t) 890 965 (face font-lock-comment-face fontified t) 965 966 (fontified t) 966 972 (face font-lock-keyword-face fontified t) 972 973 (fontified t) 973 984 (face font-lock-variable-name-face fontified t) 984 999 (fontified t) 999 1014 (face font-lock-string-face fontified t) 1014 1018 (fontified t) 1018 1024 (face font-lock-keyword-face fontified t) 1024 1025 (fontified t) 1025 1040 (face font-lock-variable-name-face fontified t) 1040 1045 (fontified t) 1045 1100 (face font-lock-comment-face fontified t) 1100 1101 (fontified t) 1101 1107 (face font-lock-keyword-face fontified t) 1107 1108 (fontified t) 1108 1122 (face font-lock-variable-name-face fontified t) 1122 1128 (fontified t) 1128 1165 (face font-lock-comment-face fontified t) 1165 1167 (fontified t) 1167 1173 (face font-lock-keyword-face fontified t) 1173 1174 (fontified t) 1174 1185 (face font-lock-variable-name-face fontified t) 1185 1192 (fontified t) 1192 1198 (face font-lock-keyword-face fontified t) 1198 1199 (fontified t) 1199 1210 (face font-lock-variable-name-face fontified t) 1210 1215 (fontified t) 1215 1221 (face font-lock-keyword-face fontified t) 1221 1222 (fontified t) 1222 1236 (face font-lock-variable-name-face fontified t) 1236 1245 (fontified t) 1245 1250 (face font-lock-keyword-face fontified t) 1250 1251 (fontified t) 1251 1262 (face font-lock-function-name-face fontified t) 1262 1278 (fontified t) 1278 1295 (face font-lock-keyword-face fontified t) 1295 1350 (fontified t) 1350 1355 (face font-lock-keyword-face fontified t) 1355 1356 (fontified t) 1356 1370 (face font-lock-function-name-face fontified t) 1370 1377 (fontified t) 1377 1394 (face font-lock-keyword-face fontified t) 1394 1457 (fontified t) 1457 1462 (face font-lock-keyword-face fontified t) 1462 1463 (fontified t) 1463 1481 (face font-lock-function-name-face fontified t) 1481 1491 (fontified t) 1491 1495 (face font-lock-keyword-face fontified t) 1495 1500 (fontified t) 1500 1517 (fontified t) 1517 1527 (face font-lock-builtin-face fontified t) 1527 1529 (fontified t) 1529 19141 (fontified nil)) . 1) (undo-tree-id0 . -19141) (undo-tree-id1 . -19141) (t 26976 40929 0 0)) nil (26976 41155 420486 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16045 . 16046) (nil fontified nil 1 . 16046) (1 . 16046)) nil (26976 41155 420471 0) 0 nil])
([nil nil ((16046 . 16047) 1152) nil (26976 41155 420467 0) 0 nil])
([nil nil ((8560 . 8561) (t 26976 41155 0 0)) nil (26976 42096 131008 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10554 . 10555) (nil fontified nil 8561 . 10555) (8561 . 10555)) nil (26976 42096 131007 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction avec retries.
   LAISSE PASSER les erreurs métier (ApplicationError) sans les toucher.\"
  (let ((attempt 0))
    (loop
      (handler-case
          (return 
            (ensure-connection
              #+postmodern
              (postmodern:with-transaction ()
                ;; INTERCEPTION INTERNE (Tunneling)
                ;; On utilise handler-bind pour inspecter l'erreur AVANT le dépilement
                (handler-bind ((error (lambda (c)
                                        ;; Si c'est une erreur métier, on ne fait RIEN.
                                        ;; Lisp va continuer à chercher un handler plus haut (Middleware)
                                        ;; et Postmodern fera le ROLLBACK en sortant.
                                        (when (typep c 'lumen.core.error:application-error)
                                          (return-from nil)) ;; Retour normal du handler, continue la propagation
                                        
                                        ;; Si c'est une erreur DB technique, on analyse
                                        (let ((mapped (lumen.data.errors:map-db-error c)))
                                          (when (and mapped (lumen.data.errors:retryable-db-error-p mapped))
                                            ;; C'est retryable : on lève notre condition spéciale
                                            (error 'retry-request :error mapped))))))
                  (funcall thunk)))
              #-postmodern
              (funcall thunk)))

        ;; CATCH DU RETRY (Hors transaction)
        ;; On n'attrape QUE notre condition spéciale.
        (retry-request (r)
          (let ((real-error (retry-original-error r)))
            (if (< attempt retries)
                (progn
                  (incf attempt)
                  (when (plusp sleep-ms)
                    (sleep (/ (max 0 sleep-ms) 1000.0))))
                ;; Trop d'essais : on relance la vraie erreur DB
                (error real-error))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 177 (face font-lock-doc-face fontified t) 177 181 (fontified t) 181 184 (face font-lock-keyword-face fontified t) 184 204 (fontified t) 204 208 (face font-lock-keyword-face fontified t) 208 216 (fontified t) 216 228 (face font-lock-keyword-face fontified t) 228 240 (fontified t) 240 246 (face font-lock-keyword-face fontified t) 246 321 (fontified t) 321 348 (face font-lock-keyword-face fontified t) 348 368 (fontified t) 368 371 (face font-lock-comment-delimiter-face fontified t) 371 404 (face font-lock-comment-face fontified t) 404 420 (fontified t) 420 423 (face font-lock-comment-delimiter-face fontified t) 423 491 (face font-lock-comment-face fontified t) 491 508 (fontified t) 508 520 (face font-lock-keyword-face fontified t) 520 523 (fontified t) 523 528 (face font-lock-warning-face fontified t) 528 530 (fontified t) 530 536 (face font-lock-keyword-face fontified t) 536 581 (fontified t) 581 584 (face font-lock-comment-delimiter-face fontified t) 584 629 (face font-lock-comment-face fontified t) 629 669 (fontified t) 669 672 (face font-lock-comment-delimiter-face fontified t) 672 735 (face font-lock-comment-face fontified t) 735 775 (fontified t) 775 778 (face font-lock-comment-delimiter-face fontified t) 778 821 (face font-lock-comment-face fontified t) 821 862 (fontified t) 862 866 (face font-lock-keyword-face fontified t) 866 956 (fontified t) 956 967 (face font-lock-keyword-face fontified t) 967 974 (fontified t) 974 977 (face font-lock-comment-delimiter-face fontified t) 977 1027 (face font-lock-comment-face fontified t) 1027 1108 (fontified t) 1108 1111 (face font-lock-comment-delimiter-face fontified t) 1111 1156 (face font-lock-comment-face fontified t) 1156 1197 (fontified t) 1197 1200 (face font-lock-keyword-face fontified t) 1200 1290 (fontified t) 1290 1294 (face font-lock-keyword-face fontified t) 1294 1400 (fontified t) 1400 1403 (face font-lock-comment-delimiter-face fontified t) 1403 1454 (face font-lock-comment-face fontified t) 1454 1499 (fontified t) 1499 1501 (face font-lock-warning-face fontified t) 1501 1504 (face font-lock-warning-face fontified t) 1504 1520 (fontified t) 1520 1526 (face font-lock-builtin-face fontified t) 1526 1540 (fontified t) 1540 1590 (fontified t) 1590 1632 (face slime-reader-conditional-face fontified t) 1632 1644 (fontified t) 1644 1647 (face font-lock-comment-delimiter-face fontified t) 1647 1681 (face font-lock-comment-face fontified t) 1681 1689 (fontified t) 1689 1692 (face font-lock-comment-delimiter-face fontified t) 1692 1735 (face font-lock-comment-face fontified t) 1735 1762 (fontified t) 1762 1773 (fontified t) 1773 1776 (face font-lock-keyword-face fontified t) 1776 1830 (fontified t) 1830 1832 (face font-lock-keyword-face fontified t) 1832 1870 (fontified t) 1870 1875 (face font-lock-keyword-face fontified t) 1875 1928 (fontified t) 1928 1932 (face font-lock-keyword-face fontified t) 1932 2024 (fontified t) 2024 2027 (face font-lock-comment-delimiter-face fontified t) 2027 2073 (face font-lock-comment-face fontified t) 2073 2090 (fontified t) 2090 2095 (face font-lock-warning-face fontified t) 2095 2114 (fontified t)) . -10555) (undo-tree-id2 . -2114) (undo-tree-id3 . -717) 12669) nil (26976 42096 131003 0) 0 nil])
([nil nil ((10130 . 10131) (t 26976 42096 0 0)) nil (26976 42104 32463 0) 0 nil])
([nil nil ((#("b" 0 1 (fontified t)) . -10130) (undo-tree-id4 . -1) 10131) nil (26976 42104 32459 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)

(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size)
                   (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms)
                   (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)

(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  (print \"IN START!\")
  (print config)
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\"
                                                         :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (print *connection-mode*)

  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections & Helper
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk
                       &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern
                (string-upcase
                 (or (getf cfg :db-connection-mode)
                     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped
       #+postmodern
       (let* ((db   (getf cfg :database))
              (user (getf cfg :user))
              (pass (getf cfg :password))
              (host (or (getf cfg :host) \"localhost\"))
              (port (or (getf cfg :port) 5432))
              (app  (or (getf cfg :application-name) \"\"))
              (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host
                                           :port port :use-ssl use-ssl
                                           :application-name app)
           (funcall thunk)))
       #-postmodern
       (funcall thunk))
      (:pooled-native
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time)
                           (* internal-time-units-per-second
                              (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema*
                                                     :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline)
                                   (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                (%pool-incf! '*pool-waiters* -1)
                (%pool-incf! '*pool-inflight* 1)
                (let* ((t1 (get-internal-real-time))
                       (wait-ms (* 1000.0 (/ (- t1 t0) internal-time-units-per-second))))
                  (multiple-value-bind (in-use _waiters) (%pool-snapshot)
                    (declare (ignore _waiters))
                    (ignore-errors
                      (lumen.data.metrics:record-pool-stats in-use wait-ms))))
                #+postmodern        
                (let* ((db   (getf cfg :database))
                       (user (getf cfg :user))
                       (pass (getf cfg :password))
                       (host (or (getf cfg :host) \"localhost\"))
                       (port (or (getf cfg :port) 5432))
                       (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect                
                       (postmodern:with-connection (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t)
                         (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect
                     (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1)
                  (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0)
             (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS ROBUSTES (Refactoring Tunneling)
;;; ---------------------------------------------------------------------------

;; 1. Condition interne pour demander un retry sans exposer d'erreur DB
(define-condition retry-request (condition)
  ((original-error :initarg :error :reader retry-original-error))
  (:documentation \"Signal interne pour déclencher un retry de transaction.\"))

;; 2. Helper logique (Fonction, pas Macro, pour éviter les bugs de stack)
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction avec retries.
   LAISSE PASSER les erreurs métier (ApplicationError) sans les toucher.\"
  (let ((attempt 0))
    (loop
      (handler-case
          (return 
            (ensure-connection
              #+postmodern
              (postmodern:with-transaction ()
                ;; INTERCEPTION INTERNE (Tunneling)
                (handler-bind ((error (lambda (c)
                                        ;; 1. Erreur Métier : ON NE FAIT RIEN.
                                        ;; En ne faisant rien, la lambda se termine, le système considère
                                        ;; que l'erreur n'est pas gérée ici, et continue de chercher plus haut.
                                        ;; Postmodern la verra donc passer et fera son ROLLBACK.
                                        (unless (typep c 'lumen.core.error:application-error)
                                          
                                          ;; 2. Erreur Technique : On vérifie si c'est retryable
                                          (let ((mapped (lumen.data.errors:map-db-error c)))
                                            (when (and mapped (lumen.data.errors:retryable-db-error-p mapped))
                                              ;; C'est retryable : on lève notre condition spéciale
                                              (error 'retry-request :error mapped)))))))
                  (funcall thunk)))
              #-postmodern
              (funcall thunk)))

        ;; CATCH DU RETRY (Hors transaction)
        (retry-request (r)
          (let ((real-error (retry-original-error r)))
            (if (< attempt retries)
                (progn
                  (incf attempt)
                  (when (plusp sleep-ms)
                    (sleep (/ (max 0 sleep-ms) 1000.0))))
                ;; Trop d'essais : on relance la vraie erreur DB
                (error real-error))))))))

;; 3. La Macro (Simple wrapper)
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn
           (ignore-errors
             (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
           ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers Internal
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode
    ((:disable nil) :no)
    ((:allow :prefer) :try)
    (:require :require)
    (:verify-ca :yes)
    (:verify-full :full)
    (t :no)))

;;; ---------------------------------------------------------------------------
;;; Query wrappers
;;; ---------------------------------------------------------------------------
(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
               sql elapsed-ms :params args :rows (length rows)))
            (values rows (length rows))))
      (condition (c)
        (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn  (get-prepared-plan sql :format :alist))
                 (row (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (if row 1 0))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
               sql elapsed-ms :params args :rows (if row 1 0)))
            row))
      (condition (c)
        (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  
  (let* ((kpos (position-if (lambda (x)
                              (and (keywordp x)
                                   (not (member x '(:null :default) :test #'eq))))
                            params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (format t \"~&EXEC:OPTS: ~A~%\" opts)
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            
            (values affected ret)))
      
      ;; BYPASS CRITIQUE POUR LE TUNNELING :
      ;; On laisse passer l'erreur métier pour qu'elle soit attrapée
      ;; par le handler-bind de with-tx (qui l'ignorera) puis par le Middleware.
      (lumen.core.error:application-error (c)
        (error c))
      
      (condition (c)
        (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect
          (progn ,@body)
       (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 454 (fontified t) 454 472 (face font-lock-builtin-face fontified t) 472 480 (fontified t) 480 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 495 (face font-lock-builtin-face fontified t) 495 496 (fontified t) 496 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 511 (face font-lock-builtin-face fontified t) 511 523 (fontified t) 523 531 (face font-lock-builtin-face fontified t) 531 532 (fontified t) 532 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 547 (face font-lock-builtin-face fontified t) 547 559 (fontified t) 559 569 (face font-lock-builtin-face fontified t) 569 570 (fontified t) 570 588 (face font-lock-builtin-face fontified t) 588 589 (fontified t) 589 603 (face font-lock-builtin-face fontified t) 603 615 (fontified t) 615 633 (face font-lock-builtin-face fontified t) 633 634 (fontified t) 634 657 (face font-lock-builtin-face fontified t) 657 669 (fontified t) 669 700 (face font-lock-builtin-face fontified t) 700 701 (fontified t) 701 717 (face font-lock-builtin-face fontified t) 717 722 (fontified t) 722 732 (face font-lock-keyword-face fontified t) 732 733 (fontified t) 733 747 (face font-lock-builtin-face fontified t) 747 750 (fontified t) 750 755 (face font-lock-comment-delimiter-face fontified t) 755 830 (face font-lock-comment-face fontified t) 830 835 (face font-lock-comment-delimiter-face fontified t) 835 856 (face font-lock-comment-face fontified t) 856 861 (face font-lock-comment-delimiter-face fontified t) 861 936 (face font-lock-comment-face fontified t) 936 937 (fontified t) 937 943 (face font-lock-keyword-face fontified t) 943 944 (fontified t) 944 955 (face font-lock-variable-name-face fontified t) 955 970 (fontified t) 970 985 (face font-lock-string-face fontified t) 985 989 (fontified t) 989 995 (face font-lock-keyword-face fontified t) 995 996 (fontified t) 996 1011 (face font-lock-variable-name-face fontified t) 1011 1016 (fontified t) 1016 1022 (face font-lock-keyword-face fontified t) 1022 1023 (fontified t) 1023 1037 (face font-lock-variable-name-face fontified t) 1037 1043 (fontified t) 1043 1049 (face font-lock-keyword-face fontified t) 1049 1050 (fontified t) 1050 1061 (face font-lock-variable-name-face fontified t) 1061 1068 (fontified t) 1068 1074 (face font-lock-keyword-face fontified t) 1074 1075 (fontified t) 1075 1086 (face font-lock-variable-name-face fontified t) 1086 1091 (fontified t) 1091 1097 (face font-lock-keyword-face fontified t) 1097 1098 (fontified t) 1098 1112 (face font-lock-variable-name-face fontified t) 1112 1121 (fontified t) 1121 1126 (face font-lock-keyword-face fontified t) 1126 1127 (fontified t) 1127 1138 (face font-lock-function-name-face fontified t) 1138 1154 (fontified t) 1154 1171 (face font-lock-keyword-face fontified t) 1171 1226 (fontified t) 1226 1231 (face font-lock-keyword-face fontified t) 1231 1232 (fontified t) 1232 1246 (face font-lock-function-name-face fontified t) 1246 1253 (fontified t) 1253 1270 (face font-lock-keyword-face fontified t) 1270 1332 (fontified t) 1332 1333 (fontified t) 1333 1338 (face font-lock-keyword-face fontified t) 1338 1339 (fontified t) 1339 1357 (face font-lock-function-name-face fontified t) 1357 1367 (fontified t) 1367 1371 (face font-lock-keyword-face fontified t) 1371 1393 (fontified t) 1393 1403 (face font-lock-builtin-face fontified t) 1403 1455 (fontified t) 1455 1468 (face font-lock-builtin-face fontified t) 1468 1469 (fontified t) 1469 1477 (face font-lock-builtin-face fontified t) 1477 1500 (fontified t) 1500 1513 (fontified t) 1513 1526 (face font-lock-builtin-face fontified t) 1526 1528 (fontified t) 1528 1578 (fontified t) 1578 1594 (face font-lock-builtin-face fontified t) 1594 1595 (fontified t) 1595 1603 (face font-lock-builtin-face fontified t) 1603 1657 (fontified t) 1657 1661 (face font-lock-keyword-face fontified t) 1661 1759 (fontified t) 1759 1765 (face font-lock-builtin-face fontified t) 1765 1818 (fontified t) 1818 1821 (face font-lock-comment-delimiter-face fontified t) 1821 1898 (face font-lock-comment-face fontified t) 1898 1901 (face font-lock-comment-delimiter-face fontified t) 1901 1907 (face font-lock-comment-face fontified t) 1907 1910 (face font-lock-comment-delimiter-face fontified t) 1910 1987 (face font-lock-comment-face fontified t) 1987 1988 (fontified t) 1988 1994 (face font-lock-keyword-face fontified t) 1994 1995 (fontified t) 1995 2004 (face font-lock-variable-name-face fontified t) 2004 2010 (fontified t) 2010 2011 (fontified t) 2011 2017 (face font-lock-keyword-face fontified t) 2017 2018 (fontified t) 2018 2034 (face font-lock-variable-name-face fontified t) 2034 2040 (fontified t) 2040 2041 (fontified t) 2041 2047 (face font-lock-keyword-face fontified t) 2047 2048 (fontified t) 2048 2065 (face font-lock-variable-name-face fontified t) 2065 2066 (fontified t) 2066 2075 (face font-lock-builtin-face fontified t) 2075 2079 (fontified t) 2079 2085 (face font-lock-keyword-face fontified t) 2085 2086 (fontified t) 2086 2116 (face font-lock-variable-name-face fontified t) 2116 2123 (fontified t) 2123 2129 (face font-lock-keyword-face fontified t) 2129 2130 (fontified t) 2130 2145 (face font-lock-variable-name-face fontified t) 2145 2154 (fontified t) 2154 2157 (face font-lock-comment-delimiter-face fontified t) 2157 2234 (face font-lock-comment-face fontified t) 2234 2237 (face font-lock-comment-delimiter-face fontified t) 2237 2250 (face font-lock-comment-face fontified t) 2250 2253 (face font-lock-comment-delimiter-face fontified t) 2253 2330 (face font-lock-comment-face fontified t) 2330 2331 (fontified t) 2331 2336 (fontified t face font-lock-keyword-face) 2336 2337 (fontified t) 2337 2343 (fontified t face font-lock-function-name-face) 2343 2345 (fontified t) 2345 2349 (fontified t face font-lock-type-face) 2349 2399 (fontified t) 2399 2410 (fontified t face font-lock-string-face) 2410 2504 (fontified t) 2504 2523 (fontified t face font-lock-builtin-face) 2523 2582 (fontified t) 2582 2602 (fontified t face font-lock-string-face) 2602 2660 (fontified t) 2660 2668 (fontified t face font-lock-builtin-face) 2668 2669 (fontified t) 2669 2678 (fontified t face font-lock-builtin-face) 2678 2685 (fontified t) 2685 2689 (fontified t face font-lock-keyword-face) 2689 2788 (fontified t) 2788 2796 (fontified t face font-lock-builtin-face) 2796 2832 (fontified t) 2832 2837 (fontified t face font-lock-keyword-face) 2837 2861 (fontified t) 2861 2870 (fontified t face font-lock-builtin-face) 2870 2895 (fontified t) 2895 2899 (fontified t face font-lock-keyword-face) 2899 2920 (fontified t) 2920 2929 (fontified t face font-lock-builtin-face) 2929 2963 (fontified t) 2963 2968 (fontified t face font-lock-builtin-face) 2968 3002 (fontified t) 3002 3011 (fontified t face font-lock-builtin-face) 3011 3049 (fontified t) 3049 3054 (fontified t face font-lock-builtin-face) 3054 3056 (fontified t) 3056 3067 (fontified t face font-lock-string-face) 3067 3105 (fontified t) 3105 3110 (fontified t face font-lock-builtin-face) 3110 3154 (fontified t) 3154 3171 (fontified t face font-lock-builtin-face) 3171 3173 (fontified t) 3173 3175 (fontified t face font-lock-string-face) 3175 3231 (fontified t) 3231 3239 (fontified t face font-lock-builtin-face) 3239 3252 (fontified t) 3252 3264 (fontified t face font-lock-keyword-face) 3264 3277 (fontified t) 3277 3282 (fontified t face font-lock-keyword-face) 3282 3431 (fontified t) 3431 3436 (fontified t face font-lock-builtin-face) 3436 3442 (fontified t) 3442 3450 (fontified t face font-lock-builtin-face) 3450 3501 (fontified t) 3501 3518 (fontified t face font-lock-builtin-face) 3518 3625 (fontified t) 3625 3630 (fontified t face font-lock-warning-face) 3630 3631 (fontified t) 3631 3653 (fontified t face font-lock-string-face) 3653 3660 (fontified t) 3660 3665 (fontified t) 3665 3701 (face slime-reader-conditional-face fontified t) 3701 3709 (fontified t) 3709 3716 (face font-lock-builtin-face fontified t) 3716 3717 (fontified t) 3717 3731 (face font-lock-builtin-face fontified t) 3731 3807 (fontified t) 3807 3812 (face font-lock-keyword-face fontified t) 3812 3813 (fontified t) 3813 3818 (face font-lock-function-name-face fontified t) 3818 3825 (fontified t) 3825 3829 (face font-lock-keyword-face fontified t) 3829 3845 (fontified t) 3845 3849 (face font-lock-keyword-face fontified t) 3849 3872 (fontified t) 3872 3881 (face font-lock-builtin-face fontified t) 3881 3903 (fontified t) 3903 3916 (face font-lock-keyword-face fontified t) 3916 3984 (fontified t) 3984 3987 (face font-lock-comment-delimiter-face fontified t) 3987 4064 (face font-lock-comment-face fontified t) 4064 4067 (face font-lock-comment-delimiter-face fontified t) 4067 4088 (face font-lock-comment-face fontified t) 4088 4091 (face font-lock-comment-delimiter-face fontified t) 4091 4168 (face font-lock-comment-face fontified t) 4168 4169 (fontified t) 4169 4174 (fontified t face font-lock-keyword-face) 4174 4175 (fontified t) 4175 4189 (fontified t face font-lock-function-name-face) 4189 4220 (fontified t) 4220 4224 (fontified t face font-lock-type-face) 4224 4287 (fontified t) 4287 4291 (fontified t face font-lock-keyword-face) 4291 4369 (fontified t) 4369 4388 (fontified t face font-lock-builtin-face) 4388 4438 (fontified t) 4438 4458 (fontified t face font-lock-string-face) 4458 4459 (fontified t) 4459 4467 (fontified t face font-lock-builtin-face) 4467 4468 (fontified t) 4468 4482 (fontified t face font-lock-builtin-face) 4482 4502 (fontified t) 4502 4510 (fontified t face font-lock-builtin-face) 4510 4519 (fontified t) 4519 4524 (fontified t face font-lock-keyword-face) 4524 4537 (fontified t) 4537 4546 (fontified t face font-lock-builtin-face) 4546 4571 (fontified t) 4571 4578 (fontified t face font-lock-builtin-face) 4578 4607 (fontified t) 4607 4611 (fontified t face font-lock-keyword-face) 4611 4629 (fontified t) 4629 4638 (fontified t face font-lock-builtin-face) 4638 4671 (fontified t) 4671 4676 (fontified t face font-lock-builtin-face) 4676 4709 (fontified t) 4709 4718 (fontified t face font-lock-builtin-face) 4718 4755 (fontified t) 4755 4760 (fontified t face font-lock-builtin-face) 4760 4762 (fontified t) 4762 4773 (fontified t face font-lock-string-face) 4773 4810 (fontified t) 4810 4815 (fontified t face font-lock-builtin-face) 4815 4858 (fontified t) 4858 4875 (fontified t face font-lock-builtin-face) 4875 4877 (fontified t) 4877 4879 (fontified t face font-lock-string-face) 4879 4934 (fontified t) 4934 4942 (fontified t face font-lock-builtin-face) 4942 4957 (fontified t) 4957 4983 (fontified t face font-lock-keyword-face) 4983 5051 (fontified t) 5051 5056 (fontified t face font-lock-builtin-face) 5056 5062 (fontified t) 5062 5070 (fontified t face font-lock-builtin-face) 5070 5122 (fontified t) 5122 5139 (fontified t face font-lock-builtin-face) 5139 5181 (fontified t) 5181 5216 (fontified t face slime-reader-conditional-face) 5216 5225 (fontified t) 5225 5239 (fontified t face font-lock-builtin-face) 5239 5280 (fontified t) 5280 5284 (fontified t face font-lock-keyword-face) 5284 5548 (fontified t) 5548 5562 (fontified t face font-lock-keyword-face) 5562 5578 (fontified t) 5578 5583 (fontified t face font-lock-keyword-face) 5583 5601 (fontified t) 5601 5607 (fontified t face font-lock-keyword-face) 5607 5744 (fontified t) 5744 5752 (fontified t face font-lock-builtin-face) 5752 5812 (fontified t) 5812 5814 (fontified t face font-lock-keyword-face) 5814 5939 (fontified t) 5939 5944 (fontified t face font-lock-warning-face) 5944 5945 (fontified t) 5945 5975 (fontified t face font-lock-string-face) 5975 6145 (fontified t) 6145 6149 (fontified t face font-lock-keyword-face) 6149 6290 (fontified t) 6290 6309 (fontified t face font-lock-keyword-face) 6309 6366 (fontified t) 6366 6373 (fontified t face font-lock-keyword-face) 6373 6414 (fontified t) 6414 6427 (fontified t face font-lock-keyword-face) 6427 6561 (fontified t) 6561 6565 (fontified t face font-lock-keyword-face) 6565 6583 (fontified t) 6583 6592 (fontified t face font-lock-builtin-face) 6592 6634 (fontified t) 6634 6639 (fontified t face font-lock-builtin-face) 6639 6681 (fontified t) 6681 6690 (fontified t face font-lock-builtin-face) 6690 6736 (fontified t) 6736 6741 (fontified t face font-lock-builtin-face) 6741 6743 (fontified t) 6743 6754 (fontified t face font-lock-string-face) 6754 6800 (fontified t) 6800 6805 (fontified t face font-lock-builtin-face) 6805 6875 (fontified t) 6875 6883 (fontified t face font-lock-builtin-face) 6883 6907 (fontified t) 6907 6921 (fontified t face font-lock-keyword-face) 6921 6962 (fontified t) 6962 6988 (fontified t face font-lock-keyword-face) 6988 7070 (fontified t) 7070 7075 (fontified t face font-lock-builtin-face) 7075 7081 (fontified t) 7081 7089 (fontified t face font-lock-builtin-face) 7089 7155 (fontified t) 7155 7164 (fontified t face font-lock-builtin-face) 7164 7194 (fontified t) 7194 7207 (fontified t face font-lock-keyword-face) 7207 7226 (fontified t) 7226 7256 (fontified t face font-lock-string-face) 7256 7427 (fontified t) 7427 7561 (fontified t face slime-reader-conditional-face) 7561 7613 (face slime-reader-conditional-face fontified t) 7613 7627 (fontified t) 7627 7631 (face font-lock-keyword-face fontified t) 7631 7708 (fontified t) 7708 7716 (face font-lock-keyword-face fontified t) 7716 7717 (fontified t) 7717 7726 (face font-lock-function-name-face fontified t) 7726 7728 (fontified t) 7728 7737 (face font-lock-type-face fontified t) 7737 7743 (fontified t) 7743 7748 (face font-lock-type-face fontified t) 7748 7758 (fontified t) 7758 7760 (face font-lock-keyword-face fontified t) 7760 7850 (fontified t) 7850 7856 (face font-lock-keyword-face fontified t) 7856 7900 (fontified t) 7900 7906 (face font-lock-keyword-face fontified t) 7906 7929 (fontified t) 7929 7937 (face font-lock-keyword-face fontified t) 7937 7938 (fontified t) 7938 7955 (face font-lock-function-name-face fontified t) 7955 7957 (fontified t) 7957 7966 (face font-lock-type-face fontified t) 7966 7972 (fontified t) 7972 7977 (face font-lock-type-face fontified t) 7977 7988 (fontified t) 7988 7997 (face font-lock-keyword-face fontified t) 7997 8014 (fontified t) 8014 8018 (face font-lock-comment-delimiter-face fontified t) 8018 8094 (face font-lock-comment-face fontified t) 8094 8098 (face font-lock-comment-delimiter-face fontified t) 8098 8144 (face font-lock-comment-face fontified t) 8144 8148 (face font-lock-comment-delimiter-face fontified t) 8148 8224 (face font-lock-comment-face fontified t) 8224 8225 (fontified t) 8225 8228 (face font-lock-comment-delimiter-face fontified t) 8228 8297 (face font-lock-comment-face fontified t) 8297 8298 (fontified t) 8298 8314 (face font-lock-keyword-face fontified t) 8314 8315 (fontified t) 8315 8328 (face font-lock-function-name-face fontified t) 8328 8360 (fontified t) 8360 8368 (face font-lock-builtin-face fontified t) 8368 8369 (fontified t) 8369 8375 (face font-lock-builtin-face fontified t) 8375 8376 (fontified t) 8376 8383 (face font-lock-builtin-face fontified t) 8383 8410 (fontified t) 8410 8424 (face font-lock-builtin-face fontified t) 8424 8425 (fontified t) 8425 8482 (face font-lock-doc-face fontified t) 8482 8486 (fontified t) 8486 8489 (face font-lock-comment-delimiter-face fontified t) 8489 8560 (face font-lock-comment-face fontified t) 8560 8561 (fontified t) 8561 8566 (face font-lock-keyword-face fontified t) 8566 8567 (fontified t) 8567 8585 (face font-lock-function-name-face fontified t) 8585 8613 (fontified t) 8613 8736 (face font-lock-doc-face fontified t) 8736 8740 (fontified t) 8740 8743 (face font-lock-keyword-face fontified t) 8743 8763 (fontified t) 8763 8767 (face font-lock-keyword-face fontified t) 8767 8775 (fontified t) 8775 8787 (face font-lock-keyword-face fontified t) 8787 8799 (fontified t) 8799 8805 (face font-lock-keyword-face fontified t) 8805 8880 (fontified t) 8880 8907 (face font-lock-keyword-face fontified t) 8907 8927 (fontified t) 8927 8930 (face font-lock-comment-delimiter-face fontified t) 8930 8963 (face font-lock-comment-face fontified t) 8963 8980 (fontified t) 8980 8992 (face font-lock-keyword-face fontified t) 8992 8995 (fontified t) 8995 9000 (face font-lock-warning-face fontified t) 9000 9002 (fontified t) 9002 9008 (face font-lock-keyword-face fontified t) 9008 9053 (fontified t) 9053 9056 (face font-lock-comment-delimiter-face fontified t) 9056 9092 (face font-lock-comment-face fontified t) 9092 9132 (fontified t) 9132 9135 (face font-lock-comment-delimiter-face fontified t) 9135 9198 (face font-lock-comment-face fontified t) 9198 9238 (fontified t) 9238 9241 (face font-lock-comment-delimiter-face fontified t) 9241 9310 (face font-lock-comment-face fontified t) 9310 9350 (fontified t) 9350 9353 (face font-lock-comment-delimiter-face fontified t) 9353 9407 (face font-lock-comment-face fontified t) 9407 9448 (fontified t) 9448 9454 (face font-lock-keyword-face fontified t) 9454 9586 (fontified t) 9586 9589 (face font-lock-comment-delimiter-face fontified t) 9589 9641 (face font-lock-comment-face fontified t) 9641 9684 (fontified t) 9684 9687 (face font-lock-keyword-face fontified t) 9687 9779 (fontified t) 9779 9783 (face font-lock-keyword-face fontified t) 9783 9891 (fontified t) 9891 9894 (face font-lock-comment-delimiter-face fontified t) 9894 9945 (face font-lock-comment-face fontified t) 9945 9992 (fontified t) 9992 9997 (face font-lock-warning-face fontified t) 9997 10013 (fontified t) 10013 10019 (face font-lock-builtin-face fontified t) 10019 10060 (fontified t) 10060 10070 (fontified t) 10070 10084 (fontified t) 10084 10126 (face slime-reader-conditional-face fontified t) 10126 10129 (fontified t) 10129 10130 (fontified t) 10130 10138 (fontified t) 10138 10141 (face font-lock-comment-delimiter-face fontified t) 10141 10175 (face font-lock-comment-face fontified t) 10175 10213 (fontified t) 10213 10216 (face font-lock-keyword-face fontified t) 10216 10270 (fontified t) 10270 10272 (face font-lock-keyword-face fontified t) 10272 10310 (fontified t) 10310 10315 (face font-lock-keyword-face fontified t) 10315 10368 (fontified t) 10368 10372 (face font-lock-keyword-face fontified t) 10372 10464 (fontified t) 10464 10467 (face font-lock-comment-delimiter-face fontified t) 10467 10513 (face font-lock-comment-face fontified t) 10513 10530 (fontified t) 10530 10535 (face font-lock-warning-face fontified t) 10535 10553 (fontified t) 10553 10554 (fontified t rear-nonsticky t) 10554 10555 (fontified t) 10555 10556 (fontified t) 10556 10559 (face font-lock-comment-delimiter-face fontified t) 10559 10588 (face font-lock-comment-face fontified t) 10588 10589 (fontified t) 10589 10597 (face font-lock-keyword-face fontified t) 10597 10598 (fontified t) 10598 10605 (face font-lock-function-name-face fontified t) 10605 10608 (fontified t) 10608 10612 (face font-lock-type-face fontified t) 10612 10624 (fontified t) 10624 10639 (face font-lock-builtin-face fontified t) 10639 10728 (fontified t) 10728 10733 (face font-lock-type-face fontified t) 10733 10743 (fontified t) 10743 10750 (face font-lock-keyword-face fontified t) 10750 10805 (fontified t) 10805 10811 (face font-lock-keyword-face fontified t) 10811 10846 (fontified t) 10846 10854 (face font-lock-keyword-face fontified t) 10854 10855 (fontified t) 10855 10877 (face font-lock-function-name-face fontified t) 10877 10884 (fontified t) 10884 10889 (face font-lock-type-face fontified t) 10889 10900 (fontified t) 10900 10903 (face font-lock-keyword-face fontified t) 10903 10922 (fontified t) 10922 10924 (face font-lock-keyword-face fontified t) 10924 10955 (fontified t) 10955 10960 (face font-lock-keyword-face fontified t) 10960 10973 (fontified t) 10973 10986 (face font-lock-keyword-face fontified t) 10986 11030 (fontified t) 11030 11064 (face font-lock-string-face fontified t) 11064 11112 (fontified t) 11112 11117 (face font-lock-keyword-face fontified t) 11117 11130 (fontified t) 11130 11134 (face font-lock-comment-delimiter-face fontified t) 11134 11210 (face font-lock-comment-face fontified t) 11210 11214 (face font-lock-comment-delimiter-face fontified t) 11214 11231 (face font-lock-comment-face fontified t) 11231 11235 (face font-lock-comment-delimiter-face fontified t) 11235 11311 (face font-lock-comment-face fontified t) 11311 11312 (fontified t) 11312 11317 (face font-lock-keyword-face fontified t) 11317 11318 (fontified t) 11318 11335 (face font-lock-function-name-face fontified t) 11335 11349 (fontified t) 11349 11353 (face font-lock-keyword-face fontified t) 11353 11368 (fontified t) 11368 11376 (face font-lock-builtin-face fontified t) 11376 11382 (fontified t) 11382 11385 (face font-lock-builtin-face fontified t) 11385 11393 (fontified t) 11393 11399 (face font-lock-builtin-face fontified t) 11399 11400 (fontified t) 11400 11407 (face font-lock-builtin-face fontified t) 11407 11409 (fontified t) 11409 11413 (face font-lock-builtin-face fontified t) 11413 11420 (fontified t) 11420 11428 (face font-lock-builtin-face fontified t) 11428 11429 (fontified t) 11429 11437 (face font-lock-builtin-face fontified t) 11437 11444 (fontified t) 11444 11454 (face font-lock-builtin-face fontified t) 11454 11455 (fontified t) 11455 11459 (face font-lock-builtin-face fontified t) 11459 11466 (fontified t) 11466 11478 (face font-lock-builtin-face fontified t) 11478 11479 (fontified t) 11479 11480 (face font-lock-builtin-face fontified t) 11480 11484 (face font-lock-builtin-face fontified t) 11484 11486 (fontified t) 11486 11493 (fontified t) 11493 11496 (face font-lock-builtin-face fontified t) 11496 11501 (fontified t) 11501 11505 (face font-lock-comment-delimiter-face fontified t) 11505 11581 (face font-lock-comment-face fontified t) 11581 11585 (face font-lock-comment-delimiter-face fontified t) 11585 11600 (face font-lock-comment-face fontified t) 11600 11604 (face font-lock-comment-delimiter-face fontified t) 11604 11630 (face font-lock-comment-face fontified t) 11630 11680 (fontified t face font-lock-comment-face) 11681 11686 (face font-lock-keyword-face) 11687 11694 (face font-lock-function-name-face) 11700 11705 (face font-lock-type-face) 11717 11721 (face font-lock-keyword-face) 11778 11780 (face font-lock-keyword-face) 11834 11836 (face font-lock-keyword-face) 11901 11912 (face font-lock-builtin-face) 12000 12012 (face font-lock-keyword-face) 12022 12044 (face font-lock-keyword-face) 12069 12073 (face font-lock-keyword-face) 12123 12130 (face font-lock-builtin-face) 12131 12138 (face font-lock-builtin-face) 12431 12435 (face font-lock-keyword-face) 12572 12579 (face font-lock-builtin-face) 12585 12590 (face font-lock-builtin-face) 12707 12712 (face font-lock-keyword-face) 12713 12721 (face font-lock-function-name-face) 12727 12732 (face font-lock-type-face) 12744 12748 (face font-lock-keyword-face) 12805 12807 (face font-lock-keyword-face) 12861 12863 (face font-lock-keyword-face) 12928 12939 (face font-lock-builtin-face) 13027 13039 (face font-lock-keyword-face) 13049 13071 (face font-lock-keyword-face) 13096 13100 (face font-lock-keyword-face) 13130 13137 (face font-lock-builtin-face) 13138 13144 (face font-lock-builtin-face) 13390 13392 (face font-lock-keyword-face) 13416 13420 (face font-lock-keyword-face) 13557 13564 (face font-lock-builtin-face) 13570 13575 (face font-lock-builtin-face) 13577 13579 (face font-lock-keyword-face) 13667 13672 (face font-lock-keyword-face) 13673 13677 (face font-lock-function-name-face) 13683 13688 (face font-lock-type-face) 13709 13727 (face font-lock-string-face) 13739 13743 (face font-lock-keyword-face) 13765 13771 (face font-lock-keyword-face) 13876 13881 (face font-lock-builtin-face) 13882 13890 (face font-lock-builtin-face) 13892 13897 (face font-lock-builtin-face) 13960 13962 (face font-lock-keyword-face) 14016 14018 (face font-lock-keyword-face) 14083 14094 (face font-lock-builtin-face) 14192 14211 (face font-lock-string-face) 14232 14251 (face font-lock-string-face) 14268 14280 (face font-lock-keyword-face) 14290 14312 (face font-lock-keyword-face) 14337 14341 (face font-lock-keyword-face) 14413 14424 (face font-lock-string-face) 14490 14492 (face font-lock-keyword-face) 14524 14528 (face font-lock-keyword-face) 14558 14565 (face font-lock-builtin-face) 14566 14572 (face font-lock-builtin-face) 14655 14657 (face font-lock-keyword-face) 14718 14722 (face font-lock-keyword-face) 14751 14758 (face font-lock-builtin-face) 14759 14764 (face font-lock-builtin-face) 14915 14918 (face font-lock-keyword-face) 15141 15145 (face font-lock-keyword-face) 15286 15293 (face font-lock-builtin-face) 15299 15308 (face font-lock-builtin-face) 15383 15386 (face font-lock-comment-delimiter-face) 15386 15422 (face font-lock-comment-face) 15428 15431 (face font-lock-comment-delimiter-face) 15431 15491 (face font-lock-comment-face) 15497 15500 (face font-lock-comment-delimiter-face) 15500 15572 (face font-lock-comment-face) 15627 15632 (face font-lock-warning-face) 15702 15710 (face font-lock-keyword-face) 15711 15724 (face font-lock-function-name-face) 15727 15736 (face font-lock-type-face) 15743 15748 (face font-lock-type-face) 15759 15782 (face font-lock-keyword-face) 15814 15821 (face font-lock-string-face) 15829 15843 (face font-lock-keyword-face) 15855 15860 (face font-lock-keyword-face) 15877 15890 (face font-lock-keyword-face) 15911 15921 (face font-lock-string-face) 15925 15926 (rear-nonsticky t)) . 1) (undo-tree-id5 . -15927) (undo-tree-id6 . -1151) (undo-tree-id7 . -8559) (undo-tree-id8 . -1151) (undo-tree-id9 . -8560) (undo-tree-id10 . -10554) (undo-tree-id11 . -10129) (undo-tree-id12 . -10129) (undo-tree-id13 . -10084) (undo-tree-id14 . -10086) (undo-tree-id15 . -8560) (undo-tree-id16 . -10130) (undo-tree-id17 . -10129) (undo-tree-id18 . -10129) (undo-tree-id19 . -10129) (undo-tree-id20 . -10129) (undo-tree-id21 . -10129) (undo-tree-id22 . -10554) (undo-tree-id23 . -10129) (undo-tree-id24 . -10129) (undo-tree-id25 . -15927) (t 26976 42104 0 0)) nil (26976 42920 52881 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12497 . 12498) (nil fontified nil 1 . 12498) (1 . 12498)) nil (26976 42920 52853 0) 0 nil])
([nil nil ((12498 . 12499)) nil (26976 42920 52849 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections & Helpers
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode)
                                          (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                       :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped
       #+postmodern
       (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432))
             (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app)
           (funcall thunk)))
       #-postmodern (funcall thunk))
      (:pooled-native
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline) (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                (%pool-incf! '*pool-waiters* -1)
                (%pool-incf! '*pool-inflight* 1)
                #+postmodern        
                (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password))
                      (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432))
                      (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect                
                       (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t)
                         (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS SAFE (Correction CONTROL-ERROR)
;;; ---------------------------------------------------------------------------
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction avec retries.
   Utilise un block nommé et des variables pour éviter les erreurs de pile SBCL.\"
  (block safe-tx
    (let ((attempt 0))
      (loop
        (let (result      ; Stocke les valeurs de retour en cas de succès
              err-obj     ; Stocke l'objet erreur
              err-type)   ; :business ou :db
          
          ;; ÉTAPE 1 : Exécution protégée
          ;; On ne sort JAMAIS d'ici via 'return'
          (handler-case
              (setf result
                    (multiple-value-list
                     (ensure-connection
                       #+postmodern
                       (postmodern:with-transaction ()
                         (funcall thunk))
                       #-postmodern
                       (funcall thunk))))
            
            ;; Capture Erreur Métier
            (lumen.core.error:application-error (c)
              (setf err-type :business
                    err-obj c))
            
            ;; Capture Erreur Technique
            (condition (c)
              (setf err-type :db
                    err-obj c)))
          
          ;; ÉTAPE 2 : Gestion du résultat (Hors Transaction)
          ;; La pile transactionnelle est propre ici.
          (cond
            ;; Succès : on retourne les valeurs
            ((null err-type)
             (return-from safe-tx (values-list result)))
            
            ;; Erreur Métier : On la relance
            ((eq err-type :business)
             (error err-obj))
            
            ;; Erreur DB : Retry ou Fatal
            ((eq err-type :db)
             (let ((mapped (lumen.data.errors:map-db-error err-obj)))
               (if (and (< attempt retries)
                        (lumen.data.errors:retryable-db-error-p mapped))
                   ;; Retry : on incrémente et on laisse le LOOP continuer
                   (progn
                     (incf attempt)
                     (when (plusp sleep-ms)
                       (sleep (/ (max 0 sleep-ms) 1000.0))))
                   
                   ;; Fatal : on relance l'erreur mappée
                   (error mapped))))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
                ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers & Wrappers (inchangés mais inclus pour complétude)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      (lumen.core.error:application-error (c) (error c)) ;; Bypass crucial
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 125 (fontified t) 125 142 (face font-lock-builtin-face fontified t) 142 147 (fontified t) 147 159 (face font-lock-builtin-face fontified t) 159 160 (fontified t) 160 178 (face font-lock-builtin-face fontified t) 178 179 (fontified t) 179 189 (face font-lock-builtin-face fontified t) 189 194 (fontified t) 194 206 (face font-lock-builtin-face fontified t) 206 207 (fontified t) 207 226 (face font-lock-builtin-face fontified t) 226 227 (fontified t) 227 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 266 (face font-lock-builtin-face fontified t) 266 267 (fontified t) 267 290 (face font-lock-builtin-face fontified t) 290 295 (fontified t) 295 307 (face font-lock-builtin-face fontified t) 307 308 (fontified t) 308 326 (face font-lock-builtin-face fontified t) 326 327 (fontified t) 327 346 (face font-lock-builtin-face fontified t) 346 347 (fontified t) 347 360 (face font-lock-builtin-face fontified t) 360 361 (fontified t) 361 382 (face font-lock-builtin-face fontified t) 382 387 (fontified t) 387 399 (face font-lock-builtin-face fontified t) 399 400 (fontified t) 400 419 (face font-lock-builtin-face fontified t) 419 420 (fontified t) 420 441 (face font-lock-builtin-face fontified t) 441 442 (fontified t) 442 460 (face font-lock-builtin-face fontified t) 460 465 (fontified t) 465 472 (face font-lock-builtin-face fontified t) 472 473 (fontified t) 473 480 (face font-lock-builtin-face fontified t) 480 481 (fontified t) 481 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 496 (face font-lock-builtin-face fontified t) 496 508 (fontified t) 508 516 (face font-lock-builtin-face fontified t) 516 517 (fontified t) 517 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 532 (face font-lock-builtin-face fontified t) 532 544 (fontified t) 544 554 (face font-lock-builtin-face fontified t) 554 555 (fontified t) 555 573 (face font-lock-builtin-face fontified t) 573 574 (fontified t) 574 588 (face font-lock-builtin-face fontified t) 588 600 (fontified t) 600 618 (face font-lock-builtin-face fontified t) 618 619 (fontified t) 619 642 (face font-lock-builtin-face fontified t) 642 654 (fontified t) 654 685 (face font-lock-builtin-face fontified t) 685 686 (fontified t) 686 702 (face font-lock-builtin-face fontified t) 702 707 (fontified t) 707 717 (face font-lock-keyword-face fontified t) 717 718 (fontified t) 718 732 (face font-lock-builtin-face fontified t) 732 735 (fontified t) 735 740 (face font-lock-comment-delimiter-face fontified t) 740 815 (face font-lock-comment-face fontified t) 815 820 (face font-lock-comment-delimiter-face fontified t) 820 841 (face font-lock-comment-face fontified t) 841 846 (face font-lock-comment-delimiter-face fontified t) 846 921 (face font-lock-comment-face fontified t) 921 922 (fontified t) 922 928 (face font-lock-keyword-face fontified t) 928 929 (fontified t) 929 940 (face font-lock-variable-name-face fontified t) 940 955 (fontified t) 955 970 (face font-lock-string-face fontified t) 970 974 (fontified t) 974 980 (face font-lock-keyword-face fontified t) 980 981 (fontified t) 981 996 (face font-lock-variable-name-face fontified t) 996 1001 (fontified t) 1001 1007 (face font-lock-keyword-face fontified t) 1007 1008 (fontified t) 1008 1022 (face font-lock-variable-name-face fontified t) 1022 1027 (fontified t) 1027 1033 (face font-lock-keyword-face fontified t) 1033 1034 (fontified t) 1034 1045 (face font-lock-variable-name-face fontified t) 1045 1052 (fontified t) 1052 1058 (face font-lock-keyword-face fontified t) 1058 1059 (fontified t) 1059 1070 (face font-lock-variable-name-face fontified t) 1070 1075 (fontified t) 1075 1081 (face font-lock-keyword-face fontified t) 1081 1082 (fontified t) 1082 1096 (face font-lock-variable-name-face fontified t) 1096 1105 (fontified t) 1105 1110 (face font-lock-keyword-face fontified t) 1110 1111 (fontified t) 1111 1122 (face font-lock-function-name-face fontified t) 1122 1138 (fontified t) 1138 1155 (face font-lock-keyword-face fontified t) 1155 1210 (fontified t) 1210 1215 (face font-lock-keyword-face fontified t) 1215 1216 (fontified t) 1216 1230 (face font-lock-function-name-face fontified t) 1230 1237 (fontified t) 1237 1254 (face font-lock-keyword-face fontified t) 1254 1317 (fontified t) 1317 1322 (face font-lock-keyword-face fontified t) 1322 1323 (fontified t) 1323 1341 (face font-lock-function-name-face fontified t) 1341 1351 (fontified t) 1351 1355 (face font-lock-keyword-face fontified t) 1355 1377 (fontified t) 1377 1387 (face font-lock-builtin-face fontified t) 1387 1420 (fontified t) 1420 1433 (face font-lock-builtin-face fontified t) 1433 1434 (fontified t) 1434 1442 (face font-lock-builtin-face fontified t) 1442 1478 (fontified t) 1478 1491 (face font-lock-builtin-face fontified t) 1491 1500 (fontified t) 1500 1524 (fontified t) 1524 1540 (face font-lock-builtin-face fontified t) 1540 1541 (fontified t) 1541 1549 (face font-lock-builtin-face fontified t) 1549 1559 (fontified t) 11331 11332 (fontified t) 11332 11337 (fontified t face font-lock-keyword-face) 11337 11338 (fontified t) 11338 11342 (fontified t face font-lock-function-name-face) 11342 11348 (fontified t) 11348 11353 (fontified t face font-lock-type-face) 11353 11374 (fontified t) 11374 11392 (fontified t face font-lock-string-face) 11392 11401 (fontified t) 11401 11405 (fontified t face font-lock-keyword-face) 11405 11427 (fontified t) 11427 11433 (fontified t face font-lock-keyword-face) 11433 11473 (fontified t) 11473 11478 (fontified t face font-lock-builtin-face) 11478 11479 (fontified t) 11479 11487 (fontified t face font-lock-builtin-face) 11487 11489 (fontified t) 11489 11494 (fontified t face font-lock-builtin-face) 11494 11529 (fontified t) 11529 11531 (fontified t face font-lock-keyword-face) 11531 11569 (fontified t) 11569 11585 (fontified t) 11585 11587 (face font-lock-keyword-face fontified t) 11587 11644 (fontified t) 11644 11655 (face font-lock-builtin-face fontified t) 11655 11704 (fontified t) 11704 11716 (face font-lock-keyword-face fontified t) 11716 11726 (fontified t) 11726 11748 (face font-lock-keyword-face fontified t) 11748 11765 (fontified t) 11765 11769 (face font-lock-keyword-face fontified t) 11769 11824 (fontified t) 11824 11826 (face font-lock-keyword-face fontified t) 11826 11835 (fontified t) 11835 11846 (face font-lock-string-face fontified t) 11846 11910 (fontified t) 11910 11917 (face font-lock-builtin-face fontified t) 11917 11918 (fontified t) 11918 11924 (face font-lock-builtin-face fontified t) 11924 11959 (fontified t) 11959 11964 (face font-lock-keyword-face fontified t) 11964 11995 (fontified t) 11995 12002 (face font-lock-builtin-face fontified t) 12002 12003 (fontified t) 12003 12008 (face font-lock-builtin-face fontified t) 12008 12046 (fontified t) 12046 12048 (face font-lock-keyword-face fontified t) 12048 12060 (fontified t) 12060 12063 (face font-lock-comment-delimiter-face fontified t) 12063 12070 (face font-lock-comment-face fontified t) 12070 12212 (fontified t) 12212 12217 (face font-lock-warning-face fontified t) 12217 12222 (fontified t) 12222 12225 (face font-lock-comment-delimiter-face fontified t) 12225 12240 (face font-lock-comment-face fontified t) 12240 12289 (fontified t) 12289 12290 (fontified t) 12290 12298 (face font-lock-keyword-face fontified t) 12298 12299 (fontified t) 12299 12312 (face font-lock-function-name-face fontified t) 12312 12315 (fontified t) 12315 12324 (face font-lock-type-face fontified t) 12324 12331 (fontified t) 12331 12336 (face font-lock-type-face fontified t) 12336 12347 (fontified t) 12347 12370 (face font-lock-keyword-face fontified t) 12370 12402 (fontified t) 12402 12409 (face font-lock-string-face fontified t) 12409 12411 (fontified t) 12411 12417 (fontified t) 12417 12431 (face font-lock-keyword-face fontified t) 12431 12433 (fontified t) 12433 12438 (face font-lock-keyword-face fontified t) 12438 12448 (fontified t) 12448 12461 (face font-lock-keyword-face fontified t) 12461 12482 (fontified t) 12482 12492 (face font-lock-string-face fontified t) 12492 12496 (fontified t) 12496 12497 (fontified t rear-nonsticky t) 12497 12498 (fontified t)) . 1) (undo-tree-id26 . -12498) (undo-tree-id27 . -12497) (undo-tree-id28 . -12497) (undo-tree-id29 . -12497) (undo-tree-id30 . -12497) (undo-tree-id31 . -12497) (undo-tree-id32 . -12498) (t 26976 42920 0 0)) nil (26976 43198 693038 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12151 . 12152) (nil fontified nil 1 . 12152) (1 . 12152)) nil (26976 43198 693024 0) 0 nil])
([nil nil ((12152 . 12153)) nil (26976 43198 693020 0) 0 nil])
([nil nil ((#("(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 23 (face font-lock-function-name-face fontified t) 23 26 (fontified t) 26 35 (face font-lock-type-face fontified t) 35 42 (fontified t) 42 47 (face font-lock-type-face fontified t) 47 58 (fontified t) 58 81 (face font-lock-keyword-face fontified t) 81 113 (fontified t) 113 120 (face font-lock-string-face fontified t) 120 122 (fontified t) 122 128 (fontified t) 128 142 (face font-lock-keyword-face fontified t) 142 144 (fontified t) 144 149 (face font-lock-keyword-face fontified t) 149 159 (fontified t) 159 172 (face font-lock-keyword-face fontified t) 172 173 (fontified t) 173 174 (fontified t rear-nonsticky t)) . 11978) (undo-tree-id33 . -174) (undo-tree-id34 . -174) (undo-tree-id35 . -174) (undo-tree-id36 . -174) (t 26976 43198 0 0)) nil (26976 43234 754163 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12185 . 12186) (nil fontified nil 11978 . 12186) (11978 . 12186)) nil (26976 43234 754147 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode)
                                          (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                       :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped
       #+postmodern
       (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432))
             (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app)
           (funcall thunk)))
       #-postmodern (funcall thunk))
      (:pooled-native
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline) (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                (%pool-incf! '*pool-waiters* -1)
                (%pool-incf! '*pool-inflight* 1)
                #+postmodern        
                (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password))
                      (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432))
                      (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect                
                       (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t)
                         (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS SAFE (Nouvelle version : handler-bind)
;;; ---------------------------------------------------------------------------
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction avec retries.
   Utilise handler-bind pour filtrer les erreurs SANS détruire la pile.\"
  (let ((attempt 0))
    ;; Bloc nommé pour pouvoir sortir en cas de succès (return-from)
    (block tx-block
      (loop
        ;; Bloc pour le mécanisme de retry interne
        (block retry-block
          (handler-bind
              ((error (lambda (c)
                        ;; 1. Erreur Mtier : ON NE FAIT RIEN (Decline handling)
                        ;; La lambda retourne normalement. Lisp continue de chercher un handler plus haut.
                        ;; Il trouvera le Middleware. Le Stack Unwinding se fera proprement.
                        (when (typep c 'lumen.core.error:application-error)
                          (return-from nil)) 
                        
                        ;; 2. Erreur DB : On regarde si c'est retryable
                        (let ((mapped (lumen.data.errors:map-db-error c)))
                          (when (and mapped 
                                     (< attempt retries)
                                     (lumen.data.errors:retryable-db-error-p mapped))
                            ;; C'est retryable : On sort brutalement du bloc de transaction (Non-local exit)
                            ;; pour aller vers le bloc de retry.
                            (return-from retry-block :retry-needed))))))
            
            ;; Exécution protégée
            (return-from tx-block 
              (ensure-connection
                #+postmodern
                (postmodern:with-transaction ()
                  (funcall thunk))
                #-postmodern
                (funcall thunk)))))
        
        ;; Si on arrive ici, c'est qu'on a fait (return-from retry-block :retry-needed)
        (incf attempt)
        (when (plusp sleep-ms)
          (sleep (/ (max 0 sleep-ms) 1000.0)))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
                ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers & Wrappers
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      (lumen.core.error:application-error (c) (error c)) ;; Bypass explicite
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 125 (fontified t) 125 142 (face font-lock-builtin-face fontified t) 142 147 (fontified t) 147 159 (face font-lock-builtin-face fontified t) 159 160 (fontified t) 160 178 (face font-lock-builtin-face fontified t) 178 179 (fontified t) 179 189 (face font-lock-builtin-face fontified t) 189 194 (fontified t) 194 206 (face font-lock-builtin-face fontified t) 206 207 (fontified t) 207 226 (face font-lock-builtin-face fontified t) 226 227 (fontified t) 227 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 266 (face font-lock-builtin-face fontified t) 266 267 (fontified t) 267 290 (face font-lock-builtin-face fontified t) 290 295 (fontified t) 295 307 (face font-lock-builtin-face fontified t) 307 308 (fontified t) 308 326 (face font-lock-builtin-face fontified t) 326 327 (fontified t) 327 346 (face font-lock-builtin-face fontified t) 346 347 (fontified t) 347 360 (face font-lock-builtin-face fontified t) 360 361 (fontified t) 361 382 (face font-lock-builtin-face fontified t) 382 387 (fontified t) 387 399 (face font-lock-builtin-face fontified t) 399 400 (fontified t) 400 419 (face font-lock-builtin-face fontified t) 419 420 (fontified t) 420 441 (face font-lock-builtin-face fontified t) 441 442 (fontified t) 442 460 (face font-lock-builtin-face fontified t) 460 465 (fontified t) 465 472 (face font-lock-builtin-face fontified t) 472 473 (fontified t) 473 480 (face font-lock-builtin-face fontified t) 480 481 (fontified t) 481 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 496 (face font-lock-builtin-face fontified t) 496 508 (fontified t) 508 516 (face font-lock-builtin-face fontified t) 516 517 (fontified t) 517 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 532 (face font-lock-builtin-face fontified t) 532 544 (fontified t) 544 554 (face font-lock-builtin-face fontified t) 554 555 (fontified t) 555 573 (face font-lock-builtin-face fontified t) 573 574 (fontified t) 574 588 (face font-lock-builtin-face fontified t) 588 600 (fontified t) 600 618 (face font-lock-builtin-face fontified t) 618 619 (fontified t) 619 642 (face font-lock-builtin-face fontified t) 642 654 (fontified t) 654 685 (face font-lock-builtin-face fontified t) 685 686 (fontified t) 686 702 (face font-lock-builtin-face fontified t) 702 707 (fontified t) 707 717 (face font-lock-keyword-face fontified t) 717 718 (fontified t) 718 732 (face font-lock-builtin-face fontified t) 732 735 (fontified t) 735 740 (face font-lock-comment-delimiter-face fontified t) 740 815 (face font-lock-comment-face fontified t) 815 820 (face font-lock-comment-delimiter-face fontified t) 820 841 (face font-lock-comment-face fontified t) 841 846 (face font-lock-comment-delimiter-face fontified t) 846 921 (face font-lock-comment-face fontified t) 921 922 (fontified t) 922 928 (face font-lock-keyword-face fontified t) 928 929 (fontified t) 929 940 (face font-lock-variable-name-face fontified t) 940 955 (fontified t) 955 970 (face font-lock-string-face fontified t) 970 974 (fontified t) 974 980 (face font-lock-keyword-face fontified t) 980 981 (fontified t) 981 996 (face font-lock-variable-name-face fontified t) 996 1001 (fontified t) 1001 1007 (face font-lock-keyword-face fontified t) 1007 1008 (fontified t) 1008 1022 (face font-lock-variable-name-face fontified t) 1022 1027 (fontified t) 1027 1033 (face font-lock-keyword-face fontified t) 1033 1034 (fontified t) 1034 1045 (face font-lock-variable-name-face fontified t) 1045 1052 (fontified t) 1052 1058 (face font-lock-keyword-face fontified t) 1058 1059 (fontified t) 1059 1070 (face font-lock-variable-name-face fontified t) 1070 1075 (fontified t) 1075 1081 (face font-lock-keyword-face fontified t) 1081 1082 (fontified t) 1082 1096 (face font-lock-variable-name-face fontified t) 1096 1105 (fontified t) 1105 1110 (face font-lock-keyword-face fontified t) 1110 1111 (fontified t) 1111 1122 (face font-lock-function-name-face fontified t) 1122 1138 (fontified t) 1138 1155 (face font-lock-keyword-face fontified t) 1155 1210 (fontified t) 1210 1215 (face font-lock-keyword-face fontified t) 1215 1216 (fontified t) 1216 1230 (face font-lock-function-name-face fontified t) 1230 1237 (fontified t) 1237 1254 (face font-lock-keyword-face fontified t) 1254 1317 (fontified t) 1317 1322 (face font-lock-keyword-face fontified t) 1322 1323 (fontified t) 1323 1341 (face font-lock-function-name-face fontified t) 1341 1351 (fontified t) 1351 1355 (face font-lock-keyword-face fontified t) 1355 1377 (fontified t) 1377 1387 (face font-lock-builtin-face fontified t) 1387 1420 (fontified t) 1420 1433 (face font-lock-builtin-face fontified t) 1433 1434 (fontified t) 1434 1442 (face font-lock-builtin-face fontified t) 1442 1478 (fontified t) 1478 1491 (face font-lock-builtin-face fontified t) 1491 1500 (fontified t) 1500 1524 (fontified t) 1524 1540 (face font-lock-builtin-face fontified t) 1540 1541 (fontified t) 1541 1549 (face font-lock-builtin-face fontified t) 1549 1559 (fontified t) 11017 11018 (fontified t) 11018 11023 (fontified t face font-lock-keyword-face) 11023 11024 (fontified t) 11024 11028 (fontified t face font-lock-function-name-face) 11028 11034 (fontified t) 11034 11039 (fontified t face font-lock-type-face) 11039 11060 (fontified t) 11060 11078 (fontified t face font-lock-string-face) 11078 11087 (fontified t) 11087 11091 (fontified t face font-lock-keyword-face) 11091 11113 (fontified t) 11113 11119 (fontified t face font-lock-keyword-face) 11119 11159 (fontified t) 11159 11164 (fontified t face font-lock-builtin-face) 11164 11165 (fontified t) 11165 11173 (fontified t face font-lock-builtin-face) 11173 11175 (fontified t) 11175 11180 (fontified t face font-lock-builtin-face) 11180 11215 (fontified t) 11215 11217 (fontified t face font-lock-keyword-face) 11217 11255 (fontified t) 11255 11271 (fontified t) 11271 11273 (face font-lock-keyword-face fontified t) 11273 11330 (fontified t) 11330 11341 (face font-lock-builtin-face fontified t) 11341 11390 (fontified t) 11390 11402 (face font-lock-keyword-face fontified t) 11402 11412 (fontified t) 11412 11434 (face font-lock-keyword-face fontified t) 11434 11451 (fontified t) 11451 11455 (face font-lock-keyword-face fontified t) 11455 11510 (fontified t) 11510 11512 (face font-lock-keyword-face fontified t) 11512 11521 (fontified t) 11521 11532 (face font-lock-string-face fontified t) 11532 11596 (fontified t) 11596 11603 (face font-lock-builtin-face fontified t) 11603 11604 (fontified t) 11604 11610 (face font-lock-builtin-face fontified t) 11610 11645 (fontified t) 11645 11650 (face font-lock-keyword-face fontified t) 11650 11681 (fontified t) 11681 11688 (face font-lock-builtin-face fontified t) 11688 11689 (fontified t) 11689 11694 (face font-lock-builtin-face fontified t) 11694 11732 (fontified t) 11732 11734 (face font-lock-keyword-face fontified t) 11734 11746 (fontified t) 11746 11749 (face font-lock-comment-delimiter-face fontified t) 11749 11756 (face font-lock-comment-face fontified t) 11756 11898 (fontified t) 11898 11903 (face font-lock-warning-face fontified t) 11903 11908 (fontified t) 11908 11911 (face font-lock-comment-delimiter-face fontified t) 11911 11928 (face font-lock-comment-face fontified t) 11928 11977 (fontified t) 11977 11978 (fontified t) 11978 11986 (face font-lock-keyword-face fontified t) 11986 11987 (fontified t) 11987 12000 (face font-lock-function-name-face fontified t) 12000 12003 (fontified t) 12003 12012 (face font-lock-type-face fontified t) 12012 12019 (fontified t) 12019 12024 (face font-lock-type-face fontified t) 12024 12035 (fontified t) 12035 12058 (face font-lock-keyword-face fontified t) 12058 12090 (fontified t) 12090 12097 (face font-lock-string-face fontified t) 12097 12105 (fontified t) 12105 12119 (face font-lock-keyword-face fontified t) 12119 12121 (fontified t) 12121 12126 (face font-lock-keyword-face fontified t) 12126 12136 (fontified t) 12136 12149 (face font-lock-keyword-face fontified t) 12149 12170 (fontified t) 12170 12180 (face font-lock-string-face fontified t) 12180 12184 (fontified t) 12184 12185 (rear-nonsticky t fontified t) 12185 12186 (fontified t)) . 1) (undo-tree-id37 . -12186) (undo-tree-id38 . -12186) (undo-tree-id39 . -11977) (undo-tree-id40 . -11977) (undo-tree-id41 . -12185) (undo-tree-id42 . -12185) (undo-tree-id43 . -11048) (undo-tree-id44 . -12185) (undo-tree-id45 . -12185) (undo-tree-id46 . -11048) (undo-tree-id47 . -12185) (undo-tree-id48 . -12185) (undo-tree-id49 . -11048) (undo-tree-id50 . -12185) (undo-tree-id51 . -12186) (undo-tree-id52 . -12186) (undo-tree-id53 . -12186) (undo-tree-id54 . -12186) (undo-tree-id55 . -12186) (undo-tree-id56 . -12186) (undo-tree-id57 . -11977) (undo-tree-id58 . -12186) (undo-tree-id59 . -12186) (undo-tree-id60 . -12186) (t 26976 43234 0 0)) nil (26976 43460 330994 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12363 . 12364) (nil fontified nil 1 . 12364) (1 . 12364)) nil (26976 43460 330968 0) 0 nil])
([nil nil ((12364 . 12365)) nil (26976 43460 330964 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State & Config
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode)
                                          (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                       :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped
       #+postmodern
       (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password))
             (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432))
             (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app)
           (funcall thunk)))
       #-postmodern (funcall thunk))
      (:pooled-native
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline) (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                (%pool-incf! '*pool-waiters* -1)
                (%pool-incf! '*pool-inflight* 1)
                #+postmodern        
                (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password))
                      (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432))
                      (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect                
                       (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t)
                         (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS VIA TUNNELING (La Solution Robuste)
;;; ---------------------------------------------------------------------------

;; Condition \"Valise\" pour transporter l'erreur métier à travers la DB
(define-condition tx-tunnel-error (error)
  ((payload :initarg :payload :reader tx-tunnel-payload))
  (:documentation \"Erreur technique utilisée pour forcer le ROLLBACK et transporter l'erreur métier.\"))

(defun call-with-tx-logic (thunk retries sleep-ms)
  (let ((attempt 0))
    (loop
      (handler-case
          (return 
            (ensure-connection
              #+postmodern
              (postmodern:with-transaction ()
                (handler-bind 
                    ((error (lambda (c)
                              ;; 1. Si c'est une Erreur Métier (Application Error)
                              ;; On l'EMBALLE dans une tx-tunnel-error et on SIGNAL l'erreur.
                              ;; Postmodern verra une erreur -> ROLLBACK.
                              (when (typep c 'lumen.core.error:application-error)
                                (error 'tx-tunnel-error :payload c))
                              
                              ;; 2. Si c'est une Erreur DB standard
                              ;; On laisse passer, Postmodern fera le Rollback.
                              ;; On pourra la catcher plus bas pour le retry.
                              )))
                  (funcall thunk)))
              #-postmodern
              (funcall thunk)))

        ;; CATCH DU TUNNEL (L'erreur métier arrive ici, après le Rollback)
        (tx-tunnel-error (e)
          ;; On déballe et on relance l'erreur originale vers le Middleware
          (error (tx-tunnel-payload e)))

        ;; CATCH DU RETRY (Les erreurs DB arrivent ici)
        (condition (c)
          (let ((mapped (lumen.data.errors:map-db-error c)))
            (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (progn
                  (incf attempt)
                  (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; Loop continue
                
                ;; Sinon c'est une vraie erreur technique fatale
                (error (or mapped c)))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
                ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      (lumen.core.error:application-error (c) (error c)) ;; Toujours relancer direct
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 125 (fontified t) 125 142 (face font-lock-builtin-face fontified t) 142 147 (fontified t) 147 159 (face font-lock-builtin-face fontified t) 159 160 (fontified t) 160 178 (face font-lock-builtin-face fontified t) 178 179 (fontified t) 179 189 (face font-lock-builtin-face fontified t) 189 194 (fontified t) 194 206 (face font-lock-builtin-face fontified t) 206 207 (fontified t) 207 226 (face font-lock-builtin-face fontified t) 226 227 (fontified t) 227 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 266 (face font-lock-builtin-face fontified t) 266 267 (fontified t) 267 290 (face font-lock-builtin-face fontified t) 290 295 (fontified t) 295 307 (face font-lock-builtin-face fontified t) 307 308 (fontified t) 308 326 (face font-lock-builtin-face fontified t) 326 327 (fontified t) 327 346 (face font-lock-builtin-face fontified t) 346 347 (fontified t) 347 360 (face font-lock-builtin-face fontified t) 360 361 (fontified t) 361 382 (face font-lock-builtin-face fontified t) 382 387 (fontified t) 387 399 (face font-lock-builtin-face fontified t) 399 400 (fontified t) 400 419 (face font-lock-builtin-face fontified t) 419 420 (fontified t) 420 441 (face font-lock-builtin-face fontified t) 441 442 (fontified t) 442 460 (face font-lock-builtin-face fontified t) 460 465 (fontified t) 465 472 (face font-lock-builtin-face fontified t) 472 473 (fontified t) 473 480 (face font-lock-builtin-face fontified t) 480 481 (fontified t) 481 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 496 (face font-lock-builtin-face fontified t) 496 508 (fontified t) 508 516 (face font-lock-builtin-face fontified t) 516 517 (fontified t) 517 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 532 (face font-lock-builtin-face fontified t) 532 544 (fontified t) 544 554 (face font-lock-builtin-face fontified t) 554 555 (fontified t) 555 573 (face font-lock-builtin-face fontified t) 573 574 (fontified t) 574 588 (face font-lock-builtin-face fontified t) 588 600 (fontified t) 600 618 (face font-lock-builtin-face fontified t) 618 619 (fontified t) 619 642 (face font-lock-builtin-face fontified t) 642 654 (fontified t) 654 685 (face font-lock-builtin-face fontified t) 685 686 (fontified t) 686 702 (face font-lock-builtin-face fontified t) 702 707 (fontified t) 707 717 (face font-lock-keyword-face fontified t) 717 718 (fontified t) 718 732 (face font-lock-builtin-face fontified t) 732 735 (fontified t) 735 740 (face font-lock-comment-delimiter-face fontified t) 740 815 (face font-lock-comment-face fontified t) 815 820 (face font-lock-comment-delimiter-face fontified t) 820 841 (face font-lock-comment-face fontified t) 841 846 (face font-lock-comment-delimiter-face fontified t) 846 921 (face font-lock-comment-face fontified t) 921 922 (fontified t) 922 928 (face font-lock-keyword-face fontified t) 928 929 (fontified t) 929 940 (face font-lock-variable-name-face fontified t) 940 955 (fontified t) 955 970 (face font-lock-string-face fontified t) 970 974 (fontified t) 974 980 (face font-lock-keyword-face fontified t) 980 981 (fontified t) 981 996 (face font-lock-variable-name-face fontified t) 996 1001 (fontified t) 1001 1007 (face font-lock-keyword-face fontified t) 1007 1008 (fontified t) 1008 1022 (face font-lock-variable-name-face fontified t) 1022 1027 (fontified t) 1027 1033 (face font-lock-keyword-face fontified t) 1033 1034 (fontified t) 1034 1045 (face font-lock-variable-name-face fontified t) 1045 1052 (fontified t) 1052 1058 (face font-lock-keyword-face fontified t) 1058 1059 (fontified t) 1059 1070 (face font-lock-variable-name-face fontified t) 1070 1075 (fontified t) 1075 1081 (face font-lock-keyword-face fontified t) 1081 1082 (fontified t) 1082 1096 (face font-lock-variable-name-face fontified t) 1096 1105 (fontified t) 1105 1110 (face font-lock-keyword-face fontified t) 1110 1111 (fontified t) 1111 1122 (face font-lock-function-name-face fontified t) 1122 1138 (fontified t) 1138 1155 (face font-lock-keyword-face fontified t) 1155 1210 (fontified t) 1210 1215 (face font-lock-keyword-face fontified t) 1215 1216 (fontified t) 1216 1230 (face font-lock-function-name-face fontified t) 1230 1237 (fontified t) 1237 1254 (face font-lock-keyword-face fontified t) 1254 1317 (fontified t) 1317 1322 (face font-lock-keyword-face fontified t) 1322 1323 (fontified t) 1323 1341 (face font-lock-function-name-face fontified t) 1341 1351 (fontified t) 1351 1355 (face font-lock-keyword-face fontified t) 1355 1377 (fontified t) 1377 1387 (face font-lock-builtin-face fontified t) 1387 1420 (fontified t) 1420 1433 (face font-lock-builtin-face fontified t) 1433 1434 (fontified t) 1434 1442 (face font-lock-builtin-face fontified t) 1442 1478 (fontified t) 1478 1491 (face font-lock-builtin-face fontified t) 1491 1500 (fontified t) 1500 1524 (fontified t) 1524 1540 (face font-lock-builtin-face fontified t) 1540 1541 (fontified t) 1541 1549 (face font-lock-builtin-face fontified t) 1549 1559 (fontified t) 11187 11188 (fontified t) 11188 11193 (fontified t face font-lock-keyword-face) 11193 11194 (fontified t) 11194 11198 (fontified t face font-lock-function-name-face) 11198 11204 (fontified t) 11204 11209 (fontified t face font-lock-type-face) 11209 11230 (fontified t) 11230 11248 (fontified t face font-lock-string-face) 11248 11257 (fontified t) 11257 11261 (fontified t face font-lock-keyword-face) 11261 11283 (fontified t) 11283 11289 (fontified t face font-lock-keyword-face) 11289 11329 (fontified t) 11329 11334 (fontified t face font-lock-builtin-face) 11334 11335 (fontified t) 11335 11343 (fontified t face font-lock-builtin-face) 11343 11345 (fontified t) 11345 11350 (fontified t face font-lock-builtin-face) 11350 11385 (fontified t) 11385 11387 (fontified t face font-lock-keyword-face) 11387 11425 (fontified t) 11425 11441 (fontified t) 11441 11443 (face font-lock-keyword-face fontified t) 11443 11500 (fontified t) 11500 11511 (face font-lock-builtin-face fontified t) 11511 11560 (fontified t) 11560 11572 (face font-lock-keyword-face fontified t) 11572 11582 (fontified t) 11582 11604 (face font-lock-keyword-face fontified t) 11604 11621 (fontified t) 11621 11625 (face font-lock-keyword-face fontified t) 11625 11680 (fontified t) 11680 11682 (face font-lock-keyword-face fontified t) 11682 11691 (fontified t) 11691 11702 (face font-lock-string-face fontified t) 11702 11766 (fontified t) 11766 11773 (face font-lock-builtin-face fontified t) 11773 11774 (fontified t) 11774 11780 (face font-lock-builtin-face fontified t) 11780 11815 (fontified t) 11815 11820 (face font-lock-keyword-face fontified t) 11820 11851 (fontified t) 11851 11858 (face font-lock-builtin-face fontified t) 11858 11859 (fontified t) 11859 11864 (face font-lock-builtin-face fontified t) 11864 11902 (fontified t) 11902 11904 (face font-lock-keyword-face fontified t) 11904 11916 (fontified t) 11916 11919 (face font-lock-comment-delimiter-face fontified t) 11919 11926 (face font-lock-comment-face fontified t) 11926 12068 (fontified t) 12068 12073 (face font-lock-warning-face fontified t) 12073 12078 (fontified t) 12078 12081 (face font-lock-comment-delimiter-face fontified t) 12081 12106 (face font-lock-comment-face fontified t) 12106 12155 (fontified t) 12155 12156 (fontified t) 12156 12164 (face font-lock-keyword-face fontified t) 12164 12165 (fontified t) 12165 12178 (face font-lock-function-name-face fontified t) 12178 12181 (fontified t) 12181 12190 (face font-lock-type-face fontified t) 12190 12197 (fontified t) 12197 12202 (face font-lock-type-face fontified t) 12202 12213 (fontified t) 12213 12236 (face font-lock-keyword-face fontified t) 12236 12268 (fontified t) 12268 12275 (face font-lock-string-face fontified t) 12275 12277 (fontified t) 12277 12283 (fontified t) 12283 12297 (face font-lock-keyword-face fontified t) 12297 12299 (fontified t) 12299 12304 (face font-lock-keyword-face fontified t) 12304 12314 (fontified t) 12314 12327 (face font-lock-keyword-face fontified t) 12327 12348 (fontified t) 12348 12358 (face font-lock-string-face fontified t) 12358 12362 (fontified t) 12362 12363 (fontified t rear-nonsticky t) 12363 12364 (fontified t)) . 1) (undo-tree-id61 . -12364) (undo-tree-id62 . -11425) (undo-tree-id63 . -12363) (undo-tree-id64 . -12363) (undo-tree-id65 . -12363) (undo-tree-id66 . -12363) (undo-tree-id67 . -12363) (undo-tree-id68 . -12363) (undo-tree-id69 . -12364) (t 26976 43460 0 0)) nil (26976 43757 367087 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11911 . 11912) (nil fontified nil 1 . 11912) (1 . 11912)) nil (26976 43757 367071 0) 0 nil])
([nil nil ((11912 . 11913)) nil (26976 43757 367066 0) 0 nil])
([nil nil ((#("-" 0 1 (face font-lock-builtin-face fontified t)) . 131) (t 26976 43757 0 0)) nil (26976 43894 346920 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel :withtransaction)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;; ... [Le code du Pool et Config reste identique, je ne le remets pas pour abréger, gardez le haut du fichier précédent] ...
;; (Copiez-collez toute la partie Pool/Config/Start/Stop/Connections du fichier précédent ici)
;; Je reprends directement à la partie critique TRANSACTIONS.

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock (Copie de sécurité pour que le fichier soit complet)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
            (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432))
            (app (or (getf config :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case (progn (postmodern:disconnect-toplevel)
                            (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
                            (setf *started* t))
         (condition (c) (setf *started* nil) (error \"DB start! failed: ~a\" c))))
     #-postmodern (setf *started* t))
    ((:scoped :pooled-native) (%ensure-pool-sema! config) (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started* (when (eq *connection-mode* :toplevel)
                    #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil)) t)

(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))) :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app) (funcall thunk))) #-postmodern (funcall thunk))
      (:pooled-native (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0)))) (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn (labels ((acquire-slot () (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0)) (if (< (get-internal-real-time) deadline) (acquire-slot) (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*))))) (acquire-slot)) (%pool-incf! '*pool-waiters* -1) (%pool-incf! '*pool-inflight* 1)
                #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (unwind-protect (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t) (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\")) (funcall thunk)) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
                #-postmodern (unwind-protect (funcall thunk) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts) `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS SAFE (Architecture \"Variable Capture\")
;;; ---------------------------------------------------------------------------

;; Condition technique uniquement pour déclencher le rollback interne
(define-condition rollback-trigger (error) ()
  (:documentation \"Signal utilisé pour sortir de with-transaction proprement.\"))

(defun call-with-tx-logic (thunk retries sleep-ms)
  (let ((attempt 0))
    (loop
      (let (captured-business-error  ; Stockera l'erreur métier
            captured-db-error        ; Stockera l'erreur DB
            success-result)          ; Stockera le résultat
        
        ;; PHASE 1 : Exécution dans la transaction
        (handler-case
            (ensure-connection
              #+postmodern
              (postmodern:with-transaction ()
                ;; On utilise handler-bind pour capturer SANS détruire la stack
                ;; On ne fait AUCUN 'return' ici, pour ne pas casser Postmodern
                (handler-bind 
                    ((lumen.core.error:application-error 
                      (lambda (c)
                        ;; 1. On garde l'erreur au chaud
                        (setf captured-business-error c)
                        ;; 2. On lance une erreur technique pour que Postmodern fasse ROLLBACK
                        (error 'rollback-trigger))))
                  
                  ;; Exécution normale
                  (setf success-result (multiple-value-list (funcall thunk)))))
              #-postmodern
              (funcall thunk))
          
          ;; CATCH 1: Notre trigger de rollback (On l'ignore, le job est fait)
          (rollback-trigger (e) 
            (declare (ignore e)))
          
          ;; CATCH 2: Erreurs DB (On stocke pour analyse retry)
          (condition (c)
            (setf captured-db-error c)))
        
        ;; PHASE 2 : Analyse hors transaction (Stack Safe)
        (cond
          ;; Cas A : Erreur Métier détectée -> On la relance
          (captured-business-error
           (error captured-business-error))
          
          ;; Cas B : Erreur DB détectée -> Retry ou Fatal
          (captured-db-error
           (let ((mapped (lumen.data.errors:map-db-error captured-db-error)))
             (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (progn
                   (incf attempt)
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; Loop continue
                 (error (or mapped captured-db-error)))))
          
          ;; Cas C : Succès
          (t 
           (return (values-list success-result))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms)))) ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      (lumen.core.error:application-error (c) (error c)) ;; Bypass explicite
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 18 (fontified t) 18 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 58 (fontified t) 58 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 125 (fontified t) 125 141 (face font-lock-builtin-face fontified t) 141 143 (fontified t) 143 146 (fontified t) 146 158 (face font-lock-builtin-face fontified t) 158 159 (fontified t) 159 177 (face font-lock-builtin-face fontified t) 177 178 (fontified t) 178 188 (face font-lock-builtin-face fontified t) 188 193 (fontified t) 193 205 (face font-lock-builtin-face fontified t) 205 206 (fontified t) 206 225 (face font-lock-builtin-face fontified t) 225 226 (fontified t) 226 244 (face font-lock-builtin-face fontified t) 244 245 (fontified t) 245 265 (face font-lock-builtin-face fontified t) 265 266 (fontified t) 266 289 (face font-lock-builtin-face fontified t) 289 294 (fontified t) 294 306 (face font-lock-builtin-face fontified t) 306 307 (fontified t) 307 325 (face font-lock-builtin-face fontified t) 325 326 (fontified t) 326 345 (face font-lock-builtin-face fontified t) 345 346 (fontified t) 346 359 (face font-lock-builtin-face fontified t) 359 360 (fontified t) 360 381 (face font-lock-builtin-face fontified t) 381 386 (fontified t) 386 398 (face font-lock-builtin-face fontified t) 398 399 (fontified t) 399 418 (face font-lock-builtin-face fontified t) 418 419 (fontified t) 419 440 (face font-lock-builtin-face fontified t) 440 441 (fontified t) 441 459 (face font-lock-builtin-face fontified t) 459 464 (fontified t) 464 471 (face font-lock-builtin-face fontified t) 471 472 (fontified t) 472 479 (face font-lock-builtin-face fontified t) 479 480 (fontified t) 480 486 (face font-lock-builtin-face fontified t) 486 487 (fontified t) 487 495 (face font-lock-builtin-face fontified t) 495 507 (fontified t) 507 515 (face font-lock-builtin-face fontified t) 515 516 (fontified t) 516 525 (face font-lock-builtin-face fontified t) 525 526 (fontified t) 526 531 (face font-lock-builtin-face fontified t) 531 543 (fontified t) 543 553 (face font-lock-builtin-face fontified t) 553 554 (fontified t) 554 572 (face font-lock-builtin-face fontified t) 572 573 (fontified t) 573 587 (face font-lock-builtin-face fontified t) 587 599 (fontified t) 599 617 (face font-lock-builtin-face fontified t) 617 618 (fontified t) 618 641 (face font-lock-builtin-face fontified t) 641 653 (fontified t) 653 684 (face font-lock-builtin-face fontified t) 684 685 (fontified t) 685 701 (face font-lock-builtin-face fontified t) 701 706 (fontified t) 706 716 (face font-lock-keyword-face fontified t) 716 717 (fontified t) 717 731 (face font-lock-builtin-face fontified t) 731 734 (fontified t) 734 737 (face font-lock-comment-delimiter-face fontified t) 737 860 (face font-lock-comment-face fontified t) 860 863 (face font-lock-comment-delimiter-face fontified t) 863 955 (face font-lock-comment-face fontified t) 955 958 (face font-lock-comment-delimiter-face fontified t) 958 1017 (face font-lock-comment-face fontified t) 1017 1018 (fontified t) 1018 1023 (face font-lock-comment-delimiter-face fontified t) 1023 1098 (face font-lock-comment-face fontified t) 1098 1103 (face font-lock-comment-delimiter-face fontified t) 1103 1177 (face font-lock-comment-face fontified t) 1177 1182 (face font-lock-comment-delimiter-face fontified t) 1182 1257 (face font-lock-comment-face fontified t) 1257 1258 (fontified t) 1258 1264 (face font-lock-keyword-face fontified t) 1264 1265 (fontified t) 1265 1276 (face font-lock-variable-name-face fontified t) 1276 1291 (fontified t) 1291 1306 (face font-lock-string-face fontified t) 1306 1310 (fontified t) 1310 1316 (face font-lock-keyword-face fontified t) 1316 1317 (fontified t) 1317 1332 (face font-lock-variable-name-face fontified t) 1332 1337 (fontified t) 1337 1343 (face font-lock-keyword-face fontified t) 1343 1344 (fontified t) 1344 1358 (face font-lock-variable-name-face fontified t) 1358 1363 (fontified t) 1363 1369 (face font-lock-keyword-face fontified t) 1369 1370 (fontified t) 1370 1381 (face font-lock-variable-name-face fontified t) 1381 1388 (fontified t) 1388 1394 (face font-lock-keyword-face fontified t) 1394 1395 (fontified t) 1395 1406 (face font-lock-variable-name-face fontified t) 1406 1411 (fontified t) 1411 1417 (face font-lock-keyword-face fontified t) 1417 1418 (fontified t) 1418 1432 (face font-lock-variable-name-face fontified t) 1432 1441 (fontified t) 1441 1446 (face font-lock-keyword-face fontified t) 1446 1447 (fontified t) 1447 1458 (face font-lock-function-name-face fontified t) 1458 1474 (fontified t) 1474 1491 (face font-lock-keyword-face fontified t) 1491 1499 (fontified t) 1499 1506 (fontified t) 1506 1546 (fontified t) 1546 1551 (face font-lock-keyword-face fontified t) 1551 1552 (fontified t) 1552 1558 (face font-lock-function-name-face fontified t) 1558 1566 (face font-lock-function-name-face fontified t) 1566 1570 (fontified t) 1570 1573 (fontified t) 1573 1590 (face font-lock-keyword-face fontified t) 1590 1643 (fontified t) 1643 1651 (fontified t)) . 1) (undo-tree-id0 . -130) (undo-tree-id1 . -130) (undo-tree-id2 . -130) (undo-tree-id3 . -130) (undo-tree-id4 . -11911) (undo-tree-id5 . -130) (undo-tree-id6 . -18) (undo-tree-id7 . -58) (undo-tree-id8 . -130) (undo-tree-id9 . -130) (undo-tree-id10 . -130) (undo-tree-id11 . -130) (undo-tree-id12 . -18) (undo-tree-id13 . -143) (undo-tree-id14 . -130) (undo-tree-id15 . -130) (undo-tree-id16 . -130) (undo-tree-id17 . -130) (undo-tree-id18 . -130) (undo-tree-id19 . -130) (undo-tree-id20 . -130) (undo-tree-id21 . -130) (undo-tree-id22 . -130) (undo-tree-id23 . -130) (undo-tree-id24 . -130) (undo-tree-id25 . -11911)) nil (26976 43894 346918 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11227 . 11228) (nil fontified nil 1 . 11228) (1 . 11228)) nil (26976 43894 346883 0) 0 nil])
([nil nil ((11228 . 11229)) nil (26976 43894 346879 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool / Config / Start / Stop (Standard)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
            (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432))
            (app (or (getf config :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case (progn (postmodern:disconnect-toplevel)
                            (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
                            (setf *started* t))
         (condition (c) (setf *started* nil) (error \"DB start! failed: ~a\" c))))
     #-postmodern (setf *started* t))
    ((:scoped :pooled-native) (%ensure-pool-sema! config) (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started* (when (eq *connection-mode* :toplevel)
                    #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil)) t)

(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))) :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app) (funcall thunk))) #-postmodern (funcall thunk))
      (:pooled-native (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0)))) (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn (labels ((acquire-slot () (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0)) (if (< (get-internal-real-time) deadline) (acquire-slot) (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*))))) (acquire-slot)) (%pool-incf! '*pool-waiters* -1) (%pool-incf! '*pool-inflight* 1)
                #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (unwind-protect (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t) (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\")) (funcall thunk)) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
                #-postmodern (unwind-protect (funcall thunk) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts) `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS VIA \"STASH & TRIGGER\"
;;; ---------------------------------------------------------------------------

;; Condition technique pour forcer Postmodern à faire ROLLBACK
(define-condition rollback-trigger (error) ()
  (:documentation \"Signal interne pour forcer le rollback de Postmodern.\"))

(defun call-with-tx-logic (thunk retries sleep-ms)
  (let ((attempt 0))
    (loop
      ;; Variable pour \"sauver\" l'erreur métier hors du crash de la transaction
      (let (captured-app-error)
        
        (handler-case
            (return ;; Si tout se passe bien, on sort de la boucle avec le résultat
              (ensure-connection
                #+postmodern
                (postmodern:with-transaction ()
                  ;; On installe un espion (handler-bind)
                  (handler-bind 
                      ((lumen.core.error:application-error 
                        (lambda (c)
                          ;; 1. ON STASH : On garde l'erreur dans la variable locale
                          (setf captured-app-error c)
                          ;; 2. ON TRIGGER : On lance une erreur bidon pour que Postmodern Rollback
                          (error 'rollback-trigger))))
                    
                    (funcall thunk)))
                #-postmodern
                (funcall thunk)))
          
          ;; CATCH DU TRIGGER (Postmodern a fini son Rollback, on atterrit ici)
          (rollback-trigger (e) 
            (declare (ignore e))
            ;; On ne fait rien, on laisse le flux continuer après le handler-case
            nil)
          
          ;; CATCH DB ERRORS (Pour les retries)
          (condition (c)
            (let ((mapped (lumen.data.errors:map-db-error c)))
              (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                  (progn
                    (incf attempt)
                    (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                  
                  ;; Erreur fatale
                  (error (or mapped c))))))
        
        ;; PHASE D'ANALYSE (Hors transaction, Pile saine)
        ;; Si on a capturé une erreur métier, on la relance MAINTENANT.
        (when captured-app-error
          (error captured-app-error))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms)))) ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      (lumen.core.error:application-error (c) (error c)) 
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 125 (fontified t) 125 142 (face font-lock-builtin-face fontified t) 142 147 (fontified t) 147 159 (face font-lock-builtin-face fontified t) 159 160 (fontified t) 160 178 (face font-lock-builtin-face fontified t) 178 179 (fontified t) 179 189 (face font-lock-builtin-face fontified t) 189 194 (fontified t) 194 206 (face font-lock-builtin-face fontified t) 206 207 (fontified t) 207 226 (face font-lock-builtin-face fontified t) 226 227 (fontified t) 227 245 (face font-lock-builtin-face fontified t) 245 246 (fontified t) 246 266 (face font-lock-builtin-face fontified t) 266 267 (fontified t) 267 290 (face font-lock-builtin-face fontified t) 290 295 (fontified t) 295 307 (face font-lock-builtin-face fontified t) 307 308 (fontified t) 308 326 (face font-lock-builtin-face fontified t) 326 327 (fontified t) 327 346 (face font-lock-builtin-face fontified t) 346 347 (fontified t) 347 360 (face font-lock-builtin-face fontified t) 360 361 (fontified t) 361 382 (face font-lock-builtin-face fontified t) 382 387 (fontified t) 387 399 (face font-lock-builtin-face fontified t) 399 400 (fontified t) 400 419 (face font-lock-builtin-face fontified t) 419 420 (fontified t) 420 441 (face font-lock-builtin-face fontified t) 441 442 (fontified t) 442 460 (face font-lock-builtin-face fontified t) 460 465 (fontified t) 465 472 (face font-lock-builtin-face fontified t) 472 473 (fontified t) 473 480 (face font-lock-builtin-face fontified t) 480 481 (fontified t) 481 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 496 (face font-lock-builtin-face fontified t) 496 508 (fontified t) 508 516 (face font-lock-builtin-face fontified t) 516 517 (fontified t) 517 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 532 (face font-lock-builtin-face fontified t) 532 544 (fontified t) 544 554 (face font-lock-builtin-face fontified t) 554 555 (fontified t) 555 573 (face font-lock-builtin-face fontified t) 573 574 (fontified t) 574 588 (face font-lock-builtin-face fontified t) 588 600 (fontified t) 600 618 (face font-lock-builtin-face fontified t) 618 619 (fontified t) 619 642 (face font-lock-builtin-face fontified t) 642 654 (fontified t) 654 685 (face font-lock-builtin-face fontified t) 685 686 (fontified t) 686 702 (face font-lock-builtin-face fontified t) 702 707 (fontified t) 707 717 (face font-lock-keyword-face fontified t) 717 718 (fontified t) 718 732 (face font-lock-builtin-face fontified t) 732 735 (fontified t) 735 740 (face font-lock-comment-delimiter-face fontified t) 740 815 (face font-lock-comment-face fontified t) 815 820 (face font-lock-comment-delimiter-face fontified t) 820 860 (face font-lock-comment-face fontified t) 860 865 (face font-lock-comment-delimiter-face fontified t) 865 940 (face font-lock-comment-face fontified t) 940 941 (fontified t) 941 947 (face font-lock-keyword-face fontified t) 947 948 (fontified t) 948 959 (face font-lock-variable-name-face fontified t) 959 974 (fontified t) 974 989 (face font-lock-string-face fontified t) 989 993 (fontified t) 993 999 (face font-lock-keyword-face fontified t) 999 1000 (fontified t) 1000 1015 (face font-lock-variable-name-face fontified t) 1015 1020 (fontified t) 1020 1026 (face font-lock-keyword-face fontified t) 1026 1027 (fontified t) 1027 1041 (face font-lock-variable-name-face fontified t) 1041 1046 (fontified t) 1046 1052 (face font-lock-keyword-face fontified t) 1052 1053 (fontified t) 1053 1064 (face font-lock-variable-name-face fontified t) 1064 1071 (fontified t) 1071 1077 (face font-lock-keyword-face fontified t) 1077 1078 (fontified t) 1078 1089 (face font-lock-variable-name-face fontified t) 1089 1094 (fontified t) 1094 1100 (face font-lock-keyword-face fontified t) 1100 1101 (fontified t) 1101 1115 (face font-lock-variable-name-face fontified t) 1115 1124 (fontified t) 1124 1129 (face font-lock-keyword-face fontified t) 1129 1130 (fontified t) 1130 1141 (face font-lock-function-name-face fontified t) 1141 1157 (fontified t) 1157 1174 (face font-lock-keyword-face fontified t) 1174 1229 (fontified t) 1229 1234 (face font-lock-keyword-face fontified t) 1234 1235 (fontified t) 1235 1249 (face font-lock-function-name-face fontified t) 1249 1256 (fontified t) 1256 1273 (face font-lock-keyword-face fontified t) 1273 1336 (fontified t) 1336 1341 (face font-lock-keyword-face fontified t) 1341 1342 (fontified t) 1342 1360 (face font-lock-function-name-face fontified t) 1360 1370 (fontified t) 1370 1374 (face font-lock-keyword-face fontified t) 1374 1396 (fontified t) 1396 1406 (face font-lock-builtin-face fontified t) 1406 1439 (fontified t) 1439 1452 (face font-lock-builtin-face fontified t) 1452 1453 (fontified t) 1453 1461 (face font-lock-builtin-face fontified t) 1461 1497 (fontified t) 1497 1500 (face font-lock-builtin-face fontified t) 1500 1510 (face font-lock-builtin-face fontified t) 1510 1543 (fontified t) 1543 1559 (face font-lock-builtin-face fontified t) 1559 1560 (fontified t) 1560 1568 (face font-lock-builtin-face fontified t) 1568 1578 (fontified t) 10078 10079 (fontified t) 10079 10084 (fontified t face font-lock-keyword-face) 10084 10085 (fontified t) 10085 10089 (fontified t face font-lock-function-name-face) 10089 10095 (fontified t) 10095 10100 (fontified t face font-lock-type-face) 10100 10121 (fontified t) 10121 10139 (fontified t face font-lock-string-face) 10139 10148 (fontified t) 10148 10152 (fontified t face font-lock-keyword-face) 10152 10174 (fontified t) 10174 10180 (fontified t face font-lock-keyword-face) 10180 10220 (fontified t) 10220 10225 (fontified t face font-lock-builtin-face) 10225 10226 (fontified t) 10226 10234 (fontified t face font-lock-builtin-face) 10234 10236 (fontified t) 10236 10241 (fontified t face font-lock-builtin-face) 10241 10276 (fontified t) 10276 10278 (fontified t face font-lock-keyword-face) 10278 10316 (fontified t) 10316 10332 (fontified t) 10332 10334 (face font-lock-keyword-face fontified t) 10334 10391 (fontified t) 10391 10402 (face font-lock-builtin-face fontified t) 10402 10451 (fontified t) 10451 10463 (face font-lock-keyword-face fontified t) 10463 10473 (fontified t) 10473 10495 (face font-lock-keyword-face fontified t) 10495 10512 (fontified t) 10512 10516 (face font-lock-keyword-face fontified t) 10516 10571 (fontified t) 10571 10573 (face font-lock-keyword-face fontified t) 10573 10582 (fontified t) 10582 10593 (face font-lock-string-face fontified t) 10593 10657 (fontified t) 10657 10664 (face font-lock-builtin-face fontified t) 10664 10665 (fontified t) 10665 10671 (face font-lock-builtin-face fontified t) 10671 10706 (fontified t) 10706 10711 (face font-lock-keyword-face fontified t) 10711 10742 (fontified t) 10742 10749 (face font-lock-builtin-face fontified t) 10749 10750 (fontified t) 10750 10755 (face font-lock-builtin-face fontified t) 10755 10793 (fontified t) 10793 10795 (face font-lock-keyword-face fontified t) 10795 10807 (fontified t) 10807 10810 (face font-lock-comment-delimiter-face fontified t) 10810 10817 (face font-lock-comment-face fontified t) 10817 10959 (fontified t) 10959 10964 (face font-lock-warning-face fontified t) 10964 11019 (fontified t) 11019 11020 (fontified t) 11020 11028 (face font-lock-keyword-face fontified t) 11028 11029 (fontified t) 11029 11042 (face font-lock-function-name-face fontified t) 11042 11045 (fontified t) 11045 11054 (face font-lock-type-face fontified t) 11054 11061 (fontified t) 11061 11066 (face font-lock-type-face fontified t) 11066 11077 (fontified t) 11077 11100 (face font-lock-keyword-face fontified t) 11100 11132 (fontified t) 11132 11139 (face font-lock-string-face fontified t) 11139 11141 (fontified t) 11141 11147 (fontified t) 11147 11161 (face font-lock-keyword-face fontified t) 11161 11163 (fontified t) 11163 11168 (face font-lock-keyword-face fontified t) 11168 11178 (fontified t) 11178 11191 (face font-lock-keyword-face fontified t) 11191 11212 (fontified t) 11212 11222 (face font-lock-string-face fontified t) 11222 11226 (fontified t) 11226 11227 (fontified t rear-nonsticky t) 11227 11228 (fontified t)) . 1) (undo-tree-id26 . -11228) (undo-tree-id27 . -11227) (undo-tree-id28 . -11227) (undo-tree-id29 . -11227) (undo-tree-id30 . -11227) (undo-tree-id31 . -11227) (undo-tree-id32 . -11228) (t 26976 43894 0 0)) nil (26976 44036 32957 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11107 . 11108) (nil fontified nil 1 . 11108) (1 . 11108)) nil (26976 44036 32944 0) 0 nil])
([nil nil ((11108 . 11109)) nil (26976 44036 32940 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel) ;; Plus de with-transaction
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Config & Pool (Standard)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
            (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432))
            (app (or (getf config :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case (progn (postmodern:disconnect-toplevel)
                            (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
                            (setf *started* t))
         (condition (c) (setf *started* nil) (error \"DB start! failed: ~a\" c))))
     #-postmodern (setf *started* t))
    ((:scoped :pooled-native) (%ensure-pool-sema! config) (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started* (when (eq *connection-mode* :toplevel)
                    #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil)) t)

;; ----------------------------------------------------------------------------
;; Connexion Helper
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))) :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app) (funcall thunk))) #-postmodern (funcall thunk))
      (:pooled-native (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0)))) (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn (labels ((acquire-slot () (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0)) (if (< (get-internal-real-time) deadline) (acquire-slot) (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*))))) (acquire-slot)) (%pool-incf! '*pool-waiters* -1) (%pool-incf! '*pool-inflight* 1)
                #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (unwind-protect (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t) (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\")) (funcall thunk)) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
                #-postmodern (unwind-protect (funcall thunk) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts) `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; GESTION MANUELLE DES TRANSACTIONS (Bare Metal)
;;; ---------------------------------------------------------------------------

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Gère la transaction manuellement via BEGIN / COMMIT / ROLLBACK.
   Utilise UNWIND-PROTECT pour garantir le rollback en cas d'erreur métier,
   permettant à l'erreur de traverser sans être capturée.\"
  (let ((attempt 0))
    (loop
      (handler-case
          (return 
            (ensure-connection
              ;; 1. Démarrage explicite
              (exec \"BEGIN\")
              
              (let ((committed nil))
                (unwind-protect
                     (multiple-value-prog1
                         (funcall thunk)
                       ;; 2. Si on arrive ici sans erreur, on commit
                       (exec \"COMMIT\")
                       (setf committed t))
                  
                  ;; 3. Nettoyage : Si on n'a pas commité (donc erreur ou saut), on rollback
                  (unless committed
                    (ignore-errors (exec \"ROLLBACK\")))))))
        
        ;; GESTION DES ERREURS
        (error (e)
          ;; A. Si c'est une erreur métier, ON LA RELANCE.
          ;; Le ROLLBACK a déjà été fait par le unwind-protect ci-dessus.
          (when (typep e 'lumen.core.error:application-error)
            (error e))
          
          ;; B. Erreurs DB : Analyse pour Retry
          (let ((mapped (lumen.data.errors:map-db-error e)))
            (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (progn
                  (incf attempt)
                  (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                
                ;; Sinon erreur fatale
                (error (or mapped e)))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms)))) ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

;; Note: exec peut lever des erreurs DB, c'est ce qu'on veut.
(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      ;; IMPORTANT: exec doit laisser passer les erreurs métier s'il y en a (peu probable ici, mais bonne pratique)
      (lumen.core.error:application-error (c) (error c))
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 126 (fontified t) 126 129 (face font-lock-comment-delimiter-face fontified t) 129 154 (face font-lock-comment-face fontified t) 154 157 (fontified t) 157 169 (face font-lock-builtin-face fontified t) 169 170 (fontified t) 170 188 (face font-lock-builtin-face fontified t) 188 189 (fontified t) 189 199 (face font-lock-builtin-face fontified t) 199 204 (fontified t) 204 216 (face font-lock-builtin-face fontified t) 216 217 (fontified t) 217 236 (face font-lock-builtin-face fontified t) 236 237 (fontified t) 237 255 (face font-lock-builtin-face fontified t) 255 256 (fontified t) 256 276 (face font-lock-builtin-face fontified t) 276 277 (fontified t) 277 300 (face font-lock-builtin-face fontified t) 300 305 (fontified t) 305 317 (face font-lock-builtin-face fontified t) 317 318 (fontified t) 318 336 (face font-lock-builtin-face fontified t) 336 337 (fontified t) 337 356 (face font-lock-builtin-face fontified t) 356 357 (fontified t) 357 370 (face font-lock-builtin-face fontified t) 370 371 (fontified t) 371 392 (face font-lock-builtin-face fontified t) 392 397 (fontified t) 397 409 (face font-lock-builtin-face fontified t) 409 410 (fontified t) 410 429 (face font-lock-builtin-face fontified t) 429 430 (fontified t) 430 451 (face font-lock-builtin-face fontified t) 451 452 (fontified t) 452 470 (face font-lock-builtin-face fontified t) 470 475 (fontified t) 475 482 (face font-lock-builtin-face fontified t) 482 483 (fontified t) 483 490 (face font-lock-builtin-face fontified t) 490 491 (fontified t) 491 497 (face font-lock-builtin-face fontified t) 497 498 (fontified t) 498 506 (face font-lock-builtin-face fontified t) 506 518 (fontified t) 518 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 536 (face font-lock-builtin-face fontified t) 536 537 (fontified t) 537 542 (face font-lock-builtin-face fontified t) 542 554 (fontified t) 554 564 (face font-lock-builtin-face fontified t) 564 565 (fontified t) 565 583 (face font-lock-builtin-face fontified t) 583 584 (fontified t) 584 598 (face font-lock-builtin-face fontified t) 598 610 (fontified t) 610 628 (face font-lock-builtin-face fontified t) 628 629 (fontified t) 629 652 (face font-lock-builtin-face fontified t) 652 664 (fontified t) 664 695 (face font-lock-builtin-face fontified t) 695 696 (fontified t) 696 712 (face font-lock-builtin-face fontified t) 712 717 (fontified t) 717 727 (face font-lock-keyword-face fontified t) 727 728 (fontified t) 728 742 (face font-lock-builtin-face fontified t) 742 745 (fontified t) 745 750 (face font-lock-comment-delimiter-face fontified t) 750 825 (face font-lock-comment-face fontified t) 825 830 (face font-lock-comment-delimiter-face fontified t) 830 855 (face font-lock-comment-face fontified t) 855 860 (face font-lock-comment-delimiter-face fontified t) 860 935 (face font-lock-comment-face fontified t) 935 936 (fontified t) 936 942 (face font-lock-keyword-face fontified t) 942 943 (fontified t) 943 954 (face font-lock-variable-name-face fontified t) 954 969 (fontified t) 969 984 (face font-lock-string-face fontified t) 984 988 (fontified t) 988 994 (face font-lock-keyword-face fontified t) 994 995 (fontified t) 995 1010 (face font-lock-variable-name-face fontified t) 1010 1015 (fontified t) 1015 1021 (face font-lock-keyword-face fontified t) 1021 1022 (fontified t) 1022 1036 (face font-lock-variable-name-face fontified t) 1036 1041 (fontified t) 1041 1047 (face font-lock-keyword-face fontified t) 1047 1048 (fontified t) 1048 1059 (face font-lock-variable-name-face fontified t) 1059 1066 (fontified t) 1066 1072 (face font-lock-keyword-face fontified t) 1072 1073 (fontified t) 1073 1084 (face font-lock-variable-name-face fontified t) 1084 1089 (fontified t) 1089 1095 (face font-lock-keyword-face fontified t) 1095 1096 (fontified t) 1096 1110 (face font-lock-variable-name-face fontified t) 1110 1119 (fontified t) 1119 1124 (face font-lock-keyword-face fontified t) 1124 1125 (fontified t) 1125 1136 (face font-lock-function-name-face fontified t) 1136 1152 (fontified t) 1152 1169 (face font-lock-keyword-face fontified t) 1169 1224 (fontified t) 1224 1229 (face font-lock-keyword-face fontified t) 1229 1230 (fontified t) 1230 1244 (face font-lock-function-name-face fontified t) 1244 1251 (fontified t) 1251 1268 (face font-lock-keyword-face fontified t) 1268 1331 (fontified t) 1331 1336 (face font-lock-keyword-face fontified t) 1336 1337 (fontified t) 1337 1355 (face font-lock-function-name-face fontified t) 1355 1365 (fontified t) 1365 1369 (face font-lock-keyword-face fontified t) 1369 1391 (fontified t) 1391 1401 (face font-lock-builtin-face fontified t) 1401 1434 (fontified t) 1434 1447 (face font-lock-builtin-face fontified t) 1447 1448 (fontified t) 1448 1456 (face font-lock-builtin-face fontified t) 1456 1492 (fontified t) 1492 1500 (face font-lock-builtin-face fontified t) 1500 1505 (face font-lock-builtin-face fontified t) 1505 1538 (fontified t) 1538 1554 (face font-lock-builtin-face fontified t) 1554 1555 (fontified t) 1555 1563 (face font-lock-builtin-face fontified t) 1563 1573 (fontified t) 5740 5742 (fontified t) 5742 5750 (face font-lock-keyword-face fontified t) 5750 5751 (fontified t) 5751 5768 (face font-lock-function-name-face fontified t) 5768 5770 (fontified t) 5770 5779 (face font-lock-type-face fontified t) 5779 5785 (fontified t) 5785 5790 (face font-lock-type-face fontified t) 5790 5799 (fontified t) 5799 5808 (face font-lock-keyword-face fontified t) 5808 5825 (fontified t) 5825 5829 (face font-lock-comment-delimiter-face fontified t) 5829 5905 (face font-lock-comment-face fontified t) 5905 5909 (face font-lock-comment-delimiter-face fontified t) 5909 5956 (face font-lock-comment-face fontified t) 5956 5960 (face font-lock-comment-delimiter-face fontified t) 5960 6036 (face font-lock-comment-face fontified t) 6036 6037 (fontified t) 6037 6038 (fontified t) 6038 6043 (fontified t face font-lock-keyword-face) 6043 6044 (fontified t) 6044 6062 (fontified t face font-lock-function-name-face) 6062 6090 (fontified t) 6090 6289 (fontified t face font-lock-doc-face) 6289 6293 (fontified t) 6293 6296 (fontified t face font-lock-keyword-face) 6296 6316 (fontified t) 6316 6320 (fontified t face font-lock-keyword-face) 6320 6328 (fontified t) 6328 6340 (fontified t face font-lock-keyword-face) 6340 6352 (fontified t) 6352 6358 (fontified t face font-lock-keyword-face) 6358 6405 (fontified t) 6405 6408 (fontified t face font-lock-comment-delimiter-face) 6408 6431 (fontified t face font-lock-comment-face) 6431 6451 (fontified t) 6451 6458 (fontified t face font-lock-string-face) 6458 6490 (fontified t) 6490 6493 (fontified t face font-lock-keyword-face) 6493 6529 (fontified t) 6529 6543 (fontified t face font-lock-keyword-face) 6543 6566 (fontified t) 6566 6586 (fontified t face font-lock-keyword-face) 6586 6651 (fontified t) 6651 6654 (fontified t face font-lock-comment-delimiter-face) 6654 6697 (fontified t face font-lock-comment-face) 6697 6726 (fontified t) 6726 6734 (fontified t face font-lock-string-face) 6734 6816 (fontified t) 6816 6819 (fontified t face font-lock-comment-delimiter-face) 6819 6891 (fontified t face font-lock-comment-face) 6891 6910 (fontified t) 6910 6916 (fontified t face font-lock-keyword-face) 6916 6948 (fontified t) 6948 6961 (fontified t face font-lock-keyword-face) 6961 6968 (fontified t) 6968 6978 (fontified t face font-lock-string-face) 6978 7003 (fontified t) 7003 7006 (fontified t face font-lock-comment-delimiter-face) 7006 7026 (fontified t face font-lock-comment-face) 7026 7035 (fontified t) 7035 7040 (fontified t face font-lock-warning-face) 7040 7055 (fontified t) 7055 7058 (fontified t face font-lock-comment-delimiter-face) 7058 7104 (fontified t face font-lock-comment-face) 7104 7114 (fontified t) 7114 7117 (fontified t face font-lock-comment-delimiter-face) 7117 7178 (fontified t face font-lock-comment-face) 7178 7189 (fontified t) 7189 7193 (fontified t face font-lock-keyword-face) 7193 7253 (fontified t) 7253 7258 (fontified t face font-lock-warning-face) 7258 7284 (fontified t) 7284 7287 (fontified t face font-lock-comment-delimiter-face) 7287 7322 (fontified t face font-lock-comment-face) 7322 7333 (fontified t) 7333 7336 (fontified t face font-lock-keyword-face) 7336 7396 (fontified t) 7396 7398 (fontified t face font-lock-keyword-face) 7398 7497 (fontified t) 7497 7502 (fontified t face font-lock-keyword-face) 7502 7555 (fontified t) 7555 7559 (fontified t face font-lock-keyword-face) 7559 7615 (fontified t) 7615 7618 (fontified t face font-lock-comment-delimiter-face) 7618 7628 (fontified t face font-lock-comment-face) 7628 7661 (fontified t) 7661 7664 (fontified t face font-lock-comment-delimiter-face) 7664 7684 (fontified t face font-lock-comment-face) 7684 7701 (fontified t) 7701 7706 (face font-lock-warning-face fontified t) 7706 7731 (fontified t) 7731 7739 (face font-lock-keyword-face fontified t) 7739 7740 (fontified t) 7740 7747 (face font-lock-function-name-face fontified t) 7747 7750 (fontified t) 7750 7754 (face font-lock-type-face fontified t) 7754 7766 (fontified t) 7766 7781 (face font-lock-builtin-face fontified t) 7781 7870 (fontified t) 7870 7875 (face font-lock-type-face fontified t) 7875 7885 (fontified t) 7885 7892 (face font-lock-keyword-face fontified t) 7892 7947 (fontified t) 7947 7953 (face font-lock-keyword-face fontified t) 7953 7987 (fontified t) 7987 7988 (fontified t) 7988 7996 (fontified t face font-lock-keyword-face) 7996 7997 (fontified t) 7997 8019 (fontified t face font-lock-function-name-face) 8019 8026 (fontified t) 8026 8031 (fontified t face font-lock-type-face) 8031 8042 (fontified t) 8042 8045 (fontified t face font-lock-keyword-face) 8045 8064 (fontified t) 8064 8066 (fontified t face font-lock-keyword-face) 8066 8087 (fontified t) 8087 8097 (fontified t) 8097 8102 (face font-lock-keyword-face fontified t) 8102 8104 (fontified t) 8104 8117 (face font-lock-keyword-face fontified t) 8117 8148 (fontified t) 8148 8182 (face font-lock-string-face fontified t) 8182 8219 (fontified t) 8219 8224 (face font-lock-keyword-face fontified t) 8224 8237 (fontified t) 8237 8241 (face font-lock-comment-delimiter-face fontified t) 8241 8317 (face font-lock-comment-face fontified t) 8317 8321 (face font-lock-comment-delimiter-face fontified t) 8321 8341 (face font-lock-comment-face fontified t) 8341 8345 (face font-lock-comment-delimiter-face fontified t) 8345 8421 (face font-lock-comment-face fontified t) 8421 8422 (fontified t) 8422 8427 (fontified t face font-lock-keyword-face) 8427 8428 (fontified t) 8428 8445 (fontified t face font-lock-function-name-face) 8445 8456 (fontified t) 8456 8459 (fontified t) 8459 8463 (face font-lock-keyword-face fontified t) 8463 8474 (fontified t) 8474 8482 (face font-lock-builtin-face fontified t) 8482 8488 (fontified t) 8488 8491 (face font-lock-builtin-face fontified t) 8491 8495 (fontified t) 8495 8501 (face font-lock-builtin-face fontified t) 8501 8502 (fontified t) 8502 8509 (face font-lock-builtin-face fontified t) 8509 8511 (fontified t) 8511 8515 (face font-lock-builtin-face fontified t) 8515 8518 (fontified t) 8518 8526 (face font-lock-builtin-face fontified t) 8526 8527 (fontified t) 8527 8535 (face font-lock-builtin-face fontified t) 8535 8538 (fontified t) 8538 8548 (face font-lock-builtin-face fontified t) 8548 8549 (fontified t) 8549 8553 (face font-lock-builtin-face fontified t) 8553 8556 (fontified t) 8556 8568 (face font-lock-builtin-face fontified t) 8568 8569 (fontified t) 8569 8574 (face font-lock-builtin-face fontified t) 8574 8579 (fontified t) 8579 8582 (face font-lock-builtin-face fontified t) 8582 8586 (fontified t) 8586 8587 (fontified t) 8587 8588 (fontified t) 8588 8593 (fontified t face font-lock-keyword-face) 8593 8594 (fontified t) 8594 8601 (fontified t face font-lock-function-name-face) 8601 8607 (fontified t) 8607 8612 (fontified t face font-lock-type-face) 8612 8624 (fontified t) 8624 8628 (fontified t face font-lock-keyword-face) 8628 8685 (fontified t) 8685 8687 (fontified t face font-lock-keyword-face) 8687 8741 (fontified t) 8741 8743 (fontified t face font-lock-keyword-face) 8743 8800 (fontified t) 8800 8811 (fontified t face font-lock-builtin-face) 8811 8860 (fontified t) 8860 8872 (fontified t face font-lock-keyword-face) 8872 8882 (fontified t) 8882 8904 (fontified t face font-lock-keyword-face) 8904 8921 (fontified t) 8921 8925 (fontified t face font-lock-keyword-face) 8925 8973 (fontified t) 8973 8980 (fontified t face font-lock-builtin-face) 8980 8981 (fontified t) 8981 8988 (fontified t face font-lock-builtin-face) 8988 9148 (fontified t) 9148 9197 (fontified t) 9197 9198 (fontified t) 9198 9203 (fontified t face font-lock-keyword-face) 9203 9204 (fontified t) 9204 9212 (fontified t face font-lock-function-name-face) 9212 9218 (fontified t) 9218 9223 (fontified t face font-lock-type-face) 9223 9235 (fontified t) 9235 9239 (fontified t face font-lock-keyword-face) 9239 9296 (fontified t) 9296 9298 (fontified t face font-lock-keyword-face) 9298 9352 (fontified t) 9352 9354 (fontified t face font-lock-keyword-face) 9354 9411 (fontified t) 9411 9422 (fontified t face font-lock-builtin-face) 9422 9471 (fontified t) 9471 9483 (fontified t face font-lock-keyword-face) 9483 9493 (fontified t) 9493 9515 (fontified t face font-lock-keyword-face) 9515 9532 (fontified t) 9532 9536 (fontified t face font-lock-keyword-face) 9536 9584 (fontified t) 9584 9591 (fontified t face font-lock-builtin-face) 9591 9592 (fontified t) 9592 9598 (fontified t face font-lock-builtin-face) 9598 9701 (fontified t) 9701 9703 (fontified t face font-lock-keyword-face) 9703 9714 (fontified t) 9714 9781 (fontified t) 9781 9784 (face font-lock-comment-delimiter-face fontified t) 9784 9843 (face font-lock-comment-face fontified t) 9843 9844 (fontified t) 9844 9849 (fontified t face font-lock-keyword-face) 9849 9850 (fontified t) 9850 9854 (fontified t face font-lock-function-name-face) 9854 9860 (fontified t) 9860 9865 (fontified t face font-lock-type-face) 9865 9886 (fontified t) 9886 9904 (fontified t face font-lock-string-face) 9904 9913 (fontified t) 9913 9917 (fontified t face font-lock-keyword-face) 9917 9939 (fontified t) 9939 9945 (fontified t face font-lock-keyword-face) 9945 9985 (fontified t) 9985 9990 (fontified t face font-lock-builtin-face) 9990 9991 (fontified t) 9991 9999 (fontified t face font-lock-builtin-face) 9999 10001 (fontified t) 10001 10006 (fontified t face font-lock-builtin-face) 10006 10041 (fontified t) 10041 10043 (fontified t face font-lock-keyword-face) 10043 10097 (fontified t) 10097 10099 (fontified t face font-lock-keyword-face) 10099 10132 (fontified t) 10132 10156 (fontified t) 10156 10167 (face font-lock-builtin-face fontified t) 10167 10216 (fontified t) 10216 10228 (face font-lock-keyword-face fontified t) 10228 10238 (fontified t) 10238 10260 (face font-lock-keyword-face fontified t) 10260 10277 (fontified t) 10277 10281 (face font-lock-keyword-face fontified t) 10281 10336 (fontified t) 10336 10338 (face font-lock-keyword-face fontified t) 10338 10347 (fontified t) 10347 10358 (face font-lock-string-face fontified t) 10358 10422 (fontified t) 10422 10429 (face font-lock-builtin-face fontified t) 10429 10430 (fontified t) 10430 10436 (face font-lock-builtin-face fontified t) 10436 10471 (fontified t) 10471 10476 (face font-lock-keyword-face fontified t) 10476 10507 (fontified t) 10507 10514 (face font-lock-builtin-face fontified t) 10514 10515 (fontified t) 10515 10520 (face font-lock-builtin-face fontified t) 10520 10558 (fontified t) 10558 10560 (face font-lock-keyword-face fontified t) 10560 10572 (fontified t) 10572 10575 (face font-lock-comment-delimiter-face fontified t) 10575 10582 (face font-lock-comment-face fontified t) 10582 10683 (fontified t) 10683 10686 (face font-lock-comment-delimiter-face fontified t) 10686 10793 (face font-lock-comment-face fontified t) 10793 10840 (fontified t) 10840 10845 (face font-lock-warning-face fontified t) 10845 10899 (fontified t) 10899 10900 (fontified t) 10900 10908 (face font-lock-keyword-face fontified t) 10908 10909 (fontified t) 10909 10922 (face font-lock-function-name-face fontified t) 10922 10925 (fontified t) 10925 10934 (face font-lock-type-face fontified t) 10934 10941 (fontified t) 10941 10946 (face font-lock-type-face fontified t) 10946 10957 (fontified t) 10957 10980 (face font-lock-keyword-face fontified t) 10980 11012 (fontified t) 11012 11019 (face font-lock-string-face fontified t) 11019 11021 (fontified t) 11021 11027 (fontified t) 11027 11041 (face font-lock-keyword-face fontified t) 11041 11043 (fontified t) 11043 11048 (face font-lock-keyword-face fontified t) 11048 11058 (fontified t) 11058 11071 (face font-lock-keyword-face fontified t) 11071 11092 (fontified t) 11092 11102 (face font-lock-string-face fontified t) 11102 11106 (fontified t) 11106 11107 (fontified t rear-nonsticky t) 11107 11108 (fontified t)) . 1) (undo-tree-id33 . -11108) (undo-tree-id34 . -7178) (undo-tree-id35 . -8236) (undo-tree-id36 . -8236) (undo-tree-id37 . -8236) (undo-tree-id38 . -8236) (undo-tree-id39 . -8236) (undo-tree-id40 . -8236) (undo-tree-id41 . -8236) (undo-tree-id42 . -8236) (undo-tree-id43 . -8236) (undo-tree-id44 . -8236) (undo-tree-id45 . -8236) (undo-tree-id46 . -8236) (undo-tree-id47 . -8236) (undo-tree-id48 . -8236) (undo-tree-id49 . -8236) (undo-tree-id50 . -8236) (undo-tree-id51 . -8236) (undo-tree-id52 . -8236) (undo-tree-id53 . -8236) (undo-tree-id54 . -8236) (undo-tree-id55 . -8236) (undo-tree-id56 . -8236) (undo-tree-id57 . -8236) (undo-tree-id58 . -8236) (undo-tree-id59 . -8236) (undo-tree-id60 . -8236) (undo-tree-id61 . -8236) (undo-tree-id62 . -8236) (undo-tree-id63 . -8236) (undo-tree-id64 . -8236) (undo-tree-id65 . -8236) (undo-tree-id66 . -8236) (undo-tree-id67 . -8236) (undo-tree-id68 . -8236) (undo-tree-id69 . -8236) (undo-tree-id70 . -8236) (undo-tree-id71 . -8236) (undo-tree-id72 . -8236) (undo-tree-id73 . -8236) (undo-tree-id74 . -8236) (undo-tree-id75 . -8236) (undo-tree-id76 . -8236) (undo-tree-id77 . -8236) (undo-tree-id78 . -8236) (undo-tree-id79 . -8236) (undo-tree-id80 . -8236) (undo-tree-id81 . -8236) (undo-tree-id82 . -8236) (undo-tree-id83 . -8236) (undo-tree-id84 . -8236) (undo-tree-id85 . -8236) (undo-tree-id86 . -8236) (undo-tree-id87 . -8236) (undo-tree-id88 . -8236) (undo-tree-id89 . -8236) (undo-tree-id90 . -8236) (undo-tree-id91 . -8236) (undo-tree-id92 . -8236) (undo-tree-id93 . -8236) (undo-tree-id94 . -8236) (undo-tree-id95 . -8236) (undo-tree-id96 . -8236) (undo-tree-id97 . -8236) (undo-tree-id98 . -8236) (undo-tree-id99 . -8236) (undo-tree-id100 . -8236) (undo-tree-id101 . -8236) (undo-tree-id102 . -8236) (undo-tree-id103 . -8236) (undo-tree-id104 . -8236) (undo-tree-id105 . -8236) (undo-tree-id106 . -8236) (undo-tree-id107 . -8236) (undo-tree-id108 . -8236) (undo-tree-id109 . -8236) (undo-tree-id110 . -8236) (undo-tree-id111 . -8236) (undo-tree-id112 . -8236) (undo-tree-id113 . -8236) (undo-tree-id114 . -8236) (undo-tree-id115 . -8236) (undo-tree-id116 . -8236) (undo-tree-id117 . -8236) (undo-tree-id118 . -8236) (undo-tree-id119 . -8236) (undo-tree-id120 . -8236) (undo-tree-id121 . -8236) (undo-tree-id122 . -8236) (undo-tree-id123 . -8236) (undo-tree-id124 . -8236) (undo-tree-id125 . -8236) (undo-tree-id126 . -8236) (undo-tree-id127 . -8236) (undo-tree-id128 . -8236) (undo-tree-id129 . -8236) (undo-tree-id130 . -8236) (undo-tree-id131 . -8236) (undo-tree-id132 . -8236) (undo-tree-id133 . -7922) (undo-tree-id134 . -7922) (undo-tree-id135 . -7922) (undo-tree-id136 . -7922) (undo-tree-id137 . -7922) (undo-tree-id138 . -7922) (undo-tree-id139 . -7922) (undo-tree-id140 . -7922) (undo-tree-id141 . -7922) (undo-tree-id142 . -7922) (undo-tree-id143 . -7922) (undo-tree-id144 . -7922) (undo-tree-id145 . -11108) (t 26976 44036 0 0)) nil (26976 44307 906334 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11074 . 11075) (nil fontified nil 1 . 11075) (1 . 11075)) nil (26976 44307 906259 0) 0 nil])
([nil nil ((11075 . 11076)) nil (26976 44307 906255 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  ;; On n'importe PLUS with-transaction
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; CONFIG & POOL (Standard - Inchangé)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
            (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432))
            (app (or (getf config :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case (progn (postmodern:disconnect-toplevel)
                            (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
                            (setf *started* t))
         (condition (c) (setf *started* nil) (error \"DB start! failed: ~a\" c))))
     #-postmodern (setf *started* t))
    ((:scoped :pooled-native) (%ensure-pool-sema! config) (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started* (when (eq *connection-mode* :toplevel)
                    #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil)) t)

(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))) :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app) (funcall thunk))) #-postmodern (funcall thunk))
      (:pooled-native (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0)))) (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn (labels ((acquire-slot () (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0)) (if (< (get-internal-real-time) deadline) (acquire-slot) (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*))))) (acquire-slot)) (%pool-incf! '*pool-waiters* -1) (%pool-incf! '*pool-inflight* 1)
                #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (unwind-protect (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t) (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\")) (funcall thunk)) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
                #-postmodern (unwind-protect (funcall thunk) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts) `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; GESTION MANUELLE DES TRANSACTIONS (BARE METAL)
;;; ---------------------------------------------------------------------------

(defun %exec-bare (sql)
  \"Exécute du SQL brut sans wrapper d'erreur complexe.\"
  #+postmodern (postmodern:execute sql)
  #-postmodern (error \"Not implemented\"))

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécution manuelle : BEGIN -> Body -> COMMIT.
   Si erreur (n'importe laquelle) -> ROLLBACK via unwind-protect.
   Zéro interception d'erreurs métier ici.\"
  (let ((attempt 0))
    (loop
      (handler-case
          (return ;; Si succès, on retourne le résultat du bloc
            (ensure-connection
              ;; 1. BEGIN
              (%exec-bare \"BEGIN\")
              
              (let ((success nil))
                (unwind-protect
                     (multiple-value-prog1
                         (funcall thunk)
                       ;; 2. Si on arrive là, pas d'erreur -> COMMIT
                       (%exec-bare \"COMMIT\")
                       (setf success t))
                  
                  ;; 3. NETTOYAGE : Si pas succès (donc erreur ou saut), ROLLBACK
                  (unless success
                    (ignore-errors (%exec-bare \"ROLLBACK\")))))))
        
        ;; CATCH UNIQUEMENT LES ERREURS DB POUR RETRY
        (cl-postgres-error:postgres-error (c)
           ;; C'est une vraie erreur DB, on regarde si on retry
           (let ((mapped (lumen.data.errors:map-db-error c)))
             (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (progn
                   (incf attempt)
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                 
                 ;; Sinon c'est fatal, on relance
                 (error c))))
        
        ;; TOUTES LES AUTRES ERREURS (Business, Lisp, etc.) PASSENT AU TRAVERS
        ;; Le unwind-protect fera le ROLLBACK.
        ))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms)))) ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Avec Exec simplifié)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (condition (c) (translate-db-error c)))))

;; EXEC simplifié : Ne capture PAS les erreurs génériques, seulement DB.
(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      
      ;; ON NE CATCH QUE LES ERREURS POSTGRES. 
      ;; Les BusinessErrors passent au travers !
      (cl-postgres-error:postgres-error (c) 
         (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 60 (fontified t) 60 63 (face font-lock-comment-delimiter-face fontified t) 63 98 (face font-lock-comment-face fontified t) 98 101 (fontified t) 101 113 (face font-lock-builtin-face fontified t) 113 114 (fontified t) 114 125 (face font-lock-builtin-face fontified t) 125 126 (fontified t) 126 143 (face font-lock-builtin-face fontified t) 143 144 (fontified t) 144 164 (face font-lock-builtin-face fontified t) 164 169 (fontified t) 169 181 (face font-lock-builtin-face fontified t) 181 182 (fontified t) 182 200 (face font-lock-builtin-face fontified t) 200 201 (fontified t) 201 211 (face font-lock-builtin-face fontified t) 211 216 (fontified t) 216 228 (face font-lock-builtin-face fontified t) 228 229 (fontified t) 229 248 (face font-lock-builtin-face fontified t) 248 249 (fontified t) 249 267 (face font-lock-builtin-face fontified t) 267 268 (fontified t) 268 288 (face font-lock-builtin-face fontified t) 288 289 (fontified t) 289 312 (face font-lock-builtin-face fontified t) 312 317 (fontified t) 317 329 (face font-lock-builtin-face fontified t) 329 330 (fontified t) 330 348 (face font-lock-builtin-face fontified t) 348 349 (fontified t) 349 368 (face font-lock-builtin-face fontified t) 368 369 (fontified t) 369 382 (face font-lock-builtin-face fontified t) 382 383 (fontified t) 383 404 (face font-lock-builtin-face fontified t) 404 409 (fontified t) 409 421 (face font-lock-builtin-face fontified t) 421 422 (fontified t) 422 441 (face font-lock-builtin-face fontified t) 441 442 (fontified t) 442 463 (face font-lock-builtin-face fontified t) 463 464 (fontified t) 464 482 (face font-lock-builtin-face fontified t) 482 487 (fontified t) 487 494 (face font-lock-builtin-face fontified t) 494 495 (fontified t) 495 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 509 (face font-lock-builtin-face fontified t) 509 510 (fontified t) 510 518 (face font-lock-builtin-face fontified t) 518 530 (fontified t) 530 538 (face font-lock-builtin-face fontified t) 538 539 (fontified t) 539 548 (face font-lock-builtin-face fontified t) 548 549 (fontified t) 549 554 (face font-lock-builtin-face fontified t) 554 566 (fontified t) 566 576 (face font-lock-builtin-face fontified t) 576 577 (fontified t) 577 595 (face font-lock-builtin-face fontified t) 595 596 (fontified t) 596 610 (face font-lock-builtin-face fontified t) 610 622 (fontified t) 622 640 (face font-lock-builtin-face fontified t) 640 641 (fontified t) 641 664 (face font-lock-builtin-face fontified t) 664 676 (fontified t) 676 707 (face font-lock-builtin-face fontified t) 707 708 (fontified t) 708 724 (face font-lock-builtin-face fontified t) 724 729 (fontified t) 729 739 (face font-lock-keyword-face fontified t) 739 740 (fontified t) 740 754 (face font-lock-builtin-face fontified t) 754 757 (fontified t) 757 762 (face font-lock-comment-delimiter-face fontified t) 762 837 (face font-lock-comment-face fontified t) 837 842 (face font-lock-comment-delimiter-face fontified t) 842 878 (face font-lock-comment-face fontified t) 878 883 (face font-lock-comment-delimiter-face fontified t) 883 958 (face font-lock-comment-face fontified t) 958 959 (fontified t) 959 965 (face font-lock-keyword-face fontified t) 965 966 (fontified t) 966 977 (face font-lock-variable-name-face fontified t) 977 992 (fontified t) 992 1007 (face font-lock-string-face fontified t) 1007 1011 (fontified t) 1011 1017 (face font-lock-keyword-face fontified t) 1017 1018 (fontified t) 1018 1033 (face font-lock-variable-name-face fontified t) 1033 1038 (fontified t) 1038 1044 (face font-lock-keyword-face fontified t) 1044 1045 (fontified t) 1045 1059 (face font-lock-variable-name-face fontified t) 1059 1064 (fontified t) 1064 1070 (face font-lock-keyword-face fontified t) 1070 1071 (fontified t) 1071 1082 (face font-lock-variable-name-face fontified t) 1082 1089 (fontified t) 1089 1095 (face font-lock-keyword-face fontified t) 1095 1096 (fontified t) 1096 1107 (face font-lock-variable-name-face fontified t) 1107 1112 (fontified t) 1112 1118 (face font-lock-keyword-face fontified t) 1118 1119 (fontified t) 1119 1133 (face font-lock-variable-name-face fontified t) 1133 1142 (fontified t) 1142 1147 (face font-lock-keyword-face fontified t) 1147 1148 (fontified t) 1148 1159 (face font-lock-function-name-face fontified t) 1159 1175 (fontified t) 1175 1192 (face font-lock-keyword-face fontified t) 1192 1247 (fontified t) 1247 1252 (face font-lock-keyword-face fontified t) 1252 1253 (fontified t) 1253 1267 (face font-lock-function-name-face fontified t) 1267 1274 (fontified t) 1274 1291 (face font-lock-keyword-face fontified t) 1291 1354 (fontified t) 1354 1359 (face font-lock-keyword-face fontified t) 1359 1360 (fontified t) 1360 1378 (face font-lock-function-name-face fontified t) 1378 1388 (fontified t) 1388 1392 (face font-lock-keyword-face fontified t) 1392 1414 (fontified t) 1414 1424 (face font-lock-builtin-face fontified t) 1424 1457 (fontified t) 1457 1470 (face font-lock-builtin-face fontified t) 1470 1471 (fontified t) 1471 1479 (face font-lock-builtin-face fontified t) 1479 1500 (fontified t) 1500 1515 (fontified t) 1515 1528 (face font-lock-builtin-face fontified t) 1528 1561 (fontified t) 1561 1577 (face font-lock-builtin-face fontified t) 1577 1578 (fontified t) 1578 1586 (face font-lock-builtin-face fontified t) 1586 1596 (fontified t) 9846 9847 (fontified t) 9847 9852 (fontified t face font-lock-keyword-face) 9852 9853 (fontified t) 9853 9857 (fontified t face font-lock-function-name-face) 9857 9863 (fontified t) 9863 9868 (fontified t face font-lock-type-face) 9868 9889 (fontified t) 9889 9907 (fontified t face font-lock-string-face) 9907 9916 (fontified t) 9916 9920 (fontified t face font-lock-keyword-face) 9920 9942 (fontified t) 9942 9948 (fontified t face font-lock-keyword-face) 9948 9988 (fontified t) 9988 9993 (fontified t face font-lock-builtin-face) 9993 9994 (fontified t) 9994 10002 (fontified t face font-lock-builtin-face) 10002 10004 (fontified t) 10004 10009 (fontified t face font-lock-builtin-face) 10009 10044 (fontified t) 10044 10046 (fontified t face font-lock-keyword-face) 10046 10100 (fontified t) 10100 10102 (fontified t face font-lock-keyword-face) 10102 10159 (fontified t) 10159 10170 (fontified t face font-lock-builtin-face) 10170 10219 (fontified t) 10219 10231 (fontified t face font-lock-keyword-face) 10231 10232 (fontified t) 10232 10241 (fontified t) 10241 10263 (face font-lock-keyword-face fontified t) 10263 10280 (fontified t) 10280 10284 (face font-lock-keyword-face fontified t) 10284 10339 (fontified t) 10339 10341 (face font-lock-keyword-face fontified t) 10341 10350 (fontified t) 10350 10361 (face font-lock-string-face fontified t) 10361 10425 (fontified t) 10425 10432 (face font-lock-builtin-face fontified t) 10432 10433 (fontified t) 10433 10439 (face font-lock-builtin-face fontified t) 10439 10474 (fontified t) 10474 10479 (face font-lock-keyword-face fontified t) 10479 10510 (fontified t) 10510 10517 (face font-lock-builtin-face fontified t) 10517 10518 (fontified t) 10518 10523 (face font-lock-builtin-face fontified t) 10523 10561 (fontified t) 10561 10563 (face font-lock-keyword-face fontified t) 10563 10575 (fontified t) 10575 10578 (face font-lock-comment-delimiter-face fontified t) 10578 10585 (face font-lock-comment-face fontified t) 10585 10693 (fontified t) 10693 10696 (face font-lock-comment-delimiter-face fontified t) 10696 10735 (face font-lock-comment-face fontified t) 10735 10741 (fontified t) 10741 10744 (face font-lock-comment-delimiter-face fontified t) 10744 10784 (face font-lock-comment-face fontified t) 10784 10866 (fontified t) 10866 10867 (fontified t) 10867 10875 (face font-lock-keyword-face fontified t) 10875 10876 (fontified t) 10876 10889 (face font-lock-function-name-face fontified t) 10889 10892 (fontified t) 10892 10901 (face font-lock-type-face fontified t) 10901 10908 (fontified t) 10908 10913 (face font-lock-type-face fontified t) 10913 10924 (fontified t) 10924 10947 (face font-lock-keyword-face fontified t) 10947 10979 (fontified t) 10979 10986 (face font-lock-string-face fontified t) 10986 10988 (fontified t) 10988 10994 (fontified t) 10994 11008 (face font-lock-keyword-face fontified t) 11008 11010 (fontified t) 11010 11015 (face font-lock-keyword-face fontified t) 11015 11025 (fontified t) 11025 11038 (face font-lock-keyword-face fontified t) 11038 11059 (fontified t) 11059 11069 (face font-lock-string-face fontified t) 11069 11073 (fontified t) 11073 11074 (fontified t rear-nonsticky t) 11074 11075 (fontified t)) . 1) (undo-tree-id146 . -11075) (undo-tree-id147 . -10232) (undo-tree-id148 . -11074) (undo-tree-id149 . -11074) (undo-tree-id150 . -11074) (undo-tree-id151 . -10232) (undo-tree-id152 . -11074) (undo-tree-id153 . -11074) (undo-tree-id154 . -10232) (undo-tree-id155 . -11074) (undo-tree-id156 . -11074) (undo-tree-id157 . -10232) (undo-tree-id158 . -11074) (undo-tree-id159 . -11074) (undo-tree-id160 . -11075) (undo-tree-id161 . -11075) (undo-tree-id162 . -11075) (undo-tree-id163 . -11075) (undo-tree-id164 . -11075) (undo-tree-id165 . -11075) (undo-tree-id166 . -11075) (undo-tree-id167 . -11075) (undo-tree-id168 . -11075) (t 26976 44307 0 0)) nil (26976 44453 163723 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11314 . 11315) (nil fontified nil 1 . 11315) (1 . 11315)) nil (26976 44453 163698 0) 0 nil])
([nil nil ((11315 . 11316)) nil (26976 44453 163694 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  ;; Import explicite de la classe d'erreur de base
  (:import-from :cl-postgres :database-error)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; CONFIG & POOL (Standard - Inchangé)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
            (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432))
            (app (or (getf config :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case (progn (postmodern:disconnect-toplevel)
                            (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
                            (setf *started* t))
         (condition (c) (setf *started* nil) (error \"DB start! failed: ~a\" c))))
     #-postmodern (setf *started* t))
    ((:scoped :pooled-native) (%ensure-pool-sema! config) (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started* (when (eq *connection-mode* :toplevel)
                    #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil)) t)

;; ----------------------------------------------------------------------------
;; Connexion Helper
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))) :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app) (funcall thunk))) #-postmodern (funcall thunk))
      (:pooled-native (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0)))) (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn (labels ((acquire-slot () (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0)) (if (< (get-internal-real-time) deadline) (acquire-slot) (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*))))) (acquire-slot)) (%pool-incf! '*pool-waiters* -1) (%pool-incf! '*pool-inflight* 1)
                #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (unwind-protect (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t) (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\")) (funcall thunk)) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
                #-postmodern (unwind-protect (funcall thunk) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts) `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; GESTION MANUELLE DES TRANSACTIONS (BARE METAL)
;;; ---------------------------------------------------------------------------

(defun %exec-bare (sql)
  \"Exécute du SQL brut sans wrapper d'erreur complexe.\"
  #+postmodern (postmodern:execute sql)
  #-postmodern (error \"Not implemented\"))

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécution manuelle : BEGIN -> Body -> COMMIT.
   Si erreur (n'importe laquelle) -> ROLLBACK via unwind-protect.
   Zéro interception d'erreurs métier ici.\"
  (let ((attempt 0))
    (loop
      (handler-case
          (return ;; Si succès, on retourne le résultat du bloc
            (ensure-connection
              ;; 1. BEGIN
              (%exec-bare \"BEGIN\")
              
              (let ((success nil))
                (unwind-protect
                     (multiple-value-prog1
                         (funcall thunk)
                       ;; 2. Si on arrive ici sans erreur, on commit
                       (%exec-bare \"COMMIT\")
                       (setf success t))
                  
                  ;; 3. NETTOYAGE : Si pas succès (donc erreur ou saut), ROLLBACK
                  (unless success
                    (ignore-errors (%exec-bare \"ROLLBACK\")))))))
        
        ;; CATCH UNIQUEMENT LES ERREURS DB POUR RETRY
        ;; Correction : On utilise cl-postgres:database-error
        (cl-postgres:database-error (c)
           ;; C'est une vraie erreur DB, on regarde si on retry
           (let ((mapped (lumen.data.errors:map-db-error c)))
             (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (progn
                   (incf attempt)
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                 
                 ;; Sinon c'est fatal, on relance
                 (error c))))
        
        ;; TOUTES LES AUTRES ERREURS (Business, Lisp, etc.) PASSENT AU TRAVERS
        ;; Le unwind-protect fera le ROLLBACK.
        ))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms)))) ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (cl-postgres:database-error (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (cl-postgres:database-error (c) (translate-db-error c)))))

;; EXEC simplifié : Ne capture QUE database-error
(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      
      ;; Correction : On utilise cl-postgres:database-error
      (cl-postgres:database-error (c) 
         (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 129 (fontified t) 129 141 (face font-lock-builtin-face fontified t) 141 142 (fontified t) 142 160 (face font-lock-builtin-face fontified t) 160 161 (fontified t) 161 171 (face font-lock-builtin-face fontified t) 171 176 (fontified t) 176 188 (face font-lock-builtin-face fontified t) 188 189 (fontified t) 189 208 (face font-lock-builtin-face fontified t) 208 209 (fontified t) 209 227 (face font-lock-builtin-face fontified t) 227 228 (fontified t) 228 248 (face font-lock-builtin-face fontified t) 248 249 (fontified t) 249 272 (face font-lock-builtin-face fontified t) 272 277 (fontified t) 277 289 (face font-lock-builtin-face fontified t) 289 290 (fontified t) 290 308 (face font-lock-builtin-face fontified t) 308 309 (fontified t) 309 328 (face font-lock-builtin-face fontified t) 328 329 (fontified t) 329 342 (face font-lock-builtin-face fontified t) 342 343 (fontified t) 343 364 (face font-lock-builtin-face fontified t) 364 369 (fontified t) 369 381 (face font-lock-builtin-face fontified t) 381 382 (fontified t) 382 401 (face font-lock-builtin-face fontified t) 401 402 (fontified t) 402 423 (face font-lock-builtin-face fontified t) 423 424 (fontified t) 424 442 (face font-lock-builtin-face fontified t) 442 446 (fontified t) 446 449 (face font-lock-comment-delimiter-face fontified t) 449 496 (face font-lock-comment-face fontified t) 496 499 (fontified t) 499 511 (face font-lock-builtin-face fontified t) 511 512 (fontified t) 512 524 (face font-lock-builtin-face fontified t) 524 525 (fontified t) 525 540 (face font-lock-builtin-face fontified t) 540 545 (fontified t) 545 552 (face font-lock-builtin-face fontified t) 552 553 (fontified t) 553 560 (face font-lock-builtin-face fontified t) 560 561 (fontified t) 561 567 (face font-lock-builtin-face fontified t) 567 568 (fontified t) 568 576 (face font-lock-builtin-face fontified t) 576 588 (fontified t) 588 596 (face font-lock-builtin-face fontified t) 596 597 (fontified t) 597 606 (face font-lock-builtin-face fontified t) 606 607 (fontified t) 607 612 (face font-lock-builtin-face fontified t) 612 624 (fontified t) 624 634 (face font-lock-builtin-face fontified t) 634 635 (fontified t) 635 653 (face font-lock-builtin-face fontified t) 653 654 (fontified t) 654 668 (face font-lock-builtin-face fontified t) 668 680 (fontified t) 680 698 (face font-lock-builtin-face fontified t) 698 699 (fontified t) 699 722 (face font-lock-builtin-face fontified t) 722 734 (fontified t) 734 765 (face font-lock-builtin-face fontified t) 765 766 (fontified t) 766 782 (face font-lock-builtin-face fontified t) 782 787 (fontified t) 787 797 (face font-lock-keyword-face fontified t) 797 798 (fontified t) 798 812 (face font-lock-builtin-face fontified t) 812 815 (fontified t) 815 820 (face font-lock-comment-delimiter-face fontified t) 820 895 (face font-lock-comment-face fontified t) 895 900 (face font-lock-comment-delimiter-face fontified t) 900 936 (face font-lock-comment-face fontified t) 936 941 (face font-lock-comment-delimiter-face fontified t) 941 1016 (face font-lock-comment-face fontified t) 1016 1017 (fontified t) 1017 1023 (face font-lock-keyword-face fontified t) 1023 1024 (fontified t) 1024 1035 (face font-lock-variable-name-face fontified t) 1035 1050 (fontified t) 1050 1065 (face font-lock-string-face fontified t) 1065 1069 (fontified t) 1069 1075 (face font-lock-keyword-face fontified t) 1075 1076 (fontified t) 1076 1091 (face font-lock-variable-name-face fontified t) 1091 1096 (fontified t) 1096 1102 (face font-lock-keyword-face fontified t) 1102 1103 (fontified t) 1103 1117 (face font-lock-variable-name-face fontified t) 1117 1122 (fontified t) 1122 1128 (face font-lock-keyword-face fontified t) 1128 1129 (fontified t) 1129 1140 (face font-lock-variable-name-face fontified t) 1140 1147 (fontified t) 1147 1153 (face font-lock-keyword-face fontified t) 1153 1154 (fontified t) 1154 1165 (face font-lock-variable-name-face fontified t) 1165 1170 (fontified t) 1170 1176 (face font-lock-keyword-face fontified t) 1176 1177 (fontified t) 1177 1191 (face font-lock-variable-name-face fontified t) 1191 1200 (fontified t) 1200 1205 (face font-lock-keyword-face fontified t) 1205 1206 (fontified t) 1206 1217 (face font-lock-function-name-face fontified t) 1217 1233 (fontified t) 1233 1250 (face font-lock-keyword-face fontified t) 1250 1305 (fontified t) 1305 1310 (face font-lock-keyword-face fontified t) 1310 1311 (fontified t) 1311 1325 (face font-lock-function-name-face fontified t) 1325 1332 (fontified t) 1332 1349 (face font-lock-keyword-face fontified t) 1349 1412 (fontified t) 1412 1417 (face font-lock-keyword-face fontified t) 1417 1418 (fontified t) 1418 1436 (face font-lock-function-name-face fontified t) 1436 1446 (fontified t) 1446 1450 (face font-lock-keyword-face fontified t) 1450 1472 (fontified t) 1472 1482 (face font-lock-builtin-face fontified t) 1482 1500 (fontified t) 1500 1515 (fontified t) 1515 1528 (face font-lock-builtin-face fontified t) 1528 1529 (fontified t) 1529 1537 (face font-lock-builtin-face fontified t) 1537 1544 (fontified t) 10129 10130 (fontified t) 10130 10135 (fontified t face font-lock-keyword-face) 10135 10136 (fontified t) 10136 10140 (fontified t face font-lock-function-name-face) 10140 10146 (fontified t) 10146 10151 (fontified t face font-lock-type-face) 10151 10172 (fontified t) 10172 10190 (fontified t face font-lock-string-face) 10190 10199 (fontified t) 10199 10203 (fontified t face font-lock-keyword-face) 10203 10225 (fontified t) 10225 10231 (fontified t face font-lock-keyword-face) 10231 10271 (fontified t) 10271 10276 (fontified t face font-lock-builtin-face) 10276 10277 (fontified t) 10277 10285 (fontified t face font-lock-builtin-face) 10285 10287 (fontified t) 10287 10292 (fontified t face font-lock-builtin-face) 10292 10327 (fontified t) 10327 10329 (fontified t face font-lock-keyword-face) 10329 10383 (fontified t) 10383 10385 (fontified t face font-lock-keyword-face) 10385 10442 (fontified t) 10442 10453 (fontified t face font-lock-builtin-face) 10453 10497 (fontified t) 10497 10502 (fontified t) 10502 10514 (face font-lock-keyword-face fontified t) 10514 10524 (fontified t) 10524 10546 (face font-lock-keyword-face fontified t) 10546 10563 (fontified t) 10563 10567 (face font-lock-keyword-face fontified t) 10567 10622 (fontified t) 10622 10624 (face font-lock-keyword-face fontified t) 10624 10633 (fontified t) 10633 10644 (face font-lock-string-face fontified t) 10644 10708 (fontified t) 10708 10715 (face font-lock-builtin-face fontified t) 10715 10716 (fontified t) 10716 10722 (face font-lock-builtin-face fontified t) 10722 10757 (fontified t) 10757 10762 (face font-lock-keyword-face fontified t) 10762 10793 (fontified t) 10793 10800 (face font-lock-builtin-face fontified t) 10800 10801 (fontified t) 10801 10806 (face font-lock-builtin-face fontified t) 10806 10844 (fontified t) 10844 10846 (face font-lock-keyword-face fontified t) 10846 10858 (fontified t) 10858 10861 (face font-lock-comment-delimiter-face fontified t) 10861 10868 (face font-lock-comment-face fontified t) 10868 10976 (fontified t) 10976 10979 (face font-lock-comment-delimiter-face fontified t) 10979 11030 (face font-lock-comment-face fontified t) 11030 11106 (fontified t) 11106 11107 (fontified t) 11107 11115 (face font-lock-keyword-face fontified t) 11115 11116 (fontified t) 11116 11129 (face font-lock-function-name-face fontified t) 11129 11132 (fontified t) 11132 11141 (face font-lock-type-face fontified t) 11141 11148 (fontified t) 11148 11153 (face font-lock-type-face fontified t) 11153 11164 (fontified t) 11164 11187 (face font-lock-keyword-face fontified t) 11187 11219 (fontified t) 11219 11226 (face font-lock-string-face fontified t) 11226 11228 (fontified t) 11228 11234 (fontified t) 11234 11248 (face font-lock-keyword-face fontified t) 11248 11250 (fontified t) 11250 11255 (face font-lock-keyword-face fontified t) 11255 11265 (fontified t) 11265 11278 (face font-lock-keyword-face fontified t) 11278 11299 (fontified t) 11299 11309 (face font-lock-string-face fontified t) 11309 11313 (fontified t) 11313 11314 (fontified t rear-nonsticky t) 11314 11315 (fontified t)) . 1) (undo-tree-id169 . -11315) (undo-tree-id170 . -10497) (undo-tree-id171 . -11314) (undo-tree-id172 . -11314) (undo-tree-id173 . -11314) (undo-tree-id174 . -11193) (undo-tree-id175 . -11193) (undo-tree-id176 . -11193) (undo-tree-id177 . -11193) (undo-tree-id178 . -11193) (undo-tree-id179 . -11193) (undo-tree-id180 . -11193) (undo-tree-id181 . -11193) (undo-tree-id182 . -11193) (undo-tree-id183 . -11193) (undo-tree-id184 . -11193) (undo-tree-id185 . -11193) (undo-tree-id186 . -11315) (t 26976 44453 0 0)) nil (26976 51444 318799 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12034 . 12035) (nil fontified nil 1 . 12035) (1 . 12035)) nil (26976 51444 318778 0) 0 nil])
([nil nil ((12035 . 12036)) nil (26976 51444 318775 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:import-from :cl-postgres :database-error) ;; On utilise la vraie classe de base
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; CONFIG & POOL (Inchangé)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms) (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
            (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432))
            (app (or (getf config :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case (progn (postmodern:disconnect-toplevel)
                            (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl :application-name app)
                            (setf *started* t))
         (condition (c) (setf *started* nil) (error \"DB start! failed: ~a\" c))))
     #-postmodern (setf *started* t))
    ((:scoped :pooled-native) (%ensure-pool-sema! config) (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started* (when (eq *connection-mode* :toplevel)
                    #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil)) t)

;; ----------------------------------------------------------------------------
;; Connexion Helper
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native))) :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (app (or (getf cfg :application-name) \"\")) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :application-name app) (funcall thunk))) #-postmodern (funcall thunk))
      (:pooled-native (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second (/ (max 1 *pool-wait-ms*) 1000.0)))) (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn (labels ((acquire-slot () (or (bt:wait-on-semaphore *pool-sema* :timeout (/ *pool-wait-ms* 1000.0)) (if (< (get-internal-real-time) deadline) (acquire-slot) (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*))))) (acquire-slot)) (%pool-incf! '*pool-waiters* -1) (%pool-incf! '*pool-inflight* 1)
                #+postmodern (let ((db (getf cfg :database)) (user (getf cfg :user)) (pass (getf cfg :password)) (host (or (getf cfg :host) \"localhost\")) (port (or (getf cfg :port) 5432)) (use-ssl (%sslmode->use-ssl (getf cfg :sslmode)))) (unwind-protect (postmodern:with-connection (list db user pass host :port port :use-ssl use-ssl :pooled-p t) (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\")) (funcall thunk)) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
                #-postmodern (unwind-protect (funcall thunk) (%pool-incf! '*pool-inflight* -1) (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0) (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts) `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; GESTION DES TRANSACTIONS PAR RÉIFICATION (Safe)
;;; ---------------------------------------------------------------------------

(defun %exec-bare (sql)
  \"Exécute du SQL brut.\"
  #+postmodern (postmodern:execute sql)
  #-postmodern (error \"Not implemented\"))

(defun try-execute-tx-once (thunk)
  \"Exécute la transaction UNE FOIS.
   Ne propage AUCUNE erreur.
   Retourne une structure (STATUS . PAYLOAD) :
    - (:SUCCESS . values)
    - (:BUSINESS . condition)
    - (:DB . condition)
    - (:FATAL . condition)\"
  (let ((tx-started nil))
    (handler-case
        (progn
          ;; 1. BEGIN
          (%exec-bare \"BEGIN\")
          (setf tx-started t)
          
          ;; 2. BODY
          (let ((res (multiple-value-list (funcall thunk))))
            
            ;; 3. COMMIT (Si on arrive ici, tout va bien)
            (%exec-bare \"COMMIT\")
            (cons :success res)))
      
      ;; -- CATCH ALL : ON TRANSFORME L'ERREUR EN DONNÉE (Réification) --
      
      ;; Cas A: Erreur Métier
      (lumen.core.error:application-error (e)
        (when tx-started (ignore-errors (%exec-bare \"ROLLBACK\")))
        (cons :business e))
      
      ;; Cas B: Erreur DB
      (cl-postgres:database-error (e)
        (when tx-started (ignore-errors (%exec-bare \"ROLLBACK\")))
        (cons :db e))
      
      ;; Cas C: Erreur Grave (Lisp, NullPointer, etc.)
      (error (e)
        (when tx-started (ignore-errors (%exec-bare \"ROLLBACK\")))
        (cons :fatal e)))))

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Boucle de retry qui gère les résultats réifiés.\"
  (ensure-connection
    (let ((attempt 0))
      (loop
        (let* ((outcome (try-execute-tx-once thunk))
               (status  (car outcome))
               (payload (cdr outcome)))
          
          ;; On sort de la fonction try-execute-tx-once proprement.
          ;; La pile est propre. On décide quoi faire.
          (ecase status
            ;; SUCCÈS : On retourne les valeurs
            (:success
             (return (values-list payload)))
            
            ;; ERREUR MÉTIER : On la relance (maintenant c'est safe !)
            (:business
             (error payload))
            
            ;; ERREUR FATALE : On la relance
            (:fatal
             (error payload))
            
            ;; ERREUR DB : On gère le retry
            (:db
             (let ((mapped (lumen.data.errors:map-db-error payload)))
               (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (incf attempt)
                     (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                   
                   ;; Sinon on relance
                   (error (or mapped payload)))))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn (ignore-errors (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms)))) ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (length rows))
            (values rows (length rows))))
      (cl-postgres:database-error (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist))
                 (row (apply fn args)))
            (lumen.data.metrics:record-query-latency sql 0 (if row 1 0))
            row))
      (cl-postgres:database-error (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (ms)
          (let* ((lower (string-downcase sql))
                 (ret (if (search \"returning\" lower)
                          (apply (get-prepared-plan sql :format :alist) args)
                          (progn (apply (get-prepared-plan sql :format :none) args) nil)))
                 (aff (if ret 1 0))) ;; approx
            (lumen.data.metrics:record-query-latency sql 0 aff)
            (values aff ret)))
      ;; EXEC laisse tout passer, c'est try-execute-tx-once qui gère
      (cl-postgres:database-error (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 129 (fontified t) 129 141 (face font-lock-builtin-face fontified t) 141 142 (fontified t) 142 160 (face font-lock-builtin-face fontified t) 160 161 (fontified t) 161 171 (face font-lock-builtin-face fontified t) 171 176 (fontified t) 176 188 (face font-lock-builtin-face fontified t) 188 189 (fontified t) 189 208 (face font-lock-builtin-face fontified t) 208 209 (fontified t) 209 227 (face font-lock-builtin-face fontified t) 227 228 (fontified t) 228 248 (face font-lock-builtin-face fontified t) 248 249 (fontified t) 249 272 (face font-lock-builtin-face fontified t) 272 277 (fontified t) 277 289 (face font-lock-builtin-face fontified t) 289 290 (fontified t) 290 308 (face font-lock-builtin-face fontified t) 308 309 (fontified t) 309 328 (face font-lock-builtin-face fontified t) 328 329 (fontified t) 329 342 (face font-lock-builtin-face fontified t) 342 343 (fontified t) 343 364 (face font-lock-builtin-face fontified t) 364 369 (fontified t) 369 381 (face font-lock-builtin-face fontified t) 381 382 (fontified t) 382 401 (face font-lock-builtin-face fontified t) 401 402 (fontified t) 402 423 (face font-lock-builtin-face fontified t) 423 424 (fontified t) 424 442 (face font-lock-builtin-face fontified t) 442 447 (fontified t) 447 459 (face font-lock-builtin-face fontified t) 459 460 (fontified t) 460 472 (face font-lock-builtin-face fontified t) 472 473 (fontified t) 473 488 (face font-lock-builtin-face fontified t) 488 490 (fontified t) 490 493 (face font-lock-comment-delimiter-face fontified t) 493 528 (face font-lock-comment-face fontified t) 528 531 (fontified t) 531 538 (face font-lock-builtin-face fontified t) 538 539 (fontified t) 539 546 (face font-lock-builtin-face fontified t) 546 547 (fontified t) 547 553 (face font-lock-builtin-face fontified t) 553 554 (fontified t) 554 562 (face font-lock-builtin-face fontified t) 562 574 (fontified t) 574 582 (face font-lock-builtin-face fontified t) 582 583 (fontified t) 583 592 (face font-lock-builtin-face fontified t) 592 593 (fontified t) 593 598 (face font-lock-builtin-face fontified t) 598 610 (fontified t) 610 620 (face font-lock-builtin-face fontified t) 620 621 (fontified t) 621 639 (face font-lock-builtin-face fontified t) 639 640 (fontified t) 640 654 (face font-lock-builtin-face fontified t) 654 666 (fontified t) 666 684 (face font-lock-builtin-face fontified t) 684 685 (fontified t) 685 708 (face font-lock-builtin-face fontified t) 708 720 (fontified t) 720 751 (face font-lock-builtin-face fontified t) 751 752 (fontified t) 752 768 (face font-lock-builtin-face fontified t) 768 773 (fontified t) 773 783 (face font-lock-keyword-face fontified t) 783 784 (fontified t) 784 798 (face font-lock-builtin-face fontified t) 798 801 (fontified t) 801 806 (face font-lock-comment-delimiter-face fontified t) 806 881 (face font-lock-comment-face fontified t) 881 886 (face font-lock-comment-delimiter-face fontified t) 886 911 (face font-lock-comment-face fontified t) 911 916 (face font-lock-comment-delimiter-face fontified t) 916 991 (face font-lock-comment-face fontified t) 991 992 (fontified t) 992 998 (face font-lock-keyword-face fontified t) 998 999 (fontified t) 999 1010 (face font-lock-variable-name-face fontified t) 1010 1025 (fontified t) 1025 1040 (face font-lock-string-face fontified t) 1040 1044 (fontified t) 1044 1050 (face font-lock-keyword-face fontified t) 1050 1051 (fontified t) 1051 1066 (face font-lock-variable-name-face fontified t) 1066 1071 (fontified t) 1071 1077 (face font-lock-keyword-face fontified t) 1077 1078 (fontified t) 1078 1092 (face font-lock-variable-name-face fontified t) 1092 1097 (fontified t) 1097 1103 (face font-lock-keyword-face fontified t) 1103 1104 (fontified t) 1104 1115 (face font-lock-variable-name-face fontified t) 1115 1122 (fontified t) 1122 1128 (face font-lock-keyword-face fontified t) 1128 1129 (fontified t) 1129 1140 (face font-lock-variable-name-face fontified t) 1140 1145 (fontified t) 1145 1151 (face font-lock-keyword-face fontified t) 1151 1152 (fontified t) 1152 1166 (face font-lock-variable-name-face fontified t) 1166 1175 (fontified t) 1175 1180 (face font-lock-keyword-face fontified t) 1180 1181 (fontified t) 1181 1192 (face font-lock-function-name-face fontified t) 1192 1208 (fontified t) 1208 1225 (face font-lock-keyword-face fontified t) 1225 1280 (fontified t) 1280 1285 (face font-lock-keyword-face fontified t) 1285 1286 (fontified t) 1286 1300 (face font-lock-function-name-face fontified t) 1300 1307 (fontified t) 1307 1324 (face font-lock-keyword-face fontified t) 1324 1387 (fontified t) 1387 1392 (face font-lock-keyword-face fontified t) 1392 1393 (fontified t) 1393 1411 (face font-lock-function-name-face fontified t) 1411 1421 (fontified t) 1421 1425 (face font-lock-keyword-face fontified t) 1425 1447 (fontified t) 1447 1457 (face font-lock-builtin-face fontified t) 1457 1490 (fontified t) 1490 1500 (face font-lock-builtin-face fontified t) 1500 1503 (face font-lock-builtin-face fontified t) 1503 1504 (fontified t) 1504 1512 (face font-lock-builtin-face fontified t) 1512 1519 (fontified t) 10857 10858 (fontified t) 10858 10863 (fontified t face font-lock-keyword-face) 10863 10864 (fontified t) 10864 10868 (fontified t face font-lock-function-name-face) 10868 10874 (fontified t) 10874 10879 (fontified t face font-lock-type-face) 10879 10900 (fontified t) 10900 10918 (fontified t face font-lock-string-face) 10918 10927 (fontified t) 10927 10931 (fontified t face font-lock-keyword-face) 10931 10953 (fontified t) 10953 10959 (fontified t face font-lock-keyword-face) 10959 10999 (fontified t) 10999 11004 (fontified t face font-lock-builtin-face) 11004 11005 (fontified t) 11005 11013 (fontified t face font-lock-builtin-face) 11013 11015 (fontified t) 11015 11020 (fontified t face font-lock-builtin-face) 11020 11055 (fontified t) 11055 11057 (fontified t face font-lock-keyword-face) 11057 11095 (fontified t) 11095 11111 (fontified t) 11111 11113 (face font-lock-keyword-face fontified t) 11113 11170 (fontified t) 11170 11181 (face font-lock-builtin-face fontified t) 11181 11230 (fontified t) 11230 11242 (face font-lock-keyword-face fontified t) 11242 11252 (fontified t) 11252 11274 (face font-lock-keyword-face fontified t) 11274 11291 (fontified t) 11291 11295 (face font-lock-keyword-face fontified t) 11295 11350 (fontified t) 11350 11352 (face font-lock-keyword-face fontified t) 11352 11361 (fontified t) 11361 11372 (face font-lock-string-face fontified t) 11372 11436 (fontified t) 11436 11443 (face font-lock-builtin-face fontified t) 11443 11444 (fontified t) 11444 11450 (face font-lock-builtin-face fontified t) 11450 11485 (fontified t) 11485 11490 (face font-lock-keyword-face fontified t) 11490 11521 (fontified t) 11521 11528 (face font-lock-builtin-face fontified t) 11528 11529 (fontified t) 11529 11534 (face font-lock-builtin-face fontified t) 11534 11572 (fontified t) 11572 11574 (face font-lock-keyword-face fontified t) 11574 11586 (fontified t) 11586 11589 (face font-lock-comment-delimiter-face fontified t) 11589 11596 (face font-lock-comment-face fontified t) 11596 11697 (fontified t) 11697 11700 (face font-lock-comment-delimiter-face fontified t) 11700 11760 (face font-lock-comment-face fontified t) 11760 11826 (fontified t) 11826 11827 (fontified t) 11827 11835 (face font-lock-keyword-face fontified t) 11835 11836 (fontified t) 11836 11849 (face font-lock-function-name-face fontified t) 11849 11852 (fontified t) 11852 11861 (face font-lock-type-face fontified t) 11861 11868 (fontified t) 11868 11873 (face font-lock-type-face fontified t) 11873 11884 (fontified t) 11884 11907 (face font-lock-keyword-face fontified t) 11907 11939 (fontified t) 11939 11946 (face font-lock-string-face fontified t) 11946 11948 (fontified t) 11948 11954 (fontified t) 11954 11968 (face font-lock-keyword-face fontified t) 11968 11970 (fontified t) 11970 11975 (face font-lock-keyword-face fontified t) 11975 11985 (fontified t) 11985 11998 (face font-lock-keyword-face fontified t) 11998 12019 (fontified t) 12019 12029 (face font-lock-string-face fontified t) 12029 12033 (fontified t) 12033 12034 (fontified t rear-nonsticky t) 12034 12035 (fontified t)) . 1) (undo-tree-id187 . -12035) (undo-tree-id188 . -11095) (undo-tree-id189 . -12034) (undo-tree-id190 . -12034) (undo-tree-id191 . -12034) (undo-tree-id192 . -11095) (undo-tree-id193 . -11095) (undo-tree-id194 . -12034) (undo-tree-id195 . -12034) (undo-tree-id196 . -12034) (undo-tree-id197 . -12034) (undo-tree-id198 . -12034) (undo-tree-id199 . -12034) (undo-tree-id200 . -12035) (t 26976 51444 0 0)) nil (26976 51581 694715 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5836 . 5837) (nil fontified nil 1 . 5837) (1 . 5837)) nil (26976 51581 694698 0) 0 nil])
([nil nil ((5837 . 5838)) nil (26976 51581 694695 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  ;; On n'importe QUE les fonctions de connexion bas niveau
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel) 
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  ;; On importe la classe d'erreur générique de cl-postgres
  (:import-from :cl-postgres :database-error)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;; ... [GARDER LA CONFIGURATION & POOL INCHANGÉE] ...
;; (Copiez ici la partie \"Config & Pool\" des fichiers précédents pour gagner de la place
;;  : pool variables, %pool-incf!, start!, stop!, etc.)
;; Pour être sûr, je vous remets le strict minimum pour que ça compile :

(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta) (bt:with-lock-held (*pool-lock*) (incf (symbol-value var) delta)))
(defun %pool-snapshot () (bt:with-lock-held (*pool-lock*) (values *pool-inflight* *pool-waiters*)))
(defun %ensure-pool-sema! (cfg)
  (let* ((sz (or (getf cfg :pool-size) 10)))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz)) *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config *connection-mode* :toplevel) ;; Simplifié pour le fix
  #+postmodern
  (let ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
        (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432)))
    (postmodern:disconnect-toplevel)
    (postmodern:connect-toplevel db user pass host :port port))
  (setf *started* t))

(defun stop! () #+postmodern (postmodern:disconnect-toplevel) (setf *started* nil))

;; CALL-WITH-CONN BASIQUE
(defun call-with-conn (thunk &key (cfg nil))
  (declare (ignore cfg))
  ;; Mode Toplevel direct pour éliminer les problèmes de Pool temporairement
  (funcall thunk))

(defmacro with-conn (&optional opts &body body)
  `(call-with-conn (lambda () ,@body)))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; LE CŒUR DU FIX : GESTION MANUELLE & SANS RETOUR
;;; ---------------------------------------------------------------------------

(defun %exec-raw (sql)
  ;; Fonction interne simple qui ne catche rien
  #+postmodern (postmodern:execute sql))

(defun call-with-tx-logic (thunk retries sleep-ms)
  (format t \"~&[DB-KERNEL] >>> Transaction Start (New Logic)~%\")
  
  (ensure-connection
    ;; Pas de loop complexe, pas de retry pour l'instant (Isolation du bug)
    (let ((committed nil)
          (error-to-raise nil))
      
      ;; 1. BEGIN
      (%exec-raw \"BEGIN\")
      
      ;; 2. PROTECTED EXECUTION
      (unwind-protect
           (handler-bind 
               ;; ON INTERCEPTE TOUT
               ((error (lambda (c)
                         (format t \"~&[DB-KERNEL] !!! Error captured inside TX: ~A~%\" c)
                         ;; On note l'erreur pour plus tard
                         (setf error-to-raise c)
                         ;; IMPORTANT : On décline la gestion ici pour laisser l'unwind-protect
                         ;; faire le rollback. On ne fait PAS de return-from.
                         ;; Le stack va se dérouler jusqu'au prochain handler.
                         )))
             
             (multiple-value-prog1
                 (funcall thunk)
               ;; Si on arrive ici, pas d'erreur -> COMMIT
               (format t \"~&[DB-KERNEL] Commit...~%\")
               (%exec-raw \"COMMIT\")
               (setf committed t)))
        
        ;; 3. CLEANUP (ROLLBACK)
        ;; S'exécute TOUJOURS. Si committed est NIL, c'est qu'il y a eu une erreur ou un saut.
        (unless committed
          (format t \"~&[DB-KERNEL] Rollback triggering...~%\")
          (ignore-errors (%exec-raw \"ROLLBACK\"))
          (format t \"~&[DB-KERNEL] Rollback Done.~%\")))
      
      ;; Note : Si une erreur a eu lieu, elle a traversé le handler-bind et le unwind-protect.
      ;; Elle continue de remonter vers le Middleware.
      )))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

;; Helpers SQL
(defmacro with-statement-timeout ((ms) &body body) `(progn ,@body))

(defun exec (sql &rest params)
  (format t \"~&[EXEC] ~A~%\" sql)
  ;; Utilisation directe de postmodern:execute pour éviter les interférences
  #+postmodern (apply #'postmodern:execute sql params))

(defun query-a (sql &rest params)
  #+postmodern (apply #'postmodern:query sql params :alists))
  
(defun query-1a (sql &rest params)
  #+postmodern (apply #'postmodern:query sql params :alist))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (%exec-raw \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (%exec-raw \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 60 (fontified t) 60 63 (face font-lock-comment-delimiter-face fontified t) 63 118 (face font-lock-comment-face fontified t) 118 121 (fontified t) 121 133 (face font-lock-builtin-face fontified t) 133 134 (fontified t) 134 145 (face font-lock-builtin-face fontified t) 145 146 (fontified t) 146 163 (face font-lock-builtin-face fontified t) 163 164 (fontified t) 164 184 (face font-lock-builtin-face fontified t) 184 190 (fontified t) 190 202 (face font-lock-builtin-face fontified t) 202 203 (fontified t) 203 221 (face font-lock-builtin-face fontified t) 221 222 (fontified t) 222 232 (face font-lock-builtin-face fontified t) 232 237 (fontified t) 237 249 (face font-lock-builtin-face fontified t) 249 250 (fontified t) 250 269 (face font-lock-builtin-face fontified t) 269 270 (fontified t) 270 288 (face font-lock-builtin-face fontified t) 288 289 (fontified t) 289 309 (face font-lock-builtin-face fontified t) 309 310 (fontified t) 310 333 (face font-lock-builtin-face fontified t) 333 338 (fontified t) 338 350 (face font-lock-builtin-face fontified t) 350 351 (fontified t) 351 369 (face font-lock-builtin-face fontified t) 369 370 (fontified t) 370 389 (face font-lock-builtin-face fontified t) 389 390 (fontified t) 390 403 (face font-lock-builtin-face fontified t) 403 404 (fontified t) 404 425 (face font-lock-builtin-face fontified t) 425 430 (fontified t) 430 442 (face font-lock-builtin-face fontified t) 442 443 (fontified t) 443 462 (face font-lock-builtin-face fontified t) 462 463 (fontified t) 463 484 (face font-lock-builtin-face fontified t) 484 485 (fontified t) 485 503 (face font-lock-builtin-face fontified t) 503 507 (fontified t) 507 510 (face font-lock-comment-delimiter-face fontified t) 510 565 (face font-lock-comment-face fontified t) 565 568 (fontified t) 568 580 (face font-lock-builtin-face fontified t) 580 581 (fontified t) 581 593 (face font-lock-builtin-face fontified t) 593 594 (fontified t) 594 609 (face font-lock-builtin-face fontified t) 609 614 (fontified t) 614 621 (face font-lock-builtin-face fontified t) 621 622 (fontified t) 622 629 (face font-lock-builtin-face fontified t) 629 630 (fontified t) 630 636 (face font-lock-builtin-face fontified t) 636 637 (fontified t) 637 645 (face font-lock-builtin-face fontified t) 645 657 (fontified t) 657 665 (face font-lock-builtin-face fontified t) 665 666 (fontified t) 666 675 (face font-lock-builtin-face fontified t) 675 676 (fontified t) 676 681 (face font-lock-builtin-face fontified t) 681 693 (fontified t) 693 703 (face font-lock-builtin-face fontified t) 703 704 (fontified t) 704 722 (face font-lock-builtin-face fontified t) 722 723 (fontified t) 723 737 (face font-lock-builtin-face fontified t) 737 749 (fontified t) 749 767 (face font-lock-builtin-face fontified t) 767 768 (fontified t) 768 791 (face font-lock-builtin-face fontified t) 791 803 (fontified t) 803 834 (face font-lock-builtin-face fontified t) 834 835 (fontified t) 835 851 (face font-lock-builtin-face fontified t) 851 856 (fontified t) 856 866 (face font-lock-keyword-face fontified t) 866 867 (fontified t) 867 881 (face font-lock-builtin-face fontified t) 881 884 (fontified t) 884 887 (face font-lock-comment-delimiter-face fontified t) 887 938 (face font-lock-comment-face fontified t) 938 941 (face font-lock-comment-delimiter-face fontified t) 941 1027 (face font-lock-comment-face fontified t) 1027 1031 (face font-lock-comment-delimiter-face fontified t) 1031 1083 (face font-lock-comment-face fontified t) 1083 1086 (face font-lock-comment-delimiter-face fontified t) 1086 1156 (face font-lock-comment-face fontified t) 1156 1158 (fontified t) 1158 1164 (face font-lock-keyword-face fontified t) 1164 1165 (fontified t) 1165 1176 (face font-lock-variable-name-face fontified t) 1176 1191 (fontified t) 1191 1206 (face font-lock-string-face fontified t) 1206 1210 (fontified t) 1210 1216 (face font-lock-keyword-face fontified t) 1216 1217 (fontified t) 1217 1232 (face font-lock-variable-name-face fontified t) 1232 1237 (fontified t) 1237 1243 (face font-lock-keyword-face fontified t) 1243 1244 (fontified t) 1244 1258 (face font-lock-variable-name-face fontified t) 1258 1263 (fontified t) 1263 1269 (face font-lock-keyword-face fontified t) 1269 1270 (fontified t) 1270 1281 (face font-lock-variable-name-face fontified t) 1281 1288 (fontified t) 1288 1294 (face font-lock-keyword-face fontified t) 1294 1295 (fontified t) 1295 1306 (face font-lock-variable-name-face fontified t) 1306 1311 (fontified t) 1311 1317 (face font-lock-keyword-face fontified t) 1317 1318 (fontified t) 1318 1332 (face font-lock-variable-name-face fontified t) 1332 1341 (fontified t) 1341 1346 (face font-lock-keyword-face fontified t) 1346 1347 (fontified t) 1347 1358 (face font-lock-function-name-face fontified t) 1358 1372 (fontified t) 1372 1389 (face font-lock-keyword-face fontified t) 1389 1439 (fontified t) 1439 1444 (face font-lock-keyword-face fontified t) 1444 1445 (fontified t) 1445 1459 (face font-lock-function-name-face fontified t) 1459 1464 (fontified t) 1464 1481 (face font-lock-keyword-face fontified t) 1481 1500 (fontified t) 1500 1538 (fontified t) 5167 5168 (fontified t) 5168 5171 (face font-lock-comment-delimiter-face fontified t) 5171 5183 (face font-lock-comment-face fontified t) 5183 5184 (fontified t) 5184 5192 (face font-lock-keyword-face fontified t) 5192 5193 (fontified t) 5193 5215 (face font-lock-function-name-face fontified t) 5215 5222 (fontified t) 5222 5227 (face font-lock-type-face fontified t) 5227 5236 (fontified t) 5236 5241 (face font-lock-keyword-face fontified t) 5241 5253 (fontified t) 5253 5258 (face font-lock-keyword-face fontified t) 5258 5259 (fontified t) 5259 5263 (face font-lock-function-name-face fontified t) 5263 5269 (fontified t) 5269 5274 (face font-lock-type-face fontified t) 5274 5295 (fontified t) 5295 5310 (face font-lock-string-face fontified t) 5310 5318 (fontified t) 5318 5321 (face font-lock-comment-delimiter-face fontified t) 5321 5393 (face font-lock-comment-face fontified t) 5393 5451 (fontified t) 5451 5456 (face font-lock-keyword-face fontified t) 5456 5457 (fontified t) 5457 5464 (face font-lock-function-name-face fontified t) 5464 5470 (fontified t) 5470 5475 (face font-lock-type-face fontified t) 5475 5536 (fontified t) 5536 5543 (face font-lock-builtin-face fontified t) 5543 5550 (fontified t) 5550 5555 (face font-lock-keyword-face fontified t) 5555 5556 (fontified t) 5556 5564 (face font-lock-function-name-face fontified t) 5564 5570 (fontified t) 5570 5575 (face font-lock-type-face fontified t) 5575 5636 (fontified t) 5636 5642 (face font-lock-builtin-face fontified t) 5642 5646 (fontified t) 5646 5647 (fontified t) 5647 5655 (face font-lock-keyword-face fontified t) 5655 5656 (fontified t) 5656 5669 (face font-lock-function-name-face fontified t) 5669 5672 (fontified t) 5672 5681 (face font-lock-type-face fontified t) 5681 5688 (fontified t) 5688 5693 (face font-lock-type-face fontified t) 5693 5704 (fontified t) 5704 5727 (face font-lock-keyword-face fontified t) 5727 5750 (fontified t) 5750 5757 (face font-lock-string-face fontified t) 5757 5759 (fontified t) 5759 5765 (fontified t) 5765 5779 (face font-lock-keyword-face fontified t) 5779 5781 (fontified t) 5781 5786 (face font-lock-keyword-face fontified t) 5786 5796 (fontified t) 5796 5809 (face font-lock-keyword-face fontified t) 5809 5821 (fontified t) 5821 5831 (face font-lock-string-face fontified t) 5831 5835 (fontified t) 5835 5836 (fontified t rear-nonsticky t) 5836 5837 (fontified t)) . 1) (undo-tree-id201 . -5837) (undo-tree-id202 . -5167) (undo-tree-id203 . -5836) (undo-tree-id204 . -5836) (undo-tree-id205 . -5836) (undo-tree-id206 . -5837) (t 26976 51581 0 0)) nil (26976 51689 676593 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5698 . 5699) (nil fontified nil 1 . 5699) (1 . 5699)) nil (26976 51689 676581 0) 0 nil])
([nil nil ((5699 . 5700)) nil (26976 51689 676577 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  ;; On n'importe QUE les fonctions de connexion
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel) 
  (:import-from :lumen.data.config :db-config)
  ;; On a besoin de get-prepared-plan pour avoir des FONCTIONS applicables
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  ;; On importe la classe d'erreur générique de cl-postgres
  (:import-from :cl-postgres :database-error)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; CONFIG & POOL (Inchangé)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz (or (getf cfg :pool-size) 10)))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz)) *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config *connection-mode* :toplevel)
  #+postmodern
  (let ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
        (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432)))
    (postmodern:disconnect-toplevel)
    (postmodern:connect-toplevel db user pass host :port port))
  (setf *started* t))

(defun stop! () #+postmodern (postmodern:disconnect-toplevel) (setf *started* nil))

;; CALL-WITH-CONN BASIQUE
(defun call-with-conn (thunk &key (cfg nil))
  (declare (ignore cfg))
  (funcall thunk))

(defmacro with-conn (&optional opts &body body)
  `(call-with-conn (lambda () ,@body)))

(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; LE CŒUR DU FIX : GESTION MANUELLE
;;; ---------------------------------------------------------------------------

(defun %exec-raw (sql)
  \"Exécute une commande SQL simple (comme BEGIN/COMMIT) sans paramètres.\"
  ;; Ici on appelle la macro directement, ce qui est valide car on n'utilise pas apply.
  (format t \"~&[DB-KERNEL] RAW: ~A~%\" sql)
  #+postmodern (postmodern:execute sql))

(defun call-with-tx-logic (thunk retries sleep-ms)
  (declare (ignore retries sleep-ms)) ;; On simplifie pour l'instant
  (format t \"~&[DB-KERNEL] >>> Transaction Start (Manual Mode)~%\")
  
  (ensure-connection
    (let ((committed nil))
      ;; 1. BEGIN
      (%exec-raw \"BEGIN\")
      
      (unwind-protect
           (handler-bind 
               ;; INTERCEPTION & LOGGING
               ((error (lambda (c)
                         (format t \"~&[DB-KERNEL] !!! Error inside TX: ~A~%\" c)
                         ;; On laisse passer l'erreur. Le unwind-protect fera le rollback.
                         )))
             
             (multiple-value-prog1
                 (funcall thunk)
               ;; Si on arrive ici -> COMMIT
               (format t \"~&[DB-KERNEL] Commit...~%\")
               (%exec-raw \"COMMIT\")
               (setf committed t)))
        
        ;; 3. CLEANUP (ROLLBACK)
        (unless committed
          (format t \"~&[DB-KERNEL] Rollback triggering...~%\")
          (ignore-errors (%exec-raw \"ROLLBACK\"))
          (format t \"~&[DB-KERNEL] Rollback Done.~%\"))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

;;; ---------------------------------------------------------------------------
;;; EXECUTION DES REQUETES (Correction apply macro)
;;; ---------------------------------------------------------------------------

(defmacro with-statement-timeout ((ms) &body body) `(progn ,@body))

(defun exec (sql &rest params)
  (format t \"~&[EXEC] ~A Params: ~A~%\" sql params)
  ;; CORRECTION : On utilise get-prepared-plan qui retourne une FONCTION.
  ;; Une fonction peut être passée à APPLY.
  (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :none)))
    (apply fn params)))

(defun query-a (sql &rest params)
  ;; CORRECTION : Idem, on récupère une fonction (closure).
  (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists)))
    (apply fn params)))
  
(defun query-1a (sql &rest params)
  ;; CORRECTION : Idem.
  (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist)))
    (apply fn params)))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (%exec-raw \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (%exec-raw \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 60 (fontified t) 60 63 (face font-lock-comment-delimiter-face fontified t) 63 107 (face font-lock-comment-face fontified t) 107 110 (fontified t) 110 122 (face font-lock-builtin-face fontified t) 122 123 (fontified t) 123 134 (face font-lock-builtin-face fontified t) 134 135 (fontified t) 135 152 (face font-lock-builtin-face fontified t) 152 153 (fontified t) 153 173 (face font-lock-builtin-face fontified t) 173 179 (fontified t) 179 191 (face font-lock-builtin-face fontified t) 191 192 (fontified t) 192 210 (face font-lock-builtin-face fontified t) 210 211 (fontified t) 211 221 (face font-lock-builtin-face fontified t) 221 225 (fontified t) 225 228 (face font-lock-comment-delimiter-face fontified t) 228 298 (face font-lock-comment-face fontified t) 298 301 (fontified t) 301 313 (face font-lock-builtin-face fontified t) 313 314 (fontified t) 314 333 (face font-lock-builtin-face fontified t) 333 334 (fontified t) 334 352 (face font-lock-builtin-face fontified t) 352 353 (fontified t) 353 373 (face font-lock-builtin-face fontified t) 373 374 (fontified t) 374 397 (face font-lock-builtin-face fontified t) 397 402 (fontified t) 402 414 (face font-lock-builtin-face fontified t) 414 415 (fontified t) 415 433 (face font-lock-builtin-face fontified t) 433 434 (fontified t) 434 453 (face font-lock-builtin-face fontified t) 453 454 (fontified t) 454 467 (face font-lock-builtin-face fontified t) 467 468 (fontified t) 468 489 (face font-lock-builtin-face fontified t) 489 494 (fontified t) 494 506 (face font-lock-builtin-face fontified t) 506 507 (fontified t) 507 526 (face font-lock-builtin-face fontified t) 526 527 (fontified t) 527 548 (face font-lock-builtin-face fontified t) 548 549 (fontified t) 549 567 (face font-lock-builtin-face fontified t) 567 571 (fontified t) 571 574 (face font-lock-comment-delimiter-face fontified t) 574 629 (face font-lock-comment-face fontified t) 629 632 (fontified t) 632 644 (face font-lock-builtin-face fontified t) 644 645 (fontified t) 645 657 (face font-lock-builtin-face fontified t) 657 658 (fontified t) 658 673 (face font-lock-builtin-face fontified t) 673 678 (fontified t) 678 685 (face font-lock-builtin-face fontified t) 685 686 (fontified t) 686 693 (face font-lock-builtin-face fontified t) 693 694 (fontified t) 694 700 (face font-lock-builtin-face fontified t) 700 701 (fontified t) 701 709 (face font-lock-builtin-face fontified t) 709 721 (fontified t) 721 729 (face font-lock-builtin-face fontified t) 729 730 (fontified t) 730 739 (face font-lock-builtin-face fontified t) 739 740 (fontified t) 740 745 (face font-lock-builtin-face fontified t) 745 757 (fontified t) 757 767 (face font-lock-builtin-face fontified t) 767 768 (fontified t) 768 786 (face font-lock-builtin-face fontified t) 786 787 (fontified t) 787 801 (face font-lock-builtin-face fontified t) 801 813 (fontified t) 813 831 (face font-lock-builtin-face fontified t) 831 832 (fontified t) 832 855 (face font-lock-builtin-face fontified t) 855 867 (fontified t) 867 898 (face font-lock-builtin-face fontified t) 898 899 (fontified t) 899 915 (face font-lock-builtin-face fontified t) 915 920 (fontified t) 920 930 (face font-lock-keyword-face fontified t) 930 931 (fontified t) 931 945 (face font-lock-builtin-face fontified t) 945 948 (fontified t) 948 953 (face font-lock-comment-delimiter-face fontified t) 953 1028 (face font-lock-comment-face fontified t) 1028 1033 (face font-lock-comment-delimiter-face fontified t) 1033 1058 (face font-lock-comment-face fontified t) 1058 1063 (face font-lock-comment-delimiter-face fontified t) 1063 1138 (face font-lock-comment-face fontified t) 1138 1139 (fontified t) 1139 1145 (face font-lock-keyword-face fontified t) 1145 1146 (fontified t) 1146 1157 (face font-lock-variable-name-face fontified t) 1157 1172 (fontified t) 1172 1187 (face font-lock-string-face fontified t) 1187 1191 (fontified t) 1191 1197 (face font-lock-keyword-face fontified t) 1197 1198 (fontified t) 1198 1213 (face font-lock-variable-name-face fontified t) 1213 1218 (fontified t) 1218 1224 (face font-lock-keyword-face fontified t) 1224 1225 (fontified t) 1225 1239 (face font-lock-variable-name-face fontified t) 1239 1244 (fontified t) 1244 1250 (face font-lock-keyword-face fontified t) 1250 1251 (fontified t) 1251 1262 (face font-lock-variable-name-face fontified t) 1262 1269 (fontified t) 1269 1275 (face font-lock-keyword-face fontified t) 1275 1276 (fontified t) 1276 1287 (face font-lock-variable-name-face fontified t) 1287 1292 (fontified t) 1292 1298 (face font-lock-keyword-face fontified t) 1298 1299 (fontified t) 1299 1313 (face font-lock-variable-name-face fontified t) 1313 1322 (fontified t) 1322 1327 (face font-lock-keyword-face fontified t) 1327 1328 (fontified t) 1328 1339 (face font-lock-function-name-face fontified t) 1339 1355 (fontified t) 1355 1372 (face font-lock-keyword-face fontified t) 1372 1427 (fontified t) 1427 1432 (face font-lock-keyword-face fontified t) 1432 1433 (fontified t) 1433 1447 (face font-lock-function-name-face fontified t) 1447 1454 (fontified t) 1454 1471 (face font-lock-keyword-face fontified t) 1471 1500 (fontified t) 1500 1532 (fontified t) 4862 4863 (fontified t) 4863 4868 (fontified t face font-lock-keyword-face) 4868 4869 (fontified t) 4869 4873 (fontified t face font-lock-function-name-face) 4873 4879 (fontified t) 4879 4884 (fontified t face font-lock-type-face) 4884 4905 (fontified t) 4905 4931 (fontified t face font-lock-string-face) 4931 4944 (fontified t) 4944 4946 (fontified t) 4946 4949 (face font-lock-comment-delimiter-face fontified t) 4949 5018 (face font-lock-comment-face fontified t) 5018 5020 (fontified t) 5020 5023 (face font-lock-comment-delimiter-face fontified t) 5023 5062 (face font-lock-comment-face fontified t) 5062 5065 (fontified t) 5065 5068 (face font-lock-keyword-face fontified t) 5068 5116 (fontified t) 5116 5123 (face font-lock-builtin-face fontified t) 5123 5124 (fontified t) 5124 5129 (face font-lock-builtin-face fontified t) 5129 5159 (fontified t) 5159 5164 (face font-lock-keyword-face fontified t) 5164 5165 (fontified t) 5165 5172 (face font-lock-function-name-face fontified t) 5172 5178 (fontified t) 5178 5183 (face font-lock-type-face fontified t) 5183 5194 (fontified t) 5194 5197 (face font-lock-comment-delimiter-face fontified t) 5197 5252 (face font-lock-comment-face fontified t) 5252 5255 (fontified t) 5255 5258 (face font-lock-keyword-face fontified t) 5258 5306 (fontified t) 5306 5313 (face font-lock-builtin-face fontified t) 5313 5314 (fontified t) 5314 5321 (face font-lock-builtin-face fontified t) 5321 5353 (fontified t) 5353 5358 (face font-lock-keyword-face fontified t) 5358 5359 (fontified t) 5359 5367 (face font-lock-function-name-face fontified t) 5367 5373 (fontified t) 5373 5378 (face font-lock-type-face fontified t) 5378 5389 (fontified t) 5389 5392 (face font-lock-comment-delimiter-face fontified t) 5392 5411 (face font-lock-comment-face fontified t) 5411 5414 (fontified t) 5414 5417 (face font-lock-keyword-face fontified t) 5417 5465 (fontified t) 5465 5472 (face font-lock-builtin-face fontified t) 5472 5473 (fontified t) 5473 5479 (face font-lock-builtin-face fontified t) 5479 5508 (fontified t) 5508 5509 (fontified t) 5509 5517 (face font-lock-keyword-face fontified t) 5517 5518 (fontified t) 5518 5531 (face font-lock-function-name-face fontified t) 5531 5534 (fontified t) 5534 5543 (face font-lock-type-face fontified t) 5543 5550 (fontified t) 5550 5555 (face font-lock-type-face fontified t) 5555 5566 (fontified t) 5566 5589 (face font-lock-keyword-face fontified t) 5589 5612 (fontified t) 5612 5619 (face font-lock-string-face fontified t) 5619 5621 (fontified t) 5621 5627 (fontified t) 5627 5641 (face font-lock-keyword-face fontified t) 5641 5643 (fontified t) 5643 5648 (face font-lock-keyword-face fontified t) 5648 5658 (fontified t) 5658 5671 (face font-lock-keyword-face fontified t) 5671 5683 (fontified t) 5683 5693 (face font-lock-string-face fontified t) 5693 5697 (fontified t) 5697 5698 (fontified t rear-nonsticky t) 5698 5699 (fontified t)) . 1) (undo-tree-id207 . -5699) (undo-tree-id208 . -4944) (undo-tree-id209 . -5698) (undo-tree-id210 . -5698) (undo-tree-id211 . -5698) (undo-tree-id212 . -5698) (undo-tree-id213 . -5698) (undo-tree-id214 . -5698) (undo-tree-id215 . -5699) (t 26976 51689 0 0)) nil (26976 52996 576295 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6215 . 6216) (nil fontified nil 1 . 6216) (1 . 6216)) nil (26976 52996 576281 0) 0 nil])
([nil nil ((6216 . 6217)) nil (26976 52996 576277 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:import-from :cl-postgres :database-error)
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; CONFIG & POOL (Inchangé)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz (or (getf cfg :pool-size) 10)))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz)) *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config *connection-mode* :toplevel)
  #+postmodern
  (let ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
        (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432)))
    (postmodern:disconnect-toplevel)
    (postmodern:connect-toplevel db user pass host :port port))
  (setf *started* t))

(defun stop! () #+postmodern (postmodern:disconnect-toplevel) (setf *started* nil))

;; Call-with-conn simplifié
(defun call-with-conn (thunk &key (cfg nil))
  (declare (ignore cfg))
  (funcall thunk))

(defmacro with-conn (&optional opts &body body) `(call-with-conn (lambda () ,@body)))
(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; GESTION MANUELLE DES TRANSACTIONS (Le Fix Crash)
;;; ---------------------------------------------------------------------------

(defun %exec-raw (sql)
  \"Exécute du SQL de contrôle (BEGIN/COMMIT) sans paramètres.\"
  #+postmodern (postmodern:execute sql))

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Gère la transaction manuellement pour éviter les conflits de stack.\"
  (declare (ignore retries sleep-ms))
  (ensure-connection
    (let ((committed nil))
      ;; 1. BEGIN
      (%exec-raw \"BEGIN\")
      
      (unwind-protect
           (handler-bind 
               ;; LOGGING UNIQUEMENT (On laisse remonter l'erreur)
               ((error (lambda (c) 
                         (format t \"~&[DB-KERNEL] Error in TX: ~A~%\" c))))
             
             (multiple-value-prog1
                 (funcall thunk)
               ;; 2. COMMIT (Si succès)
               (%exec-raw \"COMMIT\")
               (setf committed t)))
        
        ;; 3. ROLLBACK (Si échec/erreur)
        (unless committed
          (ignore-errors (%exec-raw \"ROLLBACK\")))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body) `(progn ,@body))

;;; ---------------------------------------------------------------------------
;;; EXÉCUTION INTELLIGENTE (Le Fix du \"Retour NIL\")
;;; ---------------------------------------------------------------------------

(defun exec (sql &rest params)
  (format t \"~&[EXEC] SQL: ~A~%\" sql)
  
  ;; 1. Séparation Arguments SQL vs Options Lumen (:timeout-ms etc.)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         ;; (opts (if kpos (subseq params kpos) nil)) ;; On ignore les options pour l'instant
         )

    ;; 2. Détection du RETURNING pour savoir quel format demander
    (let* ((lower (string-downcase sql))
           (has-returning (search \"returning\" lower)))
      
      (if has-returning
          ;; CAS A : INSERT/UPDATE avec RETURNING -> On veut les données (ALIST)
          (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist)))
            (let ((row (apply fn args)))
              ;; On retourne (affected-count result-row)
              (values (if row 1 0) row)))
          
          ;; CAS B : INSERT/UPDATE simple -> On veut juste le nombre (ROW COUNT)
          (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :none)))
            (let ((count (apply fn args)))
              (values count nil)))))))

(defun query-a (sql &rest params)
  ;; SELECT multiple -> Liste d'ALISTS
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params)))
    (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists)))
      (let ((rows (apply fn args)))
        (values rows (length rows))))))
  
(defun query-1a (sql &rest params)
  ;; SELECT unique -> Une ALIST
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params)))
    (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist)))
      (apply fn args))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (%exec-raw \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (%exec-raw \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 61 (fontified t) 61 73 (face font-lock-builtin-face fontified t) 73 74 (fontified t) 74 85 (face font-lock-builtin-face fontified t) 85 86 (fontified t) 86 103 (face font-lock-builtin-face fontified t) 103 104 (fontified t) 104 124 (face font-lock-builtin-face fontified t) 124 129 (fontified t) 129 141 (face font-lock-builtin-face fontified t) 141 142 (fontified t) 142 160 (face font-lock-builtin-face fontified t) 160 161 (fontified t) 161 171 (face font-lock-builtin-face fontified t) 171 176 (fontified t) 176 188 (face font-lock-builtin-face fontified t) 188 189 (fontified t) 189 208 (face font-lock-builtin-face fontified t) 208 209 (fontified t) 209 227 (face font-lock-builtin-face fontified t) 227 228 (fontified t) 228 248 (face font-lock-builtin-face fontified t) 248 249 (fontified t) 249 272 (face font-lock-builtin-face fontified t) 272 277 (fontified t) 277 289 (face font-lock-builtin-face fontified t) 289 290 (fontified t) 290 308 (face font-lock-builtin-face fontified t) 308 309 (fontified t) 309 328 (face font-lock-builtin-face fontified t) 328 329 (fontified t) 329 342 (face font-lock-builtin-face fontified t) 342 343 (fontified t) 343 364 (face font-lock-builtin-face fontified t) 364 369 (fontified t) 369 381 (face font-lock-builtin-face fontified t) 381 382 (fontified t) 382 401 (face font-lock-builtin-face fontified t) 401 402 (fontified t) 402 423 (face font-lock-builtin-face fontified t) 423 424 (fontified t) 424 442 (face font-lock-builtin-face fontified t) 442 447 (fontified t) 447 459 (face font-lock-builtin-face fontified t) 459 460 (fontified t) 460 472 (face font-lock-builtin-face fontified t) 472 473 (fontified t) 473 488 (face font-lock-builtin-face fontified t) 488 493 (fontified t) 493 500 (face font-lock-builtin-face fontified t) 500 501 (fontified t) 501 508 (face font-lock-builtin-face fontified t) 508 509 (fontified t) 509 515 (face font-lock-builtin-face fontified t) 515 516 (fontified t) 516 524 (face font-lock-builtin-face fontified t) 524 536 (fontified t) 536 544 (face font-lock-builtin-face fontified t) 544 545 (fontified t) 545 554 (face font-lock-builtin-face fontified t) 554 555 (fontified t) 555 560 (face font-lock-builtin-face fontified t) 560 572 (fontified t) 572 582 (face font-lock-builtin-face fontified t) 582 583 (fontified t) 583 601 (face font-lock-builtin-face fontified t) 601 602 (fontified t) 602 616 (face font-lock-builtin-face fontified t) 616 628 (fontified t) 628 646 (face font-lock-builtin-face fontified t) 646 647 (fontified t) 647 670 (face font-lock-builtin-face fontified t) 670 682 (fontified t) 682 713 (face font-lock-builtin-face fontified t) 713 714 (fontified t) 714 730 (face font-lock-builtin-face fontified t) 730 735 (fontified t) 735 745 (face font-lock-keyword-face fontified t) 745 746 (fontified t) 746 760 (face font-lock-builtin-face fontified t) 760 763 (fontified t) 763 768 (face font-lock-comment-delimiter-face fontified t) 768 843 (face font-lock-comment-face fontified t) 843 848 (face font-lock-comment-delimiter-face fontified t) 848 873 (face font-lock-comment-face fontified t) 873 878 (face font-lock-comment-delimiter-face fontified t) 878 953 (face font-lock-comment-face fontified t) 953 954 (fontified t) 954 960 (face font-lock-keyword-face fontified t) 960 961 (fontified t) 961 972 (face font-lock-variable-name-face fontified t) 972 987 (fontified t) 987 1002 (face font-lock-string-face fontified t) 1002 1006 (fontified t) 1006 1012 (face font-lock-keyword-face fontified t) 1012 1013 (fontified t) 1013 1028 (face font-lock-variable-name-face fontified t) 1028 1033 (fontified t) 1033 1039 (face font-lock-keyword-face fontified t) 1039 1040 (fontified t) 1040 1054 (face font-lock-variable-name-face fontified t) 1054 1059 (fontified t) 1059 1065 (face font-lock-keyword-face fontified t) 1065 1066 (fontified t) 1066 1077 (face font-lock-variable-name-face fontified t) 1077 1084 (fontified t) 1084 1090 (face font-lock-keyword-face fontified t) 1090 1091 (fontified t) 1091 1102 (face font-lock-variable-name-face fontified t) 1102 1107 (fontified t) 1107 1113 (face font-lock-keyword-face fontified t) 1113 1114 (fontified t) 1114 1128 (face font-lock-variable-name-face fontified t) 1128 1137 (fontified t) 1137 1142 (face font-lock-keyword-face fontified t) 1142 1143 (fontified t) 1143 1154 (face font-lock-function-name-face fontified t) 1154 1170 (fontified t) 1170 1187 (face font-lock-keyword-face fontified t) 1187 1242 (fontified t) 1242 1247 (face font-lock-keyword-face fontified t) 1247 1248 (fontified t) 1248 1262 (face font-lock-function-name-face fontified t) 1262 1269 (fontified t) 1269 1286 (face font-lock-keyword-face fontified t) 1286 1349 (fontified t) 1349 1354 (face font-lock-keyword-face fontified t) 1354 1355 (fontified t) 1355 1373 (face font-lock-function-name-face fontified t) 1373 1383 (fontified t) 1383 1387 (face font-lock-keyword-face fontified t) 1387 1407 (fontified t) 1407 1417 (face font-lock-builtin-face fontified t) 1417 1430 (fontified t) 1430 1434 (face font-lock-keyword-face fontified t) 1434 1500 (fontified t) 1500 1532 (fontified t) 1532 1538 (face font-lock-builtin-face fontified t) 1538 1578 (fontified t) 5421 5422 (fontified t) 5422 5427 (face font-lock-keyword-face fontified t) 5427 5428 (fontified t) 5428 5435 (face font-lock-function-name-face fontified t) 5435 5441 (fontified t) 5441 5446 (face font-lock-type-face fontified t) 5446 5455 (fontified t) 5455 5457 (fontified t) 5457 5460 (face font-lock-comment-delimiter-face fontified t) 5460 5494 (face font-lock-comment-face fontified t) 5494 5497 (fontified t) 5497 5501 (face font-lock-keyword-face fontified t) 5501 5558 (fontified t) 5558 5560 (face font-lock-keyword-face fontified t) 5560 5604 (fontified t) 5604 5607 (face font-lock-keyword-face fontified t) 5607 5655 (fontified t) 5655 5662 (face font-lock-builtin-face fontified t) 5662 5663 (fontified t) 5663 5670 (face font-lock-builtin-face fontified t) 5670 5681 (fontified t) 5681 5684 (face font-lock-keyword-face fontified t) 5684 5754 (fontified t) 5754 5759 (face font-lock-keyword-face fontified t) 5759 5760 (fontified t) 5760 5768 (face font-lock-function-name-face fontified t) 5768 5774 (fontified t) 5774 5779 (face font-lock-type-face fontified t) 5779 5790 (fontified t) 5790 5793 (face font-lock-comment-delimiter-face fontified t) 5793 5820 (face font-lock-comment-face fontified t) 5820 5823 (fontified t) 5823 5827 (face font-lock-keyword-face fontified t) 5827 5884 (fontified t) 5884 5886 (face font-lock-keyword-face fontified t) 5886 5930 (fontified t) 5930 5933 (face font-lock-keyword-face fontified t) 5933 5981 (fontified t) 5981 5988 (face font-lock-builtin-face fontified t) 5988 5989 (fontified t) 5989 5995 (face font-lock-builtin-face fontified t) 5995 6025 (fontified t) 6025 6026 (fontified t) 6026 6034 (face font-lock-keyword-face fontified t) 6034 6035 (fontified t) 6035 6048 (face font-lock-function-name-face fontified t) 6048 6051 (fontified t) 6051 6060 (face font-lock-type-face fontified t) 6060 6067 (fontified t) 6067 6072 (face font-lock-type-face fontified t) 6072 6083 (fontified t) 6083 6106 (face font-lock-keyword-face fontified t) 6106 6129 (fontified t) 6129 6136 (face font-lock-string-face fontified t) 6136 6138 (fontified t) 6138 6144 (fontified t) 6144 6158 (face font-lock-keyword-face fontified t) 6158 6160 (fontified t) 6160 6165 (face font-lock-keyword-face fontified t) 6165 6175 (fontified t) 6175 6188 (face font-lock-keyword-face fontified t) 6188 6200 (fontified t) 6200 6210 (face font-lock-string-face fontified t) 6210 6214 (fontified t) 6214 6215 (fontified t rear-nonsticky t) 6215 6216 (fontified t)) . 1) (undo-tree-id216 . -6216) (undo-tree-id217 . -5421) (undo-tree-id218 . -6215) (undo-tree-id219 . -6215) (undo-tree-id220 . -6215) (undo-tree-id221 . -5421) (undo-tree-id222 . -6215) (undo-tree-id223 . -6215) (undo-tree-id224 . -5421) (undo-tree-id225 . -5421) (undo-tree-id226 . -6215) (undo-tree-id227 . -6215) (undo-tree-id228 . -6215) (undo-tree-id229 . -6215) (undo-tree-id230 . -6215) (undo-tree-id231 . -6215) (undo-tree-id232 . -6215) (undo-tree-id233 . -6216) (t 26976 52996 0 0)) nil (26976 53038 876413 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19141 . 19142) (nil fontified nil 1530 . 19142) (nil fontified nil 1528 . 1530) (nil fontified nil 1518 . 1528) (nil fontified nil 1501 . 1518) (nil fontified nil 1496 . 1501) (nil fontified nil 1492 . 1496) (nil fontified nil 1482 . 1492) (nil fontified nil 1464 . 1482) (nil fontified nil 1463 . 1464) (nil fontified nil 1458 . 1463) (nil fontified nil 1395 . 1458) (nil fontified nil 1378 . 1395) (nil fontified nil 1371 . 1378) (nil fontified nil 1357 . 1371) (nil fontified nil 1356 . 1357) (nil fontified nil 1351 . 1356) (nil fontified nil 1296 . 1351) (nil fontified nil 1279 . 1296) (nil fontified nil 1263 . 1279) (nil fontified nil 1252 . 1263) (nil fontified nil 1251 . 1252) (nil fontified nil 1246 . 1251) (nil fontified nil 1237 . 1246) (nil fontified nil 1223 . 1237) (nil fontified nil 1222 . 1223) (nil fontified nil 1216 . 1222) (nil fontified nil 1211 . 1216) (nil fontified nil 1200 . 1211) (nil fontified nil 1199 . 1200) (nil fontified nil 1193 . 1199) (nil fontified nil 1186 . 1193) (nil fontified nil 1175 . 1186) (nil fontified nil 1174 . 1175) (nil fontified nil 1168 . 1174) (nil fontified nil 1166 . 1168) (nil fontified nil 1129 . 1166) (nil fontified nil 1123 . 1129) (nil fontified nil 1109 . 1123) (nil fontified nil 1108 . 1109) (nil fontified nil 1102 . 1108) (nil fontified nil 1101 . 1102) (nil fontified nil 1046 . 1101) (nil fontified nil 1041 . 1046) (nil fontified nil 1026 . 1041) (nil fontified nil 1025 . 1026) (nil fontified nil 1019 . 1025) (nil fontified nil 1015 . 1019) (nil fontified nil 1000 . 1015) (nil fontified nil 985 . 1000) (nil fontified nil 974 . 985) (nil fontified nil 973 . 974) (nil fontified nil 967 . 973) (nil fontified nil 966 . 967) (nil fontified nil 891 . 966) (nil fontified nil 886 . 891) (nil fontified nil 829 . 886) (nil fontified nil 824 . 829) (nil fontified nil 749 . 824) (nil fontified nil 744 . 749) (nil fontified nil 741 . 744) (nil fontified nil 727 . 741) (nil fontified nil 726 . 727) (nil fontified nil 716 . 726) (nil fontified nil 711 . 716) (nil fontified nil 695 . 711) (nil fontified nil 694 . 695) (nil fontified nil 663 . 694) (nil fontified nil 658 . 663) (nil fontified nil 635 . 658) (nil fontified nil 634 . 635) (nil fontified nil 616 . 634) (nil fontified nil 604 . 616) (nil fontified nil 590 . 604) (nil fontified nil 589 . 590) (nil fontified nil 571 . 589) (nil fontified nil 570 . 571) (nil fontified nil 560 . 570) (nil fontified nil 548 . 560) (nil fontified nil 543 . 548) (nil fontified nil 542 . 543) (nil fontified nil 533 . 542) (nil fontified nil 532 . 533) (nil fontified nil 524 . 532) (nil fontified nil 512 . 524) (nil fontified nil 504 . 512) (nil fontified nil 503 . 504) (nil fontified nil 497 . 503) (nil fontified nil 496 . 497) (nil fontified nil 489 . 496) (nil fontified nil 488 . 489) (nil fontified nil 481 . 488) (nil fontified nil 473 . 481) (nil fontified nil 455 . 473) (nil fontified nil 454 . 455) (nil fontified nil 433 . 454) (nil fontified nil 432 . 433) (nil fontified nil 413 . 432) (nil fontified nil 412 . 413) (nil fontified nil 400 . 412) (nil fontified nil 395 . 400) (nil fontified nil 374 . 395) (nil fontified nil 373 . 374) (nil fontified nil 360 . 373) (nil fontified nil 359 . 360) (nil fontified nil 340 . 359) (nil fontified nil 339 . 340) (nil fontified nil 321 . 339) (nil fontified nil 320 . 321) (nil fontified nil 308 . 320) (nil fontified nil 303 . 308) (nil fontified nil 280 . 303) (nil fontified nil 279 . 280) (nil fontified nil 259 . 279) (nil fontified nil 258 . 259) (nil fontified nil 240 . 258) (nil fontified nil 236 . 240) (nil fontified nil 217 . 236) (nil fontified nil 216 . 217) (nil fontified nil 204 . 216) (nil fontified nil 199 . 204) (nil fontified nil 189 . 199) (nil fontified nil 185 . 189) (nil fontified nil 167 . 185) (nil fontified nil 166 . 167) (nil fontified nil 154 . 166) (nil fontified nil 149 . 154) (nil fontified nil 132 . 149) (nil fontified nil 131 . 132) (nil fontified nil 111 . 131) (nil fontified nil 110 . 111) (nil fontified nil 93 . 110) (nil fontified nil 89 . 93) (nil fontified nil 78 . 89) (nil fontified nil 77 . 78) (nil fontified nil 65 . 77) (nil fontified nil 57 . 65) (nil fontified nil 54 . 57) (nil fontified nil 53 . 54) (nil fontified nil 49 . 53) (nil fontified nil 45 . 49) (nil fontified nil 31 . 45) (nil fontified nil 30 . 31) (nil fontified nil 20 . 30) (nil fontified nil 16 . 20) (nil fontified nil 13 . 16) (nil fontified nil 12 . 13) (nil fontified nil 2 . 12) (nil fontified nil 1 . 2) (1 . 19142)) nil (26976 53038 876389 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
	   :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock (portables, pas de semaphore-count)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)  ; nb de connexions actuellement “tenues” par with-conn
(defvar *pool-waiters*  0)  ; nb de threads en attente d’un slot

(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size)
                   (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms)
                   (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
;; :toplevel | :scoped | :pooled-native
(defvar *connection-mode* :toplevel)

(defvar *default-statement-timeout-ms* nil
  \"Timeout par défaut (ms) appliqué aux requêtes si fourni. NIL = pas de timeout.\")

(defvar *slow-query-ms* 500.0
  \"Seuil (ms) au-delà duquel on loggue la requête comme lente.\")

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  \"Initialise selon :connection-mode.
:toplevel → connect-toplevel
:scoped   → rien (ouverture par bloc)
:pooled-native → rien ici (piscine Postmodern via :pooled-p dans with-conn).
Tu peux régler postmodern:*max-pool-size* en amont.\"
  (print \"IN START!\")
  (print config)
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
			      (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\"
							 :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (print *connection-mode*)

  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     ;; Pas de connexion globale ; on laisse with-conn piloter. On initialise le pool si besoin.
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections & Transactions
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk
		       &key (cfg (or *current-config* (lumen.data.config:db-config))))
  \"Exécute THUNK dans une connexion Postgres selon CONFIG (ou provider). Priorité à *current-config* (set par start!) sinon config par défaut. Supporte :connection-mode = :toplevel | :scoped | :pooled-native.\"
  (let* ((mode (intern
                (string-upcase
                 ;; On regarde aussi dans la cfg passée en priorité
                 (or (getf cfg :db-connection-mode)
                     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                :keyword)))
    (ecase mode
      (:toplevel
       ;; Connexion globale déjà ouverte par start! ; on exécute directement.
       (funcall thunk))

      (:scoped
       #+postmodern
       (let* ((db   (getf cfg :database))
              (user (getf cfg :user))
              (pass (getf cfg :password))
              (host (or (getf cfg :host) \"localhost\"))
              (port (or (getf cfg :port) 5432))
              (app  (or (getf cfg :application-name) \"\"))
              (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host
                                           :port port :use-ssl use-ssl
                                           :application-name app)
           (funcall thunk)))
       #-postmodern
       (funcall thunk))

      (:pooled-native
       ;; Contrainte de concurrence via sémaphore local
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time)
                           (* internal-time-units-per-second
                              (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         ;; entrer en file d’attente
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema*
                                                     :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline)
                                   (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                ;; slot acquis → MAJ compteurs + métriques d’attente
                (%pool-incf! '*pool-waiters*  -1)
                (%pool-incf! '*pool-inflight* 1)
                (let* ((t1 (get-internal-real-time))
                       (wait-ms (* 1000.0 (/ (- t1 t0) internal-time-units-per-second))))
                  (multiple-value-bind (in-use _waiters) (%pool-snapshot)
                    (declare (ignore _waiters))
                    (ignore-errors
                      (lumen.data.metrics:record-pool-stats in-use wait-ms))))
                ;; ouvrir une connexion poolée Postmodern pour le corps
                #+postmodern		
                (let* ((db   (getf cfg :database))
                       (user (getf cfg :user))
                       (pass (getf cfg :password))
                       (host (or (getf cfg :host) \"localhost\"))
                       (port (or (getf cfg :port) 5432))
                       (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect		       
                       (postmodern:with-connection (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t)
			 (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    ;; libération du slot
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect
                     (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1)
                  (bt:signal-semaphore *pool-sema*)))
           ;; si erreur avant slot → on enlève l’attente
           (when (> *pool-waiters* 0)
             (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  \"Usage:
  (with-conn               ...body...)          ; config via provider (ENV)
  (with-conn (:config cfg) ...body...)          ; surcharge ponctuelle\"
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      ;; Pas d'opts : `opts` est en fait la 1ère forme du body (compat)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;; Ajoutez cette fonction AVANT la macro with-tx
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Logique d'exécution transactionnelle avec retries.
   Isole le contexte pour éviter les erreurs de pile (CONTROL-ERROR).\"
  (let ((attempt 0))
    (loop
      (multiple-value-bind (outcome payload)
          (handler-case
              ;; Essai d'exécution
              (values :success
                      (multiple-value-list
                       (ensure-connection
                         #+postmodern
                         (postmodern:with-transaction ()
                           (funcall thunk))
                         #-postmodern
                         (funcall thunk))))
            
            ;; 1. Erreur Métier : On capture UNIQUEMENT le message (String)
            ;; Cela détruit tout lien avec l'objet condition problématique.
            (lumen.core.error:application-error (c)
              (values :app-error (princ-to-string c)))
            
            ;; 2. Erreur DB : On capture l'objet mappé
            (condition (c)
              (let ((mapped (lumen.data.errors:map-db-error c)))
                (if (and (< attempt retries)
                         (lumen.data.errors:retryable-db-error-p mapped))
                    (values :retry nil)
                    (values :db-error mapped)))))
        
        ;; ANALYSE DU RÉSULTAT (Hors du contexte protégé)
        (ecase outcome
          (:success
           (return (values-list payload))) ;; Retour simple du LOOP (safe)
          
          (:retry
           (incf attempt)
           (when (plusp sleep-ms)
             (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
          
          (:app-error
           ;; On recrée une erreur vierge ici
           ;; Note: On utilise find-symbol pour ne pas dépendre de QALM à la compilation
           (let* ((sym (or (find-symbol \"BUSINESS-ERROR\" \"QALM.BACKEND.CORE.ERROR\")
                           'lumen.core.error:application-error))
                  (msg payload)
                  ;; Nettoyage du préfixe si présent
                  (clean-msg (if (search \"Business Error: \" msg)
                                 (subseq msg 16)
                                 msg)))
             (error (make-instance sym :message clean-msg))))
          
          (:db-error
           (error payload)))))))

;; Redéfinition de la macro pour utiliser le helper
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  ;; On enveloppe le body dans une lambda et on passe au helper
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  \"Applique SET LOCAL statement_timeout = MS à l’intérieur d’une transaction existante.
Ne crée pas de transaction : à utiliser sous with-conn + BEGIN, ou quand un bloc
ouvrira de toute façon une transaction (ex: via ton code applicatif).\"
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn
           ;; SET LOCAL n’a d’effet que dans une transaction *déjà* ouverte.
           ;; Dans les tests, on est sous with-rollback (BEGIN/ROLLBACK).
           (ignore-errors
             (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
           ,@body)
         (progn ,@body))))
;; ----------------------------------------------------------------------------
;; Internal helpers
;; ----------------------------------------------------------------------------
;; Postmodern attend :use-ssl = :no | :try | :require | :yes | :full
(defun %sslmode->use-ssl (sslmode)
  (case sslmode
    ((:disable nil) :no)
    ((:allow :prefer) :try)
    (:require :require)
    (:verify-ca :yes)
    (:verify-full :full)
    (t :no)))

(defun %rows->alists (rows)
  \"Best-effort conversion to alists. If ROWS already look like alists, return as-is.\"
  (if (and rows (consp (first rows)) (keywordp (caar rows)))
      rows
      ;; Fallback – leave as-is (caller may adapt). Improve with column metadata if needed.
      rows))

(defun %now-ms ()
  (round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))

(defun %elapsed-ms (t0)
  (* 1000.0 (/ (- (get-internal-real-time) t0) internal-time-units-per-second)))

;; ----------------------------------------------------------------------------
;; Query wrappers
;; ----------------------------------------------------------------------------
(defun query-a (sql &rest params)
  \"Execute a SELECT-like statement, return (values rows-alist count).
Options en fin de params (keywords) :
  :timeout-ms <int>  — timeout Postgres via SET LOCAL statement_timeout (ms).\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
	       sql elapsed-ms :params args :rows (length rows)))
            (values rows (length rows))))
      (condition (c)
        (translate-db-error c)))))

(defun query-1a (sql &rest params)
  \"Like query-a but expect 0/1 row; return alist or NIL.
Options :
  :timeout-ms <int>\"
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn  (get-prepared-plan sql :format :alist))
                 (row (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (if row 1 0))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
	       sql elapsed-ms :params args :rows (if row 1 0)))
            row))
      (condition (c)
        (translate-db-error c)))))

(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
   Gère correctement les arguments :NULL dans les paramètres SQL.\"
  
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  
  (let* (;; On cherche le début des options (:timeout-ms, etc.)
         ;; CORRECTION : On ignore :NULL et :DEFAULT qui sont des valeurs SQL, pas des options.
         (kpos (position-if (lambda (x)
                              (and (keywordp x)
                                   (not (member x '(:null :default) :test #'eq))))
                            params))
         
         ;; Séparation propre Arguments SQL / Options Lumen
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         
         ;; Extraction des options
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (format t \"~&EXEC:OPTS: ~A~%\" opts)
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            
            (if has-returning
                ;; RETURNING -> On veut le résultat (alist)
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                
                ;; Pas de RETURNING -> On veut juste le nombre de lignes affectées
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            
            ;; Métriques (Optionnel)
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            
            (values affected ret)))

      ;; Si c'est une erreur applicative, on la re-signale telle quelle
      ;; sans l'emballer dans une db-error.
      (lumen.core.error:application-error (c)
        (error c))
      
      (condition (c)
        (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  \"Exécute BODY dans une transaction qui sera annulée.
   Accepte des options comme (:config my-config).\"
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect
          (progn ,@body)
       (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 454 (fontified t) 454 472 (face font-lock-builtin-face fontified t) 472 480 (fontified t) 480 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 495 (face font-lock-builtin-face fontified t) 495 496 (fontified t) 496 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 511 (face font-lock-builtin-face fontified t) 511 523 (fontified t) 523 531 (face font-lock-builtin-face fontified t) 531 532 (fontified t) 532 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 547 (face font-lock-builtin-face fontified t) 547 559 (fontified t) 559 569 (face font-lock-builtin-face fontified t) 569 570 (fontified t) 570 588 (face font-lock-builtin-face fontified t) 588 589 (fontified t) 589 603 (face font-lock-builtin-face fontified t) 603 615 (fontified t) 615 633 (face font-lock-builtin-face fontified t) 633 634 (fontified t) 634 657 (face font-lock-builtin-face fontified t) 657 662 (fontified t) 662 693 (face font-lock-builtin-face fontified t) 693 694 (fontified t) 694 710 (face font-lock-builtin-face fontified t) 710 715 (fontified t) 715 725 (face font-lock-keyword-face fontified t) 725 726 (fontified t) 726 740 (face font-lock-builtin-face fontified t) 740 743 (fontified t) 743 748 (face font-lock-comment-delimiter-face fontified t) 748 823 (face font-lock-comment-face fontified t) 823 828 (face font-lock-comment-delimiter-face fontified t) 828 885 (face font-lock-comment-face fontified t) 885 890 (face font-lock-comment-delimiter-face fontified t) 890 965 (face font-lock-comment-face fontified t) 965 966 (fontified t) 966 972 (face font-lock-keyword-face fontified t) 972 973 (fontified t) 973 984 (face font-lock-variable-name-face fontified t) 984 999 (fontified t) 999 1014 (face font-lock-string-face fontified t) 1014 1018 (fontified t) 1018 1024 (face font-lock-keyword-face fontified t) 1024 1025 (fontified t) 1025 1040 (face font-lock-variable-name-face fontified t) 1040 1045 (fontified t) 1045 1100 (face font-lock-comment-face fontified t) 1100 1101 (fontified t) 1101 1107 (face font-lock-keyword-face fontified t) 1107 1108 (fontified t) 1108 1122 (face font-lock-variable-name-face fontified t) 1122 1128 (fontified t) 1128 1165 (face font-lock-comment-face fontified t) 1165 1167 (fontified t) 1167 1173 (face font-lock-keyword-face fontified t) 1173 1174 (fontified t) 1174 1185 (face font-lock-variable-name-face fontified t) 1185 1192 (fontified t) 1192 1198 (face font-lock-keyword-face fontified t) 1198 1199 (fontified t) 1199 1210 (face font-lock-variable-name-face fontified t) 1210 1215 (fontified t) 1215 1221 (face font-lock-keyword-face fontified t) 1221 1222 (fontified t) 1222 1236 (face font-lock-variable-name-face fontified t) 1236 1245 (fontified t) 1245 1250 (face font-lock-keyword-face fontified t) 1250 1251 (fontified t) 1251 1262 (face font-lock-function-name-face fontified t) 1262 1278 (fontified t) 1278 1295 (face font-lock-keyword-face fontified t) 1295 1350 (fontified t) 1350 1355 (face font-lock-keyword-face fontified t) 1355 1356 (fontified t) 1356 1370 (face font-lock-function-name-face fontified t) 1370 1377 (fontified t) 1377 1394 (face font-lock-keyword-face fontified t) 1394 1457 (fontified t) 1457 1462 (face font-lock-keyword-face fontified t) 1462 1463 (fontified t) 1463 1481 (face font-lock-function-name-face fontified t) 1481 1491 (fontified t) 1491 1495 (face font-lock-keyword-face fontified t) 1495 1500 (fontified t) 1500 1517 (fontified t) 1517 1527 (face font-lock-builtin-face fontified t) 1527 1529 (fontified t) 8938 8939 (fontified t) 8939 8947 (fontified t face font-lock-keyword-face) 8947 8948 (fontified t) 8948 8957 (fontified t face font-lock-function-name-face) 8957 8959 (fontified t) 8959 8968 (fontified t face font-lock-type-face) 8968 8974 (fontified t) 8974 8979 (fontified t face font-lock-type-face) 8979 8988 (fontified t) 8988 9143 (fontified t face font-lock-doc-face) 9143 9147 (fontified t) 9147 9149 (fontified t face font-lock-keyword-face) 9149 9239 (fontified t) 9239 9245 (fontified t face font-lock-keyword-face) 9245 9271 (fontified t) 9271 9274 (fontified t face font-lock-comment-delimiter-face) 9274 9337 (fontified t face font-lock-comment-face) 9337 9361 (fontified t) 9361 9367 (face font-lock-keyword-face fontified t) 9367 9388 (fontified t) 9388 9390 (fontified t) 9390 9398 (face font-lock-keyword-face fontified t) 9398 9399 (fontified t) 9399 9416 (face font-lock-function-name-face fontified t) 9416 9418 (fontified t) 9418 9427 (face font-lock-type-face fontified t) 9427 9433 (fontified t) 9433 9438 (face font-lock-type-face fontified t) 9438 9449 (fontified t) 9449 9458 (face font-lock-keyword-face fontified t) 9458 9475 (fontified t) 9475 9478 (face font-lock-comment-delimiter-face fontified t) 9478 9524 (face font-lock-comment-face fontified t) 9524 9525 (fontified t) 9525 9530 (fontified t face font-lock-keyword-face) 9530 9531 (fontified t) 9531 9549 (fontified t face font-lock-function-name-face) 9549 9577 (fontified t) 9577 9699 (fontified t face font-lock-doc-face) 9699 9703 (fontified t) 9703 9706 (fontified t face font-lock-keyword-face) 9706 9726 (fontified t) 9726 9730 (fontified t face font-lock-keyword-face) 9730 9738 (fontified t) 9738 9757 (fontified t face font-lock-keyword-face) 9757 9787 (fontified t) 9787 9799 (fontified t face font-lock-keyword-face) 9799 9814 (fontified t) 9814 9817 (fontified t face font-lock-comment-delimiter-face) 9817 9835 (fontified t face font-lock-comment-face) 9835 9857 (fontified t) 9857 9865 (fontified t face font-lock-builtin-face) 9865 10015 (fontified t) 10015 10042 (fontified t face font-lock-keyword-face) 10042 10115 (fontified t) 10115 10168 (face slime-reader-conditional-face fontified t) 10168 10197 (fontified t) 10197 10200 (face font-lock-comment-delimiter-face fontified t) 10200 10261 (face font-lock-comment-face fontified t) 10261 10273 (fontified t) 10273 10276 (face font-lock-comment-delimiter-face fontified t) 10276 10337 (face font-lock-comment-face fontified t) 10337 10411 (fontified t) 10411 10421 (face font-lock-builtin-face fontified t) 10421 10469 (fontified t) 10469 10472 (face font-lock-comment-delimiter-face fontified t) 10472 10512 (face font-lock-comment-face fontified t) 10512 10554 (fontified t) 10554 10557 (face font-lock-keyword-face fontified t) 10557 10621 (fontified t) 10621 10623 (face font-lock-keyword-face fontified t) 10623 10751 (fontified t) 10751 10757 (face font-lock-builtin-face fontified t) 10757 10791 (fontified t) 10791 10800 (face font-lock-builtin-face fontified t) 10800 10830 (fontified t) 10830 10833 (face font-lock-comment-delimiter-face fontified t) 10833 10880 (face font-lock-comment-face fontified t) 10880 10889 (fontified t) 10889 10894 (face font-lock-keyword-face fontified t) 10894 10914 (fontified t) 10914 10922 (face font-lock-builtin-face fontified t) 10922 10935 (fontified t) 10935 10941 (face font-lock-keyword-face fontified t) 10941 10966 (fontified t) 10966 10969 (face font-lock-comment-delimiter-face fontified t) 10969 10998 (face font-lock-comment-face fontified t) 10998 11020 (fontified t) 11020 11026 (face font-lock-builtin-face fontified t) 11026 11065 (fontified t) 11065 11069 (face font-lock-keyword-face fontified t) 11069 11138 (fontified t) 11138 11141 (face font-lock-comment-delimiter-face fontified t) 11141 11151 (face font-lock-comment-face fontified t) 11151 11173 (fontified t) 11173 11183 (face font-lock-builtin-face fontified t) 11183 11195 (fontified t) 11195 11198 (face font-lock-comment-delimiter-face fontified t) 11198 11230 (face font-lock-comment-face fontified t) 11230 11241 (fontified t) 11241 11244 (face font-lock-comment-delimiter-face fontified t) 11244 11319 (face font-lock-comment-face fontified t) 11319 11331 (fontified t) 11331 11335 (face font-lock-keyword-face fontified t) 11335 11359 (fontified t) 11359 11375 (face font-lock-string-face fontified t) 11375 11376 (fontified t) 11376 11401 (face font-lock-string-face fontified t) 11401 11518 (fontified t) 11518 11521 (face font-lock-comment-delimiter-face fontified t) 11521 11542 (face font-lock-comment-face fontified t) 11542 11553 (fontified t face font-lock-comment-face) 16246 16247 (fontified t) 16247 16252 (fontified t face font-lock-keyword-face) 16252 16253 (fontified t) 16253 16257 (fontified t face font-lock-function-name-face) 16257 16263 (fontified t) 16263 16268 (fontified t face font-lock-type-face) 16268 16279 (fontified t) 16279 16414 (fontified t face font-lock-doc-face) 16414 16430 (fontified t) 16430 16448 (fontified t face font-lock-string-face) 16448 16460 (fontified t) 16460 16464 (fontified t face font-lock-keyword-face) 16464 16466 (fontified t) 16466 16469 (fontified t face font-lock-comment-delimiter-face) 16469 16521 (fontified t face font-lock-comment-face) 16521 16530 (fontified t) 16530 16533 (fontified t face font-lock-comment-delimiter-face) 16533 16617 (fontified t face font-lock-comment-face) 16617 16646 (fontified t) 16646 16652 (fontified t face font-lock-keyword-face) 16652 16757 (fontified t) 16757 16762 (fontified t face font-lock-builtin-face) 16762 16763 (fontified t) 16763 16771 (fontified t face font-lock-builtin-face) 16771 16773 (fontified t) 16773 16778 (fontified t face font-lock-builtin-face) 16778 16844 (fontified t) 16844 16847 (fontified t face font-lock-comment-delimiter-face) 16847 16895 (fontified t face font-lock-comment-face) 16895 16911 (fontified t) 16911 16913 (fontified t face font-lock-keyword-face) 16913 16967 (fontified t) 16967 16969 (fontified t face font-lock-keyword-face) 16969 17021 (fontified t) 17021 17024 (fontified t face font-lock-comment-delimiter-face) 17024 17047 (fontified t face font-lock-comment-face) 17047 17079 (fontified t) 17079 17090 (fontified t face font-lock-builtin-face) 17090 17188 (fontified t) 17188 17207 (fontified t face font-lock-string-face) 17207 17228 (fontified t) 17228 17247 (fontified t face font-lock-string-face) 17247 17264 (fontified t) 17264 17276 (fontified t face font-lock-keyword-face) 17276 17286 (fontified t) 17286 17308 (fontified t face font-lock-keyword-face) 17308 17333 (fontified t) 17333 17337 (fontified t face font-lock-keyword-face) 17337 17409 (fontified t) 17409 17420 (fontified t face font-lock-string-face) 17420 17486 (fontified t) 17486 17488 (fontified t face font-lock-keyword-face) 17488 17519 (fontified t) 17519 17522 (fontified t face font-lock-comment-delimiter-face) 17522 17563 (fontified t face font-lock-comment-face) 17563 17580 (fontified t) 17580 17584 (fontified t face font-lock-keyword-face) 17584 17614 (fontified t) 17614 17621 (fontified t face font-lock-builtin-face) 17621 17622 (fontified t) 17622 17628 (fontified t face font-lock-builtin-face) 17628 17711 (fontified t) 17711 17713 (fontified t face font-lock-keyword-face) 17713 17790 (fontified t) 17790 17793 (fontified t face font-lock-comment-delimiter-face) 17793 17857 (fontified t face font-lock-comment-face) 17857 17874 (fontified t) 17874 17878 (fontified t face font-lock-keyword-face) 17878 17907 (fontified t) 17907 17914 (fontified t face font-lock-builtin-face) 17914 17915 (fontified t) 17915 17920 (fontified t face font-lock-builtin-face) 17920 18070 (fontified t) 18070 18073 (fontified t face font-lock-comment-delimiter-face) 18073 18095 (fontified t face font-lock-comment-face) 18095 18108 (fontified t) 18108 18111 (fontified t face font-lock-keyword-face) 18111 18334 (fontified t) 18334 18338 (fontified t face font-lock-keyword-face) 18338 18479 (fontified t) 18479 18486 (fontified t face font-lock-builtin-face) 18486 18492 (fontified t) 18492 18501 (fontified t face font-lock-builtin-face) 18501 18527 (fontified t) 18527 18570 (fontified t) 18570 18573 (face font-lock-comment-delimiter-face fontified t) 18573 18636 (face font-lock-comment-face fontified t) 18636 18642 (fontified t) 18642 18645 (face font-lock-comment-delimiter-face fontified t) 18645 18680 (face font-lock-comment-face fontified t) 18680 18735 (fontified t) 18735 18740 (face font-lock-warning-face fontified t) 18740 18810 (fontified t) 18810 18818 (face font-lock-keyword-face fontified t) 18818 18819 (fontified t) 18819 18832 (face font-lock-function-name-face fontified t) 18832 18835 (fontified t) 18835 18844 (face font-lock-type-face fontified t) 18844 18851 (fontified t) 18851 18856 (face font-lock-type-face fontified t) 18856 18865 (fontified t) 18865 18968 (face font-lock-doc-face fontified t) 18968 18973 (fontified t) 18973 18996 (face font-lock-keyword-face fontified t) 18996 19028 (fontified t) 19028 19035 (face font-lock-string-face fontified t) 19035 19043 (fontified t) 19043 19057 (face font-lock-keyword-face fontified t) 19057 19069 (fontified t) 19069 19074 (face font-lock-keyword-face fontified t) 19074 19091 (fontified t) 19091 19104 (face font-lock-keyword-face fontified t) 19104 19125 (fontified t) 19125 19135 (face font-lock-string-face fontified t) 19135 19140 (fontified t) 19140 19141 (fontified t rear-nonsticky t)) . 1) (undo-tree-id234 . -19141) (undo-tree-id235 . -18527) (undo-tree-id236 . -19141) (undo-tree-id237 . -10042) (undo-tree-id238 . -19141) (undo-tree-id239 . -10045) (undo-tree-id240 . -19141) (t 26976 53038 0 0)) nil (26976 53585 652408 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15543 . 15544) (nil fontified nil 1 . 15544) (1 . 15544)) nil (26976 53585 652393 0) 0 nil])
([nil nil ((15544 . 15545)) nil (26976 54627 724518 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction Postmodern avec gestion de retry.
   Utilise le 'Tunneling' pour éviter les erreurs de pile (CONTROL-ERROR).\"
  (let ((attempt 0))
    (loop
      ;; On utilise un handler-case AUTOUR de la transaction pour récupérer
      ;; ce qui sort du tunnel.
      (handler-case
          (return 
            (ensure-connection
              #+postmodern
              (postmodern:with-transaction ()
                ;; DEDANS la transaction : On capture les erreurs
                (handler-bind ((error (lambda (c)
                                        ;; Si c'est une erreur métier, on ne peut pas juste 'return'
                                        ;; car ça casserait Postmodern.
                                        ;; On l'emballe dans une erreur tunnel et on SIGNAL.
                                        ;; Postmodern verra une erreur -> ROLLBACK -> Propagation.
                                        (when (typep c 'lumen.core.error:application-error)
                                          (error 'tx-tunnel-error :payload c))
                                        
                                        ;; Si c'est une erreur technique, on laisse passer
                                        ;; Postmodern fera Rollback aussi.
                                        )))
                  (funcall thunk)))
              #-postmodern
              (funcall thunk)))

        ;; CATCH DU TUNNEL (L'erreur métier arrive ici, saine et sauve, après le Rollback)
        (tx-tunnel-error (e)
          ;; On déballe et on relance l'erreur originale vers le Middleware
          (error (tx-tunnel-payload e)))

        ;; CATCH DU RETRY (Erreurs techniques DB)
        (error (c)
          ;; On vérifie si on doit retenter
          (let ((mapped (lumen.data.errors:map-db-error c)))
            (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (progn
                  (incf attempt)
                  (when (plusp sleep-ms)
                    (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                
                ;; Sinon c'est une vraie erreur technique (ou l'erreur métier si le tunnel a échoué)
                ;; On relance.
                (error c))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 198 (face font-lock-doc-face fontified t) 198 202 (fontified t) 202 205 (face font-lock-keyword-face fontified t) 205 225 (fontified t) 225 229 (face font-lock-keyword-face fontified t) 229 236 (fontified t) 236 239 (face font-lock-comment-delimiter-face fontified t) 239 306 (face font-lock-comment-face fontified t) 306 312 (fontified t) 312 315 (face font-lock-comment-delimiter-face fontified t) 315 338 (face font-lock-comment-face fontified t) 338 345 (fontified t) 345 357 (face font-lock-keyword-face fontified t) 357 369 (fontified t) 369 375 (face font-lock-keyword-face fontified t) 375 450 (fontified t) 450 477 (face font-lock-keyword-face fontified t) 477 497 (fontified t) 497 500 (face font-lock-comment-delimiter-face fontified t) 500 547 (face font-lock-comment-face fontified t) 547 564 (fontified t) 564 576 (face font-lock-keyword-face fontified t) 576 579 (fontified t) 579 584 (face font-lock-warning-face fontified t) 584 586 (fontified t) 586 592 (face font-lock-keyword-face fontified t) 592 637 (fontified t) 637 640 (face font-lock-comment-delimiter-face fontified t) 640 698 (face font-lock-comment-face fontified t) 698 738 (fontified t) 738 741 (face font-lock-comment-delimiter-face fontified t) 741 770 (face font-lock-comment-face fontified t) 770 810 (fontified t) 810 813 (face font-lock-comment-delimiter-face fontified t) 813 863 (face font-lock-comment-face fontified t) 863 903 (fontified t) 903 906 (face font-lock-comment-delimiter-face fontified t) 906 962 (face font-lock-comment-face fontified t) 962 994 (fontified t) 994 1003 (fontified t) 1003 1007 (face font-lock-keyword-face fontified t) 1007 1054 (fontified t) 1054 1097 (fontified t) 1097 1102 (face font-lock-warning-face fontified t) 1102 1120 (fontified t) 1120 1128 (face font-lock-builtin-face fontified t) 1128 1214 (fontified t) 1214 1217 (face font-lock-comment-delimiter-face fontified t) 1217 1265 (face font-lock-comment-face fontified t) 1265 1305 (fontified t) 1305 1308 (face font-lock-comment-delimiter-face fontified t) 1308 1340 (face font-lock-comment-face fontified t) 1340 1434 (fontified t) 1434 1476 (face slime-reader-conditional-face fontified t) 1476 1488 (fontified t) 1488 1491 (face font-lock-comment-delimiter-face fontified t) 1491 1571 (face font-lock-comment-face fontified t) 1571 1610 (fontified t) 1610 1613 (face font-lock-comment-delimiter-face fontified t) 1613 1676 (face font-lock-comment-face fontified t) 1676 1687 (fontified t) 1687 1692 (face font-lock-warning-face fontified t) 1692 1726 (fontified t) 1726 1729 (face font-lock-comment-delimiter-face fontified t) 1729 1768 (face font-lock-comment-face fontified t) 1768 1777 (fontified t) 1777 1782 (face font-lock-warning-face fontified t) 1782 1797 (fontified t) 1797 1800 (face font-lock-comment-delimiter-face fontified t) 1800 1831 (face font-lock-comment-face fontified t) 1831 1842 (fontified t) 1842 1845 (face font-lock-keyword-face fontified t) 1845 1905 (fontified t) 1905 1907 (face font-lock-keyword-face fontified t) 1907 2006 (fontified t) 2006 2011 (face font-lock-keyword-face fontified t) 2011 2064 (fontified t) 2064 2068 (face font-lock-keyword-face fontified t) 2068 2144 (fontified t) 2144 2147 (face font-lock-comment-delimiter-face fontified t) 2147 2157 (face font-lock-comment-face fontified t) 2157 2190 (fontified t) 2190 2193 (face font-lock-comment-delimiter-face fontified t) 2193 2275 (face font-lock-comment-face fontified t) 2275 2291 (fontified t) 2291 2294 (face font-lock-comment-delimiter-face fontified t) 2294 2306 (face font-lock-comment-face fontified t) 2306 2323 (fontified t) 2323 2328 (face font-lock-warning-face fontified t) 2328 2338 (fontified t)) . -8128) (undo-tree-id284 . -2338) (undo-tree-id285 . -2086) 10466 (t 26976 54628 0 0)) nil (26976 55076 362916 0) 0 nil] [nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)

(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size)
                   (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms)
                   (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)

(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  (print \"IN START!\")
  (print config)
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\"
                                                         :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (print *connection-mode*)

  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections
;; ----------------------------------------------------------------------------
(defun call-with-conn (thunk
                       &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern
                (string-upcase
                 (or (getf cfg :db-connection-mode)
                     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped
       #+postmodern
       (let* ((db   (getf cfg :database))
              (user (getf cfg :user))
              (pass (getf cfg :password))
              (host (or (getf cfg :host) \"localhost\"))
              (port (or (getf cfg :port) 5432))
              (app  (or (getf config :application-name) \"\"))
              (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host
                                           :port port :use-ssl use-ssl
                                           :application-name app)
           (funcall thunk)))
       #-postmodern (funcall thunk))
      (:pooled-native
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time)
                           (* internal-time-units-per-second
                              (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema*
                                                     :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline)
                                   (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                (%pool-incf! '*pool-waiters* -1)
                (%pool-incf! '*pool-inflight* 1)
                #+postmodern        
                (let* ((db   (getf cfg :database))
                       (user (getf cfg :user))
                       (pass (getf cfg :password))
                       (host (or (getf cfg :host) \"localhost\"))
                       (port (or (getf cfg :port) 5432))
                       (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect                
                       (postmodern:with-connection (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t)
                         (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect
                     (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1)
                  (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0)
             (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS SECURISÉES (LE FIX)
;;; ---------------------------------------------------------------------------

;; Condition spéciale pour \"transporter\" l'erreur à travers la couche Transaction
(define-condition tx-tunnel-error (error)
  ((payload :initarg :payload :reader tx-tunnel-payload))
  (:documentation \"Erreur technique utilisée pour forcer le ROLLBACK de Postmodern tout en transportant l'erreur métier.\"))

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction Postmodern avec gestion de retry.
   Utilise le 'Tunneling' pour éviter les erreurs de pile (CONTROL-ERROR).\"
  (let ((attempt 0))
    (loop
      ;; On utilise un handler-case AUTOUR de la transaction pour récupérer
      ;; ce qui sort du tunnel.
      (handler-case
          (return 
            (ensure-connection
              #+postmodern
              (postmodern:with-transaction ()
                ;; DEDANS la transaction : On capture les erreurs
                (handler-bind ((error (lambda (c)
                                        ;; Si c'est une erreur métier, on ne peut pas juste 'return'
                                        ;; car ça casserait Postmodern.
                                        ;; On l'emballe dans une erreur tunnel et on SIGNAL.
                                        ;; Postmodern verra une erreur -> ROLLBACK -> Propagation.
                                        (when (typep c 'lumen.core.error:application-error)
                                          (error 'tx-tunnel-error :payload c))
                                        
                                        ;; Si c'est une erreur technique, on laisse passer
                                        ;; Postmodern fera Rollback aussi.
                                        )))
                  (funcall thunk)))
              #-postmodern
              (funcall thunk)))

        ;; CATCH DU TUNNEL (L'erreur métier arrive ici, saine et sauve, après le Rollback)
        (tx-tunnel-error (e)
          ;; On déballe et on relance l'erreur originale vers le Middleware
          (error (tx-tunnel-payload e)))

        ;; CATCH DU RETRY (Erreurs techniques DB)
        (error (c)
          ;; On vérifie si on doit retenter
          (let ((mapped (lumen.data.errors:map-db-error c)))
            (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (progn
                  (incf attempt)
                  (when (plusp sleep-ms)
                    (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
                
                ;; Sinon c'est une vraie erreur technique (ou l'erreur métier si le tunnel a échoué)
                ;; On relance.
                (error c))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn
           (ignore-errors
             (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
           ,@body)
         (progn ,@body))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun %rows->alists (rows)
  (if (and rows (consp (first rows)) (keywordp (caar rows))) rows rows))

(defun %now-ms () (round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))
(defun %elapsed-ms (t0) (* 1000.0 (/ (- (get-internal-real-time) t0) internal-time-units-per-second)))

;;; ---------------------------------------------------------------------------
;;; Query Wrappers
;;; ---------------------------------------------------------------------------
(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
            (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :rows (length rows)))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn  (get-prepared-plan sql :format :alist))
                 (row (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (if row 1 0))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :rows (if row 1 0)))
            row))
      (condition (c) (translate-db-error c)))))

(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      ;; BYPASS CRITIQUE : On laisse passer l'erreur applicative pour qu'elle soit attrapée par call-with-tx-logic
      (lumen.core.error:application-error (c) (error c))
      (condition (c) (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 454 (fontified t) 454 472 (face font-lock-builtin-face fontified t) 472 480 (fontified t) 480 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 495 (face font-lock-builtin-face fontified t) 495 496 (fontified t) 496 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 511 (face font-lock-builtin-face fontified t) 511 523 (fontified t) 523 531 (face font-lock-builtin-face fontified t) 531 532 (fontified t) 532 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 547 (face font-lock-builtin-face fontified t) 547 559 (fontified t) 559 569 (face font-lock-builtin-face fontified t) 569 570 (fontified t) 570 588 (face font-lock-builtin-face fontified t) 588 589 (fontified t) 589 603 (face font-lock-builtin-face fontified t) 603 615 (fontified t) 615 633 (face font-lock-builtin-face fontified t) 633 634 (fontified t) 634 657 (face font-lock-builtin-face fontified t) 657 669 (fontified t) 669 700 (face font-lock-builtin-face fontified t) 700 701 (fontified t) 701 717 (face font-lock-builtin-face fontified t) 717 722 (fontified t) 722 732 (face font-lock-keyword-face fontified t) 732 733 (fontified t) 733 747 (face font-lock-builtin-face fontified t) 747 750 (fontified t) 750 755 (face font-lock-comment-delimiter-face fontified t) 755 830 (face font-lock-comment-face fontified t) 830 835 (face font-lock-comment-delimiter-face fontified t) 835 856 (face font-lock-comment-face fontified t) 856 861 (face font-lock-comment-delimiter-face fontified t) 861 936 (face font-lock-comment-face fontified t) 936 937 (fontified t) 937 943 (face font-lock-keyword-face fontified t) 943 944 (fontified t) 944 955 (face font-lock-variable-name-face fontified t) 955 970 (fontified t) 970 985 (face font-lock-string-face fontified t) 985 989 (fontified t) 989 995 (face font-lock-keyword-face fontified t) 995 996 (fontified t) 996 1011 (face font-lock-variable-name-face fontified t) 1011 1016 (fontified t) 1016 1022 (face font-lock-keyword-face fontified t) 1022 1023 (fontified t) 1023 1037 (face font-lock-variable-name-face fontified t) 1037 1043 (fontified t) 1043 1049 (face font-lock-keyword-face fontified t) 1049 1050 (fontified t) 1050 1061 (face font-lock-variable-name-face fontified t) 1061 1068 (fontified t) 1068 1074 (face font-lock-keyword-face fontified t) 1074 1075 (fontified t) 1075 1086 (face font-lock-variable-name-face fontified t) 1086 1091 (fontified t) 1091 1097 (face font-lock-keyword-face fontified t) 1097 1098 (fontified t) 1098 1112 (face font-lock-variable-name-face fontified t) 1112 1121 (fontified t) 1121 1126 (face font-lock-keyword-face fontified t) 1126 1127 (fontified t) 1127 1138 (face font-lock-function-name-face fontified t) 1138 1154 (fontified t) 1154 1171 (face font-lock-keyword-face fontified t) 1171 1226 (fontified t) 1226 1231 (face font-lock-keyword-face fontified t) 1231 1232 (fontified t) 1232 1246 (face font-lock-function-name-face fontified t) 1246 1253 (fontified t) 1253 1270 (face font-lock-keyword-face fontified t) 1270 1333 (fontified t) 1333 1338 (face font-lock-keyword-face fontified t) 1338 1339 (fontified t) 1339 1357 (face font-lock-function-name-face fontified t) 1357 1367 (fontified t) 1367 1371 (face font-lock-keyword-face fontified t) 1371 1393 (fontified t) 1393 1403 (face font-lock-builtin-face fontified t) 1403 1455 (fontified t) 1455 1468 (face font-lock-builtin-face fontified t) 1468 1469 (fontified t) 1469 1477 (face font-lock-builtin-face fontified t) 1477 1500 (fontified t) 1500 1513 (fontified t) 1513 1526 (face font-lock-builtin-face fontified t) 1526 1528 (fontified t) 4159 4160 (fontified t) 4160 4165 (fontified t face font-lock-keyword-face) 4165 4166 (fontified t) 4166 4180 (fontified t face font-lock-function-name-face) 4180 4211 (fontified t) 4211 4215 (fontified t face font-lock-type-face) 4215 4278 (fontified t) 4278 4282 (fontified t face font-lock-keyword-face) 4282 4360 (fontified t) 4360 4379 (fontified t face font-lock-builtin-face) 4379 4429 (fontified t) 4429 4449 (fontified t face font-lock-string-face) 4449 4450 (fontified t) 4450 4458 (fontified t face font-lock-builtin-face) 4458 4459 (fontified t) 4459 4473 (fontified t face font-lock-builtin-face) 4473 4493 (fontified t) 4493 4501 (fontified t face font-lock-builtin-face) 4501 4510 (fontified t) 4510 4515 (fontified t face font-lock-keyword-face) 4515 4528 (fontified t) 4528 4537 (fontified t face font-lock-builtin-face) 4537 4562 (fontified t) 4562 4569 (fontified t face font-lock-builtin-face) 4569 4598 (fontified t) 4598 4602 (fontified t face font-lock-keyword-face) 4602 4620 (fontified t) 4620 4629 (fontified t face font-lock-builtin-face) 4629 4662 (fontified t) 4662 4667 (fontified t face font-lock-builtin-face) 4667 4700 (fontified t) 4700 4709 (fontified t face font-lock-builtin-face) 4709 4746 (fontified t) 4746 4751 (fontified t face font-lock-builtin-face) 4751 4753 (fontified t) 4753 4764 (fontified t face font-lock-string-face) 4764 4801 (fontified t) 4801 4806 (fontified t face font-lock-builtin-face) 4806 4852 (fontified t) 4852 4869 (fontified t face font-lock-builtin-face) 4869 4871 (fontified t) 4871 4873 (fontified t face font-lock-string-face) 4873 4928 (fontified t) 4928 4936 (fontified t face font-lock-builtin-face) 4936 4951 (fontified t) 4951 4977 (fontified t face font-lock-keyword-face) 4977 5045 (fontified t) 5045 5050 (fontified t face font-lock-builtin-face) 5050 5056 (fontified t) 5056 5064 (fontified t face font-lock-builtin-face) 5064 5116 (fontified t) 5116 5133 (fontified t face font-lock-builtin-face) 5133 5175 (fontified t) 5175 5203 (fontified t face slime-reader-conditional-face) 5203 5212 (fontified t) 5212 5226 (fontified t face font-lock-builtin-face) 5226 5267 (fontified t) 5267 5271 (fontified t face font-lock-keyword-face) 5271 5535 (fontified t) 5535 5549 (fontified t face font-lock-keyword-face) 5549 5565 (fontified t) 5565 5570 (fontified t face font-lock-keyword-face) 5570 5588 (fontified t) 5588 5594 (fontified t face font-lock-keyword-face) 5594 5731 (fontified t) 5731 5739 (fontified t face font-lock-builtin-face) 5739 5799 (fontified t) 5799 5801 (fontified t face font-lock-keyword-face) 5801 5926 (fontified t) 5926 5931 (fontified t face font-lock-warning-face) 5931 5932 (fontified t) 5932 5962 (fontified t face font-lock-string-face) 5962 6169 (fontified t) 6169 6173 (fontified t face font-lock-keyword-face) 6173 6191 (fontified t) 6191 6200 (fontified t face font-lock-builtin-face) 6200 6242 (fontified t) 6242 6247 (fontified t face font-lock-builtin-face) 6247 6289 (fontified t) 6289 6298 (fontified t face font-lock-builtin-face) 6298 6344 (fontified t) 6344 6349 (fontified t face font-lock-builtin-face) 6349 6351 (fontified t) 6351 6362 (fontified t face font-lock-string-face) 6362 6408 (fontified t) 6408 6413 (fontified t face font-lock-builtin-face) 6413 6483 (fontified t) 6483 6491 (fontified t face font-lock-builtin-face) 6491 6515 (fontified t) 6515 6529 (fontified t face font-lock-keyword-face) 6529 6570 (fontified t) 6570 6596 (fontified t face font-lock-keyword-face) 6596 6678 (fontified t) 6678 6683 (fontified t face font-lock-builtin-face) 6683 6689 (fontified t) 6689 6697 (fontified t face font-lock-builtin-face) 6697 6763 (fontified t) 6763 6772 (fontified t face font-lock-builtin-face) 6772 6802 (fontified t) 6802 6815 (fontified t face font-lock-keyword-face) 6815 6834 (fontified t) 6834 6864 (fontified t face font-lock-string-face) 6864 7035 (fontified t) 7035 7221 (fontified t face slime-reader-conditional-face) 7221 7223 (fontified t) 7223 7235 (fontified t) 7235 7239 (face font-lock-keyword-face fontified t) 7239 7315 (fontified t) 7315 7316 (fontified t) 7316 7324 (face font-lock-keyword-face fontified t) 7324 7325 (fontified t) 7325 7334 (face font-lock-function-name-face fontified t) 7334 7336 (fontified t) 7336 7345 (face font-lock-type-face fontified t) 7345 7351 (fontified t) 7351 7356 (face font-lock-type-face fontified t) 7356 7366 (fontified t) 7366 7368 (face font-lock-keyword-face fontified t) 7368 7458 (fontified t) 7458 7464 (face font-lock-keyword-face fontified t) 7464 7508 (fontified t) 7508 7514 (face font-lock-keyword-face fontified t) 7514 7537 (fontified t) 7537 7545 (face font-lock-keyword-face fontified t) 7545 7546 (fontified t) 7546 7563 (face font-lock-function-name-face fontified t) 7563 7565 (fontified t) 7565 7574 (face font-lock-type-face fontified t) 7574 7580 (fontified t) 7580 7585 (face font-lock-type-face fontified t) 7585 7596 (fontified t) 7596 7605 (face font-lock-keyword-face fontified t) 7605 7622 (fontified t) 7622 7626 (face font-lock-comment-delimiter-face fontified t) 7626 7702 (face font-lock-comment-face fontified t) 7702 7706 (face font-lock-comment-delimiter-face fontified t) 7706 7739 (face font-lock-comment-face fontified t) 7739 7743 (face font-lock-comment-delimiter-face fontified t) 7743 7819 (face font-lock-comment-face fontified t) 7819 7820 (fontified t) 7820 7823 (face font-lock-comment-delimiter-face fontified t) 7823 7902 (face font-lock-comment-face fontified t) 7902 7903 (fontified t) 7903 7919 (face font-lock-keyword-face fontified t) 7919 7920 (fontified t) 7920 7935 (face font-lock-function-name-face fontified t) 7935 7937 (fontified t) 7937 7942 (face font-lock-warning-face fontified t) 7942 7956 (fontified t) 7956 7964 (face font-lock-builtin-face fontified t) 7964 7965 (fontified t) 7965 7973 (face font-lock-builtin-face fontified t) 7973 7974 (fontified t) 7974 7981 (face font-lock-builtin-face fontified t) 7981 8005 (fontified t) 8005 8019 (face font-lock-builtin-face fontified t) 8019 8020 (fontified t) 8020 8123 (face font-lock-doc-face fontified t) 8123 8127 (fontified t) 8127 8128 (fontified t) 8128 8133 (fontified t face font-lock-keyword-face) 8133 8134 (fontified t) 8134 8152 (fontified t face font-lock-function-name-face) 8152 8180 (fontified t) 8180 8325 (fontified t face font-lock-doc-face) 8325 8329 (fontified t) 8329 8332 (fontified t face font-lock-keyword-face) 8332 8352 (fontified t) 8352 8356 (fontified t face font-lock-keyword-face) 8356 8363 (fontified t) 8363 8366 (fontified t face font-lock-comment-delimiter-face) 8366 8433 (fontified t face font-lock-comment-face) 8433 8439 (fontified t) 8439 8442 (fontified t face font-lock-comment-delimiter-face) 8442 8465 (fontified t face font-lock-comment-face) 8465 8472 (fontified t) 8472 8484 (fontified t face font-lock-keyword-face) 8484 8496 (fontified t) 8496 8502 (fontified t face font-lock-keyword-face) 8502 8577 (fontified t) 8577 8604 (fontified t face font-lock-keyword-face) 8604 8624 (fontified t) 8624 8627 (fontified t face font-lock-comment-delimiter-face) 8627 8674 (fontified t face font-lock-comment-face) 8674 8691 (fontified t) 8691 8703 (fontified t face font-lock-keyword-face) 8703 8706 (fontified t) 8706 8711 (fontified t face font-lock-warning-face) 8711 8713 (fontified t) 8713 8719 (fontified t face font-lock-keyword-face) 8719 8764 (fontified t) 8764 8767 (fontified t face font-lock-comment-delimiter-face) 8767 8825 (fontified t face font-lock-comment-face) 8825 8865 (fontified t) 8865 8868 (fontified t face font-lock-comment-delimiter-face) 8868 8897 (fontified t face font-lock-comment-face) 8897 8937 (fontified t) 8937 8940 (fontified t face font-lock-comment-delimiter-face) 8940 8990 (fontified t face font-lock-comment-face) 8990 9030 (fontified t) 9030 9033 (fontified t face font-lock-comment-delimiter-face) 9033 9089 (fontified t face font-lock-comment-face) 9089 9130 (fontified t) 9130 9134 (fontified t face font-lock-keyword-face) 9134 9224 (fontified t) 9224 9229 (fontified t face font-lock-warning-face) 9229 9247 (fontified t) 9247 9255 (fontified t face font-lock-builtin-face) 9255 9341 (fontified t) 9341 9344 (fontified t face font-lock-comment-delimiter-face) 9344 9392 (fontified t face font-lock-comment-face) 9392 9432 (fontified t) 9432 9435 (fontified t face font-lock-comment-delimiter-face) 9435 9467 (fontified t face font-lock-comment-face) 9467 9561 (fontified t) 9561 9603 (fontified t face slime-reader-conditional-face) 9603 9615 (fontified t) 9615 9618 (fontified t face font-lock-comment-delimiter-face) 9618 9698 (fontified t face font-lock-comment-face) 9698 9737 (fontified t) 9737 9740 (fontified t face font-lock-comment-delimiter-face) 9740 9803 (fontified t face font-lock-comment-face) 9803 9814 (fontified t) 9814 9819 (fontified t face font-lock-warning-face) 9819 9853 (fontified t) 9853 9856 (fontified t face font-lock-comment-delimiter-face) 9856 9895 (fontified t face font-lock-comment-face) 9895 9904 (fontified t) 9904 9909 (fontified t face font-lock-warning-face) 9909 9924 (fontified t) 9924 9927 (fontified t face font-lock-comment-delimiter-face) 9927 9958 (fontified t face font-lock-comment-face) 9958 9969 (fontified t) 9969 9972 (fontified t face font-lock-keyword-face) 9972 10032 (fontified t) 10032 10034 (fontified t face font-lock-keyword-face) 10034 10133 (fontified t) 10133 10138 (fontified t face font-lock-keyword-face) 10138 10191 (fontified t) 10191 10195 (fontified t face font-lock-keyword-face) 10195 10271 (fontified t) 10271 10274 (fontified t face font-lock-comment-delimiter-face) 10274 10284 (fontified t face font-lock-comment-face) 10284 10317 (fontified t) 10317 10320 (fontified t face font-lock-comment-delimiter-face) 10320 10402 (fontified t face font-lock-comment-face) 10402 10418 (fontified t) 10418 10421 (fontified t face font-lock-comment-delimiter-face) 10421 10433 (fontified t face font-lock-comment-face) 10433 10450 (fontified t) 10450 10455 (face font-lock-warning-face fontified t) 10455 10466 (fontified t) 10466 10468 (fontified t) 10468 10476 (face font-lock-keyword-face fontified t) 10476 10477 (fontified t) 10477 10484 (face font-lock-function-name-face fontified t) 10484 10487 (fontified t) 10487 10491 (face font-lock-type-face fontified t) 10491 10503 (fontified t) 10503 10518 (face font-lock-builtin-face fontified t) 10518 10607 (fontified t) 10607 10612 (face font-lock-type-face fontified t) 10612 10622 (fontified t) 10622 10629 (face font-lock-keyword-face fontified t) 10629 10684 (fontified t) 10684 10690 (face font-lock-keyword-face fontified t) 10690 10724 (fontified t) 10724 10725 (fontified t) 10725 10733 (fontified t face font-lock-keyword-face) 10733 10734 (fontified t) 10734 10756 (fontified t face font-lock-function-name-face) 10756 10763 (fontified t) 10763 10768 (fontified t face font-lock-type-face) 10768 10779 (fontified t) 10779 10782 (fontified t face font-lock-keyword-face) 10782 10801 (fontified t) 10801 10803 (fontified t face font-lock-keyword-face) 10803 10834 (fontified t) 10834 10839 (fontified t face font-lock-keyword-face) 10839 10840 (fontified t) 10840 10852 (fontified t) 10852 10865 (face font-lock-keyword-face fontified t) 10865 10909 (fontified t) 10909 10943 (face font-lock-string-face fontified t) 10943 10991 (fontified t) 10991 10996 (face font-lock-keyword-face fontified t) 10996 11009 (fontified t) 11009 11013 (face font-lock-comment-delimiter-face fontified t) 11013 11089 (face font-lock-comment-face fontified t) 11089 11093 (face font-lock-comment-delimiter-face fontified t) 11093 11113 (face font-lock-comment-face fontified t) 11113 11117 (face font-lock-comment-delimiter-face fontified t) 11117 11193 (face font-lock-comment-face fontified t) 11193 11194 (fontified t) 11194 11199 (face font-lock-keyword-face fontified t) 11199 11200 (fontified t) 11200 11217 (face font-lock-function-name-face fontified t) 11217 11231 (fontified t) 11231 11235 (face font-lock-keyword-face fontified t) 11235 11246 (fontified t) 11246 11254 (face font-lock-builtin-face fontified t) 11254 11260 (fontified t) 11260 11263 (face font-lock-builtin-face fontified t) 11263 11267 (fontified t) 11267 11273 (face font-lock-builtin-face fontified t) 11273 11274 (fontified t) 11274 11281 (face font-lock-builtin-face fontified t) 11281 11283 (fontified t) 11283 11287 (face font-lock-builtin-face fontified t) 11287 11290 (fontified t) 11290 11298 (face font-lock-builtin-face fontified t) 11298 11299 (fontified t) 11299 11307 (face font-lock-builtin-face fontified t) 11307 11310 (fontified t) 11310 11320 (face font-lock-builtin-face fontified t) 11320 11321 (fontified t) 11321 11325 (face font-lock-builtin-face fontified t) 11325 11328 (fontified t) 11328 11340 (face font-lock-builtin-face fontified t) 11340 11341 (fontified t) 11341 11346 (face font-lock-builtin-face fontified t) 11346 11351 (fontified t) 11351 11354 (face font-lock-builtin-face fontified t) 11354 11358 (fontified t) 11358 11360 (fontified t) 11360 11365 (face font-lock-keyword-face fontified t) 11365 11366 (fontified t) 11366 11379 (face font-lock-function-name-face fontified t) 11379 11390 (fontified t) 11390 11392 (face font-lock-keyword-face fontified t) 11392 11462 (fontified t) 11462 11467 (face font-lock-keyword-face fontified t) 11467 11468 (fontified t) 11468 11475 (face font-lock-function-name-face fontified t) 11475 11560 (fontified t) 11560 11565 (face font-lock-keyword-face fontified t) 11565 11566 (fontified t) 11566 11577 (face font-lock-function-name-face fontified t) 11577 11663 (fontified t) 11663 11667 (face font-lock-comment-delimiter-face fontified t) 11667 11743 (face font-lock-comment-face fontified t) 11743 11747 (face font-lock-comment-delimiter-face fontified t) 11747 11762 (face font-lock-comment-face fontified t) 11762 11766 (face font-lock-comment-delimiter-face fontified t) 11766 11842 (face font-lock-comment-face fontified t) 11842 11843 (fontified t) 11843 11848 (fontified t face font-lock-keyword-face) 11848 11849 (fontified t) 11849 11856 (fontified t face font-lock-function-name-face) 11856 11862 (fontified t) 11862 11867 (fontified t face font-lock-type-face) 11867 11879 (fontified t) 11879 11883 (fontified t face font-lock-keyword-face) 11883 11940 (fontified t) 11940 11942 (fontified t face font-lock-keyword-face) 11942 11996 (fontified t) 11996 11998 (fontified t face font-lock-keyword-face) 11998 12063 (fontified t) 12063 12074 (fontified t face font-lock-builtin-face) 12074 12162 (fontified t) 12162 12174 (fontified t face font-lock-keyword-face) 12174 12184 (fontified t) 12184 12206 (fontified t face font-lock-keyword-face) 12206 12231 (fontified t) 12231 12235 (fontified t face font-lock-keyword-face) 12235 12285 (fontified t) 12285 12292 (fontified t face font-lock-builtin-face) 12292 12293 (fontified t) 12293 12300 (fontified t face font-lock-builtin-face) 12300 12303 (fontified t) 12303 12551 (fontified t) 12551 12555 (face font-lock-keyword-face fontified t) 12555 12677 (fontified t) 12677 12684 (face font-lock-builtin-face fontified t) 12684 12690 (fontified t) 12690 12695 (face font-lock-builtin-face fontified t) 12695 12803 (fontified t) 12803 12804 (fontified t) 12804 12809 (fontified t face font-lock-keyword-face) 12809 12810 (fontified t) 12810 12818 (fontified t face font-lock-function-name-face) 12818 12824 (fontified t) 12824 12829 (fontified t face font-lock-type-face) 12829 12841 (fontified t) 12841 12845 (fontified t face font-lock-keyword-face) 12845 12902 (fontified t) 12902 12904 (fontified t face font-lock-keyword-face) 12904 12958 (fontified t) 12958 12960 (fontified t face font-lock-keyword-face) 12960 13025 (fontified t) 13025 13036 (fontified t face font-lock-builtin-face) 13036 13124 (fontified t) 13124 13136 (fontified t face font-lock-keyword-face) 13136 13146 (fontified t) 13146 13168 (fontified t face font-lock-keyword-face) 13168 13193 (fontified t) 13193 13197 (fontified t face font-lock-keyword-face) 13197 13227 (fontified t) 13227 13234 (fontified t face font-lock-builtin-face) 13234 13235 (fontified t) 13235 13241 (fontified t face font-lock-builtin-face) 13241 13445 (fontified t) 13445 13447 (fontified t face font-lock-keyword-face) 13447 13471 (fontified t) 13471 13475 (fontified t face font-lock-keyword-face) 13475 13597 (fontified t) 13597 13604 (fontified t face font-lock-builtin-face) 13604 13610 (fontified t) 13610 13615 (fontified t face font-lock-builtin-face) 13615 13617 (fontified t) 13617 13619 (fontified t face font-lock-keyword-face) 13619 13631 (fontified t) 13631 13698 (fontified t) 13698 13699 (fontified t) 13699 13704 (fontified t face font-lock-keyword-face) 13704 13705 (fontified t) 13705 13709 (fontified t face font-lock-function-name-face) 13709 13715 (fontified t) 13715 13720 (fontified t face font-lock-type-face) 13720 13741 (fontified t) 13741 13759 (fontified t face font-lock-string-face) 13759 13768 (fontified t) 13768 13772 (fontified t face font-lock-keyword-face) 13772 13794 (fontified t) 13794 13800 (fontified t face font-lock-keyword-face) 13800 13840 (fontified t) 13840 13845 (fontified t face font-lock-builtin-face) 13845 13846 (fontified t) 13846 13854 (fontified t face font-lock-builtin-face) 13854 13856 (fontified t) 13856 13861 (fontified t face font-lock-builtin-face) 13861 13896 (fontified t) 13896 13898 (fontified t face font-lock-keyword-face) 13898 13952 (fontified t) 13952 13954 (fontified t face font-lock-keyword-face) 13954 14019 (fontified t) 14019 14030 (fontified t face font-lock-builtin-face) 14030 14128 (fontified t) 14128 14147 (fontified t face font-lock-string-face) 14147 14159 (fontified t) 14159 14171 (fontified t face font-lock-keyword-face) 14171 14181 (fontified t) 14181 14203 (fontified t face font-lock-keyword-face) 14203 14228 (fontified t) 14228 14232 (fontified t face font-lock-keyword-face) 14232 14304 (fontified t) 14304 14315 (fontified t face font-lock-string-face) 14315 14368 (fontified t) 14368 14370 (fontified t face font-lock-keyword-face) 14370 14402 (fontified t) 14402 14406 (fontified t face font-lock-keyword-face) 14406 14436 (fontified t) 14436 14443 (fontified t face font-lock-builtin-face) 14443 14444 (fontified t) 14444 14450 (fontified t face font-lock-builtin-face) 14450 14453 (fontified t) 14453 14499 (fontified t) 14499 14533 (fontified t) 14533 14535 (face font-lock-keyword-face fontified t) 14535 14572 (fontified t) 14572 14576 (face font-lock-keyword-face fontified t) 14576 14605 (fontified t) 14605 14612 (face font-lock-builtin-face fontified t) 14612 14613 (fontified t) 14613 14618 (face font-lock-builtin-face fontified t) 14618 14732 (fontified t) 14732 14735 (face font-lock-keyword-face fontified t) 14735 14915 (fontified t) 14915 14919 (face font-lock-keyword-face fontified t) 14919 15043 (fontified t) 15043 15050 (face font-lock-builtin-face fontified t) 15050 15056 (fontified t) 15056 15065 (face font-lock-builtin-face fontified t) 15065 15120 (fontified t) 15120 15123 (face font-lock-comment-delimiter-face fontified t) 15123 15229 (face font-lock-comment-face fontified t) 15229 15276 (fontified t) 15276 15281 (face font-lock-warning-face fontified t) 15281 15335 (fontified t) 15335 15336 (fontified t) 15336 15344 (face font-lock-keyword-face fontified t) 15344 15345 (fontified t) 15345 15358 (face font-lock-function-name-face fontified t) 15358 15361 (fontified t) 15361 15370 (face font-lock-type-face fontified t) 15370 15377 (fontified t) 15377 15382 (face font-lock-type-face fontified t) 15382 15393 (fontified t) 15393 15416 (face font-lock-keyword-face fontified t) 15416 15448 (fontified t) 15448 15455 (face font-lock-string-face fontified t) 15455 15457 (fontified t) 15457 15463 (fontified t) 15463 15477 (face font-lock-keyword-face fontified t) 15477 15479 (fontified t) 15479 15484 (face font-lock-keyword-face fontified t) 15484 15494 (fontified t) 15494 15507 (face font-lock-keyword-face fontified t) 15507 15528 (fontified t) 15528 15538 (face font-lock-string-face fontified t) 15538 15542 (fontified t) 15542 15543 (fontified t rear-nonsticky t) 15543 15544 (fontified t)) . 1) (undo-tree-id241 . -15544) (undo-tree-id242 . -14499) (undo-tree-id243 . -15543) (undo-tree-id245 . -14217) (undo-tree-id247 . -15214) (undo-tree-id249 . -15214) (undo-tree-id251 . -9823) (undo-tree-id253 . -9821) (undo-tree-id255 . -7920) (undo-tree-id257 . -9726) (undo-tree-id258 . -9726) (undo-tree-id260 . -15543) (undo-tree-id262 . -15543) (undo-tree-id264 . -15544) (t 26976 53585 0 0)) ((1 . 15545)) (26976 54626 869848 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10837 . 10838) (nil fontified nil 8128 . 10838) (8128 . 10838)) nil (26976 55076 362906 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7360 . 7361) (nil fontified nil 1 . 7361) (1 . 7361)) ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  (:import-from :postmodern :connect-toplevel :disconnect-toplevel)
  (:import-from :lumen.data.config :db-config)
  (:import-from :lumen.data.prepare :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  (:import-from :cl-postgres :database-error) ;; La classe d'erreur correcte
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; CONFIG & POOL (Inchangé - Copiez-collez votre version habituelle ici)
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta) (bt:with-lock-held (*pool-lock*) (incf (symbol-value var) delta)))
(defun %pool-snapshot () (bt:with-lock-held (*pool-lock*) (values *pool-inflight* *pool-waiters*)))
(defun %ensure-pool-sema! (cfg)
  (let* ((sz (or (getf cfg :pool-size) 10)))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz)) *pool-size* (max 1 sz)))))

(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

(defun start! (&key (config (lumen.data.config:db-config)))
  (setf *current-config* config *connection-mode* :toplevel)
  #+postmodern
  (let ((db (getf config :database)) (user (getf config :user)) (pass (getf config :password))
        (host (or (getf config :host) \"localhost\")) (port (or (getf config :port) 5432)))
    (postmodern:disconnect-toplevel)
    (postmodern:connect-toplevel db user pass host :port port))
  (setf *started* t))

(defun stop! () #+postmodern (postmodern:disconnect-toplevel) (setf *started* nil))

(defun call-with-conn (thunk &key (cfg nil))
  (declare (ignore cfg))
  (funcall thunk))

(defmacro with-conn (&optional opts &body body) `(call-with-conn (lambda () ,@body)))
(defmacro ensure-connection (&optional opts &body body) `(with-conn ,opts ,@body))

;;; ---------------------------------------------------------------------------
;;; CŒUR DU SYSTÈME : TRANSACTION SANS SAUTS (NO JUMPS)
;;; ---------------------------------------------------------------------------

(defun %exec-raw (sql)
  \"Exécute SQL brut pour le contrôle de transaction.\"
  (format t \"~&[DB-KERNEL] RAW: ~A~%\" sql)
  #+postmodern (postmodern:execute sql))

(defun %run-tx-safe (thunk)
  \"Exécute le THUNK dans une transaction.
   NE LANCE JAMAIS D'ERREUR. Retourne une structure (STATUS . DATA).\"
  (let ((committed nil))
    (handler-case
        (progn
          (%exec-raw \"BEGIN\")
          (unwind-protect
               (let ((result (multiple-value-list (funcall thunk))))
                 ;; Succès
                 (%exec-raw \"COMMIT\")
                 (setf committed t)
                 (cons :success result))
            
            ;; Nettoyage (Rollback) si pas commité
            (unless committed
              (ignore-errors (%exec-raw \"ROLLBACK\")))))
      
      ;; -- INTERCEPTION ET TRANSFORMATION EN DONNÉE --
      
      ;; Cas 1: Erreur Métier
      (lumen.core.error:application-error (c)
        ;; Le rollback a déjà eu lieu via unwind-protect
        (cons :business c))
      
      ;; Cas 2: Erreur DB
      (cl-postgres:database-error (c)
        (cons :db c))
      
      ;; Cas 3: Autres erreurs (bug code Lisp)
      (error (c)
        (cons :fatal c)))))

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Boucle de retry qui analyse le résultat 'safe'.\"
  (ensure-connection
    (let ((attempt 0))
      (loop
        (let* ((outcome (%run-tx-safe thunk)) ;; <-- Appel sécurisé, retourne une liste
               (status  (car outcome))
               (payload (cdr outcome)))
          
          ;; ICI, nous sommes hors de la transaction, hors des handlers.
          ;; La pile est propre. Nous pouvons faire ce que nous voulons.
          
          (ecase status
            (:success
             (return (values-list payload)))
            
            (:business
             ;; On relance l'erreur métier proprement
             (error payload))
            
            (:fatal
             (error payload))
            
            (:db
             (let ((mapped (lumen.data.errors:map-db-error payload)))
               (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (format t \"~&[DB-KERNEL] Retry DB Error...~%\")
                     (incf attempt)
                     (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; Loop continue
                   
                   ;; Sinon erreur fatale
                   (error (or mapped payload)))))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))

(defmacro with-statement-timeout ((ms) &body body) `(progn ,@body))

;;; ---------------------------------------------------------------------------
;;; EXECUTION DES REQUÊTES (Fix returning)
;;; ---------------------------------------------------------------------------

(defun exec (sql &rest params)
  (format t \"~&[EXEC] SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params)))

    (let* ((lower (string-downcase sql))
           (has-returning (search \"returning\" lower)))
      
      (if has-returning
          ;; RETURNING -> ALIST
          (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist)))
            (let ((row (apply fn args)))
              (values (if row 1 0) row)))
          
          ;; PAS DE RETURNING -> COUNT
          (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :none)))
            (let ((count (apply fn args)))
              (values count nil)))))))

(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params)))
    (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alists)))
      (let ((rows (apply fn args)))
        (values rows (length rows))))))
  
(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params)))
    (let ((fn (lumen.data.prepare:get-prepared-plan sql :format :alist)))
      (apply fn args))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (%exec-raw \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (%exec-raw \"ROLLBACK\")))))" 0 1 (fontified nil) 1 11 (face font-lock-keyword-face fontified nil) 11 12 (fontified nil) 12 15 (face font-lock-builtin-face fontified nil) 15 19 (fontified nil) 19 29 (face font-lock-keyword-face fontified nil) 29 30 (fontified nil) 30 44 (face font-lock-type-face fontified nil) 44 48 (fontified nil) 48 52 (face font-lock-builtin-face fontified nil) 52 53 (fontified nil) 53 56 (face font-lock-builtin-face fontified nil) 56 61 (fontified nil) 61 73 (face font-lock-builtin-face fontified nil) 73 74 (fontified nil) 74 85 (face font-lock-builtin-face fontified nil) 85 86 (fontified nil) 86 103 (face font-lock-builtin-face fontified nil) 103 104 (fontified nil) 104 124 (face font-lock-builtin-face fontified nil) 124 129 (fontified nil) 129 141 (face font-lock-builtin-face fontified nil) 141 142 (fontified nil) 142 160 (face font-lock-builtin-face fontified nil) 160 161 (fontified nil) 161 171 (face font-lock-builtin-face fontified nil) 171 176 (fontified nil) 176 188 (face font-lock-builtin-face fontified nil) 188 189 (fontified nil) 189 208 (face font-lock-builtin-face fontified nil) 208 209 (fontified nil) 209 227 (face font-lock-builtin-face fontified nil) 227 228 (fontified nil) 228 248 (face font-lock-builtin-face fontified nil) 248 249 (fontified nil) 249 272 (face font-lock-builtin-face fontified nil) 272 277 (fontified nil) 277 289 (face font-lock-builtin-face fontified nil) 289 290 (fontified nil) 290 308 (face font-lock-builtin-face fontified nil) 308 309 (fontified nil) 309 328 (face font-lock-builtin-face fontified nil) 328 329 (fontified nil) 329 342 (face font-lock-builtin-face fontified nil) 342 343 (fontified nil) 343 364 (face font-lock-builtin-face fontified nil) 364 369 (fontified nil) 369 381 (face font-lock-builtin-face fontified nil) 381 382 (fontified nil) 382 401 (face font-lock-builtin-face fontified nil) 401 402 (fontified nil) 402 423 (face font-lock-builtin-face fontified nil) 423 424 (fontified nil) 424 442 (face font-lock-builtin-face fontified nil) 442 447 (fontified nil) 447 459 (face font-lock-builtin-face fontified nil) 459 460 (fontified nil) 460 472 (face font-lock-builtin-face fontified nil) 472 473 (fontified nil) 473 488 (face font-lock-builtin-face fontified nil) 488 490 (fontified nil) 490 493 (face font-lock-comment-delimiter-face fontified nil) 493 521 (face font-lock-comment-face fontified nil) 521 524 (fontified nil) 524 531 (face font-lock-builtin-face fontified nil) 531 532 (fontified nil) 532 539 (face font-lock-builtin-face fontified nil) 539 540 (fontified nil) 540 546 (face font-lock-builtin-face fontified nil) 546 547 (fontified nil) 547 555 (face font-lock-builtin-face fontified nil) 555 567 (fontified nil) 567 575 (face font-lock-builtin-face fontified nil) 575 576 (fontified nil) 576 585 (face font-lock-builtin-face fontified nil) 585 586 (fontified nil) 586 591 (face font-lock-builtin-face fontified nil) 591 603 (fontified nil) 603 613 (face font-lock-builtin-face fontified nil) 613 614 (fontified nil) 614 632 (face font-lock-builtin-face fontified nil) 632 633 (fontified nil) 633 647 (face font-lock-builtin-face fontified nil) 647 659 (fontified nil) 659 677 (face font-lock-builtin-face fontified nil) 677 678 (fontified nil) 678 701 (face font-lock-builtin-face fontified nil) 701 713 (fontified nil) 713 744 (face font-lock-builtin-face fontified nil) 744 745 (fontified nil) 745 761 (face font-lock-builtin-face fontified nil) 761 766 (fontified nil) 766 776 (face font-lock-keyword-face fontified nil) 776 777 (fontified nil) 777 791 (face font-lock-builtin-face fontified nil) 791 794 (fontified nil) 794 799 (face font-lock-comment-delimiter-face fontified nil) 799 874 (face font-lock-comment-face fontified nil) 874 879 (face font-lock-comment-delimiter-face fontified nil) 879 949 (face font-lock-comment-face fontified nil) 949 954 (face font-lock-comment-delimiter-face fontified nil) 954 1029 (face font-lock-comment-face fontified nil) 1029 1030 (fontified nil) 1030 1036 (face font-lock-keyword-face fontified nil) 1036 1037 (fontified nil) 1037 1048 (face font-lock-variable-name-face fontified nil) 1048 1063 (fontified nil) 1063 1078 (face font-lock-string-face fontified nil) 1078 1082 (fontified nil) 1082 1088 (face font-lock-keyword-face fontified nil) 1088 1089 (fontified nil) 1089 1104 (face font-lock-variable-name-face fontified nil) 1104 1109 (fontified nil) 1109 1115 (face font-lock-keyword-face fontified nil) 1115 1116 (fontified nil) 1116 1130 (face font-lock-variable-name-face fontified nil) 1130 1135 (fontified nil) 1135 1141 (face font-lock-keyword-face fontified nil) 1141 1142 (fontified nil) 1142 1153 (face font-lock-variable-name-face fontified nil) 1153 1160 (fontified nil) 1160 1166 (face font-lock-keyword-face fontified nil) 1166 1167 (fontified nil) 1167 1178 (face font-lock-variable-name-face fontified nil) 1178 1183 (fontified nil) 1183 1189 (face font-lock-keyword-face fontified nil) 1189 1190 (fontified nil) 1190 1204 (face font-lock-variable-name-face fontified nil) 1204 1213 (fontified nil) 1213 1218 (face font-lock-keyword-face fontified nil) 1218 1219 (fontified nil) 1219 1230 (face font-lock-function-name-face fontified nil) 1230 1244 (fontified nil) 1244 1261 (face font-lock-keyword-face fontified nil) 1261 1311 (fontified nil) 1311 1316 (face font-lock-keyword-face fontified nil) 1316 1317 (fontified nil) 1317 1331 (face font-lock-function-name-face fontified nil) 1331 1336 (fontified nil) 1336 1353 (face font-lock-keyword-face fontified nil) 1353 1411 (fontified nil) 1411 1416 (face font-lock-keyword-face fontified nil) 1416 1417 (fontified nil) 1417 1435 (face font-lock-function-name-face fontified nil) 1435 1445 (fontified nil) 1445 1449 (face font-lock-keyword-face fontified nil) 1449 1469 (fontified nil) 1469 1479 (face font-lock-builtin-face fontified nil) 1479 1492 (fontified nil) 1492 1496 (face font-lock-keyword-face fontified nil) 1496 1500 (fontified nil) 1500 1551 (fontified nil) 1551 5861 (fontified nil) 5861 5862 (fontified nil) 5862 5867 (fontified nil face font-lock-keyword-face) 5867 5868 (fontified nil) 5868 5872 (fontified nil face font-lock-function-name-face) 5872 5878 (fontified nil) 5878 5883 (fontified nil face font-lock-type-face) 5883 5904 (fontified nil) 5904 5924 (fontified nil face font-lock-string-face) 5924 5933 (fontified nil) 5933 5937 (fontified nil face font-lock-keyword-face) 5937 5959 (fontified nil) 5959 5965 (fontified nil face font-lock-keyword-face) 5965 6005 (fontified nil) 6005 6010 (fontified nil face font-lock-builtin-face) 6010 6011 (fontified nil) 6011 6019 (fontified nil face font-lock-builtin-face) 6019 6021 (fontified nil) 6021 6026 (fontified nil face font-lock-builtin-face) 6026 6061 (fontified nil) 6061 6063 (fontified nil face font-lock-keyword-face) 6063 6108 (fontified nil) 6108 6112 (fontified nil face font-lock-keyword-face) 6112 6178 (fontified nil) 6178 6189 (fontified nil face font-lock-string-face) 6189 6213 (fontified nil) 6213 6215 (fontified nil face font-lock-keyword-face) 6215 6240 (fontified nil) 6240 6243 (fontified nil face font-lock-comment-delimiter-face) 6243 6262 (fontified nil face font-lock-comment-face) 6262 6273 (fontified nil) 6273 6276 (fontified nil face font-lock-keyword-face) 6276 6324 (fontified nil) 6324 6331 (fontified nil face font-lock-builtin-face) 6331 6332 (fontified nil) 6332 6338 (fontified nil face font-lock-builtin-face) 6338 6355 (fontified nil) 6355 6358 (fontified nil face font-lock-keyword-face) 6358 6406 (fontified nil) 6406 6408 (fontified nil face font-lock-keyword-face) 6408 6446 (fontified nil) 6446 6449 (fontified nil face font-lock-comment-delimiter-face) 6449 6475 (fontified nil face font-lock-comment-face) 6475 6486 (fontified nil) 6486 6489 (fontified nil face font-lock-keyword-face) 6489 6537 (fontified nil) 6537 6544 (fontified nil face font-lock-builtin-face) 6544 6545 (fontified nil) 6545 6550 (fontified nil face font-lock-builtin-face) 6550 6567 (fontified nil) 6567 6570 (fontified nil face font-lock-keyword-face) 6570 6597 (fontified nil) 6597 6636 (fontified nil) 6636 6638 (fontified nil) 6638 6643 (face font-lock-keyword-face fontified nil) 6643 6644 (fontified nil) 6644 6651 (face font-lock-function-name-face fontified nil) 6651 6657 (fontified nil) 6657 6662 (face font-lock-type-face fontified nil) 6662 6674 (fontified nil) 6674 6678 (face font-lock-keyword-face fontified nil) 6678 6735 (fontified nil) 6735 6737 (face font-lock-keyword-face fontified nil) 6737 6781 (fontified nil) 6781 6784 (face font-lock-keyword-face fontified nil) 6784 6832 (fontified nil) 6832 6839 (face font-lock-builtin-face fontified nil) 6839 6840 (fontified nil) 6840 6847 (face font-lock-builtin-face fontified nil) 6847 6858 (fontified nil) 6858 6861 (face font-lock-keyword-face fontified nil) 6861 6931 (fontified nil) 6931 6936 (face font-lock-keyword-face fontified nil) 6936 6937 (fontified nil) 6937 6945 (face font-lock-function-name-face fontified nil) 6945 6951 (fontified nil) 6951 6956 (face font-lock-type-face fontified nil) 6956 6968 (fontified nil) 6968 6972 (face font-lock-keyword-face fontified nil) 6972 7029 (fontified nil) 7029 7031 (face font-lock-keyword-face fontified nil) 7031 7075 (fontified nil) 7075 7078 (face font-lock-keyword-face fontified nil) 7078 7126 (fontified nil) 7126 7133 (face font-lock-builtin-face fontified nil) 7133 7134 (fontified nil) 7134 7140 (face font-lock-builtin-face fontified nil) 7140 7170 (fontified nil) 7170 7171 (fontified nil) 7171 7179 (face font-lock-keyword-face fontified nil) 7179 7180 (fontified nil) 7180 7193 (face font-lock-function-name-face fontified nil) 7193 7196 (fontified nil) 7196 7205 (face font-lock-type-face fontified nil) 7205 7212 (fontified nil) 7212 7217 (face font-lock-type-face fontified nil) 7217 7228 (fontified nil) 7228 7251 (face font-lock-keyword-face fontified nil) 7251 7274 (fontified nil) 7274 7281 (face font-lock-string-face fontified nil) 7281 7283 (fontified nil) 7283 7289 (fontified nil) 7289 7303 (face font-lock-keyword-face fontified nil) 7303 7305 (fontified nil) 7305 7310 (face font-lock-keyword-face fontified nil) 7310 7320 (fontified nil) 7320 7333 (face font-lock-keyword-face fontified nil) 7333 7345 (fontified nil) 7345 7355 (face font-lock-string-face fontified nil) 7355 7359 (fontified nil) 7359 7360 (fontified nil rear-nonsticky nil)) . 1) (undo-tree-id265 . -6597) (undo-tree-id266 . -7360) (undo-tree-id267 . -7360) (undo-tree-id268 . -7360) (undo-tree-id269 . -6597) (undo-tree-id270 . -6597) (undo-tree-id271 . -7360) (undo-tree-id272 . -7360) (undo-tree-id273 . -7360) (undo-tree-id274 . -6597) (undo-tree-id275 . -7360) (undo-tree-id276 . -7360) (undo-tree-id277 . -7283) (undo-tree-id278 . -7360) (undo-tree-id279 . -7170) (undo-tree-id280 . -7283) (undo-tree-id281 . -7360) (undo-tree-id282 . -7360) (undo-tree-id283 . -7360) (nil fontified t 7282 . 7284) (nil fontified t 7275 . 7282) (nil fontified t 7252 . 7275) (nil fontified t 7229 . 7252) (nil fontified t 7218 . 7229) (nil fontified t 7213 . 7218) (nil fontified t 7206 . 7213) (nil fontified t 7197 . 7206) (nil fontified t 7194 . 7197) (nil fontified t 7181 . 7194) (nil fontified t 7180 . 7181) (nil fontified t 7172 . 7180) (nil fontified t 7171 . 7172) (nil fontified t 7141 . 7171) (nil fontified t 7135 . 7141) (nil fontified t 7134 . 7135) (nil fontified t 7127 . 7134) (nil fontified t 7079 . 7127) (nil fontified t 7076 . 7079) (nil fontified t 7032 . 7076) (nil fontified t 7030 . 7032) (nil fontified t 6973 . 7030) (nil fontified t 6969 . 6973) (nil fontified t 6957 . 6969) (nil fontified t 6952 . 6957) (nil fontified t 6946 . 6952) (nil fontified t 6938 . 6946) (nil fontified t 6937 . 6938) (nil fontified t 6932 . 6937) (nil fontified t 6862 . 6932) (nil fontified t 6859 . 6862) (nil fontified t 6848 . 6859) (nil fontified t 6841 . 6848) (nil fontified t 6840 . 6841) (nil fontified t 6833 . 6840) (nil fontified t 6785 . 6833) (nil fontified t 6782 . 6785) (nil fontified t 6738 . 6782) (nil fontified t 6736 . 6738) (nil fontified t 6679 . 6736) (nil fontified t 6675 . 6679) (nil fontified t 6663 . 6675) (nil fontified t 6658 . 6663) (nil fontified t 6652 . 6658) (nil fontified t 6645 . 6652) (nil fontified t 6644 . 6645) (nil fontified t 6639 . 6644) (nil fontified t 6637 . 6639) (nil fontified t 6598 . 6637) (nil fontified t 6571 . 6598) (nil fontified t 6568 . 6571) (nil fontified t 6551 . 6568) (nil fontified t 6546 . 6551) (nil fontified t 6545 . 6546) (nil fontified t 6538 . 6545) (nil fontified t 6490 . 6538) (nil fontified t 6487 . 6490) (nil fontified t 6476 . 6487) (nil fontified t 6450 . 6476) (nil fontified t 6447 . 6450) (nil fontified t 6409 . 6447) (nil fontified t 6407 . 6409) (nil fontified t 6359 . 6407) (nil fontified t 6356 . 6359) (nil fontified t 6339 . 6356) (nil fontified t 6333 . 6339) (nil fontified t 6332 . 6333) (nil fontified t 6325 . 6332) (nil fontified t 6277 . 6325) (nil fontified t 6274 . 6277) (nil fontified t 6263 . 6274) (nil fontified t 6244 . 6263) (nil fontified t 6241 . 6244) (nil fontified t 6216 . 6241) (nil fontified t 6214 . 6216) (nil fontified t 6190 . 6214) (nil fontified t 6179 . 6190) (nil fontified t 6113 . 6179) (nil fontified t 6109 . 6113) (nil fontified t 6064 . 6109) (nil fontified t 6062 . 6064) (nil fontified t 6027 . 6062) (nil fontified t 6022 . 6027) (nil fontified t 6020 . 6022) (nil fontified t 6012 . 6020) (nil fontified t 6011 . 6012) (nil fontified t 6006 . 6011) (nil fontified t 5966 . 6006) (nil fontified t 5960 . 5966) (nil fontified t 5938 . 5960) (nil fontified t 5934 . 5938) (nil fontified t 5925 . 5934) (nil fontified t 5905 . 5925) (nil fontified t 5884 . 5905) (nil fontified t 5879 . 5884) (nil fontified t 5873 . 5879) (nil fontified t 5869 . 5873) (nil fontified t 5868 . 5869) (nil fontified t 5863 . 5868) (nil fontified t 5862 . 5863) (nil fontified nil 1552 . 5862) (nil fontified t 1501 . 1552) (nil fontified t 1497 . 1501) (nil fontified t 1493 . 1497) (nil fontified t 1480 . 1493) (nil fontified t 1470 . 1480) (nil fontified t 1450 . 1470) (nil fontified t 1446 . 1450) (nil fontified t 1436 . 1446) (nil fontified t 1418 . 1436) (nil fontified t 1417 . 1418) (nil fontified t 1412 . 1417) (nil fontified t 1354 . 1412) (nil fontified t 1337 . 1354) (nil fontified t 1332 . 1337) (nil fontified t 1318 . 1332) (nil fontified t 1317 . 1318) (nil fontified t 1312 . 1317) (nil fontified t 1262 . 1312) (nil fontified t 1245 . 1262) (nil fontified t 1231 . 1245) (nil fontified t 1220 . 1231) (nil fontified t 1219 . 1220) (nil fontified t 1214 . 1219) (nil fontified t 1205 . 1214) (nil fontified t 1191 . 1205) (nil fontified t 1190 . 1191) (nil fontified t 1184 . 1190) (nil fontified t 1179 . 1184) (nil fontified t 1168 . 1179) (nil fontified t 1167 . 1168) (nil fontified t 1161 . 1167) (nil fontified t 1154 . 1161) (nil fontified t 1143 . 1154) (nil fontified t 1142 . 1143) (nil fontified t 1136 . 1142) (nil fontified t 1131 . 1136) (nil fontified t 1117 . 1131) (nil fontified t 1116 . 1117) (nil fontified t 1110 . 1116) (nil fontified t 1105 . 1110) (nil fontified t 1090 . 1105) (nil fontified t 1089 . 1090) (nil fontified t 1083 . 1089) (nil fontified t 1079 . 1083) (nil fontified t 1064 . 1079) (nil fontified t 1049 . 1064) (nil fontified t 1038 . 1049) (nil fontified t 1037 . 1038) (nil fontified t 1031 . 1037) (nil fontified t 1030 . 1031) (nil fontified t 955 . 1030) (nil fontified t 950 . 955) (nil fontified t 880 . 950) (nil fontified t 875 . 880) (nil fontified t 800 . 875) (nil fontified t 795 . 800) (nil fontified t 792 . 795) (nil fontified t 778 . 792) (nil fontified t 777 . 778) (nil fontified t 767 . 777) (nil fontified t 762 . 767) (nil fontified t 746 . 762) (nil fontified t 745 . 746) (nil fontified t 714 . 745) (nil fontified t 702 . 714) (nil fontified t 679 . 702) (nil fontified t 678 . 679) (nil fontified t 660 . 678) (nil fontified t 648 . 660) (nil fontified t 634 . 648) (nil fontified t 633 . 634) (nil fontified t 615 . 633) (nil fontified t 614 . 615) (nil fontified t 604 . 614) (nil fontified t 592 . 604) (nil fontified t 587 . 592) (nil fontified t 586 . 587) (nil fontified t 577 . 586) (nil fontified t 576 . 577) (nil fontified t 568 . 576) (nil fontified t 556 . 568) (nil fontified t 548 . 556) (nil fontified t 547 . 548) (nil fontified t 541 . 547) (nil fontified t 540 . 541) (nil fontified t 533 . 540) (nil fontified t 532 . 533) (nil fontified t 525 . 532) (nil fontified t 522 . 525) (nil fontified t 494 . 522) (nil fontified t 491 . 494) (nil fontified t 489 . 491) (nil fontified t 474 . 489) (nil fontified t 473 . 474) (nil fontified t 461 . 473) (nil fontified t 460 . 461) (nil fontified t 448 . 460) (nil fontified t 443 . 448) (nil fontified t 425 . 443) (nil fontified t 424 . 425) (nil fontified t 403 . 424) (nil fontified t 402 . 403) (nil fontified t 383 . 402) (nil fontified t 382 . 383) (nil fontified t 370 . 382) (nil fontified t 365 . 370) (nil fontified t 344 . 365) (nil fontified t 343 . 344) (nil fontified t 330 . 343) (nil fontified t 329 . 330) (nil fontified t 310 . 329) (nil fontified t 309 . 310) (nil fontified t 291 . 309) (nil fontified t 290 . 291) (nil fontified t 278 . 290) (nil fontified t 273 . 278) (nil fontified t 250 . 273) (nil fontified t 249 . 250) (nil fontified t 229 . 249) (nil fontified t 228 . 229) (nil fontified t 210 . 228) (nil fontified t 209 . 210) (nil fontified t 190 . 209) (nil fontified t 189 . 190) (nil fontified t 177 . 189) (nil fontified t 172 . 177) (nil fontified t 162 . 172) (nil fontified t 161 . 162) (nil fontified t 143 . 161) (nil fontified t 142 . 143) (nil fontified t 130 . 142) (nil fontified t 125 . 130) (nil fontified t 105 . 125) (nil fontified t 104 . 105) (nil fontified t 87 . 104) (nil fontified t 86 . 87) (nil fontified t 75 . 86) (nil fontified t 74 . 75) (nil fontified t 62 . 74) (nil fontified t 57 . 62) (nil fontified t 54 . 57) (nil fontified t 53 . 54) (nil fontified t 49 . 53) (nil fontified t 45 . 49) (nil fontified t 31 . 45) (nil fontified t 30 . 31) (nil fontified t 20 . 30) (nil fontified t 16 . 20) (nil fontified t 13 . 16) (nil fontified t 12 . 13) (nil fontified t 2 . 12) (nil fontified t 1 . 2) (nil rear-nonsticky t 7360 . 7361)) (26976 54625 771424 0) 0 nil])
([nil nil ((15706 . 15708)) nil (26976 55076 362905 0) 0 nil])
([nil nil ((7361 . 7362)) ((#("
" 0 1 (fontified t)) . 7361) (t 26976 54596 0 0)) (26976 54596 426181 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17633 . 17634) (nil fontified nil 15708 . 17634) (15708 . 17634)) nil (26976 55076 362905 0) 0 nil])
nil
([nil nil ((14070 . 14071)) nil (26976 55076 362904 0) 0 nil])
([nil nil ((14071 . 14073)) nil (26976 55076 362903 0) 0 nil])
([nil nil ((15710 . 15712)) nil (26976 55076 362903 0) 0 nil])
([nil nil ((15712 . 15713)) nil (26976 55076 362899 0) 0 nil])
([nil nil ((15713 . 15714) (t 26976 55076 0 0)) nil (26976 55198 240466 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17550 . 17551) (nil fontified nil 15714 . 17551) (15714 . 17551)) nil (26976 55198 240464 0) 0 nil])
([nil nil ((#("
(defun exec (sql &rest params)
  (format t \"~&[DB-EXEC] SQL: ~S | In-Transaction-P: ~A~%\" 
          sql 
          #+postmodern (postmodern:transaction-active-p postmodern:*database*) #-postmodern nil)
  ;; (format t \"~&[DB-EXEC] PARAMS: ~A~%\" params) ;; Décommenter si besoin, peut être verbeux
  
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      
      ;; BYPASS LOGGING
      (lumen.core.error:application-error (c) 
        (format t \"~&[DB-EXEC] Application Error detected during EXEC. Letting it bubble up.~%\")
        (error c))
      
      (condition (c) 
        (format t \"~&[DB-EXEC] Low-level DB Error: ~A~%\" c)
        (translate-db-error c)))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 44 (fontified t) 44 90 (face font-lock-string-face fontified t) 90 186 (fontified t) 186 202 (face slime-reader-conditional-face fontified t) 202 206 (fontified t) 206 209 (face font-lock-comment-delimiter-face fontified t) 209 298 (face font-lock-comment-face fontified t) 298 304 (fontified t) 304 308 (face font-lock-keyword-face fontified t) 308 330 (fontified t) 330 336 (face font-lock-keyword-face fontified t) 336 376 (fontified t) 376 381 (face font-lock-builtin-face fontified t) 381 382 (fontified t) 382 390 (face font-lock-builtin-face fontified t) 390 392 (fontified t) 392 397 (face font-lock-builtin-face fontified t) 397 432 (fontified t) 432 434 (face font-lock-keyword-face fontified t) 434 488 (fontified t) 488 490 (face font-lock-keyword-face fontified t) 490 555 (fontified t) 555 566 (face font-lock-builtin-face fontified t) 566 655 (fontified t) 655 667 (face font-lock-keyword-face fontified t) 667 677 (fontified t) 677 699 (face font-lock-keyword-face fontified t) 699 724 (fontified t) 724 728 (face font-lock-keyword-face fontified t) 728 800 (fontified t) 800 811 (face font-lock-string-face fontified t) 811 864 (fontified t) 864 866 (face font-lock-keyword-face fontified t) 866 898 (fontified t) 898 902 (face font-lock-keyword-face fontified t) 902 932 (fontified t) 932 939 (face font-lock-builtin-face fontified t) 939 940 (fontified t) 940 946 (face font-lock-builtin-face fontified t) 946 1029 (fontified t) 1029 1031 (face font-lock-keyword-face fontified t) 1031 1068 (fontified t) 1068 1072 (face font-lock-keyword-face fontified t) 1072 1101 (fontified t) 1101 1108 (face font-lock-builtin-face fontified t) 1108 1109 (fontified t) 1109 1114 (face font-lock-builtin-face fontified t) 1114 1228 (fontified t) 1228 1231 (face font-lock-keyword-face fontified t) 1231 1395 (fontified t) 1395 1396 (fontified t) 1396 1411 (fontified t) 1411 1415 (face font-lock-keyword-face fontified t) 1415 1499 (fontified t) 1499 1501 (fontified t) 1501 1539 (fontified t) 1539 1546 (face font-lock-builtin-face fontified t) 1546 1552 (fontified t) 1552 1561 (face font-lock-builtin-face fontified t) 1561 1574 (fontified t) 1574 1623 (fontified t) 1623 1626 (face font-lock-comment-delimiter-face fontified t) 1626 1641 (face font-lock-comment-face fontified t) 1641 1706 (fontified t) 1706 1783 (face font-lock-string-face fontified t) 1783 1794 (fontified t) 1794 1799 (face font-lock-warning-face fontified t) 1799 1851 (fontified t) 1851 1889 (face font-lock-string-face fontified t) 1889 1926 (fontified t) 1926 1927 (fontified t rear-nonsticky t)) . -17551) (undo-tree-id286 . -1) (undo-tree-id287 . -1927) (undo-tree-id288 . -649) (undo-tree-id289 . -186) (undo-tree-id290 . -188) (undo-tree-id291 . -1) (undo-tree-id292 . -1574) (undo-tree-id293 . -702) (undo-tree-id294 . -1608) (undo-tree-id295 . -1616) (undo-tree-id296 . -1616) (undo-tree-id297 . -1616) (undo-tree-id298 . -1616) (undo-tree-id299 . -1893) 19478) nil (26976 55198 240461 0) 0 nil])
([nil nil ((10838 . 10840) (t 26976 55198 0 0)) nil (26976 55704 951591 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14318 . 14319) (nil fontified nil 10840 . 14319) (10840 . 14319)) nil (26976 55704 951590 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction Postmodern avec gestion de retry et logs de debug.\"
  (format t \"~&[DB-TX] START Logic. Max retries: ~A~%\" retries)
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      (handler-case
          (return 
            (ensure-connection
              (format t \"~&[DB-TX] Connection ensured.~%\")
              #+postmodern
              (postmodern:with-transaction ()
                (format t \"~&[DB-TX] BEGIN TRANSACTION (Low-level)~%\")
                ;; DEDANS la transaction
                (handler-bind ((error (lambda (c)
                                        (format t \"~&[DB-TX] ! INSIDE TX CAUGHT: ~A (Type: ~A)~%\" c (type-of c))
                                        ;; Check si c'est une erreur métier
                                        (when (typep c 'lumen.core.error:application-error)
                                          (format t \"~&[DB-TX] -> DETECTED APP ERROR. Signaling TUNNEL.~%\")
                                          (error 'tx-tunnel-error :payload c))
                                        ;; Check si c'est une erreur déjà tunnelée (ne devrait pas arriver dans le bind, mais au cas où)
                                        (when (typep c 'tx-tunnel-error)
                                          (format t \"~&[DB-TX] -> SAW TUNNEL ERROR PASSING THROUGH.~%\"))
                                        )))
                  (let ((res (funcall thunk)))
                    (format t \"~&[DB-TX] Thunk success. PRE-COMMIT.~%\")
                    res)))
              #-postmodern
              (funcall thunk)))

        ;; CATCH DU TUNNEL
        (tx-tunnel-error (e)
          (format t \"~&[DB-TX] CATCH TUNNEL (OUTER). Unpacking payload...~%\")
          (error (tx-tunnel-payload e)))

        ;; CATCH GLOBAL / RETRY
        (error (c)
          (format t \"~&[DB-TX] CATCH GENERIC (OUTER): ~A (Type: ~A)~%\" c (type-of c))
          (let ((mapped (lumen.data.errors:map-db-error c)))
            (format t \"~&[DB-TX]   Mapped error: ~A. Retryable? ~A~%\" mapped (lumen.data.errors:retryable-db-error-p mapped))
            
            (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (progn
                  (format t \"~&[DB-TX]   -> RETRYING...~%\")
                  (incf attempt)
                  (when (plusp sleep-ms)
                    (sleep (/ (max 0 sleep-ms) 1000.0)))) 
                
                ;; Sinon on relance
                (progn
                  (format t \"~&[DB-TX]   -> FAILURE. Re-signaling error.~%\")
                  (error c)))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 141 (face font-lock-doc-face fontified t) 141 154 (fontified t) 154 196 (face font-lock-string-face fontified t) 196 209 (fontified t) 209 212 (face font-lock-keyword-face fontified t) 212 232 (fontified t) 232 236 (face font-lock-keyword-face fontified t) 236 253 (fontified t) 253 290 (face font-lock-string-face fontified t) 290 307 (fontified t) 307 319 (face font-lock-keyword-face fontified t) 319 331 (fontified t) 331 337 (face font-lock-keyword-face fontified t) 337 394 (fontified t) 394 427 (face font-lock-string-face fontified t) 427 471 (fontified t) 471 498 (face font-lock-keyword-face fontified t) 498 528 (fontified t) 528 571 (face font-lock-string-face fontified t) 571 589 (fontified t) 589 592 (face font-lock-comment-delimiter-face fontified t) 592 614 (face font-lock-comment-face fontified t) 614 631 (fontified t) 631 643 (face font-lock-keyword-face fontified t) 643 646 (fontified t) 646 651 (face font-lock-warning-face fontified t) 651 653 (fontified t) 653 659 (face font-lock-keyword-face fontified t) 659 714 (fontified t) 714 761 (face font-lock-string-face fontified t) 761 817 (fontified t) 817 820 (face font-lock-comment-delimiter-face fontified t) 820 853 (face font-lock-comment-face fontified t) 853 894 (fontified t) 894 898 (face font-lock-keyword-face fontified t) 898 997 (fontified t) 997 1051 (face font-lock-string-face fontified t) 1051 1096 (fontified t) 1096 1101 (face font-lock-warning-face fontified t) 1101 1119 (fontified t) 1119 1127 (face font-lock-builtin-face fontified t) 1127 1172 (fontified t) 1172 1175 (face font-lock-comment-delimiter-face fontified t) 1175 1269 (face font-lock-comment-face fontified t) 1269 1310 (fontified t) 1310 1314 (face font-lock-keyword-face fontified t) 1314 1394 (fontified t) 1394 1444 (face font-lock-string-face fontified t) 1444 1501 (fontified t) 1501 1510 (fontified t) 1510 1513 (face font-lock-keyword-face fontified t) 1513 1538 (fontified t) 1538 1568 (fontified t) 1568 1608 (face font-lock-string-face fontified t) 1608 1651 (fontified t) 1651 1693 (face slime-reader-conditional-face fontified t) 1693 1705 (fontified t) 1705 1708 (face font-lock-comment-delimiter-face fontified t) 1708 1724 (face font-lock-comment-face fontified t) 1724 1773 (fontified t) 1773 1829 (face font-lock-string-face fontified t) 1829 1842 (fontified t) 1842 1847 (face font-lock-warning-face fontified t) 1847 1881 (fontified t) 1881 1884 (face font-lock-comment-delimiter-face fontified t) 1884 1905 (face font-lock-comment-face fontified t) 1905 1914 (fontified t) 1914 1919 (face font-lock-warning-face fontified t) 1919 1944 (fontified t) 1944 1994 (face font-lock-string-face fontified t) 1994 2021 (fontified t) 2021 2024 (face font-lock-keyword-face fontified t) 2024 2093 (fontified t) 2093 2140 (face font-lock-string-face fontified t) 2140 2223 (fontified t) 2223 2225 (face font-lock-keyword-face fontified t) 2225 2324 (fontified t) 2324 2329 (face font-lock-keyword-face fontified t) 2329 2358 (fontified t) 2358 2388 (face font-lock-string-face fontified t) 2388 2442 (fontified t) 2442 2446 (face font-lock-keyword-face fontified t) 2446 2556 (fontified t) 2556 2559 (face font-lock-comment-delimiter-face fontified t) 2559 2576 (face font-lock-comment-face fontified t) 2576 2593 (fontified t) 2593 2598 (face font-lock-keyword-face fontified t) 2598 2627 (fontified t) 2627 2674 (face font-lock-string-face fontified t) 2674 2676 (fontified t) 2676 2695 (fontified t) 2695 2700 (face font-lock-warning-face fontified t) 2700 2710 (fontified t) 2710 2711 (rear-nonsticky t fontified t) 2711 2712 (fontified t)) . -8127) (undo-tree-id300 . -1) (undo-tree-id301 . -2711) (undo-tree-id302 . -2071) (undo-tree-id303 . -908) (undo-tree-id304 . -2712) (undo-tree-id305 . -1491) (undo-tree-id306 . -1873) (undo-tree-id307 . -1905) (undo-tree-id308 . -1924) (undo-tree-id309 . -2010) (undo-tree-id310 . -2071) (undo-tree-id311 . -2148) (undo-tree-id312 . -2197) (undo-tree-id313 . -2210) (undo-tree-id314 . -2298) (undo-tree-id315 . -2307) (undo-tree-id316 . -2330) (undo-tree-id317 . -2390) (undo-tree-id318 . -2423) (undo-tree-id319 . -2464) (undo-tree-id320 . -2523) (undo-tree-id321 . -2540) (undo-tree-id322 . -2576) (undo-tree-id323 . -2599) (undo-tree-id324 . -2676) (undo-tree-id325 . -2676) (undo-tree-id326 . -2676) (undo-tree-id327 . -2676) (undo-tree-id328 . -2676) (undo-tree-id329 . -2676) (undo-tree-id330 . -2676) (undo-tree-id331 . -2712) (undo-tree-id332 . -2712) 10839) nil (26976 55704 951587 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction Postmodern avec gestion de retry et logs de debug.
   Utilise une structure de bloc explicite pour éviter les SIMPLE-CONTROL-ERROR.\"
  (format t \"~&[DB-TX] START Logic. Max retries: ~A~%\" retries)
  
  ;; 1. On crée un bloc nommé explicite pour le retour de fonction.
  ;; C'est plus sûr que le 'return' implicite du loop.
  (block main-tx-block 
    (let ((attempt 0))
      (loop
        (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
        
        ;; Variables pour stocker le résultat hors du handler-case
        (let ((tx-result nil)
              (tx-success nil))
          
          (handler-case
              (progn
                ;; 2. On exécute la logique. On NE FAIT PAS (return ...) ici.
                ;; On stocke juste le résultat.
                (setf tx-result
                      (ensure-connection
                        (format t \"~&[DB-TX] Connection ensured.~%\")
                        #+postmodern
                        (postmodern:with-transaction ()
                          (format t \"~&[DB-TX] BEGIN TRANSACTION (Low-level)~%\")
                          (handler-bind ((error (lambda (c)
                                                  (format t \"~&[DB-TX] ! INSIDE TX CAUGHT: ~A (Type: ~A)~%\" c (type-of c))
                                                  ;; Tunneling de l'erreur métier
                                                  (when (typep c 'lumen.core.error:application-error)
                                                    (format t \"~&[DB-TX] -> DETECTED APP ERROR. Signaling TUNNEL.~%\")
                                                    (error 'tx-tunnel-error :payload c)))))
                            (let ((res (funcall thunk)))
                              (format t \"~&[DB-TX] Thunk success. PRE-COMMIT.~%\")
                              res)))
                        #-postmodern
                        (funcall thunk)))
                
                ;; Si on arrive ici, aucune erreur n'a été levée.
                (setf tx-success t))

            ;; --- GESTION DES ERREURS ---
            
            ;; Cas 1 : Erreur métier remontée via le tunnel
            (tx-tunnel-error (e)
              (format t \"~&[DB-TX] CATCH TUNNEL (OUTER). Unpacking payload...~%\")
              ;; On relance l'erreur métier. Comme on est hors du with-transaction, 
              ;; Postmodern a déjà fait son rollback proprement.
              (error (tx-tunnel-payload e)))

            ;; Cas 2 : Erreur technique / Retry
            (error (c)
              (format t \"~&[DB-TX] CATCH GENERIC (OUTER): ~A~%\" c)
              (let ((mapped (lumen.data.errors:map-db-error c)))
                (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                    (progn
                      (format t \"~&[DB-TX] -> RETRYING...~%\")
                      (incf attempt)
                      (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0))))
                    (progn
                      (format t \"~&[DB-TX] -> FAILURE. Re-signaling.~%\")
                      (error c))))))
          
          ;; 3. Sortie propre
          ;; On est sorti du handler-case et de la closure ensure-connection.
          ;; Le bloc 'main-tx-block' est lexicalement valide et stable ici.
          (when tx-success
            (return-from main-tx-block tx-result)))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 221 (face font-lock-doc-face fontified t) 221 234 (fontified t) 234 276 (face font-lock-string-face fontified t) 276 291 (fontified t) 291 294 (face font-lock-comment-delimiter-face fontified t) 294 357 (face font-lock-comment-face fontified t) 357 359 (fontified t) 359 362 (face font-lock-comment-delimiter-face fontified t) 362 412 (face font-lock-comment-face fontified t) 412 415 (fontified t) 415 420 (face font-lock-keyword-face fontified t) 420 441 (fontified t) 441 444 (face font-lock-keyword-face fontified t) 444 466 (fontified t) 466 470 (face font-lock-keyword-face fontified t) 470 471 (fontified t) 471 489 (fontified t) 489 526 (face font-lock-string-face fontified t) 526 553 (fontified t) 553 556 (face font-lock-comment-delimiter-face fontified t) 556 612 (face font-lock-comment-face fontified t) 612 621 (fontified t) 621 624 (face font-lock-keyword-face fontified t) 624 696 (fontified t) 696 708 (face font-lock-keyword-face fontified t) 708 724 (fontified t) 724 729 (face font-lock-keyword-face fontified t) 729 746 (fontified t) 746 749 (face font-lock-comment-delimiter-face fontified t) 749 808 (face font-lock-comment-face fontified t) 808 824 (fontified t) 824 827 (face font-lock-comment-delimiter-face fontified t) 827 856 (face font-lock-comment-face fontified t) 856 963 (fontified t) 963 996 (face font-lock-string-face fontified t) 996 1060 (fontified t) 1060 1087 (face font-lock-keyword-face fontified t) 1087 1127 (fontified t) 1127 1170 (face font-lock-string-face fontified t) 1170 1199 (fontified t) 1199 1211 (face font-lock-keyword-face fontified t) 1211 1214 (fontified t) 1214 1219 (face font-lock-warning-face fontified t) 1219 1221 (fontified t) 1221 1227 (face font-lock-keyword-face fontified t) 1227 1292 (fontified t) 1292 1339 (face font-lock-string-face fontified t) 1339 1405 (fontified t) 1405 1408 (face font-lock-comment-delimiter-face fontified t) 1408 1437 (face font-lock-comment-face fontified t) 1437 1488 (fontified t) 1488 1492 (face font-lock-keyword-face fontified t) 1492 1500 (fontified t) 1500 1539 (fontified t) 1539 1601 (fontified t) 1601 1655 (face font-lock-string-face fontified t) 1655 1710 (fontified t) 1710 1715 (face font-lock-warning-face fontified t) 1715 1733 (fontified t) 1733 1741 (face font-lock-builtin-face fontified t) 1741 1778 (fontified t) 1778 1781 (face font-lock-keyword-face fontified t) 1781 1846 (fontified t) 1846 1886 (face font-lock-string-face fontified t) 1886 1949 (fontified t) 1949 1971 (face slime-reader-conditional-face fontified t) 1971 2001 (face slime-reader-conditional-face fontified t) 2001 2004 (fontified t) 2004 2037 (fontified t) 2037 2040 (face font-lock-comment-delimiter-face fontified t) 2040 2087 (face font-lock-comment-face fontified t) 2087 2137 (fontified t) 2137 2140 (face font-lock-comment-delimiter-face fontified t) 2140 2168 (face font-lock-comment-face fontified t) 2168 2193 (fontified t) 2193 2196 (face font-lock-comment-delimiter-face fontified t) 2196 2241 (face font-lock-comment-face fontified t) 2241 2298 (fontified t) 2298 2354 (face font-lock-string-face fontified t) 2354 2370 (fontified t) 2370 2373 (face font-lock-comment-delimiter-face fontified t) 2373 2441 (face font-lock-comment-face fontified t) 2441 2455 (fontified t) 2455 2458 (face font-lock-comment-delimiter-face fontified t) 2458 2506 (face font-lock-comment-face fontified t) 2506 2521 (fontified t) 2521 2526 (face font-lock-warning-face fontified t) 2526 2564 (fontified t) 2564 2567 (face font-lock-comment-delimiter-face fontified t) 2567 2600 (face font-lock-comment-face fontified t) 2600 2613 (fontified t) 2613 2618 (face font-lock-warning-face fontified t) 2618 2647 (fontified t) 2647 2686 (face font-lock-string-face fontified t) 2686 2705 (fontified t) 2705 2708 (face font-lock-keyword-face fontified t) 2708 2772 (fontified t) 2772 2774 (face font-lock-keyword-face fontified t) 2774 2877 (fontified t) 2877 2882 (face font-lock-keyword-face fontified t) 2882 2915 (fontified t) 2915 2943 (face font-lock-string-face fontified t) 2943 3005 (fontified t) 3005 3009 (face font-lock-keyword-face fontified t) 3009 3086 (fontified t) 3086 3091 (face font-lock-keyword-face fontified t) 3091 3124 (fontified t) 3124 3163 (face font-lock-string-face fontified t) 3163 3188 (fontified t) 3188 3193 (face font-lock-warning-face fontified t) 3193 3223 (fontified t) 3223 3226 (face font-lock-comment-delimiter-face fontified t) 3226 3243 (face font-lock-comment-face fontified t) 3243 3253 (fontified t) 3253 3256 (face font-lock-comment-delimiter-face fontified t) 3256 3321 (face font-lock-comment-face fontified t) 3321 3331 (fontified t) 3331 3334 (face font-lock-comment-delimiter-face fontified t) 3334 3397 (face font-lock-comment-face fontified t) 3397 3408 (fontified t) 3408 3412 (face font-lock-keyword-face fontified t) 3412 3437 (fontified t) 3437 3448 (face font-lock-keyword-face fontified t) 3448 3478 (fontified t) 3478 3479 (fontified t rear-nonsticky t) 3479 3480 (fontified t)) . -8128) (undo-tree-id356 . -471) (undo-tree-id357 . -808) (undo-tree-id358 . -808) (undo-tree-id359 . -808) (undo-tree-id360 . -471) (undo-tree-id361 . -808) (undo-tree-id362 . -3480) (undo-tree-id363 . -2241) (undo-tree-id364 . -3178) (undo-tree-id365 . -3480) 11608 (t 26976 55704 0 0)) nil (26976 55930 272266 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11502 . 11503) (nil fontified nil 8128 . 11503) (8128 . 11503)) nil (26976 55930 272260 0) 0 nil])
([nil nil ((11503 . 11504)) nil (26976 55930 272260 0) 0 nil])
([nil nil ((#("(defun exec (sql &rest params)
  ;; CORRECTION : On a retiré l'appel à transaction-active-p qui n'existe pas.
  (format t \"~&[DB-EXEC] SQL: ~S~%\" sql)
  
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
              (lumen.data.metrics:record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      
      ;; BYPASS LOGGING
      (lumen.core.error:application-error (c) 
        (format t \"~&[DB-EXEC] Application Error detected during EXEC. Letting it bubble up.~%\")
        (error c))
      
      (condition (c) 
        (format t \"~&[DB-EXEC] Low-level DB Error: ~A~%\" c)
        (translate-db-error c))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 11 (face font-lock-function-name-face fontified t) 11 17 (fontified t) 17 22 (face font-lock-type-face fontified t) 22 33 (fontified t) 33 36 (face font-lock-comment-delimiter-face fontified t) 36 110 (face font-lock-comment-face fontified t) 110 122 (fontified t) 122 145 (face font-lock-string-face fontified t) 145 157 (fontified t) 157 161 (face font-lock-keyword-face fontified t) 161 183 (fontified t) 183 189 (face font-lock-keyword-face fontified t) 189 229 (fontified t) 229 234 (face font-lock-builtin-face fontified t) 234 235 (fontified t) 235 243 (face font-lock-builtin-face fontified t) 243 245 (fontified t) 245 250 (face font-lock-builtin-face fontified t) 250 285 (fontified t) 285 287 (face font-lock-keyword-face fontified t) 287 341 (fontified t) 341 343 (face font-lock-keyword-face fontified t) 343 408 (fontified t) 408 419 (face font-lock-builtin-face fontified t) 419 508 (fontified t) 508 520 (face font-lock-keyword-face fontified t) 520 530 (fontified t) 530 552 (face font-lock-keyword-face fontified t) 552 577 (fontified t) 577 581 (face font-lock-keyword-face fontified t) 581 653 (fontified t) 653 664 (face font-lock-string-face fontified t) 664 717 (fontified t) 717 719 (face font-lock-keyword-face fontified t) 719 751 (fontified t) 751 755 (face font-lock-keyword-face fontified t) 755 804 (fontified t) 804 811 (face font-lock-builtin-face fontified t) 811 812 (fontified t) 812 818 (face font-lock-builtin-face fontified t) 818 901 (fontified t) 901 903 (face font-lock-keyword-face fontified t) 903 940 (fontified t) 940 944 (face font-lock-keyword-face fontified t) 944 992 (fontified t) 992 999 (face font-lock-builtin-face fontified t) 999 1000 (fontified t) 1000 1005 (face font-lock-builtin-face fontified t) 1005 1119 (fontified t) 1119 1122 (face font-lock-keyword-face fontified t) 1122 1321 (fontified t) 1321 1325 (face font-lock-keyword-face fontified t) 1325 1391 (fontified t) 1391 1449 (fontified t) 1449 1456 (face font-lock-builtin-face fontified t) 1456 1462 (fontified t) 1462 1471 (face font-lock-builtin-face fontified t) 1471 1484 (fontified t) 1484 1500 (fontified t) 1500 1520 (fontified t) 1520 1533 (fontified t) 1533 1536 (face font-lock-comment-delimiter-face fontified t) 1536 1551 (face font-lock-comment-face fontified t) 1551 1616 (fontified t) 1616 1693 (face font-lock-string-face fontified t) 1693 1704 (fontified t) 1704 1709 (face font-lock-warning-face fontified t) 1709 1761 (fontified t) 1761 1799 (face font-lock-string-face fontified t) 1799 1803 (fontified t) 1803 1836 (fontified t)) . -16379) (undo-tree-id334 . -1836) (undo-tree-id335 . -673) (undo-tree-id336 . -1484) (undo-tree-id337 . -31) (undo-tree-id338 . -31) (undo-tree-id339 . -31) (undo-tree-id340 . -31) (undo-tree-id341 . -31) (undo-tree-id342 . -31) (undo-tree-id343 . -31) (undo-tree-id344 . -1413) (undo-tree-id345 . -1413) (undo-tree-id346 . -1413) (undo-tree-id347 . -1413) (undo-tree-id348 . -1413) (undo-tree-id349 . -1413) (undo-tree-id350 . -1694) (undo-tree-id351 . -1803) (undo-tree-id352 . -1836) (undo-tree-id353 . -1836) (undo-tree-id354 . -1836) (undo-tree-id355 . -1836) 18215) nil (26976 55930 272258 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t rear-nonsticky t)) . 16379) (undo-tree-id333 . -1)) nil (26976 55930 272244 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18023 . 18024) (nil fontified nil 16379 . 18024) (16379 . 18024)) nil (26976 55930 272233 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction Postmodern avec gestion de retry.
   Utilise un flux de contrôle sécurisé pour éviter SIMPLE-CONTROL-ERROR.\"
  (format t \"~&[DB-TX] START Logic. Max retries: ~A~%\" retries)
  
  ;; 1. On définit un bloc nommé explicite pour pouvoir en sortir proprement
  (block main-tx-block
    (let ((attempt 0))
      (loop
        (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
        
        ;; 2. Variables pour capturer le succès et le résultat SANS faire de return immédiat
        (let ((tx-result nil)
              (tx-success nil))
          
          (handler-case
              (progn
                ;; Exécution de la logique DB
                (setf tx-result
                      (ensure-connection
                        (format t \"~&[DB-TX] Connection ensured.~%\")
                        #+postmodern
                        (postmodern:with-transaction ()
                          (format t \"~&[DB-TX] BEGIN TRANSACTION (Low-level)~%\")
                          ;; Handler interne pour capturer l'erreur métier AVANT que Postmodern ne la voie
                          (handler-bind ((error (lambda (c)
                                                  (format t \"~&[DB-TX] ! INSIDE TX CAUGHT: ~A (Type: ~A)~%\" c (type-of c))
                                                  (when (typep c 'lumen.core.error:application-error)
                                                    (format t \"~&[DB-TX] -> DETECTED APP ERROR. Signaling TUNNEL.~%\")
                                                    (error 'tx-tunnel-error :payload c)))))
                            (let ((res (funcall thunk)))
                              (format t \"~&[DB-TX] Thunk success. PRE-COMMIT.~%\")
                              res)))
                        #-postmodern
                        (funcall thunk)))
                
                ;; Si on arrive ici, tout s'est bien passé
                (setf tx-success t))

            ;; --- GESTION DES ERREURS ---
            
            ;; Cas A : Erreur métier remontée via le tunnel
            (tx-tunnel-error (e)
              (format t \"~&[DB-TX] CATCH TUNNEL (OUTER). Unpacking payload...~%\")
              ;; On est sorti de la transaction, le rollback est fait.
              ;; On relance l'erreur vers le middleware.
              (error (tx-tunnel-payload e)))

            ;; Cas B : Erreur technique (Retry ou Fail)
            (error (c)
              (format t \"~&[DB-TX] CATCH GENERIC (OUTER): ~A~%\" c)
              (let ((mapped (lumen.data.errors:map-db-error c)))
                (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                    (progn
                      (format t \"~&[DB-TX] -> RETRYING...~%\")
                      (incf attempt)
                      (when (plusp sleep-ms)
                        (sleep (/ (max 0 sleep-ms) 1000.0))))
                    ;; Sinon échec définitif
                    (progn
                      (format t \"~&[DB-TX] -> FAILURE. Re-signaling.~%\")
                      (error c))))))
          
          ;; 3. Sortie propre : On est sorti du handler-case et de la closure.
          ;; Le bloc 'main-tx-block' est stable ici.
          (when tx-success
            (return-from main-tx-block tx-result)))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 197 (face font-lock-doc-face fontified t) 197 210 (fontified t) 210 252 (face font-lock-string-face fontified t) 252 267 (fontified t) 267 270 (face font-lock-comment-delimiter-face fontified t) 270 342 (face font-lock-comment-face fontified t) 342 345 (fontified t) 345 350 (face font-lock-keyword-face fontified t) 350 370 (fontified t) 370 373 (face font-lock-keyword-face fontified t) 373 395 (fontified t) 395 399 (face font-lock-keyword-face fontified t) 399 418 (fontified t) 418 455 (face font-lock-string-face fontified t) 455 482 (fontified t) 482 485 (face font-lock-comment-delimiter-face fontified t) 485 567 (face font-lock-comment-face fontified t) 567 576 (fontified t) 576 579 (face font-lock-keyword-face fontified t) 579 651 (fontified t) 651 663 (face font-lock-keyword-face fontified t) 663 679 (fontified t) 679 684 (face font-lock-keyword-face fontified t) 684 701 (fontified t) 701 704 (face font-lock-comment-delimiter-face fontified t) 704 731 (face font-lock-comment-face fontified t) 731 838 (fontified t) 838 871 (face font-lock-string-face fontified t) 871 935 (fontified t) 935 962 (face font-lock-keyword-face fontified t) 962 1002 (fontified t) 1002 1045 (face font-lock-string-face fontified t) 1045 1073 (fontified t) 1073 1076 (face font-lock-comment-delimiter-face fontified t) 1076 1154 (face font-lock-comment-face fontified t) 1154 1181 (fontified t) 1181 1193 (face font-lock-keyword-face fontified t) 1193 1196 (fontified t) 1196 1201 (face font-lock-warning-face fontified t) 1201 1203 (fontified t) 1203 1209 (face font-lock-keyword-face fontified t) 1209 1274 (fontified t) 1274 1321 (face font-lock-string-face fontified t) 1321 1388 (fontified t) 1388 1392 (face font-lock-keyword-face fontified t) 1392 1500 (fontified t) 1500 1501 (fontified t) 1501 1555 (face font-lock-string-face fontified t) 1555 1557 (fontified t) 1557 1610 (fontified t) 1610 1615 (face font-lock-warning-face fontified t) 1615 1633 (fontified t) 1633 1641 (face font-lock-builtin-face fontified t) 1641 1678 (fontified t) 1678 1681 (face font-lock-keyword-face fontified t) 1681 1746 (fontified t) 1746 1786 (face font-lock-string-face fontified t) 1786 1849 (fontified t) 1849 1901 (face slime-reader-conditional-face fontified t) 1901 1937 (fontified t) 1937 1940 (face font-lock-comment-delimiter-face fontified t) 1940 1980 (face font-lock-comment-face fontified t) 1980 2030 (fontified t) 2030 2033 (face font-lock-comment-delimiter-face fontified t) 2033 2061 (face font-lock-comment-face fontified t) 2061 2086 (fontified t) 2086 2089 (face font-lock-comment-delimiter-face fontified t) 2089 2134 (face font-lock-comment-face fontified t) 2134 2191 (fontified t) 2191 2247 (face font-lock-string-face fontified t) 2247 2263 (fontified t) 2263 2266 (face font-lock-comment-delimiter-face fontified t) 2266 2320 (face font-lock-comment-face fontified t) 2320 2334 (fontified t) 2334 2337 (face font-lock-comment-delimiter-face fontified t) 2337 2377 (face font-lock-comment-face fontified t) 2377 2392 (fontified t) 2392 2397 (face font-lock-warning-face fontified t) 2397 2435 (fontified t) 2435 2438 (face font-lock-comment-delimiter-face fontified t) 2438 2479 (face font-lock-comment-face fontified t) 2479 2492 (fontified t) 2492 2497 (face font-lock-warning-face fontified t) 2497 2526 (fontified t) 2526 2565 (face font-lock-string-face fontified t) 2565 2584 (fontified t) 2584 2587 (face font-lock-keyword-face fontified t) 2587 2651 (fontified t) 2651 2653 (face font-lock-keyword-face fontified t) 2653 2756 (fontified t) 2756 2761 (face font-lock-keyword-face fontified t) 2761 2794 (fontified t) 2794 2822 (face font-lock-string-face fontified t) 2822 2884 (fontified t) 2884 2888 (face font-lock-keyword-face fontified t) 2888 2988 (fontified t) 2988 2991 (face font-lock-comment-delimiter-face fontified t) 2991 3013 (face font-lock-comment-face fontified t) 3013 3034 (fontified t) 3034 3039 (face font-lock-keyword-face fontified t) 3039 3057 (fontified t) 3057 3072 (fontified t) 3072 3111 (face font-lock-string-face fontified t) 3111 3113 (fontified t) 3113 3136 (fontified t) 3136 3141 (face font-lock-warning-face fontified t) 3141 3171 (fontified t) 3171 3174 (face font-lock-comment-delimiter-face fontified t) 3174 3240 (face font-lock-comment-face fontified t) 3240 3250 (fontified t) 3250 3253 (face font-lock-comment-delimiter-face fontified t) 3253 3293 (face font-lock-comment-face fontified t) 3293 3304 (fontified t) 3304 3308 (face font-lock-keyword-face fontified t) 3308 3320 (fontified t) 3320 3333 (fontified t) 3333 3344 (face font-lock-keyword-face fontified t) 3344 3374 (fontified t) 3374 3375 (rear-nonsticky t fontified t) 3375 3376 (fontified t)) . -8128) (undo-tree-id366 . -3315) (undo-tree-id367 . -3376) (undo-tree-id368 . -2479) (undo-tree-id369 . -1842) (undo-tree-id370 . -2519) (undo-tree-id371 . -3376) (undo-tree-id372 . -3376) 11504 (t 26976 55930 0 0)) nil (26976 56114 851219 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11838 . 11839) (nil fontified nil 8128 . 11839) (8128 . 11839)) nil (26976 56114 851206 0) 0 nil])
([nil nil ((11839 . 11840)) nil (26976 56114 851202 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK dans une transaction Postmodern.
   Utilise un pattern 'State Machine' pour garantir que la pile est propre
   avant de signaler une erreur ou de retourner une valeur.\"
  (format t \"~&[DB-TX] START Logic (State-Machine).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      ;; 1. PHASE D'EXÉCUTION
      ;; On capture tout ce qui se passe et on le transforme en un objet 'outcome'
      ;; outcome sera sous la forme (:type valeur)
      (let ((outcome 
             (handler-case
                 ;; Essai nominal
                 (let ((result 
                        (ensure-connection
                          (format t \"~&[DB-TX] Connection ensured.~%\")
                          #+postmodern
                          (postmodern:with-transaction ()
                            (format t \"~&[DB-TX] BEGIN TX.~%\")
                            (handler-bind ((error (lambda (c)
                                                    (format t \"~&[DB-TX] ! Caught inside TX: ~A~%\" c)
                                                    ;; Tunneling immédiat
                                                    (when (typep c 'lumen.core.error:application-error)
                                                      (format t \"~&[DB-TX] -> Tunneling APP ERROR.~%\")
                                                      (error 'tx-tunnel-error :payload c)))))
                              (let ((res (funcall thunk)))
                                (format t \"~&[DB-TX] Success inside TX.~%\")
                                res)))
                          #-postmodern
                          (funcall thunk))))
                   ;; Si on arrive ici, c'est un succès complet
                   (list :success result))
               
               ;; CAS 1 : Sortie via le Tunnel
               (tx-tunnel-error (e)
                 (format t \"~&[DB-TX] Exiting via Tunnel.~%\")
                 (list :tunnel (tx-tunnel-payload e)))
               
               ;; CAS 2 : Erreur technique standard
               (error (c)
                 (format t \"~&[DB-TX] Exiting via Generic Error: ~A~%\" c)
                 (list :retry c)))))
        
        ;; 2. PHASE DE DÉCISION (Stack Clean)
        ;; Nous sommes maintenant sortis de ensure-connection, with-transaction et handler-case.
        ;; La pile est stable. Nous pouvons agir.
        (let ((status (first outcome))
              (payload (second outcome)))
          
          (ecase status
            ;; Succès : on retourne la valeur pour de bon
            (:success
             (format t \"~&[DB-TX] Status: SUCCESS. Returning.~%\")
             (return payload))
            
            ;; Erreur Métier : on la signale proprement au Middleware
            (:tunnel
             (format t \"~&[DB-TX] Status: TUNNEL. Re-signaling payload.~%\")
             (error payload))
            
            ;; Erreur Technique : on gère le retry
            (:retry
             (format t \"~&[DB-TX] Status: RETRY check.~%\")
             (let ((mapped (lumen.data.errors:map-db-error payload)))
               (if (and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (progn
                     (format t \"~&[DB-TX] -> Retrying...~%\")
                     (incf attempt)
                     (when (plusp sleep-ms) 
                       (sleep (/ (max 0 sleep-ms) 1000.0))))
                   ;; Sinon, échec fatal
                   (progn
                     (format t \"~&[DB-TX] -> Fatal Retry. Re-signaling.~%\")
                     (error payload)))))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 236 (face font-lock-doc-face fontified t) 236 249 (fontified t) 249 291 (face font-lock-string-face fontified t) 291 299 (fontified t) 299 302 (face font-lock-keyword-face fontified t) 302 322 (fontified t) 322 326 (face font-lock-keyword-face fontified t) 326 343 (fontified t) 343 380 (face font-lock-string-face fontified t) 380 403 (fontified t) 403 406 (face font-lock-comment-delimiter-face fontified t) 406 427 (face font-lock-comment-face fontified t) 427 433 (fontified t) 433 436 (face font-lock-comment-delimiter-face fontified t) 436 510 (face font-lock-comment-face fontified t) 510 516 (fontified t) 516 519 (face font-lock-comment-delimiter-face fontified t) 519 561 (face font-lock-comment-face fontified t) 561 568 (fontified t) 568 571 (face font-lock-keyword-face fontified t) 571 597 (fontified t) 597 609 (face font-lock-keyword-face fontified t) 609 627 (fontified t) 627 630 (face font-lock-comment-delimiter-face fontified t) 630 644 (face font-lock-comment-face fontified t) 644 662 (fontified t) 662 665 (face font-lock-keyword-face fontified t) 665 755 (fontified t) 755 788 (face font-lock-string-face fontified t) 788 856 (fontified t) 856 883 (face font-lock-keyword-face fontified t) 883 925 (fontified t) 925 948 (face font-lock-string-face fontified t) 948 979 (fontified t) 979 991 (face font-lock-keyword-face fontified t) 991 994 (fontified t) 994 999 (face font-lock-warning-face fontified t) 999 1001 (fontified t) 1001 1007 (face font-lock-keyword-face fontified t) 1007 1074 (fontified t) 1074 1110 (face font-lock-string-face fontified t) 1110 1166 (fontified t) 1166 1169 (face font-lock-comment-delimiter-face fontified t) 1169 1188 (face font-lock-comment-face fontified t) 1188 1241 (fontified t) 1241 1245 (face font-lock-keyword-face fontified t) 1245 1356 (fontified t) 1356 1393 (face font-lock-string-face fontified t) 1393 1450 (fontified t) 1450 1455 (face font-lock-warning-face fontified t) 1455 1473 (fontified t) 1473 1481 (face font-lock-builtin-face fontified t) 1481 1500 (fontified t) 1500 1520 (fontified t) 1520 1523 (face font-lock-keyword-face fontified t) 1523 1548 (fontified t) 1548 1590 (fontified t) 1590 1622 (face font-lock-string-face fontified t) 1622 1689 (fontified t) 1689 1743 (face slime-reader-conditional-face fontified t) 1743 1766 (fontified t) 1766 1769 (face font-lock-comment-delimiter-face fontified t) 1769 1811 (face font-lock-comment-face fontified t) 1811 1836 (fontified t) 1836 1844 (face font-lock-builtin-face fontified t) 1844 1885 (fontified t) 1885 1888 (face font-lock-comment-delimiter-face fontified t) 1888 1917 (face font-lock-comment-face fontified t) 1917 1980 (fontified t) 1980 2013 (face font-lock-string-face fontified t) 2013 2038 (fontified t) 2038 2045 (face font-lock-builtin-face fontified t) 2045 2101 (fontified t) 2101 2104 (face font-lock-comment-delimiter-face fontified t) 2104 2138 (face font-lock-comment-face fontified t) 2138 2154 (fontified t) 2154 2159 (face font-lock-warning-face fontified t) 2159 2191 (fontified t) 2191 2234 (face font-lock-string-face fontified t) 2234 2261 (fontified t) 2261 2267 (face font-lock-builtin-face fontified t) 2267 2292 (fontified t) 2292 2295 (face font-lock-comment-delimiter-face fontified t) 2295 2330 (face font-lock-comment-face fontified t) 2330 2338 (fontified t) 2338 2341 (face font-lock-comment-delimiter-face fontified t) 2341 2427 (face font-lock-comment-face fontified t) 2427 2435 (fontified t) 2435 2438 (face font-lock-comment-delimiter-face fontified t) 2438 2477 (face font-lock-comment-face fontified t) 2477 2486 (fontified t) 2486 2489 (face font-lock-keyword-face fontified t) 2489 2580 (fontified t) 2580 2585 (face font-lock-keyword-face fontified t) 2585 2605 (fontified t) 2605 2608 (face font-lock-comment-delimiter-face fontified t) 2608 2651 (face font-lock-comment-face fontified t) 2651 2664 (fontified t) 2664 2672 (face font-lock-builtin-face fontified t) 2672 2696 (fontified t) 2696 2737 (face font-lock-string-face fontified t) 2737 2753 (fontified t) 2753 2759 (face font-lock-keyword-face fontified t) 2759 2795 (fontified t) 2795 2798 (face font-lock-comment-delimiter-face fontified t) 2798 2853 (face font-lock-comment-face fontified t) 2853 2866 (fontified t) 2866 2873 (face font-lock-builtin-face fontified t) 2873 2897 (fontified t) 2897 2948 (face font-lock-string-face fontified t) 2948 2964 (fontified t) 2964 2969 (face font-lock-warning-face fontified t) 2969 3005 (fontified t) 3005 3008 (face font-lock-comment-delimiter-face fontified t) 3008 3044 (face font-lock-comment-face fontified t) 3044 3048 (fontified t) 3048 3057 (fontified t) 3057 3063 (face font-lock-builtin-face fontified t) 3063 3064 (fontified t) 3064 3087 (fontified t) 3087 3121 (face font-lock-string-face fontified t) 3121 3137 (fontified t) 3137 3140 (face font-lock-keyword-face fontified t) 3140 3209 (fontified t) 3209 3211 (face font-lock-keyword-face fontified t) 3211 3313 (fontified t) 3313 3318 (face font-lock-keyword-face fontified t) 3318 3350 (fontified t) 3350 3378 (face font-lock-string-face fontified t) 3378 3438 (fontified t) 3438 3442 (face font-lock-keyword-face fontified t) 3442 3541 (fontified t) 3541 3544 (face font-lock-comment-delimiter-face fontified t) 3544 3563 (face font-lock-comment-face fontified t) 3563 3583 (fontified t) 3583 3588 (face font-lock-keyword-face fontified t) 3588 3620 (fontified t) 3620 3663 (face font-lock-string-face fontified t) 3663 3665 (fontified t) 3665 3687 (fontified t) 3687 3692 (face font-lock-warning-face fontified t) 3692 3710 (fontified t) 3710 3711 (rear-nonsticky t fontified t)) . 8128) (undo-tree-id373 . -3711) (undo-tree-id374 . -2853) (undo-tree-id375 . -3711) (undo-tree-id376 . -3711) (undo-tree-id377 . -3711) (t 26976 56114 0 0)) nil (26976 56378 852057 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11530 . 11531) (nil fontified nil 8128 . 11531) (8128 . 11531)) nil (26976 56378 852043 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK en gérant manuellement BEGIN/COMMIT/ROLLBACK via EXEC.
   Cela évite les conflits de pile (SIMPLE-CONTROL-ERROR) causés par les macros de Postmodern.\"
  (format t \"~&[DB-TX] START Manual Transaction Logic.~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      (let ((outcome
             ;; On capture TOUT ce qui se passe dans la connexion pour le traiter dehors
             (handler-case
                 (ensure-connection
                   (format t \"~&[DB-TX] Connection ensured.~%\")
                   
                   ;; 1. Démarrage MANUEL de la transaction
                   ;; On utilise ignore-errors pour éviter de crasher si la connexion est déjà pourrie
                   (lumen.data.db:exec \"BEGIN\")
                   
                   (handler-case
                       (let ((res (funcall thunk)))
                         ;; 2. Si on arrive ici, c'est un succès -> COMMIT
                         (format t \"~&[DB-TX] Thunk success -> COMMIT.~%\")
                         (lumen.data.db:exec \"COMMIT\")
                         (list :success res))
                     
                     ;; 3. Capture de TOUTES les conditions (Métier ou Technique)
                     (condition (c)
                       (format t \"~&[DB-TX] Error inside TX: ~A. Executing ROLLBACK.~%\" c)
                       ;; On tente le rollback, mais on ignore les erreurs (ex: socket dead)
                       (ignore-errors (lumen.data.db:exec \"ROLLBACK\"))
                       ;; On retourne l'erreur comme une donnée simple
                       (list :error c))))
               
               ;; Si ensure-connection échoue avant même d'exécuter le code (ex: pool épuisé)
               (error (c)
                 (list :error c)))))

        ;; 4. DÉCISION (La pile est propre, plus de transaction active, plus de connexion ouverte)
        (destructuring-bind (status payload) outcome
          
          (if (eq status :success)
              ;; SUCCÈS : On retourne le résultat
              (return payload)

              ;; ERREUR : On analyse
              (let* ((err payload)
                     ;; Est-ce une erreur métier ?
                     (is-app-err (typep err 'lumen.core.error:application-error))
                     ;; Si non, est-ce une erreur technique DB mappable ?
                     (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))

                (cond
                  ;; A) Erreur Métier -> On la relance tout de suite (le Middleware l'attrapera)
                  (is-app-err
                   (format t \"~&[DB-TX] Re-signaling Application Error.~%\")
                   (error err))

                  ;; B) Erreur Technique Retryable -> On boucle
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (format t \"~&[DB-TX] Retryable error (~A). Sleeping...~%\" mapped)
                   (incf attempt)
                   (when (plusp sleep-ms)
                     (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; Loop continue implicitement

                  ;; C) Erreur Technique Fatale -> On relance
                  (t
                   (format t \"~&[DB-TX] Fatal Error. Re-signaling.~%\")
                   (error err))))))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 219 (face font-lock-doc-face fontified t) 219 232 (fontified t) 232 277 (face font-lock-string-face fontified t) 277 285 (fontified t) 285 288 (face font-lock-keyword-face fontified t) 288 308 (fontified t) 308 312 (face font-lock-keyword-face fontified t) 312 329 (fontified t) 329 366 (face font-lock-string-face fontified t) 366 390 (fontified t) 390 393 (face font-lock-keyword-face fontified t) 393 417 (fontified t) 417 420 (face font-lock-comment-delimiter-face fontified t) 420 493 (face font-lock-comment-face fontified t) 493 507 (fontified t) 507 519 (face font-lock-keyword-face fontified t) 519 585 (fontified t) 585 618 (face font-lock-string-face fontified t) 618 659 (fontified t) 659 662 (face font-lock-comment-delimiter-face fontified t) 662 700 (face font-lock-comment-face fontified t) 700 719 (fontified t) 719 722 (face font-lock-comment-delimiter-face fontified t) 722 803 (face font-lock-comment-face fontified t) 803 842 (fontified t) 842 849 (face font-lock-string-face fontified t) 849 891 (fontified t) 891 903 (face font-lock-keyword-face fontified t) 903 928 (fontified t) 928 931 (face font-lock-keyword-face fontified t) 931 981 (fontified t) 981 984 (face font-lock-comment-delimiter-face fontified t) 984 1031 (face font-lock-comment-face fontified t) 1031 1066 (fontified t) 1066 1104 (face font-lock-string-face fontified t) 1104 1151 (fontified t) 1151 1159 (face font-lock-string-face fontified t) 1159 1192 (fontified t) 1192 1200 (face font-lock-builtin-face fontified t) 1200 1250 (fontified t) 1250 1253 (face font-lock-comment-delimiter-face fontified t) 1253 1311 (face font-lock-comment-face fontified t) 1311 1380 (fontified t) 1380 1434 (face font-lock-string-face fontified t) 1434 1461 (fontified t) 1461 1464 (face font-lock-comment-delimiter-face fontified t) 1464 1501 (face font-lock-comment-face fontified t) 1501 1531 (face font-lock-comment-face fontified t) 1531 1555 (fontified t) 1555 1568 (face font-lock-keyword-face fontified t) 1568 1589 (fontified t) 1589 1599 (face font-lock-string-face fontified t) 1599 1625 (fontified t) 1625 1628 (face font-lock-comment-delimiter-face fontified t) 1628 1673 (face font-lock-comment-face fontified t) 1673 1702 (fontified t) 1702 1708 (face font-lock-builtin-face fontified t) 1708 1746 (fontified t) 1746 1749 (face font-lock-comment-delimiter-face fontified t) 1749 1825 (face font-lock-comment-face fontified t) 1825 1841 (fontified t) 1841 1846 (face font-lock-warning-face fontified t) 1846 1874 (fontified t) 1874 1880 (face font-lock-builtin-face fontified t) 1880 1897 (fontified t) 1897 1900 (face font-lock-comment-delimiter-face fontified t) 1900 1988 (face font-lock-comment-face fontified t) 1988 1997 (fontified t) 1997 2015 (face font-lock-keyword-face fontified t) 2015 2063 (fontified t) 2063 2065 (face font-lock-keyword-face fontified t) 2065 2077 (fontified t) 2077 2085 (face font-lock-builtin-face fontified t) 2085 2101 (fontified t) 2101 2104 (face font-lock-comment-delimiter-face fontified t) 2104 2137 (face font-lock-comment-face fontified t) 2137 2152 (fontified t) 2152 2158 (face font-lock-keyword-face fontified t) 2158 2183 (fontified t) 2183 2186 (face font-lock-comment-delimiter-face fontified t) 2186 2206 (face font-lock-comment-face fontified t) 2206 2221 (fontified t) 2221 2225 (face font-lock-keyword-face fontified t) 2225 2262 (fontified t) 2262 2265 (face font-lock-comment-delimiter-face fontified t) 2265 2292 (face font-lock-comment-face fontified t) 2292 2395 (fontified t) 2395 2398 (face font-lock-comment-delimiter-face fontified t) 2398 2448 (face font-lock-comment-face fontified t) 2448 2478 (fontified t) 2478 2484 (face font-lock-keyword-face fontified t) 2484 2554 (fontified t) 2554 2558 (face font-lock-keyword-face fontified t) 2558 2577 (fontified t) 2577 2580 (face font-lock-comment-delimiter-face fontified t) 2580 2656 (face font-lock-comment-face fontified t) 2656 2715 (fontified t) 2715 2760 (face font-lock-string-face fontified t) 2760 2782 (fontified t) 2782 2787 (face font-lock-warning-face fontified t) 2787 2813 (fontified t) 2813 2816 (face font-lock-comment-delimiter-face fontified t) 2816 2859 (face font-lock-comment-face fontified t) 2859 2988 (fontified t) 2988 3035 (face font-lock-string-face fontified t) 3035 3098 (fontified t) 3098 3102 (face font-lock-keyword-face fontified t) 3102 3179 (fontified t) 3179 3182 (face font-lock-comment-delimiter-face fontified t) 3182 3210 (face font-lock-comment-face fontified t) 3210 3229 (fontified t) 3229 3232 (face font-lock-comment-delimiter-face fontified t) 3232 3273 (face font-lock-comment-face fontified t) 3273 3323 (fontified t) 3323 3363 (face font-lock-string-face fontified t) 3363 3385 (fontified t) 3385 3390 (face font-lock-warning-face fontified t) 3390 3403 (fontified t) 3403 3404 (rear-nonsticky t fontified t) 3404 3405 (fontified t)) . 8127) (undo-tree-id378 . -3405) (undo-tree-id379 . -2537) (undo-tree-id380 . -3404) (undo-tree-id381 . -3404) (t 26976 56378 0 0)) nil (26976 56598 164162 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 56598 164150 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11580 . 11581) (nil fontified nil 8128 . 11581) (8128 . 11581)) nil (26976 56598 164150 0) 0 nil])
([nil nil ((11581 . 11584)) nil (26976 56598 164148 0) 0 nil])
([nil nil ((11581 . 11582)) nil (26976 56598 164144 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec gestion manuelle de transaction.
   Utilise HANDLER-BIND + RETURN-FROM pour garantir une sortie propre de la connexion
   avant de traiter l'erreur, évitant ainsi le SIMPLE-CONTROL-ERROR.\"
  (format t \"~&[DB-TX] START Logic (Safe-Flow).~%\")
  
  ;; 1. Bloc nommé global pour le retour de la fonction
  (block tx-func-block
    (let ((attempt 0))
      (loop
        (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
        
        (let ((outcome
               ;; 2. Bloc nommé pour la portée de la connexion
               (block connection-scope
                 (ensure-connection
                   ;; Démarrage Transaction
                   (lumen.data.db:exec \"BEGIN\")
                   
                   ;; On utilise handler-bind qui ne \"consomme\" pas la pile tout de suite
                   (handler-bind ((error (lambda (c)
                                           (format t \"~&[DB-TX] ! Caught inside TX: ~A (Type: ~A)~%\" c (type-of c))
                                           
                                           ;; 3. ROLLBACK immédiat tant qu'on a la connexion
                                           (format t \"~&[DB-TX] Executing ROLLBACK...~%\")
                                           (ignore-errors (lumen.data.db:exec \"ROLLBACK\"))
                                           
                                           ;; 4. SAUT NON-LOCAL EXPLICITE
                                           ;; On sort immédiatement de 'ensure-connection'.
                                           ;; Cela va déclencher les unwind-protect du pool de connexion proprement.
                                           (return-from connection-scope (list :error c)))))
                     
                     ;; Exécution du code métier
                     (let ((res (funcall thunk)))
                       (format t \"~&[DB-TX] Success -> COMMIT.~%\")
                       (lumen.data.db:exec \"COMMIT\")
                       (list :success res)))))))
        
        ;; 5. ZONE SÛRE (Safe Zone)
        ;; Ici, la connexion est fermée/rendue au pool. La pile est propre.
        (destructuring-bind (status payload) outcome
          (if (eq status :success)
              ;; Succès : on retourne le résultat final
              (return-from tx-func-block payload)
              
              ;; Erreur : Analyse et Décision
              (let* ((err payload)
                     (is-app-err (typep err 'lumen.core.error:application-error))
                     (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))
                
                (cond
                  ;; Cas A : Erreur Métier -> On relance
                  (is-app-err
                   (format t \"~&[DB-TX] Re-signaling APP ERROR.~%\")
                   (error err))
                  
                  ;; Cas B : Retry
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                   (incf attempt)
                   (when (plusp sleep-ms) 
                     (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; La boucle continue
                  
                  ;; Cas C : Erreur Fatale
                  (t
                   (format t \"~&[DB-TX] Fatal DB Error. Re-signaling.~%\")
                   (error err)))))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 261 (face font-lock-doc-face fontified t) 261 274 (fontified t) 274 312 (face font-lock-string-face fontified t) 312 319 (fontified t) 319 322 (face font-lock-comment-delimiter-face fontified t) 322 373 (face font-lock-comment-face fontified t) 373 376 (fontified t) 376 381 (face font-lock-keyword-face fontified t) 381 401 (fontified t) 401 404 (face font-lock-keyword-face fontified t) 404 426 (fontified t) 426 430 (face font-lock-keyword-face fontified t) 430 449 (fontified t) 449 486 (face font-lock-string-face fontified t) 486 514 (fontified t) 514 517 (face font-lock-keyword-face fontified t) 517 543 (fontified t) 543 546 (face font-lock-comment-delimiter-face fontified t) 546 591 (face font-lock-comment-face fontified t) 591 607 (fontified t) 607 612 (face font-lock-keyword-face fontified t) 612 685 (fontified t) 685 688 (face font-lock-comment-delimiter-face fontified t) 688 710 (face font-lock-comment-face fontified t) 710 749 (fontified t) 749 756 (face font-lock-string-face fontified t) 756 797 (fontified t) 797 800 (face font-lock-comment-delimiter-face fontified t) 800 868 (face font-lock-comment-face fontified t) 868 888 (fontified t) 888 900 (face font-lock-keyword-face fontified t) 900 903 (fontified t) 903 908 (face font-lock-warning-face fontified t) 908 910 (fontified t) 910 916 (face font-lock-keyword-face fontified t) 916 974 (fontified t) 974 1021 (face font-lock-string-face fontified t) 1021 1124 (fontified t) 1124 1127 (face font-lock-comment-delimiter-face fontified t) 1127 1174 (face font-lock-comment-face fontified t) 1174 1227 (fontified t) 1227 1262 (face font-lock-string-face fontified t) 1262 1308 (fontified t) 1308 1321 (face font-lock-keyword-face fontified t) 1321 1342 (fontified t) 1342 1352 (face font-lock-string-face fontified t) 1352 1442 (fontified t) 1442 1445 (face font-lock-comment-delimiter-face fontified t) 1445 1473 (face font-lock-comment-face fontified t) 1473 1500 (fontified t) 1500 1516 (fontified t) 1516 1519 (face font-lock-comment-delimiter-face fontified t) 1519 1565 (face font-lock-comment-face fontified t) 1565 1608 (fontified t) 1608 1611 (face font-lock-comment-delimiter-face fontified t) 1611 1682 (face font-lock-comment-face fontified t) 1682 1726 (fontified t) 1726 1737 (face font-lock-keyword-face fontified t) 1737 1761 (fontified t) 1761 1767 (face font-lock-builtin-face fontified t) 1767 1818 (fontified t) 1818 1821 (face font-lock-comment-delimiter-face fontified t) 1821 1846 (face font-lock-comment-face fontified t) 1846 1868 (fontified t) 1868 1871 (face font-lock-keyword-face fontified t) 1871 1929 (fontified t) 1929 1961 (face font-lock-string-face fontified t) 1961 2006 (fontified t) 2006 2014 (face font-lock-string-face fontified t) 2014 2045 (fontified t) 2045 2053 (face font-lock-builtin-face fontified t) 2053 2082 (fontified t) 2082 2085 (face font-lock-comment-delimiter-face fontified t) 2085 2110 (face font-lock-comment-face fontified t) 2110 2118 (fontified t) 2118 2121 (face font-lock-comment-delimiter-face fontified t) 2121 2186 (face font-lock-comment-face fontified t) 2186 2195 (fontified t) 2195 2213 (face font-lock-keyword-face fontified t) 2213 2250 (fontified t) 2250 2252 (face font-lock-keyword-face fontified t) 2252 2264 (fontified t) 2264 2272 (face font-lock-builtin-face fontified t) 2272 2288 (fontified t) 2288 2291 (face font-lock-comment-delimiter-face fontified t) 2291 2330 (face font-lock-comment-face fontified t) 2330 2345 (fontified t) 2345 2356 (face font-lock-keyword-face fontified t) 2356 2409 (fontified t) 2409 2412 (face font-lock-comment-delimiter-face fontified t) 2412 2441 (face font-lock-comment-face fontified t) 2441 2456 (fontified t) 2456 2460 (face font-lock-keyword-face fontified t) 2460 2588 (fontified t) 2588 2594 (face font-lock-keyword-face fontified t) 2594 2680 (fontified t) 2680 2684 (face font-lock-keyword-face fontified t) 2684 2703 (fontified t) 2703 2706 (face font-lock-comment-delimiter-face fontified t) 2706 2742 (face font-lock-comment-face fontified t) 2742 2801 (fontified t) 2801 2838 (face font-lock-string-face fontified t) 2838 2860 (fontified t) 2860 2865 (face font-lock-warning-face fontified t) 2865 2909 (fontified t) 2909 2912 (face font-lock-comment-delimiter-face fontified t) 2912 2926 (face font-lock-comment-face fontified t) 2926 3055 (fontified t) 3055 3065 (face font-lock-string-face fontified t) 3065 3097 (face font-lock-string-face fontified t) 3097 3099 (fontified t) 3099 3153 (fontified t) 3153 3157 (face font-lock-keyword-face fontified t) 3157 3235 (fontified t) 3235 3238 (face font-lock-comment-delimiter-face fontified t) 3238 3257 (face font-lock-comment-face fontified t) 3257 3294 (fontified t) 3294 3297 (face font-lock-comment-delimiter-face fontified t) 3297 3319 (face font-lock-comment-face fontified t) 3319 3369 (fontified t) 3369 3412 (face font-lock-string-face fontified t) 3412 3414 (fontified t) 3414 3434 (fontified t) 3434 3439 (face font-lock-warning-face fontified t) 3439 3452 (fontified t) 3452 3453 (rear-nonsticky t fontified t) 3453 3454 (fontified t)) . 8128) (undo-tree-id382 . -3454) (undo-tree-id383 . -2395) (undo-tree-id384 . -3454) (undo-tree-id385 . -3453) (undo-tree-id386 . -3453) (undo-tree-id387 . -3454) (undo-tree-id388 . -3454) (undo-tree-id389 . -3454) (undo-tree-id390 . -3454) (t 26976 56598 0 0)) nil (26976 56987 399872 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11928 . 11929) (nil fontified nil 8128 . 11929) (8128 . 11929)) nil (26976 56987 399855 0) 0 nil])
([nil nil ((11929 . 11930) (t 26976 56987 0 0)) nil (26976 56989 941672 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec gestion manuelle de transaction.
   Utilise RESTART-CASE + INVOKE-RESTART pour une sortie de pile coopérative,
   résolvant définitivement le SIMPLE-CONTROL-ERROR.\"
  (format t \"~&[DB-TX] START Logic (Restart-Based).~%\")
  
  (block tx-func-block
    (let ((attempt 0))
      (loop
        (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
        
        (let ((outcome
               (block connection-scope
                 (ensure-connection
                   ;; 1. Démarrage Transaction
                   (lumen.data.db:exec \"BEGIN\")
                   
                   ;; 2. On installe un gestionnaire d'erreur
                   (handler-bind ((error 
                                   (lambda (c)
                                     (format t \"~&[DB-TX] ! Caught inside TX: ~A~%\" c)
                                     
                                     ;; a) ROLLBACK immédiat
                                     (format t \"~&[DB-TX] Executing ROLLBACK...~%\")
                                     (ignore-errors (lumen.data.db:exec \"ROLLBACK\"))
                                     
                                     ;; b) Invoquer le restart pour sortir proprement
                                     ;; C'est beaucoup plus sûr que 'return-from'
                                     (if (find-restart 'abort-transaction)
                                         (invoke-restart 'abort-transaction c)
                                         (progn
                                           (format t \"~&[DB-TX] CRITICAL: Restart not found!~%\")
                                           (return-from connection-scope (list :error c)))))))
                     
                     ;; 3. Zone protégée par le Restart
                     (restart-case
                         (let ((res (funcall thunk)))
                           (format t \"~&[DB-TX] Success -> COMMIT.~%\")
                           (lumen.data.db:exec \"COMMIT\")
                           (list :success res))
                       
                       ;; DÉFINITION DU RESTART
                       ;; C'est ici qu'on atterrit après invoke-restart
                       (abort-transaction (err)
                         :report \"Abort DB transaction and return error\"
                         (format t \"~&[DB-TX] Restart invoked. Exiting safely.~%\")
                         (list :error err))))))))
        
        ;; 4. ZONE SÛRE (Safe Zone)
        ;; La pile est propre, la connexion est rendue.
        (destructuring-bind (status payload) outcome
          (if (eq status :success)
              (return-from tx-func-block payload)
              
              (let* ((err payload)
                     (is-app-err (typep err 'lumen.core.error:application-error))
                     (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))
                
                (cond
                  ((or is-app-err (null mapped))
                   ;; On recrée l'erreur pour éviter toute référence fantôme à la pile précédente
                   ;; (Astuce de sécurité ultime si l'objet err est corrompu)
                   (format t \"~&[DB-TX] Re-signaling Error (Safe Zone).~%\")
                   (error err))
                  
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                   (incf attempt)
                   (when (plusp sleep-ms) 
                     (sleep (/ (max 0 sleep-ms) 1000.0))))
                  
                  (t
                   (format t \"~&[DB-TX] Fatal DB Error. Re-signaling.~%\")
                   (error err)))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 238 (face font-lock-doc-face fontified t) 238 251 (fontified t) 251 293 (face font-lock-string-face fontified t) 293 301 (fontified t) 301 306 (face font-lock-keyword-face fontified t) 306 326 (fontified t) 326 329 (face font-lock-keyword-face fontified t) 329 351 (fontified t) 351 355 (face font-lock-keyword-face fontified t) 355 374 (fontified t) 374 411 (face font-lock-string-face fontified t) 411 439 (fontified t) 439 442 (face font-lock-keyword-face fontified t) 442 469 (fontified t) 469 474 (face font-lock-keyword-face fontified t) 474 547 (fontified t) 547 550 (face font-lock-comment-delimiter-face fontified t) 550 575 (face font-lock-comment-face fontified t) 575 614 (fontified t) 614 621 (face font-lock-string-face fontified t) 621 662 (fontified t) 662 665 (face font-lock-comment-delimiter-face fontified t) 665 705 (face font-lock-comment-face fontified t) 705 725 (fontified t) 725 737 (face font-lock-keyword-face fontified t) 737 740 (fontified t) 740 745 (face font-lock-warning-face fontified t) 745 783 (fontified t) 783 789 (face font-lock-keyword-face fontified t) 789 841 (fontified t) 841 877 (face font-lock-string-face fontified t) 877 956 (fontified t) 956 959 (face font-lock-comment-delimiter-face fontified t) 959 980 (face font-lock-comment-face fontified t) 980 1027 (fontified t) 1027 1062 (face font-lock-string-face fontified t) 1062 1102 (fontified t) 1102 1115 (face font-lock-keyword-face fontified t) 1115 1136 (fontified t) 1136 1146 (face font-lock-string-face fontified t) 1146 1224 (fontified t) 1224 1227 (face font-lock-comment-delimiter-face fontified t) 1227 1273 (face font-lock-comment-face fontified t) 1273 1310 (fontified t) 1310 1313 (face font-lock-comment-delimiter-face fontified t) 1313 1355 (face font-lock-comment-face fontified t) 1355 1393 (fontified t) 1393 1395 (face font-lock-keyword-face fontified t) 1395 1501 (fontified t) 1501 1509 (fontified t) 1509 1551 (fontified t) 1551 1556 (face font-lock-keyword-face fontified t) 1556 1610 (fontified t) 1610 1652 (face font-lock-string-face fontified t) 1652 1698 (fontified t) 1698 1709 (face font-lock-keyword-face fontified t) 1709 1733 (fontified t) 1733 1739 (face font-lock-builtin-face fontified t) 1739 1792 (fontified t) 1792 1795 (face font-lock-comment-delimiter-face fontified t) 1795 1827 (face font-lock-comment-face fontified t) 1827 1849 (fontified t) 1849 1861 (face font-lock-keyword-face fontified t) 1861 1888 (fontified t) 1888 1891 (face font-lock-keyword-face fontified t) 1891 1953 (fontified t) 1953 1985 (face font-lock-string-face fontified t) 1985 2034 (fontified t) 2034 2042 (face font-lock-string-face fontified t) 2042 2077 (fontified t) 2077 2085 (face font-lock-builtin-face fontified t) 2085 2139 (fontified t) 2139 2142 (face font-lock-comment-delimiter-face fontified t) 2142 2164 (face font-lock-comment-face fontified t) 2164 2187 (fontified t) 2187 2190 (face font-lock-comment-delimiter-face fontified t) 2190 2236 (face font-lock-comment-face fontified t) 2236 2309 (fontified t) 2309 2316 (face font-lock-builtin-face fontified t) 2316 2317 (fontified t) 2317 2356 (face font-lock-string-face fontified t) 2356 2392 (fontified t) 2392 2438 (face font-lock-string-face fontified t) 2438 2471 (fontified t) 2471 2477 (face font-lock-builtin-face fontified t) 2477 2507 (fontified t) 2507 2510 (face font-lock-comment-delimiter-face fontified t) 2510 2535 (face font-lock-comment-face fontified t) 2535 2543 (fontified t) 2543 2546 (face font-lock-comment-delimiter-face fontified t) 2546 2591 (face font-lock-comment-face fontified t) 2591 2600 (fontified t) 2600 2618 (face font-lock-keyword-face fontified t) 2618 2655 (fontified t) 2655 2657 (face font-lock-keyword-face fontified t) 2657 2669 (fontified t) 2669 2677 (face font-lock-builtin-face fontified t) 2677 2694 (fontified t) 2694 2705 (face font-lock-keyword-face fontified t) 2705 2759 (fontified t) 2759 2763 (face font-lock-keyword-face fontified t) 2763 2891 (fontified t) 2891 2897 (face font-lock-keyword-face fontified t) 2897 2983 (fontified t) 2983 2987 (face font-lock-keyword-face fontified t) 2987 3056 (fontified t) 3056 3059 (face font-lock-comment-delimiter-face fontified t) 3059 3135 (face font-lock-comment-face fontified t) 3135 3154 (fontified t) 3154 3157 (face font-lock-comment-delimiter-face fontified t) 3157 3213 (face font-lock-comment-face fontified t) 3213 3242 (fontified t) 3242 3287 (face font-lock-string-face fontified t) 3287 3309 (fontified t) 3309 3314 (face font-lock-warning-face fontified t) 3314 3469 (fontified t) 3469 3511 (face font-lock-string-face fontified t) 3511 3567 (fontified t) 3567 3571 (face font-lock-keyword-face fontified t) 3571 3718 (fontified t) 3718 3761 (face font-lock-string-face fontified t) 3761 3763 (fontified t) 3763 3783 (fontified t) 3783 3788 (face font-lock-warning-face fontified t) 3788 3801 (fontified t) 3801 3802 (rear-nonsticky t fontified t) 3802 3803 (fontified t)) . 8127) (undo-tree-id391 . -3803) (undo-tree-id392 . -2861) (undo-tree-id393 . -3803) (undo-tree-id394 . -3803) (undo-tree-id395 . -1) (undo-tree-id396 . -3803) (t 26976 56989 0 0)) nil (26976 57387 521281 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 57387 521268 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11767 . 11768) (nil fontified nil 8128 . 11768) (8128 . 11768)) nil (26976 57387 521264 0) 0 nil])
([nil nil ((#("

(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK via une stratégie de 'Conteneurisation'.
   Au lieu de lancer une erreur à travers la connexion (ce qui cause le crash),
   on capture l'erreur, on sort normalement de la connexion, puis on relance l'erreur depuis la zone sûre.\"
  (format t \"~&[DB-TX] START Logic (Container-Strategy).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      ;; Ces variables vont \"transporter\" le résultat ou l'erreur hors de la zone dangereuse
      (let ((captured-result nil)
            (captured-error nil)
            (tx-success nil))

        ;; 1. ZONE DANGEREUSE (DB)
        ;; On utilise un HANDLER-CASE global pour empêcher TOUTE erreur de sortir brutalement
        (handler-case
            (ensure-connection
              ;; Bloc pour permettre un retour local (sans casser la pile globale)
              (block inner-db-scope
                (handler-bind ((error (lambda (c)
                                        (format t \"~&[DB-TX] ! Caught inside: ~A~%\" c)
                                        ;; A) On capture l'erreur pour plus tard
                                        (setf captured-error c)
                                        ;; B) On tente un rollback silencieux
                                        (ignore-errors (lumen.data.db:exec \"ROLLBACK\"))
                                        ;; C) ON NE LANCE PAS D'ERREUR ICI.
                                        ;; On retourne 'nil' pour sortir proprement de ensure-connection.
                                        ;; Cela permet aux 'unwind-protect' du pool de se fermer correctement.
                                        (return-from inner-db-scope nil))))
                  
                  ;; Logique nominale
                  (lumen.data.db:exec \"BEGIN\")
                  (let ((res (funcall thunk)))
                    (lumen.data.db:exec \"COMMIT\")
                    ;; Si on arrive ici, c'est gagné
                    (setf captured-result res
                          tx-success t)))))
          
          ;; Cas où ensure-connection lui-même plante (avant notre block)
          (error (c)
            (setf captured-error c)))

        ;; 2. ZONE SÛRE (Safe Zone)
        ;; À ce stade, ensure-connection est terminé. Les verrous sont relâchés. La pile est plate.
        ;; Nous pouvons analyser ce qui s'est passé.
        
        (cond
          ;; SUCCÈS
          (tx-success
           (format t \"~&[DB-TX] Success -> Returning result.~%\")
           (return captured-result))
          
          ;; ERREUR CAPTURÉE
          (captured-error
           (let* ((err captured-error)
                  (is-app-err (typep err 'lumen.core.error:application-error))
                  (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))
             
             (cond
               ;; Erreur Métier -> On relance (maintenant c'est sûr)
               (is-app-err
                (format t \"~&[DB-TX] Re-signaling APP ERROR (Safe).~%\")
                (error err))
               
               ;; Retry
               ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                (incf attempt)
                (when (plusp sleep-ms) 
                  (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; La boucle continue
               
               ;; Fatal
               (t
                (format t \"~&[DB-TX] Fatal Error. Re-signaling (Safe).~%\")
                (error err))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 27 (face font-lock-function-name-face fontified t) 27 55 (fontified t) 55 298 (face font-lock-doc-face fontified t) 298 311 (fontified t) 311 358 (face font-lock-string-face fontified t) 358 366 (fontified t) 366 369 (face font-lock-keyword-face fontified t) 369 389 (fontified t) 389 393 (face font-lock-keyword-face fontified t) 393 410 (fontified t) 410 447 (face font-lock-string-face fontified t) 447 470 (fontified t) 470 473 (face font-lock-comment-delimiter-face fontified t) 473 557 (face font-lock-comment-face fontified t) 557 564 (fontified t) 564 567 (face font-lock-keyword-face fontified t) 567 663 (fontified t) 663 666 (face font-lock-comment-delimiter-face fontified t) 666 690 (face font-lock-comment-face fontified t) 690 698 (fontified t) 698 701 (face font-lock-comment-delimiter-face fontified t) 701 784 (face font-lock-comment-face fontified t) 784 793 (fontified t) 793 805 (face font-lock-keyword-face fontified t) 805 851 (fontified t) 851 854 (face font-lock-comment-delimiter-face fontified t) 854 920 (face font-lock-comment-face fontified t) 920 935 (fontified t) 935 940 (face font-lock-keyword-face fontified t) 940 973 (fontified t) 973 985 (face font-lock-keyword-face fontified t) 985 988 (fontified t) 988 993 (face font-lock-warning-face fontified t) 993 995 (fontified t) 995 1001 (face font-lock-keyword-face fontified t) 1001 1056 (fontified t) 1056 1089 (face font-lock-string-face fontified t) 1089 1133 (fontified t) 1133 1136 (face font-lock-comment-delimiter-face fontified t) 1136 1174 (face font-lock-comment-face fontified t) 1174 1278 (fontified t) 1278 1281 (face font-lock-comment-delimiter-face fontified t) 1281 1316 (face font-lock-comment-face fontified t) 1316 1357 (fontified t) 1357 1370 (face font-lock-keyword-face fontified t) 1370 1391 (fontified t) 1391 1401 (face font-lock-string-face fontified t) 1401 1444 (fontified t) 1444 1447 (face font-lock-comment-delimiter-face fontified t) 1447 1480 (face font-lock-comment-face fontified t) 1480 1502 (fontified t) 1502 1520 (fontified t) 1520 1523 (face font-lock-comment-delimiter-face fontified t) 1523 1586 (face font-lock-comment-face fontified t) 1586 1626 (fontified t) 1626 1629 (face font-lock-comment-delimiter-face fontified t) 1629 1697 (face font-lock-comment-face fontified t) 1697 1738 (fontified t) 1738 1749 (face font-lock-keyword-face fontified t) 1749 1810 (fontified t) 1810 1813 (face font-lock-comment-delimiter-face fontified t) 1813 1830 (face font-lock-comment-face fontified t) 1830 1868 (fontified t) 1868 1875 (face font-lock-string-face fontified t) 1875 1896 (fontified t) 1896 1899 (face font-lock-keyword-face fontified t) 1899 1964 (fontified t) 1964 1972 (face font-lock-string-face fontified t) 1972 1994 (fontified t) 1994 1997 (face font-lock-comment-delimiter-face fontified t) 1997 2027 (face font-lock-comment-face fontified t) 2027 2138 (fontified t) 2138 2141 (face font-lock-comment-delimiter-face fontified t) 2141 2202 (face font-lock-comment-face fontified t) 2202 2213 (fontified t) 2213 2218 (face font-lock-warning-face fontified t) 2218 2270 (fontified t) 2270 2273 (face font-lock-comment-delimiter-face fontified t) 2273 2298 (face font-lock-comment-face fontified t) 2298 2306 (fontified t) 2306 2309 (face font-lock-comment-delimiter-face fontified t) 2309 2398 (face font-lock-comment-face fontified t) 2398 2406 (fontified t) 2406 2409 (face font-lock-comment-delimiter-face fontified t) 2409 2451 (face font-lock-comment-face fontified t) 2451 2469 (fontified t) 2469 2473 (face font-lock-keyword-face fontified t) 2473 2484 (fontified t) 2484 2487 (face font-lock-comment-delimiter-face fontified t) 2487 2494 (face font-lock-comment-face fontified t) 2494 2537 (fontified t) 2537 2579 (face font-lock-string-face fontified t) 2579 2593 (fontified t) 2593 2599 (face font-lock-keyword-face fontified t) 2599 2639 (fontified t) 2639 2642 (face font-lock-comment-delimiter-face fontified t) 2642 2658 (face font-lock-comment-face fontified t) 2658 2696 (fontified t) 2696 2700 (face font-lock-keyword-face fontified t) 2700 2829 (fontified t) 2829 2835 (face font-lock-keyword-face fontified t) 2835 2915 (fontified t) 2915 2919 (face font-lock-keyword-face fontified t) 2919 2935 (fontified t) 2935 2938 (face font-lock-comment-delimiter-face fontified t) 2938 2989 (face font-lock-comment-face fontified t) 2989 3042 (fontified t) 3042 3086 (face font-lock-string-face fontified t) 3086 3105 (fontified t) 3105 3110 (face font-lock-warning-face fontified t) 3110 3148 (fontified t) 3148 3151 (face font-lock-comment-delimiter-face fontified t) 3151 3157 (face font-lock-comment-face fontified t) 3157 3280 (fontified t) 3280 3322 (face font-lock-string-face fontified t) 3322 3372 (fontified t) 3372 3376 (face font-lock-keyword-face fontified t) 3376 3451 (fontified t) 3451 3454 (face font-lock-comment-delimiter-face fontified t) 3454 3473 (face font-lock-comment-face fontified t) 3473 3504 (fontified t) 3504 3507 (face font-lock-comment-delimiter-face fontified t) 3507 3513 (face font-lock-comment-face fontified t) 3513 3557 (fontified t) 3557 3604 (face font-lock-string-face fontified t) 3604 3623 (fontified t) 3623 3628 (face font-lock-warning-face fontified t) 3628 3641 (fontified t) 3641 3642 (rear-nonsticky t fontified t)) . 8126) (undo-tree-id397 . -3642) (undo-tree-id398 . -2887) (undo-tree-id399 . -3642) (undo-tree-id400 . -1) (undo-tree-id401 . -3642) (undo-tree-id402 . -2) (undo-tree-id403 . -3642) (undo-tree-id404 . -3642) (undo-tree-id405 . -3642) (undo-tree-id406 . -3642) (undo-tree-id407 . -3642) (undo-tree-id408 . -3642) (undo-tree-id409 . -3642) (undo-tree-id410 . -3642) (undo-tree-id411 . -3567) (undo-tree-id412 . -3567) (undo-tree-id413 . -3132) (undo-tree-id414 . -2434) (undo-tree-id415 . -1585) (undo-tree-id416 . -556) (t 26976 57387 0 0)) nil (26976 57544 369155 0) 0 nil])
([nil nil ((8126 . 8128)) nil (26976 57544 369133 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11064 . 11065) (nil fontified nil 8128 . 11065) (8128 . 11065)) nil (26976 57544 369129 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec stratégie de conteneurisation.
   CORRECTION FINALE : On ne relance JAMAIS l'objet erreur original.
   On extrait son texte et on lance une NOUVELLE erreur pour éviter le SIMPLE-CONTROL-ERROR.\"
  (format t \"~&[DB-TX] START Logic (Sanitized-Re-Signal).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      (let ((captured-result nil)
            (captured-error nil)
            (tx-success nil))

        ;; 1. ZONE DANGEREUSE (DB)
        (handler-case
            (ensure-connection
              (block inner-db-scope
                (handler-bind ((error (lambda (c)
                                        (format t \"~&[DB-TX] ! Caught inside: ~A~%\" c)
                                        (setf captured-error c)
                                        (ignore-errors (lumen.data.db:exec \"ROLLBACK\"))
                                        ;; Sortie propre avec NIL
                                        (return-from inner-db-scope nil))))
                  
                  (lumen.data.db:exec \"BEGIN\")
                  (let ((res (funcall thunk)))
                    (lumen.data.db:exec \"COMMIT\")
                    (setf captured-result res
                          tx-success t)))))
          
          ;; Erreur de connexion pure (avant le block)
          (error (c)
            (setf captured-error c)))

        ;; 2. ZONE SÛRE (Safe Zone)
        (cond
          (tx-success
           (format t \"~&[DB-TX] Success -> Returning result.~%\")
           (return captured-result))
          
          (captured-error
           (let* ((err captured-error)
                  (is-app-err (typep err 'lumen.core.error:application-error))
                  (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))
             
             (cond
               ;; CAS CRITIQUE : ERREUR MÉTIER
               (is-app-err
                (format t \"~&[DB-TX] Re-signaling FRESH error (String copy).~%\")
                ;; ICI EST LE FIX : On convertit l'objet erreur en String pure.
                ;; On lance une erreur standard. Le Middleware attrapera le message.
                ;; Cela détruit tous les pointeurs de pile invalides.
                (error \"~A\" err))
               
               ;; Retry
               ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                (incf attempt)
                (when (plusp sleep-ms) 
                  (sleep (/ (max 0 sleep-ms) 1000.0))))
               
               ;; Erreur Fatale
               (t
                (format t \"~&[DB-TX] Fatal Error. Re-signaling FRESH string.~%\")
                ;; Même punition pour les erreurs techniques fatales
                (error \"DB Error: ~A\" err))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 267 (face font-lock-doc-face fontified t) 267 280 (fontified t) 280 328 (face font-lock-string-face fontified t) 328 336 (fontified t) 336 339 (face font-lock-keyword-face fontified t) 339 359 (fontified t) 359 363 (face font-lock-keyword-face fontified t) 363 380 (fontified t) 380 417 (face font-lock-string-face fontified t) 417 441 (fontified t) 441 444 (face font-lock-keyword-face fontified t) 444 540 (fontified t) 540 543 (face font-lock-comment-delimiter-face fontified t) 543 567 (face font-lock-comment-face fontified t) 567 576 (fontified t) 576 588 (face font-lock-keyword-face fontified t) 588 635 (fontified t) 635 640 (face font-lock-keyword-face fontified t) 640 673 (fontified t) 673 685 (face font-lock-keyword-face fontified t) 685 688 (fontified t) 688 693 (face font-lock-warning-face fontified t) 693 695 (fontified t) 695 701 (face font-lock-keyword-face fontified t) 701 756 (fontified t) 756 789 (face font-lock-string-face fontified t) 789 898 (fontified t) 898 911 (face font-lock-keyword-face fontified t) 911 932 (fontified t) 932 942 (face font-lock-string-face fontified t) 942 985 (fontified t) 985 988 (face font-lock-comment-delimiter-face fontified t) 988 1011 (face font-lock-comment-face fontified t) 1011 1052 (fontified t) 1052 1063 (face font-lock-keyword-face fontified t) 1063 1144 (fontified t) 1144 1151 (face font-lock-string-face fontified t) 1151 1172 (fontified t) 1172 1175 (face font-lock-keyword-face fontified t) 1175 1240 (fontified t) 1240 1248 (face font-lock-string-face fontified t) 1248 1361 (fontified t) 1361 1364 (face font-lock-comment-delimiter-face fontified t) 1364 1406 (face font-lock-comment-face fontified t) 1406 1417 (fontified t) 1417 1422 (face font-lock-warning-face fontified t) 1422 1474 (fontified t) 1474 1477 (face font-lock-comment-delimiter-face fontified t) 1477 1501 (face font-lock-comment-face fontified t) 1501 1502 (face font-lock-comment-face fontified t) 1502 1511 (fontified t) 1511 1515 (face font-lock-keyword-face fontified t) 1515 1559 (fontified t) 1559 1601 (face font-lock-string-face fontified t) 1601 1615 (fontified t) 1615 1621 (face font-lock-keyword-face fontified t) 1621 1689 (fontified t) 1689 1693 (face font-lock-keyword-face fontified t) 1693 1822 (fontified t) 1822 1828 (face font-lock-keyword-face fontified t) 1828 1908 (fontified t) 1908 1912 (face font-lock-keyword-face fontified t) 1912 1928 (fontified t) 1928 1931 (face font-lock-comment-delimiter-face fontified t) 1931 1960 (face font-lock-comment-face fontified t) 1960 2013 (fontified t) 2013 2066 (face font-lock-string-face fontified t) 2066 2084 (fontified t) 2084 2087 (face font-lock-comment-delimiter-face fontified t) 2087 2148 (face font-lock-comment-face fontified t) 2148 2164 (fontified t) 2164 2167 (face font-lock-comment-delimiter-face fontified t) 2167 2233 (face font-lock-comment-face fontified t) 2233 2249 (fontified t) 2249 2252 (face font-lock-comment-delimiter-face fontified t) 2252 2303 (face font-lock-comment-face fontified t) 2303 2320 (fontified t) 2320 2325 (face font-lock-warning-face fontified t) 2325 2326 (fontified t) 2326 2330 (face font-lock-string-face fontified t) 2330 2368 (fontified t) 2368 2371 (face font-lock-comment-delimiter-face fontified t) 2371 2377 (face font-lock-comment-face fontified t) 2377 2500 (fontified t) 2500 2542 (face font-lock-string-face fontified t) 2542 2592 (fontified t) 2592 2596 (face font-lock-keyword-face fontified t) 2596 2702 (fontified t) 2702 2705 (face font-lock-comment-delimiter-face fontified t) 2705 2719 (face font-lock-comment-face fontified t) 2719 2763 (fontified t) 2763 2816 (face font-lock-string-face fontified t) 2816 2834 (fontified t) 2834 2837 (face font-lock-comment-delimiter-face fontified t) 2837 2887 (face font-lock-comment-face fontified t) 2887 2904 (fontified t) 2904 2909 (face font-lock-warning-face fontified t) 2909 2910 (fontified t) 2910 2924 (face font-lock-string-face fontified t) 2924 2937 (fontified t) 2937 2938 (rear-nonsticky t fontified t)) . 8127) (undo-tree-id417 . -2938) (undo-tree-id418 . -1987) (undo-tree-id419 . -2938) (undo-tree-id420 . -2938) (undo-tree-id421 . -1) (undo-tree-id422 . -2938) (undo-tree-id423 . -1339) (undo-tree-id424 . -467) (t 26976 57544 0 0)) nil (26976 57734 447611 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 57734 447597 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11545 . 11546) (nil fontified nil 8128 . 11546) (8128 . 11546)) nil (26976 57734 447593 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec stratégie de conteneurisation.
   FIX 25P02 : On utilise 'postmodern:execute' directement pour BEGIN/COMMIT/ROLLBACK
   afin d'éviter que 'exec' n'essaie de définir un statement_timeout sur une transaction annulée.\"
  (format t \"~&[DB-TX] START Logic (Raw-SQL-Control).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      (let ((captured-result nil)
            (captured-error nil)
            (tx-success nil))

        ;; 1. ZONE DANGEREUSE (DB)
        (handler-case
            (ensure-connection
              (block inner-db-scope
                (handler-bind ((error (lambda (c)
                                        (format t \"~&[DB-TX] ! Caught inside: ~A~%\" c)
                                        (setf captured-error c)
                                        
                                        ;; FIX CRITIQUE ICI :
                                        ;; On utilise execute (raw) et non exec (smart)
                                        ;; pour éviter l'erreur 25P02 (SET timeout impossible sur transaction annulée)
                                        (ignore-errors 
                                          #+postmodern (postmodern:execute \"ROLLBACK\")
                                          #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                                        
                                        ;; Sortie propre avec NIL
                                        (return-from inner-db-scope nil))))
                  
                  ;; Démarrage Raw
                  #+postmodern (postmodern:execute \"BEGIN\")
                  #-postmodern (lumen.data.db:exec \"BEGIN\")
                  
                  (let ((res (funcall thunk)))
                    ;; Commit Raw
                    #+postmodern (postmodern:execute \"COMMIT\")
                    #-postmodern (lumen.data.db:exec \"COMMIT\")
                    
                    (setf captured-result res
                          tx-success t)))))
          
          ;; Erreur de connexion pure
          (error (c)
            (setf captured-error c)))

        ;; 2. ZONE SÛRE (Safe Zone)
        (cond
          (tx-success
           (format t \"~&[DB-TX] Success -> Returning result.~%\")
           (return captured-result))
          
          (captured-error
           (let* ((err captured-error)
                  (is-app-err (typep err 'lumen.core.error:application-error))
                  (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))
             
             (cond
               ;; ERREUR MÉTIER -> Nouvelle erreur propre (String)
               (is-app-err
                (format t \"~&[DB-TX] Re-signaling FRESH error.~%\")
                (error \"~A\" err))
               
               ;; Retry
               ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                (incf attempt)
                (when (plusp sleep-ms) 
                  (sleep (/ (max 0 sleep-ms) 1000.0))))
               
               ;; Erreur Fatale -> Nouvelle erreur propre
               (t
                (format t \"~&[DB-TX] Fatal Error. Re-signaling FRESH string.~%\")
                (error \"DB Error: ~A\" err))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 289 (face font-lock-doc-face fontified t) 289 302 (fontified t) 302 346 (face font-lock-string-face fontified t) 346 354 (fontified t) 354 357 (face font-lock-keyword-face fontified t) 357 377 (fontified t) 377 381 (face font-lock-keyword-face fontified t) 381 398 (fontified t) 398 435 (face font-lock-string-face fontified t) 435 459 (fontified t) 459 462 (face font-lock-keyword-face fontified t) 462 558 (fontified t) 558 561 (face font-lock-comment-delimiter-face fontified t) 561 585 (face font-lock-comment-face fontified t) 585 594 (fontified t) 594 606 (face font-lock-keyword-face fontified t) 606 653 (fontified t) 653 658 (face font-lock-keyword-face fontified t) 658 691 (fontified t) 691 703 (face font-lock-keyword-face fontified t) 703 706 (fontified t) 706 711 (face font-lock-warning-face fontified t) 711 713 (fontified t) 713 719 (face font-lock-keyword-face fontified t) 719 774 (fontified t) 774 807 (face font-lock-string-face fontified t) 807 956 (fontified t) 956 959 (face font-lock-comment-delimiter-face fontified t) 959 978 (face font-lock-comment-face fontified t) 978 1018 (fontified t) 1018 1021 (face font-lock-comment-delimiter-face fontified t) 1021 1066 (face font-lock-comment-face fontified t) 1066 1106 (fontified t) 1106 1109 (face font-lock-comment-delimiter-face fontified t) 1109 1185 (face font-lock-comment-face fontified t) 1185 1226 (fontified t) 1226 1239 (face font-lock-keyword-face fontified t) 1239 1316 (fontified t) 1316 1326 (face font-lock-string-face fontified t) 1326 1370 (fontified t) 1370 1403 (face slime-reader-conditional-face fontified t) 1403 1413 (face slime-reader-conditional-face fontified t) 1413 1414 (face slime-reader-conditional-face fontified t) 1414 1497 (fontified t) 1497 1500 (face font-lock-comment-delimiter-face fontified t) 1500 1501 (face font-lock-comment-face fontified t) 1501 1523 (face font-lock-comment-face fontified t) 1523 1564 (fontified t) 1564 1575 (face font-lock-keyword-face fontified t) 1575 1636 (fontified t) 1636 1639 (face font-lock-comment-delimiter-face fontified t) 1639 1653 (face font-lock-comment-face fontified t) 1653 1704 (fontified t) 1704 1711 (face font-lock-string-face fontified t) 1711 1731 (fontified t) 1731 1764 (face slime-reader-conditional-face fontified t) 1764 1771 (face slime-reader-conditional-face fontified t) 1771 1772 (face slime-reader-conditional-face fontified t) 1772 1811 (fontified t) 1811 1814 (face font-lock-keyword-face fontified t) 1814 1859 (fontified t) 1859 1862 (face font-lock-comment-delimiter-face fontified t) 1862 1873 (face font-lock-comment-face fontified t) 1873 1926 (fontified t) 1926 1934 (face font-lock-string-face fontified t) 1934 1956 (fontified t) 1956 1989 (face slime-reader-conditional-face fontified t) 1989 1997 (face slime-reader-conditional-face fontified t) 1997 1998 (face slime-reader-conditional-face fontified t) 1998 2131 (fontified t) 2131 2134 (face font-lock-comment-delimiter-face fontified t) 2134 2159 (face font-lock-comment-face fontified t) 2159 2170 (fontified t) 2170 2175 (face font-lock-warning-face fontified t) 2175 2227 (fontified t) 2227 2230 (face font-lock-comment-delimiter-face fontified t) 2230 2255 (face font-lock-comment-face fontified t) 2255 2264 (fontified t) 2264 2268 (face font-lock-keyword-face fontified t) 2268 2312 (fontified t) 2312 2354 (face font-lock-string-face fontified t) 2354 2368 (fontified t) 2368 2374 (face font-lock-keyword-face fontified t) 2374 2442 (fontified t) 2442 2446 (face font-lock-keyword-face fontified t) 2446 2575 (fontified t) 2575 2581 (face font-lock-keyword-face fontified t) 2581 2661 (fontified t) 2661 2665 (face font-lock-keyword-face fontified t) 2665 2681 (fontified t) 2681 2684 (face font-lock-comment-delimiter-face fontified t) 2684 2733 (face font-lock-comment-face fontified t) 2733 2786 (fontified t) 2786 2825 (face font-lock-string-face fontified t) 2825 2844 (fontified t) 2844 2849 (face font-lock-warning-face fontified t) 2849 2850 (fontified t) 2850 2854 (face font-lock-string-face fontified t) 2854 2892 (fontified t) 2892 2895 (face font-lock-comment-delimiter-face fontified t) 2895 2901 (face font-lock-comment-face fontified t) 2901 3024 (fontified t) 3024 3066 (face font-lock-string-face fontified t) 3066 3116 (fontified t) 3116 3120 (face font-lock-keyword-face fontified t) 3120 3226 (fontified t) 3226 3229 (face font-lock-comment-delimiter-face fontified t) 3229 3269 (face font-lock-comment-face fontified t) 3269 3313 (fontified t) 3313 3366 (face font-lock-string-face fontified t) 3366 3385 (fontified t) 3385 3390 (face font-lock-warning-face fontified t) 3390 3391 (fontified t) 3391 3405 (face font-lock-string-face fontified t) 3405 3418 (fontified t) 3418 3419 (rear-nonsticky t fontified t)) . 8127) (undo-tree-id425 . -3419) (undo-tree-id426 . -2633) (undo-tree-id427 . -3419) (undo-tree-id428 . -1) (undo-tree-id429 . -3419) (undo-tree-id430 . -3419) (undo-tree-id431 . -3419) (undo-tree-id432 . -1) (undo-tree-id433 . -3419) (undo-tree-id434 . -3338) (undo-tree-id435 . -3338) (undo-tree-id436 . -2599) (undo-tree-id437 . -1924) (undo-tree-id438 . -862) (undo-tree-id439 . -156) (t 26976 57734 0 0)) nil (26976 57844 170689 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 57844 170671 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11734 . 11735) (nil fontified nil 8128 . 11735) (8128 . 11735)) nil (26976 57844 170667 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec stratégie de conteneurisation + ROLLBACK Bas-Niveau.
   CORRECTION CRITIQUE 25P02 : On utilise cl-postgres:exec-query pour le ROLLBACK.
   Cela évite la 'Préparation' automatique de Postmodern qui est interdite dans une transaction annulée.\"
  (format t \"~&[DB-TX] START Logic (Low-Level-Fix).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      (let ((captured-result nil)
            (captured-error nil)
            (tx-success nil))

        ;; 1. ZONE DANGEREUSE (DB)
        (handler-case
            (ensure-connection
              (block inner-db-scope
                (handler-bind ((error (lambda (c)
                                        (format t \"~&[DB-TX] ! Caught inside: ~A~%\" c)
                                        (setf captured-error c)
                                        
                                        ;; FIX 25P02 : Utilisation directe de cl-postgres
                                        ;; On bypass 'postmodern:execute' qui tente de préparer le statement.
                                        (ignore-errors 
                                          #+postmodern 
                                          (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                                          #-postmodern 
                                          (lumen.data.db:exec \"ROLLBACK\"))
                                        
                                        ;; Sortie propre via NIL (pas d'erreur lancée)
                                        (return-from inner-db-scope nil))))
                  
                  ;; Démarrage Transaction (Bas niveau aussi pour symétrie)
                  #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                  #-postmodern (lumen.data.db:exec \"BEGIN\")
                  
                  (let ((res (funcall thunk)))
                    ;; Commit
                    #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                    #-postmodern (lumen.data.db:exec \"COMMIT\")
                    
                    (setf captured-result res
                          tx-success t)))))
          
          ;; Erreur de connexion pure
          (error (c)
            (setf captured-error c)))

        ;; 2. ZONE SÛRE (Safe Zone - Pile propre)
        (cond
          (tx-success
           (format t \"~&[DB-TX] Success -> Returning result.~%\")
           (return captured-result))
          
          (captured-error
           (let* ((err captured-error)
                  (is-app-err (typep err 'lumen.core.error:application-error))
                  (mapped (unless is-app-err (lumen.data.errors:map-db-error err))))
             
             (cond
               ;; ERREUR MÉTIER : Sanitisation (String) pour éviter le SIMPLE-CONTROL-ERROR
               (is-app-err
                (format t \"~&[DB-TX] Re-signaling FRESH error string.~%\")
                (error \"~A\" err))
               
               ;; RETRY
               ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                (incf attempt)
                (when (plusp sleep-ms) 
                  (sleep (/ (max 0 sleep-ms) 1000.0))))
               
               ;; FATAL
               (t
                (format t \"~&[DB-TX] Fatal Error. Re-signaling FRESH string.~%\")
                (error \"DB Error: ~A\" err))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 315 (face font-lock-doc-face fontified t) 315 328 (fontified t) 328 370 (face font-lock-string-face fontified t) 370 378 (fontified t) 378 381 (face font-lock-keyword-face fontified t) 381 401 (fontified t) 401 405 (face font-lock-keyword-face fontified t) 405 422 (fontified t) 422 459 (face font-lock-string-face fontified t) 459 483 (fontified t) 483 486 (face font-lock-keyword-face fontified t) 486 582 (fontified t) 582 585 (face font-lock-comment-delimiter-face fontified t) 585 609 (face font-lock-comment-face fontified t) 609 618 (fontified t) 618 630 (face font-lock-keyword-face fontified t) 630 677 (fontified t) 677 682 (face font-lock-keyword-face fontified t) 682 715 (fontified t) 715 727 (face font-lock-keyword-face fontified t) 727 730 (fontified t) 730 735 (face font-lock-warning-face fontified t) 735 737 (fontified t) 737 743 (face font-lock-keyword-face fontified t) 743 798 (fontified t) 798 831 (face font-lock-string-face fontified t) 831 980 (fontified t) 980 983 (face font-lock-comment-delimiter-face fontified t) 983 1030 (face font-lock-comment-face fontified t) 1030 1070 (fontified t) 1070 1073 (face font-lock-comment-delimiter-face fontified t) 1073 1140 (face font-lock-comment-face fontified t) 1140 1181 (fontified t) 1181 1194 (face font-lock-keyword-face fontified t) 1194 1340 (fontified t) 1340 1350 (face font-lock-string-face fontified t) 1350 1394 (fontified t) 1394 1470 (face slime-reader-conditional-face fontified t) 1470 1480 (face slime-reader-conditional-face fontified t) 1480 1481 (face slime-reader-conditional-face fontified t) 1481 1501 (fontified t) 1501 1524 (fontified t) 1524 1564 (fontified t) 1564 1567 (face font-lock-comment-delimiter-face fontified t) 1567 1611 (face font-lock-comment-face fontified t) 1611 1652 (fontified t) 1652 1663 (face font-lock-keyword-face fontified t) 1663 1724 (fontified t) 1724 1727 (face font-lock-comment-delimiter-face fontified t) 1727 1782 (face font-lock-comment-face fontified t) 1782 1859 (fontified t) 1859 1866 (face font-lock-string-face fontified t) 1866 1886 (fontified t) 1886 1919 (face slime-reader-conditional-face fontified t) 1919 1926 (face slime-reader-conditional-face fontified t) 1926 1927 (face slime-reader-conditional-face fontified t) 1927 1966 (fontified t) 1966 1969 (face font-lock-keyword-face fontified t) 1969 2014 (fontified t) 2014 2017 (face font-lock-comment-delimiter-face fontified t) 2017 2024 (face font-lock-comment-face fontified t) 2024 2103 (fontified t) 2103 2111 (face font-lock-string-face fontified t) 2111 2133 (fontified t) 2133 2166 (face slime-reader-conditional-face fontified t) 2166 2174 (face slime-reader-conditional-face fontified t) 2174 2175 (face slime-reader-conditional-face fontified t) 2175 2308 (fontified t) 2308 2311 (face font-lock-comment-delimiter-face fontified t) 2311 2336 (face font-lock-comment-face fontified t) 2336 2347 (fontified t) 2347 2352 (face font-lock-warning-face fontified t) 2352 2404 (fontified t) 2404 2407 (face font-lock-comment-delimiter-face fontified t) 2407 2446 (face font-lock-comment-face fontified t) 2446 2455 (fontified t) 2455 2459 (face font-lock-keyword-face fontified t) 2459 2503 (fontified t) 2503 2545 (face font-lock-string-face fontified t) 2545 2559 (fontified t) 2559 2565 (face font-lock-keyword-face fontified t) 2565 2633 (fontified t) 2633 2637 (face font-lock-keyword-face fontified t) 2637 2766 (fontified t) 2766 2772 (face font-lock-keyword-face fontified t) 2772 2852 (fontified t) 2852 2856 (face font-lock-keyword-face fontified t) 2856 2872 (fontified t) 2872 2875 (face font-lock-comment-delimiter-face fontified t) 2875 2949 (face font-lock-comment-face fontified t) 2949 3002 (fontified t) 3002 3048 (face font-lock-string-face fontified t) 3048 3067 (fontified t) 3067 3072 (face font-lock-warning-face fontified t) 3072 3073 (fontified t) 3073 3077 (face font-lock-string-face fontified t) 3077 3115 (fontified t) 3115 3118 (face font-lock-comment-delimiter-face fontified t) 3118 3124 (face font-lock-comment-face fontified t) 3124 3247 (fontified t) 3247 3289 (face font-lock-string-face fontified t) 3289 3339 (fontified t) 3339 3343 (face font-lock-keyword-face fontified t) 3343 3449 (fontified t) 3449 3452 (face font-lock-comment-delimiter-face fontified t) 3452 3458 (face font-lock-comment-face fontified t) 3458 3502 (fontified t) 3502 3555 (face font-lock-string-face fontified t) 3555 3574 (fontified t) 3574 3579 (face font-lock-warning-face fontified t) 3579 3580 (fontified t) 3580 3594 (face font-lock-string-face fontified t) 3594 3607 (fontified t) 3607 3608 (rear-nonsticky t fontified t)) . 8127) (undo-tree-id440 . -3608) (undo-tree-id441 . -2824) (undo-tree-id442 . -3608) (undo-tree-id443 . -3608) (undo-tree-id444 . -1) (undo-tree-id445 . -3608) (undo-tree-id446 . -2790) (undo-tree-id447 . -2075) (undo-tree-id448 . -991) (undo-tree-id449 . -315) (undo-tree-id450 . -315) (undo-tree-id451 . -315) (undo-tree-id452 . -315) (undo-tree-id453 . -315) (t 26976 57844 0 0)) nil (26976 57984 176298 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 57984 176281 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11927 . 11928) (nil fontified nil 8128 . 11928) (8128 . 11928)) nil (26976 57984 176277 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec une isolation totale des erreurs.
   Utilise HANDLER-CASE à l'intérieur de la connexion pour garantir
   que la pile est propre AVANT le Rollback, et renvoie des données simples (pas de sauts).\"
  (format t \"~&[DB-TX] START Logic (Strict-Isolation).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      (let ((outcome 
             ;; 1. On ouvre la connexion
             (ensure-connection
               ;; 2. On protège TOUT le bloc interne avec HANDLER-CASE.
               ;; C'est crucial : cela capture l'erreur et déroule la pile interne
               ;; SANS sortir de 'ensure-connection'.
               (handler-case
                   (progn
                     ;; START TX
                     (format t \"~&[DB-TX] BEGIN~%\")
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                     #-postmodern (lumen.data.db:exec \"BEGIN\")
                     
                     (let ((res (funcall thunk)))
                       ;; COMMIT
                       (format t \"~&[DB-TX] COMMIT~%\")
                       #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                       #-postmodern (lumen.data.db:exec \"COMMIT\")
                       ;; On retourne un objet Succès pur
                       (list :success res)))
                 
                 ;; 3. CATCH INTERNE : La pile est déroulée jusqu'ici, mais la connexion est encore ouverte.
                 (error (c)
                   (format t \"~&[DB-TX] Caught inside: ~A~%\" c)
                   
                   ;; ROLLBACK BAS-NIVEAU (Pour éviter erreur 25P02)
                   (format t \"~&[DB-TX] ROLLBACK~%\")
                   (ignore-errors 
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                     #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                   
                   ;; 4. EXTRACTION SÉCURISÉE
                   ;; On extrait le message MAINTENANT pour ne garder aucune référence
                   ;; à des objets complexes qui pourraient casser plus tard.
                   (let ((msg (format nil \"~A\" c))
                         (is-app (typep c 'lumen.core.error:application-error)))
                     (list :error c msg is-app)))))))

      ;; 5. ZONE SÛRE (Safe Zone)
      ;; La connexion est fermée. Le bloc ensure-connection est fini.
      ;; Nous avons juste une liste 'outcome' entre les mains.
      (destructuring-bind (status &optional err msg is-app) outcome
        
        (if (eq status :success)
            ;; SUCCÈS
            (return err) ;; err contient le résultat 'res' ici (voir structure list plus haut)
            
            ;; ERREUR
            (let ((mapped (unless is-app (lumen.data.errors:map-db-error err))))
              (cond
                ;; CAS A : Erreur Métier -> On recrée une erreur propre
                (is-app
                 (format t \"~&[DB-TX] Re-signaling App Error (Clean).~%\")
                 ;; On lance une simple error avec le message original pour éviter tout crash de pile
                 (error msg))
                
                ;; CAS B : Retry
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                 (incf attempt)
                 (when (plusp sleep-ms) 
                   (sleep (/ (max 0 sleep-ms) 1000.0))))
                
                ;; CAS C : Fatal
                (t
                 (format t \"~&[DB-TX] Fatal Error. Re-signaling (Clean).~%\")
                 (error \"DB Error: ~A\" msg))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 54 (fontified t) 54 268 (face font-lock-doc-face fontified t) 268 281 (fontified t) 281 326 (face font-lock-string-face fontified t) 326 334 (fontified t) 334 337 (face font-lock-keyword-face fontified t) 337 357 (fontified t) 357 361 (face font-lock-keyword-face fontified t) 361 378 (fontified t) 378 415 (face font-lock-string-face fontified t) 415 439 (fontified t) 439 442 (face font-lock-keyword-face fontified t) 442 467 (fontified t) 467 470 (face font-lock-comment-delimiter-face fontified t) 470 495 (face font-lock-comment-face fontified t) 495 542 (fontified t) 542 545 (face font-lock-comment-delimiter-face fontified t) 545 599 (face font-lock-comment-face fontified t) 599 614 (fontified t) 614 617 (face font-lock-comment-delimiter-face fontified t) 617 682 (face font-lock-comment-face fontified t) 682 697 (fontified t) 697 700 (face font-lock-comment-delimiter-face fontified t) 700 736 (face font-lock-comment-face fontified t) 736 752 (fontified t) 752 764 (face font-lock-keyword-face fontified t) 764 785 (fontified t) 785 790 (face font-lock-keyword-face fontified t) 790 812 (fontified t) 812 815 (face font-lock-comment-delimiter-face fontified t) 815 824 (face font-lock-comment-face fontified t) 824 855 (fontified t) 855 874 (face font-lock-string-face fontified t) 874 956 (fontified t) 956 963 (face font-lock-string-face fontified t) 963 986 (fontified t) 986 1019 (face slime-reader-conditional-face fontified t) 1019 1026 (face slime-reader-conditional-face fontified t) 1026 1027 (face slime-reader-conditional-face fontified t) 1027 1072 (fontified t) 1072 1075 (face font-lock-keyword-face fontified t) 1075 1123 (fontified t) 1123 1126 (face font-lock-comment-delimiter-face fontified t) 1126 1133 (face font-lock-comment-face fontified t) 1133 1166 (fontified t) 1166 1186 (face font-lock-string-face fontified t) 1186 1270 (fontified t) 1270 1278 (face font-lock-string-face fontified t) 1278 1303 (fontified t) 1303 1336 (face slime-reader-conditional-face fontified t) 1336 1344 (face slime-reader-conditional-face fontified t) 1344 1345 (face slime-reader-conditional-face fontified t) 1345 1369 (fontified t) 1369 1372 (face font-lock-comment-delimiter-face fontified t) 1372 1404 (face font-lock-comment-face fontified t) 1404 1433 (fontified t) 1433 1441 (face font-lock-builtin-face fontified t) 1441 1484 (fontified t) 1484 1487 (face font-lock-comment-delimiter-face fontified t) 1487 1501 (face font-lock-comment-face fontified t) 1501 1576 (face font-lock-comment-face fontified t) 1576 1594 (fontified t) 1594 1599 (face font-lock-warning-face fontified t) 1599 1633 (fontified t) 1633 1664 (face font-lock-string-face fontified t) 1664 1707 (fontified t) 1707 1710 (face font-lock-comment-delimiter-face fontified t) 1710 1757 (face font-lock-comment-face fontified t) 1757 1786 (fontified t) 1786 1808 (face font-lock-string-face fontified t) 1808 1830 (fontified t) 1830 1843 (face font-lock-keyword-face fontified t) 1843 1925 (fontified t) 1925 1935 (face font-lock-string-face fontified t) 1935 1958 (fontified t) 1958 1991 (face slime-reader-conditional-face fontified t) 1991 2001 (face slime-reader-conditional-face fontified t) 2001 2002 (face slime-reader-conditional-face fontified t) 2002 2043 (fontified t) 2043 2046 (face font-lock-comment-delimiter-face fontified t) 2046 2070 (face font-lock-comment-face fontified t) 2070 2089 (fontified t) 2089 2092 (face font-lock-comment-delimiter-face fontified t) 2092 2157 (face font-lock-comment-face fontified t) 2157 2176 (fontified t) 2176 2179 (face font-lock-comment-delimiter-face fontified t) 2179 2235 (face font-lock-comment-face fontified t) 2235 2255 (fontified t) 2255 2258 (face font-lock-keyword-face fontified t) 2258 2277 (fontified t) 2277 2281 (face font-lock-string-face fontified t) 2281 2394 (fontified t) 2394 2400 (face font-lock-builtin-face fontified t) 2400 2428 (fontified t) 2428 2431 (face font-lock-comment-delimiter-face fontified t) 2431 2456 (face font-lock-comment-face fontified t) 2456 2462 (fontified t) 2462 2465 (face font-lock-comment-delimiter-face fontified t) 2465 2526 (face font-lock-comment-face fontified t) 2526 2532 (fontified t) 2532 2535 (face font-lock-comment-delimiter-face fontified t) 2535 2589 (face font-lock-comment-face fontified t) 2589 2596 (fontified t) 2596 2614 (face font-lock-keyword-face fontified t) 2614 2623 (fontified t) 2623 2632 (face font-lock-type-face fontified t) 2632 2675 (fontified t) 2675 2677 (face font-lock-keyword-face fontified t) 2677 2689 (fontified t) 2689 2697 (face font-lock-builtin-face fontified t) 2697 2711 (fontified t) 2711 2714 (face font-lock-comment-delimiter-face fontified t) 2714 2721 (face font-lock-comment-face fontified t) 2721 2734 (fontified t) 2734 2740 (face font-lock-keyword-face fontified t) 2740 2746 (fontified t) 2746 2749 (face font-lock-comment-delimiter-face fontified t) 2749 2816 (face font-lock-comment-face fontified t) 2816 2841 (fontified t) 2841 2844 (face font-lock-comment-delimiter-face fontified t) 2844 2851 (face font-lock-comment-face fontified t) 2851 2864 (fontified t) 2864 2867 (face font-lock-keyword-face fontified t) 2867 2878 (fontified t) 2878 2884 (face font-lock-keyword-face fontified t) 2884 2947 (fontified t) 2947 2951 (face font-lock-keyword-face fontified t) 2951 2968 (fontified t) 2968 2971 (face font-lock-comment-delimiter-face fontified t) 2971 3024 (face font-lock-comment-face fontified t) 3024 3075 (fontified t) 3075 3120 (face font-lock-string-face fontified t) 3120 3139 (fontified t) 3139 3142 (face font-lock-comment-delimiter-face fontified t) 3142 3224 (face font-lock-comment-face fontified t) 3224 3242 (fontified t) 3242 3247 (face font-lock-warning-face fontified t) 3247 3287 (fontified t) 3287 3290 (face font-lock-comment-delimiter-face fontified t) 3290 3304 (face font-lock-comment-face fontified t) 3304 3429 (fontified t) 3429 3471 (face font-lock-string-face fontified t) 3471 3523 (fontified t) 3523 3527 (face font-lock-keyword-face fontified t) 3527 3636 (fontified t) 3636 3639 (face font-lock-comment-delimiter-face fontified t) 3639 3653 (face font-lock-comment-face fontified t) 3653 3699 (fontified t) 3699 3747 (face font-lock-string-face fontified t) 3747 3767 (fontified t) 3767 3772 (face font-lock-warning-face fontified t) 3772 3773 (fontified t) 3773 3787 (face font-lock-string-face fontified t) 3787 3800 (fontified t) 3800 3801 (rear-nonsticky t fontified t)) . 8127) (undo-tree-id454 . -3801) (undo-tree-id455 . -2932) (undo-tree-id456 . -3801) (undo-tree-id457 . -3801) (undo-tree-id458 . -1) (undo-tree-id459 . -3801) (undo-tree-id460 . -2023) (undo-tree-id461 . -1099) (undo-tree-id462 . -321) (t 26976 57984 0 0)) nil (26976 58051 972172 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 58051 972156 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10437 . 10438) (nil fontified nil 10422 . 10438) (nil fontified nil 10417 . 10422) (nil fontified nil 10404 . 10417) (nil fontified nil 10395 . 10404) (nil fontified nil 10358 . 10395) (nil fontified nil 10350 . 10358) (nil fontified nil 10330 . 10350) (nil fontified nil 10325 . 10330) (nil fontified nil 10216 . 10325) (nil fontified nil 10198 . 10216) (nil fontified nil 10189 . 10198) (nil fontified nil 10187 . 10189) (nil fontified nil 10157 . 10187) (nil fontified nil 10125 . 10157) (nil fontified nil 10122 . 10125) (nil fontified nil 10005 . 10122) (nil fontified nil 9980 . 10005) (nil fontified nil 9979 . 9980) (nil fontified nil 9963 . 9979) (nil fontified nil 9939 . 9963) (nil fontified nil 9935 . 9939) (nil fontified nil 9923 . 9935) (nil fontified nil 9848 . 9923) (nil fontified nil 9845 . 9848) (nil fontified nil 9834 . 9845) (nil fontified nil 9802 . 9834) (nil fontified nil 9799 . 9802) (nil fontified nil 9787 . 9799) (nil fontified nil 9777 . 9787) (nil fontified nil 9755 . 9777) (nil fontified nil 9745 . 9755) (nil fontified nil 9742 . 9745) (nil fontified nil 9673 . 9742) (nil fontified nil 9669 . 9673) (nil fontified nil 9657 . 9669) (nil fontified nil 9653 . 9657) (nil fontified nil 9630 . 9653) (nil fontified nil 9624 . 9630) (nil fontified nil 9602 . 9624) (nil fontified nil 9573 . 9602) (nil fontified nil 9570 . 9573) (nil fontified nil 9545 . 9570) (nil fontified nil 9539 . 9545) (nil fontified nil 9526 . 9539) (nil fontified nil 9518 . 9526) (nil fontified nil 9498 . 9518) (nil fontified nil 9493 . 9498) (nil fontified nil 9484 . 9493) (nil fontified nil 9437 . 9484) (nil fontified nil 9434 . 9437) (nil fontified nil 9404 . 9434) (nil fontified nil 9395 . 9404) (nil fontified nil 9361 . 9395) (nil fontified nil 9355 . 9361) (nil fontified nil 9227 . 9355) (nil fontified nil 9225 . 9227) (nil fontified nil 9161 . 9225) (nil fontified nil 9158 . 9161) (nil fontified nil 9116 . 9158) (nil fontified nil 9076 . 9116) (nil fontified nil 9073 . 9076) (nil fontified nil 9025 . 9073) (nil fontified nil 9015 . 9025) (nil fontified nil 8941 . 9015) (nil fontified nil 8880 . 8941) (nil fontified nil 8877 . 8880) (nil fontified nil 8865 . 8877) (nil fontified nil 8804 . 8865) (nil fontified nil 8801 . 8804) (nil fontified nil 8772 . 8801) (nil fontified nil 8719 . 8772) (nil fontified nil 8646 . 8719) (nil fontified nil 8619 . 8646) (nil fontified nil 8469 . 8619) (nil fontified nil 8461 . 8469) (nil fontified nil 8439 . 8461) (nil fontified nil 8421 . 8439) (nil fontified nil 8418 . 8421) (nil fontified nil 8403 . 8418) (nil fontified nil 8391 . 8403) (nil fontified nil 8361 . 8391) (nil fontified nil 8342 . 8361) (nil fontified nil 8334 . 8342) (nil fontified nil 8330 . 8334) (nil fontified nil 8310 . 8330) (nil fontified nil 8307 . 8310) (nil fontified nil 8303 . 8307) (nil fontified nil 8181 . 8303) (nil fontified nil 8153 . 8181) (nil fontified nil 8135 . 8153) (nil fontified nil 8134 . 8135) (nil fontified nil 8129 . 8134) (nil fontified nil 8128 . 8129) (8128 . 10438)) nil (26976 58051 972150 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -10437) (undo-tree-id463 . -1) (undo-tree-id464 . -1) (undo-tree-id465 . -1) (undo-tree-id466 . -1) 10438 (t 26976 58051 0 0)) nil (26976 58053 26932 0) 0 nil])
([nil nil ((#("
(defun exec (sql &rest params)
  (format t \"~&[DB-EXEC] SQL: ~S~%\" sql) ;; Log simple sans check de transaction
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (lumen.data.prepare:get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (lumen.data.prepare:get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
              (lumen.data.metrics:record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      ;; Laisse passer les erreurs applicatives pour le tunnel
      (lumen.core.error:application-error (c) (error c))
      (condition (c) (translate-db-error c)))))
" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 12 (face font-lock-function-name-face fontified t) 12 18 (fontified t) 18 23 (face font-lock-type-face fontified t) 23 44 (fontified t) 44 67 (face font-lock-string-face fontified t) 67 73 (fontified t) 73 76 (face font-lock-comment-delimiter-face fontified t) 76 113 (face font-lock-comment-face fontified t) 113 116 (fontified t) 116 120 (face font-lock-keyword-face fontified t) 120 142 (fontified t) 142 148 (face font-lock-keyword-face fontified t) 148 188 (fontified t) 188 193 (face font-lock-builtin-face fontified t) 193 194 (fontified t) 194 202 (face font-lock-builtin-face fontified t) 202 204 (fontified t) 204 209 (face font-lock-builtin-face fontified t) 209 244 (fontified t) 244 246 (face font-lock-keyword-face fontified t) 246 300 (fontified t) 300 302 (face font-lock-keyword-face fontified t) 302 367 (fontified t) 367 378 (face font-lock-builtin-face fontified t) 378 467 (fontified t) 467 479 (face font-lock-keyword-face fontified t) 479 489 (fontified t) 489 511 (face font-lock-keyword-face fontified t) 511 536 (fontified t) 536 540 (face font-lock-keyword-face fontified t) 540 612 (fontified t) 612 623 (face font-lock-string-face fontified t) 623 676 (fontified t) 676 678 (face font-lock-keyword-face fontified t) 678 710 (fontified t) 710 714 (face font-lock-keyword-face fontified t) 714 763 (fontified t) 763 770 (face font-lock-builtin-face fontified t) 770 771 (fontified t) 771 777 (face font-lock-builtin-face fontified t) 777 860 (fontified t) 860 862 (face font-lock-keyword-face fontified t) 862 899 (fontified t) 899 903 (face font-lock-keyword-face fontified t) 903 951 (fontified t) 951 958 (face font-lock-builtin-face fontified t) 958 959 (fontified t) 959 964 (face font-lock-builtin-face fontified t) 964 1078 (fontified t) 1078 1081 (face font-lock-keyword-face fontified t) 1081 1241 (fontified t) 1241 1265 (fontified t) 1265 1280 (fontified t) 1280 1284 (face font-lock-keyword-face fontified t) 1284 1408 (fontified t) 1408 1415 (face font-lock-builtin-face fontified t) 1415 1421 (fontified t) 1421 1430 (face font-lock-builtin-face fontified t) 1430 1485 (fontified t) 1485 1488 (face font-lock-comment-delimiter-face fontified t) 1488 1501 (face font-lock-comment-face fontified t) 1501 1542 (face font-lock-comment-face fontified t) 1542 1589 (fontified t) 1589 1594 (face font-lock-warning-face fontified t) 1594 1645 (fontified t) 1645 1646 (fontified t rear-nonsticky t) 1646 1647 (fontified t)) . -15314) (undo-tree-id470 . -1) (undo-tree-id471 . -1647) (undo-tree-id472 . -194) (undo-tree-id473 . -1) (undo-tree-id474 . -1265) (undo-tree-id475 . -1178) (undo-tree-id476 . -780) (undo-tree-id477 . -1647) 16961 (t 26976 58053 0 0)) nil (26976 58116 448057 0) 0 nil])
([nil nil ((15314 . 15315)) nil (26976 58116 448051 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 17876 . 17877) (nil fontified nil 17809 . 17877) (nil fontified nil 17804 . 17809) (nil fontified nil 17749 . 17804) (nil fontified nil 17714 . 17749) (nil fontified nil 17711 . 17714) (nil fontified nil 17705 . 17711) (nil fontified nil 17642 . 17705) (nil fontified nil 17639 . 17642) (nil fontified nil 17570 . 17639) (nil fontified nil 17561 . 17570) (nil fontified nil 17555 . 17561) (nil fontified nil 17548 . 17555) (nil fontified nil 17407 . 17548) (nil fontified nil 17403 . 17407) (nil fontified nil 17180 . 17403) (nil fontified nil 17177 . 17180) (nil fontified nil 17164 . 17177) (nil fontified nil 17142 . 17164) (nil fontified nil 17139 . 17142) (nil fontified nil 16989 . 17139) (nil fontified nil 16984 . 16989) (nil fontified nil 16983 . 16984) (nil fontified nil 16976 . 16983) (nil fontified nil 16947 . 16976) (nil fontified nil 16943 . 16947) (nil fontified nil 16926 . 16943) (nil fontified nil 16862 . 16926) (nil fontified nil 16859 . 16862) (nil fontified nil 16826 . 16859) (nil fontified nil 16782 . 16826) (nil fontified nil 16780 . 16782) (nil fontified nil 16697 . 16780) (nil fontified nil 16691 . 16697) (nil fontified nil 16690 . 16691) (nil fontified nil 16683 . 16690) (nil fontified nil 16653 . 16683) (nil fontified nil 16649 . 16653) (nil fontified nil 16632 . 16649) (nil fontified nil 16591 . 16632) (nil fontified nil 16588 . 16591) (nil fontified nil 16557 . 16588) (nil fontified nil 16555 . 16557) (nil fontified nil 16489 . 16555) (nil fontified nil 16478 . 16489) (nil fontified nil 16406 . 16478) (nil fontified nil 16402 . 16406) (nil fontified nil 16377 . 16402) (nil fontified nil 16355 . 16377) (nil fontified nil 16345 . 16355) (nil fontified nil 16333 . 16345) (nil fontified nil 16316 . 16333) (nil fontified nil 16297 . 16316) (nil fontified nil 16276 . 16297) (nil fontified nil 16257 . 16276) (nil fontified nil 16159 . 16257) (nil fontified nil 16148 . 16159) (nil fontified nil 16116 . 16148) (nil fontified nil 16093 . 16116) (nil fontified nil 16090 . 16093) (nil fontified nil 16038 . 16090) (nil fontified nil 16036 . 16038) (nil fontified nil 15982 . 16036) (nil fontified nil 15980 . 15982) (nil fontified nil 15964 . 15980) (nil fontified nil 15916 . 15964) (nil fontified nil 15913 . 15916) (nil fontified nil 15847 . 15913) (nil fontified nil 15842 . 15847) (nil fontified nil 15840 . 15842) (nil fontified nil 15832 . 15840) (nil fontified nil 15831 . 15832) (nil fontified nil 15826 . 15831) (nil fontified nil 15721 . 15826) (nil fontified nil 15715 . 15721) (nil fontified nil 15686 . 15715) (nil fontified nil 15602 . 15686) (nil fontified nil 15599 . 15602) (nil fontified nil 15590 . 15599) (nil fontified nil 15538 . 15590) (nil fontified nil 15535 . 15538) (nil fontified nil 15533 . 15535) (nil fontified nil 15529 . 15533) (nil fontified nil 15517 . 15529) (nil fontified nil 15499 . 15517) (nil fontified nil 15483 . 15499) (nil fontified nil 15348 . 15483) (nil fontified nil 15337 . 15348) (nil fontified nil 15332 . 15337) (nil fontified nil 15326 . 15332) (nil fontified nil 15322 . 15326) (nil fontified nil 15321 . 15322) (nil fontified nil 15316 . 15321) (nil fontified nil 15315 . 15316) (15315 . 17877)) nil (26976 58116 448048 0) 0 nil])
([nil nil ((17877 . 17878)) nil (26976 58116 448039 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -17877) (undo-tree-id467 . -1) (undo-tree-id468 . 1) (undo-tree-id469 . -1) 17878) nil (26976 58116 448035 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Logique d'exécution transactionnelle avec retries.
   Isole le contexte pour éviter les erreurs de pile (CONTROL-ERROR).\"
  (let ((attempt 0))
    (loop
      (multiple-value-bind (outcome payload)
          (handler-case
              ;; Essai d'exécution
              (values :success
                      (multiple-value-list
                       (ensure-connection
                         #+postmodern
                         (postmodern:with-transaction ()
                           (funcall thunk))
                         #-postmodern
                         (funcall thunk))))
            
            ;; 1. Erreur Métier : On capture UNIQUEMENT le message (String)
            ;; Cela détruit tout lien avec l'objet condition problématique.
            (lumen.core.error:application-error (c)
              (values :app-error (princ-to-string c)))
            
            ;; 2. Erreur DB : On capture l'objet mappé
            (condition (c)
              (let ((mapped (lumen.data.errors:map-db-error c)))
                (if (and (< attempt retries)
                         (lumen.data.errors:retryable-db-error-p mapped))
                    (values :retry nil)
                    (values :db-error mapped)))))
        
        ;; ANALYSE DU RÉSULTAT (Hors du contexte protégé)
        (ecase outcome
          (:success
           (return (values-list payload))) ;; Retour simple du LOOP (safe)
          
          (:retry
           (incf attempt)
           (when (plusp sleep-ms)
             (sleep (/ (max 0 sleep-ms) 1000.0)))) ;; On boucle
          
          (:app-error
           ;; On recrée une erreur vierge ici
           ;; Note: On utilise find-symbol pour ne pas dépendre de QALM à la compilation
           (let* ((sym (or (find-symbol \"BUSINESS-ERROR\" \"QALM.BACKEND.CORE.ERROR\")
                           'lumen.core.error:application-error))
                  (msg payload)
                  ;; Nettoyage du préfixe si présent
                  (clean-msg (if (search \"Business Error: \" msg)
                                 (subseq msg 16)
                                 msg)))
             (error (make-instance sym :message clean-msg))))
          
          (:db-error
           (error payload)))))))
  " 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 23 (face font-lock-function-name-face fontified t) 23 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 175 (face font-lock-doc-face fontified t) 175 179 (fontified t) 179 182 (face font-lock-keyword-face fontified t) 182 202 (fontified t) 202 206 (face font-lock-keyword-face fontified t) 206 214 (fontified t) 214 233 (face font-lock-keyword-face fontified t) 233 263 (fontified t) 263 275 (face font-lock-keyword-face fontified t) 275 290 (fontified t) 290 293 (face font-lock-comment-delimiter-face fontified t) 293 311 (face font-lock-comment-face fontified t) 311 333 (fontified t) 333 341 (face font-lock-builtin-face fontified t) 341 491 (fontified t) 491 518 (face font-lock-keyword-face fontified t) 518 591 (fontified t) 591 644 (face slime-reader-conditional-face fontified t) 644 673 (fontified t) 673 676 (face font-lock-comment-delimiter-face fontified t) 676 737 (face font-lock-comment-face fontified t) 737 749 (fontified t) 749 752 (face font-lock-comment-delimiter-face fontified t) 752 813 (face font-lock-comment-face fontified t) 813 887 (fontified t) 887 897 (face font-lock-builtin-face fontified t) 897 945 (fontified t) 945 948 (face font-lock-comment-delimiter-face fontified t) 948 988 (face font-lock-comment-face fontified t) 988 1030 (fontified t) 1030 1033 (face font-lock-keyword-face fontified t) 1033 1097 (fontified t) 1097 1099 (face font-lock-keyword-face fontified t) 1099 1227 (fontified t) 1227 1233 (face font-lock-builtin-face fontified t) 1233 1267 (fontified t) 1267 1276 (face font-lock-builtin-face fontified t) 1276 1306 (fontified t) 1306 1309 (face font-lock-comment-delimiter-face fontified t) 1309 1356 (face font-lock-comment-face fontified t) 1356 1365 (fontified t) 1365 1370 (face font-lock-keyword-face fontified t) 1370 1390 (fontified t) 1390 1398 (face font-lock-builtin-face fontified t) 1398 1411 (fontified t) 1411 1417 (face font-lock-keyword-face fontified t) 1417 1442 (fontified t) 1442 1445 (face font-lock-comment-delimiter-face fontified t) 1445 1474 (face font-lock-comment-face fontified t) 1474 1496 (fontified t) 1496 1502 (face font-lock-builtin-face fontified t) 1502 1523 (fontified t) 1523 1529 (fontified t) 1529 1541 (fontified t) 1541 1545 (face font-lock-keyword-face fontified t) 1545 1614 (fontified t) 1614 1617 (face font-lock-comment-delimiter-face fontified t) 1617 1627 (face font-lock-comment-face fontified t) 1627 1649 (fontified t) 1649 1659 (face font-lock-builtin-face fontified t) 1659 1671 (fontified t) 1671 1674 (face font-lock-comment-delimiter-face fontified t) 1674 1706 (face font-lock-comment-face fontified t) 1706 1717 (fontified t) 1717 1720 (face font-lock-comment-delimiter-face fontified t) 1720 1795 (face font-lock-comment-face fontified t) 1795 1807 (fontified t) 1807 1811 (face font-lock-keyword-face fontified t) 1811 1835 (fontified t) 1835 1851 (face font-lock-string-face fontified t) 1851 1852 (fontified t) 1852 1877 (face font-lock-string-face fontified t) 1877 1994 (fontified t) 1994 1997 (face font-lock-comment-delimiter-face fontified t) 1997 2029 (face font-lock-comment-face fontified t) 2029 2059 (fontified t) 2059 2061 (face font-lock-keyword-face fontified t) 2061 2070 (fontified t) 2070 2088 (face font-lock-string-face fontified t) 2088 2197 (fontified t) 2197 2202 (face font-lock-warning-face fontified t) 2202 2222 (fontified t) 2222 2230 (face font-lock-builtin-face fontified t) 2230 2267 (fontified t) 2267 2276 (face font-lock-builtin-face fontified t) 2276 2289 (fontified t) 2289 2294 (face font-lock-warning-face fontified t) 2294 2312 (fontified t)) . -8128) (undo-tree-id0 . -2312) (undo-tree-id1 . -1503) (undo-tree-id2 . -2310) 10440 (t 26976 58116 0 0)) nil (26976 58178 394497 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11927 . 11928) (nil fontified nil 8128 . 11928) (8128 . 11928)) nil (26976 58178 394480 0) 0 nil])
([nil nil ((11928 . 11929)) nil (26976 58178 394475 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK avec une isolation totale des erreurs.
   Utilise HANDLER-CASE à l'intérieur de la connexion pour garantir
   que la pile est propre AVANT le Rollback, et renvoie des données simples (pas de sauts).\"
  (format t \"~&[DB-TX] START Logic (Strict-Isolation).~%\")
  
  (let ((attempt 0))
    (loop
      (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
      
      (let ((outcome 
             ;; 1. On ouvre la connexion
             (ensure-connection
               ;; 2. On protège TOUT le bloc interne avec HANDLER-CASE.
               ;; C'est crucial : cela capture l'erreur et déroule la pile interne
               ;; SANS sortir de 'ensure-connection'.
               (handler-case
                   (progn
                     ;; START TX
                     (format t \"~&[DB-TX] BEGIN~%\")
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                     #-postmodern (lumen.data.db:exec \"BEGIN\")
                     
                     (let ((res (funcall thunk)))
                       ;; COMMIT
                       (format t \"~&[DB-TX] COMMIT~%\")
                       #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                       #-postmodern (lumen.data.db:exec \"COMMIT\")
                       ;; On retourne un objet Succès pur
                       (list :success res)))
                 
                 ;; 3. CATCH INTERNE : La pile est déroulée jusqu'ici, mais la connexion est encore ouverte.
                 (error (c)
                   (format t \"~&[DB-TX] Caught inside: ~A~%\" c)
                   
                   ;; ROLLBACK BAS-NIVEAU (Pour éviter erreur 25P02)
                   (format t \"~&[DB-TX] ROLLBACK~%\")
                   (ignore-errors 
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                     #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                   
                   ;; 4. EXTRACTION SÉCURISÉE
                   ;; On extrait le message MAINTENANT pour ne garder aucune référence
                   ;; à des objets complexes qui pourraient casser plus tard.
                   (let ((msg (format nil \"~A\" c))
                         (is-app (typep c 'lumen.core.error:application-error)))
                     (list :error c msg is-app)))))))

      ;; 5. ZONE SÛRE (Safe Zone)
      ;; La connexion est fermée. Le bloc ensure-connection est fini.
      ;; Nous avons juste une liste 'outcome' entre les mains.
      (destructuring-bind (status &optional err msg is-app) outcome
        
        (if (eq status :success)
            ;; SUCCÈS
            (return err) ;; err contient le résultat 'res' ici (voir structure list plus haut)
            
            ;; ERREUR
            (let ((mapped (unless is-app (lumen.data.errors:map-db-error err))))
              (cond
                ;; CAS A : Erreur Métier -> On recrée une erreur propre
                (is-app
                 (format t \"~&[DB-TX] Re-signaling App Error (Clean).~%\")
                 ;; On lance une simple error avec le message original pour éviter tout crash de pile
                 (error msg))
                
                ;; CAS B : Retry
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                 (incf attempt)
                 (when (plusp sleep-ms) 
                   (sleep (/ (max 0 sleep-ms) 1000.0))))
                
                ;; CAS C : Fatal
                (t
                 (format t \"~&[DB-TX] Fatal Error. Re-signaling (Clean).~%\")
                 (error \"DB Error: ~A\" msg))))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil)
                         (retries 0) (sleep-ms 50))
                   &body body)
  (declare (ignore isolation read-only))
  `(call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 267 (face font-lock-doc-face fontified t) 267 280 (fontified t) 280 325 (face font-lock-string-face fontified t) 325 333 (fontified t) 333 336 (face font-lock-keyword-face fontified t) 336 356 (fontified t) 356 360 (face font-lock-keyword-face fontified t) 360 377 (fontified t) 377 414 (face font-lock-string-face fontified t) 414 438 (fontified t) 438 441 (face font-lock-keyword-face fontified t) 441 466 (fontified t) 466 469 (face font-lock-comment-delimiter-face fontified t) 469 494 (face font-lock-comment-face fontified t) 494 541 (fontified t) 541 544 (face font-lock-comment-delimiter-face fontified t) 544 598 (face font-lock-comment-face fontified t) 598 613 (fontified t) 613 616 (face font-lock-comment-delimiter-face fontified t) 616 681 (face font-lock-comment-face fontified t) 681 696 (fontified t) 696 699 (face font-lock-comment-delimiter-face fontified t) 699 735 (face font-lock-comment-face fontified t) 735 751 (fontified t) 751 763 (face font-lock-keyword-face fontified t) 763 784 (fontified t) 784 789 (face font-lock-keyword-face fontified t) 789 811 (fontified t) 811 814 (face font-lock-comment-delimiter-face fontified t) 814 823 (face font-lock-comment-face fontified t) 823 854 (fontified t) 854 873 (face font-lock-string-face fontified t) 873 955 (fontified t) 955 962 (face font-lock-string-face fontified t) 962 985 (fontified t) 985 1018 (face slime-reader-conditional-face fontified t) 1018 1025 (face slime-reader-conditional-face fontified t) 1025 1026 (face slime-reader-conditional-face fontified t) 1026 1071 (fontified t) 1071 1074 (face font-lock-keyword-face fontified t) 1074 1122 (fontified t) 1122 1125 (face font-lock-comment-delimiter-face fontified t) 1125 1132 (face font-lock-comment-face fontified t) 1132 1165 (fontified t) 1165 1185 (face font-lock-string-face fontified t) 1185 1269 (fontified t) 1269 1277 (face font-lock-string-face fontified t) 1277 1302 (fontified t) 1302 1335 (face slime-reader-conditional-face fontified t) 1335 1343 (face slime-reader-conditional-face fontified t) 1343 1344 (face slime-reader-conditional-face fontified t) 1344 1368 (fontified t) 1368 1371 (face font-lock-comment-delimiter-face fontified t) 1371 1403 (face font-lock-comment-face fontified t) 1403 1432 (fontified t) 1432 1440 (face font-lock-builtin-face fontified t) 1440 1483 (fontified t) 1483 1486 (face font-lock-comment-delimiter-face fontified t) 1486 1500 (face font-lock-comment-face fontified t) 1500 1575 (face font-lock-comment-face fontified t) 1575 1593 (fontified t) 1593 1598 (face font-lock-warning-face fontified t) 1598 1632 (fontified t) 1632 1663 (face font-lock-string-face fontified t) 1663 1706 (fontified t) 1706 1709 (face font-lock-comment-delimiter-face fontified t) 1709 1756 (face font-lock-comment-face fontified t) 1756 1785 (fontified t) 1785 1807 (face font-lock-string-face fontified t) 1807 1829 (fontified t) 1829 1842 (face font-lock-keyword-face fontified t) 1842 1924 (fontified t) 1924 1934 (face font-lock-string-face fontified t) 1934 1957 (fontified t) 1957 1990 (face slime-reader-conditional-face fontified t) 1990 2000 (face slime-reader-conditional-face fontified t) 2000 2001 (face slime-reader-conditional-face fontified t) 2001 2042 (fontified t) 2042 2045 (face font-lock-comment-delimiter-face fontified t) 2045 2069 (face font-lock-comment-face fontified t) 2069 2088 (fontified t) 2088 2091 (face font-lock-comment-delimiter-face fontified t) 2091 2156 (face font-lock-comment-face fontified t) 2156 2175 (fontified t) 2175 2178 (face font-lock-comment-delimiter-face fontified t) 2178 2234 (face font-lock-comment-face fontified t) 2234 2254 (fontified t) 2254 2257 (face font-lock-keyword-face fontified t) 2257 2276 (fontified t) 2276 2280 (face font-lock-string-face fontified t) 2280 2393 (fontified t) 2393 2399 (face font-lock-builtin-face fontified t) 2399 2427 (fontified t) 2427 2430 (face font-lock-comment-delimiter-face fontified t) 2430 2455 (face font-lock-comment-face fontified t) 2455 2461 (fontified t) 2461 2464 (face font-lock-comment-delimiter-face fontified t) 2464 2525 (face font-lock-comment-face fontified t) 2525 2531 (fontified t) 2531 2534 (face font-lock-comment-delimiter-face fontified t) 2534 2588 (face font-lock-comment-face fontified t) 2588 2595 (fontified t) 2595 2613 (face font-lock-keyword-face fontified t) 2613 2622 (fontified t) 2622 2631 (face font-lock-type-face fontified t) 2631 2674 (fontified t) 2674 2676 (face font-lock-keyword-face fontified t) 2676 2688 (fontified t) 2688 2696 (face font-lock-builtin-face fontified t) 2696 2710 (fontified t) 2710 2713 (face font-lock-comment-delimiter-face fontified t) 2713 2720 (face font-lock-comment-face fontified t) 2720 2733 (fontified t) 2733 2739 (face font-lock-keyword-face fontified t) 2739 2745 (fontified t) 2745 2748 (face font-lock-comment-delimiter-face fontified t) 2748 2815 (face font-lock-comment-face fontified t) 2815 2840 (fontified t) 2840 2843 (face font-lock-comment-delimiter-face fontified t) 2843 2850 (face font-lock-comment-face fontified t) 2850 2863 (fontified t) 2863 2866 (face font-lock-keyword-face fontified t) 2866 2877 (fontified t) 2877 2883 (face font-lock-keyword-face fontified t) 2883 2946 (fontified t) 2946 2950 (face font-lock-keyword-face fontified t) 2950 2967 (fontified t) 2967 2970 (face font-lock-comment-delimiter-face fontified t) 2970 3023 (face font-lock-comment-face fontified t) 3023 3074 (fontified t) 3074 3075 (face font-lock-string-face fontified t) 3075 3119 (face font-lock-string-face fontified t) 3119 3121 (fontified t) 3121 3138 (fontified t) 3138 3141 (face font-lock-comment-delimiter-face fontified t) 3141 3223 (face font-lock-comment-face fontified t) 3223 3241 (fontified t) 3241 3246 (face font-lock-warning-face fontified t) 3246 3286 (fontified t) 3286 3289 (face font-lock-comment-delimiter-face fontified t) 3289 3303 (face font-lock-comment-face fontified t) 3303 3428 (fontified t) 3428 3470 (face font-lock-string-face fontified t) 3470 3522 (fontified t) 3522 3526 (face font-lock-keyword-face fontified t) 3526 3635 (fontified t) 3635 3638 (face font-lock-comment-delimiter-face fontified t) 3638 3652 (face font-lock-comment-face fontified t) 3652 3698 (fontified t) 3698 3746 (face font-lock-string-face fontified t) 3746 3748 (fontified t) 3748 3766 (fontified t) 3766 3771 (face font-lock-warning-face fontified t) 3771 3772 (fontified t) 3772 3786 (face font-lock-string-face fontified t) 3786 3799 (fontified t) 3799 3800 (rear-nonsticky t fontified t) 3800 3801 (fontified t) 3801 3802 (fontified t) 3802 3803 (fontified t) 3803 3811 (face font-lock-keyword-face fontified t) 3811 3812 (fontified t) 3812 3819 (face font-lock-function-name-face fontified t) 3819 3822 (fontified t) 3822 3826 (face font-lock-type-face fontified t) 3826 3838 (fontified t) 3838 3853 (face font-lock-builtin-face fontified t) 3853 3942 (fontified t) 3942 3947 (face font-lock-type-face fontified t) 3947 3957 (fontified t) 3957 3964 (face font-lock-keyword-face fontified t) 3964 4019 (fontified t) 4019 4025 (face font-lock-keyword-face fontified t) 4025 4057 (fontified t)) . 8128) (undo-tree-id3 . -4057) (undo-tree-id4 . -2931) (undo-tree-id5 . -3801) (undo-tree-id6 . -3801) (t 26976 58178 0 0)) nil (26976 58581 986956 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11253 . 11254) (nil fontified nil 8128 . 11254) (8128 . 11254)) nil (26976 58581 986944 0) 0 nil])
([nil nil ((11254 . 11256)) nil (26976 58581 986943 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11893 . 11894) (nil fontified nil 11256 . 11894) (11256 . 11894)) nil (26976 58581 986939 0) 0 nil])
([nil nil ((#("(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  ;; On utilise MULTIPLE-VALUE-BIND pour récupérer le résultat ET l'erreur potentielle
  `(multiple-value-bind (res err)
       (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)
     (if err
         ;; SI ERREUR : On la lance ici, dans le contexte sain de l'appelant.
         ;; La fonction 'call-with-tx-logic' a complètement fini et nettoyé sa pile.
         (error err)
         ;; SINON : On retourne le résultat
         res)))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 17 (face font-lock-function-name-face fontified t) 17 20 (fontified t) 20 24 (face font-lock-type-face fontified t) 24 36 (fontified t) 36 51 (face font-lock-builtin-face fontified t) 51 142 (fontified t) 142 147 (face font-lock-type-face fontified t) 147 157 (fontified t) 157 164 (face font-lock-keyword-face fontified t) 164 197 (fontified t) 197 200 (face font-lock-comment-delimiter-face fontified t) 200 282 (face font-lock-comment-face fontified t) 282 286 (fontified t) 286 305 (face font-lock-keyword-face fontified t) 305 344 (fontified t) 344 350 (face font-lock-keyword-face fontified t) 350 388 (fontified t) 388 390 (face font-lock-keyword-face fontified t) 390 404 (fontified t) 404 407 (face font-lock-comment-delimiter-face fontified t) 407 473 (face font-lock-comment-face fontified t) 473 482 (fontified t) 482 485 (face font-lock-comment-delimiter-face fontified t) 485 558 (face font-lock-comment-face fontified t) 558 568 (fontified t) 568 573 (face font-lock-warning-face fontified t) 573 588 (fontified t) 588 591 (face font-lock-comment-delimiter-face fontified t) 591 623 (face font-lock-comment-face fontified t) 623 637 (fontified t) 637 638 (rear-nonsticky t fontified t)) . -11256) (undo-tree-id15 . -638) (undo-tree-id16 . -638) (undo-tree-id17 . -638) (undo-tree-id18 . -638) (undo-tree-id19 . -638) (undo-tree-id20 . -638) 11894 (t 26976 58581 0 0)) nil (26976 58853 946303 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11866 . 11867) (nil fontified nil 11256 . 11867) (11256 . 11867)) nil (26976 58853 946299 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute THUNK. Ne lance JAMAIS d'erreur.
   Retourne (values RESULTAT NIL) en cas de succès.
   Retourne (values NIL ERREUR-STRING) en cas d'échec.\"
  (format t \"~&[DB-TX] START Logic (No-Signal-Strategy).~%\")
  
  (let ((attempt 0))
    (block main-loop
      (loop
        (format t \"~&[DB-TX] Loop start. Attempt: ~A~%\" attempt)
        
        (let ((outcome 
               (ensure-connection
                 (handler-case
                     (progn
                       ;; BEGIN
                       #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                       #-postmodern (lumen.data.db:exec \"BEGIN\")
                       
                       (let ((res (funcall thunk)))
                         ;; COMMIT
                         #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                         #-postmodern (lumen.data.db:exec \"COMMIT\")
                         ;; Succès : (:success resultat)
                         (list :success res)))
                   
                   ;; CATCH des erreurs internes
                   (error (c)
                     (format t \"~&[DB-TX] Caught inside: ~A~%\" c)
                     ;; ROLLBACK (Protocol simple query)
                     (ignore-errors 
                       #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                       #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                     
                     ;; On extrait les infos
                     (let ((msg (format nil \"~A\" c))
                           (is-app (typep c 'lumen.core.error:application-error)))
                       ;; Echec : (:error condition msg is-app)
                       (list :error c msg is-app)))))))

        ;; ZONE D'ANALYSE (Pile propre)
        (destructuring-bind (status &optional err msg is-app) outcome
          
          (if (eq status :success)
              ;; SUCCÈS : Retourne (VALEUR, NIL)
              (return-from main-loop (values err nil))
              
              ;; ECHEC
              (let ((mapped (unless is-app (lumen.data.errors:map-db-error err))))
                (cond
                  ;; Cas A : Erreur Métier -> On retourne l'erreur (pas de retry)
                  (is-app
                   (format t \"~&[DB-TX] App Error -> Returning error value.~%\")
                   (return-from main-loop (values nil msg)))
                  
                  ;; Cas B : Retry
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (format t \"~&[DB-TX] Retryable error. Sleeping...~%\")
                   (incf attempt)
                   (when (plusp sleep-ms) 
                     (sleep (/ (max 0 sleep-ms) 1000.0))))
                  
                  ;; Cas C : Fatal -> On retourne l'erreur technique
                  (t
                   (format t \"~&[DB-TX] Fatal Error -> Returning error value.~%\")
                   (return-from main-loop (values nil (format nil \"DB Error: ~A\" msg)))))))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 202 (face font-lock-doc-face fontified t) 202 215 (fontified t) 215 262 (face font-lock-string-face fontified t) 262 270 (fontified t) 270 273 (face font-lock-keyword-face fontified t) 273 293 (fontified t) 293 298 (face font-lock-keyword-face fontified t) 298 316 (fontified t) 316 320 (face font-lock-keyword-face fontified t) 320 339 (fontified t) 339 376 (face font-lock-string-face fontified t) 376 404 (fontified t) 404 407 (face font-lock-keyword-face fontified t) 407 471 (fontified t) 471 483 (face font-lock-keyword-face fontified t) 483 506 (fontified t) 506 511 (face font-lock-keyword-face fontified t) 511 535 (fontified t) 535 538 (face font-lock-comment-delimiter-face fontified t) 538 544 (face font-lock-comment-face fontified t) 544 626 (fontified t) 626 633 (face font-lock-string-face fontified t) 633 658 (fontified t) 658 691 (face slime-reader-conditional-face fontified t) 691 698 (face slime-reader-conditional-face fontified t) 698 699 (face slime-reader-conditional-face fontified t) 699 748 (fontified t) 748 751 (face font-lock-keyword-face fontified t) 751 801 (fontified t) 801 804 (face font-lock-comment-delimiter-face fontified t) 804 811 (face font-lock-comment-face fontified t) 811 895 (fontified t) 895 903 (face font-lock-string-face fontified t) 903 930 (fontified t) 930 963 (face slime-reader-conditional-face fontified t) 963 971 (face slime-reader-conditional-face fontified t) 971 972 (face slime-reader-conditional-face fontified t) 972 998 (fontified t) 998 1001 (face font-lock-comment-delimiter-face fontified t) 1001 1030 (face font-lock-comment-face fontified t) 1030 1061 (fontified t) 1061 1069 (face font-lock-builtin-face fontified t) 1069 1116 (fontified t) 1116 1119 (face font-lock-comment-delimiter-face fontified t) 1119 1146 (face font-lock-comment-face fontified t) 1146 1166 (fontified t) 1166 1171 (face font-lock-warning-face fontified t) 1171 1207 (fontified t) 1207 1238 (face font-lock-string-face fontified t) 1238 1263 (fontified t) 1263 1266 (face font-lock-comment-delimiter-face fontified t) 1266 1299 (face font-lock-comment-face fontified t) 1299 1321 (fontified t) 1321 1334 (face font-lock-keyword-face fontified t) 1334 1418 (fontified t) 1418 1428 (face font-lock-string-face fontified t) 1428 1453 (fontified t) 1453 1486 (face slime-reader-conditional-face fontified t) 1486 1496 (face slime-reader-conditional-face fontified t) 1496 1497 (face slime-reader-conditional-face fontified t) 1497 1500 (fontified t) 1500 1521 (fontified t) 1521 1542 (fontified t) 1542 1545 (face font-lock-comment-delimiter-face fontified t) 1545 1566 (face font-lock-comment-face fontified t) 1566 1588 (fontified t) 1588 1591 (face font-lock-keyword-face fontified t) 1591 1610 (fontified t) 1610 1614 (face font-lock-string-face fontified t) 1614 1725 (fontified t) 1725 1728 (face font-lock-comment-delimiter-face fontified t) 1728 1766 (face font-lock-comment-face fontified t) 1766 1795 (fontified t) 1795 1801 (face font-lock-builtin-face fontified t) 1801 1831 (fontified t) 1831 1834 (face font-lock-comment-delimiter-face fontified t) 1834 1863 (face font-lock-comment-face fontified t) 1863 1872 (fontified t) 1872 1890 (face font-lock-keyword-face fontified t) 1890 1899 (fontified t) 1899 1908 (face font-lock-type-face fontified t) 1908 1955 (fontified t) 1955 1957 (face font-lock-keyword-face fontified t) 1957 1969 (fontified t) 1969 1977 (face font-lock-builtin-face fontified t) 1977 1993 (fontified t) 1993 1996 (face font-lock-comment-delimiter-face fontified t) 1996 2028 (face font-lock-comment-face fontified t) 2028 2043 (fontified t) 2043 2054 (face font-lock-keyword-face fontified t) 2054 2112 (fontified t) 2112 2115 (face font-lock-comment-delimiter-face fontified t) 2115 2121 (face font-lock-comment-face fontified t) 2121 2136 (fontified t) 2136 2139 (face font-lock-keyword-face fontified t) 2139 2150 (fontified t) 2150 2156 (face font-lock-keyword-face fontified t) 2156 2221 (fontified t) 2221 2225 (face font-lock-keyword-face fontified t) 2225 2244 (fontified t) 2244 2247 (face font-lock-comment-delimiter-face fontified t) 2247 2308 (face font-lock-comment-face fontified t) 2308 2363 (fontified t) 2363 2412 (face font-lock-string-face fontified t) 2412 2434 (fontified t) 2434 2445 (face font-lock-keyword-face fontified t) 2445 2512 (fontified t) 2512 2515 (face font-lock-comment-delimiter-face fontified t) 2515 2529 (face font-lock-comment-face fontified t) 2529 2658 (fontified t) 2658 2700 (face font-lock-string-face fontified t) 2700 2756 (fontified t) 2756 2760 (face font-lock-keyword-face fontified t) 2760 2875 (fontified t) 2875 2878 (face font-lock-comment-delimiter-face fontified t) 2878 2926 (face font-lock-comment-face fontified t) 2926 2976 (fontified t) 2976 3027 (face font-lock-string-face fontified t) 3027 3029 (fontified t) 3029 3049 (fontified t) 3049 3060 (face font-lock-keyword-face fontified t) 3060 3095 (fontified t) 3095 3109 (face font-lock-string-face fontified t) 3109 3125 (fontified t) 3125 3126 (rear-nonsticky t fontified t)) . -8128) (undo-tree-id7 . -2121) (undo-tree-id8 . -2121) (undo-tree-id9 . -2121) (undo-tree-id10 . -1823) (undo-tree-id11 . -3126) (undo-tree-id12 . -3029) (undo-tree-id13 . -3126) (undo-tree-id14 . -3126) 11254) nil (26976 58853 946297 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10952 . 10953) (nil fontified nil 8128 . 10953) (8128 . 10953)) nil (26976 58853 946279 0) 0 nil])
([nil nil ((#("
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  ;; On capture les deux valeurs de retour : le résultat OU l'erreur
  `(multiple-value-bind (res err-msg)
       (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)
     (if err-msg
         ;; Si une erreur est renvoyée, on la lance ICI.
         ;; Nous sommes hors de la DB, hors des threads de pool, hors de tout danger.
         (error err-msg)
         ;; Sinon, on retourne le résultat
         res)))" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 21 (fontified t) 21 25 (face font-lock-type-face fontified t) 25 37 (fontified t) 37 52 (face font-lock-builtin-face fontified t) 52 143 (fontified t) 143 148 (face font-lock-type-face fontified t) 148 158 (fontified t) 158 165 (face font-lock-keyword-face fontified t) 165 198 (fontified t) 198 201 (face font-lock-comment-delimiter-face fontified t) 201 265 (face font-lock-comment-face fontified t) 265 269 (fontified t) 269 288 (face font-lock-keyword-face fontified t) 288 331 (fontified t) 331 337 (face font-lock-keyword-face fontified t) 337 375 (fontified t) 375 377 (face font-lock-keyword-face fontified t) 377 395 (fontified t) 395 398 (face font-lock-comment-delimiter-face fontified t) 398 443 (face font-lock-comment-face fontified t) 443 452 (fontified t) 452 455 (face font-lock-comment-delimiter-face fontified t) 455 529 (face font-lock-comment-face fontified t) 529 539 (fontified t) 539 544 (face font-lock-warning-face fontified t) 544 563 (fontified t) 563 566 (face font-lock-comment-delimiter-face fontified t) 566 597 (face font-lock-comment-face fontified t) 597 611 (fontified t) 611 612 (fontified t rear-nonsticky t)) . 10954) (undo-tree-id21 . -612) (t 26976 58853 0 0)) nil (26976 59250 137052 0) 0 nil])
([nil nil ((10954 . 10955)) nil (26976 59250 137043 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11607 . 11608) (nil fontified nil 10955 . 11608) (10955 . 11608)) nil (26976 59250 137039 0) 0 nil])
([nil nil ((#("
(defun call-with-tx-logic (thunk retries sleep-ms &optional (attempt 0))
  \"Exécute THUNK avec une architecture Récursive pure.
   Retourne (values RESULTAT NIL) ou (values NIL ERREUR-STRING).
   Aucun 'return-from' n'est utilisé, ce qui garantit la stabilité de la pile.\"
  
  (format t \"~&[DB-TX] logic call. Attempt: ~A~%\" attempt)
  
  ;; 1. Exécution et Capture du résultat brut (Succès ou Erreur condition)
  (let ((outcome
         (ensure-connection
           (handler-case
               (progn
                 ;; BEGIN (Raw)
                 #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                 #-postmodern (lumen.data.db:exec \"BEGIN\")
                 
                 (let ((res (funcall thunk)))
                   ;; COMMIT (Raw)
                   #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                   #-postmodern (lumen.data.db:exec \"COMMIT\")
                   ;; On retourne une paire (:success . resultat)
                   (cons :success res)))
             
             ;; CATCH interne
             (error (c)
               (format t \"~&[DB-TX] Caught inside: ~A~%\" c)
               ;; ROLLBACK (Raw + Ignore Errors)
               (ignore-errors 
                 #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                 #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
               ;; On retourne une paire (:error . condition)
               (cons :error c))))))

    ;; 2. Analyse du résultat (Hors de ensure-connection)
    (if (eq (car outcome) :success)
        ;; CAS SUCCÈS : On retourne (valeur, nil)
        (values (cdr outcome) nil)

        ;; CAS ÉCHEC
        (let* ((err (cdr outcome))
               (msg (format nil \"~A\" err)) ;; On convertit tout de suite en String (Sanitisation)
               (is-app (typep err 'lumen.core.error:application-error))
               (mapped (unless is-app (lumen.data.errors:map-db-error err))))

          (cond
            ;; A) Erreur Métier -> On retourne l'erreur (pas de retry)
            (is-app
             (format t \"~&[DB-TX] App Error -> Returning msg.~%\")
             (values nil msg))

            ;; B) Retry -> On s'appelle récursivement (RECURSION)
            ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
             (format t \"~&[DB-TX] Retryable error. Recursing...~%\")
             (when (plusp sleep-ms) 
               (sleep (/ (max 0 sleep-ms) 1000.0)))
             ;; Appel récursif avec attempt + 1
             (call-with-tx-logic thunk retries sleep-ms (1+ attempt)))

            ;; C) Fatal -> On retourne l'erreur technique
            (t
             (format t \"~&[DB-TX] Fatal Error -> Returning msg.~%\")
             (values nil (format nil \"DB Error: ~A\" msg))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 51 (fontified t) 51 60 (face font-lock-type-face fontified t) 60 76 (fontified t) 76 273 (face font-lock-doc-face fontified t) 273 289 (fontified t) 289 326 (face font-lock-string-face fontified t) 326 341 (fontified t) 341 344 (face font-lock-comment-delimiter-face fontified t) 344 414 (face font-lock-comment-face fontified t) 414 417 (fontified t) 417 420 (face font-lock-keyword-face fontified t) 420 471 (fontified t) 471 483 (face font-lock-keyword-face fontified t) 483 500 (fontified t) 500 505 (face font-lock-keyword-face fontified t) 505 523 (fontified t) 523 526 (face font-lock-comment-delimiter-face fontified t) 526 538 (face font-lock-comment-face fontified t) 538 614 (fontified t) 614 621 (face font-lock-string-face fontified t) 621 640 (fontified t) 640 673 (face slime-reader-conditional-face fontified t) 673 680 (face slime-reader-conditional-face fontified t) 680 681 (face slime-reader-conditional-face fontified t) 681 718 (fontified t) 718 721 (face font-lock-keyword-face fontified t) 721 765 (fontified t) 765 768 (face font-lock-comment-delimiter-face fontified t) 768 781 (face font-lock-comment-face fontified t) 781 859 (fontified t) 859 867 (face font-lock-string-face fontified t) 867 888 (fontified t) 888 921 (face slime-reader-conditional-face fontified t) 921 929 (face slime-reader-conditional-face fontified t) 929 930 (face slime-reader-conditional-face fontified t) 930 950 (fontified t) 950 953 (face font-lock-comment-delimiter-face fontified t) 953 997 (face font-lock-comment-face fontified t) 997 1022 (fontified t) 1022 1030 (face font-lock-builtin-face fontified t) 1030 1065 (fontified t) 1065 1068 (face font-lock-comment-delimiter-face fontified t) 1068 1082 (face font-lock-comment-face fontified t) 1082 1096 (fontified t) 1096 1101 (face font-lock-warning-face fontified t) 1101 1131 (fontified t) 1131 1162 (face font-lock-string-face fontified t) 1162 1181 (fontified t) 1181 1184 (face font-lock-comment-delimiter-face fontified t) 1184 1215 (face font-lock-comment-face fontified t) 1215 1231 (fontified t) 1231 1244 (face font-lock-keyword-face fontified t) 1244 1322 (fontified t) 1322 1332 (face font-lock-string-face fontified t) 1332 1351 (fontified t) 1351 1384 (face slime-reader-conditional-face fontified t) 1384 1394 (face slime-reader-conditional-face fontified t) 1394 1395 (face slime-reader-conditional-face fontified t) 1395 1412 (fontified t) 1412 1415 (face font-lock-comment-delimiter-face fontified t) 1415 1458 (face font-lock-comment-face fontified t) 1458 1479 (fontified t) 1479 1485 (face font-lock-builtin-face fontified t) 1485 1499 (fontified t) 1499 1501 (face font-lock-comment-delimiter-face fontified t) 1501 1502 (face font-lock-comment-delimiter-face fontified t) 1502 1553 (face font-lock-comment-face fontified t) 1553 1558 (fontified t) 1558 1560 (face font-lock-keyword-face fontified t) 1560 1579 (fontified t) 1579 1587 (face font-lock-builtin-face fontified t) 1587 1597 (fontified t) 1597 1600 (face font-lock-comment-delimiter-face fontified t) 1600 1639 (face font-lock-comment-face fontified t) 1639 1683 (fontified t) 1683 1686 (face font-lock-comment-delimiter-face fontified t) 1686 1696 (face font-lock-comment-face fontified t) 1696 1705 (fontified t) 1705 1709 (face font-lock-keyword-face fontified t) 1709 1763 (fontified t) 1763 1767 (face font-lock-string-face fontified t) 1767 1774 (fontified t) 1774 1777 (face font-lock-comment-delimiter-face fontified t) 1777 1829 (face font-lock-comment-face fontified t) 1829 1925 (fontified t) 1925 1931 (face font-lock-keyword-face fontified t) 1931 1991 (fontified t) 1991 1995 (face font-lock-keyword-face fontified t) 1995 2008 (fontified t) 2008 2011 (face font-lock-comment-delimiter-face fontified t) 2011 2067 (face font-lock-comment-face fontified t) 2067 2110 (fontified t) 2110 2151 (face font-lock-string-face fontified t) 2151 2197 (fontified t) 2197 2200 (face font-lock-comment-delimiter-face fontified t) 2200 2251 (face font-lock-comment-face fontified t) 2251 2368 (fontified t) 2368 2411 (face font-lock-string-face fontified t) 2411 2427 (fontified t) 2427 2431 (face font-lock-keyword-face fontified t) 2431 2515 (fontified t) 2515 2518 (face font-lock-comment-delimiter-face fontified t) 2518 2550 (face font-lock-comment-face fontified t) 2550 2634 (fontified t) 2634 2637 (face font-lock-comment-delimiter-face fontified t) 2637 2680 (face font-lock-comment-face fontified t) 2680 2718 (fontified t) 2718 2761 (face font-lock-string-face fontified t) 2761 2800 (fontified t) 2800 2814 (face font-lock-string-face fontified t) 2814 2825 (fontified t) 2825 2826 (rear-nonsticky t fontified t)) . 8127) (undo-tree-id26 . -2826) (undo-tree-id27 . -1980) (undo-tree-id28 . -2826) (undo-tree-id29 . -1) (undo-tree-id30 . -2826) (undo-tree-id31 . -335) (t 26976 59250 0 0)) nil (26976 59660 21581 0) 0 nil])
([nil nil ((8127 . 8128)) nil (26976 59660 21576 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11203 . 11204) (nil fontified nil 8128 . 11204) (8128 . 11204)) nil (26976 59660 21575 0) 0 nil])
([nil nil ((#("(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  `(multiple-value-bind (res err-msg is-app-error)
       (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)
     (cond
       ;; Cas 1 : Erreur Métier -> On lance le Proxy typé
       ((and err-msg is-app-error)
        (error 'db-safe-business-error :message err-msg))
       
       ;; Cas 2 : Erreur Technique -> On lance une erreur simple
       (err-msg
        (error \"DB Error: ~A\" err-msg))
       
       ;; Cas 3 : Succès
       (t res))))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 17 (face font-lock-function-name-face fontified t) 17 20 (fontified t) 20 24 (face font-lock-type-face fontified t) 24 36 (fontified t) 36 51 (face font-lock-builtin-face fontified t) 51 142 (fontified t) 142 147 (face font-lock-type-face fontified t) 147 157 (fontified t) 157 164 (face font-lock-keyword-face fontified t) 164 199 (fontified t) 199 218 (face font-lock-keyword-face fontified t) 218 274 (fontified t) 274 280 (face font-lock-keyword-face fontified t) 280 318 (fontified t) 318 322 (face font-lock-keyword-face fontified t) 322 330 (fontified t) 330 333 (face font-lock-comment-delimiter-face fontified t) 333 381 (face font-lock-comment-face fontified t) 381 425 (fontified t) 425 430 (face font-lock-warning-face fontified t) 430 455 (fontified t) 455 463 (face font-lock-builtin-face fontified t) 463 489 (fontified t) 489 492 (face font-lock-comment-delimiter-face fontified t) 492 547 (face font-lock-comment-face fontified t) 547 572 (fontified t) 572 577 (face font-lock-warning-face fontified t) 577 578 (fontified t) 578 592 (face font-lock-string-face fontified t) 592 618 (fontified t) 618 621 (face font-lock-comment-delimiter-face fontified t) 621 636 (face font-lock-comment-face fontified t) 636 652 (fontified t) 652 653 (fontified t rear-nonsticky t)) . -11206) (undo-tree-id22 . -653) (undo-tree-id23 . -636) (undo-tree-id24 . -653) (undo-tree-id25 . -653) 11859) nil (26976 59660 21573 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12166 . 12167) (nil fontified nil 11206 . 12167) (11206 . 12167)) nil (26976 59660 21556 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute une transaction et retourne une liste (:ok . res) ou (:error . msg).
   NE LANCE JAMAIS D'ERREUR. Gère les retries en interne via une boucle simple.\"
  ;; (format t \"~&[DB-TX] START Safe Logic.~%\") ;; Debug si besoin
  
  (let ((attempt 0))
    (loop
      ;; Bloc de connexion/transaction isolé
      (let ((outcome
             (block db-try
               (handler-case
                   (ensure-connection
                     ;; --- DÉBUT TRANSACTION ---
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                     #-postmodern (lumen.data.db:exec \"BEGIN\")
                     
                     (handler-case
                         (let ((res (funcall thunk)))
                           ;; --- COMMIT ---
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                           #-postmodern (lumen.data.db:exec \"COMMIT\")
                           ;; Succès : on retourne (:ok . résultat)
                           (cons :ok res))
                       
                       ;; CATCH INTERNE (Erreur applicative ou DB)
                       (error (c)
                         ;; --- ROLLBACK (Mode Brut pour éviter erreur 25P02) ---
                         (ignore-errors 
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                           #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                         
                         ;; On retourne (:error . condition-objet)
                         (cons :error c))))
                 
                 ;; Catch si ensure-connection plante avant la TX
                 (error (c) (cons :error c))))))
        
        ;; ANALYSE DU RÉSULTAT (Hors de la connexion)
        (if (eq (car outcome) :ok)
            ;; Cas SUCCÈS : On retourne le résultat tout de suite
            (return (cdr outcome))
            
            ;; Cas ÉCHEC : On analyse pour savoir si on retry
            (let* ((err (cdr outcome))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (cond
                ;; 1. Erreur Métier -> Pas de retry, on retourne le message string
                (is-app
                 ;; IMPORTANT : On extrait le texte pour tuer la référence à la pile
                 (return (cons :app-error (format nil \"~A\" err))))
                
                ;; 2. Retry possible -> On boucle
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (incf attempt)
                 (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                 ;; Le Loop continue ici
                 )
                
                ;; 3. Erreur Fatale -> On retourne le message technique
                (t
                 (return (cons :db-error (format nil \"~A\" err)))))))))))

(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  (let ((res-sym (gensym \"RES\")))
    `(let ((,res-sym (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)))
       ;; On analyse la paire de retour (type . data)
       (case (car ,res-sym)
         
         ;; SUCCÈS : On renvoie la donnée
         (:ok (cdr ,res-sym))
         
         ;; ERREUR MÉTIER (Business Error)
         ;; On lance une erreur applicative PROPRE. 
         ;; Le Middleware va l'attraper et faire le Toast JSON.
         (:app-error 
          (error 'lumen.core.error:application-error 
                 :message (cdr ,res-sym))) ;; On passe juste le texte
         
         ;; ERREUR TECHNIQUE (DB Error)
         ;; On lance une erreur générique
         (:db-error" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 211 (face font-lock-doc-face fontified t) 211 214 (fontified t) 214 217 (face font-lock-comment-delimiter-face fontified t) 217 279 (face font-lock-comment-face fontified t) 279 285 (fontified t) 285 288 (face font-lock-keyword-face fontified t) 288 308 (fontified t) 308 312 (face font-lock-keyword-face fontified t) 312 319 (fontified t) 319 322 (face font-lock-comment-delimiter-face fontified t) 322 358 (face font-lock-comment-face fontified t) 358 365 (fontified t) 365 368 (face font-lock-keyword-face fontified t) 368 393 (fontified t) 393 398 (face font-lock-keyword-face fontified t) 398 422 (fontified t) 422 434 (face font-lock-keyword-face fontified t) 434 494 (fontified t) 494 497 (face font-lock-comment-delimiter-face fontified t) 497 523 (face font-lock-comment-face fontified t) 523 603 (fontified t) 603 610 (face font-lock-string-face fontified t) 610 633 (fontified t) 633 666 (face slime-reader-conditional-face fontified t) 666 673 (face slime-reader-conditional-face fontified t) 673 674 (face slime-reader-conditional-face fontified t) 674 719 (fontified t) 719 731 (face font-lock-keyword-face fontified t) 731 758 (fontified t) 758 761 (face font-lock-keyword-face fontified t) 761 813 (fontified t) 813 816 (face font-lock-comment-delimiter-face fontified t) 816 831 (face font-lock-comment-face fontified t) 831 917 (fontified t) 917 925 (face font-lock-string-face fontified t) 925 954 (fontified t) 954 987 (face slime-reader-conditional-face fontified t) 987 995 (face slime-reader-conditional-face fontified t) 995 996 (face slime-reader-conditional-face fontified t) 996 1024 (fontified t) 1024 1027 (face font-lock-comment-delimiter-face fontified t) 1027 1065 (face font-lock-comment-face fontified t) 1065 1098 (fontified t) 1098 1101 (face font-lock-builtin-face fontified t) 1101 1155 (fontified t) 1155 1158 (face font-lock-comment-delimiter-face fontified t) 1158 1199 (face font-lock-comment-face fontified t) 1199 1223 (fontified t) 1223 1228 (face font-lock-warning-face fontified t) 1228 1258 (fontified t) 1258 1261 (face font-lock-comment-delimiter-face fontified t) 1261 1315 (face font-lock-comment-face fontified t) 1315 1341 (fontified t) 1341 1354 (face font-lock-keyword-face fontified t) 1354 1442 (fontified t) 1442 1452 (face font-lock-string-face fontified t) 1452 1481 (fontified t) 1481 1500 (face slime-reader-conditional-face fontified t) 1500 1514 (face slime-reader-conditional-face fontified t) 1514 1524 (face slime-reader-conditional-face fontified t) 1524 1525 (face slime-reader-conditional-face fontified t) 1525 1527 (fontified t) 1527 1578 (fontified t) 1578 1581 (face font-lock-comment-delimiter-face fontified t) 1581 1620 (face font-lock-comment-face fontified t) 1620 1651 (fontified t) 1651 1657 (face font-lock-builtin-face fontified t) 1657 1699 (fontified t) 1699 1702 (face font-lock-comment-delimiter-face fontified t) 1702 1748 (face font-lock-comment-face fontified t) 1748 1766 (fontified t) 1766 1771 (face font-lock-warning-face fontified t) 1771 1782 (fontified t) 1782 1788 (face font-lock-builtin-face fontified t) 1788 1814 (fontified t) 1814 1817 (face font-lock-comment-delimiter-face fontified t) 1817 1860 (face font-lock-comment-face fontified t) 1860 1869 (fontified t) 1869 1871 (face font-lock-keyword-face fontified t) 1871 1890 (fontified t) 1890 1893 (face font-lock-builtin-face fontified t) 1893 1907 (fontified t) 1907 1910 (face font-lock-comment-delimiter-face fontified t) 1910 1961 (face font-lock-comment-face fontified t) 1961 1974 (fontified t) 1974 1980 (face font-lock-keyword-face fontified t) 1980 2021 (fontified t) 2021 2024 (face font-lock-comment-delimiter-face fontified t) 2024 2071 (face font-lock-comment-face fontified t) 2071 2084 (fontified t) 2084 2088 (face font-lock-keyword-face fontified t) 2088 2214 (fontified t) 2214 2220 (face font-lock-keyword-face fontified t) 2220 2298 (fontified t) 2298 2302 (face font-lock-keyword-face fontified t) 2302 2319 (fontified t) 2319 2322 (face font-lock-comment-delimiter-face fontified t) 2322 2386 (face font-lock-comment-face fontified t) 2386 2427 (fontified t) 2427 2430 (face font-lock-comment-delimiter-face fontified t) 2430 2495 (face font-lock-comment-face fontified t) 2495 2513 (fontified t) 2513 2519 (face font-lock-keyword-face fontified t) 2519 2526 (fontified t) 2526 2536 (face font-lock-builtin-face fontified t) 2536 2549 (fontified t) 2549 2553 (face font-lock-string-face fontified t) 2553 2595 (fontified t) 2595 2598 (face font-lock-comment-delimiter-face fontified t) 2598 2629 (face font-lock-comment-face fontified t) 2629 2777 (fontified t) 2777 2781 (face font-lock-keyword-face fontified t) 2781 2853 (fontified t) 2853 2856 (face font-lock-comment-delimiter-face fontified t) 2856 2877 (face font-lock-comment-face fontified t) 2877 2929 (fontified t) 2929 2932 (face font-lock-comment-delimiter-face fontified t) 2932 2985 (face font-lock-comment-face fontified t) 2985 3022 (fontified t) 3022 3028 (face font-lock-keyword-face fontified t) 3028 3035 (fontified t) 3035 3044 (face font-lock-builtin-face fontified t) 3044 3057 (fontified t) 3057 3061 (face font-lock-string-face fontified t) 3061 3075 (fontified t) 3075 3076 (rear-nonsticky t fontified t) 3076 3077 (fontified t) 3077 3078 (fontified t) 3078 3079 (fontified t) 3079 3087 (face font-lock-keyword-face fontified t) 3087 3088 (fontified t) 3088 3095 (face font-lock-function-name-face fontified t) 3095 3098 (fontified t) 3098 3102 (face font-lock-type-face fontified t) 3102 3114 (fontified t) 3114 3129 (face font-lock-builtin-face fontified t) 3129 3220 (fontified t) 3220 3225 (face font-lock-type-face fontified t) 3225 3235 (fontified t) 3235 3242 (face font-lock-keyword-face fontified t) 3242 3276 (fontified t) 3276 3279 (face font-lock-keyword-face fontified t) 3279 3298 (fontified t) 3298 3303 (face font-lock-string-face fontified t) 3303 3313 (fontified t) 3313 3316 (face font-lock-keyword-face fontified t) 3316 3349 (fontified t) 3349 3355 (face font-lock-keyword-face fontified t) 3355 3396 (fontified t) 3396 3399 (face font-lock-comment-delimiter-face fontified t) 3399 3443 (face font-lock-comment-face fontified t) 3443 3451 (fontified t) 3451 3455 (face font-lock-keyword-face fontified t) 3455 3490 (fontified t) 3490 3493 (face font-lock-comment-delimiter-face fontified t) 3493 3523 (face font-lock-comment-face fontified t) 3523 3533 (fontified t) 3533 3536 (face font-lock-builtin-face fontified t) 3536 3572 (fontified t) 3572 3575 (face font-lock-comment-delimiter-face fontified t) 3575 3606 (face font-lock-comment-face fontified t) 3606 3615 (fontified t) 3615 3618 (face font-lock-comment-delimiter-face fontified t) 3618 3659 (face font-lock-comment-face fontified t) 3659 3668 (fontified t) 3668 3671 (face font-lock-comment-delimiter-face fontified t) 3671 3723 (face font-lock-comment-face fontified t) 3723 3733 (fontified t) 3733 3743 (face font-lock-builtin-face fontified t) 3743 3756 (fontified t) 3756 3761 (face font-lock-warning-face fontified t) 3761 3816 (fontified t) 3816 3824 (face font-lock-builtin-face fontified t) 3824 3842 (fontified t) 3842 3845 (face font-lock-comment-delimiter-face fontified t) 3845 3869 (face font-lock-comment-face fontified t) 3869 3888 (fontified t) 3888 3891 (face font-lock-comment-delimiter-face fontified t) 3891 3919 (face font-lock-comment-face fontified t) 3919 3928 (fontified t) 3928 3931 (face font-lock-comment-delimiter-face fontified t) 3931 3961 (face font-lock-comment-face fontified t) 3961 3971 (fontified t) 3971 3980 (face font-lock-builtin-face fontified t)) . 8128) (undo-tree-id32 . -3980) (undo-tree-id33 . -2727) (undo-tree-id34 . -3077) (undo-tree-id35 . -3980) (undo-tree-id36 . -1961) (undo-tree-id37 . -1895) (undo-tree-id38 . -1860) (undo-tree-id39 . -1806) (undo-tree-id40 . -1797) (undo-tree-id41 . -1748) (undo-tree-id42 . -1664) (undo-tree-id43 . -1553) (undo-tree-id44 . -1454) (undo-tree-id45 . -1356) (undo-tree-id46 . -1233) (undo-tree-id47 . -1132) (undo-tree-id48 . -1065) (undo-tree-id49 . -927) (undo-tree-id50 . -831) (undo-tree-id51 . -732) (undo-tree-id52 . -675) (undo-tree-id53 . -523) (undo-tree-id54 . -435) (undo-tree-id55 . -379) (undo-tree-id56 . -313) (undo-tree-id57 . -282) (undo-tree-id58 . -212) (undo-tree-id59 . -51) (undo-tree-id60 . -3980) (undo-tree-id61 . -3078) (undo-tree-id62 . -3980) (t 26976 59660 0 0)) nil (26976 59887 887824 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12206 . 12207) (nil fontified nil 8128 . 12207) (8128 . 12207)) nil (26976 59887 887795 0) 0 nil])
([nil nil ((#(";; 1. LA FONCTION \"FACTEUR\"
;; Elle fait le travail et retourne un colis : (:ok . resultat) ou (:error . message)
;; Elle ne lance AUCUNE exception, donc elle ne peut pas casser la pile.
(defun call-with-tx-logic (thunk retries sleep-ms)
  (format t \"~&[DB-TX] logic call (Safe-Return-Value).~%\")
  
  (let ((attempt 0))
    (loop
      (let ((outcome
             ;; Bloc de protection connection
             (block db-attempt
               (handler-case
                   (ensure-connection
                     ;; --- BEGIN ---
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                     #-postmodern (lumen.data.db:exec \"BEGIN\")
                     
                     (handler-case
                         (let ((res (funcall thunk)))
                           ;; --- COMMIT ---
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                           #-postmodern (lumen.data.db:exec \"COMMIT\")
                           ;; Colis Succès
                           (cons :ok res))
                       
                       ;; CATCH INTERNE
                       (error (c)
                         (format t \"~&[DB-TX] Caught internal: ~A~%\" c)
                         ;; --- ROLLBACK ---
                         (ignore-errors 
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                           #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                         ;; Colis Erreur (avec l'objet erreur pour analyse)
                         (cons :error c))))
                 
                 ;; Catch échec connexion
                 (error (c) (cons :error c))))))
        
        ;; ANALYSE DU COLIS (Zone Sûre, hors connexion)
        (if (eq (car outcome) :ok)
            ;; Succès : on retourne le résultat
            (return (cdr outcome))
            
            ;; Échec : on décide (Retry ou Return Message)
            (let* ((err (cdr outcome))
                   (msg (format nil \"~A\" err)) ;; On convertit en texte ICI pour tuer les références mortes
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (cond
                ;; A) Erreur Métier -> On retourne le type spécial :app-error
                (is-app
                 (format t \"~&[DB-TX] App error -> Return message.~%\")
                 (return (cons :app-error msg)))
                
                ;; B) Retry -> On boucle
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (format t \"~&[DB-TX] Retryable. Sleeping...~%\")
                 (incf attempt)
                 (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0))))
                
                ;; C) Fatal -> On retourne le type :db-error
                (t
                 (format t \"~&[DB-TX] Fatal error -> Return message.~%\")
                 (return (cons :db-error (format nil \"DB Error: ~A\" msg)))))))))))

;; 2. LA MACRO \"DÉCIDEUR\"
;; C'est elle qui ouvre le colis et lance l'erreur SI NÉCESSAIRE.
;; Comme elle s'exécute dans le contrôleur, la pile est propre.
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  (let ((res-sym (gensym \"RES\")))
    `(let ((,res-sym (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)))
       ;; On inspecte le premier élément de la liste retournée
       (case (car ,res-sym)
         
         ;; SUCCÈS : on rend la donnée
         (:ok (cdr ,res-sym))
         
         ;; ERREUR MÉTIER : On lance l'erreur pour le Middleware
         (:app-error 
          (error 'lumen.core.error:application-error 
                 :message (cdr ,res-sym)))
         
         ;; ERREUR TECHNIQUE
         (:db-error
          (error (cdr ,res-sym)))))))
          (error \"Database Error: ~A\" (cdr ,res-sym)))))))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 28 (face font-lock-comment-face fontified t) 28 31 (face font-lock-comment-delimiter-face fontified t) 31 114 (face font-lock-comment-face fontified t) 114 117 (face font-lock-comment-delimiter-face fontified t) 117 187 (face font-lock-comment-face fontified t) 187 188 (fontified t) 188 193 (face font-lock-keyword-face fontified t) 193 194 (fontified t) 194 212 (face font-lock-function-name-face fontified t) 212 250 (fontified t) 250 295 (face font-lock-string-face fontified t) 295 303 (fontified t) 303 306 (face font-lock-keyword-face fontified t) 306 326 (fontified t) 326 330 (face font-lock-keyword-face fontified t) 330 338 (fontified t) 338 341 (face font-lock-keyword-face fontified t) 341 365 (fontified t) 365 368 (face font-lock-comment-delimiter-face fontified t) 368 398 (face font-lock-comment-face fontified t) 398 412 (fontified t) 412 417 (face font-lock-keyword-face fontified t) 417 445 (fontified t) 445 457 (face font-lock-keyword-face fontified t) 457 517 (fontified t) 517 520 (face font-lock-comment-delimiter-face fontified t) 520 534 (face font-lock-comment-face fontified t) 534 614 (fontified t) 614 621 (face font-lock-string-face fontified t) 621 644 (fontified t) 644 677 (face slime-reader-conditional-face fontified t) 677 684 (face slime-reader-conditional-face fontified t) 684 685 (face slime-reader-conditional-face fontified t) 685 730 (fontified t) 730 742 (face font-lock-keyword-face fontified t) 742 769 (fontified t) 769 772 (face font-lock-keyword-face fontified t) 772 824 (fontified t) 824 827 (face font-lock-comment-delimiter-face fontified t) 827 842 (face font-lock-comment-face fontified t) 842 928 (fontified t) 928 936 (face font-lock-string-face fontified t) 936 965 (fontified t) 965 998 (face slime-reader-conditional-face fontified t) 998 1006 (face slime-reader-conditional-face fontified t) 1006 1007 (face slime-reader-conditional-face fontified t) 1007 1035 (fontified t) 1035 1038 (face font-lock-comment-delimiter-face fontified t) 1038 1051 (face font-lock-comment-face fontified t) 1051 1084 (fontified t) 1084 1087 (face font-lock-builtin-face fontified t) 1087 1141 (fontified t) 1141 1144 (face font-lock-comment-delimiter-face fontified t) 1144 1158 (face font-lock-comment-face fontified t) 1158 1182 (fontified t) 1182 1187 (face font-lock-warning-face fontified t) 1187 1227 (fontified t) 1227 1260 (face font-lock-string-face fontified t) 1260 1289 (fontified t) 1289 1292 (face font-lock-comment-delimiter-face fontified t) 1292 1309 (face font-lock-comment-face fontified t) 1309 1335 (fontified t) 1335 1348 (face font-lock-keyword-face fontified t) 1348 1436 (fontified t) 1436 1446 (face font-lock-string-face fontified t) 1446 1475 (fontified t) 1475 1500 (face slime-reader-conditional-face fontified t) 1500 1508 (face slime-reader-conditional-face fontified t) 1508 1518 (face slime-reader-conditional-face fontified t) 1518 1519 (face slime-reader-conditional-face fontified t) 1519 1521 (fontified t) 1521 1546 (fontified t) 1546 1549 (fontified t face font-lock-comment-delimiter-face) 1549 1597 (fontified t face font-lock-comment-face) 1597 1628 (fontified t) 1628 1634 (fontified t face font-lock-builtin-face) 1634 1676 (fontified t) 1676 1679 (fontified t face font-lock-comment-delimiter-face) 1679 1701 (fontified t face font-lock-comment-face) 1701 1719 (fontified t) 1719 1724 (fontified t face font-lock-warning-face) 1724 1735 (fontified t) 1735 1741 (fontified t face font-lock-builtin-face) 1741 1767 (fontified t) 1767 1770 (fontified t face font-lock-comment-delimiter-face) 1770 1815 (fontified t face font-lock-comment-face) 1815 1824 (fontified t) 1824 1826 (fontified t face font-lock-keyword-face) 1826 1845 (fontified t) 1845 1848 (fontified t face font-lock-builtin-face) 1848 1862 (fontified t) 1862 1865 (fontified t face font-lock-comment-delimiter-face) 1865 1898 (fontified t face font-lock-comment-face) 1898 1911 (fontified t) 1911 1917 (fontified t face font-lock-keyword-face) 1917 1958 (fontified t) 1958 1961 (fontified t face font-lock-comment-delimiter-face) 1961 2005 (fontified t face font-lock-comment-face) 2005 2018 (fontified t) 2018 2022 (fontified t face font-lock-keyword-face) 2022 2080 (fontified t) 2080 2084 (fontified t face font-lock-string-face) 2084 2091 (fontified t) 2091 2094 (fontified t face font-lock-comment-delimiter-face) 2094 2152 (fontified t face font-lock-comment-face) 2152 2256 (fontified t) 2256 2262 (fontified t face font-lock-keyword-face) 2262 2340 (fontified t) 2340 2344 (fontified t face font-lock-keyword-face) 2344 2361 (fontified t) 2361 2364 (fontified t face font-lock-comment-delimiter-face) 2364 2423 (fontified t face font-lock-comment-face) 2423 2474 (fontified t) 2474 2516 (fontified t face font-lock-string-face) 2516 2536 (fontified t) 2536 2542 (fontified t face font-lock-keyword-face) 2542 2549 (fontified t) 2549 2559 (fontified t face font-lock-builtin-face) 2559 2600 (fontified t) 2600 2603 (fontified t face font-lock-comment-delimiter-face) 2603 2625 (fontified t face font-lock-comment-face) 2625 2750 (fontified t) 2750 2786 (fontified t face font-lock-string-face) 2786 2838 (fontified t) 2838 2842 (fontified t face font-lock-keyword-face) 2842 2931 (fontified t) 2931 2934 (fontified t face font-lock-comment-delimiter-face) 2934 2976 (fontified t face font-lock-comment-face) 2976 3022 (fontified t) 3022 3066 (fontified t face font-lock-string-face) 3066 3068 (fontified t) 3068 3086 (fontified t) 3086 3092 (face font-lock-keyword-face fontified t) 3092 3099 (fontified t) 3099 3108 (face font-lock-builtin-face fontified t) 3108 3121 (fontified t) 3121 3135 (face font-lock-string-face fontified t) 3135 3151 (fontified t) 3151 3152 (fontified t) 3152 3155 (face font-lock-comment-delimiter-face fontified t) 3155 3178 (face font-lock-comment-face fontified t) 3178 3181 (face font-lock-comment-delimiter-face fontified t) 3181 3244 (face font-lock-comment-face fontified t) 3244 3247 (face font-lock-comment-delimiter-face fontified t) 3247 3308 (face font-lock-comment-face fontified t) 3308 3309 (fontified t) 3309 3317 (fontified t face font-lock-keyword-face) 3317 3318 (fontified t) 3318 3325 (fontified t face font-lock-function-name-face) 3325 3328 (fontified t) 3328 3332 (fontified t face font-lock-type-face) 3332 3344 (fontified t) 3344 3359 (fontified t face font-lock-builtin-face) 3359 3378 (fontified t) 3378 3450 (fontified t) 3450 3455 (face font-lock-type-face fontified t) 3455 3465 (fontified t) 3465 3472 (face font-lock-keyword-face fontified t) 3472 3506 (fontified t) 3506 3509 (face font-lock-keyword-face fontified t) 3509 3528 (fontified t) 3528 3533 (face font-lock-string-face fontified t) 3533 3543 (fontified t) 3543 3546 (face font-lock-keyword-face fontified t) 3546 3579 (fontified t) 3579 3585 (face font-lock-keyword-face fontified t) 3585 3626 (fontified t) 3626 3629 (face font-lock-comment-delimiter-face fontified t) 3629 3682 (face font-lock-comment-face fontified t) 3682 3690 (fontified t) 3690 3694 (face font-lock-keyword-face fontified t) 3694 3729 (fontified t) 3729 3732 (face font-lock-comment-delimiter-face fontified t) 3732 3759 (face font-lock-comment-face fontified t) 3759 3769 (fontified t) 3769 3772 (face font-lock-builtin-face fontified t) 3772 3808 (fontified t) 3808 3811 (face font-lock-comment-delimiter-face fontified t) 3811 3864 (face font-lock-comment-face fontified t) 3864 3874 (fontified t) 3874 3884 (face font-lock-builtin-face fontified t) 3884 3897 (fontified t) 3897 3902 (face font-lock-warning-face fontified t) 3902 3957 (fontified t) 3957 3965 (face font-lock-builtin-face fontified t) 3965 4002 (fontified t) 4002 4005 (face font-lock-comment-delimiter-face fontified t) 4005 4022 (face font-lock-comment-face fontified t) 4022 4032 (fontified t) 4032 4041 (face font-lock-builtin-face fontified t) 4041 4053 (fontified t) 4053 4058 (face font-lock-warning-face fontified t) 4058 4078 (fontified t) 4078 4079 (fontified t rear-nonsticky t) 4079 4080 (fontified t) 4080 4091 (fontified t) 4091 4096 (face font-lock-warning-face fontified t) 4096 4097 (fontified t) 4097 4117 (face font-lock-string-face fontified t) 4117 4137 (fontified t) 4137 4138 (fontified t rear-nonsticky t)) . 8128) (undo-tree-id63 . -4138) (undo-tree-id64 . -4138) (undo-tree-id65 . -4138) (undo-tree-id66 . -4138) (undo-tree-id67 . -187) (undo-tree-id68 . -3068) (undo-tree-id69 . -352) (undo-tree-id70 . -321) (undo-tree-id71 . -297) (undo-tree-id72 . -187) (undo-tree-id73 . -28) (undo-tree-id74 . -4138) (undo-tree-id75 . -4138) (t 26976 59887 0 0)) nil (26976 59906 207684 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12206 . 12207) (nil fontified nil 8128 . 12207) (8128 . 12207)) nil (26976 59906 207667 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  (format t \"~&[DB-TX] logic call (Safe-Return-Value).~%\")
  
  (let ((attempt 0))
    (loop
      (let ((outcome
             ;; Bloc de protection connection
             (block db-attempt
               (handler-case
                   (ensure-connection
                     ;; --- BEGIN ---
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                     #-postmodern (lumen.data.db:exec \"BEGIN\")
                     
                     (handler-case
                         (let ((res (funcall thunk)))
                           ;; --- COMMIT ---
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                           #-postmodern (lumen.data.db:exec \"COMMIT\")
                           ;; Colis Succès
                           (cons :ok res))
                       
                       ;; CATCH INTERNE
                       (error (c)
                         (format t \"~&[DB-TX] Caught internal: ~A~%\" c)
                         ;; --- ROLLBACK ---
                         (ignore-errors 
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                           #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                         ;; Colis Erreur (avec l'objet erreur pour analyse)
                         (cons :error c))))
                 
                 ;; Catch échec connexion
                 (error (c) (cons :error c))))))
        
        ;; ANALYSE DU COLIS (Zone Sûre, hors connexion)
        (if (eq (car outcome) :ok)
            ;; Succès : on retourne le résultat
            (return (cdr outcome))
            
            ;; Échec : on décide (Retry ou Return Message)
            (let* ((err (cdr outcome))
                   (msg (format nil \"~A\" err)) ;; On convertit en texte ICI pour tuer les références mortes
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (cond
                ;; A) Erreur Métier -> On retourne le type spécial :app-error
                (is-app
                 (format t \"~&[DB-TX] App error -> Return message.~%\")
                 (return (cons :app-error msg)))
                
                ;; B) Retry -> On boucle
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (format t \"~&[DB-TX] Retryable. Sleeping...~%\")
                 (incf attempt)
                 (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0))))
                
                ;; C) Fatal -> On retourne le type :db-error
                (t
                 (format t \"~&[DB-TX] Fatal error -> Return message.~%\")
                 (return (cons :db-error (format nil \"DB Error: ~A\" msg)))))))))))

;; 2. LA MACRO \"DÉCIDEUR\"
;; C'est elle qui ouvre le colis et lance l'erreur SI NÉCESSAIRE.
;; Comme elle s'exécute dans le contrôleur, la pile est propre.
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  (let ((res-sym (gensym \"RES\")))
    `(let ((,res-sym (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)))
       ;; On inspecte le premier élément de la liste retournée
       (case (car ,res-sym)
         
         ;; SUCCÈS : on rend la donnée
         (:ok (cdr ,res-sym))
         
         ;; ERREUR MÉTIER : On lance l'erreur pour le Middleware
         (:app-error 
          (error 'lumen.core.error:application-error 
                 :message (cdr ,res-sym)))
         
         ;; ERREUR TECHNIQUE
         (:db-error
          (error (cdr ,res-sym)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 63 (fontified t) 63 108 (face font-lock-string-face fontified t) 108 116 (fontified t) 116 119 (face font-lock-keyword-face fontified t) 119 139 (fontified t) 139 143 (face font-lock-keyword-face fontified t) 143 151 (fontified t) 151 154 (face font-lock-keyword-face fontified t) 154 178 (fontified t) 178 181 (face font-lock-comment-delimiter-face fontified t) 181 211 (face font-lock-comment-face fontified t) 211 225 (fontified t) 225 230 (face font-lock-keyword-face fontified t) 230 258 (fontified t) 258 270 (face font-lock-keyword-face fontified t) 270 330 (fontified t) 330 333 (face font-lock-comment-delimiter-face fontified t) 333 347 (face font-lock-comment-face fontified t) 347 427 (fontified t) 427 434 (face font-lock-string-face fontified t) 434 457 (fontified t) 457 490 (face slime-reader-conditional-face fontified t) 490 497 (face slime-reader-conditional-face fontified t) 497 498 (face slime-reader-conditional-face fontified t) 498 543 (fontified t) 543 555 (face font-lock-keyword-face fontified t) 555 582 (fontified t) 582 585 (face font-lock-keyword-face fontified t) 585 637 (fontified t) 637 640 (face font-lock-comment-delimiter-face fontified t) 640 655 (face font-lock-comment-face fontified t) 655 741 (fontified t) 741 749 (face font-lock-string-face fontified t) 749 778 (fontified t) 778 807 (face slime-reader-conditional-face fontified t) 807 811 (face slime-reader-conditional-face fontified t) 811 819 (face slime-reader-conditional-face fontified t) 819 820 (face slime-reader-conditional-face fontified t) 820 821 (fontified t) 821 848 (fontified t) 848 851 (face font-lock-comment-delimiter-face fontified t) 851 864 (face font-lock-comment-face fontified t) 864 897 (fontified t) 897 900 (face font-lock-builtin-face fontified t) 900 954 (fontified t) 954 957 (face font-lock-comment-delimiter-face fontified t) 957 971 (face font-lock-comment-face fontified t) 971 995 (fontified t) 995 1000 (face font-lock-warning-face fontified t) 1000 1040 (fontified t) 1040 1073 (face font-lock-string-face fontified t) 1073 1102 (fontified t) 1102 1105 (face font-lock-comment-delimiter-face fontified t) 1105 1122 (face font-lock-comment-face fontified t) 1122 1148 (fontified t) 1148 1161 (face font-lock-keyword-face fontified t) 1161 1249 (fontified t) 1249 1259 (face font-lock-string-face fontified t) 1259 1288 (fontified t) 1288 1321 (face slime-reader-conditional-face fontified t) 1321 1331 (face slime-reader-conditional-face fontified t) 1331 1332 (face slime-reader-conditional-face fontified t) 1332 1359 (fontified t) 1359 1362 (face font-lock-comment-delimiter-face fontified t) 1362 1410 (face font-lock-comment-face fontified t) 1410 1441 (fontified t) 1441 1447 (face font-lock-builtin-face fontified t) 1447 1489 (fontified t) 1489 1492 (face font-lock-comment-delimiter-face fontified t) 1492 1514 (face font-lock-comment-face fontified t) 1514 1532 (fontified t) 1532 1537 (face font-lock-warning-face fontified t) 1537 1548 (fontified t) 1548 1554 (face font-lock-builtin-face fontified t) 1554 1580 (fontified t) 1580 1583 (face font-lock-comment-delimiter-face fontified t) 1583 1628 (face font-lock-comment-face fontified t) 1628 1637 (fontified t) 1637 1639 (face font-lock-keyword-face fontified t) 1639 1658 (fontified t) 1658 1661 (face font-lock-builtin-face fontified t) 1661 1675 (fontified t) 1675 1678 (face font-lock-comment-delimiter-face fontified t) 1678 1711 (face font-lock-comment-face fontified t) 1711 1724 (fontified t) 1724 1730 (face font-lock-keyword-face fontified t) 1730 1771 (fontified t) 1771 1774 (face font-lock-comment-delimiter-face fontified t) 1774 1818 (face font-lock-comment-face fontified t) 1818 1831 (fontified t) 1831 1835 (face font-lock-keyword-face fontified t) 1835 1893 (fontified t) 1893 1897 (face font-lock-string-face fontified t) 1897 1904 (fontified t) 1904 1907 (face font-lock-comment-delimiter-face fontified t) 1907 1965 (face font-lock-comment-face fontified t) 1965 2069 (fontified t) 2069 2075 (face font-lock-keyword-face fontified t) 2075 2153 (fontified t) 2153 2157 (face font-lock-keyword-face fontified t) 2157 2174 (fontified t) 2174 2177 (face font-lock-comment-delimiter-face fontified t) 2177 2236 (face font-lock-comment-face fontified t) 2236 2287 (fontified t) 2287 2321 (face font-lock-string-face fontified t) 2321 2329 (face font-lock-string-face fontified t) 2329 2331 (fontified t) 2331 2349 (fontified t) 2349 2355 (face font-lock-keyword-face fontified t) 2355 2362 (fontified t) 2362 2372 (face font-lock-builtin-face fontified t) 2372 2413 (fontified t) 2413 2416 (face font-lock-comment-delimiter-face fontified t) 2416 2438 (face font-lock-comment-face fontified t) 2438 2563 (fontified t) 2563 2599 (face font-lock-string-face fontified t) 2599 2651 (fontified t) 2651 2655 (face font-lock-keyword-face fontified t) 2655 2744 (fontified t) 2744 2747 (face font-lock-comment-delimiter-face fontified t) 2747 2789 (face font-lock-comment-face fontified t) 2789 2835 (fontified t) 2835 2879 (face font-lock-string-face fontified t) 2879 2899 (fontified t) 2899 2905 (face font-lock-keyword-face fontified t) 2905 2912 (fontified t) 2912 2921 (face font-lock-builtin-face fontified t) 2921 2934 (fontified t) 2934 2948 (face font-lock-string-face fontified t) 2948 2965 (fontified t) 2965 2968 (face font-lock-comment-delimiter-face fontified t) 2968 2991 (face font-lock-comment-face fontified t) 2991 2994 (face font-lock-comment-delimiter-face fontified t) 2994 3057 (face font-lock-comment-face fontified t) 3057 3060 (face font-lock-comment-delimiter-face fontified t) 3060 3121 (face font-lock-comment-face fontified t) 3121 3122 (fontified t) 3122 3130 (face font-lock-keyword-face fontified t) 3130 3131 (fontified t) 3131 3138 (face font-lock-function-name-face fontified t) 3138 3141 (fontified t) 3141 3145 (face font-lock-type-face fontified t) 3145 3157 (fontified t) 3157 3172 (face font-lock-builtin-face fontified t) 3172 3263 (fontified t) 3263 3268 (face font-lock-type-face fontified t) 3268 3278 (fontified t) 3278 3285 (face font-lock-keyword-face fontified t) 3285 3319 (fontified t) 3319 3322 (face font-lock-keyword-face fontified t) 3322 3341 (fontified t) 3341 3346 (face font-lock-string-face fontified t) 3346 3356 (fontified t) 3356 3359 (face font-lock-keyword-face fontified t) 3359 3392 (fontified t) 3392 3398 (face font-lock-keyword-face fontified t) 3398 3439 (fontified t) 3439 3442 (face font-lock-comment-delimiter-face fontified t) 3442 3495 (face font-lock-comment-face fontified t) 3495 3503 (fontified t) 3503 3507 (face font-lock-keyword-face fontified t) 3507 3542 (fontified t) 3542 3545 (face font-lock-comment-delimiter-face fontified t) 3545 3572 (face font-lock-comment-face fontified t) 3572 3582 (fontified t) 3582 3585 (face font-lock-builtin-face fontified t) 3585 3621 (fontified t) 3621 3624 (face font-lock-comment-delimiter-face fontified t) 3624 3677 (face font-lock-comment-face fontified t) 3677 3687 (fontified t) 3687 3697 (face font-lock-builtin-face fontified t) 3697 3710 (fontified t) 3710 3715 (face font-lock-warning-face fontified t) 3715 3770 (fontified t) 3770 3778 (face font-lock-builtin-face fontified t) 3778 3815 (fontified t) 3815 3818 (face font-lock-comment-delimiter-face fontified t) 3818 3831 (face font-lock-comment-face fontified t) 3831 3835 (face font-lock-comment-face fontified t) 3835 3845 (fontified t) 3845 3854 (face font-lock-builtin-face fontified t) 3854 3866 (fontified t) 3866 3871 (face font-lock-warning-face fontified t) 3871 3892 (fontified t)) . 8315) (undo-tree-id21 . -3892) (t 26976 59906 0 0)) nil (26976 61197 926508 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12298 . 12299) (nil fontified nil 8315 . 12299) (8315 . 12299)) nil (26976 61197 926506 0) 0 nil])
([nil nil ((#(";" 0 1 (face font-lock-comment-face fontified t)) . -8368) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (#(";" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -8369) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (#(" " 0 1 (face font-lock-comment-delimiter-face fontified t)) . -8370) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) 8371) nil (26976 61197 926502 0) 0 nil])
([nil nil ((#("config" 0 6 (fontified t)) . -4846) (undo-tree-id22 . -6) 4852 (t 26976 61197 0 0)) nil (26976 61426 710385 0) 0 nil])
([nil nil ((4846 . 4849)) nil (26976 61426 710373 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  (format t \"~&[DB-TX] logic call (Safe-Return-Value).~%\")
  
  (let ((attempt 0))
    (loop
      (let ((outcome
             ;; Bloc de protection connection
             (block db-attempt
               (handler-case
                   (ensure-connection
                     ;; --- BEGIN (Raw) ---
                     #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                     #-postmodern (lumen.data.db:exec \"BEGIN\")
                     
                     (handler-case
                         (let ((res (funcall thunk)))
                           ;; --- COMMIT (Raw) ---
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                           #-postmodern (lumen.data.db:exec \"COMMIT\")
                           ;; Colis Succès (:ok . resultat)
                           (cons :ok res))
                       
                       ;; CATCH INTERNE
                       (error (c)
                         ;; (format t \"~&[DB-TX] Caught internal: ~A~%\" c)
                         ;; --- ROLLBACK (Raw + Ignore Errors) ---
                         (ignore-errors 
                           #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                           #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                         ;; Colis Erreur (:error . condition)
                         (cons :error c))))
                 
                 ;; Catch échec connexion pur
                 (error (c) (cons :error c))))))
        
        ;; ANALYSE DU COLIS (Zone Sûre, hors connexion)
        (if (eq (car outcome) :ok)
            ;; Succès : on retourne le résultat directement
            (return (cdr outcome))
            
            ;; Échec : on décide (Retry ou Return Message)
            (let* ((err (cdr outcome))
                   ;; Conversion immédiate en texte pour tuer les références de pile mortes
                   (msg (format nil \"~A\" err)) 
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (cond
                ;; A) Erreur Métier -> On retourne le type spécial :app-error
                (is-app
                 ;; (format t \"~&[DB-TX] App error -> Return message.~%\")
                 (return (cons :app-error msg)))
                
                ;; B) Retry -> On boucle
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 ;; (format t \"~&[DB-TX] Retryable. Sleeping...~%\")
                 (incf attempt)
                 (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0))))
                
                ;; C) Fatal -> On retourne le type :db-error
                (t
                 ;; (format t \"~&[DB-TX] Fatal error -> Return message.~%\")
                 (return (cons :db-error (format nil \"Database Error: ~A\" msg)))))))))))

;; 2. LA MACRO \"DÉCIDEUR\" (Interface externe)
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  (let ((res-sym (gensym \"RES\")))
    `(let ((,res-sym (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)))
       ;; Log de debug pour prouver que c'est la NOUVELLE macro qui tourne
       ;; (format t \"~&[MACRO-CHECK] Executing Safe Macro logic.~%\")
       
       (case (car ,res-sym)
         ;; SUCCÈS : on rend la donnée brute
         (:ok (cdr ,res-sym))
         
         ;; ERREUR MÉTIER : On lance l'erreur PROPREMENT pour le Middleware
         (:app-error 
          (error 'lumen.core.error:application-error 
                 :message (cdr ,res-sym)))
         
         ;; ERREUR TECHNIQUE
         (:db-error
          (error (cdr ,res-sym)))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 51 (fontified t) 51 53 (fontified t) 53 63 (fontified t) 63 108 (face font-lock-string-face fontified t) 108 110 (fontified t) 110 116 (fontified t) 116 119 (face font-lock-keyword-face fontified t) 119 139 (fontified t) 139 143 (face font-lock-keyword-face fontified t) 143 151 (fontified t) 151 154 (face font-lock-keyword-face fontified t) 154 178 (fontified t) 178 181 (face font-lock-comment-delimiter-face fontified t) 181 211 (face font-lock-comment-face fontified t) 211 225 (fontified t) 225 230 (face font-lock-keyword-face fontified t) 230 258 (fontified t) 258 270 (face font-lock-keyword-face fontified t) 270 330 (fontified t) 330 333 (face font-lock-comment-delimiter-face fontified t) 333 353 (face font-lock-comment-face fontified t) 353 433 (fontified t) 433 440 (face font-lock-string-face fontified t) 440 463 (fontified t) 463 496 (face slime-reader-conditional-face fontified t) 496 503 (face slime-reader-conditional-face fontified t) 503 504 (face slime-reader-conditional-face fontified t) 504 549 (fontified t) 549 561 (face font-lock-keyword-face fontified t) 561 588 (fontified t) 588 591 (face font-lock-keyword-face fontified t) 591 643 (fontified t) 643 646 (face font-lock-comment-delimiter-face fontified t) 646 667 (face font-lock-comment-face fontified t) 667 753 (fontified t) 753 761 (face font-lock-string-face fontified t) 761 790 (fontified t) 790 823 (face slime-reader-conditional-face fontified t) 823 831 (face slime-reader-conditional-face fontified t) 831 832 (face slime-reader-conditional-face fontified t) 832 860 (fontified t) 860 863 (face font-lock-comment-delimiter-face fontified t) 863 893 (face font-lock-comment-face fontified t) 893 926 (fontified t) 926 929 (face font-lock-builtin-face fontified t) 929 983 (fontified t) 983 986 (face font-lock-comment-delimiter-face fontified t) 986 1000 (face font-lock-comment-face fontified t) 1000 1024 (fontified t) 1024 1029 (face font-lock-warning-face fontified t) 1029 1059 (fontified t) 1059 1062 (face font-lock-comment-delimiter-face fontified t) 1062 1109 (face font-lock-comment-face fontified t) 1109 1130 (fontified t) 1130 1134 (fontified t) 1134 1137 (face font-lock-comment-delimiter-face fontified t) 1137 1176 (face font-lock-comment-face fontified t) 1176 1202 (fontified t) 1202 1215 (fontified t face font-lock-keyword-face) 1215 1303 (fontified t) 1303 1313 (fontified t face font-lock-string-face) 1313 1342 (fontified t) 1342 1375 (fontified t face slime-reader-conditional-face) 1375 1385 (fontified t face slime-reader-conditional-face) 1385 1386 (fontified t face slime-reader-conditional-face) 1386 1413 (fontified t) 1413 1416 (fontified t face font-lock-comment-delimiter-face) 1416 1450 (fontified t face font-lock-comment-face) 1450 1481 (fontified t) 1481 1487 (fontified t face font-lock-builtin-face) 1487 1497 (fontified t) 1497 1512 (fontified t) 1512 1529 (fontified t) 1529 1532 (fontified t face font-lock-comment-delimiter-face) 1532 1558 (fontified t face font-lock-comment-face) 1558 1576 (fontified t) 1576 1581 (fontified t face font-lock-warning-face) 1581 1592 (fontified t) 1592 1598 (fontified t face font-lock-builtin-face) 1598 1610 (fontified t) 1610 1616 (fontified t) 1616 1624 (fontified t) 1624 1627 (fontified t face font-lock-comment-delimiter-face) 1627 1672 (fontified t face font-lock-comment-face) 1672 1681 (fontified t) 1681 1683 (fontified t face font-lock-keyword-face) 1683 1702 (fontified t) 1702 1705 (fontified t face font-lock-builtin-face) 1705 1719 (fontified t) 1719 1722 (fontified t face font-lock-comment-delimiter-face) 1722 1767 (fontified t face font-lock-comment-face) 1767 1780 (fontified t) 1780 1786 (fontified t face font-lock-keyword-face) 1786 1827 (fontified t) 1827 1830 (fontified t face font-lock-comment-delimiter-face) 1830 1874 (fontified t face font-lock-comment-face) 1874 1887 (fontified t) 1887 1891 (fontified t face font-lock-keyword-face) 1891 1932 (fontified t) 1932 1935 (fontified t face font-lock-comment-delimiter-face) 1935 2005 (fontified t face font-lock-comment-face) 2005 2041 (fontified t) 2041 2045 (fontified t face font-lock-string-face) 2045 2157 (fontified t) 2157 2163 (fontified t face font-lock-keyword-face) 2163 2241 (fontified t) 2241 2245 (fontified t face font-lock-keyword-face) 2245 2262 (fontified t) 2262 2265 (fontified t face font-lock-comment-delimiter-face) 2265 2324 (fontified t face font-lock-comment-face) 2324 2365 (fontified t) 2365 2368 (fontified t face font-lock-comment-delimiter-face) 2368 2422 (fontified t face font-lock-comment-face) 2422 2440 (fontified t) 2440 2446 (fontified t face font-lock-keyword-face) 2446 2453 (fontified t) 2453 2463 (fontified t face font-lock-builtin-face) 2463 2504 (fontified t) 2504 2507 (fontified t face font-lock-comment-delimiter-face) 2507 2529 (fontified t face font-lock-comment-face) 2529 2644 (fontified t) 2644 2647 (fontified t face font-lock-comment-delimiter-face) 2647 2695 (fontified t face font-lock-comment-face) 2695 2745 (fontified t) 2745 2749 (fontified t face font-lock-keyword-face) 2749 2838 (fontified t) 2838 2841 (fontified t face font-lock-comment-delimiter-face) 2841 2883 (fontified t face font-lock-comment-face) 2883 2919 (fontified t) 2919 2922 (fontified t face font-lock-comment-delimiter-face) 2922 2978 (fontified t face font-lock-comment-face) 2978 2996 (fontified t) 2996 3002 (face font-lock-keyword-face fontified t) 3002 3009 (fontified t) 3009 3012 (face font-lock-builtin-face fontified t) 3012 3018 (face font-lock-builtin-face fontified t) 3018 3031 (fontified t) 3031 3051 (face font-lock-string-face fontified t) 3051 3067 (fontified t) 3067 3068 (fontified t) 3068 3071 (face font-lock-comment-delimiter-face fontified t) 3071 3114 (face font-lock-comment-face fontified t) 3114 3115 (fontified t) 3115 3123 (fontified t face font-lock-keyword-face) 3123 3124 (fontified t) 3124 3131 (fontified t face font-lock-function-name-face) 3131 3134 (fontified t) 3134 3138 (fontified t face font-lock-type-face) 3138 3150 (fontified t) 3150 3165 (fontified t face font-lock-builtin-face) 3165 3237 (fontified t) 3237 3256 (fontified t) 3256 3261 (fontified t face font-lock-type-face) 3261 3271 (fontified t) 3271 3278 (fontified t face font-lock-keyword-face) 3278 3312 (fontified t) 3312 3315 (fontified t face font-lock-keyword-face) 3315 3334 (fontified t) 3334 3339 (fontified t face font-lock-string-face) 3339 3349 (fontified t) 3349 3352 (fontified t face font-lock-keyword-face) 3352 3385 (fontified t) 3385 3391 (fontified t face font-lock-keyword-face) 3391 3432 (fontified t) 3432 3435 (fontified t face font-lock-comment-delimiter-face) 3435 3500 (fontified t face font-lock-comment-face) 3500 3507 (fontified t) 3507 3510 (fontified t face font-lock-comment-delimiter-face) 3510 3569 (fontified t face font-lock-comment-face) 3569 3585 (fontified t) 3585 3589 (fontified t face font-lock-keyword-face) 3589 3614 (fontified t) 3614 3617 (fontified t face font-lock-comment-delimiter-face) 3617 3650 (fontified t face font-lock-comment-face) 3650 3660 (fontified t) 3660 3663 (fontified t face font-lock-builtin-face) 3663 3699 (fontified t) 3699 3702 (fontified t face font-lock-comment-delimiter-face) 3702 3766 (fontified t face font-lock-comment-face) 3766 3776 (fontified t) 3776 3786 (fontified t face font-lock-builtin-face) 3786 3799 (fontified t) 3799 3804 (fontified t face font-lock-warning-face) 3804 3859 (fontified t) 3859 3867 (fontified t face font-lock-builtin-face) 3867 3904 (fontified t) 3904 3907 (fontified t face font-lock-comment-delimiter-face) 3907 3924 (fontified t face font-lock-comment-face) 3924 3934 (fontified t) 3934 3943 (fontified t face font-lock-builtin-face) 3943 3944 (fontified t) 3944 3955 (fontified t) 3955 3960 (face font-lock-warning-face fontified t) 3960 3980 (fontified t) 3980 3981 (fontified t rear-nonsticky t)) . 8312) (undo-tree-id23 . -3981) (undo-tree-id24 . -53) (undo-tree-id25 . -308) (undo-tree-id26 . -109) (undo-tree-id27 . -3981) (undo-tree-id28 . -3981) (t 26976 61426 0 0)) nil (26976 61757 178059 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12924 . 12925) (nil fontified nil 8312 . 12925) (8312 . 12925)) nil (26976 61757 178044 0) 0 nil])
([nil nil ((11992 . 11993) (t 26976 61757 0 0)) nil (26976 61783 159414 0) 0 nil])
([nil nil ((#("(defun call-with-tx-logic (thunk retries sleep-ms)
  \"Exécute une transaction avec l'architecture Try/Finally (UNWIND-PROTECT).
   C'est la méthode la plus stable pour gérer les ressources en Common Lisp.\"
  
  (let ((attempt 0))
    (loop
      (block attempt-block
        ;; 1. On ouvre la connexion
        (ensure-connection
          (let ((tx-committed nil)  ; A-t-on réussi le commit ?
                (tx-error nil)      ; A-t-on capturé une erreur ?
                (result nil))       ; Le résultat final
            
            ;; 2. Bloc de protection PRINCIPAL (Try / Finally)
            (unwind-protect
                 (progn
                   ;; --- BEGIN ---
                   ;; Utilisation de raw SQL pour éviter les interférences
                   #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                   #-postmodern (lumen.data.db:exec \"BEGIN\")
                   
                   ;; --- EXECUTION ---
                   ;; On capture les erreurs ICI pour éviter qu'elles ne remontent
                   ;; avant qu'on ait pu décider du sort de la transaction.
                   (handler-case
                       (progn
                         (setf result (funcall thunk))
                         
                         ;; --- COMMIT ---
                         #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                         #-postmodern (lumen.data.db:exec \"COMMIT\")
                         
                         (setf tx-committed t))
                     
                     ;; Capture erreur
                     (error (c)
                       (setf tx-error c))))
              
              ;; 3. CLEANUP (Finally)
              ;; Ce code s'exécute TOUJOURS, quoi qu'il arrive (succès, erreur, saut...)
              (unless tx-committed
                ;; Si pas commité, on ROLLBACK silencieusement
                (ignore-errors 
                  #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                  #-postmodern (lumen.data.db:exec \"ROLLBACK\"))))
            
            ;; 4. ANALYSE (Toujours dans ensure-connection mais après le cleanup DB)
            (cond
              ;; Succès
              (tx-committed
               (return-from call-with-tx-logic result))
              
              ;; Erreur capturée
              (tx-error
               (let* ((err tx-error)
                      ;; On extrait le message tout de suite (Sanitisation)
                      (msg (format nil \"~A\" err))
                      (is-app (typep err 'lumen.core.error:application-error))
                      (mapped (unless is-app (lumen.data.errors:map-db-error err))))
                 
                 (cond
                   ;; A) Erreur Métier -> On retourne un objet spécial
                   ;; (On ne lance PAS l'erreur ici pour ne pas perturber la pile)
                   (is-app
                    (return-from call-with-tx-logic (cons :app-error msg)))
                   
                   ;; B) Retry -> On ne fait rien, le LOOP va relancer
                   ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                    (incf attempt)
                    (when (plusp sleep-ms) 
                      (sleep (/ (max 0 sleep-ms) 1000.0)))
                    ;; On laisse le flow sortir du block attempt-block et le loop continue
                    )
                   
                   ;; C) Fatal
                   (t
                    (return-from call-with-tx-logic 
                      (cons :db-error (format nil \"DB Error: ~A\" msg))))))))))))))


(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  (let ((res-sym (gensym \"RES\")))
    `(let ((,res-sym (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)))
       ;; Inspection du résultat
       (if (and (consp ,res-sym) (keywordp (car ,res-sym)))
           ;; C'est une erreur spéciale (:app-error ou :db-error)
           (case (car ,res-sym)
             (:app-error 
              ;; C'est ici que le middleware attrape l'erreur.
              ;; On utilise error simple avec les arguments corrects.
              (error 'lumen.core.error:application-error 
                     :message (cdr ,res-sym)))
             
             (:db-error
              (error (cdr ,res-sym))))
           
           ;; Sinon c'est le résultat brut (succès)
           ,res-sym))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 53 (fontified t) 53 205 (face font-lock-doc-face fontified t) 205 212 (fontified t) 212 215 (face font-lock-keyword-face fontified t) 215 235 (fontified t) 235 239 (face font-lock-keyword-face fontified t) 239 247 (fontified t) 247 252 (face font-lock-keyword-face fontified t) 252 275 (fontified t) 275 278 (face font-lock-comment-delimiter-face fontified t) 278 303 (face font-lock-comment-face fontified t) 303 341 (fontified t) 341 344 (face font-lock-keyword-face fontified t) 344 366 (fontified t) 366 394 (face font-lock-comment-face fontified t) 394 430 (fontified t) 430 460 (face font-lock-comment-face fontified t) 460 496 (fontified t) 496 516 (face font-lock-comment-face fontified t) 516 541 (fontified t) 541 544 (face font-lock-comment-delimiter-face fontified t) 544 592 (face font-lock-comment-face fontified t) 592 605 (fontified t) 605 619 (face font-lock-keyword-face fontified t) 619 638 (fontified t) 638 643 (face font-lock-keyword-face fontified t) 643 663 (fontified t) 663 666 (face font-lock-comment-delimiter-face fontified t) 666 680 (face font-lock-comment-face fontified t) 680 699 (fontified t) 699 702 (face font-lock-comment-delimiter-face fontified t) 702 755 (face font-lock-comment-face fontified t) 755 833 (fontified t) 833 840 (face font-lock-string-face fontified t) 840 861 (fontified t) 861 894 (face slime-reader-conditional-face fontified t) 894 901 (face slime-reader-conditional-face fontified t) 901 902 (face slime-reader-conditional-face fontified t) 902 942 (fontified t) 942 945 (face font-lock-comment-delimiter-face fontified t) 945 963 (face font-lock-comment-face fontified t) 963 982 (fontified t) 982 985 (face font-lock-comment-delimiter-face fontified t) 985 1046 (face font-lock-comment-face fontified t) 1046 1065 (fontified t) 1065 1068 (face font-lock-comment-delimiter-face fontified t) 1068 1122 (face font-lock-comment-face fontified t) 1122 1142 (fontified t) 1142 1154 (face font-lock-keyword-face fontified t) 1154 1179 (fontified t) 1179 1184 (face font-lock-keyword-face fontified t) 1184 1291 (fontified t) 1291 1294 (face font-lock-comment-delimiter-face fontified t) 1294 1309 (face font-lock-comment-face fontified t) 1309 1393 (fontified t) 1393 1401 (face font-lock-string-face fontified t) 1401 1428 (fontified t) 1428 1461 (face slime-reader-conditional-face fontified t) 1461 1469 (face slime-reader-conditional-face fontified t) 1469 1470 (face slime-reader-conditional-face fontified t) 1470 1500 (fontified t) 1500 1545 (fontified t) 1545 1588 (fontified t) 1588 1591 (face font-lock-comment-delimiter-face fontified t) 1591 1606 (face font-lock-comment-face fontified t) 1606 1628 (fontified t) 1628 1633 (face font-lock-warning-face fontified t) 1633 1711 (fontified t) 1711 1714 (face font-lock-comment-delimiter-face fontified t) 1714 1735 (face font-lock-comment-face fontified t) 1735 1749 (fontified t) 1749 1752 (face font-lock-comment-delimiter-face fontified t) 1752 1824 (face font-lock-comment-face fontified t) 1824 1839 (fontified t) 1839 1845 (face font-lock-keyword-face fontified t) 1845 1875 (fontified t) 1875 1878 (face font-lock-comment-delimiter-face fontified t) 1878 1922 (face font-lock-comment-face fontified t) 1922 1939 (fontified t) 1939 1952 (face font-lock-keyword-face fontified t) 1952 2031 (fontified t) 2031 2041 (face font-lock-string-face fontified t) 2041 2061 (fontified t) 2061 2094 (face slime-reader-conditional-face fontified t) 2094 2104 (face slime-reader-conditional-face fontified t) 2104 2105 (face slime-reader-conditional-face fontified t) 2105 2134 (fontified t) 2134 2137 (face font-lock-comment-delimiter-face fontified t) 2137 2207 (face font-lock-comment-face fontified t) 2207 2220 (fontified t) 2220 2224 (face font-lock-keyword-face fontified t) 2224 2239 (fontified t) 2239 2242 (face font-lock-comment-delimiter-face fontified t) 2242 2249 (face font-lock-comment-face fontified t) 2249 2293 (fontified t) 2293 2304 (face font-lock-keyword-face fontified t) 2304 2362 (fontified t) 2362 2365 (face font-lock-comment-delimiter-face fontified t) 2365 2381 (face font-lock-comment-face fontified t) 2381 2421 (fontified t) 2421 2425 (face font-lock-keyword-face fontified t) 2425 2464 (fontified t) 2464 2467 (face font-lock-comment-delimiter-face fontified t) 2467 2518 (face font-lock-comment-face fontified t) 2518 2557 (fontified t) 2557 2561 (face font-lock-string-face fontified t) 2561 2678 (fontified t) 2678 2684 (face font-lock-keyword-face fontified t) 2684 2768 (fontified t) 2768 2772 (face font-lock-keyword-face fontified t) 2772 2792 (fontified t) 2792 2795 (face font-lock-comment-delimiter-face fontified t) 2795 2844 (face font-lock-comment-face fontified t) 2844 2863 (fontified t) 2863 2866 (face font-lock-comment-delimiter-face fontified t) 2866 2927 (face font-lock-comment-face fontified t) 2927 2975 (fontified t) 2975 2986 (face font-lock-keyword-face fontified t) 2986 3012 (fontified t) 3012 3022 (face font-lock-builtin-face fontified t) 3022 3069 (fontified t) 3069 3072 (face font-lock-comment-delimiter-face fontified t) 3072 3121 (face font-lock-comment-face fontified t) 3121 3278 (fontified t) 3278 3282 (face font-lock-keyword-face fontified t) 3282 3380 (fontified t) 3380 3383 (face font-lock-comment-delimiter-face fontified t) 3383 3451 (face font-lock-comment-face fontified t) 3451 3512 (fontified t) 3512 3515 (face font-lock-comment-delimiter-face fontified t) 3515 3524 (face font-lock-comment-face fontified t) 3524 3567 (fontified t) 3567 3578 (face font-lock-keyword-face fontified t) 3578 3599 (fontified t) 3599 3627 (fontified t) 3627 3636 (face font-lock-builtin-face fontified t) 3636 3649 (fontified t) 3649 3663 (face font-lock-string-face fontified t) 3663 3682 (fontified t) 3682 3685 (fontified t) 3685 3693 (face font-lock-keyword-face fontified t) 3693 3694 (fontified t) 3694 3701 (face font-lock-function-name-face fontified t) 3701 3704 (fontified t) 3704 3708 (face font-lock-type-face fontified t) 3708 3720 (fontified t) 3720 3735 (face font-lock-builtin-face fontified t) 3735 3826 (fontified t) 3826 3831 (face font-lock-type-face fontified t) 3831 3841 (fontified t) 3841 3848 (face font-lock-keyword-face fontified t) 3848 3882 (fontified t) 3882 3885 (face font-lock-keyword-face fontified t) 3885 3904 (fontified t) 3904 3909 (face font-lock-string-face fontified t) 3909 3919 (fontified t) 3919 3922 (face font-lock-keyword-face fontified t) 3922 3955 (fontified t) 3955 3961 (face font-lock-keyword-face fontified t) 3961 4002 (fontified t) 4002 4005 (face font-lock-comment-delimiter-face fontified t) 4005 4028 (face font-lock-comment-face fontified t) 4028 4036 (fontified t) 4036 4038 (face font-lock-keyword-face fontified t) 4038 4099 (fontified t) 4099 4102 (face font-lock-comment-delimiter-face fontified t) 4102 4154 (face font-lock-comment-face fontified t) 4154 4166 (fontified t) 4166 4170 (face font-lock-keyword-face fontified t) 4170 4200 (fontified t) 4200 4210 (face font-lock-builtin-face fontified t) 4210 4226 (fontified t) 4226 4229 (face font-lock-comment-delimiter-face fontified t) 4229 4275 (face font-lock-comment-face fontified t) 4275 4289 (fontified t) 4289 4292 (face font-lock-comment-delimiter-face fontified t) 4292 4345 (face font-lock-comment-face fontified t) 4345 4360 (fontified t) 4360 4365 (face font-lock-warning-face fontified t) 4365 4424 (fontified t) 4424 4432 (face font-lock-builtin-face fontified t) 4432 4478 (fontified t) 4478 4487 (face font-lock-builtin-face fontified t) 4487 4503 (fontified t) 4503 4508 (face font-lock-warning-face fontified t) 4508 4550 (fontified t) 4550 4553 (face font-lock-comment-delimiter-face fontified t) 4553 4591 (face font-lock-comment-face fontified t) 4591 4613 (fontified t) 4613 4614 (fontified t rear-nonsticky t)) . 8312) (undo-tree-id34 . -4614) (undo-tree-id35 . -2518) (undo-tree-id36 . -3912) (undo-tree-id37 . -3912) (undo-tree-id38 . -3912) (t 26976 61783 0 0)) nil (26976 62255 591403 0) 0 nil])
([nil nil ((#(";; 1. LA FONCTION \"FACTEUR\"
;; Elle fait le travail et retourne un colis : (:ok . resultat) ou (:error . message)
;; Elle ne lance AUCUNE exception, donc elle ne peut pas casser la pile.
" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 28 (face font-lock-comment-face fontified t) 28 31 (face font-lock-comment-delimiter-face fontified t) 31 114 (face font-lock-comment-face fontified t) 114 117 (face font-lock-comment-delimiter-face fontified t) 117 187 (face font-lock-comment-face fontified t)) . 8125) (undo-tree-id29 . -187) (undo-tree-id30 . -187) (undo-tree-id31 . -187) (undo-tree-id32 . -187) (undo-tree-id33 . -187)) nil (26976 62255 591396 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12561 . 12562) (nil fontified nil 8125 . 12562) (8125 . 12562)) nil (26976 62255 591379 0) 0 nil])
([nil nil ((#(";; 1. LA BOÎTE AUX LETTRES (Canal latéral)
;; Cette variable va stocker le résultat de la transaction (Succès ou Erreur)
;; de manière indépendante du flux de retour des fonctions.
(defvar *tx-outcome* nil)

;; 2. LA FONCTION LOGIQUE (Le Travailleur)
(defun call-with-tx-logic (thunk retries sleep-ms)
  (let ((attempt 0))
    (loop
      ;; On réinitialise l'issue pour cette tentative
      (setf *tx-outcome* nil)
      
      ;; Bloc de connexion
      (handler-case
          (ensure-connection
            ;; --- BEGIN ---
            #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
            #-postmodern (lumen.data.db:exec \"BEGIN\")
            
            (handler-case
                (let ((res (funcall thunk)))
                  ;; --- COMMIT ---
                  #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                  #-postmodern (lumen.data.db:exec \"COMMIT\")
                  
                  ;; SUCCÈS : On écrit le résultat dans la boîte aux lettres
                  (setf *tx-outcome* (cons :success res)))
              
              ;; CATCH ERREUR INTERNE
              (error (c)
                ;; --- ROLLBACK ---
                (ignore-errors 
                  #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                  #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                
                ;; ERREUR : On écrit l'erreur dans la boîte aux lettres
                (setf *tx-outcome* (cons :error c)))))
        
        ;; Catch erreur connexion (avant le begin)
        (error (c)
          (setf *tx-outcome* (cons :error c))))
      
      ;; ANALYSE DE LA BOÎTE AUX LETTRES (Hors de la connexion)
      ;; Ici, la connexion est fermée. La pile est propre.
      
      (let ((status (car *tx-outcome*))
            (payload (cdr *tx-outcome*)))
        
        (if (eq status :success)
            ;; CAS 1 : Succès -> On retourne la valeur normalement
            (return payload)
            
            ;; CAS 2 : Échec -> On analyse le payload
            (let* ((err payload)
                   ;; Sanitisation : on extrait le texte TOUT DE SUITE
                   (msg (format nil \"~A\" err))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (cond
                ;; A) Erreur Métier -> On ne fait RIEN.
                ;; On laisse *tx-outcome* tel quel (:error . c) et on sort de la boucle.
                ;; La macro s'occupera de lancer l'erreur.
                (is-app
                 (return nil))
                
                ;; B) Retry -> On boucle
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (incf attempt)
                 (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0))))
                
                ;; C) Fatal -> On ne fait RIEN.
                ;; On sort, et la macro lancera l'erreur.
                (t
                 (return nil)))))))))

;; 3. LA MACRO (Le Chef d'Orchestre)
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only))
  ;; On utilise PROG1 pour exécuter la logique, mais on ignore sa valeur de retour
  ;; si une erreur est présente dans la variable *tx-outcome*.
  `(let ((*tx-outcome* nil)) ;; Nouvelle boîte aux lettres pour cette TX (Thread-Local)
     (let ((res (call-with-tx-logic (lambda () ,@body) ,retries ,sleep-ms)))
       
       ;; INSPECTION DE LA BOÎTE AUX LETTRES
       (if (and (consp *tx-outcome*)
                (eq (car *tx-outcome*) :error))
           
           ;; CAS ERREUR : C'est ICI que l'erreur est lancée.
           ;; Nous sommes dans le contexte lexical de repo-patch, pas dans la DB.
           (let ((err (cdr *tx-outcome*)))
             (if (typep err 'lumen.core.error:application-error)
                 ;; On relance une copie propre pour le Middleware
                 (error 'lumen.core.error:application-error 
                        :message (format nil \"~A\" err))
                 ;; Erreur technique
                 (error \"Database Error: ~A\" err)))
           
           ;; CAS SUCCÈS : On retourne le résultat calculé
           res))))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 43 (face font-lock-comment-face fontified t) 43 46 (face font-lock-comment-delimiter-face fontified t) 46 121 (face font-lock-comment-face fontified t) 121 124 (face font-lock-comment-delimiter-face fontified t) 124 181 (face font-lock-comment-face fontified t) 181 182 (fontified t) 182 188 (face font-lock-keyword-face fontified t) 188 189 (fontified t) 189 201 (face font-lock-variable-name-face fontified t) 201 208 (fontified t) 208 211 (face font-lock-comment-delimiter-face fontified t) 211 251 (face font-lock-comment-face fontified t) 251 252 (fontified t) 252 257 (face font-lock-keyword-face fontified t) 257 258 (fontified t) 258 276 (face font-lock-function-name-face fontified t) 276 305 (fontified t) 305 308 (face font-lock-keyword-face fontified t) 308 328 (fontified t) 328 332 (face font-lock-keyword-face fontified t) 332 339 (fontified t) 339 342 (face font-lock-comment-delimiter-face fontified t) 342 387 (face font-lock-comment-face fontified t) 387 430 (fontified t) 430 433 (face font-lock-comment-delimiter-face fontified t) 433 451 (face font-lock-comment-face fontified t) 451 458 (fontified t) 458 470 (face font-lock-keyword-face fontified t) 470 512 (fontified t) 512 515 (face font-lock-comment-delimiter-face fontified t) 515 529 (face font-lock-comment-face fontified t) 529 600 (fontified t) 600 607 (face font-lock-string-face fontified t) 607 621 (fontified t) 621 654 (face slime-reader-conditional-face fontified t) 654 661 (face slime-reader-conditional-face fontified t) 661 662 (face slime-reader-conditional-face fontified t) 662 689 (fontified t) 689 701 (face font-lock-keyword-face fontified t) 701 719 (fontified t) 719 722 (face font-lock-keyword-face fontified t) 722 765 (fontified t) 765 768 (face font-lock-comment-delimiter-face fontified t) 768 783 (face font-lock-comment-face fontified t) 783 860 (fontified t) 860 868 (face font-lock-string-face fontified t) 868 888 (fontified t) 888 921 (face slime-reader-conditional-face fontified t) 921 929 (face slime-reader-conditional-face fontified t) 929 930 (face slime-reader-conditional-face fontified t) 930 968 (fontified t) 968 971 (face font-lock-comment-delimiter-face fontified t) 971 994 (face font-lock-comment-face fontified t) 994 1027 (face font-lock-comment-face fontified t) 1027 1070 (fontified t) 1070 1078 (face font-lock-builtin-face fontified t) 1078 1115 (fontified t) 1115 1118 (face font-lock-comment-delimiter-face fontified t) 1118 1139 (face font-lock-comment-face fontified t) 1139 1154 (fontified t) 1154 1159 (face font-lock-warning-face fontified t) 1159 1180 (fontified t) 1180 1183 (face font-lock-comment-delimiter-face fontified t) 1183 1200 (face font-lock-comment-face fontified t) 1200 1217 (fontified t) 1217 1230 (face font-lock-keyword-face fontified t) 1230 1309 (fontified t) 1309 1319 (face font-lock-string-face fontified t) 1319 1339 (fontified t) 1339 1372 (face slime-reader-conditional-face fontified t) 1372 1382 (face slime-reader-conditional-face fontified t) 1382 1383 (face slime-reader-conditional-face fontified t) 1383 1418 (fontified t) 1418 1421 (face font-lock-comment-delimiter-face fontified t) 1421 1474 (face font-lock-comment-face fontified t) 1474 1515 (fontified t) 1515 1521 (face font-lock-builtin-face fontified t) 1521 1546 (fontified t) 1546 1549 (face font-lock-comment-delimiter-face fontified t) 1549 1589 (face font-lock-comment-face fontified t) 1589 1598 (fontified t) 1598 1603 (face font-lock-warning-face fontified t) 1603 1643 (fontified t) 1643 1649 (face font-lock-builtin-face fontified t) 1649 1669 (fontified t) 1669 1672 (face font-lock-comment-delimiter-face fontified t) 1672 1727 (face font-lock-comment-face fontified t) 1727 1733 (fontified t) 1733 1736 (face font-lock-comment-delimiter-face fontified t) 1736 1786 (face font-lock-comment-face fontified t) 1786 1800 (fontified t) 1800 1803 (face font-lock-keyword-face fontified t) 1803 1893 (fontified t) 1893 1895 (face font-lock-keyword-face fontified t) 1895 1907 (fontified t) 1907 1915 (face font-lock-builtin-face fontified t) 1915 1929 (fontified t) 1929 1932 (face font-lock-comment-delimiter-face fontified t) 1932 1984 (face font-lock-comment-face fontified t) 1984 1997 (fontified t) 1997 2003 (face font-lock-keyword-face fontified t) 2003 2038 (fontified t) 2038 2041 (face font-lock-comment-delimiter-face fontified t) 2041 2080 (face font-lock-comment-face fontified t) 2080 2093 (fontified t) 2093 2097 (face font-lock-keyword-face fontified t) 2097 2132 (fontified t) 2132 2135 (face font-lock-comment-delimiter-face fontified t) 2135 2184 (face font-lock-comment-face fontified t) 2184 2220 (fontified t) 2220 2224 (face font-lock-string-face fontified t) 2224 2335 (fontified t) 2335 2341 (face font-lock-keyword-face fontified t) 2341 2419 (fontified t) 2419 2423 (face font-lock-keyword-face fontified t) 2423 2440 (fontified t) 2440 2443 (face font-lock-comment-delimiter-face fontified t) 2443 2480 (face font-lock-comment-face fontified t) 2480 2496 (fontified t) 2496 2499 (face font-lock-comment-delimiter-face fontified t) 2499 2527 (face font-lock-comment-face fontified t) 2527 2569 (face font-lock-comment-face fontified t) 2569 2585 (fontified t) 2585 2588 (face font-lock-comment-delimiter-face fontified t) 2588 2628 (face font-lock-comment-face fontified t) 2628 2670 (fontified t) 2670 2676 (face font-lock-keyword-face fontified t) 2676 2716 (fontified t) 2716 2719 (face font-lock-comment-delimiter-face fontified t) 2719 2741 (face font-lock-comment-face fontified t) 2741 2889 (fontified t) 2889 2893 (face font-lock-keyword-face fontified t) 2893 2982 (fontified t) 2982 2985 (face font-lock-comment-delimiter-face fontified t) 2985 3014 (face font-lock-comment-face fontified t) 3014 3030 (fontified t) 3030 3033 (face font-lock-comment-delimiter-face fontified t) 3033 3072 (face font-lock-comment-face fontified t) 3072 3109 (fontified t) 3109 3115 (face font-lock-keyword-face fontified t) 3115 3130 (fontified t) 3130 3133 (face font-lock-comment-delimiter-face fontified t) 3133 3167 (face font-lock-comment-face fontified t) 3167 3168 (fontified t) 3168 3176 (face font-lock-keyword-face fontified t) 3176 3177 (fontified t) 3177 3184 (face font-lock-function-name-face fontified t) 3184 3187 (fontified t) 3187 3191 (face font-lock-type-face fontified t) 3191 3203 (fontified t) 3203 3218 (face font-lock-builtin-face fontified t) 3218 3309 (fontified t) 3309 3314 (face font-lock-type-face fontified t) 3314 3324 (fontified t) 3324 3331 (face font-lock-keyword-face fontified t) 3331 3364 (fontified t) 3364 3367 (face font-lock-comment-delimiter-face fontified t) 3367 3445 (face font-lock-comment-face fontified t) 3445 3447 (fontified t) 3447 3450 (face font-lock-comment-delimiter-face fontified t) 3450 3508 (face font-lock-comment-face fontified t) 3508 3512 (fontified t) 3512 3515 (face font-lock-keyword-face fontified t) 3515 3537 (fontified t) 3537 3540 (face font-lock-comment-delimiter-face fontified t) 3540 3596 (face font-lock-comment-face fontified t) 3596 3602 (fontified t) 3602 3605 (face font-lock-keyword-face fontified t) 3605 3633 (fontified t) 3633 3639 (face font-lock-keyword-face fontified t) 3639 3688 (fontified t) 3688 3691 (face font-lock-comment-delimiter-face fontified t) 3691 3726 (face font-lock-comment-face fontified t) 3726 3734 (fontified t) 3734 3736 (face font-lock-keyword-face fontified t) 3736 3802 (fontified t) 3802 3808 (face font-lock-builtin-face fontified t) 3808 3834 (fontified t) 3834 3837 (face font-lock-comment-delimiter-face fontified t) 3837 3885 (face font-lock-comment-face fontified t) 3885 3896 (fontified t) 3896 3899 (face font-lock-comment-delimiter-face fontified t) 3899 3967 (face font-lock-comment-face fontified t) 3967 3979 (fontified t) 3979 3982 (face font-lock-keyword-face fontified t) 3982 4024 (fontified t) 4024 4026 (face font-lock-keyword-face fontified t) 4026 4069 (fontified t) 4069 4075 (fontified t) 4075 4092 (fontified t) 4092 4095 (face font-lock-comment-delimiter-face fontified t) 4095 4142 (face font-lock-comment-face fontified t) 4142 4160 (fontified t) 4160 4165 (face font-lock-warning-face fontified t) 4165 4227 (fontified t) 4227 4235 (face font-lock-builtin-face fontified t) 4235 4248 (fontified t) 4248 4252 (face font-lock-string-face fontified t) 4252 4276 (fontified t) 4276 4279 (face font-lock-comment-delimiter-face fontified t) 4279 4296 (face font-lock-comment-face fontified t) 4296 4314 (fontified t) 4314 4319 (face font-lock-warning-face fontified t) 4319 4320 (fontified t) 4320 4340 (face font-lock-string-face fontified t) 4340 4371 (fontified t) 4371 4374 (face font-lock-comment-delimiter-face fontified t) 4374 4419 (face font-lock-comment-face fontified t) 4419 4437 (fontified t)) . 8125) (undo-tree-id0 . -4437) (undo-tree-id1 . -4437) (undo-tree-id2 . -4437) (undo-tree-id3 . -4437) (t 26976 62255 0 0)) nil (26976 62607 425035 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11562 . 11563) (nil fontified nil 8125 . 11563) (8125 . 11563)) nil (26976 62607 425016 0) 0 nil])
([nil nil ((#("(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only)) ;; On ignore l'isolation pour simplifier en mode brut
  
  ;; On génère des symboles uniques pour éviter les conflits de noms avec votre code
  (let ((attempt-sym (gensym \"ATTEMPT\"))
        (outcome-sym (gensym \"OUTCOME\"))
        (err-sym (gensym \"ERR\"))
        (res-sym (gensym \"RES\"))
        (msg-sym (gensym \"MSG\")))
    
    ;; Le code généré est injecté directement, sans (lambda)
    `(loop :for ,attempt-sym :from 0 :to ,retries :do
       (let ((,outcome-sym
              ;; 1. Connexion
              (ensure-connection
                ;; Bloc de protection pour attraper les retours
                (block tx-execution
                  (handler-case
                      (progn
                        ;; --- BEGIN ---
                        #+postmodern (cl-postgres:exec-query postmodern:*database* \"BEGIN\")
                        #-postmodern (lumen.data.db:exec \"BEGIN\")
                        
                        ;; INJECTION DU CORPS DU CODE ICI (Pas de Lambda !)
                        ;; call-next-method fonctionnera car on est dans le même scope lexical
                        (let ((,res-sym (progn ,@body)))
                          
                          ;; --- COMMIT ---
                          #+postmodern (cl-postgres:exec-query postmodern:*database* \"COMMIT\")
                          #-postmodern (lumen.data.db:exec \"COMMIT\")
                          
                          ;; Succès : (:success . valeur)
                          (cons :success ,res-sym)))
                    
                    ;; CATCH ERREUR
                    (error (,err-sym)
                      ;; --- ROLLBACK ---
                      (ignore-errors 
                        #+postmodern (cl-postgres:exec-query postmodern:*database* \"ROLLBACK\")
                        #-postmodern (lumen.data.db:exec \"ROLLBACK\"))
                      
                      ;; Erreur : (:error . condition)
                      (cons :error ,err-sym)))))))
         
         ;; 2. ANALYSE (Hors du bloc handler-case DB)
         (if (eq (car ,outcome-sym) :success)
             ;; SUCCÈS : On retourne la valeur et on sort de la boucle (et de la macro)
             (return (cdr ,outcome-sym))
             
             ;; ÉCHEC
             (let* ((,err-sym (cdr ,outcome-sym))
                    ;; Sanitisation du message
                    (,msg-sym (format nil \"~A\" ,err-sym))
                    (is-app (typep ,err-sym 'lumen.core.error:application-error))
                    (mapped (unless is-app (lumen.data.errors:map-db-error ,err-sym))))
               
               (cond
                 ;; A) Erreur Métier -> ON LANCE L'ERREUR PROPREMENT
                 (is-app
                  (error 'lumen.core.error:application-error :message ,msg-sym))
                 
                 ;; B) Retry -> Le loop continuera
                 ((and mapped (< ,attempt-sym ,retries) (lumen.data.errors:retryable-db-error-p mapped))
                  (when (plusp ,sleep-ms) (sleep (/ (max 0 ,sleep-ms) 1000.0)))
                  ;; Loop continue...
                  )
                 
                 ;; C) Fatal
                 (t
                  (error \"Database Error: ~A\" ,msg-sym)))))))))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn
           (ignore-errors
             (postmodern:query (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
           ,@body)
         (progn ,@body))))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 17 (face font-lock-function-name-face fontified t) 17 20 (fontified t) 20 24 (face font-lock-type-face fontified t) 24 36 (fontified t) 36 51 (face font-lock-builtin-face fontified t) 51 142 (fontified t) 142 147 (face font-lock-type-face fontified t) 147 157 (fontified t) 157 164 (face font-lock-keyword-face fontified t) 164 195 (fontified t) 195 198 (face font-lock-comment-delimiter-face fontified t) 198 249 (face font-lock-comment-face fontified t) 249 254 (fontified t) 254 257 (face font-lock-comment-delimiter-face fontified t) 257 337 (face font-lock-comment-face fontified t) 337 340 (fontified t) 340 343 (face font-lock-keyword-face fontified t) 343 366 (fontified t) 366 375 (face font-lock-string-face fontified t) 375 407 (fontified t) 407 416 (face font-lock-string-face fontified t) 416 444 (fontified t) 444 449 (face font-lock-string-face fontified t) 449 477 (fontified t) 477 482 (face font-lock-string-face fontified t) 482 510 (fontified t) 510 515 (face font-lock-string-face fontified t) 515 528 (fontified t) 528 531 (face font-lock-comment-delimiter-face fontified t) 531 585 (face font-lock-comment-face fontified t) 585 591 (fontified t) 591 595 (face font-lock-keyword-face fontified t) 595 596 (fontified t) 596 600 (face font-lock-builtin-face fontified t) 600 614 (fontified t) 614 619 (face font-lock-builtin-face fontified t) 619 622 (fontified t) 622 625 (face font-lock-builtin-face fontified t) 625 635 (fontified t) 635 638 (face font-lock-builtin-face fontified t) 638 647 (fontified t) 647 650 (face font-lock-keyword-face fontified t) 650 680 (fontified t) 680 683 (face font-lock-comment-delimiter-face fontified t) 683 696 (face font-lock-comment-face fontified t) 696 745 (fontified t) 745 748 (face font-lock-comment-delimiter-face fontified t) 748 793 (face font-lock-comment-face fontified t) 793 810 (fontified t) 810 815 (face font-lock-keyword-face fontified t) 815 848 (fontified t) 848 860 (face font-lock-keyword-face fontified t) 860 884 (fontified t) 884 889 (face font-lock-keyword-face fontified t) 889 914 (fontified t) 914 917 (face font-lock-comment-delimiter-face fontified t) 917 931 (face font-lock-comment-face fontified t) 931 1014 (fontified t) 1014 1021 (face font-lock-string-face fontified t) 1021 1047 (fontified t) 1047 1080 (face slime-reader-conditional-face fontified t) 1080 1087 (face slime-reader-conditional-face fontified t) 1087 1088 (face slime-reader-conditional-face fontified t) 1088 1138 (fontified t) 1138 1141 (face font-lock-comment-delimiter-face fontified t) 1141 1190 (face font-lock-comment-face fontified t) 1190 1214 (fontified t) 1214 1217 (face font-lock-comment-delimiter-face fontified t) 1217 1285 (face font-lock-comment-face fontified t) 1285 1310 (fontified t) 1310 1313 (face font-lock-keyword-face fontified t) 1313 1326 (fontified t) 1326 1331 (face font-lock-keyword-face fontified t) 1331 1395 (fontified t) 1395 1398 (face font-lock-comment-delimiter-face fontified t) 1398 1413 (face font-lock-comment-face fontified t) 1413 1498 (fontified t) 1498 1500 (face font-lock-string-face fontified t) 1500 1506 (face font-lock-string-face fontified t) 1506 1508 (fontified t) 1508 1534 (fontified t) 1534 1567 (face slime-reader-conditional-face fontified t) 1567 1575 (face slime-reader-conditional-face fontified t) 1575 1576 (face slime-reader-conditional-face fontified t) 1576 1630 (fontified t) 1630 1633 (face font-lock-comment-delimiter-face fontified t) 1633 1662 (face font-lock-comment-face fontified t) 1662 1694 (fontified t) 1694 1702 (face font-lock-builtin-face fontified t) 1702 1756 (fontified t) 1756 1759 (face font-lock-comment-delimiter-face fontified t) 1759 1772 (face font-lock-comment-face fontified t) 1772 1793 (fontified t) 1793 1798 (face font-lock-warning-face fontified t) 1798 1832 (fontified t) 1832 1835 (face font-lock-comment-delimiter-face fontified t) 1835 1852 (face font-lock-comment-face fontified t) 1852 1875 (fontified t) 1875 1888 (face font-lock-keyword-face fontified t) 1888 1973 (fontified t) 1973 1983 (face font-lock-string-face fontified t) 1983 2009 (fontified t) 2009 2042 (face slime-reader-conditional-face fontified t) 2042 2052 (face slime-reader-conditional-face fontified t) 2052 2053 (face slime-reader-conditional-face fontified t) 2053 2100 (fontified t) 2100 2103 (face font-lock-comment-delimiter-face fontified t) 2103 2133 (face font-lock-comment-face fontified t) 2133 2161 (fontified t) 2161 2167 (face font-lock-builtin-face fontified t) 2167 2203 (fontified t) 2203 2206 (face font-lock-comment-delimiter-face fontified t) 2206 2248 (face font-lock-comment-face fontified t) 2248 2258 (fontified t) 2258 2260 (face font-lock-keyword-face fontified t) 2260 2284 (fontified t) 2284 2292 (face font-lock-builtin-face fontified t) 2292 2307 (fontified t) 2307 2310 (face font-lock-comment-delimiter-face fontified t) 2310 2382 (face font-lock-comment-face fontified t) 2382 2396 (fontified t) 2396 2402 (face font-lock-keyword-face fontified t) 2402 2450 (fontified t) 2450 2453 (face font-lock-comment-delimiter-face fontified t) 2453 2459 (face font-lock-comment-face fontified t) 2459 2473 (fontified t) 2473 2477 (face font-lock-keyword-face fontified t) 2477 2529 (fontified t) 2529 2532 (face font-lock-comment-delimiter-face fontified t) 2532 2556 (face font-lock-comment-face fontified t) 2556 2598 (fontified t) 2598 2602 (face font-lock-string-face fontified t) 2602 2725 (fontified t) 2725 2731 (face font-lock-keyword-face fontified t) 2731 2816 (fontified t) 2816 2820 (face font-lock-keyword-face fontified t) 2820 2838 (fontified t) 2838 2841 (face font-lock-comment-delimiter-face fontified t) 2841 2890 (face font-lock-comment-face fontified t) 2890 2934 (fontified t) 2934 2939 (face font-lock-warning-face fontified t) 2939 2976 (fontified t) 2976 2984 (face font-lock-builtin-face fontified t) 2984 3031 (fontified t) 3031 3034 (face font-lock-comment-delimiter-face fontified t) 3034 3065 (face font-lock-comment-face fontified t) 3065 3189 (fontified t) 3189 3193 (face font-lock-keyword-face fontified t) 3193 3268 (fontified t) 3268 3271 (face font-lock-comment-delimiter-face fontified t) 3271 3288 (face font-lock-comment-face fontified t) 3288 3343 (fontified t) 3343 3346 (face font-lock-comment-delimiter-face fontified t) 3346 3355 (face font-lock-comment-face fontified t) 3355 3394 (fontified t) 3394 3399 (face font-lock-warning-face fontified t) 3399 3400 (fontified t) 3400 3420 (face font-lock-string-face fontified t) 3420 3437 (fontified t) 3437 3438 (rear-nonsticky t fontified t) 3438 3439 (fontified t) 3439 3441 (fontified t) 3441 3449 (face font-lock-keyword-face fontified t) 3449 3450 (fontified t) 3450 3472 (face font-lock-function-name-face fontified t) 3472 3479 (fontified t) 3479 3484 (face font-lock-type-face fontified t) 3484 3495 (fontified t) 3495 3498 (face font-lock-keyword-face fontified t) 3498 3517 (fontified t) 3517 3519 (face font-lock-keyword-face fontified t) 3519 3550 (fontified t) 3550 3555 (face font-lock-keyword-face fontified t) 3555 3568 (fontified t) 3568 3581 (face font-lock-keyword-face fontified t) 3581 3625 (fontified t) 3625 3659 (face font-lock-string-face fontified t) 3659 3707 (fontified t) 3707 3712 (face font-lock-keyword-face fontified t) 3712 3723 (fontified t)) . 8125) (undo-tree-id33 . -3723) (undo-tree-id34 . -2556) (undo-tree-id35 . -3438) (undo-tree-id36 . -3438) (t 26976 62607 0 0)) nil (26976 63272 909504 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 8125)) nil (26976 63272 909502 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -8124) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) 8125) nil (26976 63272 909501 0) 0 nil])
([nil nil ((#("
;; Condition spéciale pour \"transporter\" l'erreur à travers la couche Transaction
(define-condition tx-tunnel-error (error)
  ((payload :initarg :payload :reader tx-tunnel-payload))
  (:documentation \"Erreur technique utilisée pour forcer le ROLLBACK de Postmodern tout en transportant l'erreur métier.\"))
" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 83 (face font-lock-comment-face fontified t) 83 84 (fontified t) 84 100 (face font-lock-keyword-face fontified t) 100 101 (fontified t) 101 116 (face font-lock-function-name-face fontified t) 116 118 (fontified t) 118 123 (face font-lock-warning-face fontified t) 123 137 (fontified t) 137 145 (face font-lock-builtin-face fontified t) 145 146 (fontified t) 146 154 (face font-lock-builtin-face fontified t) 154 155 (fontified t) 155 162 (face font-lock-builtin-face fontified t) 162 186 (fontified t) 186 200 (face font-lock-builtin-face fontified t) 200 201 (fontified t) 201 304 (face font-lock-doc-face fontified t) 304 307 (fontified t)) . 7817) (undo-tree-id24 . -307) (undo-tree-id25 . -307) (undo-tree-id26 . -307) (undo-tree-id27 . -307)) nil (26976 63272 909498 0) 0 nil])
([nil nil ((7618 . 7620)) nil (26976 63272 909492 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9486 . 9487) (nil fontified nil 7620 . 9487) (7620 . 9487)) nil (26976 63272 909492 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11093 . 11094) (nil fontified nil 9686 . 11094) (9686 . 11094)) nil (26976 63272 909491 0) 0 nil])
([nil nil ((11094 . 11095)) nil (26976 63272 909490 0) 0 nil])
([nil nil ((#("
;; Les macros/fonctions with-conn et ensure-connection doivent être présentes ici.
;; Assurez-vous qu'elles n'utilisent PAS de 'return-from' internes bizarres.
;; Une implémentation simple :
(defmacro ensure-connection (&body body)
  `(call-with-conn (lambda () ,@body)))" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 84 (face font-lock-comment-face fontified t) 84 87 (face font-lock-comment-delimiter-face fontified t) 87 161 (face font-lock-comment-face fontified t) 161 164 (face font-lock-comment-delimiter-face fontified t) 164 192 (face font-lock-comment-face fontified t) 192 193 (fontified t) 193 201 (face font-lock-keyword-face fontified t) 201 202 (fontified t) 202 219 (face font-lock-function-name-face fontified t) 219 221 (fontified t) 221 226 (face font-lock-type-face fontified t) 226 233 (fontified t) 233 253 (fontified t) 253 259 (face font-lock-keyword-face fontified t) 259 271 (fontified t) 271 272 (rear-nonsticky t fontified t)) . 10822) (undo-tree-id17 . -272) (undo-tree-id18 . -208) (undo-tree-id19 . -202) (undo-tree-id20 . -272) (undo-tree-id21 . -272) (undo-tree-id22 . -219) (undo-tree-id23 . -272)) nil (26976 63272 909489 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -10821) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 10822) nil (26976 63272 909482 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6900 . 6901) (nil fontified nil 4160 . 6901) (4160 . 6901) (t 26976 63272 0 0)) nil (26976 64539 490111 0) 0 nil])
([nil nil ((6901 . 6903)) nil (26976 64539 490110 0) 0 nil])
([nil nil ((#("(defun call-with-conn (thunk
                       &key (cfg (or *current-config* (lumen.data.config:db-config))))
  (let* ((mode (intern
                (string-upcase
                 (or (getf cfg :db-connection-mode)
                     (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                :keyword)))
    (ecase mode
      (:toplevel (funcall thunk))
      (:scoped
       #+postmodern
       (let* ((db   (getf cfg :database))
              (user (getf cfg :user))
              (pass (getf cfg :password))
              (host (or (getf cfg :host) \"localhost\"))
              (port (or (getf cfg :port) 5432))
              (app  (or (getf cfg :application-name) \"\"))
              (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
         (postmodern:with-connection (list db user pass host
                                           :port port :use-ssl use-ssl
                                           :application-name app)
           (funcall thunk)))
       #-postmodern (funcall thunk))
      (:pooled-native
       (%ensure-pool-sema! cfg)
       (let* ((deadline (+ (get-internal-real-time)
                           (* internal-time-units-per-second
                              (/ (max 1 *pool-wait-ms*) 1000.0))))
              (t0 (get-internal-real-time)))
         (%pool-incf! '*pool-waiters* 1)
         (unwind-protect
              (progn
                (labels ((acquire-slot ()
                           (or (bt:wait-on-semaphore *pool-sema*
                                                     :timeout (/ *pool-wait-ms* 1000.0))
                               (if (< (get-internal-real-time) deadline)
                                   (acquire-slot)
                                   (error \"DB pool: timeout after ~A ms\" *pool-wait-ms*)))))
                  (acquire-slot))
                (%pool-incf! '*pool-waiters* -1)
                (%pool-incf! '*pool-inflight* 1)
                #+postmodern        
                (let* ((db   (getf cfg :database))
                       (user (getf cfg :user))
                       (pass (getf cfg :password))
                       (host (or (getf cfg :host) \"localhost\"))
                       (port (or (getf cfg :port) 5432))
                       (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
                  (unwind-protect                
                       (postmodern:with-connection (list db user pass host
                                                         :port port :use-ssl use-ssl
                                                         :pooled-p t)
                         (ignore-errors (postmodern:query \"set client_encoding = 'UTF8'\"))
                         (funcall thunk))
                    (%pool-incf! '*pool-inflight* -1)
                    (bt:signal-semaphore *pool-sema*)))
                #-postmodern
                (unwind-protect
                     (funcall thunk)
                  (%pool-incf! '*pool-inflight* -1)
                  (bt:signal-semaphore *pool-sema*)))
           (when (> *pool-waiters* 0)
             (%pool-incf! '*pool-waiters* -1))))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 21 (face font-lock-function-name-face fontified t) 21 28 (fontified t) 28 29 (fontified t) 29 52 (fontified t) 52 56 (face font-lock-type-face fontified t) 56 119 (fontified t) 119 123 (face font-lock-keyword-face fontified t) 123 201 (fontified t) 201 220 (face font-lock-builtin-face fontified t) 220 270 (fontified t) 270 290 (face font-lock-string-face fontified t) 290 291 (fontified t) 291 299 (face font-lock-builtin-face fontified t) 299 300 (fontified t) 300 314 (face font-lock-builtin-face fontified t) 314 334 (fontified t) 334 342 (face font-lock-builtin-face fontified t) 342 351 (fontified t) 351 356 (face font-lock-keyword-face fontified t) 356 369 (fontified t) 369 378 (face font-lock-builtin-face fontified t) 378 403 (fontified t) 403 410 (face font-lock-builtin-face fontified t) 410 411 (fontified t) 411 439 (fontified t) 439 443 (face font-lock-keyword-face fontified t) 443 461 (fontified t) 461 470 (face font-lock-builtin-face fontified t) 470 503 (fontified t) 503 508 (face font-lock-builtin-face fontified t) 508 541 (fontified t) 541 550 (face font-lock-builtin-face fontified t) 550 587 (fontified t) 587 592 (face font-lock-builtin-face fontified t) 592 594 (fontified t) 594 605 (face font-lock-string-face fontified t) 605 642 (fontified t) 642 647 (face font-lock-builtin-face fontified t) 647 690 (fontified t) 690 707 (face font-lock-builtin-face fontified t) 707 709 (fontified t) 709 711 (face font-lock-string-face fontified t) 711 766 (fontified t) 766 774 (face font-lock-builtin-face fontified t) 774 789 (fontified t) 789 815 (face font-lock-keyword-face fontified t) 815 883 (fontified t) 883 888 (face font-lock-builtin-face fontified t) 888 894 (fontified t) 894 902 (face font-lock-builtin-face fontified t) 902 954 (fontified t) 954 971 (face font-lock-builtin-face fontified t) 971 1013 (fontified t) 1013 1041 (face slime-reader-conditional-face fontified t) 1041 1050 (fontified t) 1050 1064 (face font-lock-builtin-face fontified t) 1064 1105 (fontified t) 1105 1109 (face font-lock-keyword-face fontified t) 1109 1281 (fontified t) 1281 1322 (fontified t) 1322 1373 (fontified t) 1373 1387 (face font-lock-keyword-face fontified t) 1387 1403 (fontified t) 1403 1408 (face font-lock-keyword-face fontified t) 1408 1426 (fontified t) 1426 1432 (face font-lock-keyword-face fontified t) 1432 1449 (fontified t) 1449 1451 (fontified t) 1451 1499 (fontified t) 1499 1516 (fontified t) 1516 1569 (fontified t) 1569 1577 (face font-lock-builtin-face fontified t) 1577 1637 (fontified t) 1637 1639 (face font-lock-keyword-face fontified t) 1639 1764 (fontified t) 1764 1769 (face font-lock-warning-face fontified t) 1769 1770 (fontified t) 1770 1800 (face font-lock-string-face fontified t) 1800 1911 (fontified t) 1911 1953 (fontified t) 1953 2007 (fontified t) 2007 2011 (face font-lock-keyword-face fontified t) 2011 2029 (fontified t) 2029 2038 (face font-lock-builtin-face fontified t) 2038 2080 (fontified t) 2080 2085 (face font-lock-builtin-face fontified t) 2085 2127 (fontified t) 2127 2136 (face font-lock-builtin-face fontified t) 2136 2182 (fontified t) 2182 2187 (face font-lock-builtin-face fontified t) 2187 2189 (fontified t) 2189 2200 (face font-lock-string-face fontified t) 2200 2246 (fontified t) 2246 2251 (face font-lock-builtin-face fontified t) 2251 2321 (fontified t) 2321 2329 (face font-lock-builtin-face fontified t) 2329 2353 (fontified t) 2353 2367 (face font-lock-keyword-face fontified t) 2367 2408 (fontified t) 2408 2434 (face font-lock-keyword-face fontified t) 2434 2516 (fontified t) 2516 2521 (face font-lock-builtin-face fontified t) 2521 2527 (fontified t) 2527 2535 (face font-lock-builtin-face fontified t) 2535 2601 (fontified t) 2601 2610 (face font-lock-builtin-face fontified t) 2610 2640 (fontified t) 2640 2653 (face font-lock-keyword-face fontified t) 2653 2672 (fontified t) 2672 2702 (face font-lock-string-face fontified t) 2702 2873 (fontified t) 2873 3016 (face slime-reader-conditional-face fontified t) 3016 3059 (face slime-reader-conditional-face fontified t) 3059 3061 (fontified t) 3061 3073 (fontified t) 3073 3077 (face font-lock-keyword-face fontified t) 3077 3154 (fontified t) 3154 3162 (face font-lock-keyword-face fontified t) 3162 3163 (fontified t) 3163 3172 (face font-lock-function-name-face fontified t) 3172 3174 (fontified t) 3174 3183 (face font-lock-type-face fontified t) 3183 3189 (fontified t) 3189 3194 (face font-lock-type-face fontified t) 3194 3204 (fontified t) 3204 3206 (face font-lock-keyword-face fontified t) 3206 3296 (fontified t) 3296 3302 (face font-lock-keyword-face fontified t) 3302 3346 (fontified t) 3346 3352 (face font-lock-keyword-face fontified t) 3352 3373 (fontified t)) . -6903) (undo-tree-id43 . -3373) (undo-tree-id44 . -2203) 10276) nil (26976 64539 490109 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -6902) (undo-tree-id41 . -1) (undo-tree-id42 . -1) 6903) nil (26976 64539 490107 0) 0 nil])
([nil nil ((#("(in-package :cl)

(defpackage :lumen.data.db
  (:use :cl)
  
  (:import-from :postmodern
   :connect-toplevel :disconnect-toplevel :with-transaction)
  (:import-from :lumen.data.config
   :db-config)
  (:import-from :lumen.data.prepare
   :get-prepared-plan :reset-prepare-cache :*prepare-cache-ttl-ms*)
  (:import-from :lumen.data.errors :translate-db-error :map-db-error :retryable-db-error-p)
  (:import-from :lumen.data.metrics :record-query-latency :record-slow-query)
  
  (:export :start! :stop! :with-tx
           :query-a :query-1a :exec
           :with-conn :ensure-connection :with-rollback
           :*connection-mode* :with-statement-timeout
           :*default-statement-timeout-ms* :*slow-query-ms*))

(in-package :lumen.data.db)

;;;; --------------------------------------------------------------------------
;;;; Pool counters & lock
;;;; --------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)

(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*)
    (incf (symbol-value var) delta)))

(defun %pool-snapshot ()
  (bt:with-lock-held (*pool-lock*)
    (values *pool-inflight* *pool-waiters*)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size)
                   (lumen.core.config:cfg-get-int :db/pool-size :default 10)))
         (wait (or (getf cfg :pool-wait-ms)
                   (lumen.core.config:cfg-get-int :db/pool-wait-ms :default 2000))))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))

;; ----------------------------------------------------------------------------
;; State
;; ----------------------------------------------------------------------------
(defvar *started* nil)
(defvar *current-config* nil)
(defvar *connection-mode* :toplevel)

(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; ----------------------------------------------------------------------------
;; Start / Stop
;; ----------------------------------------------------------------------------
(defun start! (&key (config (lumen.data.config:db-config)))
  (print \"IN START!\")
  (print config)
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode)
                              (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\"
                                                         :default :toplevel)))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  (print *connection-mode*)

  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let* ((db   (getf config :database))
            (user (getf config :user))
            (pass (getf config :password))
            (host (or (getf config :host) \"localhost\"))
            (port (or (getf config :port) 5432))
            (app  (or (getf config :application-name) \"\"))
            (use-ssl (%sslmode->use-ssl (getf config :sslmode))))
       (handler-case
           (progn
             (postmodern:disconnect-toplevel)
             (postmodern:connect-toplevel db user pass host
                                          :port port :use-ssl use-ssl
                                          :application-name app)
             (setf *started* t))
         (condition (c)
           (setf *started* nil)
           (error \"DB start! failed: ~a\" c))))
     #-postmodern
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)

;; ----------------------------------------------------------------------------
;; Connections
;; ----------------------------------------------------------------------------
(defvar *in-connection* nil
  \"Indique si nous sommes déjà à l'intérieur d'un bloc ensure-connection/with-tx.\")

;; On modifie call-with-conn pour gérer le flag *in-connection*
(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  ;; Si on est déjà connecté, on exécute juste le code (NO-OP).
  ;; Cela évite de recréer des handler-bind/unwind-protect imbriqués qui cassent la pile.
  (if *in-connection*
      (funcall thunk)
      
      ;; Sinon, on établit la connexion (votre logique existante)
      (let ((*in-connection* t)) ;; On marque qu'on est connecté
        (let* ((mode (intern
                      (string-upcase
                       (or (getf cfg :db-connection-mode)
                           (lumen.core.config:cfg-get \"DB_CONNECTION_MODE\" :default :pooled-native)))
                      :keyword)))
          (ecase mode
            (:toplevel (funcall thunk))
            (:scoped
             #+postmodern
             (let* ((db   (getf cfg :database))
                    (user (getf cfg :user))
                    (pass (getf cfg :password))
                    (host (or (getf cfg :host) \"localhost\"))
                    (port (or (getf cfg :port) 5432))
                    (app  (or (getf cfg :application-name) \"\"))
                    (use-ssl (%sslmode->use-ssl (getf cfg :sslmode))))
               (postmodern:with-connection (list db user pass host
                                                 :port port :use-ssl use-ssl
                                                 :application-name app)
                 (funcall thunk)))
             #-postmodern (funcall thunk))
            (:pooled-native
             ;; ... (Votre logique de pool existante ici) ...
             ;; Pour simplifier l'exemple je mets un funcall, 
             ;; mais gardez votre logique de semaphore ici.
             (%ensure-pool-sema! cfg)
             (let ((deadline (+ (get-internal-real-time) (* internal-time-units-per-second 2))))
               ;; ... (votre acquisition de sémaphore) ...
               (bt:wait-on-semaphore *pool-sema*)
               (unwind-protect
                    #+postmodern
                    (postmodern:with-connection (list (getf cfg :database) (getf cfg :user) (getf cfg :password) (or (getf cfg :host) \"localhost\") :pooled-p t)
                      (funcall thunk))
                    #-postmodern
                    (funcall thunk)
                 (bt:signal-semaphore *pool-sema*)))
             ))))))

(defmacro with-conn (&optional opts &body body)
  (if (and opts (listp opts) (or (null opts) (keywordp (first opts))))
      `(call-with-conn (lambda () ,@body) ,@opts)
      `(call-with-conn (lambda () ,opts ,@body))))

(defmacro ensure-connection (&optional opts &body body)
  `(with-conn ,opts ,@body))

;; ============================================================================
;; EXECUTION & HELPERS
;; ============================================================================
(defvar *default-statement-timeout-ms* nil)
(defvar *slow-query-ms* 500.0)

;; Helper pour exécuter du SQL brut sans interférence (utilisé par with-tx)
(defun %raw-exec (sql)
  #+postmodern (cl-postgres:exec-query postmodern:*database* sql)
  #-postmodern (error \"Not implemented for non-postmodern\"))

(defmacro with-statement-timeout ((ms) &body body)
  `(let ((%ms ,ms))
     (if (and %ms (> %ms 0))
         (progn
           (ignore-errors (%raw-exec (format nil \"set local statement_timeout = ~d\" (truncate %ms))))
           ,@body)
         (progn ,@body))))

;; Votre fonction exec existante (simplifiée pour correspondre au style)
(defun exec (sql &rest params)
  ;; (format t \"~&[DB-EXEC] ~S~%\" sql)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            
            ;; Metrics...
            (values affected ret)))
      (condition (c) (translate-db-error c)))))

;;; ---------------------------------------------------------------------------
;;; TRANSACTIONS SECURISÉES (LE FIX)
;;; ---------------------------------------------------------------------------
(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only retries sleep-ms)) ;; Simplification pour debug
  
  `(ensure-connection
     (let ((%tx-success nil))
       (unwind-protect
            (progn
              ;; 1. START TRANSACTION (Raw SQL)
              (%raw-exec \"BEGIN\")
              
              ;; 2. INLINE BODY EXECUTION
              ;; C'est ici que call-next-method s'exécute.
              ;; Si une erreur survient, la pile remonte jusqu'à unwind-protect.
              (let ((res (progn ,@body)))
                
                ;; 3. COMMIT (Seulement si aucune erreur n'a sauté le code)
                (%raw-exec \"COMMIT\")
                (setf %tx-success t)
                res))
         
         ;; 4. CLEANUP (Toujours exécuté)
         (unless %tx-success
           ;; Si on n'a pas marqué le succès (donc erreur ou saut), on ROLLBACK.
           ;; L'erreur originale continue sa route vers le Middleware.
           (ignore-errors (%raw-exec \"ROLLBACK\")))))))

;;; ---------------------------------------------------------------------------
;;; Helpers (Inchangés)
;;; ---------------------------------------------------------------------------
(defun %sslmode->use-ssl (sslmode)
  (case sslmode ((:disable nil) :no) ((:allow :prefer) :try) (:require :require) (:verify-ca :yes) (:verify-full :full) (t :no)))

(defun %rows->alists (rows)
  (if (and rows (consp (first rows)) (keywordp (caar rows))) rows rows))

(defun %now-ms () (round (* 1000.0 (/ (get-internal-real-time) internal-time-units-per-second))))
(defun %elapsed-ms (t0) (* 1000.0 (/ (- (get-internal-real-time) t0) internal-time-units-per-second)))

;;; ---------------------------------------------------------------------------
;;; Query Wrappers
;;; ---------------------------------------------------------------------------
(defun query-a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn   (lumen.data.prepare:get-prepared-plan sql :format :alists))
                 (rows (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
            (lumen.data.metrics:record-query-latency sql elapsed-ms (length rows))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :rows (length rows)))
            (values rows (length rows))))
      (condition (c) (translate-db-error c)))))

(defun query-1a (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn  (get-prepared-plan sql :format :alist))
                 (row (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (if row 1 0))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :rows (if row 1 0)))
            row))
      (condition (c) (translate-db-error c)))))

#|
(defun exec (sql &rest params)
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  (let* ((kpos (position-if (lambda (x) (and (keywordp x) (not (member x '(:null :default) :test #'eq)))) params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0) cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query sql elapsed-ms :params args :affected affected)))
            (values affected ret)))
      ;; BYPASS CRITIQUE : On laisse passer l'erreur applicative pour qu'elle soit attrapée par call-with-tx-logic
      (lumen.core.error:application-error (c) (error c))
      (condition (c) (translate-db-error c)))))
|#

(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
   Gère correctement les arguments :NULL dans les paramètres SQL.\"
  
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  
  (let* (;; On cherche le début des options (:timeout-ms, etc.)
         ;; CORRECTION : On ignore :NULL et :DEFAULT qui sont des valeurs SQL, pas des options.
         (kpos (position-if (lambda (x)
                              (and (keywordp x)
                                   (not (member x '(:null :default) :test #'eq))))
                            params))
         
         ;; Séparation propre Arguments SQL / Options Lumen
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         
         ;; Extraction des options
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (format t \"~&EXEC:OPTS: ~A~%\" opts)
    
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            
            (if has-returning
                ;; RETURNING -> On veut le résultat (alist)
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0)
                        ret row))
                
                ;; Pas de RETURNING -> On veut juste le nombre de lignes affectées
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            
            ;; Métriques (Optionnel)
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            
            (values affected ret)))

      ;; Si c'est une erreur applicative, on la re-signale telle quelle
      ;; sans l'emballer dans une db-error.
      (lumen.core.error:application-error (c)
        (error c))
      
      (condition (c)
        (translate-db-error c)))))

(defmacro with-rollback ((&optional opts) &body body)
  `(lumen.data.db:with-conn ,opts
     (lumen.data.db:exec \"BEGIN\")
     (unwind-protect (progn ,@body) (ignore-errors (lumen.data.db:exec \"ROLLBACK\")))))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 15 (face font-lock-builtin-face fontified t) 15 19 (fontified t) 19 29 (face font-lock-keyword-face fontified t) 29 30 (fontified t) 30 44 (face font-lock-type-face fontified t) 44 48 (fontified t) 48 52 (face font-lock-builtin-face fontified t) 52 53 (fontified t) 53 56 (face font-lock-builtin-face fontified t) 56 64 (fontified t) 64 76 (face font-lock-builtin-face fontified t) 76 77 (fontified t) 77 88 (face font-lock-builtin-face fontified t) 88 92 (fontified t) 92 109 (face font-lock-builtin-face fontified t) 109 110 (fontified t) 110 130 (face font-lock-builtin-face fontified t) 130 131 (fontified t) 131 148 (face font-lock-builtin-face fontified t) 148 153 (fontified t) 153 165 (face font-lock-builtin-face fontified t) 165 166 (fontified t) 166 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 198 (face font-lock-builtin-face fontified t) 198 203 (fontified t) 203 215 (face font-lock-builtin-face fontified t) 215 216 (fontified t) 216 235 (face font-lock-builtin-face fontified t) 235 239 (fontified t) 239 257 (face font-lock-builtin-face fontified t) 257 258 (fontified t) 258 278 (face font-lock-builtin-face fontified t) 278 279 (fontified t) 279 302 (face font-lock-builtin-face fontified t) 302 307 (fontified t) 307 319 (face font-lock-builtin-face fontified t) 319 320 (fontified t) 320 338 (face font-lock-builtin-face fontified t) 338 339 (fontified t) 339 358 (face font-lock-builtin-face fontified t) 358 359 (fontified t) 359 372 (face font-lock-builtin-face fontified t) 372 373 (fontified t) 373 394 (face font-lock-builtin-face fontified t) 394 399 (fontified t) 399 411 (face font-lock-builtin-face fontified t) 411 412 (fontified t) 412 431 (face font-lock-builtin-face fontified t) 431 432 (fontified t) 432 453 (face font-lock-builtin-face fontified t) 453 454 (fontified t) 454 472 (face font-lock-builtin-face fontified t) 472 480 (fontified t) 480 487 (face font-lock-builtin-face fontified t) 487 488 (fontified t) 488 495 (face font-lock-builtin-face fontified t) 495 496 (fontified t) 496 502 (face font-lock-builtin-face fontified t) 502 503 (fontified t) 503 511 (face font-lock-builtin-face fontified t) 511 523 (fontified t) 523 531 (face font-lock-builtin-face fontified t) 531 532 (fontified t) 532 541 (face font-lock-builtin-face fontified t) 541 542 (fontified t) 542 547 (face font-lock-builtin-face fontified t) 547 559 (fontified t) 559 569 (face font-lock-builtin-face fontified t) 569 570 (fontified t) 570 588 (face font-lock-builtin-face fontified t) 588 589 (fontified t) 589 603 (face font-lock-builtin-face fontified t) 603 615 (fontified t) 615 633 (face font-lock-builtin-face fontified t) 633 634 (fontified t) 634 657 (face font-lock-builtin-face fontified t) 657 669 (fontified t) 669 700 (face font-lock-builtin-face fontified t) 700 701 (fontified t) 701 717 (face font-lock-builtin-face fontified t) 717 722 (fontified t) 722 732 (face font-lock-keyword-face fontified t) 732 733 (fontified t) 733 747 (face font-lock-builtin-face fontified t) 747 750 (fontified t) 750 755 (face font-lock-comment-delimiter-face fontified t) 755 830 (face font-lock-comment-face fontified t) 830 835 (face font-lock-comment-delimiter-face fontified t) 835 856 (face font-lock-comment-face fontified t) 856 861 (face font-lock-comment-delimiter-face fontified t) 861 936 (face font-lock-comment-face fontified t) 936 937 (fontified t) 937 943 (face font-lock-keyword-face fontified t) 943 944 (fontified t) 944 955 (face font-lock-variable-name-face fontified t) 955 970 (fontified t) 970 985 (face font-lock-string-face fontified t) 985 989 (fontified t) 989 995 (face font-lock-keyword-face fontified t) 995 996 (fontified t) 996 1011 (face font-lock-variable-name-face fontified t) 1011 1016 (fontified t) 1016 1022 (face font-lock-keyword-face fontified t) 1022 1023 (fontified t) 1023 1037 (face font-lock-variable-name-face fontified t) 1037 1043 (fontified t) 1043 1049 (face font-lock-keyword-face fontified t) 1049 1050 (fontified t) 1050 1061 (face font-lock-variable-name-face fontified t) 1061 1068 (fontified t) 1068 1074 (face font-lock-keyword-face fontified t) 1074 1075 (fontified t) 1075 1086 (face font-lock-variable-name-face fontified t) 1086 1091 (fontified t) 1091 1097 (face font-lock-keyword-face fontified t) 1097 1098 (fontified t) 1098 1112 (face font-lock-variable-name-face fontified t) 1112 1121 (fontified t) 1121 1126 (face font-lock-keyword-face fontified t) 1126 1127 (fontified t) 1127 1138 (face font-lock-function-name-face fontified t) 1138 1154 (fontified t) 1154 1171 (face font-lock-keyword-face fontified t) 1171 1226 (fontified t) 1226 1231 (face font-lock-keyword-face fontified t) 1231 1232 (fontified t) 1232 1246 (face font-lock-function-name-face fontified t) 1246 1253 (fontified t) 1253 1270 (face font-lock-keyword-face fontified t) 1270 1332 (fontified t) 1332 1333 (fontified t) 1333 1338 (face font-lock-keyword-face fontified t) 1338 1339 (fontified t) 1339 1357 (face font-lock-function-name-face fontified t) 1357 1367 (fontified t) 1367 1371 (face font-lock-keyword-face fontified t) 1371 1393 (fontified t) 1393 1403 (face font-lock-builtin-face fontified t) 1403 1455 (fontified t) 1455 1468 (face font-lock-builtin-face fontified t) 1468 1469 (fontified t) 1469 1477 (face font-lock-builtin-face fontified t) 1477 1500 (fontified t) 1500 1513 (fontified t) 1513 1526 (face font-lock-builtin-face fontified t) 1526 1528 (fontified t) 1528 1578 (fontified t) 1578 1594 (face font-lock-builtin-face fontified t) 1594 1595 (fontified t) 1595 1603 (face font-lock-builtin-face fontified t) 1603 1657 (fontified t) 1657 1661 (face font-lock-keyword-face fontified t) 1661 1759 (fontified t) 1759 1765 (face font-lock-builtin-face fontified t) 1765 1818 (fontified t) 1818 1821 (face font-lock-comment-delimiter-face fontified t) 1821 1898 (face font-lock-comment-face fontified t) 1898 1901 (face font-lock-comment-delimiter-face fontified t) 1901 1907 (face font-lock-comment-face fontified t) 1907 1910 (face font-lock-comment-delimiter-face fontified t) 1910 1987 (face font-lock-comment-face fontified t) 1987 1988 (fontified t) 1988 1994 (face font-lock-keyword-face fontified t) 1994 1995 (fontified t) 1995 2004 (face font-lock-variable-name-face fontified t) 2004 2011 (fontified t) 2011 2017 (face font-lock-keyword-face fontified t) 2017 2018 (fontified t) 2018 2034 (face font-lock-variable-name-face fontified t) 2034 2041 (fontified t) 2041 2047 (face font-lock-keyword-face fontified t) 2047 2048 (fontified t) 2048 2065 (face font-lock-variable-name-face fontified t) 2065 2066 (fontified t) 2066 2075 (face font-lock-builtin-face fontified t) 2075 2079 (fontified t) 2079 2085 (face font-lock-keyword-face fontified t) 2085 2086 (fontified t) 2086 2116 (face font-lock-variable-name-face fontified t) 2116 2123 (fontified t) 2123 2129 (face font-lock-keyword-face fontified t) 2129 2130 (fontified t) 2130 2145 (face font-lock-variable-name-face fontified t) 2145 2154 (fontified t) 2154 2157 (face font-lock-comment-delimiter-face fontified t) 2157 2234 (face font-lock-comment-face fontified t) 2234 2237 (face font-lock-comment-delimiter-face fontified t) 2237 2250 (face font-lock-comment-face fontified t) 2250 2253 (face font-lock-comment-delimiter-face fontified t) 2253 2330 (face font-lock-comment-face fontified t) 2330 2331 (fontified t) 2331 2336 (face font-lock-keyword-face fontified t) 2336 2337 (fontified t) 2337 2343 (face font-lock-function-name-face fontified t) 2343 2345 (fontified t) 2345 2349 (face font-lock-type-face fontified t) 2349 2399 (fontified t) 2399 2410 (face font-lock-string-face fontified t) 2410 2504 (fontified t) 2504 2523 (face font-lock-builtin-face fontified t) 2523 2582 (fontified t) 2582 2602 (face font-lock-string-face fontified t) 2602 2660 (fontified t) 2660 2668 (face font-lock-builtin-face fontified t) 2668 2669 (fontified t) 2669 2678 (face font-lock-builtin-face fontified t) 2678 2685 (fontified t) 2685 2689 (face font-lock-keyword-face fontified t) 2689 2788 (fontified t) 2788 2796 (face font-lock-builtin-face fontified t) 2796 2832 (fontified t) 2832 2837 (face font-lock-keyword-face fontified t) 2837 2861 (fontified t) 2861 2870 (face font-lock-builtin-face fontified t) 2870 2895 (fontified t) 2895 2899 (face font-lock-keyword-face fontified t) 2899 2920 (fontified t) 2920 2929 (face font-lock-builtin-face fontified t) 2929 2963 (fontified t) 2963 2968 (face font-lock-builtin-face fontified t) 2968 3002 (fontified t) 3002 3011 (face font-lock-builtin-face fontified t) 3011 3028 (fontified t) 3028 3049 (fontified t) 3049 3054 (face font-lock-builtin-face fontified t) 3054 3056 (fontified t) 3056 3067 (face font-lock-string-face fontified t) 3067 3070 (fontified t) 3070 3105 (fontified t) 3105 3110 (face font-lock-builtin-face fontified t) 3110 3154 (fontified t) 3154 3171 (face font-lock-builtin-face fontified t) 3171 3173 (fontified t) 3173 3175 (face font-lock-string-face fontified t) 3175 3231 (fontified t) 3231 3239 (face font-lock-builtin-face fontified t) 3239 3252 (fontified t) 3252 3264 (face font-lock-keyword-face fontified t) 3264 3277 (fontified t) 3277 3282 (face font-lock-keyword-face fontified t) 3282 3431 (fontified t) 3431 3436 (face font-lock-builtin-face fontified t) 3436 3442 (fontified t) 3442 3450 (face font-lock-builtin-face fontified t) 3450 3501 (fontified t) 3501 3518 (face font-lock-builtin-face fontified t) 3518 3625 (fontified t) 3625 3630 (face font-lock-warning-face fontified t) 3630 3631 (fontified t) 3631 3653 (face font-lock-string-face fontified t) 3653 3665 (fontified t) 3665 3701 (face slime-reader-conditional-face fontified t) 3701 3709 (fontified t) 3709 3716 (face font-lock-builtin-face fontified t) 3716 3717 (fontified t) 3717 3731 (face font-lock-builtin-face fontified t) 3731 3807 (fontified t) 3807 3812 (face font-lock-keyword-face fontified t) 3812 3813 (fontified t) 3813 3818 (face font-lock-function-name-face fontified t) 3818 3825 (fontified t) 3825 3829 (face font-lock-keyword-face fontified t) 3829 3845 (fontified t) 3845 3849 (face font-lock-keyword-face fontified t) 3849 3872 (fontified t) 3872 3881 (face font-lock-builtin-face fontified t) 3881 3903 (fontified t) 3903 3916 (face font-lock-keyword-face fontified t) 3916 3984 (fontified t) 3984 3987 (face font-lock-comment-delimiter-face fontified t) 3987 4064 (face font-lock-comment-face fontified t) 4064 4067 (face font-lock-comment-delimiter-face fontified t) 4067 4079 (face font-lock-comment-face fontified t) 4079 4082 (face font-lock-comment-delimiter-face fontified t) 4082 4159 (face font-lock-comment-face fontified t) 4159 4160 (fontified t) 4160 4166 (face font-lock-keyword-face fontified t) 4166 4167 (fontified t) 4167 4182 (face font-lock-variable-name-face fontified t) 4182 4189 (fontified t) 4189 4269 (face font-lock-doc-face fontified t) 4269 4272 (fontified t) 4272 4275 (face font-lock-comment-delimiter-face fontified t) 4275 4336 (face font-lock-comment-face fontified t) 4336 4337 (fontified t) 4337 4342 (face font-lock-keyword-face fontified t) 4342 4343 (fontified t) 4343 4357 (face font-lock-function-name-face fontified t) 4357 4365 (fontified t) 4365 4369 (face font-lock-type-face fontified t) 4369 4431 (fontified t) 4431 4434 (face font-lock-comment-delimiter-face fontified t) 4434 4493 (face font-lock-comment-face fontified t) 4493 4495 (fontified t) 4495 4498 (face font-lock-comment-delimiter-face fontified t) 4498 4583 (face font-lock-comment-face fontified t) 4583 4586 (fontified t) 4586 4588 (face font-lock-keyword-face fontified t) 4588 4640 (fontified t) 4640 4643 (face font-lock-comment-delimiter-face fontified t) 4643 4700 (face font-lock-comment-face fontified t) 4700 4707 (fontified t) 4707 4710 (face font-lock-keyword-face fontified t) 4710 4733 (fontified t) 4733 4736 (face font-lock-comment-delimiter-face fontified t) 4736 4765 (face font-lock-comment-face fontified t) 4765 4774 (fontified t) 4774 4778 (face font-lock-keyword-face fontified t) 4778 4868 (fontified t) 4868 4887 (face font-lock-builtin-face fontified t) 4887 4943 (fontified t) 4943 4963 (face font-lock-string-face fontified t) 4963 4964 (fontified t) 4964 4972 (face font-lock-builtin-face fontified t) 4972 4973 (fontified t) 4973 4987 (face font-lock-builtin-face fontified t) 4987 5013 (fontified t) 5013 5021 (face font-lock-builtin-face fontified t) 5021 5036 (fontified t) 5036 5041 (face font-lock-keyword-face fontified t) 5041 5060 (fontified t) 5060 5069 (face font-lock-builtin-face fontified t) 5069 5100 (fontified t) 5100 5107 (face font-lock-builtin-face fontified t) 5107 5148 (fontified t) 5148 5152 (face font-lock-keyword-face fontified t) 5152 5170 (fontified t) 5170 5179 (face font-lock-builtin-face fontified t) 5179 5218 (fontified t) 5218 5223 (face font-lock-builtin-face fontified t) 5223 5262 (fontified t) 5262 5271 (face font-lock-builtin-face fontified t) 5271 5314 (fontified t) 5314 5319 (face font-lock-builtin-face fontified t) 5319 5321 (fontified t) 5321 5332 (face font-lock-string-face fontified t) 5332 5375 (fontified t) 5375 5380 (face font-lock-builtin-face fontified t) 5380 5429 (fontified t) 5429 5446 (face font-lock-builtin-face fontified t) 5446 5448 (fontified t) 5448 5450 (face font-lock-string-face fontified t) 5450 5511 (fontified t) 5511 5519 (face font-lock-builtin-face fontified t) 5519 5540 (fontified t) 5540 5566 (face font-lock-keyword-face fontified t) 5566 5640 (fontified t) 5640 5645 (face font-lock-builtin-face fontified t) 5645 5651 (fontified t) 5651 5659 (face font-lock-builtin-face fontified t) 5659 5668 (fontified t) 5668 5717 (fontified t) 5717 5734 (face font-lock-builtin-face fontified t) 5734 5788 (fontified t) 5788 5816 (face slime-reader-conditional-face fontified t) 5816 5831 (fontified t) 5831 5845 (face font-lock-builtin-face fontified t) 5845 5859 (fontified t) 5859 5862 (face font-lock-comment-delimiter-face fontified t) 5862 5908 (face font-lock-comment-face fontified t) 5908 5921 (fontified t) 5921 5924 (face font-lock-comment-delimiter-face fontified t) 5924 5971 (face font-lock-comment-face fontified t) 5971 5984 (fontified t) 5984 5987 (face font-lock-comment-delimiter-face fontified t) 5987 6031 (face font-lock-comment-face fontified t) 6031 6083 (fontified t) 6083 6086 (face font-lock-keyword-face fontified t) 6086 6181 (fontified t) 6181 6184 (face font-lock-comment-delimiter-face fontified t) 6184 6225 (face font-lock-comment-face fontified t) 6225 6291 (fontified t) 6291 6305 (face font-lock-keyword-face fontified t) 6305 6360 (fontified t) 6360 6386 (face font-lock-keyword-face fontified t) 6386 6403 (fontified t) 6403 6412 (face font-lock-builtin-face fontified t) 6412 6424 (fontified t) 6424 6429 (face font-lock-builtin-face fontified t) 6429 6441 (fontified t) 6441 6450 (face font-lock-builtin-face fontified t) 6450 6466 (fontified t) 6466 6471 (face font-lock-builtin-face fontified t) 6471 6473 (fontified t) 6473 6484 (face font-lock-string-face fontified t) 6484 6486 (fontified t) 6486 6495 (face font-lock-builtin-face fontified t) 6495 6558 (fontified t) 6558 6606 (face slime-reader-conditional-face fontified t) 6606 6681 (fontified t) 6681 6682 (fontified t) 6682 6690 (face font-lock-keyword-face fontified t) 6690 6691 (fontified t) 6691 6700 (face font-lock-function-name-face fontified t) 6700 6702 (fontified t) 6702 6711 (face font-lock-type-face fontified t) 6711 6717 (fontified t) 6717 6722 (face font-lock-type-face fontified t) 6722 6732 (fontified t) 6732 6734 (face font-lock-keyword-face fontified t) 6734 6824 (fontified t) 6824 6830 (face font-lock-keyword-face fontified t) 6830 6850 (fontified t) 6850 6874 (fontified t) 6874 6880 (face font-lock-keyword-face fontified t) 6880 6899 (fontified t) 6899 6900 (fontified t rear-nonsticky t) 6900 6901 (fontified t) 6901 6902 (fontified t) 6902 6903 (fontified t) 6903 6911 (face font-lock-keyword-face fontified t) 6911 6912 (fontified t) 6912 6929 (face font-lock-function-name-face fontified t) 6929 6931 (fontified t) 6931 6940 (face font-lock-type-face fontified t) 6940 6946 (fontified t) 6946 6951 (face font-lock-type-face fontified t) 6951 6958 (fontified t) 6958 6962 (fontified t) 6962 6971 (face font-lock-keyword-face fontified t) 6971 6981 (fontified t) 6981 6987 (fontified t) 6987 6988 (fontified t) 6988 6991 (face font-lock-comment-delimiter-face fontified t) 6991 7068 (face font-lock-comment-face fontified t) 7068 7071 (face font-lock-comment-delimiter-face fontified t) 7071 7091 (face font-lock-comment-face fontified t) 7091 7094 (face font-lock-comment-delimiter-face fontified t) 7094 7171 (face font-lock-comment-face fontified t) 7171 7172 (fontified t) 7172 7178 (face font-lock-keyword-face fontified t) 7178 7179 (fontified t) 7179 7209 (face font-lock-variable-name-face fontified t) 7209 7216 (fontified t) 7216 7222 (face font-lock-keyword-face fontified t) 7222 7223 (fontified t) 7223 7238 (face font-lock-variable-name-face fontified t) 7238 7247 (fontified t) 7247 7250 (face font-lock-comment-delimiter-face fontified t) 7250 7323 (face font-lock-comment-face fontified t) 7323 7324 (fontified t) 7324 7329 (face font-lock-keyword-face fontified t) 7329 7330 (fontified t) 7330 7339 (face font-lock-function-name-face fontified t) 7339 7414 (fontified t) 7414 7434 (face slime-reader-conditional-face fontified t) 7434 7470 (face slime-reader-conditional-face fontified t) 7470 7471 (face slime-reader-conditional-face fontified t) 7471 7475 (fontified t) 7475 7483 (face font-lock-keyword-face fontified t) 7483 7484 (fontified t) 7484 7506 (face font-lock-function-name-face fontified t) 7506 7513 (fontified t) 7513 7518 (face font-lock-type-face fontified t) 7518 7529 (fontified t) 7529 7532 (face font-lock-keyword-face fontified t) 7532 7551 (fontified t) 7551 7553 (face font-lock-keyword-face fontified t) 7553 7584 (fontified t) 7584 7589 (face font-lock-keyword-face fontified t) 7589 7602 (fontified t) 7602 7615 (face font-lock-keyword-face fontified t) 7615 7639 (fontified t) 7639 7673 (face font-lock-string-face fontified t) 7673 7721 (fontified t) 7721 7726 (face font-lock-keyword-face fontified t) 7726 7739 (fontified t) 7739 7742 (face font-lock-comment-delimiter-face fontified t) 7742 7812 (face font-lock-comment-face fontified t) 7812 7813 (fontified t) 7813 7818 (face font-lock-keyword-face fontified t) 7818 7819 (fontified t) 7819 7823 (face font-lock-function-name-face fontified t) 7823 7829 (fontified t) 7829 7834 (face font-lock-type-face fontified t) 7834 7845 (fontified t) 7845 7848 (face font-lock-comment-delimiter-face fontified t) 7848 7882 (face font-lock-comment-face fontified t) 7882 7885 (fontified t) 7885 7889 (face font-lock-keyword-face fontified t) 7889 7946 (fontified t) 7946 7948 (face font-lock-keyword-face fontified t) 7948 8002 (fontified t) 8002 8004 (face font-lock-keyword-face fontified t) 8004 8069 (fontified t) 8069 8080 (face font-lock-builtin-face fontified t) 8080 8089 (fontified t) 8089 8123 (fontified t) 8123 8173 (fontified t) 8173 8185 (face font-lock-keyword-face fontified t) 8185 8195 (fontified t) 8195 8217 (face font-lock-keyword-face fontified t) 8217 8242 (fontified t) 8242 8246 (face font-lock-keyword-face fontified t) 8246 8318 (fontified t) 8318 8329 (face font-lock-string-face fontified t) 8329 8382 (fontified t) 8382 8384 (face font-lock-keyword-face fontified t) 8384 8401 (fontified t) 8401 8402 (fontified t) 8402 8416 (fontified t) 8416 8420 (fontified t face font-lock-keyword-face) 8420 8450 (fontified t) 8450 8457 (fontified t face font-lock-builtin-face) 8457 8458 (fontified t) 8458 8464 (fontified t face font-lock-builtin-face) 8464 8467 (fontified t) 8547 8549 (face font-lock-keyword-face) 8586 8590 (face font-lock-keyword-face) 8619 8626 (face font-lock-builtin-face) 8627 8632 (face font-lock-builtin-face) 8758 8761 (face font-lock-comment-delimiter-face) 8761 8772 (face font-lock-comment-face) 8854 8855 (rear-nonsticky t) 8857 8861 (face font-lock-comment-delimiter-face) 8861 8937 (face font-lock-comment-face) 8937 8941 (face font-lock-comment-delimiter-face) 8941 8974 (face font-lock-comment-face) 8974 8978 (face font-lock-comment-delimiter-face) 8978 9054 (face font-lock-comment-face) 9055 9063 (face font-lock-keyword-face) 9064 9071 (face font-lock-function-name-face) 9074 9078 (face font-lock-type-face) 9090 9105 (face font-lock-builtin-face) 9196 9201 (face font-lock-type-face) 9211 9218 (face font-lock-keyword-face) 9266 9269 (face font-lock-comment-delimiter-face) 9269 9295 (face font-lock-comment-face) 9326 9329 (face font-lock-keyword-face) 9358 9372 (face font-lock-keyword-face) 9386 9391 (face font-lock-keyword-face) 9406 9409 (face font-lock-comment-delimiter-face) 9409 9440 (face font-lock-comment-face) 9465 9472 (face font-lock-string-face) 9503 9506 (face font-lock-comment-delimiter-face) 9506 9531 (face font-lock-comment-face) 9545 9548 (face font-lock-comment-delimiter-face) 9548 9590 (face font-lock-comment-face) 9604 9607 (face font-lock-comment-delimiter-face) 9607 9671 (face font-lock-comment-face) 9686 9689 (face font-lock-keyword-face) 9697 9702 (face font-lock-keyword-face) 9746 9749 (face font-lock-comment-delimiter-face) 9749 9806 (face font-lock-comment-face) 9833 9841 (face font-lock-string-face) 9921 9924 (face font-lock-comment-delimiter-face) 9924 9954 (face font-lock-comment-face) 9964 9970 (face font-lock-keyword-face) 9994 9997 (face font-lock-comment-delimiter-face) 9997 10064 (face font-lock-comment-face) 10075 10078 (face font-lock-comment-delimiter-face) 10078 10135 (face font-lock-comment-face) 10147 10160 (face font-lock-keyword-face) 10172 10182 (face font-lock-string-face) 10191 10195 (face font-lock-comment-delimiter-face) 10195 10271 (face font-lock-comment-face) 10271 10275 (face font-lock-comment-delimiter-face) 10275 10295 (face font-lock-comment-face) 10295 10299 (face font-lock-comment-delimiter-face) 10299 10375 (face font-lock-comment-face) 10376 10381 (face font-lock-keyword-face) 10382 10399 (face font-lock-function-name-face) 10413 10417 (face font-lock-keyword-face) 10428 10436 (face font-lock-builtin-face) 10442 10445 (face font-lock-builtin-face) 10449 10455 (face font-lock-builtin-face) 10456 10463 (face font-lock-builtin-face) 10465 10469 (face font-lock-builtin-face) 10472 10480 (face font-lock-builtin-face) 10481 10489 (face font-lock-builtin-face) 10492 10502 (face font-lock-builtin-face) 10503 10507 (face font-lock-builtin-face) 10510 10522 (face font-lock-builtin-face) 10523 10528 (face font-lock-builtin-face) 10533 10536 (face font-lock-builtin-face) 10542 10547 (face font-lock-keyword-face) 10548 10561 (face font-lock-function-name-face) 10572 10574 (face font-lock-keyword-face) 10644 10649 (face font-lock-keyword-face) 10650 10657 (face font-lock-function-name-face) 10742 10747 (face font-lock-keyword-face) 10748 10759 (face font-lock-function-name-face) 10845 10849 (face font-lock-comment-delimiter-face) 10849 10925 (face font-lock-comment-face) 10925 10929 (face font-lock-comment-delimiter-face) 10929 10944 (face font-lock-comment-face) 10944 10948 (face font-lock-comment-delimiter-face) 10948 11024 (face font-lock-comment-face) 11025 11030 (face font-lock-keyword-face) 11031 11038 (face font-lock-function-name-face) 11044 11049 (face font-lock-type-face) 11061 11065 (face font-lock-keyword-face) 11122 11124 (face font-lock-keyword-face) 11178 11180 (face font-lock-keyword-face) 11245 11256 (face font-lock-builtin-face) 11344 11356 (face font-lock-keyword-face) 11366 11388 (face font-lock-keyword-face) 11413 11417 (face font-lock-keyword-face) 11467 11474 (face font-lock-builtin-face) 11475 11482 (face font-lock-builtin-face) 11733 11737 (face font-lock-keyword-face) 11859 11866 (face font-lock-builtin-face) 11872 11877 (face font-lock-builtin-face) 11986 11991 (face font-lock-keyword-face) 11992 12000 (face font-lock-function-name-face) 12006 12011 (face font-lock-type-face) 12023 12027 (face font-lock-keyword-face) 12084 12086 (face font-lock-keyword-face) 12140 12142 (face font-lock-keyword-face) 12207 12218 (face font-lock-builtin-face) 12306 12318 (face font-lock-keyword-face) 12328 12350 (face font-lock-keyword-face) 12375 12379 (face font-lock-keyword-face) 12409 12416 (face font-lock-builtin-face) 12417 12423 (face font-lock-builtin-face) 12627 12629 (face font-lock-keyword-face) 12653 12657 (face font-lock-keyword-face) 12779 12786 (face font-lock-builtin-face) 12792 12797 (face font-lock-builtin-face) 12799 12801 (face font-lock-keyword-face) 12880 12882 (face font-lock-comment-delimiter-face) 12882 14077 (face font-lock-comment-face) 14077 14085 (face font-lock-comment-face)) . 1) (undo-tree-id37 . -17295) (undo-tree-id38 . -9440) (undo-tree-id39 . -10448) (undo-tree-id40 . -10448)) nil (26976 64539 490104 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9697 . 9698) (nil fontified nil 1 . 9698) (1 . 9698)) nil (26976 64539 490091 0) 0 nil])
([nil nil ((9698 . 9699)) nil (26976 64539 490087 0) 0 nil])
([nil nil ((5058 . 5060) (t 26976 64539 0 0)) nil (26977 215 74889 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7483 . 7484) (nil fontified nil 7398 . 7484) (nil fontified nil 7396 . 7398) (nil fontified nil 7394 . 7396) (nil fontified nil 7389 . 7394) (nil fontified nil 7383 . 7389) (nil fontified nil 7376 . 7383) (nil fontified nil 7246 . 7376) (nil fontified nil 7242 . 7246) (nil fontified nil 7218 . 7242) (nil fontified nil 7216 . 7218) (nil fontified nil 6970 . 7216) (nil fontified nil 6964 . 6970) (nil fontified nil 6963 . 6964) (nil fontified nil 6956 . 6963) (nil fontified nil 6926 . 6956) (nil fontified nil 6922 . 6926) (nil fontified nil 6897 . 6922) (nil fontified nil 6875 . 6897) (nil fontified nil 6865 . 6875) (nil fontified nil 6853 . 6865) (nil fontified nil 6765 . 6853) (nil fontified nil 6754 . 6765) (nil fontified nil 6689 . 6754) (nil fontified nil 6687 . 6689) (nil fontified nil 6633 . 6687) (nil fontified nil 6631 . 6633) (nil fontified nil 6574 . 6631) (nil fontified nil 6570 . 6574) (nil fontified nil 6566 . 6570) (nil fontified nil 6481 . 6566) (nil fontified nil 6470 . 6481) (nil fontified nil 6465 . 6470) (nil fontified nil 6459 . 6465) (nil fontified nil 6451 . 6459) (nil fontified nil 6450 . 6451) (nil fontified nil 6445 . 6450) (nil fontified nil 6444 . 6445) (nil fontified nil 6328 . 6444) (nil fontified nil 6323 . 6328) (nil fontified nil 6317 . 6323) (nil fontified nil 6310 . 6317) (nil fontified nil 6180 . 6310) (nil fontified nil 6176 . 6180) (nil fontified nil 5883 . 6176) (nil fontified nil 5876 . 5883) (nil fontified nil 5875 . 5876) (nil fontified nil 5868 . 5875) (nil fontified nil 5818 . 5868) (nil fontified nil 5814 . 5818) (nil fontified nil 5789 . 5814) (nil fontified nil 5767 . 5789) (nil fontified nil 5757 . 5767) (nil fontified nil 5745 . 5757) (nil fontified nil 5657 . 5745) (nil fontified nil 5646 . 5657) (nil fontified nil 5581 . 5646) (nil fontified nil 5579 . 5581) (nil fontified nil 5563 . 5579) (nil fontified nil 5525 . 5563) (nil fontified nil 5523 . 5525) (nil fontified nil 5466 . 5523) (nil fontified nil 5462 . 5466) (nil fontified nil 5458 . 5462) (nil fontified nil 5274 . 5458) (nil fontified nil 5263 . 5274) (nil fontified nil 5258 . 5263) (nil fontified nil 5252 . 5258) (nil fontified nil 5245 . 5252) (nil fontified nil 5244 . 5245) (nil fontified nil 5239 . 5244) (nil fontified nil 5238 . 5239) (nil fontified nil 5161 . 5238) (nil fontified nil 5158 . 5161) (nil fontified nil 5143 . 5158) (nil fontified nil 5140 . 5143) (nil fontified nil 5063 . 5140) (nil fontified nil 5060 . 5063) (5060 . 7484)) nil (26977 215 74886 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -7483) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 7484) nil (26977 215 74878 0) 0 nil])
([nil nil ((2003 . 2009) (t 26977 215 0 0)) nil (26977 326 532338 0) 0 nil])
([nil nil ((2009 . 2010)) nil (26977 326 532337 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2026 . 2027) (nil fontified nil 2010 . 2027) (2010 . 2027)) nil (26977 326 532336 0) 0 nil])
([nil nil ((2027 . 2028)) nil (26977 326 532332 0) 0 nil])
([nil nil ((1774 . 1777) (t 26977 326 0 0)) nil (26977 639 611623 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1801 . 1802) (nil fontified nil 1801 . 1802) (nil fontified nil 1800 . 1801) (nil fontified nil 1784 . 1800) (nil fontified nil 1777 . 1784) (1777 . 1802)) nil (26977 639 611622 0) 0 nil])
([nil nil ((#("*connection-mode*" 0 16 (fontified t) 16 17 (fontified t rear-nonsticky t)) . -1784) (undo-tree-id3 . -17) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -11) (undo-tree-id9 . -11) (undo-tree-id10 . -11) (undo-tree-id11 . -11) (undo-tree-id12 . -11) (undo-tree-id13 . -17) (undo-tree-id14 . -17) (undo-tree-id15 . -17) (undo-tree-id16 . -17) (undo-tree-id17 . -17) (undo-tree-id18 . -17) (undo-tree-id19 . -17) (undo-tree-id20 . -17) 1801) nil (26977 639 611619 0) 0 nil])
([nil nil ((1784 . 1790)) nil (26977 639 611596 0) 0 nil])
([nil nil ((#("toplevel" 0 8 (face font-lock-builtin-face fontified t)) . -1889) (undo-tree-id44 . -8) 1897 (t 26977 639 0 0)) nil (26977 702 969748 0) 0 nil])
([nil nil ((1889 . 1894)) nil (26977 702 969746 0) 0 nil])
([nil nil ((1888 . 1896) (#(":poole" 0 6 (face font-lock-builtin-face fontified t)) . -1888) (undo-tree-id28 . -1) (undo-tree-id29 . -6) (undo-tree-id30 . -1) (undo-tree-id31 . -5) (undo-tree-id32 . -5) (undo-tree-id33 . -5) (undo-tree-id34 . -6) (undo-tree-id35 . -6) (undo-tree-id36 . -6) (undo-tree-id37 . -6) (undo-tree-id38 . -6) (undo-tree-id39 . -6) (undo-tree-id40 . -6) (undo-tree-id41 . -6) (undo-tree-id42 . -6) (undo-tree-id43 . -6) 1894) nil (26977 702 969745 0) 0 nil])
([nil nil ((1896 . 1897)) nil (26977 702 969733 0) 0 nil])
([nil nil ((1888 . 1902) (#(":pooled-n" 0 9 (face font-lock-builtin-face fontified t)) . -1888) (undo-tree-id21 . -9) (undo-tree-id22 . -8) (undo-tree-id23 . -8) (undo-tree-id24 . -8) (undo-tree-id25 . -8) (undo-tree-id26 . -9) (undo-tree-id27 . -9) 1897) nil (26977 702 969730 0) 0 nil])
([nil nil ((#("(" 0 1 (fontified t)) . 1) (t 26977 702 0 0)) nil (26977 1284 321612 0) 0 nil])
([nil nil ((1 . 2)) nil (26977 1611 106250 0) 0 nil] [nil nil ((nil rear-nonsticky nil 14 . 15) (nil fontified nil 1 . 15) (1 . 15)) ((#("call-with-conn" 0 13 (fontified nil) 13 14 (rear-nonsticky nil fontified nil)) . 1) (undo-tree-id0 . -14) (nil rear-nonsticky t 14 . 15)) (26977 1284 321550 0) 0 nil])
([nil nil ((#("(defmacro with-tx ((&key (isolation :read-committed) (read-only nil) 
                         (retries 0) (sleep-ms 50)) 
                   &body body)
  (declare (ignore isolation read-only)) ;; Isolation ignorée pour simplifier le raw SQL
  
  (let ((attempt-sym (gensym \"ATTEMPT\"))
        (outcome-sym (gensym \"OUTCOME\"))
        (err-sym (gensym \"ERR\"))
        (res-sym (gensym \"RES\"))
        (msg-sym (gensym \"MSG\")))
    
    ;; Boucle de Retry
    `(loop :for ,attempt-sym :from 0 :to ,retries :do
       (let ((,outcome-sym
              ;; Connexion (Réentrante grâce à call-with-conn)
              (ensure-connection
                ;; Bloc pour capturer le retour
                (block tx-execution
                  (handler-case
                      (progn
                        ;; START TX
                        (%raw-exec \"BEGIN\")
                        
                        ;; INJECTION DU CORPS DU CODE (INLINE)
                        ;; Permet à call-next-method de fonctionner
                        (let ((,res-sym (progn ,@body)))
                          
                          ;; COMMIT
                          (%raw-exec \"COMMIT\")
                          
                          ;; Succès : (:success . valeur)
                          (cons :success ,res-sym)))
                    
                    ;; CATCH ERREUR
                    (error (,err-sym)
                      ;; ROLLBACK
                      (ignore-errors (%raw-exec \"ROLLBACK\"))
                      ;; Erreur : (:error . condition)
                      (cons :error ,err-sym)))))))
         
         ;; ANALYSE (Hors du bloc handler-case DB)
         (if (eq (car ,outcome-sym) :success)
             ;; SUCCÈS : On retourne la valeur et on sort de la boucle
             (return (cdr ,outcome-sym))
             
             ;; ÉCHEC
             (let* ((,err-sym (cdr ,outcome-sym))
                    ;; Sanitisation du message
                    (,msg-sym (format nil \"~A\" ,err-sym))
                    (is-app (typep ,err-sym 'lumen.core.error:application-error))
                    (mapped (unless is-app (lumen.data.errors:map-db-error ,err-sym))))
               
               (cond
                 ;; A) Erreur Métier -> ON LANCE L'ERREUR PROPREMENT
                 (is-app
                  (error 'lumen.core.error:application-error :message ,msg-sym))
                 
                 ;; B) Retry -> Le loop continuera
                 ((and mapped (< ,attempt-sym ,retries) (lumen.data.errors:retryable-db-error-p mapped))
                  (when (plusp ,sleep-ms) (sleep (/ (max 0 ,sleep-ms) 1000.0)))
                  ;; Loop continue...
                  )
                 
                 ;; C) Fatal
                 (t
                  (error \"Database Error: ~A\" ,msg-sym)))))))))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 17 (face font-lock-function-name-face fontified t) 17 20 (fontified t) 20 24 (face font-lock-type-face fontified t) 24 36 (fontified t) 36 51 (face font-lock-builtin-face fontified t) 51 142 (fontified t) 142 147 (face font-lock-type-face fontified t) 147 157 (fontified t) 157 164 (face font-lock-keyword-face fontified t) 164 195 (fontified t) 195 198 (face font-lock-comment-delimiter-face fontified t) 198 243 (face font-lock-comment-face fontified t) 243 249 (fontified t) 249 252 (face font-lock-keyword-face fontified t) 252 275 (fontified t) 275 284 (face font-lock-string-face fontified t) 284 316 (fontified t) 316 325 (face font-lock-string-face fontified t) 325 353 (fontified t) 353 358 (face font-lock-string-face fontified t) 358 386 (fontified t) 386 391 (face font-lock-string-face fontified t) 391 419 (fontified t) 419 424 (face font-lock-string-face fontified t) 424 437 (fontified t) 437 440 (face font-lock-comment-delimiter-face fontified t) 440 456 (face font-lock-comment-face fontified t) 456 462 (fontified t) 462 466 (face font-lock-keyword-face fontified t) 466 467 (fontified t) 467 471 (face font-lock-builtin-face fontified t) 471 485 (fontified t) 485 490 (face font-lock-builtin-face fontified t) 490 493 (fontified t) 493 496 (face font-lock-builtin-face fontified t) 496 506 (fontified t) 506 509 (face font-lock-builtin-face fontified t) 509 518 (fontified t) 518 521 (face font-lock-keyword-face fontified t) 521 551 (fontified t) 551 554 (face font-lock-comment-delimiter-face fontified t) 554 600 (face font-lock-comment-face fontified t) 600 649 (fontified t) 649 652 (face font-lock-comment-delimiter-face fontified t) 652 681 (face font-lock-comment-face fontified t) 681 698 (fontified t) 698 703 (face font-lock-keyword-face fontified t) 703 736 (fontified t) 736 748 (face font-lock-keyword-face fontified t) 748 772 (fontified t) 772 777 (face font-lock-keyword-face fontified t) 777 802 (fontified t) 802 805 (face font-lock-comment-delimiter-face fontified t) 805 814 (face font-lock-comment-face fontified t) 814 849 (fontified t) 849 856 (face font-lock-string-face fontified t) 856 907 (fontified t) 907 910 (face font-lock-comment-delimiter-face fontified t) 910 946 (face font-lock-comment-face fontified t) 946 970 (fontified t) 970 973 (face font-lock-comment-delimiter-face fontified t) 973 1014 (face font-lock-comment-face fontified t) 1014 1039 (fontified t) 1039 1042 (face font-lock-keyword-face fontified t) 1042 1055 (fontified t) 1055 1060 (face font-lock-keyword-face fontified t) 1060 1124 (fontified t) 1124 1127 (face font-lock-comment-delimiter-face fontified t) 1127 1134 (face font-lock-comment-face fontified t) 1134 1171 (fontified t) 1171 1179 (face font-lock-string-face fontified t) 1179 1234 (fontified t) 1234 1237 (face font-lock-comment-delimiter-face fontified t) 1237 1266 (face font-lock-comment-face fontified t) 1266 1298 (fontified t) 1298 1306 (face font-lock-builtin-face fontified t) 1306 1360 (fontified t) 1360 1363 (face font-lock-comment-delimiter-face fontified t) 1363 1376 (face font-lock-comment-face fontified t) 1376 1397 (fontified t) 1397 1402 (face font-lock-warning-face fontified t) 1402 1436 (fontified t) 1436 1439 (face font-lock-comment-delimiter-face fontified t) 1439 1448 (face font-lock-comment-face fontified t) 1448 1471 (fontified t) 1471 1484 (face font-lock-keyword-face fontified t) 1484 1496 (fontified t) 1496 1500 (face font-lock-string-face fontified t) 1500 1506 (face font-lock-string-face fontified t) 1506 1509 (fontified t) 1509 1531 (fontified t) 1531 1534 (face font-lock-comment-delimiter-face fontified t) 1534 1564 (face font-lock-comment-face fontified t) 1564 1592 (fontified t) 1592 1598 (face font-lock-builtin-face fontified t) 1598 1634 (fontified t) 1634 1637 (face font-lock-comment-delimiter-face fontified t) 1637 1676 (face font-lock-comment-face fontified t) 1676 1686 (fontified t) 1686 1688 (face font-lock-keyword-face fontified t) 1688 1712 (fontified t) 1712 1720 (face font-lock-builtin-face fontified t) 1720 1735 (fontified t) 1735 1738 (face font-lock-comment-delimiter-face fontified t) 1738 1793 (face font-lock-comment-face fontified t) 1793 1807 (fontified t) 1807 1813 (face font-lock-keyword-face fontified t) 1813 1861 (fontified t) 1861 1864 (face font-lock-comment-delimiter-face fontified t) 1864 1870 (face font-lock-comment-face fontified t) 1870 1884 (fontified t) 1884 1888 (face font-lock-keyword-face fontified t) 1888 1940 (fontified t) 1940 1943 (face font-lock-comment-delimiter-face fontified t) 1943 1967 (face font-lock-comment-face fontified t) 1967 2009 (fontified t) 2009 2013 (face font-lock-string-face fontified t) 2013 2136 (fontified t) 2136 2142 (face font-lock-keyword-face fontified t) 2142 2227 (fontified t) 2227 2231 (face font-lock-keyword-face fontified t) 2231 2249 (fontified t) 2249 2252 (face font-lock-comment-delimiter-face fontified t) 2252 2301 (face font-lock-comment-face fontified t) 2301 2345 (fontified t) 2345 2350 (face font-lock-warning-face fontified t) 2350 2387 (fontified t) 2387 2395 (face font-lock-builtin-face fontified t) 2395 2442 (fontified t) 2442 2445 (face font-lock-comment-delimiter-face fontified t) 2445 2476 (face font-lock-comment-face fontified t) 2476 2600 (fontified t) 2600 2604 (face font-lock-keyword-face fontified t) 2604 2679 (fontified t) 2679 2682 (face font-lock-comment-delimiter-face fontified t) 2682 2699 (face font-lock-comment-face fontified t) 2699 2754 (fontified t) 2754 2757 (face font-lock-comment-delimiter-face fontified t) 2757 2766 (face font-lock-comment-face fontified t) 2766 2805 (fontified t) 2805 2810 (face font-lock-warning-face fontified t) 2810 2811 (fontified t) 2811 2831 (face font-lock-string-face fontified t) 2831 2849 (fontified t)) . 9321) (undo-tree-id1 . -2849) (undo-tree-id2 . -2849) (undo-tree-id3 . -2849) (undo-tree-id4 . -2849)) nil (26977 1611 106248 0) 0 nil])
nil
([nil nil ((nil rear-nonsticky nil 11975 . 11976) (nil fontified nil 9321 . 11976) (9321 . 11976)) nil (26977 1611 106235 0) 0 nil])
([nil nil ((11977 . 11978) (t 26977 1611 0 0)) nil (26977 4766 168352 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14243 . 14244) (nil fontified nil 11978 . 14244) (11978 . 14244)) nil (26977 4766 168351 0) 0 nil])
([nil nil ((701 . 702)) nil (26977 4766 168351 0) 0 nil])
([nil nil ((702 . 703)) nil (26977 4766 168350 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 720 . 721) (nil fontified nil 703 . 721) (703 . 721)) nil (26977 4766 168349 0) 0 nil])
([nil nil ((14264 . 14265) 721) nil (26977 4766 168345 0) 0 nil])
([nil nil ((12205 . 12206) (t 26977 4766 0 0)) nil (26977 7750 70723 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12990 . 12991) (nil fontified nil 12206 . 12991) (12206 . 12991)) nil (26977 7750 70723 0) 0 nil])
([nil nil ((12991 . 12992)) nil (26977 7750 70722 0) 0 nil])
([nil nil ((#("(format nil \"~A\" err))" 0 12 (fontified t) 12 16 (face font-lock-string-face fontified t) 16 22 (fontified t)) . -14202) (undo-tree-id45 . -22) 14224) nil (26977 7750 70722 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14229 . 14230) (nil fontified nil 14202 . 14230) (14202 . 14230)) nil (26977 7750 70721 0) 0 nil])
([nil nil ((14684 . 14686) (#("		" 0 2 (fontified nil)) . 14683) (undo-tree-id44 . -2) (14682 . 14686)) nil (26977 7750 70720 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14848 . 14849) (nil fontified nil 14686 . 14849) (14686 . 14849)) nil (26977 7750 70719 0) 0 nil])
([nil nil ((#("QALM" 0 4 (face font-lock-comment-face fontified t)) . -14709) (undo-tree-id43 . -4) 14713) nil (26977 7750 70718 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . 14709)) nil (26977 7750 70717 0) 0 nil])
([nil nil ((#("inconnue" 0 8 (face font-lock-comment-face fontified t)) . -14709) (undo-tree-id42 . -8) 14717) nil (26977 7750 70716 0) 0 nil])
([nil nil ((#("s" 0 1 (face font-lock-comment-face fontified t)) . 14709) (#("i" 0 1 (face font-lock-comment-face fontified t)) . 14709) (#("a" 0 1 (face font-lock-comment-face fontified t)) . 14709) (#("m" 0 1 (face font-lock-comment-face fontified t)) . 14709) (#(" " 0 1 (face font-lock-comment-face fontified t)) . 14709)) nil (26977 7750 70715 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . 14709)) nil (26977 7750 70714 0) 0 nil])
([nil nil ((12991 . 12993)) nil (26977 7750 70714 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14318 . 14319) (nil fontified nil 12993 . 14319) (12993 . 14319)) nil (26977 7750 70713 0) 0 nil])
([nil nil ((#("QALM" 0 4 (face font-lock-comment-face fontified t)) . -13416) (undo-tree-id41 . -4) 13420) nil (26977 7750 70713 0) 0 nil])
([nil nil ((13416 . 13422)) nil (26977 7750 70712 0) 0 nil])
([nil nil ((13422 . 13423)) nil (26977 7750 70712 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -13422) (undo-tree-id40 . -1) 13423) nil (26977 7750 70711 0) 0 nil])
([nil nil ((#("QALM" 0 4 (face font-lock-comment-face fontified t)) . -13538) (undo-tree-id39 . -4) 13542) nil (26977 7750 70710 0) 0 nil])
([nil nil ((13538 . 13540)) nil (26977 7750 70709 0) 0 nil])
([nil nil ((13540 . 13541)) nil (26977 7750 70709 0) 0 nil])
([nil nil ((#("p" 0 1 (face font-lock-comment-face fontified t)) . -13530) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (#("a" 0 1 (face font-lock-comment-face fontified t)) . -13531) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (#("c" 0 1 (face font-lock-comment-face fontified t)) . -13532) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (#("k" 0 1 (face font-lock-comment-face fontified t)) . -13533) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (#("a" 0 1 (face font-lock-comment-face fontified t)) . -13534) (undo-tree-id28 . -1) (undo-tree-id29 . -1) (#("g" 0 1 (face font-lock-comment-face fontified t)) . -13535) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (#("e" 0 1 (face font-lock-comment-face fontified t)) . -13536) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -13537) (undo-tree-id34 . -1) (undo-tree-id35 . -1) (#("d" 0 1 (face font-lock-comment-face fontified t)) . -13538) (undo-tree-id36 . -1) (#("u" 0 1 (face font-lock-comment-face fontified t)) . -13539) (undo-tree-id37 . -1) (#(" " 0 1 (face font-lock-comment-face fontified t)) . -13540) (undo-tree-id38 . -1) 13541) nil (26977 7750 70707 0) 0 nil])
([nil nil ((13530 . 13531)) nil (26977 7750 70694 0) 0 nil])
([nil nil ((#("y" 0 1 (face font-lock-comment-face fontified t)) . -13530) (undo-tree-id19 . -1) 13531) nil (26977 7750 70693 0) 0 nil])
([nil nil ((13530 . 13537)) nil (26977 7750 70692 0) 0 nil])
([nil nil ((13537 . 13538)) nil (26977 7750 70691 0) 0 nil])
([nil nil ((13538 . 13544)) nil (26977 7750 70691 0) 0 nil])
([nil nil ((#("(defun run-in-transaction (thunk &key (retries 0) (sleep-ms 50))
  (let ((attempt 0))
    (loop
      (let ((outcome
             (block safe-zone
               (ensure-connection
                 (handler-case
                     (progn
                       (%raw-exec \"BEGIN\")
                       ;; On exécute le code métier
                       (let ((res (funcall thunk)))
                         (%raw-exec \"COMMIT\")
                         (cons :ok res)))
                   
                   ;; CATCH-ALL : On capture TOUT (Business ou Tech)
                   (error (c)
                     (ignore-errors (%raw-exec \"ROLLBACK\"))
                     ;; On retourne l'erreur emballée. Pas de re-throw ici.
                     (cons :error c)))))))
        
        ;; ANALYSE DU RÉSULTAT (Hors de la connexion DB)
        (if (eq (car outcome) :ok)
            (return (cdr outcome)) ;; SUCCÈS
            
            ;; ÉCHEC
            (let* ((err (cdr outcome))
                   (msg (extract-error-message err)) ;; Sanitisation immédiate
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (cond
                ;; A) ERREUR MÉTIER : On arrête tout et on retourne un objet erreur spécial
                ;; Le repo va le voir et le lancer proprement.
                (is-app
                 (return (cons :business-error msg)))

		;; Si c'est une erreur qui n'est pas DB, on suppose Business
                ((not mapped)
                 (return (cons :business-error msg)))
                
                ;; B) RETRY
                ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                 (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                 (incf attempt))
                
                ;; C) FATAL
                (t
                 (return (cons :fatal-error msg))))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 25 (face font-lock-function-name-face fontified t) 25 33 (fontified t) 33 37 (face font-lock-type-face fontified t) 37 68 (fontified t) 68 71 (face font-lock-keyword-face fontified t) 71 91 (fontified t) 91 95 (face font-lock-keyword-face fontified t) 95 103 (fontified t) 103 106 (face font-lock-keyword-face fontified t) 106 131 (fontified t) 131 136 (face font-lock-keyword-face fontified t) 136 199 (fontified t) 199 211 (face font-lock-keyword-face fontified t) 211 234 (fontified t) 234 239 (face font-lock-keyword-face fontified t) 239 274 (fontified t) 274 281 (face font-lock-string-face fontified t) 281 306 (fontified t) 306 309 (face font-lock-comment-delimiter-face fontified t) 309 335 (face font-lock-comment-face fontified t) 335 359 (fontified t) 359 362 (face font-lock-keyword-face fontified t) 362 423 (fontified t) 423 431 (face font-lock-string-face fontified t) 431 455 (fontified t) 455 464 (fontified t) 464 467 (face font-lock-builtin-face fontified t) 467 475 (fontified t) 475 514 (fontified t) 514 517 (face font-lock-comment-delimiter-face fontified t) 517 527 (face font-lock-comment-face fontified t) 527 564 (face font-lock-comment-face fontified t) 564 584 (fontified t) 584 589 (face font-lock-warning-face fontified t) 589 616 (fontified t) 616 629 (face font-lock-keyword-face fontified t) 629 641 (fontified t) 641 651 (face font-lock-string-face fontified t) 651 675 (fontified t) 675 678 (face font-lock-comment-delimiter-face fontified t) 678 730 (face font-lock-comment-face fontified t) 730 757 (fontified t) 757 763 (face font-lock-builtin-face fontified t) 763 790 (fontified t) 790 793 (face font-lock-comment-delimiter-face fontified t) 793 839 (face font-lock-comment-face fontified t) 839 848 (fontified t) 848 850 (face font-lock-keyword-face fontified t) 850 869 (fontified t) 869 872 (face font-lock-builtin-face fontified t) 872 887 (fontified t) 887 893 (face font-lock-keyword-face fontified t) 893 909 (fontified t) 909 912 (face font-lock-comment-delimiter-face fontified t) 912 919 (face font-lock-comment-face fontified t) 919 944 (fontified t) 944 947 (face font-lock-comment-delimiter-face fontified t) 947 953 (face font-lock-comment-face fontified t) 953 966 (fontified t) 966 970 (face font-lock-keyword-face fontified t) 970 992 (fontified t) 992 1016 (fontified t) 1016 1043 (fontified t) 1043 1044 (fontified t rear-nonsticky t) 1044 1045 (fontified t) 1045 1048 (face font-lock-comment-delimiter-face fontified t) 1048 1071 (face font-lock-comment-face fontified t) 1071 1105 (fontified t) 1105 1147 (fontified t) 1147 1175 (fontified t) 1175 1181 (face font-lock-keyword-face fontified t) 1181 1192 (fontified t) 1192 1229 (fontified t) 1229 1232 (fontified t) 1232 1244 (fontified t) 1244 1259 (fontified t) 1259 1263 (face font-lock-keyword-face fontified t) 1263 1280 (fontified t) 1280 1283 (face font-lock-comment-delimiter-face fontified t) 1283 1306 (face font-lock-comment-face fontified t) 1306 1313 (face font-lock-comment-face fontified t) 1313 1356 (face font-lock-comment-face fontified t) 1356 1372 (fontified t) 1372 1375 (face font-lock-comment-delimiter-face fontified t) 1375 1419 (face font-lock-comment-face fontified t) 1419 1443 (fontified t) 1443 1461 (fontified t) 1461 1467 (face font-lock-keyword-face fontified t) 1467 1474 (fontified t) 1474 1489 (face font-lock-builtin-face fontified t) 1489 1497 (fontified t) 1497 1498 (fontified t) 1498 1500 (fontified t) 1500 1503 (face font-lock-comment-delimiter-face fontified t) 1503 1561 (face font-lock-comment-face fontified t) 1561 1609 (fontified t) 1609 1615 (face font-lock-keyword-face fontified t) 1615 1622 (fontified t) 1622 1637 (face font-lock-builtin-face fontified t) 1637 1643 (fontified t) 1643 1644 (fontified t rear-nonsticky t) 1644 1645 (fontified t) 1645 1678 (fontified t) 1678 1681 (face font-lock-comment-delimiter-face fontified t) 1681 1690 (face font-lock-comment-face fontified t) 1690 1806 (fontified t) 1806 1810 (face font-lock-keyword-face fontified t) 1810 1931 (fontified t) 1931 1934 (face font-lock-comment-delimiter-face fontified t) 1934 1943 (face font-lock-comment-face fontified t) 1943 1962 (fontified t) 1962 1980 (fontified t) 1980 1986 (face font-lock-keyword-face fontified t) 1986 1993 (fontified t) 1993 2005 (face font-lock-builtin-face fontified t) 2005 2018 (fontified t) 2018 2019 (fontified t rear-nonsticky t)) . 14518) (undo-tree-id14 . -2019) (undo-tree-id15 . -839) (undo-tree-id16 . -1823) (undo-tree-id17 . -1823) (undo-tree-id18 . -1823)) nil (26977 7750 70690 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16234 . 16235) (nil fontified nil 14518 . 16235) (14518 . 16235)) nil (26977 7750 70687 0) 0 nil])
([nil nil ((446 . 449)) nil (26977 7750 70686 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 541 . 542) (nil fontified nil 541 . 542) (nil fontified nil 520 . 541) (nil fontified nil 519 . 520) (nil fontified nil 506 . 519) (nil fontified nil 505 . 506) (nil fontified nil 486 . 505) (nil fontified nil 481 . 486) (nil fontified nil 463 . 481) (nil fontified nil 462 . 463) (nil fontified nil 450 . 462) (nil fontified nil 449 . 450) (449 . 542)) nil (26977 7750 70686 0) 0 nil])
([nil nil ((#(":lumen.data.errors" 0 18 (face font-lock-builtin-face fontified t)) . -463) (undo-tree-id13 . -18) 481) nil (26977 7750 70684 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 479 . 480) (nil fontified nil 463 . 480) (463 . 480)) nil (26977 7750 70683 0) 0 nil])
([nil nil ((#(":translate-db-error" 0 19 (face font-lock-builtin-face fontified t)) . -485) (undo-tree-id12 . -19) 504) nil (26977 7750 70682 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 502 . 503) (nil fontified nil 485 . 503) (485 . 503)) nil (26977 7750 70681 0) 0 nil])
([nil nil ((#(":map-db-error :retryable-db-error-p" 0 13 (face font-lock-builtin-face fontified t) 13 14 (fontified t) 14 35 (face font-lock-builtin-face fontified t)) . -504) (undo-tree-id5 . -35) (undo-tree-id6 . -35) (undo-tree-id7 . -35) (undo-tree-id8 . -35) (undo-tree-id9 . -35) (undo-tree-id10 . -35) (undo-tree-id11 . -35) 539) nil (26977 7750 70679 0) 0 nil])
([nil nil ((nil fontified nil 553 . 554) (nil fontified nil 532 . 553) (nil fontified nil 531 . 532) (nil fontified nil 530 . 531) (nil fontified nil 529 . 530) (nil fontified nil 505 . 529) (nil fontified nil 504 . 505) (504 . 554)) nil (26977 7750 70662 0) 0 nil])
([nil nil ((#("
(defun extract-error-message (c)
  \"Essaie d'extraire le texte humain d'une condition par tous les moyens.\"
  (or
   ;; 1. Si c'est une SIMPLE-ERROR (via 'error' string), on reformate les arguments
   (and (typep c 'simple-condition)
        (simple-condition-format-control c)
        (apply #'format nil (simple-condition-format-control c) (simple-condition-format-arguments c)))
   
   ;; 2. Si c'est une APPLICATION-ERROR connue
   (ignore-errors (lumen.core.error:application-error-message c))
   
   ;; 3. Si c'est une DB-ERROR connue
   (ignore-errors (lumen.data.errors:db-error-message c))
   
   ;; 4. Tentative d'accès direct au slot 'message' (pour QALM error)
   (ignore-errors (slot-value c 'message))
   
   ;; 5. Fallback sur le report standard
   (format nil \"~A\" c)))
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (fontified t face font-lock-keyword-face) 7 8 (fontified t) 8 29 (fontified t face font-lock-function-name-face) 29 36 (fontified t) 36 108 (fontified t face font-lock-doc-face) 108 118 (fontified t) 118 121 (fontified t face font-lock-comment-delimiter-face) 121 199 (fontified t face font-lock-comment-face) 199 390 (fontified t) 390 393 (fontified t face font-lock-comment-delimiter-face) 393 434 (fontified t face font-lock-comment-face) 434 438 (fontified t) 438 451 (fontified t face font-lock-keyword-face) 451 507 (fontified t) 507 510 (fontified t face font-lock-comment-delimiter-face) 510 542 (fontified t face font-lock-comment-face) 542 546 (fontified t) 546 559 (fontified t face font-lock-keyword-face) 559 607 (fontified t) 607 610 (fontified t face font-lock-comment-delimiter-face) 610 674 (fontified t face font-lock-comment-face) 674 678 (fontified t) 678 691 (fontified t face font-lock-keyword-face) 691 724 (fontified t) 724 727 (fontified t face font-lock-comment-delimiter-face) 727 762 (fontified t face font-lock-comment-face) 762 777 (fontified t) 777 781 (face font-lock-string-face fontified t) 781 785 (fontified t) 785 786 (fontified t rear-nonsticky t) 786 787 (fontified t)) . 12314) (undo-tree-id46 . -787) (t 26977 7750 0 0)) nil (26977 8704 637265 0) 0 nil])
([nil nil ((12314 . 12315)) nil (26977 8704 637256 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 12815 . 12816) (nil fontified nil 12315 . 12816) (12315 . 12816)) nil (26977 8704 637256 0) 0 nil])
([nil nil ((12816 . 12817)) nil (26977 8704 637255 0) 0 nil])
([nil nil ((14148 . 14150)) nil (26977 8704 637255 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15100 . 15101) (nil fontified nil 14150 . 15101) (14150 . 15101)) nil (26977 8704 637254 0) 0 nil])
([nil nil ((12817 . 12818)) nil (26977 8704 637253 0) 0 nil])
([nil nil ((12818 . 12820)) nil (26977 8704 637253 0) 0 nil])
([nil nil ((14152 . 14154)) nil (26977 8704 637252 0) 0 nil])
([nil nil ((14154 . 14155)) nil (26977 8704 637248 0) 0 nil])
([nil nil ((14263 . 14266) (t 26977 8704 0 0)) nil (26977 9180 306263 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14595 . 14596) (nil fontified nil 14266 . 14596) (14266 . 14596)) nil (26977 9180 306263 0) 0 nil])
([nil nil ((14596 . 14599)) nil (26977 9180 306262 0) 0 nil])
([nil nil ((14263 . 14266)) nil (26977 9180 306262 0) 0 nil])
([nil nil ((14155 . 14156)) nil (26977 9180 306261 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14624 . 14625) (nil fontified nil 14156 . 14625) (14156 . 14625)) nil (26977 9180 306261 0) 0 nil])
([nil nil ((14625 . 14626)) nil (26977 9180 306260 0) 0 nil])
([nil nil ((#(";; 1. On cherche un slot 'CODE' dans le package de l'erreur (QALM, etc.)
          (read-slot-dynamically c \"CODE\")" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 73 (face font-lock-comment-face fontified t) 73 108 (fontified t) 108 114 (face font-lock-string-face fontified t) 114 115 (fontified t)) . -15352) (undo-tree-id94 . -115) (undo-tree-id95 . -73) (undo-tree-id96 . -115) (undo-tree-id97 . -115) (undo-tree-id98 . -115) (undo-tree-id99 . -115) (undo-tree-id100 . -115) (undo-tree-id101 . -115) 15467) nil (26977 9180 306259 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15475 . 15476) (nil fontified nil 15352 . 15476) (15352 . 15476)) nil (26977 9180 306255 0) 0 nil])
([nil nil ((15476 . 15480)) nil (26977 9180 306254 0) 0 nil])
([nil nil ((#("(code
         (or 
          ;; 1. On cherche les noms classiques
          (read-slot-loose c '(\"CODE\" \"STATUS\" \"HTTP-CODE\" \"HTTP-STATUS\" \"ERROR-CODE\"))
	  
          ;; 2. On cherche un slot 'STATUS' (autre convention fréquente)
          (read-slot-dynamically c \"STATUS\")
          ;; 3. Accès direct si c'est notre ApplicationError
          (ignore-errors (lumen.core.error:application-error-code c))
          ;; 4. Défaut
          400)))" 0 20 (fontified t) 20 30 (fontified t) 30 33 (face font-lock-comment-delimiter-face fontified t) 33 67 (face font-lock-comment-face fontified t) 67 98 (fontified t) 98 104 (face font-lock-string-face fontified t) 104 105 (fontified t) 105 113 (face font-lock-string-face fontified t) 113 114 (fontified t) 114 125 (face font-lock-string-face fontified t) 125 126 (fontified t) 126 139 (face font-lock-string-face fontified t) 139 140 (fontified t) 140 152 (face font-lock-string-face fontified t) 152 153 (fontified t) 153 154 (rear-nonsticky t fontified t) 154 158 (fontified t) 158 159 (fontified t) 159 169 (fontified t) 169 172 (face font-lock-comment-delimiter-face fontified t) 172 232 (face font-lock-comment-face fontified t) 232 267 (fontified t) 267 275 (face font-lock-string-face fontified t) 275 287 (fontified t) 287 290 (face font-lock-comment-delimiter-face fontified t) 290 338 (face font-lock-comment-face fontified t) 338 349 (fontified t) 349 362 (face font-lock-keyword-face fontified t) 362 418 (fontified t) 418 421 (face font-lock-comment-delimiter-face fontified t) 421 431 (face font-lock-comment-face fontified t) 431 447 (fontified t)) . -15322) (undo-tree-id47 . -447) (undo-tree-id48 . -30) (undo-tree-id49 . -30) (undo-tree-id50 . -30) (undo-tree-id51 . -30) (undo-tree-id52 . -30) (undo-tree-id53 . -30) (undo-tree-id54 . -30) (undo-tree-id55 . -30) (undo-tree-id56 . -30) (undo-tree-id57 . -20) (undo-tree-id58 . -30) (undo-tree-id59 . -30) (undo-tree-id60 . -159) (undo-tree-id61 . -30) (undo-tree-id62 . -30) (undo-tree-id63 . -30) (undo-tree-id64 . -30) (undo-tree-id65 . -30) (undo-tree-id66 . -20) (undo-tree-id67 . -154) (undo-tree-id68 . -159) (undo-tree-id69 . -154) (undo-tree-id70 . -154) (undo-tree-id71 . -154) (undo-tree-id72 . 293) (undo-tree-id73 . -67) (undo-tree-id74 . -158) (undo-tree-id75 . -159) (undo-tree-id76 . -158) (undo-tree-id77 . -158) (undo-tree-id78 . -158) (undo-tree-id79 . -158) (undo-tree-id80 . -158) (undo-tree-id81 . -158) (undo-tree-id82 . -158) (undo-tree-id83 . -158) (undo-tree-id84 . -158) (undo-tree-id85 . -158) (undo-tree-id86 . -30) (undo-tree-id87 . -431) (undo-tree-id88 . -447) (undo-tree-id89 . -447) (undo-tree-id90 . -447) (undo-tree-id91 . -447) (undo-tree-id92 . -447) (undo-tree-id93 . -447) 15769) nil (26977 9180 306251 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15906 . 15907) (nil fontified nil 15322 . 15907) (15322 . 15907)) nil (26977 9180 306215 0) 0 nil])
([nil nil ((16068 . 16070) (t 26977 9180 0 0)) nil (26977 9614 736160 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16734 . 16735) (nil fontified nil 16070 . 16735) (16070 . 16735)) nil (26977 9614 736159 0) 0 nil])
([nil nil ((14626 . 14627)) nil (26977 9614 736159 0) 0 nil])
([nil nil ((14627 . 14629)) nil (26977 9614 736158 0) 0 nil])
([nil nil ((16072 . 16074)) nil (26977 9614 736157 0) 0 nil])
([nil nil ((16074 . 16075)) nil (26977 9614 736154 0) 0 nil])
([nil nil ((#("

(defun extract-error-details (c)
  \"Extrait proprement le message et le code.\"
  (let ((msg 
         (or
          (ignore-errors (lumen.core.error:application-error-message c))
          (ignore-errors (format nil \"~A\" c))
          \"Erreur inconnue\"))
        
        (code
         (or 
          ;; Grâce à l'héritage corrigé, ceci marchera toujours pour business-error
          (ignore-errors (lumen.core.error:application-error-code c))
          ;; Fallback si c'est une autre erreur inconnue
          (ignore-errors (slot-value c 'qalm.backend.core.error::code))
          400)))
    
    (unless (integerp code) (setf code 400))
    (values msg code)))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 30 (face font-lock-function-name-face fontified t) 30 37 (fontified t) 37 59 (face font-lock-doc-face fontified t) 59 80 (face font-lock-doc-face fontified t) 80 81 (fontified t) 81 84 (fontified t) 84 87 (face font-lock-keyword-face fontified t) 87 92 (fontified t) 92 95 (fontified t) 95 119 (fontified t) 119 132 (face font-lock-keyword-face fontified t) 132 192 (fontified t) 192 205 (face font-lock-keyword-face fontified t) 205 218 (fontified t) 218 222 (face font-lock-string-face fontified t) 222 237 (fontified t) 237 254 (face font-lock-string-face fontified t) 254 304 (fontified t) 304 307 (face font-lock-comment-delimiter-face fontified t) 307 378 (face font-lock-comment-face fontified t) 378 389 (fontified t) 389 402 (face font-lock-keyword-face fontified t) 402 458 (fontified t) 458 461 (face font-lock-comment-delimiter-face fontified t) 461 505 (face font-lock-comment-face fontified t) 505 516 (fontified t) 516 529 (face font-lock-keyword-face fontified t) 529 604 (fontified t) 604 610 (face font-lock-keyword-face fontified t) 610 666 (fontified t) 666 667 (fontified t rear-nonsticky t)) . 16074) (undo-tree-id138 . -667) (undo-tree-id139 . -667) (undo-tree-id140 . -2) (undo-tree-id141 . -667) (t 26977 9614 0 0)) nil (26977 9694 687591 0) 0 nil])
([nil nil ((#("|" 0 1 (face font-lock-comment-face fontified t)) . -16072) (undo-tree-id116 . -1) (undo-tree-id117 . -1) (undo-tree-id118 . -1) (undo-tree-id119 . -1) (undo-tree-id120 . -1) (undo-tree-id121 . -1) (undo-tree-id122 . -1) (undo-tree-id123 . -1) (undo-tree-id124 . -1) (undo-tree-id125 . -1) (undo-tree-id126 . -1) (#("#" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -16073) (undo-tree-id127 . -1) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (undo-tree-id137 . -1) 16074) nil (26977 9694 687587 0) 0 nil])
([nil nil ((#("#" 0 1 (fontified t)) . -14627) (undo-tree-id102 . -1) (undo-tree-id103 . -1) (undo-tree-id104 . -1) (undo-tree-id105 . -1) (undo-tree-id106 . -1) (undo-tree-id107 . -1) (undo-tree-id108 . -1) (#("|" 0 1 (face font-lock-comment-delimiter-face fontified t)) . -14628) (undo-tree-id109 . -1) (undo-tree-id110 . -1) (undo-tree-id111 . -1) (undo-tree-id112 . -1) (undo-tree-id113 . -1) (undo-tree-id114 . -1) (undo-tree-id115 . -1) 14629) nil (26977 9694 687572 0) 0 nil])
([nil nil ((#("(defun read-slot-loose (instance slot-names)
  \"Cherche la valeur d'un slot parmi une liste de noms potentiels (string),
   quel que soit le package du symbole.\"
  (let* ((class (class-of instance))
         (pkg   (symbol-package (class-name class))))
    (when pkg
      (dolist (name slot-names)
        (let ((sym (find-symbol name pkg)))
          (when (and sym (slot-boundp instance sym))
            (return-from read-slot-loose (slot-value instance sym))))))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 22 (face font-lock-function-name-face fontified t) 22 47 (fontified t) 47 161 (face font-lock-doc-face fontified t) 161 165 (fontified t) 165 169 (face font-lock-keyword-face fontified t) 169 258 (fontified t) 258 262 (face font-lock-keyword-face fontified t) 262 274 (fontified t) 274 280 (face font-lock-keyword-face fontified t) 280 308 (fontified t) 308 311 (face font-lock-keyword-face fontified t) 311 354 (fontified t) 354 358 (face font-lock-keyword-face fontified t) 358 396 (fontified t) 396 409 (fontified t) 409 420 (face font-lock-keyword-face fontified t) 420 468 (fontified t) 468 469 (rear-nonsticky t fontified t) 469 470 (fontified t)) . -14156) (undo-tree-id142 . -470) (undo-tree-id143 . -470) (undo-tree-id144 . -470) (undo-tree-id145 . -470) 14626 (t 26977 9694 0 0)) nil (26977 10463 879773 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 14791 . 14792) (nil fontified nil 14156 . 14792) (14156 . 14792)) nil (26977 10463 879758 0) 0 nil])
([nil nil ((#("(defun read-slot-loose (instance slot-names)
  \"Cherche la valeur d'un slot par nom, en ignorant les erreurs de slot manquant.\"
  (let* ((class (class-of instance))
         (pkg   (symbol-package (class-name class))))
    (when pkg
      (dolist (name slot-names)
        (let ((sym (find-symbol name pkg)))
          ;; CORRECTION ICI : On enveloppe slot-boundp dans ignore-errors.
          ;; Si le slot n'existe pas sur l'objet, cela retourne NIL au lieu de crasher.
          (when (and sym 
                     (ignore-errors (slot-boundp instance sym)))
            (return-from read-slot-loose (slot-value instance sym))))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 22 (face font-lock-function-name-face fontified t) 22 47 (fontified t) 47 127 (face font-lock-doc-face fontified t) 127 131 (fontified t) 131 135 (face font-lock-keyword-face fontified t) 135 224 (fontified t) 224 228 (face font-lock-keyword-face fontified t) 228 240 (fontified t) 240 246 (face font-lock-keyword-face fontified t) 246 274 (fontified t) 274 277 (face font-lock-keyword-face fontified t) 277 319 (fontified t) 319 322 (face font-lock-comment-delimiter-face fontified t) 322 384 (face font-lock-comment-face fontified t) 384 394 (fontified t) 394 397 (face font-lock-comment-delimiter-face fontified t) 397 472 (face font-lock-comment-face fontified t) 472 483 (fontified t) 483 487 (face font-lock-keyword-face fontified t) 487 520 (fontified t) 520 533 (face font-lock-keyword-face fontified t) 533 576 (fontified t) 576 587 (face font-lock-keyword-face fontified t) 587 635 (fontified t) 635 636 (rear-nonsticky t fontified t)) . -14156) (undo-tree-id166 . -636) (undo-tree-id167 . -636) 14792 (t 26977 10463 0 0)) nil (26977 10809 614800 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15810 . 15811) (nil fontified nil 14156 . 15811) (14156 . 15811)) nil (26977 10809 614798 0) 0 nil])
([nil nil ((15038 . 15041)) nil (26977 10809 614798 0) 0 nil])
([nil nil ((nil fontified nil 15370 . 15371) (nil fontified nil 15311 . 15370) (nil fontified nil 15299 . 15311) (nil fontified nil 15258 . 15299) (nil fontified nil 15255 . 15258) (nil fontified nil 15240 . 15255) (nil fontified nil 15227 . 15240) (nil fontified nil 15210 . 15227) (nil fontified nil 15161 . 15210) (nil fontified nil 15147 . 15161) (nil fontified nil 15090 . 15147) (nil fontified nil 15078 . 15090) (nil fontified nil 15044 . 15078) (nil fontified nil 15041 . 15044) (15041 . 15371)) nil (26977 10809 614797 0) 0 nil])
([nil nil ((15371 . 15374)) nil (26977 10809 614795 0) 0 nil])
([nil nil ((#("
(defun extract-error-details (c)
  \"Retourne (values message code) à partir de n'importe quelle condition.\"
  
  ;; --- DEBUG: ON AFFICHE L'OBJET ---
  (format t \"~&-----------------------------------------------------\")
  (format t \"~&[DB DEBUG] Inspection de l'erreur métier : ~A\" (type-of c))
  (ignore-errors (describe c)) ;; Affiche tous les slots dans la console !
  (format t \"~&-----------------------------------------------------~%\")
  
  (let ((msg 
         (or
          ;; 1. Texte via format (standard)
          (ignore-errors (format nil \"~A\" c))
          ;; 2. Fallback slots connus
          (read-slot-dynamically c \"MESSAGE\")
          \"Erreur inconnue\"))
        
        (code
         (or 
          ;; 1. On cherche les noms classiques
          (read-slot-loose c '(\"CODE\" \"STATUS\" \"HTTP-CODE\" \"HTTP-STATUS\" \"ERROR-CODE\"))
          
          ;; 2. Accès direct Lumen
          (ignore-errors (lumen.core.error:application-error-code c))
          
          ;; 3. Check si c'est dans les arguments d'une simple-error
          (and (typep c 'simple-condition)
               (find-if (lambda (x) (and (integerp x) (>= x 400) (< x 600)))
                        (simple-condition-format-arguments c)))
          
          ;; 4. Défaut
          400)))
    
    ;; Petit clean-up : si le code n'est pas un entier (ex: string), on garde 400
    (unless (integerp code) (setf code 400))
    
    (values msg code)))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (fontified t face font-lock-keyword-face) 7 8 (fontified t) 8 29 (fontified t face font-lock-function-name-face) 29 34 (fontified t) 34 36 (fontified t) 36 108 (fontified t face font-lock-doc-face) 108 111 (fontified t) 111 112 (fontified t) 112 114 (fontified t) 114 117 (fontified t face font-lock-comment-delimiter-face) 117 151 (fontified t face font-lock-comment-face) 151 163 (fontified t) 163 220 (fontified t face font-lock-string-face) 220 234 (fontified t) 234 283 (fontified t face font-lock-string-face) 283 300 (fontified t) 300 313 (fontified t face font-lock-keyword-face) 313 328 (fontified t) 328 331 (fontified t face font-lock-comment-delimiter-face) 331 372 (fontified t face font-lock-comment-face) 372 384 (fontified t) 384 443 (fontified t face font-lock-string-face) 443 444 (fontified t rear-nonsticky t) 444 447 (fontified t) 447 448 (fontified t) 448 451 (fontified t) 451 454 (fontified t face font-lock-keyword-face) 454 485 (fontified t) 485 488 (fontified t face font-lock-comment-delimiter-face) 488 508 (fontified t face font-lock-comment-face) 508 519 (fontified t face font-lock-comment-face) 519 530 (fontified t) 530 541 (fontified t face font-lock-keyword-face) 541 543 (fontified t face font-lock-keyword-face) 543 556 (fontified t) 556 560 (fontified t face font-lock-string-face) 560 565 (fontified t) 565 575 (fontified t) 575 578 (fontified t face font-lock-comment-delimiter-face) 578 603 (fontified t face font-lock-comment-face) 603 638 (fontified t) 638 647 (fontified t face font-lock-string-face) 647 659 (fontified t) 659 676 (fontified t face font-lock-string-face) 676 688 (fontified t) 688 696 (fontified t) 696 726 (fontified t) 726 727 (face font-lock-comment-delimiter-face fontified t) 727 729 (face font-lock-comment-delimiter-face fontified t) 729 763 (face font-lock-comment-face fontified t) 763 794 (fontified t) 794 800 (face font-lock-string-face fontified t) 800 801 (fontified t) 801 809 (face font-lock-string-face fontified t) 809 810 (fontified t) 810 821 (face font-lock-string-face fontified t) 821 822 (fontified t) 822 835 (face font-lock-string-face fontified t) 835 836 (fontified t) 836 848 (face font-lock-string-face fontified t) 848 872 (fontified t) 872 875 (face font-lock-comment-delimiter-face fontified t) 875 897 (face font-lock-comment-face fontified t) 897 908 (fontified t) 908 921 (face font-lock-keyword-face fontified t) 921 988 (fontified t) 988 991 (face font-lock-comment-delimiter-face fontified t) 991 1047 (face font-lock-comment-face fontified t) 1047 1115 (fontified t) 1115 1121 (face font-lock-keyword-face fontified t) 1121 1252 (fontified t) 1252 1255 (face font-lock-comment-delimiter-face fontified t) 1255 1265 (face font-lock-comment-face fontified t) 1265 1280 (fontified t) 1280 1281 (fontified t rear-nonsticky t) 1281 1282 (fontified t) 1282 1291 (fontified t) 1291 1294 (face font-lock-comment-delimiter-face fontified t) 1294 1369 (face font-lock-comment-face fontified t) 1369 1374 (fontified t) 1374 1380 (face font-lock-keyword-face fontified t) 1380 1419 (fontified t) 1419 1441 (fontified t) 1441 1442 (fontified t rear-nonsticky t)) . 16148) (undo-tree-id153 . -1442) (undo-tree-id154 . -448) (undo-tree-id155 . -1264) (undo-tree-id156 . -1) (undo-tree-id157 . -114) (undo-tree-id158 . -696) (undo-tree-id159 . -444) (undo-tree-id160 . -1442) (undo-tree-id161 . -33) (undo-tree-id162 . -33) (undo-tree-id163 . -33) (undo-tree-id164 . -33) (undo-tree-id165 . -1442)) nil (26977 10809 614794 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 16148) (#("
" 0 1 (fontified t)) . 16148) (undo-tree-id152 . -1)) nil (26977 10809 614783 0) 0 nil])
([nil nil ((#("
;; --- NOUVEAU HELPER : LECTURE CIBLÉE ---" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 43 (face font-lock-comment-face fontified t)) . 14596) (undo-tree-id146 . -43) (undo-tree-id147 . -43) (undo-tree-id148 . -43) (undo-tree-id149 . -43) (undo-tree-id150 . -43) (undo-tree-id151 . -43)) nil (26977 10809 614779 0) 0 nil])
([nil nil ((14595 . 14597) (t 26977 10809 0 0)) nil (26977 11299 706289 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 15364 . 15365) (nil fontified nil 14597 . 15365) (14597 . 15365)) nil (26977 11299 706289 0) 0 nil])
([nil nil ((#("

(defun read-lumen-slot (instance slot-name)
  \"Cherche le slot dans le package LUMEN.CORE.ERROR (héritage).\"
  (let ((sym (find-symbol slot-name :lumen.core.error)))
    (when (and sym (ignore-errors (slot-boundp instance sym)))
      (slot-value instance sym))))

(defun read-slot-loose (instance slot-names)
  \"Cherche le slot dans le package DE L'INSTANCE (QALM, etc.).
   Indispensable si l'héritage est imparfait ou si le slot est masqué.\"
  (let* ((class (class-of instance))
         (pkg   (symbol-package (class-name class))))
    (when pkg
      (dolist (name slot-names)
        (let ((sym (find-symbol name pkg)))
          (when (and sym (ignore-errors (slot-boundp instance sym)))
            (return-from read-slot-loose (slot-value instance sym))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 24 (face font-lock-function-name-face fontified t) 24 48 (fontified t) 48 110 (face font-lock-doc-face fontified t) 110 114 (fontified t) 114 117 (face font-lock-keyword-face fontified t) 117 147 (fontified t) 147 164 (face font-lock-builtin-face fontified t) 164 173 (fontified t) 173 177 (face font-lock-keyword-face fontified t) 177 188 (fontified t) 188 201 (face font-lock-keyword-face fontified t) 201 268 (fontified t) 268 273 (face font-lock-keyword-face fontified t) 273 274 (fontified t) 274 289 (face font-lock-function-name-face fontified t) 289 314 (fontified t) 314 446 (face font-lock-doc-face fontified t) 446 450 (fontified t) 450 454 (face font-lock-keyword-face fontified t) 454 543 (fontified t) 543 547 (face font-lock-keyword-face fontified t) 547 559 (fontified t) 559 565 (face font-lock-keyword-face fontified t) 565 593 (fontified t) 593 596 (face font-lock-keyword-face fontified t) 596 639 (fontified t) 639 643 (face font-lock-keyword-face fontified t) 643 654 (fontified t) 654 667 (face font-lock-keyword-face fontified t) 667 710 (fontified t) 710 721 (face font-lock-keyword-face fontified t) 721 769 (fontified t) 769 770 (rear-nonsticky t fontified t)) . 14595) (undo-tree-id169 . -770)) nil (26977 11299 706288 0) 0 nil])
([nil nil ((16032 . 16036) (#("    " 0 4 (fontified nil)) . 16031) (undo-tree-id168 . -4) (16030 . 16036)) nil (26977 11299 706280 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 16100 . 16101) (nil fontified nil 16036 . 16101) (16036 . 16101)) nil (26977 11299 706266 0) 0 nil])
([nil nil ((#("(defun exec (sql &rest params)
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil))))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            (if has-returning
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
                  (setf affected (if row 1 0) ret row))
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n ret nil)))
            (values affected ret)))
      (condition (c) (translate-db-error c)))))" 0 1 (fontified t) 1 6 (fontified t face font-lock-keyword-face) 6 7 (fontified t) 7 11 (fontified t face font-lock-function-name-face) 11 17 (fontified t) 17 22 (fontified t face font-lock-type-face) 22 34 (fontified t) 34 38 (fontified t face font-lock-keyword-face) 38 95 (fontified t) 95 97 (fontified t face font-lock-keyword-face) 97 151 (fontified t) 151 153 (fontified t face font-lock-keyword-face) 153 218 (fontified t) 218 229 (fontified t face font-lock-builtin-face) 229 278 (fontified t) 278 290 (fontified t face font-lock-keyword-face) 290 300 (fontified t) 300 322 (fontified t face font-lock-keyword-face) 322 347 (fontified t) 347 351 (fontified t face font-lock-keyword-face) 351 423 (fontified t) 423 434 (fontified t face font-lock-string-face) 434 487 (fontified t) 487 489 (fontified t face font-lock-keyword-face) 489 521 (fontified t) 521 525 (fontified t face font-lock-keyword-face) 525 555 (fontified t) 555 562 (fontified t face font-lock-builtin-face) 562 563 (fontified t) 563 569 (fontified t face font-lock-builtin-face) 569 652 (fontified t) 652 654 (fontified t face font-lock-keyword-face) 654 691 (fontified t) 691 695 (fontified t face font-lock-keyword-face) 695 724 (fontified t) 724 731 (fontified t face font-lock-builtin-face) 731 732 (fontified t) 732 737 (fontified t face font-lock-builtin-face) 737 874 (fontified t) 874 921 (fontified t)) . 8306) (undo-tree-id181 . -921) (undo-tree-id182 . -791) (undo-tree-id183 . -135) (undo-tree-id184 . -135) (undo-tree-id185 . -135) (undo-tree-id186 . -921) (undo-tree-id187 . -921) (undo-tree-id188 . -921) (undo-tree-id189 . -921) (undo-tree-id190 . -921) (undo-tree-id191 . -921) (t 26977 11299 0 0)) nil (26977 18781 558933 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10866 . 10867) (nil fontified nil 10800 . 10867) (nil fontified nil 10795 . 10800) (nil fontified nil 10740 . 10795) (nil fontified nil 10705 . 10740) (nil fontified nil 10702 . 10705) (nil fontified nil 10696 . 10702) (nil fontified nil 10633 . 10696) (nil fontified nil 10630 . 10633) (nil fontified nil 10561 . 10630) (nil fontified nil 10552 . 10561) (nil fontified nil 10546 . 10552) (nil fontified nil 10539 . 10546) (nil fontified nil 10398 . 10539) (nil fontified nil 10394 . 10398) (nil fontified nil 10171 . 10394) (nil fontified nil 10168 . 10171) (nil fontified nil 10155 . 10168) (nil fontified nil 10133 . 10155) (nil fontified nil 10130 . 10133) (nil fontified nil 9980 . 10130) (nil fontified nil 9975 . 9980) (nil fontified nil 9974 . 9975) (nil fontified nil 9967 . 9974) (nil fontified nil 9938 . 9967) (nil fontified nil 9934 . 9938) (nil fontified nil 9917 . 9934) (nil fontified nil 9853 . 9917) (nil fontified nil 9850 . 9853) (nil fontified nil 9817 . 9850) (nil fontified nil 9816 . 9817) (nil fontified nil 9773 . 9816) (nil fontified nil 9771 . 9773) (nil fontified nil 9688 . 9771) (nil fontified nil 9682 . 9688) (nil fontified nil 9681 . 9682) (nil fontified nil 9674 . 9681) (nil fontified nil 9644 . 9674) (nil fontified nil 9640 . 9644) (nil fontified nil 9623 . 9640) (nil fontified nil 9582 . 9623) (nil fontified nil 9579 . 9582) (nil fontified nil 9548 . 9579) (nil fontified nil 9546 . 9548) (nil fontified nil 9480 . 9546) (nil fontified nil 9469 . 9480) (nil fontified nil 9397 . 9469) (nil fontified nil 9393 . 9397) (nil fontified nil 9368 . 9393) (nil fontified nil 9346 . 9368) (nil fontified nil 9336 . 9346) (nil fontified nil 9324 . 9336) (nil fontified nil 9307 . 9324) (nil fontified nil 9288 . 9307) (nil fontified nil 9267 . 9288) (nil fontified nil 9248 . 9267) (nil fontified nil 9150 . 9248) (nil fontified nil 9139 . 9150) (nil fontified nil 9107 . 9139) (nil fontified nil 9084 . 9107) (nil fontified nil 9081 . 9084) (nil fontified nil 9029 . 9081) (nil fontified nil 9027 . 9029) (nil fontified nil 8973 . 9027) (nil fontified nil 8971 . 8973) (nil fontified nil 8955 . 8971) (nil fontified nil 8907 . 8955) (nil fontified nil 8904 . 8907) (nil fontified nil 8838 . 8904) (nil fontified nil 8833 . 8838) (nil fontified nil 8831 . 8833) (nil fontified nil 8823 . 8831) (nil fontified nil 8822 . 8823) (nil fontified nil 8817 . 8822) (nil fontified nil 8712 . 8817) (nil fontified nil 8706 . 8712) (nil fontified nil 8677 . 8706) (nil fontified nil 8593 . 8677) (nil fontified nil 8590 . 8593) (nil fontified nil 8581 . 8590) (nil fontified nil 8529 . 8581) (nil fontified nil 8526 . 8529) (nil fontified nil 8524 . 8526) (nil fontified nil 8520 . 8524) (nil fontified nil 8508 . 8520) (nil fontified nil 8490 . 8508) (nil fontified nil 8474 . 8490) (nil fontified nil 8339 . 8474) (nil fontified nil 8328 . 8339) (nil fontified nil 8323 . 8328) (nil fontified nil 8317 . 8323) (nil fontified nil 8316 . 8317) (nil fontified nil 8313 . 8316) (nil fontified nil 8312 . 8313) (nil fontified nil 8307 . 8312) (nil fontified nil 8306 . 8307) (8306 . 10867)) nil (26977 18781 558918 0) 0 nil])
([nil nil ((#("

      ;; Si c'est une erreur applicative, on la re-signale telle quelle
      ;; sans l'emballer dans une db-error.
      (lumen.core.error:application-error (c)
        (error c))" 0 8 (fontified t) 8 11 (face font-lock-comment-delimiter-face fontified t) 11 74 (face font-lock-comment-face fontified t) 74 80 (fontified t) 80 83 (face font-lock-comment-delimiter-face fontified t) 83 118 (face font-lock-comment-face fontified t) 118 173 (fontified t) 173 178 (face font-lock-warning-face fontified t) 178 182 (fontified t)) . 10622) (undo-tree-id172 . -182) (undo-tree-id173 . -182) (undo-tree-id174 . -182) (undo-tree-id175 . -182) (undo-tree-id176 . -1) (undo-tree-id177 . -1) (undo-tree-id178 . -1) (undo-tree-id179 . -1) (undo-tree-id180 . -182)) nil (26977 18781 558906 0) 0 nil])
([nil nil ((10685 . 10686)) nil (26977 18781 558896 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -10685) (undo-tree-id170 . -1) (undo-tree-id171 . -1) 10686) nil (26977 18781 558892 0) 0 nil])
([nil nil ((9736 . 9741) (t 26977 18781 0 0)) nil (26977 19156 137048 0) 0 nil])
([nil nil ((9741 . 9747)) nil (26977 19156 137046 0) 0 nil])
([nil nil ((9747 . 9748)) nil (26977 19156 137044 0) 0 nil])
([nil nil ((9748 . 9752)) nil (26977 19156 137039 0) 0 nil])
([nil nil ((9736 . 9741) (t 26977 19156 0 0)) nil (26977 19172 544144 0) 0 nil])
([nil nil ((9741 . 9747)) nil (26977 19172 544143 0) 0 nil])
([nil nil ((9747 . 9748)) nil (26977 19172 544142 0) 0 nil])
([nil nil ((9748 . 9749)) nil (26977 19172 544141 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -9748) (undo-tree-id192 . -1) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) 9749) nil (26977 19172 544139 0) 0 nil])
([nil nil ((9748 . 9756)) nil (26977 19172 544113 0) 0 nil])
([nil nil ((9323 . 9325) (t 26977 19172 0 0)) nil (26977 23279 264630 0) 0 nil])
([nil nil ((10715 . 10718) (10689 . 10692) (#("        " 0 8 (fontified nil)) . 10689) (10719 . 10720)) nil (26977 23279 264630 0) 0 nil])
([nil nil ((10719 . 10724)) nil (26977 23279 264629 0) 0 nil])
([nil nil ((10674 . 10676)) nil (26977 23279 264629 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -10674) (undo-tree-id203 . -1) (#(":" 0 1 (face font-lock-builtin-face fontified t)) . -10675) (undo-tree-id204 . -1) 10676) nil (26977 23279 264628 0) 0 nil])
([nil nil ((10674 . 10676)) nil (26977 23279 264626 0) 0 nil])
([nil nil ((#(":" 0 1 (fontified t)) . -10674) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (#(":" 0 1 (face font-lock-builtin-face fontified t)) . -10675) (undo-tree-id202 . -1) 10676) nil (26977 23279 264625 0) 0 nil])
([nil nil ((10674 . 10676)) nil (26977 23279 264621 0) 0 nil])
([nil nil ((10692 . 10694)) nil (26977 23279 264621 0) 0 nil])
([nil nil ((10720 . 10722)) nil (26977 23279 264620 0) 0 nil])
([nil nil ((10731 . 10734)) nil (26977 23279 264620 0) 0 nil])
([nil nil ((10730 . 10732)) nil (26977 23279 264619 0) 0 nil])
([nil nil ((10738 . 10739)) nil (26977 23279 264618 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -10738) (undo-tree-id197 . -1) (undo-tree-id198 . -1) 10739) nil (26977 23279 264614 0) 0 nil])
([nil nil ((8304 . 8306) (t 26977 23279 0 0)) nil (26977 23450 658782 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10148 . 10149) (nil fontified nil 8306 . 10149) (8306 . 10149)) nil (26977 23450 658781 0) 0 nil])
([nil nil ((8933 . 8937) (#("    " 0 4 (fontified nil)) . 8932) (undo-tree-id246 . -4) (8931 . 8937)) nil (26977 23450 658779 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 9011 . 9012) (nil fontified nil 9006 . 9012) (nil fontified nil 8987 . 9006) (nil fontified nil 8966 . 8987) (nil fontified nil 8947 . 8966) (nil fontified nil 8937 . 8947) (8937 . 9012)) nil (26977 23450 658777 0) 0 nil])
([nil nil ((#("
  ;; SUPPRESSION DU HANDLER-CASE ICI

(defun exec (sql &rest params)
  \"Execute INSERT/UPDATE/DELETE. Returns (values affected returning?).
   Gère correctement les arguments :NULL dans les paramètres SQL.\"
  
  (format t \"~&EXEC:SQL: ~A~%\" sql)
  
  (let* (;; On cherche le début des options (:timeout-ms, etc.)
         ;; CORRECTION : On ignore :NULL et :DEFAULT qui sont des valeurs SQL, pas des options.
         (kpos (position-if (lambda (x)
                              (and (keywordp x)
                                   (not (member x '(:null :default) :test #'eq))))
                            params))
         
         ;; Séparation propre Arguments SQL / Options Lumen
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         
         ;; Extraction des options
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))

    (format t \"~&EXEC:ARGS: ~A~%\" args)
    (format t \"~&EXEC:OPTS: ~A~%\" opts)
    
    ;;(handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((lower (string-downcase sql))
                 (has-returning (search \"returning\" lower))
                 affected ret)
            
            (if has-returning
                ;; RETURNING -> On veut le résultat (alist)
                (let* ((fn  (get-prepared-plan sql :format :alist))
                       (row (apply fn args)))
		  (print \"OKKKK\")
		  (print row)
                  (setf affected (if row 1 0)
                        ret row))
                
                ;; Pas de RETURNING -> On veut juste le nombre de lignes affectées
                (let* ((fn (get-prepared-plan sql :format :none))
                       (n  (or (apply fn args) 0)))
                  (setf affected n
                        ret nil)))
            
            ;; Métriques (Optionnel)
            (let ((elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                           cl:internal-time-units-per-second))))
              (record-query-latency sql elapsed-ms (or affected 0))
              (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
                (lumen.data.metrics:record-slow-query
                 sql elapsed-ms :params args :affected affected)))
            
            (values affected ret)))
      
      ;;(condition (c)
	;;	 (translate-db-error c)
	;;	 )
    ;;)
  ))" 0 1 (fontified t) 1 3 (fontified t) 3 6 (face font-lock-comment-delimiter-face fontified t) 6 36 (face font-lock-comment-face fontified t) 36 37 (face font-lock-comment-face fontified t rear-nonsticky t) 37 38 (face font-lock-comment-face fontified t) 38 39 (fontified t) 39 40 (fontified t) 40 45 (face font-lock-keyword-face fontified t) 45 46 (fontified t) 46 49 (face font-lock-function-name-face fontified t) 49 50 (face font-lock-function-name-face fontified t) 50 56 (fontified t) 56 61 (face font-lock-type-face fontified t) 61 72 (fontified t) 72 207 (face font-lock-doc-face fontified t) 207 223 (fontified t) 223 241 (face font-lock-string-face fontified t) 241 253 (fontified t) 253 257 (face font-lock-keyword-face fontified t) 257 259 (fontified t) 259 262 (face font-lock-comment-delimiter-face fontified t) 262 314 (face font-lock-comment-face fontified t) 314 320 (fontified t) 320 323 (fontified t) 323 326 (face font-lock-comment-delimiter-face fontified t) 326 410 (face font-lock-comment-face fontified t) 410 439 (fontified t) 439 445 (face font-lock-keyword-face fontified t) 445 550 (fontified t) 550 555 (face font-lock-builtin-face fontified t) 555 556 (fontified t) 556 564 (face font-lock-builtin-face fontified t) 564 566 (fontified t) 566 571 (face font-lock-builtin-face fontified t) 571 637 (fontified t) 637 640 (face font-lock-comment-delimiter-face fontified t) 640 688 (face font-lock-comment-face fontified t) 688 704 (fontified t) 704 706 (face font-lock-keyword-face fontified t) 706 760 (fontified t) 760 762 (face font-lock-keyword-face fontified t) 762 814 (fontified t) 814 817 (face font-lock-comment-delimiter-face fontified t) 817 840 (face font-lock-comment-face fontified t) 840 872 (fontified t) 872 883 (face font-lock-builtin-face fontified t) 883 981 (fontified t) 981 1000 (face font-lock-string-face fontified t) 1000 1021 (fontified t) 1021 1040 (face font-lock-string-face fontified t) 1040 1052 (fontified t) 1052 1056 (fontified t) 1056 1058 (face font-lock-comment-delimiter-face fontified t) 1058 1059 (face font-lock-comment-face fontified t) 1059 1071 (face font-lock-comment-face fontified t) 1071 1072 (face font-lock-comment-face fontified t) 1072 1081 (fontified t) 1081 1103 (face font-lock-keyword-face fontified t) 1103 1128 (fontified t) 1128 1132 (face font-lock-keyword-face fontified t) 1132 1204 (fontified t) 1204 1215 (face font-lock-string-face fontified t) 1215 1281 (fontified t) 1281 1283 (face font-lock-keyword-face fontified t) 1283 1314 (fontified t) 1314 1317 (face font-lock-comment-delimiter-face fontified t) 1317 1358 (face font-lock-comment-face fontified t) 1358 1375 (fontified t) 1375 1379 (face font-lock-keyword-face fontified t) 1379 1409 (fontified t) 1409 1416 (face font-lock-builtin-face fontified t) 1416 1417 (fontified t) 1417 1423 (face font-lock-builtin-face fontified t) 1423 1426 (fontified t) 1426 1472 (fontified t) 1472 1483 (fontified t) 1483 1490 (face font-lock-string-face fontified t) 1490 1491 (fontified t) 1491 1492 (fontified t) 1492 1501 (fontified t) 1501 1508 (fontified t) 1508 1542 (fontified t) 1542 1544 (face font-lock-keyword-face fontified t) 1544 1577 (fontified t) 1577 1587 (fontified t) 1587 1588 (fontified t) 1588 1621 (fontified t) 1621 1624 (face font-lock-comment-delimiter-face fontified t) 1624 1688 (face font-lock-comment-face fontified t) 1688 1705 (fontified t) 1705 1709 (face font-lock-keyword-face fontified t) 1709 1738 (fontified t) 1738 1745 (face font-lock-builtin-face fontified t) 1745 1746 (fontified t) 1746 1751 (face font-lock-builtin-face fontified t) 1751 1901 (fontified t) 1901 1904 (face font-lock-comment-delimiter-face fontified t) 1904 1910 (face font-lock-comment-face fontified t) 1910 1926 (face font-lock-comment-face fontified t) 1926 1939 (fontified t) 1939 1942 (face font-lock-keyword-face fontified t) 1942 2165 (fontified t) 2165 2169 (face font-lock-keyword-face fontified t) 2169 2310 (fontified t) 2310 2317 (face font-lock-builtin-face fontified t) 2317 2323 (fontified t) 2323 2332 (face font-lock-builtin-face fontified t) 2332 2358 (fontified t) 2358 2393 (fontified t) 2393 2394 (fontified t) 2394 2401 (fontified t) 2401 2407 (fontified t) 2407 2409 (face font-lock-comment-delimiter-face fontified t) 2409 2424 (face font-lock-comment-face fontified t) 2424 2425 (fontified t) 2425 2427 (face font-lock-comment-delimiter-face fontified t) 2427 2429 (face font-lock-comment-face fontified t) 2429 2452 (face font-lock-comment-face fontified t) 2452 2453 (fontified t) 2453 2455 (face font-lock-comment-delimiter-face fontified t) 2455 2459 (face font-lock-comment-face fontified t) 2459 2463 (fontified t) 2463 2465 (face font-lock-comment-delimiter-face fontified t) 2465 2467 (face font-lock-comment-face fontified t) 2467 2470 (fontified t) 2470 2471 (fontified t rear-nonsticky t)) . 10193) (undo-tree-id205 . -2471) (undo-tree-id206 . -1588) (undo-tree-id207 . -2471) (undo-tree-id208 . -39) (undo-tree-id209 . -2393) (undo-tree-id210 . -1604) (undo-tree-id211 . -2471) (undo-tree-id212 . -965) (undo-tree-id213 . -2471) (undo-tree-id214 . -213) (undo-tree-id215 . -971) (undo-tree-id216 . -2471) (undo-tree-id217 . -1268) (undo-tree-id218 . -1255) (undo-tree-id219 . -1224) (undo-tree-id220 . -1164) (undo-tree-id221 . -1117) (undo-tree-id222 . -1072) (undo-tree-id223 . -1052) (undo-tree-id224 . -1047) (undo-tree-id225 . -1007) (undo-tree-id226 . -967) (undo-tree-id227 . -966) (undo-tree-id228 . -926) (undo-tree-id229 . -840) (undo-tree-id230 . -805) (undo-tree-id231 . -795) (undo-tree-id232 . -744) (undo-tree-id233 . -688) (undo-tree-id234 . -628) (undo-tree-id235 . -581) (undo-tree-id236 . -450) (undo-tree-id237 . -401) (undo-tree-id238 . -250) (undo-tree-id239 . -211) (undo-tree-id240 . -141) (undo-tree-id241 . -70) (undo-tree-id242 . -39) (undo-tree-id243 . -38) (undo-tree-id244 . -1) (undo-tree-id245 . -2471)) nil (26977 23450 658773 0) 0 nil])
([nil nil ((17672 . 17676) (#("			 " 0 4 (fontified nil)) . 17671) (undo-tree-id247 . -4) (undo-tree-id248 . -4) (undo-tree-id249 . -4) (undo-tree-id250 . -4) (undo-tree-id251 . -4) (undo-tree-id252 . -4) (undo-tree-id253 . -4) (undo-tree-id254 . -4) (undo-tree-id255 . -4) (17670 . 17676) (t 26977 23450 0 0)) nil (26977 23895 367101 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 18330 . 18331) (nil fontified nil 17676 . 18331) (17676 . 18331)) nil (26977 23895 367087 0) 0 nil])
([nil nil ((18331 . 18336)) nil (26977 23895 367083 0) 0 nil])
([nil nil ((#("

			 ;; --- AJOUT DE SÉCURITÉ ---
                         ;; On vérifie si la transaction est toujours valide côté DB
                         ;; Si ABORTED, c'est qu'une erreur a été \"avalée\" quelque part.
                         (let ((tx-state (cdar (%raw-exec \"SELECT txid_current_if_assigned() IS NOT NULL AS in_tx\")))) 
                           ;; Note: Ceci est une vérification simplifiée. 
                           ;; Idéalement, on vérifie si on est 'ABORTED' via pq-transaction-status si accessible.
                           ;; Sinon, on force le commit et on prie pour que le driver lève une erreur si rollback.
                           )" 0 1 (fontified t) 1 2 (fontified t) 2 6 (fontified t) 6 9 (face font-lock-comment-delimiter-face fontified t) 9 35 (face font-lock-comment-face fontified t) 35 60 (fontified t) 60 63 (face font-lock-comment-delimiter-face fontified t) 63 120 (face font-lock-comment-face fontified t) 120 145 (fontified t) 145 148 (face font-lock-comment-delimiter-face fontified t) 148 209 (face font-lock-comment-face fontified t) 209 235 (fontified t) 235 238 (face font-lock-keyword-face fontified t) 238 267 (fontified t) 267 323 (face font-lock-string-face fontified t) 323 356 (fontified t) 356 359 (face font-lock-comment-delimiter-face fontified t) 359 404 (face font-lock-comment-face fontified t) 404 431 (fontified t) 431 434 (face font-lock-comment-delimiter-face fontified t) 434 518 (face font-lock-comment-face fontified t) 518 545 (fontified t) 545 548 (face font-lock-comment-delimiter-face fontified t) 548 633 (face font-lock-comment-face fontified t) 633 660 (fontified t) 660 661 (rear-nonsticky t fontified t)) . 17670) (undo-tree-id259 . -661) (t 26977 23895 0 0)) nil (26977 64910 661396 0) 0 nil])
([nil nil ((19059 . 19060)) nil (26977 64910 661394 0) 0 nil])
([nil nil ((nil fontified nil 20781 . 20782) (nil fontified nil 20767 . 20781) (nil fontified nil 20755 . 20767) (nil fontified nil 20748 . 20755) (nil fontified nil 20742 . 20748) (nil fontified nil 20701 . 20742) (nil fontified nil 20684 . 20701) (nil fontified nil 20681 . 20684) (nil fontified nil 20609 . 20681) (nil fontified nil 20590 . 20609) (nil fontified nil 20578 . 20590) (nil fontified nil 20565 . 20578) (nil fontified nil 20554 . 20565) (nil fontified nil 20550 . 20554) (nil fontified nil 20530 . 20550) (nil fontified nil 20509 . 20530) (nil fontified nil 20430 . 20509) (nil fontified nil 20413 . 20430) (nil fontified nil 20410 . 20413) (nil fontified nil 20373 . 20410) (nil fontified nil 20372 . 20373) (nil fontified nil 20371 . 20372) (nil fontified nil 20370 . 20371) (nil fontified nil 20369 . 20370) (nil fontified nil 20368 . 20369) (nil fontified nil 20360 . 20368) (nil fontified nil 20346 . 20360) (nil fontified nil 20345 . 20346) (nil fontified nil 20338 . 20345) (nil fontified nil 20332 . 20338) (nil fontified nil 20312 . 20332) (nil fontified nil 20300 . 20312) (nil fontified nil 20297 . 20300) (nil fontified nil 20252 . 20297) (nil fontified nil 20249 . 20252) (nil fontified nil 20230 . 20249) (nil fontified nil 20210 . 20230) (nil fontified nil 20201 . 20210) (nil fontified nil 20186 . 20201) (nil fontified nil 20120 . 20186) (nil fontified nil 20117 . 20120) (nil fontified nil 20098 . 20117) (nil fontified nil 20094 . 20098) (nil fontified nil 20020 . 20094) (nil fontified nil 20001 . 20020) (nil fontified nil 19986 . 20001) (nil fontified nil 19942 . 19986) (nil fontified nil 19939 . 19942) (nil fontified nil 19925 . 19939) (nil fontified nil 19921 . 19925) (nil fontified nil 19910 . 19921) (nil fontified nil 19862 . 19910) (nil fontified nil 19856 . 19862) (nil fontified nil 19828 . 19856) (nil fontified nil 19798 . 19828) (nil fontified nil 19730 . 19798) (nil fontified nil 19726 . 19730) (nil fontified nil 19713 . 19726) (nil fontified nil 19705 . 19713) (nil fontified nil 19700 . 19705) (nil fontified nil 19690 . 19700) (nil fontified nil 19684 . 19690) (nil fontified nil 19678 . 19684) (nil fontified nil 19665 . 19678) (nil fontified nil 19663 . 19665) (nil fontified nil 19660 . 19663) (nil fontified nil 19644 . 19660) (nil fontified nil 19641 . 19644) (nil fontified nil 19639 . 19641) (nil fontified nil 19621 . 19639) (nil fontified nil 19615 . 19621) (nil fontified nil 19611 . 19615) (nil fontified nil 19605 . 19611) (nil fontified nil 19578 . 19605) (nil fontified nil 19575 . 19578) (nil fontified nil 19565 . 19575) (nil fontified nil 19553 . 19565) (nil fontified nil 19540 . 19553) (nil fontified nil 19527 . 19540) (nil fontified nil 19513 . 19527) (nil fontified nil 19508 . 19513) (nil fontified nil 19480 . 19508) (nil fontified nil 19477 . 19480) (nil fontified nil 19446 . 19477) (nil fontified nil 19444 . 19446) (nil fontified nil 19436 . 19444) (nil fontified nil 19419 . 19436) (nil fontified nil 19400 . 19419) (nil fontified nil 19399 . 19400) (nil fontified nil 19395 . 19399) (nil fontified nil 19394 . 19395) (nil fontified nil 19370 . 19394) (nil fontified nil 19367 . 19370) (nil fontified nil 19343 . 19367) (nil fontified nil 19341 . 19343) (nil fontified nil 19334 . 19341) (nil fontified nil 19299 . 19334) (nil fontified nil 19294 . 19299) (nil fontified nil 19271 . 19294) (nil fontified nil 19259 . 19271) (nil fontified nil 19207 . 19259) (nil fontified nil 19196 . 19207) (nil fontified nil 19191 . 19196) (nil fontified nil 19186 . 19191) (nil fontified nil 19166 . 19186) (nil fontified nil 19163 . 19166) (nil fontified nil 19155 . 19163) (nil fontified nil 19151 . 19155) (nil fontified nil 19131 . 19151) (nil fontified nil 19128 . 19131) (nil fontified nil 19125 . 19128) (nil fontified nil 19097 . 19125) (nil fontified nil 19093 . 19097) (nil fontified nil 19085 . 19093) (nil fontified nil 19075 . 19085) (nil fontified nil 19073 . 19075) (nil fontified nil 19067 . 19073) (nil fontified nil 19066 . 19067) (nil fontified nil 19061 . 19066) (nil fontified nil 19060 . 19061) (19060 . 20782)) nil (26977 64910 661391 0) 0 nil])
([nil nil ((17335 . 17336)) nil (26977 64910 661382 0) 0 nil])
([nil nil ((17336 . 17338)) nil (26977 64910 661381 0) 0 nil])
([nil nil ((#("[" 0 1 (fontified t)) . -17337) (undo-tree-id256 . -1) (undo-tree-id257 . -1) (undo-tree-id258 . -1) 17338) nil (26977 64910 661380 0) 0 nil])
([nil nil ((17337 . 17338)) nil (26977 64910 661368 0) 0 nil])
([nil nil ((19062 . 19064)) nil (26977 64910 661367 0) 0 nil])
([nil nil ((19064 . 19065)) nil (26977 64910 661367 0) 0 nil])
([nil nil ((19523 . 19531)) nil (26977 64910 661366 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19571 . 19572) (nil fontified nil 19531 . 19572) (19531 . 19572)) nil (26977 64910 661365 0) 0 nil])
([nil nil ((20837 . 20838) 19572) nil (26977 64910 661361 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 10218 . 10219) (nil fontified nil 10154 . 10219) (10154 . 10219) (t 26977 64910 0 0)) nil (26977 64951 330931 0) 0 nil])
([nil nil ((10145 . 10147)) nil (26977 64951 330926 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -3515) (undo-tree-id283 . -1) 3516 (t 26977 64951 0 0)) nil (26978 2219 970597 0) 0 nil])
([nil nil ((20904 . 20905)) nil (26978 2219 970595 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23049 . 23050) (nil fontified nil 20905 . 23050) (20905 . 23050)) nil (26978 2219 970595 0) 0 nil])
([nil nil ((#("
(defun run-in-transaction (thunk &key (retries 0) (sleep-ms 50))
  (let ((attempt 0))
    (loop
      (let ((outcome
             (block safe-zone
               (ensure-connection
                 (handler-case
                     (progn
                       (%raw-exec \"BEGIN\")
                       (let ((res (funcall thunk)))
			 
                         (%raw-exec \"COMMIT\")
                         (cons :ok res)))
                   (error (c)
		     (format t \"~&[TX ERROR/ROLLBACK] ~A~%\" c)
                     (ignore-errors (%raw-exec \"ROLLBACK\"))
                     (cons :error c)))))))
        
        (if (eq (car outcome) :ok)
            (return (cdr outcome))
            
            (let* ((err (cdr outcome))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              ;; On extrait proprement le message et le code
              (multiple-value-bind (msg code) (extract-error-details err)
                
                (cond
                  ;; Cas A : Erreur Métier (ApplicationError OU QALM error non mappée)
                  ((or is-app (not mapped))
                   ;; On retourne le tuple spécial (:business-error message code)
                   (return (list :business-error msg code)))
                  
                  ;; Cas B : Retry DB
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                   (incf attempt))
                  
                  ;; Cas C : Fatal DB
                  (t
                   (return (list :fatal-error msg)))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 15 (face font-lock-function-name-face fontified t) 15 16 (face font-lock-function-name-face fontified t) 16 19 (face font-lock-function-name-face fontified t) 19 26 (face font-lock-function-name-face fontified t) 26 34 (fontified t) 34 38 (face font-lock-type-face fontified t) 38 66 (fontified t) 66 69 (fontified t) 69 72 (face font-lock-keyword-face fontified t) 72 92 (fontified t) 92 96 (face font-lock-keyword-face fontified t) 96 104 (fontified t) 104 107 (face font-lock-keyword-face fontified t) 107 127 (fontified t) 127 132 (fontified t) 132 137 (face font-lock-keyword-face fontified t) 137 148 (fontified t) 148 200 (fontified t) 200 212 (face font-lock-keyword-face fontified t) 212 235 (fontified t) 235 240 (face font-lock-keyword-face fontified t) 240 275 (fontified t) 275 282 (face font-lock-string-face fontified t) 282 284 (fontified t) 284 308 (fontified t) 308 311 (face font-lock-keyword-face fontified t) 311 335 (fontified t) 335 336 (fontified t) 336 340 (fontified t) 340 341 (fontified t) 341 360 (fontified t) 360 377 (fontified t) 377 385 (face font-lock-string-face fontified t) 385 387 (fontified t) 387 418 (fontified t) 418 421 (face font-lock-builtin-face fontified t) 421 429 (fontified t) 429 449 (fontified t) 449 454 (face font-lock-warning-face fontified t) 454 459 (fontified t) 459 466 (fontified t) 466 476 (fontified t) 476 504 (face font-lock-string-face fontified t) 504 506 (fontified t) 506 507 (fontified t rear-nonsticky t) 507 508 (fontified t) 508 517 (fontified t) 517 530 (fontified t) 530 543 (face font-lock-keyword-face fontified t) 543 555 (fontified t) 555 565 (face font-lock-string-face fontified t) 565 568 (fontified t) 568 595 (fontified t) 595 601 (face font-lock-builtin-face fontified t) 601 605 (fontified t) 605 611 (fontified t) 611 629 (fontified t) 629 631 (face font-lock-keyword-face fontified t) 631 634 (fontified t) 634 650 (fontified t) 650 653 (face font-lock-builtin-face fontified t) 653 655 (fontified t) 655 668 (fontified t) 668 674 (face font-lock-keyword-face fontified t) 674 680 (fontified t) 680 690 (fontified t) 690 695 (fontified t) 695 703 (fontified t) 703 716 (fontified t) 716 720 (face font-lock-keyword-face fontified t) 720 788 (fontified t) 788 818 (fontified t) 818 846 (fontified t) 846 852 (face font-lock-keyword-face fontified t) 852 900 (fontified t) 900 911 (fontified t) 911 915 (fontified t) 915 929 (fontified t) 929 932 (face font-lock-comment-delimiter-face fontified t) 932 976 (face font-lock-comment-face fontified t) 976 991 (fontified t) 991 1010 (face font-lock-keyword-face fontified t) 1010 1084 (fontified t) 1084 1088 (face font-lock-keyword-face fontified t) 1088 1107 (fontified t) 1107 1110 (face font-lock-comment-delimiter-face fontified t) 1110 1176 (face font-lock-comment-face fontified t) 1176 1191 (fontified t) 1191 1200 (fontified t) 1200 1220 (fontified t) 1220 1239 (fontified t) 1239 1242 (face font-lock-comment-delimiter-face fontified t) 1242 1287 (face font-lock-comment-face fontified t) 1287 1290 (face font-lock-comment-face fontified t) 1290 1302 (face font-lock-comment-face fontified t) 1302 1322 (fontified t) 1322 1328 (face font-lock-keyword-face fontified t) 1328 1335 (fontified t) 1335 1336 (face font-lock-builtin-face fontified t) 1336 1350 (face font-lock-builtin-face fontified t) 1350 1358 (fontified t) 1358 1359 (fontified t) 1359 1360 (fontified t) 1360 1361 (fontified t) 1361 1362 (fontified t) 1362 1363 (fontified t) 1363 1400 (fontified t) 1400 1403 (face font-lock-comment-delimiter-face fontified t) 1403 1420 (face font-lock-comment-face fontified t) 1420 1429 (fontified t) 1429 1499 (fontified t) 1499 1515 (fontified t) 1515 1519 (fontified t) 1519 1520 (fontified t) 1520 1540 (fontified t) 1540 1544 (face font-lock-keyword-face fontified t) 1544 1548 (fontified t) 1548 1550 (fontified t) 1550 1555 (fontified t) 1555 1568 (fontified t) 1568 1580 (fontified t) 1580 1599 (fontified t) 1599 1671 (fontified t) 1671 1674 (face font-lock-comment-delimiter-face fontified t) 1674 1691 (face font-lock-comment-face fontified t) 1691 1712 (fontified t) 1712 1732 (fontified t) 1732 1738 (face font-lock-keyword-face fontified t) 1738 1745 (fontified t) 1745 1757 (face font-lock-builtin-face fontified t) 1757 1771 (fontified t) 1771 1772 (fontified t rear-nonsticky t)) . 19131) (undo-tree-id262 . -1772) (undo-tree-id263 . -655) (undo-tree-id264 . -1) (undo-tree-id265 . -1772) (undo-tree-id266 . -1772) (undo-tree-id267 . -1772) (undo-tree-id268 . -690) (undo-tree-id269 . -655) (undo-tree-id270 . -620) (undo-tree-id271 . -611) (undo-tree-id272 . -568) (undo-tree-id273 . -508) (undo-tree-id274 . -459) (undo-tree-id275 . -387) (undo-tree-id276 . -336) (undo-tree-id277 . -241) (undo-tree-id278 . -182) (undo-tree-id279 . -118) (undo-tree-id280 . -87) (undo-tree-id281 . -1) (undo-tree-id282 . -1772)) nil (26978 2219 970593 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 19131) (undo-tree-id260 . -1) (undo-tree-id261 . -1)) nil (26978 2219 970579 0) 0 nil])
([nil nil ((21277 . 21278) 20399) nil (26978 2219 970564 0) 0 nil])
([nil nil ((21277 . 21279) (t 26978 2219 0 0)) nil (26978 2935 616517 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23226 . 23227) (nil fontified nil 21279 . 23227) (21279 . 23227)) nil (26978 2935 616517 0) 0 nil])
([nil nil ((22262 . 22263)) nil (26978 2935 616516 0) 0 nil])
([nil nil ((#("]" 0 1 (face font-lock-string-face fontified nil)) . 22264) (22263 . 22264) (#("/" 0 1 (face font-lock-string-face fontified nil)) . 22262) (22263 . 22264)) nil (26978 2935 616515 0) 0 nil])
([nil nil ((#("/" 0 1 (face font-lock-string-face fontified t)) . -22263) (undo-tree-id305 . -1) 22264) nil (26978 2935 616514 0) 0 nil])
([nil nil ((22262 . 22263)) nil (26978 2935 616512 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 22270 . 22271) (nil fontified nil 22263 . 22271) (22263 . 22271)) nil (26978 2935 616511 0) 0 nil])
([nil nil ((#("
(defun run-in-transaction (thunk &key (retries 0) (sleep-ms 50))
  (let ((attempt 0))
    (loop
      (let ((outcome
             (block safe-zone
               ;; ensure-connection appelle call-with-conn.
               ;; Donc, à l'intérieur d'ici, postmodern:*database* EST VALIDE.
               (ensure-connection
                 (handler-case
                     (progn
                       ;; 1. VRAI DÉBUT (Informe l'objet Postmodern)
                       (postmodern:begin-transaction)
                       
                       (let ((res (funcall thunk)))
                         
                         ;; 2. VRAI COMMIT (Informe l'objet Postmodern)
                         (postmodern:commit-transaction)
                         
                         (cons :ok res)))
                   
                   ;; GESTION D'ERREUR
                   (error (c)
                     (format t \"~&[TX ERROR/ROLLBACK] ~A~%\" c)
                     
                     ;; 3. VRAI ROLLBACK (Informe l'objet Postmodern)
                     ;; On ignore les erreurs si la connexion est déjà morte
                     (ignore-errors (postmodern:rollback-transaction))
                     
                     (cons :error c)))))))
        
        ;; Logique de retry inchangée (parfaite)
        (if (eq (car outcome) :ok)
            (return (cdr outcome))
            
            (let* ((err (cdr outcome))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (multiple-value-bind (msg code) (extract-error-details err)
                (cond
                  ((or is-app (not mapped))
                   (return (list :business-error msg code)))
                  
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                   (incf attempt))
                  
                  (t
                   (return (list :fatal-error msg)))))))))))" 0 1 (fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 26 (face font-lock-function-name-face fontified t) 26 34 (fontified t) 34 38 (face font-lock-type-face fontified t) 38 69 (fontified t) 69 72 (face font-lock-keyword-face fontified t) 72 92 (fontified t) 92 96 (face font-lock-keyword-face fontified t) 96 104 (fontified t) 104 107 (face font-lock-keyword-face fontified t) 107 132 (fontified t) 132 137 (face font-lock-keyword-face fontified t) 137 163 (fontified t) 163 166 (face font-lock-comment-delimiter-face fontified t) 166 208 (face font-lock-comment-face fontified t) 208 223 (fontified t) 223 226 (face font-lock-comment-delimiter-face fontified t) 226 287 (face font-lock-comment-face fontified t) 287 339 (fontified t) 339 351 (face font-lock-keyword-face fontified t) 351 374 (fontified t) 374 379 (face font-lock-keyword-face fontified t) 379 403 (fontified t) 403 406 (face font-lock-comment-delimiter-face fontified t) 406 449 (face font-lock-comment-face fontified t) 449 551 (fontified t) 551 554 (face font-lock-keyword-face fontified t) 554 630 (fontified t) 630 633 (face font-lock-comment-delimiter-face fontified t) 633 677 (face font-lock-comment-face fontified t) 677 791 (fontified t) 791 794 (face font-lock-builtin-face fontified t) 794 841 (fontified t) 841 844 (face font-lock-comment-delimiter-face fontified t) 844 861 (face font-lock-comment-face fontified t) 861 881 (fontified t) 881 886 (face font-lock-warning-face fontified t) 886 922 (fontified t) 922 950 (face font-lock-string-face fontified t) 950 997 (fontified t) 997 1000 (face font-lock-comment-delimiter-face fontified t) 1000 1046 (face font-lock-comment-face fontified t) 1046 1067 (fontified t) 1067 1070 (face font-lock-comment-delimiter-face fontified t) 1070 1123 (face font-lock-comment-face fontified t) 1123 1145 (fontified t) 1145 1158 (face font-lock-keyword-face fontified t) 1158 1243 (fontified t) 1243 1249 (face font-lock-builtin-face fontified t) 1249 1276 (fontified t) 1276 1279 (face font-lock-comment-delimiter-face fontified t) 1279 1317 (face font-lock-comment-face fontified t) 1317 1326 (fontified t) 1326 1328 (face font-lock-keyword-face fontified t) 1328 1347 (fontified t) 1347 1350 (face font-lock-builtin-face fontified t) 1350 1365 (fontified t) 1365 1371 (face font-lock-keyword-face fontified t) 1371 1413 (fontified t) 1413 1417 (face font-lock-keyword-face fontified t) 1417 1500 (fontified t) 1500 1501 (fontified t) 1501 1515 (fontified t) 1515 1543 (fontified t) 1543 1549 (face font-lock-keyword-face fontified t) 1549 1627 (fontified t) 1627 1646 (face font-lock-keyword-face fontified t) 1646 1703 (fontified t) 1703 1707 (face font-lock-keyword-face fontified t) 1707 1772 (fontified t) 1772 1778 (face font-lock-keyword-face fontified t) 1778 1785 (fontified t) 1785 1800 (face font-lock-builtin-face fontified t) 1800 1952 (fontified t) 1952 1956 (face font-lock-keyword-face fontified t) 1956 2086 (fontified t) 2086 2106 (fontified t) 2106 2112 (face font-lock-keyword-face fontified t) 2112 2119 (fontified t) 2119 2131 (face font-lock-builtin-face fontified t) 2131 2145 (fontified t) 2145 2146 (fontified t rear-nonsticky t)) . 19131) (undo-tree-id284 . -2146) (undo-tree-id285 . -1) (undo-tree-id286 . -935) (undo-tree-id287 . -2146) (undo-tree-id288 . -605) (undo-tree-id289 . -579) (undo-tree-id290 . -527) (undo-tree-id291 . -503) (undo-tree-id292 . -449) (undo-tree-id293 . -380) (undo-tree-id294 . -352) (undo-tree-id295 . -321) (undo-tree-id296 . -287) (undo-tree-id297 . -208) (undo-tree-id298 . -148) (undo-tree-id299 . -118) (undo-tree-id300 . -97) (undo-tree-id301 . -87) (undo-tree-id302 . -66) (undo-tree-id303 . -1) (undo-tree-id304 . -2146)) nil (26978 2935 616509 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 19131)) nil (26978 2935 616474 0) 0 nil])
([nil nil ((19602 . 19607) (t 26978 2935 0 0)) nil (26978 3092 931959 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19647 . 19648) (nil fontified nil 19645 . 19648) (nil fontified nil 19639 . 19645) (nil fontified nil 19638 . 19639) (nil fontified nil 19637 . 19638) (nil fontified nil 19630 . 19637) (nil fontified nil 19617 . 19630) (nil fontified nil 19607 . 19617) (19607 . 19648)) nil (26978 3092 931958 0) 0 nil])
([nil nil ((19624 . 19629)) nil (26978 3092 931957 0) 0 nil])
([nil nil ((19629 . 19630)) nil (26978 3092 931956 0) 0 nil])
([nil nil ((#("ERROR" 0 5 (face font-lock-string-face fontified t)) . 19630)) nil (26978 3092 931956 0) 0 nil])
([nil nil ((#("/ROLLBACK" 0 1 (face font-lock-string-face fontified t) 1 8 (face font-lock-string-face fontified t) 8 9 (face font-lock-string-face fontified t rear-nonsticky t)) . 19630) (undo-tree-id318 . -9)) nil (26978 3092 931955 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -19629) (undo-tree-id317 . -1) 19630) nil (26978 3092 931954 0) 0 nil])
([nil nil ((#("c" 0 1 (fontified t)) . -19637) (undo-tree-id306 . -1) (undo-tree-id307 . -1) (undo-tree-id308 . -1) (undo-tree-id309 . -1) (undo-tree-id310 . -1) (undo-tree-id311 . -1) (undo-tree-id312 . -1) (undo-tree-id313 . -1) (undo-tree-id314 . -1) (undo-tree-id315 . -1) (undo-tree-id316 . -1) 19638) nil (26978 3092 931951 0) 0 nil])
([nil nil ((19637 . 19640)) nil (26978 3092 931931 0) 0 nil])
([nil nil ((19550 . 19559) (#(" " 0 1 (fontified nil)) . 19549) (undo-tree-id321 . -1) (19550 . 19551) (t 26978 3092 0 0)) nil (26978 3229 325259 0) 0 nil])
([nil nil ((nil fontified nil 19592 . 19593) (nil fontified nil 19588 . 19592) (nil fontified nil 19582 . 19588) (nil fontified nil 19581 . 19582) (nil fontified nil 19569 . 19581) (nil fontified nil 19559 . 19569) (19559 . 19593)) nil (26978 3229 325258 0) 0 nil])
([nil nil ((19581 . 19582)) nil (26978 3229 325257 0) 0 nil])
([nil nil ((19582 . 19583)) nil (26978 3229 325256 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -19582) (undo-tree-id320 . -1) 19583) nil (26978 3229 325255 0) 0 nil])
([nil nil ((19582 . 19587)) nil (26978 3229 325253 0) 0 nil])
([nil nil ((#("res" 0 3 (fontified t)) . -19595) (undo-tree-id319 . -3) 19598) nil (26978 3229 325251 0) 0 nil])
([nil nil ((19595 . 19600)) nil (26978 3229 325238 0) 0 nil])
([nil nil ((19549 . 19559) (t 26978 3229 0 0)) nil (26978 3587 632575 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19720 . 19721) (nil fontified nil 19559 . 19721) (19559 . 19721)) nil (26978 3587 632571 0) 0 nil])
([nil nil ((19627 . 19628) (t 26978 3587 0 0)) nil (26978 3629 811489 0) 0 nil])
([nil nil ((19661 . 19662) (t 26978 3629 0 0)) nil (26978 3662 900662 0) 0 nil])
([nil nil ((19692 . 19693)) nil (26978 4583 52163 0) 0 nil])
([nil nil ((20043 . 20048) (t 26978 3662 0 0)) nil (26978 4637 834828 0) 0 nil] [nil nil ((20028 . 20032) (#("			 " 0 4 (fontified nil)) . 20027) (undo-tree-id322 . -4) (undo-tree-id323 . -4) (undo-tree-id324 . -4) (undo-tree-id325 . -4) (undo-tree-id326 . -4) (20027 . 20032) (#(" " 0 1 (face font-lock-comment-face fontified nil)) . 20027) (20026 . 20027) (t 26978 3662 0 0)) ((#("
" 0 1 (face font-lock-comment-face fontified t)) . 20026) (undo-tree-id329 . -1) (undo-tree-id330 . -1) (undo-tree-id331 . -1) (undo-tree-id332 . -1) (undo-tree-id333 . -1) (undo-tree-id334 . -1) (undo-tree-id335 . -1) (undo-tree-id336 . -1) (undo-tree-id337 . -1) (undo-tree-id338 . -1) (undo-tree-id339 . -1) (undo-tree-id340 . -1) (undo-tree-id341 . -1) (20027 . 20028) (#("			 
" 0 4 (fontified nil) 4 5 (fontified nil)) . 20027) (undo-tree-id342 . -5) (undo-tree-id343 . -5) (undo-tree-id344 . -4) (undo-tree-id345 . -4) (undo-tree-id346 . -4) (undo-tree-id347 . -4) (undo-tree-id348 . -5) (undo-tree-id349 . -5) (undo-tree-id350 . -5) (undo-tree-id351 . -5) (undo-tree-id352 . -5) (undo-tree-id353 . -5) (undo-tree-id354 . -5) (20027 . 20031) (#("			 " 0 4 (fontified t)) . 20028) (undo-tree-id355 . -4) (undo-tree-id356 . -4) (undo-tree-id357 . -4) (undo-tree-id358 . -4) (undo-tree-id359 . -4) (undo-tree-id360 . -4) (undo-tree-id361 . -4)) (26978 4581 350600 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20943 . 20944) (nil fontified nil 20048 . 20944) (20048 . 20944)) nil (26978 4637 834827 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20927 . 20928) (nil fontified nil 20032 . 20928) (20032 . 20928)) ((#(";; --- PATCH CRITIQUE ---
                         ;; Si on est dans une sous-transaction (Level > 0),
                         ;; le with-transaction va seulement faire \"RELEASE SAVEPOINT\".
                         ;; Nous, on veut que les données soient écrites sur le disque MAINTENANT.
                         (when (> postmodern:*transaction-level* 0)
                           (format t \"~&[TX WARNING] Transaction imbriquée détectée (Lvl ~A). Force COMMIT.~%\" 
                                   postmodern:*transaction-level*)
                           ;; 1. On force l'écriture disque
                           (postmodern:execute \"COMMIT\")
                           ;; 2. On rouvre immédiatement une transaction pour ne pas casser 
                           ;; la logique du parent qui s'attend à être dans une transaction.
                           (postmodern:execute \"BEGIN\"))" 0 3 (face font-lock-comment-delimiter-face fontified nil) 3 26 (face font-lock-comment-face fontified nil) 26 51 (fontified nil) 51 54 (face font-lock-comment-delimiter-face fontified nil) 54 103 (face font-lock-comment-face fontified nil) 103 128 (fontified nil) 128 131 (face font-lock-comment-delimiter-face fontified nil) 131 191 (face font-lock-comment-face fontified nil) 191 216 (fontified nil) 216 219 (face font-lock-comment-delimiter-face fontified nil) 219 290 (face font-lock-comment-face fontified nil) 290 316 (fontified nil) 316 320 (face font-lock-keyword-face fontified nil) 320 395 (fontified nil) 395 468 (face font-lock-string-face fontified nil) 468 564 (fontified nil) 564 567 (face font-lock-comment-delimiter-face fontified nil) 567 597 (face font-lock-comment-face fontified nil) 597 644 (fontified nil) 644 652 (face font-lock-string-face fontified nil) 652 681 (fontified nil) 681 684 (face font-lock-comment-delimiter-face fontified nil) 684 747 (face font-lock-comment-face fontified nil) 747 774 (fontified nil) 774 777 (face font-lock-comment-delimiter-face fontified nil) 777 840 (face font-lock-comment-face fontified nil) 840 887 (fontified nil) 887 894 (face font-lock-string-face fontified nil) 894 895 (fontified nil) 895 896 (rear-nonsticky nil fontified nil)) . 20032) (undo-tree-id327 . -896) (undo-tree-id328 . -840) (nil fontified t 20809 . 20872) (nil fontified t 20806 . 20809) (nil fontified t 20779 . 20806) (nil fontified t 20716 . 20779) (nil fontified t 20713 . 20716) (nil fontified t 20684 . 20713) (nil fontified t 20676 . 20684) (nil fontified t 20629 . 20676) (nil fontified t 20599 . 20629) (nil fontified t 20596 . 20599) (nil fontified t 20500 . 20596) (nil fontified t 20427 . 20500) (nil fontified t 20352 . 20427) (nil fontified t 20348 . 20352) (nil fontified t 20322 . 20348) (nil fontified t 20251 . 20322) (nil fontified t 20248 . 20251) (nil fontified t 20223 . 20248) (nil fontified t 20163 . 20223) (nil fontified t 20160 . 20163) (nil fontified t 20135 . 20160) (nil fontified t 20086 . 20135) (nil fontified t 20083 . 20086) (nil fontified t 20058 . 20083) (nil fontified t 20035 . 20058) (nil fontified t 20032 . 20035) (nil rear-nonsticky t 20927 . 20928)) (26978 4581 350507 0) 0 nil])
([nil nil ((20944 . 20949)) nil (26978 4637 834826 0) 0 nil])
nil
([nil nil ((19734 . 19736)) nil (26978 4637 834825 0) 0 nil])
([nil nil ((19835 . 19837)) nil (26978 4637 834824 0) 0 nil])
([nil nil ((20386 . 20387)) nil (26978 4637 834822 0) 0 nil])
([nil nil ((20568 . 20569)) nil (26978 4637 834818 0) 0 nil])
([nil nil ((19343 . 19351) (t 26978 4637 0 0)) nil (26978 5141 972231 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19681 . 19682) (nil fontified nil 19351 . 19682) (19351 . 19682)) nil (26978 5141 972230 0) 0 nil])
([nil nil ((#("
		       (format t \"~&[TX INFO] Level: ~A | Open: ~A~%\" 
          postmodern::*transaction-level* (postmodern::transaction-open-p postmodern::*current-logical-transaction*))
		       ;;(format t \"~&[TX DEBUG thunk] ~A~%\" thunk)" 0 1 (fontified t) 1 10 (fontified t) 10 20 (fontified t) 20 56 (face font-lock-string-face fontified t) 56 58 (fontified t) 58 174 (fontified t) 174 175 (fontified t rear-nonsticky t) 175 176 (fontified t) 176 185 (fontified t) 185 187 (face font-lock-comment-delimiter-face fontified t) 187 197 (face font-lock-comment-face fontified t) 197 215 (face font-lock-comment-face fontified t) 215 216 (face font-lock-comment-face fontified t) 216 222 (face font-lock-comment-face fontified t) 222 228 (face font-lock-comment-face fontified t) 228 229 (face font-lock-comment-face fontified t rear-nonsticky t)) . 19888) (undo-tree-id373 . -229) (undo-tree-id374 . -144)) nil (26978 5141 972229 0) 0 nil])
([nil nil ((19280 . 19282) (19262 . 19263) (19278 . 19279)) nil (26978 5141 972227 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19632 . 19633) (nil fontified nil 19282 . 19633) (19282 . 19633)) nil (26978 5141 972226 0) 0 nil])
([nil nil ((#("
			 ;;(format t \"~&[TX DEBUG] ~A~%\" res)
                         ;; Si on arrive ici, le code s'est bien passé.
                         ;; En sortant de ce bloc, with-transaction va faire le COMMIT automatiquement.
			 ;; --- PATCH CRITIQUE ---
                         ;; Si on est dans une sous-transaction (Level > 0),
                         ;; le with-transaction va seulement faire \"RELEASE SAVEPOINT\".
                         ;; Nous, on veut que les données soient écrites sur le disque MAINTENANT.
                         (when (> postmodern::*transaction-level* 0)
                           (format t \"~&[TX WARNING] Transaction imbriquée détectée (Lvl ~A). Force COMMIT.~%\" 
                                   postmodern::*transaction-level*)
                           ;; 1. On force l'écriture disque
                           (postmodern:execute \"COMMIT\")
                           ;; 2. On rouvre immédiatement une transaction pour ne pas casser 
                           ;; la logique du parent qui s'attend à être dans une transaction.
                           (postmodern:execute \"BEGIN\"))" 0 1 (fontified t) 1 5 (fontified t) 5 7 (face font-lock-comment-delimiter-face fontified t) 7 17 (face font-lock-comment-face fontified t) 17 29 (face font-lock-comment-face fontified t) 29 30 (face font-lock-comment-face fontified t) 30 36 (face font-lock-comment-face fontified t) 36 40 (face font-lock-comment-face fontified t) 40 41 (face font-lock-comment-face fontified t rear-nonsticky t) 41 42 (face font-lock-comment-face fontified t) 42 67 (fontified t) 67 70 (face font-lock-comment-delimiter-face fontified t) 70 114 (face font-lock-comment-face fontified t) 114 139 (fontified t) 139 142 (face font-lock-comment-delimiter-face fontified t) 142 200 (face font-lock-comment-face fontified t) 200 201 (face font-lock-comment-face fontified t) 201 218 (face font-lock-comment-face fontified t) 218 222 (fontified t) 222 225 (face font-lock-comment-delimiter-face fontified t) 225 248 (face font-lock-comment-face fontified t) 248 273 (fontified t) 273 276 (face font-lock-comment-delimiter-face fontified t) 276 325 (face font-lock-comment-face fontified t) 325 350 (fontified t) 350 353 (face font-lock-comment-delimiter-face fontified t) 353 413 (face font-lock-comment-face fontified t) 413 438 (fontified t) 438 441 (face font-lock-comment-delimiter-face fontified t) 441 512 (face font-lock-comment-face fontified t) 512 538 (fontified t) 538 542 (face font-lock-keyword-face fontified t) 542 581 (fontified t) 581 618 (fontified t) 618 691 (face font-lock-string-face fontified t) 691 693 (fontified t) 693 761 (fontified t) 761 788 (fontified t) 788 791 (face font-lock-comment-delimiter-face fontified t) 791 821 (face font-lock-comment-face fontified t) 821 839 (fontified t) 839 868 (fontified t) 868 876 (face font-lock-string-face fontified t) 876 878 (fontified t) 878 905 (fontified t) 905 908 (face font-lock-comment-delimiter-face fontified t) 908 971 (face font-lock-comment-face fontified t) 971 998 (fontified t) 998 1001 (face font-lock-comment-delimiter-face fontified t) 1001 1014 (face font-lock-comment-face fontified t) 1014 1064 (face font-lock-comment-face fontified t) 1064 1111 (fontified t) 1111 1118 (face font-lock-string-face fontified t) 1118 1119 (fontified t) 1119 1120 (fontified t rear-nonsticky t)) . 20295) (undo-tree-id362 . -1120) (undo-tree-id363 . -5) (undo-tree-id364 . -200) (undo-tree-id365 . -299) (undo-tree-id366 . -299) (undo-tree-id367 . -299) (undo-tree-id368 . -222) (undo-tree-id369 . -1120) (undo-tree-id370 . -1120) (undo-tree-id371 . -1120) (undo-tree-id372 . -1120)) nil (26978 5141 972223 0) 0 nil])
([nil nil ((20699 . 20701)) nil (26978 5141 972203 0) 0 nil])
([nil nil ((#("postmodern" 0 10 (fontified t)) . -19562) (undo-tree-id405 . -10) 19572 (t 26978 5141 0 0)) nil (26978 5196 198805 0) 0 nil])
([nil nil ((19562 . 19567)) nil (26978 5196 198804 0) 0 nil])
([nil nil ((#("postmodern" 0 10 (fontified t)) . -19808) (undo-tree-id404 . -10) 19818) nil (26978 5196 198803 0) 0 nil])
([nil nil ((19808 . 19813)) nil (26978 5196 198801 0) 0 nil])
([nil nil ((#("postmodern" 0 10 (fontified t)) . -19995) (undo-tree-id403 . -10) 20005) nil (26978 5196 198801 0) 0 nil])
([nil nil ((19995 . 19999)) nil (26978 5196 198799 0) 0 nil])
([nil nil ((20457 . 20462) (#("                     " 0 21 (fontified t)) . 20457) (20410 . 20415) (#("                     " 0 21 (fontified t)) . 20410) (undo-tree-id401 . -21) (20377 . 20382) (#("                     " 0 21 (fontified t)) . 20377) (20305 . 20310) (#("                     " 0 21 (fontified t)) . 20305) (20257 . 20262) (#("                     " 0 21 (fontified t)) . 20257) (20241 . 20246) (#("                   " 0 19 (fontified t)) . 20241) (20199 . 20204) (20133 . 20140) (#("                       " 0 23 (fontified t)) . 20133) (20096 . 20101) (#("                     " 0 21 (fontified t)) . 20096) (20039 . 20044) (#("                     " 0 21 (fontified t)) . 20039) (19975 . 19980) (#("                     " 0 21 (fontified t)) . 19975) (19947 . 19948) (19815 . 19816) (19749 . 19750) (19682 . 19683) (19649 . 19650) (#("     " 0 5 (fontified t)) . 19649) (undo-tree-id402 . -5) (19630 . 19633) (19590 . 19594) (#("               " 0 15 (fontified t)) . 19590) (19476 . 19478) (#("               " 0 15 (fontified t)) . 19476) (19399 . 19401) (#("               " 0 15 (fontified t)) . 19399) (19344 . 19346) (#("               " 0 15 (fontified t)) . 19344) 19132) nil (26978 5196 198797 0) 0 nil])
([nil nil ((#("postmodern" 0 10 (face font-lock-keyword-face fontified t)) . -20102) (undo-tree-id387 . -10) (undo-tree-id388 . -7) (undo-tree-id389 . -7) (undo-tree-id390 . -7) (undo-tree-id391 . -7) (undo-tree-id392 . -7) (undo-tree-id393 . -10) (undo-tree-id394 . -10) (undo-tree-id395 . -10) (undo-tree-id396 . -10) (undo-tree-id397 . -10) (undo-tree-id398 . -10) (undo-tree-id399 . -10) (undo-tree-id400 . -10) 20112) nil (26978 5196 198790 0) 0 nil])
([nil nil ((20102 . 20106)) nil (26978 5196 198779 0) 0 nil])
([nil nil ((19516 . 19519) (#(" " 0 1 (fontified nil)) . 19515) (undo-tree-id376 . -1) (undo-tree-id377 . -1) (undo-tree-id378 . -1) (undo-tree-id379 . -1) (undo-tree-id380 . -1) (undo-tree-id381 . -1) (undo-tree-id382 . -1) (undo-tree-id383 . -1) (undo-tree-id384 . -1) (undo-tree-id385 . -1) (undo-tree-id386 . -1) (19516 . 19517)) nil (26978 5196 198778 0) 0 nil])
([nil nil ((19555 . 19562) (#(" " 0 1 (fontified nil)) . 19554) (undo-tree-id375 . -1) (19555 . 19556)) nil (26978 5196 198765 0) 0 nil])
([nil nil ((19963 . 19964) (t 26978 5196 0 0)) nil (26978 5208 467248 0) 0 nil])
([nil nil ((20225 . 20226) (t 26978 5208 0 0)) nil (26978 5378 599670 0) 0 nil])
([nil nil ((#("  " 0 2 (fontified t)) . -21325) (#("  " 0 2 (fontified t)) . -21305) (#("  " 0 2 (fontified t)) . -21254) (#("  " 0 2 (fontified t)) . -21177) (#("  " 0 2 (fontified t)) . -21078) (#("  " 0 2 (fontified t)) . -21001) (#("  " 0 2 (fontified t)) . -20958) (#("  " 0 2 (fontified t)) . -20936) (#("  " 0 2 (fontified t)) . -20862) (#("  " 0 2 (fontified t)) . -20772) (#("  " 0 2 (fontified t)) . -20698) (#("  " 0 2 (fontified t)) . -20654) (#("  " 0 2 (fontified t)) . -20608) (#("  " 0 2 (fontified t)) . -20571) (#("  " 0 2 (fontified t)) . -20500) (#("	 " 0 2 (fontified t)) . -20461) (#("	 " 0 2 (fontified t)) . -20416) (#("	 " 0 2 (fontified t)) . -20385) (#("	 " 0 2 (fontified t)) . -20315) (#("	 " 0 2 (fontified t)) . -20269) (#("	  " 0 3 (fontified nil)) . -20255) (20255 . 20256) (#("	" 0 1 (fontified nil)) . 20255) (20249 . 20255) 19132 (t 26978 5378 0 0)) nil (26978 5392 217971 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20483) (undo-tree-id406 . -1) (undo-tree-id407 . -1) (undo-tree-id408 . -1) (undo-tree-id409 . -1) (undo-tree-id410 . -1) (undo-tree-id411 . -1) (undo-tree-id412 . -1) (undo-tree-id413 . -1) (undo-tree-id414 . -1) (undo-tree-id415 . -1) (undo-tree-id416 . -1) 20484 (t 26978 5392 0 0)) nil (26978 5404 503202 0) 0 nil])
([nil nil ((19475 . 19478) (t 26978 5404 0 0)) nil (26978 5670 23214 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19561 . 19562) (nil fontified nil 19478 . 19562) (19478 . 19562)) nil (26978 5670 23213 0) 0 nil])
([nil nil ((#("WARNING" 0 7 (face font-lock-string-face fontified t)) . -19485) (undo-tree-id425 . -7) 19492) nil (26978 5670 23212 0) 0 nil])
([nil nil ((19485 . 19490)) nil (26978 5670 23209 0) 0 nil])
([nil nil ((#("Nested Transaction (Lvl ~A) détectée" 0 36 (face font-lock-string-face fontified t)) . -19492) (undo-tree-id424 . -36) 19528) nil (26978 5670 23208 0) 0 nil])
([nil nil ((19492 . 19494)) nil (26978 5670 23207 0) 0 nil])
([nil nil ((19494 . 19495)) nil (26978 5670 23207 0) 0 nil])
([nil nil ((19495 . 19501)) nil (26978 5670 23206 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-string-face fontified t)) . -19500) (undo-tree-id423 . -1) 19501) nil (26978 5670 23206 0) 0 nil])
([nil nil ((19500 . 19501)) nil (26978 5670 23201 0) 0 nil])
([nil nil ((19501 . 19502)) nil (26978 5670 23200 0) 0 nil])
([nil nil ((19502 . 19504)) nil (26978 5670 23200 0) 0 nil])
([nil nil ((#(". Nouvelle" 0 10 (face font-lock-string-face fontified t)) . 19504)) nil (26978 5670 23199 0) 0 nil])
([nil nil ((#(" connexion" 0 10 (face font-lock-string-face fontified t)) . 19504)) nil (26978 5670 23199 0) 0 nil])
([nil nil ((#(" forcée" 0 7 (face font-lock-string-face fontified t)) . 19504)) nil (26978 5670 23198 0) 0 nil])
([nil nil ((#("!" 0 1 (face font-lock-string-face fontified t)) . 19504) (#(" " 0 1 (face font-lock-string-face fontified t)) . 19504)) nil (26978 5670 23198 0) 0 nil])
([nil nil ((19507 . 19508)) nil (26978 5670 23197 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19532 . 19533) (nil fontified nil 19513 . 19533) (nil fontified nil 19508 . 19513) (19508 . 19533)) nil (26978 5670 23197 0) 0 nil])
([nil nil ((19533 . 19534)) nil (26978 5670 23196 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -19533) (undo-tree-id417 . -1) (undo-tree-id418 . -1) (undo-tree-id419 . -1) (undo-tree-id420 . -1) (undo-tree-id421 . -1) (undo-tree-id422 . -1) 19534) nil (26978 5670 23194 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19487 . 19488) (nil fontified nil 19478 . 19488) (19478 . 19488)) nil (26978 5670 23180 0) 0 nil])
([nil nil ((19543 . 19544)) nil (26978 5670 23176 0) 0 nil])
([nil nil ((1906 . 1908) (t 26978 5670 0 0)) nil (26978 5780 34051 0) 0 nil])
([nil nil ((2156 . 2158)) nil (26978 5780 34047 0) 0 nil])
([nil nil ((8940 . 8942) (t 26978 5780 0 0)) nil (26978 6125 240482 0) 0 nil])
([nil nil ((#("
		(let ((lumen.data.db::*in-connection*
			(if (> pomo::*transaction-level* 0)
			    nil lumen.data.db::*in-connection*)))" 0 1 (fontified t) 1 3 (fontified t) 3 4 (fontified t) 4 7 (face font-lock-keyword-face fontified t) 7 41 (fontified t) 41 45 (fontified t) 45 47 (face font-lock-keyword-face fontified t) 47 56 (fontified t) 56 76 (fontified t) 76 123 (fontified t) 123 124 (fontified t rear-nonsticky t)) . 19550) (undo-tree-id457 . -124) (t 26978 6125 0 0)) nil (26978 6407 794728 0) 0 nil])
([nil nil ((#("
                          ;; Debug info pour confirmer l'isolation
                          (when (> pomo::*transaction-level* 0)
                            (format t \"~&[TX WARNING] Nested Transaction (Lvl ~A) détectée. Nouvelle connexion forcée !~%\" 
                                    pomo::*transaction-level*))" 0 1 (fontified t) 1 27 (fontified t) 27 30 (face font-lock-comment-delimiter-face fontified t) 30 68 (face font-lock-comment-face fontified t) 68 95 (fontified t) 95 99 (face font-lock-keyword-face fontified t) 99 108 (fontified t) 108 128 (fontified t) 128 132 (fontified t) 132 170 (fontified t) 170 254 (face font-lock-string-face fontified t) 254 256 (fontified t) 256 296 (fontified t) 296 317 (fontified t) 317 318 (fontified t) 318 319 (fontified t rear-nonsticky t)) . 19617) (undo-tree-id455 . -319) (undo-tree-id456 . -131)) nil (26978 6407 794727 0) 0 nil])
([nil nil ((19617 . 19623)) nil (26978 6407 794725 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19650 . 19651) (nil fontified nil 19623 . 19651) (19623 . 19651)) nil (26978 6407 794725 0) 0 nil])
([nil nil ((#("
			  ;; SOLUTION : On utilise la macro officielle de Postmodern
			  ;; Elle gère l'objet transaction interne pour nous.
			  (pomo:with-transaction ()" 0 1 (fontified t) 1 6 (fontified t) 6 9 (face font-lock-comment-delimiter-face fontified t) 9 65 (face font-lock-comment-face fontified t) 65 70 (fontified t) 70 73 (face font-lock-comment-delimiter-face fontified t) 73 122 (face font-lock-comment-face fontified t) 122 127 (fontified t) 127 128 (fontified t) 128 132 (face font-lock-keyword-face fontified t) 132 149 (face font-lock-keyword-face fontified t) 149 152 (fontified t)) . 19651) (undo-tree-id454 . -152)) nil (26978 6407 794724 0) 0 nil])
([nil nil ((19617 . 19623)) nil (26978 6407 794723 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19755 . 19756) (nil fontified nil 19623 . 19756) (19623 . 19756)) nil (26978 6407 794722 0) 0 nil])
([nil nil ((#("	" 0 1 (fontified t)) . 19826) (#("
" 0 1 (fontified t)) . 19826)) nil (26978 6407 794721 0) 0 nil])
([nil nil ((19827 . 19832) (#(" " 0 1 (fontified nil)) . 19827) (#("  " 0 2 (fontified nil)) . -19796) (19826 . 19827)) nil (26978 6407 794720 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19980 . 19981) (nil fontified nil 19832 . 19981) (19832 . 19981)) nil (26978 6407 794720 0) 0 nil])
([nil nil ((20266 . 20274) (20219 . 20224) (20260 . 20261)) nil (26978 6407 794719 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 20376 . 20377) (nil fontified nil 20274 . 20377) (20274 . 20377)) nil (26978 6407 794718 0) 0 nil])
([nil nil ((#("
			;; Si on est ici, une erreur est remontée.
			;; Postmodern a DÉJÀ exécuté le ROLLBACK (via son unwind-protect).
			;; La connexion est propre" 0 1 (fontified t) 1 4 (fontified t) 4 7 (face font-lock-comment-delimiter-face fontified t) 7 47 (face font-lock-comment-face fontified t) 47 50 (fontified t) 50 53 (face font-lock-comment-delimiter-face fontified t) 53 117 (face font-lock-comment-face fontified t) 117 120 (fontified t) 120 123 (face font-lock-comment-delimiter-face fontified t) 123 125 (face font-lock-comment-face fontified t) 125 146 (face font-lock-comment-face fontified t)) . 20068) (undo-tree-id453 . -146)) nil (26978 6407 794717 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20256) (undo-tree-id452 . -1) 20257) nil (26978 6407 794716 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20253) (undo-tree-id449 . -1) (#(")" 0 1 (fontified t)) . -20254) (undo-tree-id450 . -1) (#(")" 0 1 (fontified t)) . -20255) (undo-tree-id451 . -1) 20256) nil (26978 6407 794715 0) 0 nil])
([nil nil ((20253 . 20255)) nil (26978 6407 794712 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -20028) (undo-tree-id440 . -1) (undo-tree-id441 . -1) (undo-tree-id442 . -1) (undo-tree-id443 . -1) (undo-tree-id444 . -1) (undo-tree-id445 . -1) (undo-tree-id446 . -1) (undo-tree-id447 . -1) (undo-tree-id448 . -1) 20029) nil (26978 6407 794710 0) 0 nil])
([nil nil ((20254 . 20255)) nil (26978 6407 794702 0) 0 nil])
([nil nil ((#("
		;; ASTUCE : Si on est déjà dans une transaction (Level > 0), 
		;; on force Lumen à croire qu'on n'est PAS connecté.
		;; Cela oblige ensure-connection à prendre une NOUVELLE connexion du pool." 0 1 (fontified t) 1 3 (fontified t) 3 6 (face font-lock-comment-delimiter-face fontified t) 6 65 (face font-lock-comment-face fontified t) 65 67 (fontified t) 67 70 (face font-lock-comment-delimiter-face fontified t) 70 120 (face font-lock-comment-face fontified t) 120 122 (fontified t) 122 125 (face font-lock-comment-delimiter-face fontified t) 125 196 (face font-lock-comment-face fontified t)) . 19285) (undo-tree-id430 . -196) (undo-tree-id431 . -70) (undo-tree-id432 . -70) (undo-tree-id433 . -70) (undo-tree-id434 . -70) (undo-tree-id435 . -70) (undo-tree-id436 . -196) (undo-tree-id437 . -196) (undo-tree-id438 . -196) (undo-tree-id439 . -196)) nil (26978 6407 794701 0) 0 nil])
([nil nil ((20875 . 20877) (20853 . 20855) (20800 . 20802) (20721 . 20723) (20620 . 20622) (20541 . 20543) (20496 . 20498) (20472 . 20474) (#("              " 0 3 (fontified t) 3 12 (fontified t) 12 14 (fontified t)) . 20472) (20410 . 20412) (20318 . 20320) (20242 . 20244) (20196 . 20198) (20148 . 20150) (20110 . 20111) (#("      " 0 6 (fontified t)) . 20110) (20044 . 20045) (#("      " 0 6 (fontified t)) . 20044) (#("	" 0 1 (fontified nil)) . -20013) (20013 . 20014) (#("	" 0 1 (fontified nil)) . 20013) (20007 . 20013) (19956 . 19957) (#("	     " 0 6 (fontified nil)) . -19900) (undo-tree-id426 . -6) (19900 . 19901) (#("	" 0 1 (fontified nil)) . 19900) (19894 . 19900) (#("	     " 0 6 (fontified nil)) . -19850) (19850 . 19851) (#("	" 0 1 (fontified nil)) . 19850) (19844 . 19850) (#("  " 0 2 (fontified t)) . -19830) (#("    " 0 4 (fontified t)) . -19787) (19730 . 19731) (19667 . 19668) (#("  " 0 2 (fontified t)) . -19609) (undo-tree-id427 . -2) (#("  " 0 2 (fontified t)) . -19575) (#("  " 0 2 (fontified t)) . -19543) (undo-tree-id428 . -2) (19458 . 19461) (#("                       " 0 23 (fontified t)) . 19458) (#("  " 0 2 (fontified t)) . -19426) (undo-tree-id429 . -2) (#("	" 0 1 (fontified nil)) . -19416) (19416 . 19417) (#("	" 0 1 (fontified nil)) . 19416) (19410 . 19416) (#("  " 0 2 (fontified t)) . -19394) (#("  " 0 2 (fontified t)) . -19357) 19138) nil (26978 6407 794689 0) 0 nil])
([nil nil ((#("." 0 1 (fontified t)) . -19840) (undo-tree-id458 . -1) (undo-tree-id459 . -1) (undo-tree-id460 . -1) (undo-tree-id461 . -1) (undo-tree-id462 . -1) (undo-tree-id463 . -1) (undo-tree-id464 . -1) 19841 (t 26978 6407 0 0)) nil (26978 6427 773046 0) 0 nil])
([nil nil ((19354 . 19357) (t 26978 6427 0 0)) nil (26978 6702 587226 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 19399 . 19400) (nil fontified nil 19357 . 19400) (19357 . 19400)) nil (26978 6702 587224 0) 0 nil])
([nil nil ((20079 . 20080)) nil (26978 6702 587220 0) 0 nil])
([nil nil ((20965 . 20966) (t 26978 6702 0 0)) nil (26978 6956 223510 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 23591 . 23592) (nil fontified nil 20966 . 23592) (20966 . 23592)) nil (26978 6956 223508 0) 0 nil])
([nil nil ((23592 . 23593)) nil (26978 6956 223504 0) 0 nil])
([nil nil ((22211 . 22212) (t 26978 6956 0 0)) nil (26978 6974 899933 0) 0 nil])
([nil nil ((#("(Votre implémentation existante)" 0 32 (face font-lock-comment-face fontified t)) . -1021) (undo-tree-id473 . -32) 1053 (t 26978 6974 0 0)) nil (26978 9681 720793 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-comment-face fontified t)) . -1020) (undo-tree-id471 . -1) (undo-tree-id472 . -1) 1021) nil (26978 9681 720791 0) 0 nil])
([nil nil ((#(";; ----------------------------------------------------------------------------
;; Pool Variables
;; ----------------------------------------------------------------------------
(defvar *pool-lock* (bt:make-lock \"lumen.db.pool\"))
(defvar *pool-inflight* 0)
(defvar *pool-waiters* 0)
(defvar *pool-sema* nil)
(defvar *pool-size* 0)
(defvar *pool-wait-ms* 2000)

(defun %pool-incf! (var delta)
  (bt:with-lock-held (*pool-lock*) (incf (symbol-value var) delta)))

(defun %ensure-pool-sema! (cfg)
  (let* ((sz   (or (getf cfg :pool-size) 10))
         (wait (or (getf cfg :pool-wait-ms) 2000)))
    (setf *pool-wait-ms* (max 1 wait))
    (when (or (null *pool-sema*) (<= sz 0) (/= sz *pool-size*))
      (setf *pool-sema* (bt:make-semaphore :count (max 1 sz))
            *pool-size* (max 1 sz)))))" 0 3 (face font-lock-comment-delimiter-face fontified t) 3 80 (face font-lock-comment-face fontified t) 80 83 (face font-lock-comment-delimiter-face fontified t) 83 98 (face font-lock-comment-face fontified t) 98 101 (face font-lock-comment-delimiter-face fontified t) 101 178 (face font-lock-comment-face fontified t) 178 179 (fontified t) 179 185 (face font-lock-keyword-face fontified t) 185 186 (fontified t) 186 197 (face font-lock-variable-name-face fontified t) 197 212 (fontified t) 212 227 (face font-lock-string-face fontified t) 227 230 (fontified t) 230 231 (fontified t) 231 237 (face font-lock-keyword-face fontified t) 237 238 (fontified t) 238 253 (face font-lock-variable-name-face fontified t) 253 257 (fontified t) 257 258 (fontified t) 258 264 (face font-lock-keyword-face fontified t) 264 265 (fontified t) 265 279 (face font-lock-variable-name-face fontified t) 279 284 (fontified t) 284 290 (face font-lock-keyword-face fontified t) 290 291 (fontified t) 291 302 (face font-lock-variable-name-face fontified t) 302 309 (fontified t) 309 315 (face font-lock-keyword-face fontified t) 315 316 (fontified t) 316 327 (face font-lock-variable-name-face fontified t) 327 332 (fontified t) 332 338 (face font-lock-keyword-face fontified t) 338 339 (fontified t) 339 353 (face font-lock-variable-name-face fontified t) 353 362 (fontified t) 362 367 (face font-lock-keyword-face fontified t) 367 368 (fontified t) 368 379 (face font-lock-function-name-face fontified t) 379 395 (fontified t) 395 412 (face font-lock-keyword-face fontified t) 412 463 (fontified t) 463 468 (face font-lock-keyword-face fontified t) 468 469 (fontified t) 469 487 (face font-lock-function-name-face fontified t) 487 497 (fontified t) 497 501 (face font-lock-keyword-face fontified t) 501 523 (fontified t) 523 533 (face font-lock-builtin-face fontified t) 533 569 (fontified t) 569 582 (face font-lock-builtin-face fontified t) 582 636 (fontified t) 636 640 (face font-lock-keyword-face fontified t) 640 674 (fontified t) 674 691 (fontified t) 691 695 (fontified t) 695 738 (fontified t) 738 744 (face font-lock-builtin-face fontified t) 744 795 (fontified t)) . 923) (undo-tree-id470 . -795)) nil (26978 9681 720788 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 923) (#("
" 0 1 (fontified t)) . 923)) nil (26978 9681 720786 0) 0 nil])
([nil nil ((#("(defvar *in-connection* nil
  \"Flag pour détecter si on est déjà dans une connexion active (Nested Transaction).\")

(defun call-with-conn (thunk &key (cfg (or *current-config* (lumen.data.config:db-config))))
  ;; Si on est déjà connecté, on exécute directement (NO-OP sur la connexion)
  (if *in-connection*
      (funcall thunk)
      
      ;; Sinon on ouvre une nouvelle connexion
      (let ((*in-connection* t))
        (let* ((mode (intern (string-upcase (or (getf cfg :db-connection-mode) :pooled-native)) :keyword)))
          (ecase mode
            (:toplevel (funcall thunk))
            (:scoped
             #+postmodern
             (postmodern:with-connection (list (getf cfg :database) (getf cfg :user) (getf cfg :password) (getf cfg :host))
               (funcall thunk))
             #-postmodern (funcall thunk))
            (:pooled-native
             (%ensure-pool-sema! cfg)
             (%pool-incf! '*pool-waiters* 1)
             (unwind-protect
                  (progn
                    (bt:wait-on-semaphore *pool-sema*)
                    (%pool-incf! '*pool-waiters* -1)
                    (%pool-incf! '*pool-inflight* 1)
                    (unwind-protect
                         #+postmodern
                         (postmodern:with-connection (list (getf cfg :database) (getf cfg :user) (getf cfg :password) (getf cfg :host) :pooled-p t)
                           (funcall thunk))
                         #-postmodern (funcall thunk)
                      (%pool-incf! '*pool-inflight* -1)
                      (bt:signal-semaphore *pool-sema*)))
               ;; Cleanup waiters si erreur avant acquisition
               )))))))
" 0 1 (fontified t) 1 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 23 (face font-lock-variable-name-face fontified t) 23 30 (fontified t) 30 113 (face font-lock-doc-face fontified t) 113 116 (fontified t) 116 117 (fontified t) 117 122 (face font-lock-keyword-face fontified t) 122 123 (fontified t) 123 137 (face font-lock-function-name-face fontified t) 137 145 (fontified t) 145 149 (face font-lock-type-face fontified t) 149 150 (fontified t) 150 174 (fontified t) 174 209 (fontified t) 209 211 (fontified t) 211 214 (face font-lock-comment-delimiter-face fontified t) 214 287 (face font-lock-comment-face fontified t) 287 290 (fontified t) 290 292 (face font-lock-keyword-face fontified t) 292 323 (fontified t) 323 331 (fontified t) 331 344 (fontified t) 344 347 (face font-lock-comment-delimiter-face fontified t) 347 385 (face font-lock-comment-face fontified t) 385 392 (fontified t) 392 395 (face font-lock-keyword-face fontified t) 395 418 (fontified t) 418 427 (fontified t) 427 431 (face font-lock-keyword-face fontified t) 431 476 (fontified t) 476 495 (face font-lock-builtin-face fontified t) 495 497 (fontified t) 497 511 (face font-lock-builtin-face fontified t) 511 514 (fontified t) 514 522 (face font-lock-builtin-face fontified t) 522 537 (fontified t) 537 542 (face font-lock-keyword-face fontified t) 542 553 (fontified t) 553 561 (fontified t) 561 570 (face font-lock-builtin-face fontified t) 570 582 (fontified t) 582 588 (fontified t) 588 601 (fontified t) 601 608 (face font-lock-builtin-face fontified t) 608 649 (fontified t) 649 675 (face font-lock-keyword-face fontified t) 675 692 (fontified t) 692 701 (face font-lock-builtin-face fontified t) 701 713 (fontified t) 713 718 (face font-lock-builtin-face fontified t) 718 730 (fontified t) 730 739 (face font-lock-builtin-face fontified t) 739 751 (fontified t) 751 756 (face font-lock-builtin-face fontified t) 756 804 (fontified t) 804 832 (face slime-reader-conditional-face fontified t) 832 847 (fontified t) 847 861 (face font-lock-builtin-face fontified t) 861 959 (fontified t) 959 973 (face font-lock-keyword-face fontified t) 973 992 (fontified t) 992 993 (fontified t) 993 998 (face font-lock-keyword-face fontified t) 998 999 (fontified t) 999 1016 (fontified t) 1016 1054 (fontified t) 1054 1181 (fontified t) 1181 1195 (face font-lock-keyword-face fontified t) 1195 1260 (fontified t) 1260 1286 (face font-lock-keyword-face fontified t) 1286 1303 (fontified t) 1303 1312 (face font-lock-builtin-face fontified t) 1312 1324 (fontified t) 1324 1329 (face font-lock-builtin-face fontified t) 1329 1341 (fontified t) 1341 1350 (face font-lock-builtin-face fontified t) 1350 1362 (fontified t) 1362 1367 (face font-lock-builtin-face fontified t) 1367 1369 (fontified t) 1369 1378 (face font-lock-builtin-face fontified t) 1378 1451 (fontified t) 1451 1479 (face slime-reader-conditional-face fontified t) 1479 1536 (fontified t) 1536 1609 (fontified t) 1609 1612 (face font-lock-comment-delimiter-face fontified t) 1612 1636 (face font-lock-comment-face fontified t) 1636 1656 (face font-lock-comment-face fontified t) 1656 1679 (fontified t)) . -2272) (undo-tree-id468 . -1679) (undo-tree-id469 . -609) 3951) nil (26978 9681 720785 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5898 . 5899) (nil fontified nil 2272 . 5899) (2272 . 5899)) nil (26978 9681 720782 0) 0 nil])
([nil nil ((5899 . 5900)) nil (26978 9681 720781 0) 0 nil])
([nil nil ((6293 . 6295)) nil (26978 9681 720780 0) 0 nil])
([nil nil ((6336 . 6338)) nil (26978 9681 720779 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -2301) (undo-tree-id467 . -1) 2302) nil (26978 9681 720778 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -3049) (undo-tree-id466 . -1) 3050) nil (26978 9681 720776 0) 0 nil])
([nil nil ((#("
" 0 1 (face font-lock-comment-face fontified t)) . -4226) (undo-tree-id465 . -1) 4227) nil (26978 9681 720773 0) 0 nil])
([nil nil ((24714 . 24715)) nil (26978 9681 720760 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 26817 . 26818) (nil fontified nil 24715 . 26818) (24715 . 26818)) nil (26978 9681 720759 0) 0 nil])
([nil nil ((26818 . 26819)) nil (26978 9681 720753 0) 0 nil])
([nil nil ((24714 . 24715) (t 26978 9681 0 0)) nil (26978 9850 899707 0) 0 nil])
([nil nil ((24715 . 24717)) nil (26978 9850 899705 0) 0 nil])
([nil nil ((26822 . 26824)) nil (26978 9850 899703 0) 0 nil])
([nil nil ((26824 . 26825)) nil (26978 9850 899698 0) 0 nil])
([nil nil ((#("
;; Ceci est une FONCTION. Pas une macro.
;; Elle prend une lambda (thunk), l'exécute, et retourne une structure (:ok val) ou (:err val).
;; Elle ne laisse JAMAIS une exception sortir de la DB.
#|
(defun run-in-transaction (thunk &key (retries 0) (sleep-ms 50))
  (let ((attempt 0))
    (loop
      (let ((outcome
             (block safe-zone
               (ensure-connection
                 (handler-case
                     (progn
                       (%raw-exec \"BEGIN\")
                       (let ((res (funcall thunk)))
			 
                         (%raw-exec \"COMMIT\")
                         (cons :ok res)))
                   (error (c)
                     (ignore-errors (%raw-exec \"ROLLBACK\"))
                     (cons :error c)))))))
        
        (if (eq (car outcome) :ok)
            (return (cdr outcome))
            
            (let* ((err (cdr outcome))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              ;; On extrait proprement le message et le code
              (multiple-value-bind (msg code) (extract-error-details err)
                
                (cond
                  ;; Cas A : Erreur Métier (ApplicationError OU QALM error non mappée)
                  ((or is-app (not mapped))
                   ;; On retourne le tuple spécial (:business-error message code)
                   (return (list :business-error msg code)))
                  
                  ;; Cas B : Retry DB
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                   (incf attempt))
                  
                  ;; Cas C : Fatal DB
                  (t
                   (return (list :fatal-error msg)))))))))))
|#

(defun run-in-transaction (thunk &key (retries 0) (sleep-ms 50))
  (let ((attempt 0))
    (loop
      (let ((outcome
              (block safe-zone
		(format t \"~&[TX DEBUG] TX Level: ~A~%\" pomo::*transaction-level*)
		(let ((lumen.data.db::*in-connection* nil))
		(ensure-connection
                  (handler-case
		      (progn
			;; 1. BEGIN EXPLICITE (SQL pur)
			;; On bypass les objets transactions de Postmodern qui semblent désynchronisés
			(postmodern:execute \"BEGIN\")
			(let ((res (funcall thunk)))
			  ;; 2. COMMIT EXPLICITE (SQL pur)
                          ;; On force l'écriture sur le disque
                          (postmodern:execute \"COMMIT\")
                          (cons :ok res)))
                   
		    (error (c)
		      (format t \"~&[TX ERROR/ROLLBACK] ~A~%\" c)
		      ;; 3. ROLLBACK EXPLICITE (SQL pur)
                      (ignore-errors (postmodern:execute \"ROLLBACK\"))
		      (cons :error c))))))))
        
	;; Le reste de votre logique de gestion d'erreur reste identique
	(if (eq (car outcome) :ok)
            (return (cdr outcome))
            
            (let* ((err (cdr outcome))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (multiple-value-bind (msg code) (extract-error-details err)
		(cond
                  ((or is-app (not mapped))
                   (return (list :business-error msg code)))
                  
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                   (incf attempt))
                  
                  (t" 0 1 (fontified t) 1 4 (face font-lock-comment-delimiter-face fontified t) 4 42 (face font-lock-comment-face fontified t) 42 45 (face font-lock-comment-delimiter-face fontified t) 45 55 (face font-lock-comment-face fontified t) 55 56 (face font-lock-comment-face fontified t) 56 57 (face font-lock-comment-face fontified t) 57 138 (face font-lock-comment-face fontified t) 138 141 (face font-lock-comment-delimiter-face fontified t) 141 169 (face font-lock-comment-face fontified t) 169 194 (face font-lock-comment-face fontified t) 194 196 (face font-lock-comment-delimiter-face fontified t) 196 197 (face font-lock-comment-face fontified t) 197 198 (face font-lock-comment-face fontified t) 198 203 (face font-lock-comment-face fontified t) 203 204 (face font-lock-comment-face fontified t) 204 210 (face font-lock-comment-face fontified t) 210 211 (face font-lock-comment-face fontified t) 211 212 (face font-lock-comment-face fontified t) 212 215 (face font-lock-comment-face fontified t) 215 222 (face font-lock-comment-face fontified t) 222 230 (face font-lock-comment-face fontified t) 230 234 (face font-lock-comment-face fontified t) 234 262 (face font-lock-comment-face fontified t) 262 265 (face font-lock-comment-face fontified t) 265 268 (face font-lock-comment-face fontified t) 268 283 (face font-lock-comment-face fontified t) 283 288 (face font-lock-comment-face fontified t) 288 292 (face font-lock-comment-face fontified t) 292 300 (face font-lock-comment-face fontified t) 300 303 (face font-lock-comment-face fontified t) 303 323 (face font-lock-comment-face fontified t) 323 328 (face font-lock-comment-face fontified t) 328 333 (face font-lock-comment-face fontified t) 333 344 (face font-lock-comment-face fontified t) 344 396 (face font-lock-comment-face fontified t) 396 408 (face font-lock-comment-face fontified t) 408 431 (face font-lock-comment-face fontified t) 431 436 (face font-lock-comment-face fontified t) 436 471 (face font-lock-comment-face fontified t) 471 478 (face font-lock-comment-face fontified t) 478 480 (face font-lock-comment-face fontified t) 480 504 (face font-lock-comment-face fontified t) 504 507 (face font-lock-comment-face fontified t) 507 531 (face font-lock-comment-face fontified t) 531 532 (face font-lock-comment-face fontified t) 532 536 (face font-lock-comment-face fontified t) 536 537 (face font-lock-comment-face fontified t) 537 556 (face font-lock-comment-face fontified t) 556 573 (face font-lock-comment-face fontified t) 573 581 (face font-lock-comment-face fontified t) 581 583 (face font-lock-comment-face fontified t) 583 614 (face font-lock-comment-face fontified t) 614 617 (face font-lock-comment-face fontified t) 617 645 (face font-lock-comment-face fontified t) 645 650 (face font-lock-comment-face fontified t) 650 664 (face font-lock-comment-face fontified t) 664 677 (face font-lock-comment-face fontified t) 677 690 (face font-lock-comment-face fontified t) 690 702 (face font-lock-comment-face fontified t) 702 712 (face font-lock-comment-face fontified t) 712 715 (face font-lock-comment-face fontified t) 715 742 (face font-lock-comment-face fontified t) 742 748 (face font-lock-comment-face fontified t) 748 752 (face font-lock-comment-face fontified t) 752 758 (face font-lock-comment-face fontified t) 758 776 (face font-lock-comment-face fontified t) 776 778 (face font-lock-comment-face fontified t) 778 781 (face font-lock-comment-face fontified t) 781 797 (face font-lock-comment-face fontified t) 797 800 (face font-lock-comment-face fontified t) 800 802 (face font-lock-comment-face fontified t) 802 815 (face font-lock-comment-face fontified t) 815 821 (face font-lock-comment-face fontified t) 821 827 (face font-lock-comment-face fontified t) 827 837 (face font-lock-comment-face fontified t) 837 842 (face font-lock-comment-face fontified t) 842 850 (face font-lock-comment-face fontified t) 850 863 (face font-lock-comment-face fontified t) 863 867 (face font-lock-comment-face fontified t) 867 935 (face font-lock-comment-face fontified t) 935 965 (face font-lock-comment-face fontified t) 965 993 (face font-lock-comment-face fontified t) 993 999 (face font-lock-comment-face fontified t) 999 1047 (face font-lock-comment-face fontified t) 1047 1058 (face font-lock-comment-face fontified t) 1058 1062 (face font-lock-comment-face fontified t) 1062 1076 (face font-lock-comment-face fontified t) 1076 1079 (face font-lock-comment-face fontified t) 1079 1123 (face font-lock-comment-face fontified t) 1123 1138 (face font-lock-comment-face fontified t) 1138 1157 (face font-lock-comment-face fontified t) 1157 1231 (face font-lock-comment-face fontified t) 1231 1235 (face font-lock-comment-face fontified t) 1235 1254 (face font-lock-comment-face fontified t) 1254 1257 (face font-lock-comment-face fontified t) 1257 1323 (face font-lock-comment-face fontified t) 1323 1338 (face font-lock-comment-face fontified t) 1338 1347 (face font-lock-comment-face fontified t) 1347 1367 (face font-lock-comment-face fontified t) 1367 1386 (face font-lock-comment-face fontified t) 1386 1389 (face font-lock-comment-face fontified t) 1389 1434 (face font-lock-comment-face fontified t) 1434 1437 (face font-lock-comment-face fontified t) 1437 1449 (face font-lock-comment-face fontified t) 1449 1469 (face font-lock-comment-face fontified t) 1469 1475 (face font-lock-comment-face fontified t) 1475 1482 (face font-lock-comment-face fontified t) 1482 1483 (face font-lock-comment-face fontified t) 1483 1497 (face font-lock-comment-face fontified t) 1497 1505 (face font-lock-comment-face fontified t) 1505 1506 (face font-lock-comment-face fontified t) 1506 1507 (face font-lock-comment-face fontified t) 1507 1508 (face font-lock-comment-face fontified t) 1508 1509 (face font-lock-comment-face fontified t) 1509 1510 (face font-lock-comment-face fontified t) 1510 1547 (face font-lock-comment-face fontified t) 1547 1550 (face font-lock-comment-face fontified t) 1550 1567 (face font-lock-comment-face fontified t) 1567 1646 (face font-lock-comment-face fontified t) 1646 1667 (face font-lock-comment-face fontified t) 1667 1687 (face font-lock-comment-face fontified t) 1687 1691 (face font-lock-comment-face fontified t) 1691 1697 (face font-lock-comment-face fontified t) 1697 1702 (face font-lock-comment-face fontified t) 1702 1710 (face font-lock-comment-face fontified t) 1710 1711 (face font-lock-comment-face fontified t) 1711 1715 (face font-lock-comment-face fontified t) 1715 1727 (face font-lock-comment-face fontified t) 1727 1746 (face font-lock-comment-face fontified t) 1746 1783 (face font-lock-comment-face fontified t) 1783 1800 (face font-lock-comment-face fontified t) 1800 1818 (face font-lock-comment-face fontified t) 1818 1821 (face font-lock-comment-face fontified t) 1821 1838 (face font-lock-comment-face fontified t) 1838 1879 (face font-lock-comment-face fontified t) 1879 1885 (face font-lock-comment-face fontified t) 1885 1892 (face font-lock-comment-face fontified t) 1892 1904 (face font-lock-comment-face fontified t) 1904 1918 (face font-lock-comment-face fontified t) 1918 1919 (face font-lock-comment-face fontified t rear-nonsticky t) 1919 1920 (face font-lock-comment-face fontified t) 1920 1922 (face font-lock-comment-delimiter-face fontified t) 1922 1923 (fontified t) 1923 1924 (fontified t) 1924 1925 (fontified t) 1925 1930 (face font-lock-keyword-face fontified t) 1930 1931 (fontified t) 1931 1937 (face font-lock-function-name-face fontified t) 1937 1949 (face font-lock-function-name-face fontified t) 1949 1957 (fontified t) 1957 1961 (face font-lock-type-face fontified t) 1961 1992 (fontified t) 1992 1995 (face font-lock-keyword-face fontified t) 1995 2015 (fontified t) 2015 2019 (face font-lock-keyword-face fontified t) 2019 2027 (fontified t) 2027 2030 (face font-lock-keyword-face fontified t) 2030 2041 (fontified t) 2041 2056 (fontified t) 2056 2061 (face font-lock-keyword-face fontified t) 2061 2071 (fontified t) 2071 2072 (fontified t) 2072 2074 (fontified t) 2074 2083 (fontified t) 2083 2084 (fontified t rear-nonsticky t) 2084 2112 (face font-lock-string-face fontified t) 2112 2113 (face font-lock-string-face fontified t rear-nonsticky t) 2113 2114 (fontified t) 2114 2119 (fontified t) 2119 2138 (fontified t) 2138 2139 (fontified t rear-nonsticky t) 2139 2141 (fontified t) 2141 2143 (fontified t) 2143 2144 (fontified t) 2144 2147 (face font-lock-keyword-face fontified t) 2147 2185 (fontified t) 2185 2186 (fontified t rear-nonsticky t) 2186 2187 (fontified t) 2187 2189 (fontified t) 2189 2208 (fontified t) 2208 2227 (fontified t) 2227 2239 (face font-lock-keyword-face fontified t) 2239 2240 (fontified t) 2240 2248 (fontified t) 2248 2249 (fontified t) 2249 2254 (face font-lock-keyword-face fontified t) 2254 2255 (fontified t) 2255 2258 (fontified t) 2258 2261 (face font-lock-comment-delimiter-face fontified t) 2261 2290 (face font-lock-comment-face fontified t) 2290 2293 (fontified t) 2293 2296 (face font-lock-comment-delimiter-face fontified t) 2296 2370 (face font-lock-comment-face fontified t) 2370 2371 (face font-lock-comment-face fontified t rear-nonsticky t) 2371 2372 (face font-lock-comment-face fontified t) 2372 2375 (fontified t) 2375 2395 (fontified t) 2395 2402 (face font-lock-string-face fontified t) 2402 2403 (fontified t rear-nonsticky t) 2403 2404 (fontified t) 2404 2407 (fontified t) 2407 2408 (fontified t) 2408 2411 (face font-lock-keyword-face fontified t) 2411 2436 (fontified t) 2436 2441 (fontified t) 2441 2444 (face font-lock-comment-delimiter-face fontified t) 2444 2474 (face font-lock-comment-face fontified t) 2474 2500 (fontified t) 2500 2503 (face font-lock-comment-delimiter-face fontified t) 2503 2537 (face font-lock-comment-face fontified t) 2537 2583 (fontified t) 2583 2591 (face font-lock-string-face fontified t) 2591 2592 (fontified t rear-nonsticky t) 2592 2593 (fontified t) 2593 2625 (fontified t) 2625 2628 (face font-lock-builtin-face fontified t) 2628 2636 (fontified t) 2636 2656 (fontified t) 2656 2662 (fontified t) 2662 2663 (fontified t) 2663 2668 (face font-lock-warning-face fontified t) 2668 2672 (fontified t) 2672 2673 (fontified t) 2673 2681 (fontified t) 2681 2691 (fontified t) 2691 2694 (face font-lock-string-face fontified t) 2694 2704 (face font-lock-string-face fontified t) 2704 2711 (face font-lock-string-face fontified t) 2711 2712 (face font-lock-string-face fontified t rear-nonsticky t) 2712 2713 (face font-lock-string-face fontified t) 2713 2719 (face font-lock-string-face fontified t) 2719 2723 (fontified t) 2723 2731 (fontified t) 2731 2734 (face font-lock-comment-delimiter-face fontified t) 2734 2766 (face font-lock-comment-face fontified t) 2766 2789 (fontified t) 2789 2802 (face font-lock-keyword-face fontified t) 2802 2823 (fontified t) 2823 2833 (face font-lock-string-face fontified t) 2833 2834 (fontified t) 2834 2835 (fontified t rear-nonsticky t) 2835 2836 (fontified t) 2836 2844 (fontified t) 2844 2850 (fontified t) 2850 2856 (face font-lock-builtin-face fontified t) 2856 2867 (fontified t) 2867 2876 (fontified t) 2876 2877 (fontified t) 2877 2879 (face font-lock-comment-delimiter-face fontified t) 2879 2880 (face font-lock-comment-delimiter-face fontified t) 2880 2942 (face font-lock-comment-face fontified t) 2942 2943 (fontified t) 2943 2944 (fontified t) 2944 2946 (face font-lock-keyword-face fontified t) 2946 2949 (fontified t) 2949 2965 (fontified t) 2965 2968 (face font-lock-builtin-face fontified t) 2968 2970 (fontified t) 2970 2983 (fontified t) 2983 2989 (face font-lock-keyword-face fontified t) 2989 3005 (fontified t) 3005 3018 (fontified t) 3018 3031 (fontified t) 3031 3035 (face font-lock-keyword-face fontified t) 3035 3057 (fontified t) 3057 3133 (fontified t) 3133 3161 (fontified t) 3161 3167 (face font-lock-keyword-face fontified t) 3167 3215 (fontified t) 3215 3230 (fontified t) 3230 3245 (fontified t) 3245 3264 (face font-lock-keyword-face fontified t) 3264 3285 (fontified t) 3285 3306 (fontified t) 3306 3307 (fontified t) 3307 3311 (face font-lock-keyword-face fontified t) 3311 3312 (fontified t) 3312 3327 (fontified t) 3327 3349 (fontified t) 3349 3356 (fontified t) 3356 3376 (fontified t) 3376 3382 (face font-lock-keyword-face fontified t) 3382 3389 (fontified t) 3389 3404 (face font-lock-builtin-face fontified t) 3404 3406 (fontified t) 3406 3417 (fontified t) 3417 3426 (fontified t) 3426 3436 (fontified t) 3436 3437 (fontified t) 3437 3449 (fontified t) 3449 3484 (fontified t) 3484 3507 (fontified t) 3507 3536 (fontified t) 3536 3556 (fontified t) 3556 3560 (face font-lock-keyword-face fontified t) 3560 3563 (fontified t) 3563 3589 (fontified t) 3589 3615 (fontified t) 3615 3617 (fontified t) 3617 3621 (fontified t) 3621 3650 (fontified t) 3650 3669 (fontified t) 3669 3673 (fontified t) 3673 3675 (fontified t) 3675 3687 (fontified t) 3687 3688 (fontified t) 3688 3689 (fontified t)) . 18334) (undo-tree-id478 . -3689) (t 26978 9850 0 0)) nil (26978 13718 143154 0) 0 nil])
([nil nil ((#("
                   (return (list :fatal-error msg)))))))))))
" 0 1 (fontified t) 1 3 (fontified t) 3 21 (fontified t) 21 27 (face font-lock-keyword-face fontified t) 27 34 (fontified t) 34 46 (face font-lock-builtin-face fontified t) 46 60 (fontified t) 60 61 (fontified t rear-nonsticky t) 61 62 (fontified t)) . -18334) (undo-tree-id477 . -62) 18396) nil (26978 13718 143152 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -18333) (undo-tree-id475 . -1) (undo-tree-id476 . -1) 18334) nil (26978 13718 143150 0) 0 nil])
([nil nil ((18333 . 18335)) nil (26978 13718 143146 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -18334) (undo-tree-id474 . -1) 18335) nil (26978 13718 143143 0) 0 nil])
([nil nil ((#("(defun start! (&key (config (lumen.data.config:db-config)))
  ;;(print config)
  (setf *current-config* config
        *connection-mode* (or (getf config :db-connection-mode) :pooled-native))
  (when (stringp *connection-mode*)
    (setf *connection-mode* (intern (string-upcase *connection-mode*) :keyword)))
  ;;(print *connection-mode*)
  (ecase *connection-mode*
    (:toplevel
     #+postmodern
     (let ((db (getf config :database)) (user (getf config :user))
           (pass (getf config :password)) (host (or (getf config :host) \"localhost\"))
           (port (or (getf config :port) 5432)) (use-ssl (case (getf config :sslmode) (:require :yes) (t :no))))
       (postmodern:connect-toplevel db user pass host :port port :use-ssl use-ssl))
     (setf *started* t))
    ((:scoped :pooled-native)
     (%ensure-pool-sema! config)
     (setf *started* t)))
  *started*)

(defun stop! ()
  (when *started*
    (when (eq *connection-mode* :toplevel)
      #+postmodern (ignore-errors (postmodern:disconnect-toplevel)))
    (setf *started* nil))
  t)" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 13 (face font-lock-function-name-face fontified t) 13 15 (fontified t) 15 19 (face font-lock-type-face fontified t) 19 62 (fontified t) 62 64 (face font-lock-comment-delimiter-face fontified t) 64 79 (face font-lock-comment-face fontified t) 79 154 (fontified t) 154 173 (face font-lock-builtin-face fontified t) 173 175 (fontified t) 175 189 (face font-lock-builtin-face fontified t) 189 195 (fontified t) 195 199 (face font-lock-keyword-face fontified t) 199 298 (fontified t) 298 306 (face font-lock-builtin-face fontified t) 306 312 (fontified t) 312 314 (face font-lock-comment-delimiter-face fontified t) 314 340 (face font-lock-comment-face fontified t) 340 343 (fontified t) 343 348 (face font-lock-keyword-face fontified t) 348 372 (fontified t) 372 381 (face font-lock-builtin-face fontified t) 381 406 (fontified t) 406 409 (face font-lock-keyword-face fontified t) 409 428 (fontified t) 428 437 (face font-lock-builtin-face fontified t) 437 459 (fontified t) 459 464 (face font-lock-builtin-face fontified t) 464 487 (fontified t) 487 497 (fontified t) 497 506 (face font-lock-builtin-face fontified t) 506 532 (fontified t) 532 537 (face font-lock-builtin-face fontified t) 537 539 (fontified t) 539 550 (face font-lock-string-face fontified t) 550 553 (fontified t) 553 587 (fontified t) 587 592 (face font-lock-builtin-face fontified t) 592 611 (fontified t) 611 615 (face font-lock-keyword-face fontified t) 615 629 (fontified t) 629 637 (face font-lock-builtin-face fontified t) 637 640 (fontified t) 640 648 (face font-lock-builtin-face fontified t) 648 649 (fontified t) 649 653 (face font-lock-builtin-face fontified t) 653 658 (fontified t) 658 661 (face font-lock-builtin-face fontified t) 661 720 (fontified t) 720 725 (face font-lock-builtin-face fontified t) 725 731 (fontified t) 731 739 (face font-lock-builtin-face fontified t) 739 781 (fontified t) 781 788 (face font-lock-builtin-face fontified t) 788 789 (fontified t) 789 803 (face font-lock-builtin-face fontified t) 803 829 (fontified t) 829 879 (fontified t) 879 884 (face font-lock-keyword-face fontified t) 884 885 (fontified t) 885 890 (face font-lock-function-name-face fontified t) 890 897 (fontified t) 897 901 (face font-lock-keyword-face fontified t) 901 917 (fontified t) 917 921 (face font-lock-keyword-face fontified t) 921 944 (fontified t) 944 953 (face font-lock-builtin-face fontified t) 953 975 (fontified t) 975 988 (face font-lock-keyword-face fontified t) 988 1054 (fontified t)) . -1014) (undo-tree-id0 . -1054) (undo-tree-id1 . -1054) (undo-tree-id2 . -877) (undo-tree-id3 . -857) (undo-tree-id4 . -1054) (undo-tree-id5 . -1054) (undo-tree-id6 . -1054) (undo-tree-id7 . -1054) (undo-tree-id8 . -1054) (undo-tree-id9 . -1054) (undo-tree-id10 . -1050) (undo-tree-id11 . -1054) (undo-tree-id12 . -1054) 2068 (t 26978 13718 0 0)) nil (26978 20587 386591 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2736 . 2737) (nil fontified nil 1014 . 2737) (1014 . 2737)) nil (26978 20587 386564 0) 0 nil])
([nil nil ((8534 . 8537) (t 26978 20587 0 0)) nil (26978 27289 56823 0) 0 nil])
([nil nil ((8537 . 8540)) nil (26978 27289 56822 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -8539) (undo-tree-id36 . -1) 8540) nil (26978 27289 56822 0) 0 nil])
([nil nil ((8539 . 8543)) nil (26978 27289 56820 0) 0 nil])
([nil nil ((8543 . 8544)) nil (26978 27289 56819 0) 0 nil])
([nil nil ((8544 . 8552)) nil (26978 27289 56819 0) 0 nil])
([nil nil ((8552 . 8553)) nil (26978 27289 56818 0) 0 nil])
([nil nil ((8545 . 8550)) nil (26978 27289 56818 0) 0 nil])
([nil nil ((8550 . 8552)) nil (26978 27289 56817 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -8551) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) 8552) nil (26978 27289 56816 0) 0 nil])
([nil nil ((8551 . 8553)) nil (26978 27289 56813 0) 0 nil])
([nil nil ((8560 . 8561)) nil (26978 27289 56813 0) 0 nil])
([nil nil ((8561 . 8564)) nil (26978 27289 56812 0) 0 nil])
([nil nil ((8564 . 8565)) nil (26978 27289 56812 0) 0 nil])
([nil nil ((8565 . 8574)) nil (26978 27289 56811 0) 0 nil])
([nil nil ((#("
  (let* ((kpos (position-if #'keywordp params))
         (args (if kpos (subseq params 0 kpos) params))
         (opts (if kpos (subseq params kpos) '()))
         (timeout-ms (getf opts :timeout-ms (or *default-statement-timeout-ms* nil)))
         (t0 (get-internal-real-time)))
    (handler-case
        (with-statement-timeout (timeout-ms)
          (let* ((fn  (get-prepared-plan sql :format :alist))
                 (row (apply fn args))
                 (elapsed-ms (* 1000.0 (/ (- (get-internal-real-time) t0)
                                          cl:internal-time-units-per-second))))
            (record-query-latency sql elapsed-ms (if row 1 0))
            (when (and *slow-query-ms* (>= elapsed-ms *slow-query-ms*))
              (lumen.data.metrics:record-slow-query
	       sql elapsed-ms :params args :rows (if row 1 0)))
            row))
      (condition (c)
        (translate-db-error c)))))" 0 1 (fontified t) 1 4 (fontified t) 4 8 (face font-lock-keyword-face fontified t) 8 65 (fontified t) 65 67 (face font-lock-keyword-face fontified t) 67 121 (fontified t) 121 123 (face font-lock-keyword-face fontified t) 123 188 (fontified t) 188 199 (face font-lock-builtin-face fontified t) 199 287 (fontified t) 287 299 (face font-lock-keyword-face fontified t) 299 309 (fontified t) 309 331 (face font-lock-keyword-face fontified t) 331 356 (fontified t) 356 360 (face font-lock-keyword-face fontified t) 360 390 (fontified t) 390 397 (face font-lock-builtin-face fontified t) 397 398 (fontified t) 398 404 (face font-lock-builtin-face fontified t) 404 650 (fontified t) 650 652 (face font-lock-keyword-face fontified t) 652 663 (fontified t) 663 676 (fontified t) 676 680 (face font-lock-keyword-face fontified t) 680 810 (fontified t) 810 817 (face font-lock-builtin-face fontified t) 817 823 (fontified t) 823 828 (face font-lock-builtin-face fontified t) 828 830 (fontified t) 830 832 (face font-lock-keyword-face fontified t) 832 917 (fontified t)) . 8575) (undo-tree-id19 . -917) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -917) (undo-tree-id29 . -917) (undo-tree-id30 . -917) (undo-tree-id31 . -917) (undo-tree-id32 . -917)) nil (26978 27289 56809 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -8574) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) 8575) nil (26978 27289 56791 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -11112) (undo-tree-id42 . -1) 11113 (t 26978 27289 0 0)) nil (26978 31022 139086 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11113 . 11114) (nil fontified nil 11112 . 11114) (11112 . 11114)) nil (26978 31022 139083 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 11139 . 11140) (nil fontified nil 11128 . 11140) (nil fontified nil 11127 . 11128) (nil fontified nil 11126 . 11127) (11126 . 11140)) nil (26978 31022 139082 0) 0 nil])
([nil nil ((#("Affected" 0 8 (face font-lock-string-face fontified t)) . -11128) (undo-tree-id38 . -8) (undo-tree-id39 . -8) (undo-tree-id40 . -8) (undo-tree-id41 . -8) 11136) nil (26978 31022 139079 0) 0 nil])
([nil nil ((11128 . 11129)) nil (26978 31022 139072 0) 0 nil])
([nil nil ((#("T" 0 1 (face font-lock-string-face fontified t)) . -11128) (undo-tree-id37 . -1) 11129) nil (26978 31022 139070 0) 0 nil])
([nil nil ((11128 . 11131)) nil (26978 31022 139059 0) 0 nil])
([nil nil ((11147 . 11149)) nil (26978 31022 139057 0) 0 nil])
([nil nil ((11149 . 11152)) nil (26978 31022 139051 0) 0 nil])
([nil nil ((7707 . 7712) (t 26978 31022 0 0)) nil (26985 27674 85506 0) 0 nil])
([nil nil ((7712 . 7716)) nil (26985 27674 85505 0) 0 nil])
([nil nil ((#("p" 0 1 (fontified t)) . -7713) (undo-tree-id8 . -1) (#("r" 0 1 (fontified t)) . -7714) (undo-tree-id9 . -1) (#("n" 0 1 (fontified t)) . -7715) (undo-tree-id10 . -1) 7716) nil (26985 27674 85504 0) 0 nil])
([nil nil ((7713 . 7719)) nil (26985 27674 85502 0) 0 nil])
([nil nil ((7719 . 7720)) nil (26985 27674 85502 0) 0 nil])
([nil nil ((7720 . 7721)) nil (26985 27674 85501 0) 0 nil])
([nil nil ((7721 . 7722)) nil (26985 27674 85501 0) 0 nil])
([nil nil ((7722 . 7724)) nil (26985 27674 85501 0) 0 nil])
([nil nil ((7724 . 7725)) nil (26985 27674 85500 0) 0 nil])
([nil nil ((#("é" 0 1 (face font-lock-string-face fontified t)) . -7723) (undo-tree-id6 . -1) (#(" " 0 1 (face font-lock-string-face fontified t)) . -7724) (undo-tree-id7 . -1) 7725) nil (26985 27674 85500 0) 0 nil])
([nil nil ((7723 . 7724)) nil (26985 27674 85497 0) 0 nil])
([nil nil ((7724 . 7726)) nil (26985 27674 85496 0) 0 nil])
([nil nil ((#("a" 0 1 (face font-lock-string-face fontified t)) . -7725) (undo-tree-id5 . -1) 7726) nil (26985 27674 85496 0) 0 nil])
([nil nil ((7725 . 7728)) nil (26985 27674 85495 0) 0 nil])
([nil nil ((#("I" 0 1 (face font-lock-string-face fontified t)) . -7726) (undo-tree-id3 . -1) (#("N" 0 1 (face font-lock-string-face fontified t)) . -7727) (undo-tree-id4 . -1) 7728) nil (26985 27674 85494 0) 0 nil])
([nil nil ((7726 . 7738)) nil (26985 27674 85492 0) 0 nil])
([nil nil ((#(":" 0 1 (face font-lock-string-face fontified t)) . -7737) (undo-tree-id2 . -1) 7738) nil (26985 27674 85491 0) 0 nil])
([nil nil ((7737 . 7738)) nil (26985 27674 85490 0) 0 nil])
([nil nil ((#("}" 0 1 (face font-lock-string-face fontified t)) . -7737) (undo-tree-id1 . -1) 7738) nil (26985 27674 85490 0) 0 nil])
([nil nil ((7737 . 7738)) nil (26985 27674 85488 0) 0 nil])
([nil nil ((7738 . 7739)) nil (26985 27674 85487 0) 0 nil])
([nil nil ((7739 . 7741)) nil (26985 27674 85487 0) 0 nil])
([nil nil ((7741 . 7742)) nil (26985 27674 85486 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -7741) (undo-tree-id0 . -1) 7742) nil (26985 27674 85485 0) 0 nil])
([nil nil ((7741 . 7742)) nil (26985 27674 85471 0) 0 nil])
([nil nil ((7742 . 7744)) nil (26985 27674 85471 0) 0 nil])
([nil nil ((7744 . 7745)) nil (26985 27674 85469 0) 0 nil])
([nil nil ((7745 . 7749)) nil (26985 27674 85466 0) 0 nil])
([nil nil ((7748 . 7749) (t 26985 27674 0 0)) nil (26985 27680 417804 0) 0 nil])
([nil nil ((#("q" 0 1 (fontified t)) . -7748) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) 7749) nil (26985 27680 417803 0) 0 nil])
([nil nil ((7748 . 7749)) nil (26985 27680 417784 0) 0 nil])
([nil nil ((7750 . 7755) (t 26985 27680 0 0)) nil (26985 56137 712265 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7792 . 7793) (nil fontified nil 7787 . 7793) (nil fontified nil 7765 . 7787) (nil fontified nil 7755 . 7765) (7755 . 7793)) nil (26985 56137 712264 0) 0 nil])
([nil nil ((#("args" 0 4 (fontified t)) . -7788) (undo-tree-id23 . -4) 7792) nil (26985 56137 712263 0) 0 nil])
([nil nil ((7788 . 7793)) nil (26985 56137 712260 0) 0 nil])
([nil nil ((#("s" 0 1 (fontified t)) . -7792) (undo-tree-id22 . -1) 7793) nil (26985 56137 712258 0) 0 nil])
([nil nil ((7792 . 7794)) nil (26985 56137 712245 0) 0 nil])
([nil nil ((7737 . 7738) (t 26985 56137 0 0)) nil (26985 56169 456076 0) 0 nil])
([nil nil ((7738 . 7742)) nil (26985 56169 456075 0) 0 nil])
([nil nil ((#(" " 0 1 (face font-lock-string-face fontified t)) . -7737) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) (#("A" 0 1 (face font-lock-string-face fontified t)) . -7738) (undo-tree-id29 . -1) (#("R" 0 1 (face font-lock-string-face fontified t)) . -7739) (undo-tree-id30 . -1) (#("G" 0 1 (face font-lock-string-face fontified t)) . -7740) (undo-tree-id31 . -1) (#("S" 0 1 (face font-lock-string-face fontified t)) . -7741) (undo-tree-id32 . -1) 7742) nil (26985 56169 456074 0) 0 nil])
([nil nil ((7738 . 7739)) nil (26985 56169 456059 0) 0 nil])
([nil nil ((7739 . 7744)) nil (26985 56169 456058 0) 0 nil])
([nil nil ((7788 . 7791)) nil (26985 56169 456058 0) 0 nil])
([nil nil ((7791 . 7795)) nil (26985 56169 456056 0) 0 nil])
([nil nil ((7795 . 7796)) nil (26985 56169 456053 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -11293) (undo-tree-id0 . -1) (undo-tree-id1 . -1) 11294 (t 26985 56169 0 0)) nil (26990 32044 609787 0) 0 nil])
([nil nil ((19155 . 19157) (t 26990 32044 0 0)) nil (26991 10015 233991 0) 0 nil])
([nil nil ((19428 . 19430)) nil (26991 10015 233990 0) 0 nil])
([nil nil ((20086 . 20092)) nil (26991 10015 233990 0) 0 nil])
([nil nil ((20039 . 20041)) nil (26991 10015 233989 0) 0 nil])
([nil nil ((#("
#|
(defun run-in-transaction (thunk &key (retries 0) (sleep-ms 50))
  (let ((attempt 0))
    (loop
      (let ((outcome
             (block safe-zone
               ;; Avec le nouveau Pool, ensure-connection nous garantit une connexion 
               ;; persistante et stable pour la durée du bloc.
               (ensure-connection
                 (handler-case
                     ;; On utilise la macro standard.
                     ;; Elle envoie BEGIN, exécute le thunk, puis COMMIT.
                     ;; En cas d'erreur, elle envoie ROLLBACK automatiquement via unwind-protect.
                     (postmodern:with-transaction ()
                       (let ((res (funcall thunk)))
                         (cons :ok res)))
                   
                   ;; On capture l'erreur APRÈS que with-transaction ait fait le rollback
                   (error (c)
                     (format t \"~&[TX ERROR] ~A~%\" c)
                     (cons :error c)))))))
        
        ;; Logique de Retry / Mapping d'erreur (Inchangée et validée)
        (if (eq (car outcome) :ok)
            (return (cdr outcome))
            
            (let* ((err (cdr outcome))
                   (is-app (typep err 'lumen.core.error:application-error))
                   (mapped (unless is-app (lumen.data.errors:map-db-error err))))
              
              (multiple-value-bind (msg code) (extract-error-details err)
                (cond
                  ;; Cas A : Erreur Métier -> On renvoie la structure pour le contrôleur
                  ((or is-app (not mapped))
                   (return (list :business-error msg code)))
                  
                  ;; Cas B : Erreur DB transitoire (ex: deadlock) -> On retry
                  ((and mapped (< attempt retries) (lumen.data.errors:retryable-db-error-p mapped))
                   (when (plusp sleep-ms) (sleep (/ (max 0 sleep-ms) 1000.0)))
                   (incf attempt))
                  
                  ;; Cas C : Erreur Fatale -> On arrête
                  (t
                   (return (list :fatal-error msg)))))))))))
|#
" 0 1 (fontified t) 1 3 (face font-lock-comment-delimiter-face fontified t) 3 139 (face font-lock-comment-face fontified t) 139 151 (face font-lock-comment-face fontified t) 151 639 (face font-lock-comment-face fontified t) 639 645 (face font-lock-comment-face fontified t) 645 706 (face font-lock-comment-face fontified t) 706 717 (face font-lock-comment-face fontified t) 717 739 (face font-lock-comment-face fontified t) 739 1323 (face font-lock-comment-face fontified t) 1323 1335 (face font-lock-comment-face fontified t) 1335 1402 (face font-lock-comment-face fontified t) 1402 1424 (face font-lock-comment-face fontified t) 1424 2108 (face font-lock-comment-face fontified t) 2108 2110 (face font-lock-comment-delimiter-face fontified t) 2110 2111 (fontified t)) . -20883) (undo-tree-id17 . -2111) (undo-tree-id18 . -100) (undo-tree-id19 . -1) (undo-tree-id20 . -739) (undo-tree-id21 . -1472) (undo-tree-id22 . -1472) (undo-tree-id23 . -1561) (undo-tree-id24 . -2111) 22994) nil (26991 10015 233988 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -20882) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) 20883) nil (26991 10015 233982 0) 0 nil])
([nil nil ((20882 . 20883)) nil (26991 10015 233960 0) 0 nil])
([nil current ((#("
#|
(defun extract-error-details (c)
  \"Retourne (values message code) à partir de n'importe quelle condition.\"
  (let ((msg 
         (or
          ;; 1. Si c'est déjà une APPLICATION-ERROR
          (ignore-errors (lumen.core.error:application-error-message c))
          
          ;; 2. Si c'est une DB-ERROR
          (ignore-errors (lumen.data.errors:db-error-message c))
          
          ;; 3. Si c'est votre erreur métier (via introspection dynamique du slot 'message')
          ;; Cela permet de lire l'erreur sans dépendre du système métier
          (ignore-errors (slot-value c 'message)) ;; Supposant que le slot s'appelle 'message'
          
          ;; 4. Si c'est une simple-error standard
          (and (typep c 'simple-condition)
               (simple-condition-format-control c)
               (apply #'format nil (simple-condition-format-control c) 
                      (simple-condition-format-arguments c)))
          
          ;; 5. Fallback ultime
          (format nil \"~A\" c)))
        
        (code
         (or 
          ;; On cherche un slot 'code' (pour QALM ou autre)
          (ignore-errors (slot-value c 'code))
          ;; Ou dans application-error
          (ignore-errors (lumen.core.error:application-error-code c))
          ;; Défaut
          400)))
    
    (values msg code)))
|#
" 0 1 (fontified t) 1 3 (fontified t face font-lock-comment-delimiter-face) 3 1199 (fontified t face font-lock-comment-face) 1199 1335 (face font-lock-comment-face fontified t) 1335 1337 (face font-lock-comment-delimiter-face fontified t) 1337 1338 (fontified t)) . 14883) (undo-tree-id25 . -1338) (undo-tree-id26 . -1053) (t 26991 10015 0 0)) nil (26991 27514 854759 0) 0 nil])
nil
