(undo-tree-save-format-version . 1)
"2ab50e77518ca88e0daa7e7ca2195c4a99d3236a"
[nil nil nil nil (26790 8226 605743 0) 0 nil]
([nil nil ((nil rear-nonsticky nil 1918 . 1919) (nil fontified nil 1 . 1919) (1 . 1919) (t 26790 8226 0 0)) nil (26805 52061 580002 0) 0 nil])
([nil nil ((35 . 38)) nil (26805 52061 580001 0) 0 nil])
([nil nil ((#("(defpackage :lumen.data.migrations
  
  (:use :cl :alexandria)
  (:import-from :lumen.data.db :with-db :exec :query-a)
  (:export
   :defmigration
   :ensure-meta!
   :applied-versions
   :migrate-up-to
   :migrate-all
   :rollback-one))

(in-package :lumen.data.migrations)

(defvar *registry* (make-hash-table :test 'equal))

(defmacro defmigration (version &key up down)
  \"VERSION = string ou integer horodaté. UP/DOWN = forms s'exécutant dans (with-db ...).\"
  `(setf (gethash (format nil \"~A\" ,version) *registry*)
         (list :up (lambda () (with-db ,up))
               :down (lambda () (with-db ,down)))))

(defun ensure-meta! ()
  (with-db
    (exec \"CREATE TABLE IF NOT EXISTS schema_migrations (version text primary key, applied_at timestamptz not null default now())\")))

(defun applied-versions ()
  (with-db
    (mapcar (lambda (a) (cdr (assoc :version a)))
            (query-a \"SELECT version FROM schema_migrations ORDER BY version\"))))

(defun %apply! (version dir)
  (let* ((entry (gethash version *registry*)))
    (unless entry (error \"Migration ~A introuvable.\" version))
    (ecase dir
      (:up   (funcall (getf entry :up))
             (exec \"INSERT INTO schema_migrations(version) VALUES($1)\" version))
      (:down (funcall (getf entry :down))
             (exec \"DELETE FROM schema_migrations WHERE version = $1\" version)))))

(defun migrate-up-to (&optional target)
  (ensure-meta!)
  (let* ((have (applied-versions))
         (all  (sort (loop for k being the hash-keys of *registry* collect k) #'string<))
         (todo (remove-if (lambda (v) (member v have :test #'string=)) all)))
    (dolist (v todo)
      (when (or (null target) (string<= v target))
        (%apply! v :up)))))

(defun migrate-all ()
  (migrate-up-to nil))

(defun rollback-one ()
  (ensure-meta!)
  (let* ((have (applied-versions))
         (last (car (last have))))
    (when last (%apply! last :down) last)))
" 0 1 (fontified t) 1 11 (face font-lock-keyword-face fontified t) 11 12 (fontified t) 12 34 (face font-lock-type-face fontified t) 34 37 (fontified t) 37 38 (fontified t) 38 41 (fontified t) 41 45 (face font-lock-builtin-face fontified t) 45 46 (fontified t) 46 49 (face font-lock-builtin-face fontified t) 49 50 (fontified t) 50 61 (face font-lock-builtin-face fontified t) 61 66 (fontified t) 66 78 (face font-lock-builtin-face fontified t) 78 79 (fontified t) 79 93 (face font-lock-builtin-face fontified t) 93 94 (fontified t) 94 102 (face font-lock-builtin-face fontified t) 102 103 (fontified t) 103 108 (face font-lock-builtin-face fontified t) 108 109 (fontified t) 109 117 (face font-lock-builtin-face fontified t) 117 122 (fontified t) 122 129 (face font-lock-builtin-face fontified t) 129 133 (fontified t) 133 146 (face font-lock-builtin-face fontified t) 146 150 (fontified t) 150 163 (face font-lock-builtin-face fontified t) 163 167 (fontified t) 167 184 (face font-lock-builtin-face fontified t) 184 188 (fontified t) 188 202 (face font-lock-builtin-face fontified t) 202 206 (fontified t) 206 218 (face font-lock-builtin-face fontified t) 218 222 (fontified t) 222 235 (face font-lock-builtin-face fontified t) 235 240 (fontified t) 240 250 (face font-lock-keyword-face fontified t) 250 251 (fontified t) 251 273 (face font-lock-builtin-face fontified t) 273 277 (fontified t) 277 283 (face font-lock-keyword-face fontified t) 283 284 (fontified t) 284 294 (face font-lock-variable-name-face fontified t) 294 312 (fontified t) 312 317 (face font-lock-builtin-face fontified t) 317 329 (fontified t) 329 337 (face font-lock-keyword-face fontified t) 337 338 (fontified t) 338 350 (face font-lock-function-name-face fontified t) 350 360 (fontified t) 360 364 (face font-lock-type-face fontified t) 364 376 (fontified t) 376 463 (face font-lock-doc-face fontified t) 463 494 (fontified t) 494 498 (face font-lock-string-face fontified t) 498 536 (fontified t) 536 539 (face font-lock-builtin-face fontified t) 539 541 (fontified t) 541 547 (face font-lock-keyword-face fontified t) 547 552 (fontified t) 552 559 (face font-lock-keyword-face fontified t) 559 581 (fontified t) 581 586 (face font-lock-builtin-face fontified t) 586 588 (fontified t) 588 594 (face font-lock-keyword-face fontified t) 594 599 (fontified t) 599 606 (face font-lock-keyword-face fontified t) 606 620 (fontified t) 620 625 (face font-lock-keyword-face fontified t) 625 626 (fontified t) 626 638 (face font-lock-function-name-face fontified t) 638 645 (fontified t) 645 652 (face font-lock-keyword-face fontified t) 652 663 (fontified t) 663 783 (face font-lock-string-face fontified t) 783 789 (fontified t) 789 794 (face font-lock-keyword-face fontified t) 794 795 (fontified t) 795 811 (face font-lock-function-name-face fontified t) 811 818 (fontified t) 818 825 (face font-lock-keyword-face fontified t) 825 839 (fontified t) 839 845 (face font-lock-keyword-face fontified t) 845 862 (fontified t) 862 870 (face font-lock-builtin-face fontified t) 870 897 (fontified t) 897 953 (face font-lock-string-face fontified t) 953 960 (fontified t) 960 965 (face font-lock-keyword-face fontified t) 965 966 (fontified t) 966 973 (face font-lock-function-name-face fontified t) 973 991 (fontified t) 991 995 (face font-lock-keyword-face fontified t) 995 1040 (fontified t) 1040 1046 (face font-lock-keyword-face fontified t) 1046 1054 (fontified t) 1054 1059 (face font-lock-warning-face fontified t) 1059 1060 (fontified t) 1060 1087 (face font-lock-string-face fontified t) 1087 1103 (fontified t) 1103 1108 (face font-lock-keyword-face fontified t) 1108 1120 (fontified t) 1120 1123 (face font-lock-builtin-face fontified t) 1123 1147 (fontified t) 1147 1150 (face font-lock-builtin-face fontified t) 1150 1172 (fontified t) 1172 1223 (face font-lock-string-face fontified t) 1223 1241 (fontified t) 1241 1246 (face font-lock-builtin-face fontified t) 1246 1268 (fontified t) 1268 1273 (face font-lock-builtin-face fontified t) 1273 1295 (fontified t) 1295 1345 (face font-lock-string-face fontified t) 1345 1360 (fontified t) 1360 1361 (fontified t) 1361 1366 (face font-lock-keyword-face fontified t) 1366 1367 (fontified t) 1367 1380 (face font-lock-function-name-face fontified t) 1380 1382 (fontified t) 1382 1391 (face font-lock-type-face fontified t) 1391 1420 (fontified t) 1420 1424 (face font-lock-keyword-face fontified t) 1424 1474 (fontified t) 1474 1478 (face font-lock-keyword-face fontified t) 1478 1503 (fontified t) 1503 1538 (fontified t) 1538 1542 (fontified t) 1542 1569 (fontified t) 1569 1575 (face font-lock-keyword-face fontified t) 1575 1595 (fontified t) 1595 1600 (face font-lock-builtin-face fontified t) 1600 1625 (fontified t) 1625 1631 (face font-lock-keyword-face fontified t) 1631 1648 (fontified t) 1648 1652 (face font-lock-keyword-face fontified t) 1652 1711 (fontified t) 1711 1714 (face font-lock-builtin-face fontified t) 1714 1722 (fontified t) 1722 1727 (face font-lock-keyword-face fontified t) 1727 1728 (fontified t) 1728 1739 (face font-lock-function-name-face fontified t) 1739 1768 (fontified t) 1768 1773 (face font-lock-keyword-face fontified t) 1773 1774 (fontified t) 1774 1786 (face font-lock-function-name-face fontified t) 1786 1810 (fontified t) 1810 1814 (face font-lock-keyword-face fontified t) 1814 1882 (fontified t) 1882 1886 (face font-lock-keyword-face fontified t) 1886 1906 (fontified t) 1906 1911 (face font-lock-builtin-face fontified t) 1911 1920 (fontified t) 1920 1921 (fontified t rear-nonsticky t)) . 1) (undo-tree-id0 . -1921) (undo-tree-id1 . -981) (undo-tree-id2 . -981)) nil (26805 52061 579999 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6363 . 6364) (nil fontified nil 1 . 6364) (1 . 6364)) nil (26805 52061 579977 0) 0 nil])
([nil nil ((66 . 69) (t 26805 52061 0 0)) nil (26807 9387 329141 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 154 . 155) (nil fontified nil 154 . 155) (nil fontified nil 136 . 154) (nil fontified nil 135 . 136) (nil fontified nil 126 . 135) (nil fontified nil 125 . 126) (nil fontified nil 117 . 125) (nil fontified nil 116 . 117) (nil fontified nil 111 . 116) (nil fontified nil 110 . 111) (nil fontified nil 102 . 110) (nil fontified nil 97 . 102) (nil fontified nil 83 . 97) (nil fontified nil 82 . 83) (nil fontified nil 70 . 82) (nil fontified nil 69 . 70) (69 . 155)) nil (26807 9387 329140 0) 0 nil])
([nil nil ((#("data.db" 0 7 (face font-lock-builtin-face fontified t)) . -90) (undo-tree-id1 . -7) 97) nil (26807 9387 329138 0) 0 nil])
([nil nil ((90 . 95)) nil (26807 9387 329135 0) 0 nil])
([nil nil ((#("with-tx :exec :query-a :query-1a :ensure-connection" 0 7 (face font-lock-builtin-face fontified t) 7 8 (fontified t) 8 13 (face font-lock-builtin-face fontified t) 13 14 (fontified t) 14 22 (face font-lock-builtin-face fontified t) 22 23 (fontified t) 23 32 (face font-lock-builtin-face fontified t) 32 33 (fontified t) 33 51 (face font-lock-builtin-face fontified t)) . -101) (undo-tree-id0 . -51) 152) nil (26807 9387 329134 0) 0 nil])
([nil nil ((101 . 107)) nil (26807 9387 329119 0) 0 nil])
([nil nil ((107 . 116)) nil (26807 9387 329115 0) 0 nil])
([nil nil ((#("i" 0 1 (face font-lock-builtin-face fontified t)) . -104) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (#("n" 0 1 (face font-lock-builtin-face fontified t)) . -105) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (#("g" 0 1 (face font-lock-builtin-face fontified t)) . -106) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) 107 (t 26807 9387 0 0)) nil (26807 18915 962176 0) 0 nil])
([nil nil ((2538 . 2541) (t 26807 18915 0 0)) nil (26807 57436 338651 0) 0 nil])
([nil nil ((2541 . 2547)) nil (26807 57436 338650 0) 0 nil])
([nil nil ((2547 . 2548)) nil (26807 57436 338650 0) 0 nil])
([nil nil ((2548 . 2556)) nil (26807 57436 338649 0) 0 nil])
([nil nil ((#("à" 0 1 (fontified t)) . -2555) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) 2556) nil (26807 57436 338648 0) 0 nil])
([nil nil ((2555 . 2556)) nil (26807 57436 338632 0) 0 nil])
([nil nil ((1682 . 1689) (t 26807 57436 0 0)) nil (26807 58586 167359 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1764 . 1765) (nil fontified nil 1689 . 1765) (1689 . 1765)) nil (26807 58586 167356 0) 0 nil])
([nil nil ((2171 . 2174) (t 26807 58586 0 0)) nil (26807 58731 258922 0) 0 nil])
([nil nil ((2174 . 2180)) nil (26807 58731 258921 0) 0 nil])
([nil nil ((2180 . 2181)) nil (26807 58731 258921 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2195 . 2196) (nil fontified nil 2181 . 2196) (2181 . 2196)) nil (26807 58731 258920 0) 0 nil])
([nil nil ((2196 . 2197)) nil (26807 58731 258916 0) 0 nil])
([nil nil ((#("
  (print \"OKKKK\")" 0 10 (fontified t) 10 17 (face font-lock-string-face fontified t) 17 18 (fontified t)) . 2647) (undo-tree-id0 . -18) (undo-tree-id1 . -1) (undo-tree-id2 . -18) (undo-tree-id3 . -18) (undo-tree-id4 . -18) (undo-tree-id5 . -18) (undo-tree-id6 . -18) (undo-tree-id7 . -18) (undo-tree-id8 . -18) (undo-tree-id9 . -18) (undo-tree-id10 . -18) (undo-tree-id11 . -18) (undo-tree-id12 . -18) (undo-tree-id13 . -18) (undo-tree-id14 . -18) (t 26807 58731 0 0)) nil (26807 59778 737493 0) 0 nil])
([nil nil ((1622 . 1624) (t 26807 59778 0 0)) nil (26807 63056 299892 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2098 . 2099) (nil fontified nil 1624 . 2099) (1624 . 2099)) nil (26807 63056 299892 0) 0 nil])
([nil nil ((#("
(defmacro defmigration (version &key up down)
  \"Déclare une migration `version`. `up` et `down` sont des forms exécutables.\"
  (let ((vsym (gensym \"VER\")))
    `(eval-when (:compile-toplevel :load-toplevel :execute)
       (let ((,vsym (%to-version-string ,version)))
         (%push-migration!
          (make-migration :version ,vsym :up-forms '(progn ,@up) :down-forms '(progn ,@down)))))))
" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 23 (face font-lock-function-name-face fontified t) 23 33 (fontified t) 33 37 (face font-lock-type-face fontified t) 37 49 (fontified t) 49 126 (face font-lock-doc-face fontified t) 126 130 (fontified t) 130 133 (face font-lock-keyword-face fontified t) 133 149 (fontified t) 149 154 (face font-lock-string-face fontified t) 154 164 (fontified t) 164 173 (face font-lock-keyword-face fontified t) 173 175 (fontified t) 175 192 (face font-lock-builtin-face fontified t) 192 193 (fontified t) 193 207 (face font-lock-builtin-face fontified t) 207 208 (fontified t) 208 216 (face font-lock-builtin-face fontified t) 216 226 (fontified t) 226 229 (face font-lock-keyword-face fontified t) 229 274 (fontified t) 274 297 (fontified t) 297 323 (fontified t) 323 331 (face font-lock-builtin-face fontified t) 331 338 (fontified t) 338 347 (face font-lock-builtin-face fontified t) 347 350 (fontified t) 350 355 (face font-lock-keyword-face fontified t) 355 362 (fontified t) 362 373 (face font-lock-builtin-face fontified t) 373 376 (fontified t) 376 381 (face font-lock-keyword-face fontified t) 381 396 (fontified t)) . 1227) (undo-tree-id20 . -396)) nil (26807 63056 299891 0) 0 nil])
([nil nil ((1703 . 1705)) nil (26807 63056 299890 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2165 . 2166) (nil fontified nil 1705 . 2166) (1705 . 2166)) nil (26807 63056 299890 0) 0 nil])
([nil nil ((3404 . 3406)) nil (26807 63056 299889 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5484 . 5485) (nil fontified nil 3406 . 5485) (3406 . 5485)) nil (26807 63056 299889 0) 0 nil])
([nil nil ((3452 . 3455)) nil (26807 63056 299888 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3529 . 3530) (nil fontified nil 3455 . 3530) (3455 . 3530)) nil (26807 63056 299887 0) 0 nil])
([nil nil ((#("

(defun migrate-up-to (target &key (verbose t))
  \"Monte/descend l’état des migrations jusqu’à `target` (string ou integer).\"
  (%ensure-table!)
  (let* ((tgt (%to-version-string target))
         (applied (%applied-versions))
         (applied-set (alexandria:alist-hash-table (mapcar (lambda (v) (cons v t)) applied)
                                                   :test #'equal))
         (all (loop for i below (length *registry*) collect (aref *registry* i)))
         (to-up   (remove-if (lambda (m)
                               (or (gethash (migration-version m) applied-set)
                                   (string< tgt (migration-version m))))
                             all))
         (to-down (remove-if-not (lambda (m)
                                   (and (gethash (migration-version m) applied-set)
                                        (string< tgt (migration-version m))))
                                 all)))
    ;; UP: dans l’ordre croissant
    (dolist (m (sort to-up (lambda (a b) (string< (migration-version a)
                                                  (migration-version b)))))
      (when verbose (format t \"~&[migrations] ↑ applying ~A...~%\" (migration-version m)))
      (with-tx ()
        (eval (migration-up-forms m))
        (exec \"INSERT INTO schema_migrations(version) VALUES ($1)\" (migration-version m)))
      (when verbose (format t \"[migrations] OK ~A~%\" (migration-version m))))
    ;; DOWN: dans l’ordre décroissant
    (dolist (m (sort to-down (lambda (a b) (string> (migration-version a)
                                                    (migration-version b)))))
      (when verbose (format t \"~&[migrations] ↓ rolling back ~A...~%\" (migration-version m)))
      (with-tx ()
        (let ((down (migration-down-forms m)))
          (when (and (null down)) (error \"Migration ~A has no DOWN.\" (migration-version m)))
          (eval down))
        (exec \"DELETE FROM schema_migrations WHERE version=$1\" (migration-version m)))
      (when verbose (format t \"[migrations] ROLLBACK OK ~A~%\" (migration-version m))))
    (values (length to-up) (length to-down))))" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-function-name-face fontified t) 22 31 (fontified t) 31 35 (face font-lock-type-face fontified t) 35 51 (fontified t) 51 126 (face font-lock-doc-face fontified t) 126 149 (fontified t) 149 153 (face font-lock-keyword-face fontified t) 153 255 (fontified t) 255 263 (fontified t) 263 288 (fontified t) 288 294 (face font-lock-keyword-face fontified t) 294 320 (fontified t) 320 371 (fontified t) 371 376 (face font-lock-builtin-face fontified t) 376 386 (fontified t) 386 387 (fontified t) 387 402 (fontified t) 402 406 (face font-lock-keyword-face fontified t) 406 414 (fontified t) 414 469 (fontified t) 469 499 (fontified t) 499 505 (face font-lock-keyword-face fontified t) 505 731 (fontified t) 731 737 (face font-lock-keyword-face fontified t) 737 789 (fontified t) 789 820 (fontified t) 820 826 (fontified t) 826 948 (fontified t) 948 951 (face font-lock-comment-delimiter-face fontified t) 951 978 (face font-lock-comment-face fontified t) 978 983 (fontified t) 983 989 (face font-lock-keyword-face fontified t) 989 1000 (fontified t) 1000 1006 (fontified t) 1006 1012 (face font-lock-keyword-face fontified t) 1012 1050 (fontified t) 1050 1133 (fontified t) 1133 1137 (face font-lock-keyword-face fontified t) 1137 1156 (fontified t) 1156 1191 (face font-lock-string-face fontified t) 1191 1223 (fontified t) 1223 1230 (face font-lock-keyword-face fontified t) 1230 1286 (fontified t) 1286 1288 (face font-lock-string-face fontified t) 1288 1338 (face font-lock-string-face fontified t) 1338 1363 (fontified t) 1363 1370 (fontified t) 1370 1374 (face font-lock-keyword-face fontified t) 1374 1393 (fontified t) 1393 1415 (face font-lock-string-face fontified t) 1415 1445 (fontified t) 1445 1448 (face font-lock-comment-delimiter-face fontified t) 1448 1479 (face font-lock-comment-face fontified t) 1479 1484 (fontified t) 1484 1490 (face font-lock-keyword-face fontified t) 1490 1501 (fontified t) 1501 1509 (fontified t) 1509 1515 (face font-lock-keyword-face fontified t) 1515 1553 (fontified t) 1553 1638 (fontified t) 1638 1642 (face font-lock-keyword-face fontified t) 1642 1661 (fontified t) 1661 1700 (face font-lock-string-face fontified t) 1700 1732 (fontified t) 1732 1739 (face font-lock-keyword-face fontified t) 1739 1752 (fontified t) 1752 1755 (face font-lock-keyword-face fontified t) 1755 1801 (fontified t) 1801 1805 (face font-lock-keyword-face fontified t) 1805 1820 (fontified t) 1820 1825 (fontified t) 1825 1830 (face font-lock-warning-face fontified t) 1830 1831 (fontified t) 1831 1858 (face font-lock-string-face fontified t) 1858 1883 (fontified t) 1883 1920 (fontified t) 1920 1968 (face font-lock-string-face fontified t) 1968 2000 (fontified t) 2000 2004 (face font-lock-keyword-face fontified t) 2004 2023 (fontified t) 2023 2054 (face font-lock-string-face fontified t) 2054 2126 (fontified t)) . 5563) (undo-tree-id15 . -2126) (undo-tree-id16 . -1) (undo-tree-id17 . -1215) (undo-tree-id18 . -75) (undo-tree-id19 . -75)) nil (26807 63056 299885 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 5563)) nil (26807 63056 299872 0) 0 nil])
([nil nil ((#("fn" 0 2 (face font-lock-builtin-face fontified t)) . -1664) (undo-tree-id35 . -2) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -2) (undo-tree-id43 . -2) (undo-tree-id44 . -2) (undo-tree-id45 . -2) (undo-tree-id46 . -2) (undo-tree-id47 . -2) (undo-tree-id48 . -2) (undo-tree-id49 . -2) 1666 (t 26807 63056 0 0)) nil (26807 63141 945621 0) 0 nil])
([nil nil ((1664 . 1669)) nil (26807 63141 945610 0) 0 nil])
([nil nil ((#("fn" 0 2 (face font-lock-builtin-face fontified t)) . -1691) (undo-tree-id21 . -2) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -2) (undo-tree-id28 . -2) (undo-tree-id29 . -2) (undo-tree-id30 . -2) (undo-tree-id31 . -2) (undo-tree-id32 . -2) (undo-tree-id33 . -2) (undo-tree-id34 . -2) 1693) nil (26807 63141 945608 0) 0 nil])
([nil nil ((1691 . 1696)) nil (26807 63141 945536 0) 0 nil])
([nil nil ((#("register-migration" 0 18 (fontified t)) . -1585) (undo-tree-id50 . -18) (undo-tree-id51 . -8) (undo-tree-id52 . -8) (undo-tree-id53 . -8) (undo-tree-id54 . -8) (undo-tree-id55 . -8) (undo-tree-id56 . -18) (undo-tree-id57 . -18) (undo-tree-id58 . -18) (undo-tree-id59 . -18) (undo-tree-id60 . -18) (undo-tree-id61 . -18) (undo-tree-id62 . -18) (undo-tree-id63 . -18) 1603 (t 26807 63141 0 0)) nil (26807 63166 947363 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1600 . 1601) (nil fontified nil 1585 . 1601) (1585 . 1601)) nil (26807 63166 947341 0) 0 nil])
([nil nil ((4591 . 4593) (t 26807 63166 0 0)) nil (26807 63282 692426 0) 0 nil])
([nil nil ((4593 . 4599)) nil (26807 63282 692425 0) 0 nil])
([nil nil ((4599 . 4600)) nil (26807 63282 692425 0) 0 nil])
([nil nil ((4600 . 4603)) nil (26807 63282 692425 0) 0 nil])
([nil nil ((4603 . 4604)) nil (26807 63282 692424 0) 0 nil])
([nil nil ((4604 . 4607)) nil (26807 63282 692424 0) 0 nil])
([nil nil ((4648 . 4652)) nil (26807 63282 692424 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4665 . 4666) (nil fontified nil 4665 . 4666) (nil fontified nil 4659 . 4665) (nil fontified nil 4652 . 4659) (4652 . 4666)) nil (26807 63282 692423 0) 0 nil])
([nil nil ((#("0" 0 1 (face font-lock-string-face fontified t)) . -4663) (undo-tree-id64 . -1) 4664) nil (26807 63282 692421 0) 0 nil])
([nil nil ((4663 . 4664)) nil (26807 63282 692408 0) 0 nil])
([nil nil ((1733 . 1736) (t 26807 63282 0 0)) nil (26807 63359 570367 0) 0 nil])
([nil nil ((1736 . 1742)) nil (26807 63359 570367 0) 0 nil])
([nil nil ((1742 . 1743)) nil (26807 63359 570366 0) 0 nil])
([nil nil ((1743 . 1746)) nil (26807 63359 570366 0) 0 nil])
([nil nil ((1746 . 1747)) nil (26807 63359 570366 0) 0 nil])
([nil nil ((1747 . 1750)) nil (26807 63359 570365 0) 0 nil])
([nil nil ((1791 . 1792)) nil (26807 63359 570365 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1805 . 1806) (nil fontified nil 1805 . 1806) (nil fontified nil 1799 . 1805) (nil fontified nil 1792 . 1799) (1792 . 1806)) nil (26807 63359 570365 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-string-face fontified t)) . -1803) (undo-tree-id75 . -1) (undo-tree-id76 . -1) (undo-tree-id77 . -1) (undo-tree-id78 . -1) 1804) nil (26807 63359 570364 0) 0 nil])
([nil nil ((1803 . 1804)) nil (26807 63359 570361 0) 0 nil])
([nil nil ((1864 . 1865)) nil (26807 63359 570361 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1878 . 1879) (nil fontified nil 1878 . 1879) (nil fontified nil 1872 . 1878) (nil fontified nil 1865 . 1872) (1865 . 1879)) nil (26807 63359 570360 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-string-face fontified t)) . -1876) (undo-tree-id72 . -1) (undo-tree-id73 . -1) (undo-tree-id74 . -1) 1877) nil (26807 63359 570359 0) 0 nil])
([nil nil ((1876 . 1877)) nil (26807 63359 570357 0) 0 nil])
([nil nil ((1902 . 1906)) nil (26807 63359 570356 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1919 . 1920) (nil fontified nil 1919 . 1920) (nil fontified nil 1913 . 1919) (nil fontified nil 1906 . 1913) (1906 . 1920)) nil (26807 63359 570356 0) 0 nil])
([nil nil ((#("2" 0 1 (face font-lock-string-face fontified t)) . -1917) (undo-tree-id65 . -1) (undo-tree-id66 . -1) (undo-tree-id67 . -1) (undo-tree-id68 . -1) (undo-tree-id69 . -1) (undo-tree-id70 . -1) (undo-tree-id71 . -1) 1918) nil (26807 63359 570354 0) 0 nil])
([nil nil ((1917 . 1918)) nil (26807 63359 570339 0) 0 nil])
([nil nil ((1772 . 1778) (t 26807 63359 0 0)) nil (26807 63434 841617 0) 0 nil])
([nil nil ((1778 . 1779)) nil (26807 63434 841617 0) 0 nil])
([nil nil ((1814 . 1815)) nil (26807 63434 841617 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1856 . 1857) (nil fontified nil 1856 . 1857) (nil fontified nil 1851 . 1856) (nil fontified nil 1850 . 1851) (1850 . 1857)) nil (26807 63434 841616 0) 0 nil])
([nil nil ((1857 . 1858)) nil (26807 63434 841615 0) 0 nil])
([nil nil ((1898 . 1899)) nil (26807 63434 841614 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -1857) (undo-tree-id79 . -1) (undo-tree-id80 . -1) (undo-tree-id81 . -1) (undo-tree-id82 . -1) (undo-tree-id83 . -1) (undo-tree-id84 . -1) (undo-tree-id85 . -1) (undo-tree-id86 . -1) (undo-tree-id87 . -1) (undo-tree-id88 . -1) (undo-tree-id89 . -1) 1858) nil (26807 63434 841611 0) 0 nil])
([nil nil ((1898 . 1900) (t 26807 63434 0 0)) nil (26807 63446 61686 0) 0 nil])
([nil nil ((1900 . 1906)) nil (26807 63446 61686 0) 0 nil])
([nil nil ((1906 . 1907)) nil (26807 63446 61685 0) 0 nil])
([nil nil ((1907 . 1913)) nil (26807 63446 61681 0) 0 nil])
([nil nil ((#("n" 0 1 (fontified t)) . -1794) (undo-tree-id92 . -1) 1795 (t 26807 63446 0 0)) nil (26807 63554 678513 0) 0 nil])
([nil nil ((1794 . 1798)) nil (26807 63554 678512 0) 0 nil])
([nil nil ((#("orms" 0 4 (fontified t)) . -1794) (undo-tree-id91 . -4) 1798) nil (26807 63554 678511 0) 0 nil])
([nil nil ((1794 . 1795)) nil (26807 63554 678509 0) 0 nil])
([nil nil ((#("b" 0 1 (fontified t)) . -1794) (undo-tree-id90 . -1) 1795) nil (26807 63554 678509 0) 0 nil])
([nil nil ((1794 . 1795)) nil (26807 63554 678500 0) 0 nil])
([nil nil ((1750 . 1753)) nil (26807 63554 678500 0) 0 nil])
([nil nil ((1753 . 1759)) nil (26807 63554 678499 0) 0 nil])
([nil nil ((1759 . 1760)) nil (26807 63554 678499 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1781 . 1782) (nil fontified nil 1760 . 1782) (1760 . 1782)) nil (26807 63554 678498 0) 0 nil])
([nil nil ((1782 . 1783)) nil (26807 63554 678493 0) 0 nil])
([nil nil ((#("(progn " 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t rear-nonsticky t)) . -1883) (undo-tree-id112 . -7) (undo-tree-id113 . -7) (undo-tree-id114 . -6) (undo-tree-id115 . -6) (undo-tree-id116 . -6) (undo-tree-id117 . -6) (undo-tree-id118 . -7) (undo-tree-id119 . -7) (undo-tree-id120 . -7) (undo-tree-id121 . -7) (undo-tree-id122 . -7) (undo-tree-id123 . -7) 1890 (t 26807 63554 0 0)) nil (26807 63619 161835 0) 0 nil])
([nil nil ((#(" (print \"OK 4\")" 0 1 (fontified t) 1 8 (fontified t) 8 14 (face font-lock-string-face fontified t) 14 15 (fontified t rear-nonsticky t)) . -1905) (undo-tree-id104 . -15) (undo-tree-id105 . -1) (undo-tree-id106 . -15) (undo-tree-id107 . -15) (undo-tree-id108 . -15) (undo-tree-id109 . -15) (undo-tree-id110 . -15) (undo-tree-id111 . -15) 1920) nil (26807 63619 161825 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -1908) (undo-tree-id93 . -1) (undo-tree-id94 . -1) (undo-tree-id95 . -1) (undo-tree-id96 . -1) (undo-tree-id97 . -1) (undo-tree-id98 . -1) (undo-tree-id99 . -1) (undo-tree-id100 . -1) (undo-tree-id101 . -1) (undo-tree-id102 . -1) (undo-tree-id103 . -1) 1909) nil (26807 63619 161818 0) 0 nil])
([nil nil ((1910 . 1912) (t 26807 63619 0 0)) nil (26807 63991 51530 0) 0 nil])
([nil nil ((1783 . 1786) (t 26807 63991 0 0)) nil (26808 1881 506311 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1799 . 1800) (nil fontified nil 1799 . 1800) (nil fontified nil 1793 . 1799) (nil fontified nil 1786 . 1793) (1786 . 1800)) nil (26808 1881 506310 0) 0 nil])
([nil nil ((1798 . 1799)) nil (26808 1881 506309 0) 0 nil])
([nil nil ((#("&" 0 1 (face font-lock-string-face fontified t)) . -1798) (undo-tree-id124 . -1) 1799) nil (26808 1881 506308 0) 0 nil])
([nil nil ((1798 . 1799)) nil (26808 1881 506297 0) 0 nil])
([nil nil ((#("(print \"OK 3\")" 0 7 (fontified t) 7 13 (face font-lock-string-face fontified t) 13 14 (fontified t rear-nonsticky t)) . 1850) (undo-tree-id127 . -14) 1864 (t 26808 1881 0 0)) nil (26808 1958 73526 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -1849) (undo-tree-id125 . -1) (undo-tree-id126 . -1) 1850) nil (26808 1958 73524 0) 0 nil])
([nil nil ((nil fontified nil 1843 . 1844) (nil fontified nil 1837 . 1843) (nil fontified nil 1830 . 1837) (1830 . 1844)) nil (26808 1958 73515 0) 0 nil])
([nil nil ((1844 . 1845)) nil (26808 1958 73515 0) 0 nil])
([nil nil ((2080 . 2086)) nil (26808 1958 73514 0) 0 nil])
([nil nil ((2086 . 2087)) nil (26808 1958 73513 0) 0 nil])
([nil nil ((2100 . 2101)) nil (26808 1958 73509 0) 0 nil])
([nil nil ((#("@" 0 1 (fontified t)) . 2088) (t 26808 1958 0 0)) nil (26808 2042 673251 0) 0 nil])
([nil nil ((#("progn" 0 5 (face font-lock-keyword-face fontified t)) . -2081) (undo-tree-id140 . -5) 2086) nil (26808 2042 673250 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -2079) (undo-tree-id132 . -1) (undo-tree-id133 . -1) (undo-tree-id134 . -1) (undo-tree-id135 . -1) (undo-tree-id136 . -1) (#("(" 0 1 (fontified t)) . -2080) (undo-tree-id137 . -1) (undo-tree-id138 . -1) (undo-tree-id139 . -1) 2081) nil (26808 2042 673248 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -2092) (undo-tree-id128 . -1) (undo-tree-id129 . -1) (undo-tree-id130 . -1) (undo-tree-id131 . -1) 2093) nil (26808 2042 673240 0) 0 nil])
([nil nil ((4471 . 4476) (t 26808 2042 0 0)) nil (26808 2610 202056 0) 0 nil])
([nil nil ((4476 . 4482)) nil (26808 2610 202055 0) 0 nil])
([nil nil ((4482 . 4483)) nil (26808 2610 202055 0) 0 nil])
([nil nil ((4483 . 4488)) nil (26808 2610 202054 0) 0 nil])
([nil nil ((#("i" 0 1 (fontified t)) . -4487) (undo-tree-id154 . -1) 4488) nil (26808 2610 202054 0) 0 nil])
([nil nil ((4487 . 4489)) nil (26808 2610 202053 0) 0 nil])
([nil nil ((#("d" 0 1 (fontified t)) . -4488) (undo-tree-id153 . -1) 4489) nil (26808 2610 202052 0) 0 nil])
([nil nil ((#("e" 0 1 (fontified t)) . -4487) (undo-tree-id152 . -1) 4488) nil (26808 2610 202051 0) 0 nil])
([nil nil ((4487 . 4491)) nil (26808 2610 202050 0) 0 nil])
([nil nil ((4491 . 4496)) nil (26808 2610 202050 0) 0 nil])
([nil nil ((4496 . 4502)) nil (26808 2610 202050 0) 0 nil])
([nil nil ((4502 . 4503)) nil (26808 2610 202049 0) 0 nil])
([nil nil ((4503 . 4506)) nil (26808 2610 202049 0) 0 nil])
([nil nil ((#("k" 0 1 (fontified t)) . -4504) (undo-tree-id150 . -1) (#("k" 0 1 (fontified t)) . -4505) (undo-tree-id151 . -1) 4506) nil (26808 2610 202048 0) 0 nil])
([nil nil ((4504 . 4507)) nil (26808 2610 202046 0) 0 nil])
([nil nil ((4507 . 4512)) nil (26808 2610 202046 0) 0 nil])
([nil nil ((4512 . 4515)) nil (26808 2610 202046 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -4513) (undo-tree-id148 . -1) (#("o" 0 1 (fontified t)) . -4514) (undo-tree-id149 . -1) 4515) nil (26808 2610 202045 0) 0 nil])
([nil nil ((4513 . 4518)) nil (26808 2610 202043 0) 0 nil])
([nil nil ((4518 . 4519)) nil (26808 2610 202043 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -4514) (undo-tree-id143 . -1) (#("i" 0 1 (fontified t)) . -4515) (undo-tree-id144 . -1) (#("n" 0 1 (fontified t)) . -4516) (undo-tree-id145 . -1) (#("t" 0 1 (fontified t)) . -4517) (undo-tree-id146 . -1) (#(" " 0 1 (fontified t)) . -4518) (undo-tree-id147 . -1) 4519) nil (26808 2610 202042 0) 0 nil])
([nil nil ((4514 . 4515)) nil (26808 2610 202038 0) 0 nil])
([nil nil ((#("^" 0 1 (fontified t)) . -4513) (undo-tree-id141 . -1) (#("r" 0 1 (fontified t)) . -4514) (undo-tree-id142 . -1) 4515) nil (26808 2610 202037 0) 0 nil])
([nil nil ((4513 . 4518)) nil (26808 2610 202023 0) 0 nil])
([nil nil ((4518 . 4519)) nil (26808 2610 202022 0) 0 nil])
([nil nil ((4519 . 4525)) nil (26808 2610 202022 0) 0 nil])
([nil nil ((4525 . 4530)) nil (26808 2610 202021 0) 0 nil])
([nil nil ((4530 . 4536)) nil (26808 2610 202021 0) 0 nil])
([nil nil ((4536 . 4537)) nil (26808 2610 202020 0) 0 nil])
([nil nil ((4537 . 4545)) nil (26808 2610 202015 0) 0 nil])
([nil nil ((#("
    (print applied)
    (print all)
    (print to-up)
    (print to-down)" 0 1 (fontified t) 1 21 (fontified t) 21 37 (fontified t) 37 55 (fontified t) 55 74 (fontified t)) . 4471) (undo-tree-id155 . -74) (undo-tree-id156 . -74) (undo-tree-id157 . -74) (t 26808 2610 0 0)) nil (26808 2794 892037 0) 0 nil])
([nil nil ((3364 . 3369) (t 26808 2794 0 0)) nil (26808 2887 414317 0) 0 nil])
([nil nil ((3369 . 3375)) nil (26808 2887 414317 0) 0 nil])
([nil nil ((3375 . 3376)) nil (26808 2887 414316 0) 0 nil])
([nil nil ((3376 . 3378)) nil (26808 2887 414316 0) 0 nil])
([nil nil ((#("r" 0 1 (fontified t)) . -3377) (undo-tree-id158 . -1) 3378) nil (26808 2887 414314 0) 0 nil])
([nil nil ((3377 . 3383)) nil (26808 2887 414302 0) 0 nil])
([nil nil ((3364 . 3369) (t 26808 2887 0 0)) nil (26808 2901 304842 0) 0 nil])
([nil nil ((3369 . 3375)) nil (26808 2901 304841 0) 0 nil])
([nil nil ((3375 . 3376)) nil (26808 2901 304841 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -3364) (undo-tree-id159 . -1) (undo-tree-id160 . 1) (undo-tree-id161 . -1) (undo-tree-id162 . -1) (undo-tree-id163 . -1) (undo-tree-id164 . -1) (undo-tree-id165 . -1) (undo-tree-id166 . -1) (undo-tree-id167 . -1) (undo-tree-id168 . -1) (undo-tree-id169 . -1) (undo-tree-id170 . -1) (undo-tree-id171 . -1) (undo-tree-id172 . -1) (undo-tree-id173 . -1) (undo-tree-id174 . -1) (undo-tree-id175 . -1) (undo-tree-id176 . -1) (undo-tree-id177 . -1) (undo-tree-id178 . -1) (undo-tree-id179 . -1) (undo-tree-id180 . -1) (undo-tree-id181 . -1) (undo-tree-id182 . -1) (undo-tree-id183 . -1) (undo-tree-id184 . -1) (undo-tree-id185 . -1) (undo-tree-id186 . -1) (undo-tree-id187 . -1) (undo-tree-id188 . -1) (undo-tree-id189 . -1) (undo-tree-id190 . -1) (undo-tree-id191 . -1) (undo-tree-id192 . -1) (undo-tree-id193 . -1) (undo-tree-id194 . -1) (undo-tree-id195 . -1) (undo-tree-id196 . -1) (undo-tree-id197 . -1) (undo-tree-id198 . -1) (#(" " 0 1 (fontified t)) . -3365) (undo-tree-id199 . -1) (undo-tree-id200 . -1) (undo-tree-id201 . -1) (undo-tree-id202 . -1) (undo-tree-id203 . -1) (undo-tree-id204 . -1) (undo-tree-id205 . -1) (undo-tree-id206 . -1) (undo-tree-id207 . -1) (undo-tree-id208 . -1) (undo-tree-id209 . -1) (undo-tree-id210 . -1) (undo-tree-id211 . -1) (undo-tree-id212 . -1) (undo-tree-id213 . -1) (undo-tree-id214 . -1) (undo-tree-id215 . -1) (undo-tree-id216 . -1) (undo-tree-id217 . -1) (undo-tree-id218 . -1) (undo-tree-id219 . -1) (#(" " 0 1 (fontified t)) . -3366) (undo-tree-id220 . -1) (undo-tree-id221 . -1) (undo-tree-id222 . -1) (undo-tree-id223 . -1) (undo-tree-id224 . -1) (undo-tree-id225 . -1) (undo-tree-id226 . -1) (undo-tree-id227 . -1) (undo-tree-id228 . -1) (undo-tree-id229 . -1) (undo-tree-id230 . -1) (undo-tree-id231 . -1) (undo-tree-id232 . -1) (undo-tree-id233 . -1) (undo-tree-id234 . -1) (undo-tree-id235 . -1) (undo-tree-id236 . -1) (undo-tree-id237 . -1) (undo-tree-id238 . -1) (undo-tree-id239 . -1) (undo-tree-id240 . -1) (#(" " 0 1 (fontified nil)) . -3367) (undo-tree-id241 . -1) (undo-tree-id242 . -1) (undo-tree-id243 . -1) (undo-tree-id244 . -1) (undo-tree-id245 . -1) (undo-tree-id246 . -1) (undo-tree-id247 . -1) (undo-tree-id248 . -1) (undo-tree-id249 . -1) (undo-tree-id250 . -1) (undo-tree-id251 . -1) (undo-tree-id252 . -1) (undo-tree-id253 . -1) (undo-tree-id254 . -1) (undo-tree-id255 . -1) (undo-tree-id256 . -1) (undo-tree-id257 . -1) (undo-tree-id258 . -1) (undo-tree-id259 . -1) (undo-tree-id260 . -1) (undo-tree-id261 . -1) (#(" " 0 1 (fontified t)) . -3368) (undo-tree-id262 . -1) (undo-tree-id263 . -1) (undo-tree-id264 . -1) (undo-tree-id265 . -1) (undo-tree-id266 . -1) (undo-tree-id267 . -1) (undo-tree-id268 . -1) (undo-tree-id269 . -1) (undo-tree-id270 . -1) (undo-tree-id271 . -1) (undo-tree-id272 . -1) (undo-tree-id273 . -1) (undo-tree-id274 . -1) (undo-tree-id275 . -1) (undo-tree-id276 . -1) (undo-tree-id277 . -1) (undo-tree-id278 . -1) (undo-tree-id279 . -1) (undo-tree-id280 . -1) (undo-tree-id281 . -1) (undo-tree-id282 . -1) (#("(" 0 1 (fontified t)) . -3369) (undo-tree-id283 . -1) (undo-tree-id284 . -1) (undo-tree-id285 . -1) (undo-tree-id286 . -1) (undo-tree-id287 . -1) (undo-tree-id288 . -1) (undo-tree-id289 . -1) (undo-tree-id290 . -1) (undo-tree-id291 . -1) (undo-tree-id292 . -1) (undo-tree-id293 . -1) (undo-tree-id294 . -1) (undo-tree-id295 . -1) (#("p" 0 1 (fontified t)) . -3370) (undo-tree-id296 . -1) (undo-tree-id297 . -1) (undo-tree-id298 . -1) (undo-tree-id299 . -1) (undo-tree-id300 . -1) (undo-tree-id301 . -1) (undo-tree-id302 . -1) (undo-tree-id303 . -1) (undo-tree-id304 . -1) (undo-tree-id305 . -1) (undo-tree-id306 . -1) (undo-tree-id307 . -1) (undo-tree-id308 . -1) (#("r" 0 1 (fontified t)) . -3371) (undo-tree-id309 . -1) (undo-tree-id310 . -1) (undo-tree-id311 . -1) (undo-tree-id312 . -1) (undo-tree-id313 . -1) (undo-tree-id314 . -1) (undo-tree-id315 . -1) (undo-tree-id316 . -1) (undo-tree-id317 . -1) (undo-tree-id318 . -1) (undo-tree-id319 . -1) (undo-tree-id320 . -1) (undo-tree-id321 . -1) (#("i" 0 1 (fontified t)) . -3372) (undo-tree-id322 . -1) (undo-tree-id323 . -1) (undo-tree-id324 . -1) (undo-tree-id325 . -1) (undo-tree-id326 . -1) (undo-tree-id327 . -1) (undo-tree-id328 . -1) (undo-tree-id329 . -1) (undo-tree-id330 . -1) (undo-tree-id331 . -1) (undo-tree-id332 . -1) (#("n" 0 1 (fontified t)) . -3373) (undo-tree-id333 . -1) (undo-tree-id334 . -1) (undo-tree-id335 . -1) (undo-tree-id336 . -1) (undo-tree-id337 . -1) (undo-tree-id338 . -1) (undo-tree-id339 . -1) (undo-tree-id340 . -1) (undo-tree-id341 . -1) (#("t" 0 1 (fontified t)) . -3374) (undo-tree-id342 . -1) (undo-tree-id343 . -1) (undo-tree-id344 . -1) (undo-tree-id345 . -1) (undo-tree-id346 . -1) (undo-tree-id347 . -1) (undo-tree-id348 . -1) (undo-tree-id349 . -1) (undo-tree-id350 . -1) (#(" " 0 1 (fontified t)) . -3375) (undo-tree-id351 . -1) (undo-tree-id352 . -1) (undo-tree-id353 . -1) (undo-tree-id354 . -1) (undo-tree-id355 . -1) (undo-tree-id356 . -1) (undo-tree-id357 . -1) 3376) nil (26808 2901 304835 0) 0 nil])
([nil nil ((3383 . 3388)) nil (26808 2901 304722 0) 0 nil])
([nil nil ((3388 . 3394)) nil (26808 2901 304721 0) 0 nil])
([nil nil ((3394 . 3395)) nil (26808 2901 304720 0) 0 nil])
([nil nil ((3395 . 3401)) nil (26808 2901 304716 0) 0 nil])
([nil nil ((4508 . 4513) (t 26808 2901 0 0)) nil (26808 3033 324760 0) 0 nil])
([nil nil ((4513 . 4519)) nil (26808 3033 324759 0) 0 nil])
([nil nil ((4519 . 4520)) nil (26808 3033 324759 0) 0 nil])
([nil nil ((4520 . 4523)) nil (26808 3033 324759 0) 0 nil])
([nil nil ((4523 . 4524)) nil (26808 3033 324758 0) 0 nil])
([nil nil ((4524 . 4528)) nil (26808 3033 324758 0) 0 nil])
([nil nil ((4528 . 4533)) nil (26808 3033 324758 0) 0 nil])
([nil nil ((4533 . 4534)) nil (26808 3033 324757 0) 0 nil])
([nil nil ((#("'" 0 1 (fontified t)) . -4533) (undo-tree-id358 . -1) (undo-tree-id359 . -1) (undo-tree-id360 . -1) (undo-tree-id361 . -1) (undo-tree-id362 . -1) 4534) nil (26808 3033 324756 0) 0 nil])
([nil nil ((4533 . 4539)) nil (26808 3033 324745 0) 0 nil])
([nil nil ((4539 . 4540)) nil (26808 3033 324744 0) 0 nil])
([nil nil ((4540 . 4546)) nil (26808 3033 324740 0) 0 nil])
([nil nil ((4683 . 4690) (t 26808 3033 0 0)) nil (26808 3358 65436 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . -4683) (undo-tree-id365 . -1) (#(" " 0 1 (fontified t)) . -4684) (undo-tree-id366 . -1) (#(" " 0 1 (fontified t)) . -4685) (undo-tree-id367 . -1) (#(" " 0 1 (fontified t)) . -4686) (undo-tree-id368 . -1) (#(" " 0 1 (fontified t)) . -4687) (undo-tree-id369 . -1) (#(" " 0 1 (fontified t)) . -4688) (undo-tree-id370 . -1) (#(" " 0 1 (fontified t)) . -4689) (undo-tree-id371 . -1) 4690) nil (26808 3358 65434 0) 0 nil])
([nil nil ((4546 . 4551)) nil (26808 3358 65429 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4563 . 4564) (nil fontified nil 4551 . 4564) (4551 . 4564)) nil (26808 3358 65429 0) 0 nil])
([nil nil ((#("up" 0 2 (fontified t)) . -4561) (undo-tree-id364 . -2) 4563) nil (26808 3358 65428 0) 0 nil])
([nil nil ((4561 . 4565)) nil (26808 3358 65426 0) 0 nil])
([nil nil ((4546 . 4551)) nil (26808 3358 65425 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4565 . 4566) (nil fontified nil 4565 . 4566) (nil fontified nil 4558 . 4565) (nil fontified nil 4551 . 4558) (4551 . 4566)) nil (26808 3358 65425 0) 0 nil])
([nil nil ((#("UP" 0 2 (face font-lock-string-face fontified t)) . 4562) (undo-tree-id363 . -2)) nil (26808 3358 65423 0) 0 nil])
([nil nil ((4562 . 4566)) nil (26808 3358 65408 0) 0 nil])
([nil nil ((3570 . 3572) (t 26808 3358 0 0)) nil (26808 3550 974714 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6351 . 6352) (nil fontified nil 3572 . 6352) (3572 . 6352)) nil (26808 3550 974714 0) 0 nil])
([nil nil ((#("

(defun migrate-up-to (target &key (verbose t))
  \"Monte/descend l’état des migrations jusqu’à `target` (string ou integer).\"
  (%ensure-table!)
  (let* ((tgt (%to-version-string target))
         (applied (%applied-versions))
         (applied-set (alexandria:alist-hash-table
                       (mapcar (lambda (v) (cons v t)) applied)
                       :test #'equal))
         (all (loop for i below (length *registry*) collect (aref *registry* i)))
         (to-up   (remove-if (lambda (m)
                               (or (gethash (migration-version m) applied-set)
                                   (string< tgt (migration-version m))))
                             all))
         (to-down (remove-if-not (lambda (m)
                                   (and (gethash (migration-version m) applied-set)
                                        (string< tgt (migration-version m))))
                                 all)))
    (print \"TO UP\")
    (print to-up)
    (print \"TO DOWN\")
    (print to-down)
    ;; UP
    (dolist (m (sort to-up (lambda (a b)
                             (string< (migration-version a) (migration-version b)))))
      (when verbose (format t \"~&[migrations] ↑ applying ~A...~%\" (migration-version m)))
      (with-tx ()
	(print \"OK 0\")
        (let ((thunk (%ensure-up-fn m)))
	  (print \"OK 1\")
          (unless thunk (error \"Migration ~A has no UP.\" (migration-version m)))
          (funcall thunk))
        (exec \"INSERT INTO schema_migrations(version) VALUES ($1)\"
              (migration-version m)))
      (when verbose (format t \"[migrations] OK ~A~%\" (migration-version m))))
    ;; DOWN
    (dolist (m (sort to-down (lambda (a b)
                               (string> (migration-version a) (migration-version b)))))
      (when verbose (format t \"~&[migrations] ↓ rolling back ~A...~%\" (migration-version m)))
      (with-tx ()
        (let ((thunk (%ensure-down-fn m)))
          (unless thunk (error \"Migration ~A has no DOWN.\" (migration-version m)))
          (funcall thunk))
        (exec \"DELETE FROM schema_migrations WHERE version=$1\"
              (migration-version m)))
      (when verbose (format t \"[migrations] ROLLBACK OK ~A~%\" (migration-version m))))
    (values (length to-up) (length to-down))))
" 0 1 (fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 8 (face font-lock-keyword-face fontified t) 8 9 (fontified t) 9 22 (face font-lock-function-name-face fontified t) 22 31 (fontified t) 31 35 (face font-lock-type-face fontified t) 35 49 (fontified t) 49 51 (fontified t) 51 60 (face font-lock-doc-face fontified t) 60 125 (face font-lock-doc-face fontified t) 125 126 (face font-lock-doc-face fontified t rear-nonsticky t) 126 127 (fontified t) 127 149 (fontified t) 149 153 (face font-lock-keyword-face fontified t) 153 311 (fontified t) 311 317 (face font-lock-keyword-face fontified t) 317 366 (fontified t) 366 371 (face font-lock-builtin-face fontified t) 371 397 (fontified t) 397 401 (face font-lock-keyword-face fontified t) 401 494 (fontified t) 494 500 (face font-lock-keyword-face fontified t) 500 726 (fontified t) 726 732 (face font-lock-keyword-face fontified t) 732 899 (fontified t) 899 939 (fontified t) 939 950 (fontified t) 950 957 (face font-lock-string-face fontified t) 957 959 (fontified t) 959 977 (fontified t) 977 981 (fontified t) 981 988 (fontified t) 988 997 (face font-lock-string-face fontified t) 997 998 (fontified t rear-nonsticky t) 998 999 (fontified t) 999 1003 (fontified t) 1003 1017 (fontified t) 1017 1018 (fontified t rear-nonsticky t) 1018 1019 (fontified t) 1019 1023 (fontified t) 1023 1026 (face font-lock-comment-delimiter-face fontified t) 1026 1029 (face font-lock-comment-face fontified t) 1029 1034 (fontified t) 1034 1040 (face font-lock-keyword-face fontified t) 1040 1057 (fontified t) 1057 1063 (face font-lock-keyword-face fontified t) 1063 1070 (fontified t) 1070 1155 (fontified t) 1155 1156 (fontified t) 1156 1163 (fontified t) 1163 1167 (face font-lock-keyword-face fontified t) 1167 1186 (fontified t) 1186 1221 (face font-lock-string-face fontified t) 1221 1246 (fontified t) 1246 1253 (fontified t) 1253 1260 (face font-lock-keyword-face fontified t) 1260 1264 (fontified t) 1264 1272 (fontified t) 1272 1278 (face font-lock-string-face fontified t) 1278 1279 (fontified t) 1279 1280 (fontified t) 1280 1289 (fontified t) 1289 1292 (face font-lock-keyword-face fontified t) 1292 1312 (fontified t) 1312 1321 (fontified t) 1321 1324 (fontified t) 1324 1331 (fontified t) 1331 1337 (face font-lock-string-face fontified t) 1337 1338 (fontified t rear-nonsticky t) 1338 1339 (fontified t) 1339 1349 (fontified t) 1349 1350 (fontified t) 1350 1356 (face font-lock-keyword-face fontified t) 1356 1364 (fontified t) 1364 1369 (face font-lock-warning-face fontified t) 1369 1370 (fontified t) 1370 1393 (face font-lock-string-face fontified t) 1393 1395 (face font-lock-string-face fontified t) 1395 1412 (fontified t) 1412 1420 (fontified t) 1420 1427 (fontified t) 1427 1447 (fontified t) 1447 1461 (fontified t) 1461 1475 (face font-lock-string-face fontified t) 1475 1490 (face font-lock-string-face fontified t) 1490 1501 (face font-lock-string-face fontified t) 1501 1513 (face font-lock-string-face fontified t) 1513 1514 (fontified t) 1514 1559 (fontified t) 1559 1563 (face font-lock-keyword-face fontified t) 1563 1565 (fontified t) 1565 1582 (fontified t) 1582 1604 (face font-lock-string-face fontified t) 1604 1630 (fontified t) 1630 1634 (fontified t) 1634 1637 (face font-lock-comment-delimiter-face fontified t) 1637 1642 (face font-lock-comment-face fontified t) 1642 1647 (fontified t) 1647 1653 (face font-lock-keyword-face fontified t) 1653 1672 (fontified t) 1672 1678 (face font-lock-keyword-face fontified t) 1678 1694 (fontified t) 1694 1707 (fontified t) 1707 1741 (fontified t) 1741 1773 (fontified t) 1773 1780 (fontified t) 1780 1784 (face font-lock-keyword-face fontified t) 1784 1803 (fontified t) 1803 1842 (face font-lock-string-face fontified t) 1842 1874 (fontified t) 1874 1881 (face font-lock-keyword-face fontified t) 1881 1894 (fontified t) 1894 1897 (face font-lock-keyword-face fontified t) 1897 1939 (fontified t) 1939 1945 (face font-lock-keyword-face fontified t) 1945 1953 (fontified t) 1953 1958 (face font-lock-warning-face fontified t) 1958 1959 (fontified t) 1959 1986 (face font-lock-string-face fontified t) 1986 2052 (fontified t) 2052 2100 (face font-lock-string-face fontified t) 2100 2146 (fontified t) 2146 2150 (face font-lock-keyword-face fontified t) 2150 2169 (fontified t) 2169 2200 (face font-lock-string-face fontified t) 2200 2272 (fontified t) 2272 2273 (fontified t rear-nonsticky t)) . -6352) (undo-tree-id372 . -1927) (undo-tree-id373 . -938) (undo-tree-id374 . -963) (undo-tree-id375 . -1003) (undo-tree-id376 . -1013) (undo-tree-id377 . -943) (undo-tree-id378 . -981) (undo-tree-id379 . -996) (undo-tree-id380 . -996) (undo-tree-id381 . -584) (undo-tree-id382 . -2273) (undo-tree-id383 . -981) (undo-tree-id384 . -2) (undo-tree-id385 . -1514) (undo-tree-id386 . -1) (undo-tree-id387 . -1) (undo-tree-id388 . -1685) (undo-tree-id389 . -2273) 8625) nil (26808 3550 974712 0) 0 nil])
([nil nil ((5358 . 5362)) nil (26808 3550 974693 0) 0 nil])
([nil nil ((5362 . 5368)) nil (26808 3550 974692 0) 0 nil])
([nil nil ((5368 . 5369)) nil (26808 3550 974691 0) 0 nil])
([nil nil ((5369 . 5375)) nil (26808 3550 974687 0) 0 nil])
([nil nil ((5386 . 5394) (t 26808 3550 0 0)) nil (26808 4013 252716 0) 0 nil])
([nil nil ((5394 . 5395)) nil (26808 4013 252714 0) 0 nil])
([nil nil ((5410 . 5411)) nil (26808 4013 252711 0) 0 nil])
([nil nil ((#("@" 0 1 (fontified t)) . -2283) (undo-tree-id396 . -1) 2284 (t 26808 4013 0 0)) nil (26808 8646 352534 0) 0 nil])
([nil nil ((#("
	  (print \"OK 5\")" 0 1 (fontified t) 1 4 (fontified t) 4 11 (fontified t) 11 17 (face font-lock-string-face fontified t) 17 18 (fontified t rear-nonsticky t)) . 1963) (undo-tree-id395 . -18)) nil (26808 8646 352533 0) 0 nil])
([nil nil ((#("
  (print \"OK 2a\")" 0 1 (fontified t) 1 3 (fontified t) 3 10 (fontified t) 10 17 (face font-lock-string-face fontified t) 17 18 (rear-nonsticky t fontified t)) . 1783) (undo-tree-id394 . -18)) nil (26808 8646 352532 0) 0 nil])
([nil nil ((#("
  (print \"OK 2\")" 0 1 (fontified t) 1 10 (fontified t) 10 16 (face font-lock-string-face fontified t) 16 17 (fontified t)) . 1733) (undo-tree-id393 . -17)) nil (26808 8646 352531 0) 0 nil])
([nil nil ((#("(progn (print \"OK 3\") " 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 14 (fontified t) 14 20 (face font-lock-string-face fontified t) 20 21 (fontified t rear-nonsticky t) 21 22 (fontified t)) . -1788) (undo-tree-id392 . -22) 1810) nil (26808 8646 352529 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -1808) (undo-tree-id391 . -1) 1809) nil (26808 8646 352527 0) 0 nil])
([nil nil ((#("
    (print target)
    (print \"WWW\")" 0 1 (fontified t) 1 20 (fontified t) 20 22 (fontified t) 22 31 (fontified t) 31 36 (face font-lock-string-face fontified t) 36 37 (fontified t)) . 3287) (undo-tree-id390 . -37)) nil (26808 8646 352523 0) 0 nil])
([nil nil ((#("migration-up-fn" 0 15 (fontified t)) . -1789) (t 26808 8646 0 0) (1804 . 1822) (t 26808 8646 0 0)) nil (26812 49408 314686 0) 0 nil])
([nil nil ((#("fn" 0 2 (fontified t)) . -2085) (undo-tree-id0 . -2) 2087) nil (26812 49408 314684 0) 0 nil])
([nil nil ((2085 . 2090)) nil (26812 49408 314663 0) 0 nil])
([nil nil ((1707 . 1709) (t 26812 49408 0 0)) nil (26819 5745 91787 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2394 . 2395) (nil fontified nil 1709 . 2395) (1709 . 2395)) nil (26819 5745 91787 0) 0 nil])
([nil nil ((#("
(defmacro defmigration (version &key up down)
  \"VERSION = string ou integer horodaté.
UP/DOWN = forms qui seront DANS une (lambda () ...).\"
  (let* ((ver-str (if (integerp version)
                      (write-to-string version)
                      version))
         (up-fn   `(lambda () ,@up))
         (down-fn (when down `(lambda () ,@down))))
    `(%push-migration!
      (make-migration
        :version ,ver-str
        :up-forms ,up-fn
        :down-forms ,down-fn))))" 0 1 (fontified t) 1 2 (fontified t) 2 10 (face font-lock-keyword-face fontified t) 10 11 (fontified t) 11 23 (face font-lock-function-name-face fontified t) 23 33 (fontified t) 33 37 (face font-lock-type-face fontified t) 37 49 (fontified t) 49 141 (face font-lock-doc-face fontified t) 141 145 (fontified t) 145 149 (face font-lock-keyword-face fontified t) 149 161 (fontified t) 161 163 (face font-lock-keyword-face fontified t) 163 274 (fontified t) 274 283 (fontified t) 283 289 (face font-lock-keyword-face fontified t) 289 300 (fontified t) 300 319 (fontified t) 319 323 (face font-lock-keyword-face fontified t) 323 331 (fontified t) 331 337 (face font-lock-keyword-face fontified t) 337 405 (fontified t) 405 413 (face font-lock-builtin-face fontified t) 413 431 (fontified t) 431 440 (face font-lock-builtin-face fontified t) 440 448 (fontified t) 448 456 (fontified t) 456 467 (face font-lock-builtin-face fontified t) 467 480 (fontified t)) . 1227) (undo-tree-id41 . -480)) nil (26819 5745 91786 0) 0 nil])
([nil nil ((#("
" 0 1 (fontified t)) . 1227)) nil (26819 5745 91785 0) 0 nil])
([nil nil ((1914 . 1916)) nil (26819 5745 91784 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2484 . 2485) (nil fontified nil 1916 . 2485) (1916 . 2485)) nil (26819 5745 91784 0) 0 nil])
([nil nil ((#("


(defun %ensure-up-fn (m)
  (print (migration-up-forms m))
  (or (ignore-errors (migration-up-forms m))
      (let ((forms (ignore-errors (migration-up-forms m))))
	;;(print forms)
        (when forms
          ;; Compile un thunk propre (sans eval à l’exécution)
          (compile nil `(lambda () ,forms))))))

(defun %ensure-down-fn (m)
  (or (ignore-errors (migration-down-forms m))
      (let ((forms (ignore-errors (migration-down-forms m))))
        (when forms
          (compile nil `(lambda () ,forms))))))
" 0 1 (rear-nonsticky t fontified t) 1 2 (fontified t) 2 4 (fontified t) 4 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 23 (face font-lock-function-name-face fontified t) 23 68 (fontified t) 68 81 (face font-lock-keyword-face fontified t) 81 113 (fontified t) 113 116 (face font-lock-keyword-face fontified t) 116 126 (fontified t) 126 139 (face font-lock-keyword-face fontified t) 139 167 (fontified t) 167 169 (face font-lock-comment-delimiter-face fontified t) 169 183 (face font-lock-comment-face fontified t) 183 192 (fontified t) 192 196 (face font-lock-keyword-face fontified t) 196 213 (fontified t) 213 216 (face font-lock-comment-delimiter-face fontified t) 216 266 (face font-lock-comment-face fontified t) 266 291 (fontified t) 291 297 (face font-lock-keyword-face fontified t) 297 316 (fontified t) 316 321 (face font-lock-keyword-face fontified t) 321 322 (fontified t) 322 337 (face font-lock-function-name-face fontified t) 337 349 (fontified t) 349 362 (face font-lock-keyword-face fontified t) 362 396 (fontified t) 396 399 (face font-lock-keyword-face fontified t) 399 409 (fontified t) 409 422 (face font-lock-keyword-face fontified t) 422 460 (fontified t) 460 464 (face font-lock-keyword-face fontified t) 464 496 (fontified t) 496 502 (face font-lock-keyword-face fontified t) 502 519 (fontified t)) . 2484) (undo-tree-id40 . -519)) nil (26819 5745 91783 0) 0 nil])
([nil nil ((2484 . 2485)) nil (26819 5745 91782 0) 0 nil])
([nil nil ((3722 . 3724)) nil (26819 5745 91782 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4003 . 4004) (nil fontified nil 3724 . 4004) (3724 . 4004)) nil (26819 5745 91781 0) 0 nil])
([nil nil ((#("
(defun migrate-all (&key (verbose t))
  (%ensure-table!)
  (let ((target (%max-registered-version)))
    (if target
        (migrate-up-to target :verbose verbose)
        (progn
          (when verbose (format t \"~&[migrations] nothing to migrate.~%\"))
          0))))
" 0 1 (face font-lock-comment-face fontified t) 1 2 (fontified t) 2 7 (face font-lock-keyword-face fontified t) 7 8 (fontified t) 8 14 (face font-lock-function-name-face fontified t) 14 16 (face font-lock-function-name-face fontified t) 16 19 (face font-lock-function-name-face fontified t) 19 21 (fontified t) 21 25 (face font-lock-type-face fontified t) 25 39 (fontified t) 39 61 (fontified t) 61 64 (face font-lock-keyword-face fontified t) 64 107 (fontified t) 107 109 (face font-lock-keyword-face fontified t) 109 147 (fontified t) 147 155 (face font-lock-builtin-face fontified t) 155 174 (fontified t) 174 179 (face font-lock-keyword-face fontified t) 179 191 (fontified t) 191 195 (face font-lock-keyword-face fontified t) 195 214 (fontified t) 214 252 (face font-lock-string-face fontified t) 252 255 (fontified t) 255 271 (fontified t)) . 3452) (undo-tree-id34 . -271) (undo-tree-id35 . -1) (undo-tree-id36 . -270) (undo-tree-id37 . -271) (undo-tree-id38 . -271) (undo-tree-id39 . -271)) nil (26819 5745 91780 0) 0 nil])
([nil nil ((3733 . 3735)) nil (26819 5745 91776 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6332 . 6333) (nil fontified nil 3735 . 6333) (3735 . 6333)) nil (26819 5745 91776 0) 0 nil])
([nil nil ((6332 . 6333)) nil (26819 5745 91775 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -6332) (undo-tree-id32 . -1) (undo-tree-id33 . -1) 6333) nil (26819 5745 91774 0) 0 nil])
([nil nil ((#("


(defun migrate-up-to (target &key (verbose t))
  (%ensure-table!)
  (let* ((tgt (%to-version-string target))
         (applied (%applied-versions))    ; => liste de strings \"YYYY-..\"
         (applied-set (alexandria:alist-hash-table
                       (mapcar (lambda (v) (cons (string-trim \" \" v) t)) applied)
                       :test #'equal))
         ;; dédupliquer le registre par version
         (all (loop for i below (length *registry*) collect (aref *registry* i)))
         (all-uniq (remove-duplicates all
                                      :key #'migration-version :test #'equal :from-end t))
         ;; à monter = non appliquées ET ≤ target
         (to-up (remove-if (lambda (m)
                             (or (gethash (string-trim \" \" (migration-version m)) applied-set)
                                 (string< tgt (migration-version m))))
                           all-uniq))
         ;; à descendre = appliquées ET > target
         (to-down (remove-if-not (lambda (m)
                                   (and (gethash (string-trim \" \" (migration-version m)) applied-set)
                                        (string< tgt (migration-version m))))
                                 all-uniq)))
    ;; -------- UP en ordre croissant --------
    (dolist (m (sort to-up (lambda (a b)
                             (string< (migration-version a) (migration-version b)))))
      (let* ((ver (migration-version m))
             (thunk (%ensure-up-fn m)))
        (when (gethash ver applied-set)
          (when verbose (format t \"[migrations] ~A already applied; skip.~%\" ver))
          (continue))
        (when verbose (format t \"~&[migrations] ↑ applying ~A...~%\" ver))
        (with-tx ()
          (unless thunk (error \"Migration ~A has no UP.\" ver))
	  (print thunk)
          (funcall (funcall thunk))
          (exec \"INSERT INTO schema_migrations(version)
                 VALUES ($1)
                 ON CONFLICT (version) DO NOTHING\"
                ver))
        (setf (gethash ver applied-set) t) ; tenue à jour in-memory
        (when verbose (format t \"[migrations] OK ~A~%\" ver))))
    ;; -------- DOWN en ordre décroissant --------
    (dolist (m (sort to-down (lambda (a b)
                               (string> (migration-version a) (migration-version b)))))
      (let* ((ver (migration-version m))
             (thunk (%ensure-down-fn m)))
        (when verbose (format t \"~&[migrations] ↓ rolling back ~A...~%\" ver))
        (with-tx ()
          (unless thunk (error \"Migration ~A has no DOWN.\" ver))
          (funcall thunk)
          (exec \"DELETE FROM schema_migrations WHERE version=$1\" ver))
        (remhash ver applied-set)
        (when verbose (format t \"[migrations] ROLLBACK OK ~A~%\" ver))))
    (values (length to-up) (length to-down))))

(defun rollback-one (&key (verbose t))
  (%ensure-table!)
  (let* ((last (query-1a \"SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1\")))
    (if (null last)
        (progn
          (when verbose (format t \"~&[migrations] nothing to rollback.~%\"))
          0)
        (let* ((v (cdr (assoc :version last)))
               (m (%find-mig v)))
          (unless m (error \"No migration registered for version ~A\" v))
          (when verbose (format t \"~&[migrations] ↓ rolling back ~A...~%\" v))
          (with-tx ()
            (let ((down (migration-down-forms m)))
              (when (and (null down)) (error \"Migration ~A has no DOWN.\" v))
              (eval down))
            (exec \"DELETE FROM schema_migrations WHERE version=$1\" v))
          (when verbose (format t \"[migrations] ROLLBACK OK ~A~%\" v))
          1))))" 0 1 (rear-nonsticky t fontified t) 1 2 (fontified t) 2 3 (fontified t) 3 4 (fontified t) 4 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 23 (face font-lock-function-name-face fontified t) 23 32 (fontified t) 32 36 (face font-lock-type-face fontified t) 36 72 (fontified t) 72 76 (face font-lock-keyword-face fontified t) 76 154 (fontified t) 154 186 (face font-lock-comment-face fontified t) 186 187 (fontified t) 187 237 (fontified t) 237 265 (fontified t) 265 269 (fontified t) 269 275 (face font-lock-keyword-face fontified t) 275 299 (fontified t) 299 302 (face font-lock-string-face fontified t) 302 319 (fontified t) 319 342 (fontified t) 342 347 (face font-lock-builtin-face fontified t) 347 367 (fontified t) 367 370 (face font-lock-comment-delimiter-face fontified t) 370 406 (face font-lock-comment-face fontified t) 406 421 (fontified t) 421 425 (face font-lock-keyword-face fontified t) 425 568 (fontified t) 568 572 (face font-lock-builtin-face fontified t) 572 593 (fontified t) 593 598 (face font-lock-builtin-face fontified t) 598 607 (fontified t) 607 616 (face font-lock-builtin-face fontified t) 616 630 (fontified t) 630 633 (face font-lock-comment-delimiter-face fontified t) 633 671 (face font-lock-comment-face fontified t) 671 699 (fontified t) 699 705 (face font-lock-keyword-face fontified t) 705 765 (fontified t) 765 768 (face font-lock-string-face fontified t) 768 923 (fontified t) 923 926 (face font-lock-comment-delimiter-face fontified t) 926 963 (face font-lock-comment-face fontified t) 963 997 (fontified t) 997 1003 (face font-lock-keyword-face fontified t) 1003 1070 (fontified t) 1070 1073 (face font-lock-string-face fontified t) 1073 1079 (fontified t) 1079 1110 (fontified t) 1110 1221 (fontified t) 1221 1233 (fontified t) 1233 1237 (fontified t) 1237 1240 (face font-lock-comment-delimiter-face fontified t) 1240 1280 (face font-lock-comment-face fontified t) 1280 1285 (fontified t) 1285 1291 (face font-lock-keyword-face fontified t) 1291 1308 (fontified t) 1308 1314 (face font-lock-keyword-face fontified t) 1314 1414 (fontified t) 1414 1418 (face font-lock-keyword-face fontified t) 1418 1497 (fontified t) 1497 1501 (face font-lock-keyword-face fontified t) 1501 1502 (fontified t) 1502 1528 (fontified t) 1528 1539 (fontified t) 1539 1543 (face font-lock-keyword-face fontified t) 1543 1562 (fontified t) 1562 1604 (face font-lock-string-face fontified t) 1604 1642 (fontified t) 1642 1646 (face font-lock-keyword-face fontified t) 1646 1665 (fontified t) 1665 1700 (face font-lock-string-face fontified t) 1700 1716 (fontified t) 1716 1723 (face font-lock-keyword-face fontified t) 1723 1738 (fontified t) 1738 1744 (face font-lock-keyword-face fontified t) 1744 1752 (fontified t) 1752 1757 (face font-lock-warning-face fontified t) 1757 1758 (fontified t) 1758 1783 (face font-lock-string-face fontified t) 1783 1819 (fontified t) 1819 1843 (fontified t) 1843 1859 (fontified t) 1859 1978 (face font-lock-string-face fontified t) 1978 2044 (fontified t) 2044 2069 (face font-lock-comment-face fontified t) 2069 2078 (fontified t) 2078 2082 (face font-lock-keyword-face fontified t) 2082 2101 (fontified t) 2101 2123 (face font-lock-string-face fontified t) 2123 2136 (fontified t) 2136 2139 (face font-lock-comment-delimiter-face fontified t) 2139 2183 (face font-lock-comment-face fontified t) 2183 2188 (fontified t) 2188 2194 (face font-lock-keyword-face fontified t) 2194 2213 (fontified t) 2213 2219 (face font-lock-keyword-face fontified t) 2219 2321 (fontified t) 2321 2325 (face font-lock-keyword-face fontified t) 2325 2406 (fontified t) 2406 2410 (face font-lock-keyword-face fontified t) 2410 2429 (fontified t) 2429 2468 (face font-lock-string-face fontified t) 2468 2484 (fontified t) 2484 2491 (face font-lock-keyword-face fontified t) 2491 2506 (fontified t) 2506 2512 (face font-lock-keyword-face fontified t) 2512 2520 (fontified t) 2520 2525 (face font-lock-warning-face fontified t) 2525 2526 (fontified t) 2526 2553 (face font-lock-string-face fontified t) 2553 2602 (fontified t) 2602 2610 (face font-lock-string-face fontified t) 2610 2650 (face font-lock-string-face fontified t) 2650 2657 (fontified t) 2657 2700 (fontified t) 2700 2704 (face font-lock-keyword-face fontified t) 2704 2723 (fontified t) 2723 2733 (face font-lock-string-face fontified t) 2733 2754 (face font-lock-string-face fontified t) 2754 2763 (fontified t) 2763 2811 (fontified t) 2811 2812 (fontified t) 2812 2817 (face font-lock-keyword-face fontified t) 2817 2818 (fontified t) 2818 2830 (face font-lock-function-name-face fontified t) 2830 2832 (fontified t) 2832 2836 (face font-lock-type-face fontified t) 2836 2872 (fontified t) 2872 2876 (face font-lock-keyword-face fontified t) 2876 2894 (fontified t) 2894 2963 (face font-lock-string-face fontified t) 2963 2972 (fontified t) 2972 2974 (face font-lock-keyword-face fontified t) 2974 2996 (fontified t) 2996 3001 (face font-lock-keyword-face fontified t) 3001 3013 (fontified t) 3013 3017 (face font-lock-keyword-face fontified t) 3017 3028 (fontified t) 3028 3036 (fontified t) 3036 3075 (face font-lock-string-face fontified t) 3075 3078 (fontified t) 3078 3100 (fontified t) 3100 3104 (face font-lock-keyword-face fontified t) 3104 3121 (fontified t) 3121 3129 (face font-lock-builtin-face fontified t) 3129 3183 (fontified t) 3183 3189 (face font-lock-keyword-face fontified t) 3189 3193 (fontified t) 3193 3198 (face font-lock-warning-face fontified t) 3198 3199 (fontified t) 3199 3239 (face font-lock-string-face fontified t) 3239 3255 (fontified t) 3255 3259 (face font-lock-keyword-face fontified t) 3259 3278 (fontified t) 3278 3317 (face font-lock-string-face fontified t) 3317 3333 (fontified t) 3333 3340 (face font-lock-keyword-face fontified t) 3340 3357 (fontified t) 3357 3360 (face font-lock-keyword-face fontified t) 3360 3410 (fontified t) 3410 3414 (face font-lock-keyword-face fontified t) 3414 3434 (fontified t) 3434 3439 (face font-lock-warning-face fontified t) 3439 3440 (fontified t) 3440 3467 (face font-lock-string-face fontified t) 3467 3517 (fontified t) 3517 3565 (face font-lock-string-face fontified t) 3565 3581 (fontified t) 3581 3585 (face font-lock-keyword-face fontified t) 3585 3604 (fontified t) 3604 3635 (face font-lock-string-face fontified t) 3635 3655 (fontified t)) . -6332) (undo-tree-id3 . -2680) (undo-tree-id4 . -2495) (undo-tree-id5 . -3655) (undo-tree-id6 . -3) (undo-tree-id7 . -1233) (undo-tree-id8 . -617) (undo-tree-id9 . -617) (undo-tree-id10 . -617) (undo-tree-id11 . -617) (undo-tree-id12 . -617) (undo-tree-id13 . -617) (undo-tree-id14 . -617) (undo-tree-id15 . -617) (undo-tree-id16 . -617) (undo-tree-id17 . -617) (undo-tree-id18 . -1) (undo-tree-id19 . -1) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (undo-tree-id23 . -3) (undo-tree-id24 . -1528) (undo-tree-id25 . -831) (undo-tree-id26 . -1726) (undo-tree-id27 . -2811) (undo-tree-id28 . -3078) (undo-tree-id29 . -2521) (undo-tree-id30 . -3270) (undo-tree-id31 . -3640) 9987) nil (26819 5745 91769 0) 0 nil])
([nil nil ((6332 . 6334)) nil (26819 5745 91745 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7104 . 7105) (nil fontified nil 6334 . 7105) (6334 . 7105)) nil (26819 5745 91744 0) 0 nil])
([nil nil ((#("
" 0 1 (rear-nonsticky t fontified t)) . -7104) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) 7105) nil (26819 5745 91740 0) 0 nil])
([nil nil ((6334 . 6335) (t 26819 5745 0 0)) nil (26819 5748 467060 0) 0 nil])
([nil nil ((#("o" 0 1 (fontified t)) . -6334) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) 6335) nil (26819 5748 467056 0) 0 nil])
([nil nil ((202 . 203) (t 26819 5748 0 0)) nil (26978 23874 269407 0) 0 nil])
([nil nil ((203 . 204)) nil (26978 23874 269407 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 221 . 222) (nil fontified nil 214 . 222) (nil fontified nil 204 . 214) (204 . 222)) nil (26978 23874 269406 0) 0 nil])
([nil nil ((#("(ensure-connection" 0 18 (fontified t)) . -2546) (undo-tree-id14 . -18) 2564) nil (26978 23874 269405 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2578 . 2579) (nil fontified nil 2546 . 2579) (2546 . 2579)) nil (26978 23874 269403 0) 0 nil])
([nil nil ((2825 . 2826)) nil (26978 23874 269402 0) 0 nil])
([nil nil ((#("(with-tx ()" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 11 (fontified t)) . -5342) (undo-tree-id13 . -11) 5353) nil (26978 23874 269402 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 5374 . 5375) (nil fontified nil 5342 . 5375) (5342 . 5375)) nil (26978 23874 269400 0) 0 nil])
([nil nil ((5731 . 5732)) nil (26978 23874 269463 0) 0 nil])
([nil nil ((#("(with-tx ()" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 11 (fontified t)) . -6076) (undo-tree-id21 . -11) 6087) nil (26978 23967 177399 0) 0 nil] [nil nil ((#("(with-tx ()" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 11 (fontified t)) . -6076) (undo-tree-id0 . -11) (undo-tree-id1 . -11) (undo-tree-id2 . -11) (undo-tree-id3 . -11) (undo-tree-id4 . -11) (undo-tree-id5 . -11) (undo-tree-id6 . -11) (undo-tree-id7 . -11) (undo-tree-id8 . -11) (undo-tree-id9 . -11) (undo-tree-id10 . -11) (undo-tree-id11 . -11) (undo-tree-id12 . -11) 6087) ((6076 . 6087)) (26978 23874 269395 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6108 . 6109) (nil fontified nil 6076 . 6109) (6076 . 6109)) nil (26978 23967 177398 0) 0 nil])
nil
([nil nil ((6386 . 6387)) nil (26978 23967 177397 0) 0 nil])
([nil nil ((6333 . 6334) (6310 . 6311) (6275 . 6276) (6205 . 6206) (6175 . 6176) (6125 . 6126) (6102 . 6104) (#("   " 0 3 (fontified t)) . 6102) (5682 . 5683) (5661 . 5662) (5617 . 5618) (5602 . 5603) (5459 . 5460) (5431 . 5432) (5385 . 5386) (5362 . 5364) (#("   " 0 3 (fontified t)) . 5362) 3771) nil (26978 23967 177390 0) 0 nil])
([nil nil ((#("(with-tx ()" 0 1 (fontified t) 1 8 (face font-lock-keyword-face fontified t) 8 11 (fontified t)) . -6947) (undo-tree-id15 . -11) (undo-tree-id16 . -8) (undo-tree-id17 . -8) (undo-tree-id18 . -8) (undo-tree-id19 . -11) (undo-tree-id20 . -11) 6958) nil (26978 23967 177379 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 6979 . 6980) (nil fontified nil 6947 . 6980) (6947 . 6980)) nil (26978 23967 177313 0) 0 nil])
([nil nil ((7203 . 7204)) nil (26978 23967 177312 0) 0 nil])
([nil nil ((7148 . 7149) (7078 . 7079) (7046 . 7047) (6994 . 6995) (6967 . 6971) (#("   " 0 3 (fontified t)) . 6967) 6427) nil (26978 23967 177311 0) 0 nil])
([nil nil ((7868 . 7871)) nil (26978 23967 177309 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7903 . 7904) (nil fontified nil 7871 . 7904) (7871 . 7904)) nil (26978 23967 177309 0) 0 nil])
([nil nil ((7949 . 7950)) nil (26978 23967 177308 0) 0 nil])
([nil nil ((7950 . 7951)) nil (26978 23967 177307 0) 0 nil])
([nil nil ((7907 . 7910) 7833) nil (26978 23967 177303 0) 0 nil])
([nil nil ((5608 . 5609) (t 26978 23967 0 0)) nil (26978 24169 900792 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -5738) (undo-tree-id36 . -1) (undo-tree-id37 . -1) (undo-tree-id38 . -1) (undo-tree-id39 . -1) (undo-tree-id40 . -1) (undo-tree-id41 . -1) (undo-tree-id42 . -1) (undo-tree-id43 . -1) (undo-tree-id44 . -1) (undo-tree-id45 . -1) (undo-tree-id46 . -1) (undo-tree-id47 . -1) (undo-tree-id48 . -1) 5739) nil (26978 24169 900791 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -6265) (undo-tree-id29 . -1) (undo-tree-id30 . -1) (undo-tree-id31 . -1) (undo-tree-id32 . -1) (undo-tree-id33 . -1) (undo-tree-id34 . -1) (undo-tree-id35 . -1) 6266) nil (26978 24169 900778 0) 0 nil])
([nil nil ((6265 . 6267)) nil (26978 24169 900769 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -6398) (undo-tree-id22 . -1) (undo-tree-id23 . -1) (undo-tree-id24 . -1) (undo-tree-id25 . -1) (undo-tree-id26 . -1) (undo-tree-id27 . -1) (undo-tree-id28 . -1) 6399) nil (26978 24169 900765 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -7208) (undo-tree-id49 . -1) (undo-tree-id50 . -1) (undo-tree-id51 . -1) (undo-tree-id52 . -1) (undo-tree-id53 . -1) (undo-tree-id54 . -1) (undo-tree-id55 . -1) 7209 (t 26978 24169 0 0)) nil (26978 24189 88017 0) 0 nil])
([nil nil ((7208 . 7209)) nil (26978 24207 971760 0) 0 nil] [nil nil ((7137 . 7138)) ((#(")" 0 1 (fontified t)) . 7137)) (26978 24188 663536 0) 0 nil])
([nil nil ((7137 . 7138) (t 26993 53276 0 0)) nil (27000 62717 198243 0) 0 nil])
([nil nil ((7209 . 7210)) ((#(")" 0 1 (fontified t)) . 7209)) (26978 24188 663458 0) 0 nil])
([nil nil ((7226 . 7227)) nil (27000 62717 198242 0) 0 nil])
nil
([nil nil ((#(")" 0 1 (fontified t)) . -7225) (undo-tree-id20 . -1) (undo-tree-id21 . -1) (undo-tree-id22 . -1) (#("=" 0 1 (face (font-lock-warning-face) help-echo "Easy to misread; consider moving the element to the next line" fontified t)) . -7226) (undo-tree-id23 . -1) 7227) nil (27000 62717 198241 0) 0 nil])
([nil nil ((#(")" 0 1 (fontified t)) . -7209) (undo-tree-id0 . -1) (undo-tree-id1 . -1) (undo-tree-id2 . -1) (undo-tree-id3 . -1) (undo-tree-id4 . -1) (undo-tree-id5 . -1) (undo-tree-id6 . -1) (undo-tree-id7 . -1) (undo-tree-id8 . -1) (undo-tree-id9 . -1) (undo-tree-id10 . -1) (undo-tree-id11 . -1) (undo-tree-id12 . -1) (undo-tree-id13 . -1) (undo-tree-id14 . -1) (undo-tree-id15 . -1) (undo-tree-id16 . -1) (undo-tree-id17 . -1) (undo-tree-id18 . -1) (undo-tree-id19 . -1) 7210) nil (27000 62717 198236 0) 0 nil])
([nil nil ((7224 . 7225)) nil (27000 62717 198203 0) 0 nil])
([nil nil ((2667 . 2668) 2672 (t 27000 62717 0 0)) nil (27001 3644 434606 0) 0 nil])
([nil nil ((#("(defun %push-migration! (m)
  (bt:with-lock-held (*lock*)
    (vector-push-extend m *registry*)
    ;; garder l’ordre par version croissante dans le registre
    (let* ((lst (loop for i below (length *registry*) collect (aref *registry* i)))
           (sorted (sort lst (lambda (a b)
                               (string< (migration-version a)
                                        (migration-version b))))))
      (setf *registry* (make-array 0 :adjustable t :fill-pointer 0))
      (dolist (x sorted) (vector-push-extend x *registry*)))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 23 (face font-lock-function-name-face fontified t) 23 31 (fontified t) 31 48 (face font-lock-keyword-face fontified t) 48 100 (fontified t) 100 103 (face font-lock-comment-delimiter-face fontified t) 103 158 (face font-lock-comment-face fontified t) 158 163 (fontified t) 163 167 (face font-lock-keyword-face fontified t) 167 175 (fontified t) 175 179 (face font-lock-keyword-face fontified t) 179 272 (fontified t) 272 278 (face font-lock-keyword-face fontified t) 278 451 (fontified t) 451 462 (face font-lock-builtin-face fontified t) 462 465 (fontified t) 465 478 (face font-lock-builtin-face fontified t) 478 490 (fontified t) 490 496 (face font-lock-keyword-face fontified t) 496 545 (fontified t)) . -701) (undo-tree-id24 . -545) 1246) nil (27001 3644 434605 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 1490 . 1491) (nil fontified nil 701 . 1491) (701 . 1491)) nil (27001 3644 434601 0) 0 nil])
([nil nil ((1491 . 1493)) nil (27001 3644 434600 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2032 . 2033) (nil fontified nil 1493 . 2033) (1493 . 2033)) nil (27001 3644 434599 0) 0 nil])
([nil nil ((892 . 898) (#(" " 0 1 (fontified nil)) . 891) (undo-tree-id23 . -1) (892 . 893)) nil (27001 3644 434597 0) 0 nil])
([nil nil ((929 . 937) (#(" " 0 1 (fontified nil)) . 928) (undo-tree-id22 . -1) (929 . 930)) nil (27001 3644 434595 0) 0 nil])
([nil nil ((1246 . 1251) (#(" " 0 1 (fontified nil)) . 1245) (undo-tree-id21 . -1) (1246 . 1247)) nil (27001 3644 434592 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -1328) (undo-tree-id20 . -1) 1329) nil (27001 3644 434590 0) 0 nil])
([nil nil ((#(" " 0 1 (fontified t)) . -1377) (undo-tree-id19 . -1) 1378) nil (27001 3644 434589 0) 0 nil])
([nil nil ((#("(defun %ensure-up-fn (mig)
  (let ((f (migration-up-forms mig)))
    (cond
      ((functionp f) f)                ; déjà une fonction
      ((consp f)     (eval f))         ; lambda-expression → fonction
      (t (error \"Migration ~A has no UP.\" (migration-version mig))))))

(defun %ensure-down-fn (mig)
  (let ((f (migration-down-forms mig)))
    (cond
      ((null f)     (error \"Migration ~A has no DOWN.\" (migration-version mig)))
      ((functionp f) f)
      ((consp f)     (eval f))
      (t (error \"Migration ~A has invalid DOWN.\" (migration-version mig))))))" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 20 (face font-lock-function-name-face fontified t) 20 30 (fontified t) 30 33 (face font-lock-keyword-face fontified t) 33 36 (fontified t) 36 65 (fontified t) 65 70 (fontified t) 70 74 (face font-lock-keyword-face fontified t) 74 88 (fontified t) 88 114 (fontified t) 114 134 (face font-lock-comment-face fontified t) 134 138 (fontified t) 138 173 (fontified t) 173 204 (face font-lock-comment-face fontified t) 204 214 (fontified t) 214 219 (face font-lock-warning-face fontified t) 219 220 (fontified t) 220 245 (face font-lock-string-face fontified t) 245 277 (fontified t) 277 282 (face font-lock-keyword-face fontified t) 282 283 (fontified t) 283 298 (face font-lock-function-name-face fontified t) 298 308 (fontified t) 308 311 (face font-lock-keyword-face fontified t) 311 350 (fontified t) 350 354 (face font-lock-keyword-face fontified t) 354 376 (fontified t) 376 381 (face font-lock-warning-face fontified t) 381 382 (fontified t) 382 409 (face font-lock-string-face fontified t) 409 501 (fontified t) 501 506 (face font-lock-warning-face fontified t) 506 507 (fontified t) 507 539 (face font-lock-string-face fontified t) 539 568 (fontified t)) . -2740) (undo-tree-id18 . -568) 3308) nil (27001 3644 434587 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2853 . 2854) (nil fontified nil 2740 . 2854) (2740 . 2854)) nil (27001 3644 434585 0) 0 nil])
([nil nil ((#("(defun migrate-all (&key (verbose t))
  (%ensure-table!)
  (let ((target (%max-registered-version)))
    (if target
        (migrate-up-to target :verbose verbose)
        (progn
          (when verbose (format t \"~&[migrations] nothing to migrate.~%\"))
          (values 0 0)))))

(defun migrate-up-to (target &key (verbose t))
  (%ensure-table!)
  (let* ((tgt (%to-version-string target))
         (applied        (%applied-versions)) ; => liste de strings \"YYYY-..\"
         (applied-set    (alexandria:alist-hash-table
                          (mapcar (lambda (v) (cons (string-trim \" \" v) t)) applied)
                          :test #'equal))
         ;; dédupliquer le registre par version
         (all       (loop for i below (length *registry*) collect (aref *registry* i)))
         (all-uniq  (remove-duplicates all :key #'migration-version :test #'equal :from-end t))
         ;; à monter = non appliquées ET ≤ target
         (to-up     (remove-if (lambda (m)
                                 (or (gethash (string-trim \" \" (migration-version m)) applied-set)
                                     (string< tgt (migration-version m))))
                               all-uniq))
         ;; à descendre = appliquées ET > target
         (to-down   (remove-if-not (lambda (m)
                                     (and (gethash (string-trim \" \" (migration-version m)) applied-set)
                                          (string< tgt (migration-version m))))
                                   all-uniq))
         (n-up 0)
         (n-down 0))
    ;; -------- UP en ordre croissant --------
    (dolist (m (sort to-up (lambda (a b)
                             (string< (migration-version a) (migration-version b)))))
      (let ((ver (migration-version m)))
        (when verbose (format t \"~&[migrations] ↑ applying ~A...~%\" ver))
        (run-in-transaction
	 (lambda ()
           (let ((up-fn (%ensure-up-fn m)))
             (funcall up-fn))
           (exec \"INSERT INTO schema_migrations(version)
                 VALUES ($1)
                 ON CONFLICT (version) DO NOTHING\"
                 ver)))
         (setf (gethash ver applied-set) t)
         (incf n-up)
         (when verbose (format t \"[migrations] OK ~A~%\" ver))))

    ;; -------- DOWN en ordre décroissant (si jamais on voulait descendre) --------
    (dolist (m (sort to-down (lambda (a b)
                               (string> (migration-version a) (migration-version b)))))
      (let ((ver (migration-version m)))
        (when verbose (format t \"~&[migrations] ↓ rolling back ~A...~%\" ver))
        (run-in-transaction
	 (lambda ()
           (let ((down-fn (%ensure-down-fn m)))
             (funcall down-fn))
           (exec \"DELETE FROM schema_migrations WHERE version=$1\" ver)))
         (remhash ver applied-set)
         (incf n-down)
         (when verbose (format t \"[migrations] ROLLBACK OK ~A~%\" ver))))
    (values n-up n-down)))

(defun rollback-one (&key (verbose t))
  (%ensure-table!)
  (let ((last (query-1a \"SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1\")))
    (if (null last)
        (progn
          (when verbose (format t \"~&[migrations] nothing to rollback.~%\"))
          0)
        (let* ((v (cdr (assoc :version last)))
               (m (%find-mig v)))
          (unless m (error \"No migration registered for version ~A\" v))
          (when verbose (format t \"~&[migrations] ↓ rolling back ~A...~%\" v))
          (run-in-transaction
	   (lambda ()
             (let ((down-fn (%ensure-down-fn m)))
               (funcall down-fn))
             (exec \"DELETE FROM schema_migrations WHERE version=$1\" v)))
           (when verbose (format t \"[migrations] ROLLBACK OK ~A~%\" v))
          1))))

(defun status ()
  (%ensure-table!)
  (let* ((applied (%applied-list))
         (applied-index (alexandria:alist-hash-table
                         (mapcar (lambda (r) (cons (cdr (assoc :version r)) r)) applied)
                         :test #'equal)))
    (loop for i from 0 below (length *registry*)
          for m = (aref *registry* i)
          for v = (migration-version m)
          for row = (gethash v applied-index)
          collect
          (list (cons :version v)
                (cons :applied-p (and row t))
                (cons :applied-at (and row (cdr (assoc :applied_at row))))))))

(defun reset! ()
  (%ensure-table!)
  (run-in-transaction
   (lambda ()
     (exec \"TRUNCATE TABLE schema_migrations\"))))
" 0 1 (fontified t) 1 6 (face font-lock-keyword-face fontified t) 6 7 (fontified t) 7 11 (face font-lock-function-name-face fontified t) 11 18 (face font-lock-function-name-face fontified t) 18 20 (fontified t) 20 24 (face font-lock-type-face fontified t) 24 38 (fontified t) 38 60 (fontified t) 60 63 (face font-lock-keyword-face fontified t) 63 80 (fontified t) 80 101 (fontified t) 101 106 (fontified t) 106 108 (face font-lock-keyword-face fontified t) 108 146 (fontified t) 146 150 (face font-lock-builtin-face fontified t) 150 154 (face font-lock-builtin-face fontified t) 154 164 (fontified t) 164 173 (fontified t) 173 178 (face font-lock-keyword-face fontified t) 178 190 (fontified t) 190 194 (face font-lock-keyword-face fontified t) 194 213 (fontified t) 213 251 (face font-lock-string-face fontified t) 251 282 (fontified t) 282 283 (fontified t) 283 288 (face font-lock-keyword-face fontified t) 288 289 (fontified t) 289 302 (face font-lock-function-name-face fontified t) 302 311 (fontified t) 311 315 (face font-lock-type-face fontified t) 315 351 (fontified t) 351 355 (face font-lock-keyword-face fontified t) 355 437 (fontified t) 437 469 (face font-lock-comment-face fontified t) 469 514 (fontified t) 514 515 (fontified t) 515 523 (fontified t) 523 558 (fontified t) 558 564 (face font-lock-keyword-face fontified t) 564 588 (fontified t) 588 591 (face font-lock-string-face fontified t) 591 634 (fontified t) 634 639 (face font-lock-builtin-face fontified t) 639 659 (fontified t) 659 662 (face font-lock-comment-delimiter-face fontified t) 662 684 (face font-lock-comment-face fontified t) 684 698 (face font-lock-comment-face fontified t) 698 719 (fontified t) 719 723 (face font-lock-keyword-face fontified t) 723 829 (fontified t) 829 833 (face font-lock-builtin-face fontified t) 833 854 (fontified t) 854 859 (face font-lock-builtin-face fontified t) 859 868 (fontified t) 868 877 (face font-lock-builtin-face fontified t) 877 891 (fontified t) 891 894 (face font-lock-comment-delimiter-face fontified t) 894 932 (face font-lock-comment-face fontified t) 932 964 (fontified t) 964 970 (face font-lock-keyword-face fontified t) 970 1034 (fontified t) 1034 1037 (face font-lock-string-face fontified t) 1037 1081 (fontified t) 1081 1149 (fontified t) 1149 1200 (fontified t) 1200 1203 (face font-lock-comment-delimiter-face fontified t) 1203 1240 (face font-lock-comment-face fontified t) 1240 1276 (fontified t) 1276 1282 (face font-lock-keyword-face fontified t) 1282 1351 (fontified t) 1351 1354 (face font-lock-string-face fontified t) 1354 1560 (fontified t) 1560 1563 (face font-lock-comment-delimiter-face fontified t) 1563 1603 (face font-lock-comment-face fontified t) 1603 1608 (fontified t) 1608 1614 (face font-lock-keyword-face fontified t) 1614 1631 (fontified t) 1631 1637 (face font-lock-keyword-face fontified t) 1637 1737 (fontified t) 1737 1740 (face font-lock-keyword-face fontified t) 1740 1780 (fontified t) 1780 1784 (face font-lock-keyword-face fontified t) 1784 1803 (fontified t) 1803 1838 (face font-lock-string-face fontified t) 1838 1876 (fontified t) 1876 1882 (face font-lock-keyword-face fontified t) 1882 1898 (fontified t) 1898 1901 (face font-lock-keyword-face fontified t) 1901 1977 (fontified t) 1977 2023 (face font-lock-string-face fontified t) 2023 2046 (face font-lock-string-face fontified t) 2046 2096 (face font-lock-string-face fontified t) 2096 2196 (fontified t) 2196 2198 (face font-lock-keyword-face fontified t) 2198 2200 (face font-lock-keyword-face fontified t) 2200 2219 (fontified t) 2219 2241 (face font-lock-string-face fontified t) 2241 2250 (fontified t) 2250 2255 (fontified t) 2255 2258 (face font-lock-comment-delimiter-face fontified t) 2258 2335 (face font-lock-comment-face fontified t) 2335 2340 (fontified t) 2340 2346 (face font-lock-keyword-face fontified t) 2346 2365 (fontified t) 2365 2371 (face font-lock-keyword-face fontified t) 2371 2473 (fontified t) 2473 2476 (face font-lock-keyword-face fontified t) 2476 2516 (fontified t) 2516 2520 (face font-lock-keyword-face fontified t) 2520 2539 (fontified t) 2539 2578 (face font-lock-string-face fontified t) 2578 2616 (fontified t) 2616 2622 (face font-lock-keyword-face fontified t) 2622 2638 (fontified t) 2638 2641 (face font-lock-keyword-face fontified t) 2641 2723 (fontified t) 2723 2771 (face font-lock-string-face fontified t) 2771 2847 (fontified t) 2847 2851 (face font-lock-keyword-face fontified t) 2851 2870 (fontified t) 2870 2901 (face font-lock-string-face fontified t) 2901 2938 (fontified t) 2938 2939 (fontified t) 2939 2944 (face font-lock-keyword-face fontified t) 2944 2945 (fontified t) 2945 2957 (face font-lock-function-name-face fontified t) 2957 2959 (fontified t) 2959 2963 (face font-lock-type-face fontified t) 2963 2999 (fontified t) 2999 3002 (face font-lock-keyword-face fontified t) 3002 3020 (fontified t) 3020 3089 (face font-lock-string-face fontified t) 3089 3098 (fontified t) 3098 3100 (face font-lock-keyword-face fontified t) 3100 3122 (fontified t) 3122 3127 (face font-lock-keyword-face fontified t) 3127 3139 (fontified t) 3139 3143 (face font-lock-keyword-face fontified t) 3143 3162 (fontified t) 3162 3201 (face font-lock-string-face fontified t) 3201 3226 (fontified t) 3226 3230 (face font-lock-keyword-face fontified t) 3230 3247 (fontified t) 3247 3255 (face font-lock-builtin-face fontified t) 3255 3309 (fontified t) 3309 3315 (face font-lock-keyword-face fontified t) 3315 3319 (fontified t) 3319 3324 (face font-lock-warning-face fontified t) 3324 3325 (fontified t) 3325 3365 (face font-lock-string-face fontified t) 3365 3381 (fontified t) 3381 3385 (face font-lock-keyword-face fontified t) 3385 3404 (fontified t) 3404 3443 (face font-lock-string-face fontified t) 3443 3483 (fontified t) 3483 3489 (face font-lock-keyword-face fontified t) 3489 3507 (fontified t) 3507 3510 (face font-lock-keyword-face fontified t) 3510 3546 (fontified t) 3546 3577 (fontified t) 3577 3596 (fontified t) 3596 3644 (face font-lock-string-face fontified t) 3644 3662 (fontified t) 3662 3666 (face font-lock-keyword-face fontified t) 3666 3685 (fontified t) 3685 3716 (face font-lock-string-face fontified t) 3716 3738 (fontified t) 3738 3739 (fontified t) 3739 3744 (face font-lock-keyword-face fontified t) 3744 3745 (fontified t) 3745 3750 (face font-lock-function-name-face fontified t) 3750 3751 (face font-lock-function-name-face fontified t) 3751 3755 (fontified t) 3755 3777 (fontified t) 3777 3781 (face font-lock-keyword-face fontified t) 3781 3896 (fontified t) 3896 3902 (face font-lock-keyword-face fontified t) 3902 3925 (fontified t) 3925 3933 (face font-lock-builtin-face fontified t) 3933 3976 (fontified t) 3976 3981 (face font-lock-builtin-face fontified t) 3981 3998 (fontified t) 3998 4002 (face font-lock-keyword-face fontified t) 4002 4206 (fontified t) 4206 4214 (face font-lock-builtin-face fontified t) 4214 4240 (fontified t) 4240 4250 (face font-lock-builtin-face fontified t) 4250 4286 (fontified t) 4286 4297 (face font-lock-builtin-face fontified t) 4297 4319 (fontified t) 4319 4330 (face font-lock-builtin-face fontified t) 4330 4345 (fontified t) 4345 4350 (face font-lock-keyword-face fontified t) 4350 4351 (fontified t) 4351 4357 (face font-lock-function-name-face fontified t) 4357 4406 (fontified t) 4406 4412 (face font-lock-keyword-face fontified t) 4412 4427 (fontified t) 4427 4461 (face font-lock-string-face fontified t) 4461 4466 (fontified t)) . -3840) (undo-tree-id0 . -4466) (undo-tree-id1 . -3543) (undo-tree-id2 . -4466) (undo-tree-id3 . -282) (undo-tree-id4 . -523) (undo-tree-id5 . -282) (undo-tree-id6 . -2046) (undo-tree-id7 . -1930) (undo-tree-id8 . -2938) (undo-tree-id9 . -3577) (undo-tree-id10 . -3128) (undo-tree-id11 . -4380) (undo-tree-id12 . -4466) (undo-tree-id13 . -4466) (undo-tree-id14 . -4466) (undo-tree-id15 . -4466) (undo-tree-id16 . -4466) (undo-tree-id17 . -4466) 8306) nil (27001 3644 434582 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 7783 . 7784) (nil fontified nil 3840 . 7784) (3840 . 7784)) nil (27001 3644 434542 0) 0 nil])
([nil nil ((7784 . 7785) 5780) nil (27001 3644 434537 0) 0 nil])
([nil nil ((#("(defmacro defmigration (version &key up down)
  \"VERSION = string ou integer horodaté.
UP/DOWN = forms qui seront encapsulées dans une fonction (lambda () ...).
On enregistre préférentiellement des *fonctions objets* (#'), mais on tolère
les lambda-expressions via %ensure-up-fn / %ensure-down-fn.\"
  (let* ((ver-str (if (integerp version) (write-to-string version) version))
         (up-fn   (when up   `#'(lambda () ,@up)))
         (down-fn (when down `#'(lambda () ,@down))))
    `(%push-migration!
      (make-migration
       :version    ,ver-str
       :up-forms   ,(or up-fn   `(lambda () ,@up))   ; fallback pour compat
       :down-forms ,(or down-fn `(lambda () ,@down))))))" 0 1 (fontified t) 1 9 (face font-lock-keyword-face fontified t) 9 10 (fontified t) 10 22 (face font-lock-function-name-face fontified t) 22 32 (fontified t) 32 36 (face font-lock-type-face fontified t) 36 48 (fontified t) 48 253 (face font-lock-doc-face fontified t) 253 298 (face font-lock-doc-face fontified t) 298 299 (fontified t) 299 302 (fontified t) 302 306 (face font-lock-keyword-face fontified t) 306 318 (fontified t) 318 320 (face font-lock-keyword-face fontified t) 320 395 (fontified t) 395 399 (face font-lock-keyword-face fontified t) 399 409 (fontified t) 409 413 (face font-lock-keyword-face fontified t) 413 415 (face font-lock-keyword-face fontified t) 415 427 (fontified t) 427 446 (fontified t) 446 450 (face font-lock-keyword-face fontified t) 450 460 (fontified t) 460 466 (face font-lock-keyword-face fontified t) 466 533 (fontified t) 533 541 (face font-lock-builtin-face fontified t) 541 561 (fontified t) 561 570 (face font-lock-builtin-face fontified t) 570 588 (fontified t) 588 594 (face font-lock-keyword-face fontified t) 594 607 (fontified t) 607 630 (face font-lock-comment-face fontified t) 630 637 (fontified t) 637 648 (face font-lock-builtin-face fontified t) 648 664 (fontified t) 664 670 (face font-lock-keyword-face fontified t) 670 686 (fontified t)) . -2052) (undo-tree-id25 . -686) (undo-tree-id26 . -318) (undo-tree-id27 . -686) (undo-tree-id28 . -686) (undo-tree-id29 . -686) (undo-tree-id30 . -630) (undo-tree-id31 . -686) (undo-tree-id32 . -686) 2738 (t 27001 3644 0 0)) nil (27001 3802 789325 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 2721 . 2722) (nil fontified nil 2052 . 2722) (2052 . 2722)) nil (27001 3802 789297 0) 0 nil])
([nil nil ((2050 . 2052) (t 27001 3802 0 0)) nil (27001 4167 383223 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 3472 . 3473) (nil fontified nil 2052 . 3473) (2052 . 3473)) nil (27001 4167 383222 0) 0 nil])
([nil nil ((4145 . 4147)) nil (27001 4167 383221 0) 0 nil])
([nil nil ((nil rear-nonsticky nil 4635 . 4636) (nil fontified nil 4147 . 4636) (4147 . 4636)) nil (27001 4167 383221 0) 0 nil])
([nil nil ((3474 . 3475)) nil (27001 4167 383219 0) 0 nil])
([nil nil ((3475 . 3476)) nil (27001 4167 383219 0) 0 nil])
([nil nil ((#("{" 0 1 (fontified t)) . -3475) (undo-tree-id33 . -1) 3476) nil (27001 4167 383217 0) 0 nil])
([nil nil ((3475 . 3477)) nil (27001 4167 383204 0) 0 nil])
([nil nil ((4149 . 4151)) nil (27001 4167 383202 0) 0 nil])
([nil current ((4151 . 4152)) nil (27001 4167 383197 0) 0 nil])
nil
